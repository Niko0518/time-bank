# Time Bank - AI ç¼–ç¨‹æŒ‡å—

> âš ï¸ **å¼ºåˆ¶è§„åˆ™**ï¼šæ¯æ¬¡æ›´æ–°è¯·é˜…è¯»æœ¬æŒ‡ä»¤ï¼Œåœ¨æ›´æ–°åï¼Œå‡¡æ˜¯æ¶‰åŠå…³é”®æŠ€æœ¯ç»†èŠ‚æˆ–é‡è¦æ”¹åŠ¨æ—¶ï¼Œå¿…é¡»å°†å…¶æ·»åŠ åˆ°æœ¬æ–‡ä»¶çš„ã€Œç¬¬äºŒéƒ¨åˆ†ï¼šç‰ˆæœ¬æ›´æ–°æ—¥å¿—ã€ä¸­ã€‚æˆ‘ä»¬çš„äº¤æµè¯­è¨€æ˜¯ä¸­æ–‡

---

## ğŸ“‹ æ¯æ¬¡æ›´æ–°å‰å¤è¿°ç”¨æˆ·éœ€æ±‚

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¦‚å†µä¸æŠ€æœ¯åŸºç¡€

> æœ¬éƒ¨åˆ†åŒ…å«é¡¹ç›®çš„æ•´ä½“æ¶æ„ã€æ ¸å¿ƒæ–‡ä»¶ã€å…³é”®é…ç½®ç­‰åŸºç¡€ä¿¡æ¯ã€‚**æ¯æ¬¡å¼€å§‹å·¥ä½œå‰å¿…é¡»é˜…è¯»ç†è§£**ã€‚

---

## 1.1 é¡¹ç›®æ¦‚è¿°

Time Bank æ˜¯ä¸€ä¸ª **æ··åˆå¼€å‘ (Hybrid) çš„å®‰å“åº”ç”¨**ï¼Œç»“åˆåŸç”Ÿ Java å¤–å£³å’Œ WebView å‰ç«¯ç•Œé¢ã€‚

**æŠ€æœ¯æ ˆ**ï¼š
- **å‰ç«¯**: åŸç”Ÿ JavaScript (Vanilla JS)ï¼Œæ— æ¡†æ¶ï¼Œå•æ–‡ä»¶ ~30,000 è¡Œ
- **æ ·å¼**: CSS å˜é‡ï¼Œæ”¯æŒæ·±è‰²æ¨¡å¼ (`prefers-color-scheme`)
- **äº‘ç«¯**: è…¾è®¯ CloudBase JS SDK v2.24.10
- **Android**: Javaï¼ŒminSdk 26ï¼ŒtargetSdk 34
- **æ„å»º**: Gradle 8.x

---

## 1.2 æ ¸å¿ƒæ–‡ä»¶ç»“æ„

| æ–‡ä»¶ | ç”¨é€” | è¡Œæ•° |
|------|------|------|
| `android_project/app/src/main/assets/www/index.html` | **å‰ç«¯å…¨éƒ¨ä»£ç ** (HTML+CSS+JS) | ~30,000 è¡Œ |
| `android_project/app/src/main/java/com/jianglicheng/timebank/MainActivity.java` | Android å…¥å£ï¼ŒWebView åˆå§‹åŒ– | ~200 è¡Œ |
| `android_project/app/src/main/java/com/jianglicheng/timebank/WebAppInterface.java` | JS æ¡¥æ¥ (`window.Android`) | ~900 è¡Œ |
| `android_project/app/src/main/java/com/jianglicheng/timebank/AlarmReceiver.java` | é—¹é’Ÿå¹¿æ’­æ¥æ”¶å™¨ | ~100 è¡Œ |
| `sw.js` | Service Worker (PWA ç¼“å­˜) | ~50 è¡Œ |

### æ–‡ä»¶åŒæ­¥è§„åˆ™
- **ä¸»æ–‡ä»¶**: `android_project/app/src/main/assets/www/index.html`
- **æ ¹ç›®å½•å‰¯æœ¬**: `index.html` (ç”¨äº GitHub Pages é¢„è§ˆ)
- âš ï¸ **æ¯æ¬¡ä¿®æ”¹åå¿…é¡»åŒæ­¥**: 
  ```powershell
  Copy-Item "android_project/app/src/main/assets/www/index.html" "index.html" -Force
  ```

### index.html ç»“æ„æ¦‚è§ˆ
```
è¡Œ 1-1000        : HTML ç»“æ„ + CSS æ ·å¼
è¡Œ 1000-4000     : æ›´å¤š HTML (å„é¡µé¢æ¨¡æ¿)
è¡Œ 4000-4100     : é¦–é¡µå¡ç‰‡ (ä½™é¢ã€å±å¹•æ—¶é—´ã€ç¡çœ )
è¡Œ 4500-5200     : ç¡çœ è®¾ç½®é¢æ¿ HTML
è¡Œ 4730-6000     : æ›´æ–°æ—¥å¿—åŒºåŸŸ
è¡Œ 6000-8000     : JavaScript å·¥å…·å‡½æ•°
è¡Œ 8000-10000    : DAL (æ•°æ®è®¿é—®å±‚) + CloudBase é€»è¾‘
è¡Œ 10000-11000   : ä»»åŠ¡å¡ç‰‡æ‹–æ‹½æ’åº
è¡Œ 11000-16000   : ä»»åŠ¡ç®¡ç† + äº¤æ˜“è®°å½•
è¡Œ 16000-19000   : æŠ¥å‘Šé¡µé¢ + æ—¶é—´æµå›¾
è¡Œ 19000-21000   : ç¡çœ æ—¶é—´ç®¡ç†ç³»ç»Ÿ
è¡Œ 21000-23000   : å±å¹•æ—¶é—´ç®¡ç†
è¡Œ 23000-27000   : è®¤è¯ç™»å½•ç›¸å…³
è¡Œ 27000-30000   : å…¶ä»–ä¸šåŠ¡é€»è¾‘
```

---

## 1.3 è…¾è®¯äº‘ CloudBase é…ç½®

### ç¯å¢ƒä¿¡æ¯
- **ç¯å¢ƒ ID**: `cloud1-8gvjsmyd7860b4a3`
- **åœ°åŸŸ**: `ap-shanghai`
- **ç™»å½•æ–¹å¼**: é‚®ç®±ç™»å½•
- **SDK ç‰ˆæœ¬**: v2.24.10

### æ•°æ®åº“é›†åˆ

| é›†åˆåç§° | å®‰å…¨è§„åˆ™ç±»å‹ | ç”¨é€” |
|---------|-------------|------|
| `tb_profile` | âœ… é¢„ç½®è§„åˆ™ï¼ˆè¯»å†™æœ¬äººæ•°æ®ï¼‰ | ç”¨æˆ·èµ„æ–™ï¼ˆå«è®¾å¤‡é…ç½®ï¼‰ |
| `tb_task` | âœ… é¢„ç½®è§„åˆ™ï¼ˆè¯»å†™æœ¬äººæ•°æ®ï¼‰ | ä»»åŠ¡åˆ—è¡¨ |
| `tb_transaction` | ğŸ”§ è‡ªå®šä¹‰è§„åˆ™ | äº¤æ˜“è®°å½•ï¼ˆå«ç¡çœ ç»“ç®—ï¼‰ |
| `tb_running` | âœ… é¢„ç½®è§„åˆ™ï¼ˆè¯»å†™æœ¬äººæ•°æ®ï¼‰ | è¿è¡Œä¸­ä»»åŠ¡ |
| `tb_daily` | ğŸ”§ è‡ªå®šä¹‰è§„åˆ™ | æ¯æ—¥ç»Ÿè®¡ |

### è‡ªå®šä¹‰è§„åˆ™ä»£ç ï¼ˆtb_transaction / tb_dailyï¼‰
```json
{
  "read": "doc._openid == auth.uid || doc._openid == auth.openid",
  "write": "doc._openid == auth.uid || doc._openid == auth.openid",
  "delete": true
}
```

### å®‰å…¨è§„åˆ™å¯¹æŸ¥è¯¢çš„å½±å“
```javascript
// é¢„ç½®è§„åˆ™ "è¯»å–å’Œä¿®æ”¹æœ¬äººæ•°æ®" - ä¸éœ€è¦ where æ¡ä»¶
db.collection('tb_profile').get()  // CloudBase è‡ªåŠ¨è¿‡æ»¤

// è‡ªå®šä¹‰è§„åˆ™ - éœ€è¦æ‰‹åŠ¨æ·»åŠ  where æ¡ä»¶
db.collection('tb_transaction').where({ _openid: currentUid }).get()
```

### å…³é”®ä»£ç ä½ç½®
| åŠŸèƒ½ | æœç´¢å…³é”®è¯ |
|------|-----------|
| DAL å¯¹è±¡ | `const DAL =` |
| SDK åˆå§‹åŒ– | `initCloudBase` |
| Watch å®æ—¶ç›‘å¬ | `subscribeAll` |
| æ•°æ®åŠ è½½ | `DAL.loadAll` |
| ä»»åŠ¡ä¿å­˜ | `DAL.saveTask` |

âš ï¸ **é‡è¦**: `saveData()` åœ¨å¤šè¡¨æ¨¡å¼ä¸‹**ä¸ä¿å­˜ä»»åŠ¡åˆ°äº‘ç«¯**ï¼Œåªä¿å­˜ Profileã€‚ä¿®æ”¹ä»»åŠ¡æ•°æ®åéœ€å•ç‹¬è°ƒç”¨ `DAL.saveTask(task)` åŒæ­¥åˆ°äº‘ç«¯ã€‚

---

## 1.4 æ ¸å¿ƒæ•°æ®ç»“æ„

### ç¡çœ è®¾ç½® (localStorage: sleepSettings)
```javascript
sleepSettings = {
    enabled: false,
    plannedBedtime: '22:30',
    plannedWakeTime: '06:45',
    targetDurationMinutes: 495,
    durationTolerance: 45,
    toleranceReward: 60,
    countdownSeconds: 60,
    showCard: true,
    autoDetectWake: true,
    earlyBedtimeRate: 0.2,
    lateBedtimeRate: 0.5,
    earlyWakeRate: 0.2,
    lateWakeRate: 0.5,
    durationDeviationRate: 0.5,
    earnCategory: null,   // [v7.9.3] ç¡çœ å¥–åŠ±åˆ†ç±»
    spendCategory: null,  // [v7.9.3] ç¡çœ æƒ©ç½šåˆ†ç±»
};
```

### å±å¹•æ—¶é—´è®¾ç½® (localStorage: screenTimeSettings)
```javascript
screenTimeSettings = {
    enabled: false,
    dailyLimitMinutes: 120,
    showCard: true,
    whitelistApps: [],
    settledDates: { deviceId: [dates] },
    earnCategory: null,
    spendCategory: null,
    cardStyle: 'classic',
};
```

### ç¡çœ çŠ¶æ€ (localStorage: sleepState)
```javascript
sleepState = {
    isSleeping: false,
    sleepStartTime: null,
    unlockCount: 0,
    cancelledDates: [],
    lastSleepRecord: null,
    lastUnlockTime: null,
};
```

---

## 1.5 ç‰ˆæœ¬å‘å¸ƒè§„åˆ™

### âš ï¸ ç‰ˆæœ¬å·ä¸æ¨é€åŸåˆ™ï¼ˆå¼ºåˆ¶ï¼‰
1. **ç‰ˆæœ¬å·ç”±ç”¨æˆ·æŒ‡å®š**ï¼šç”¨æˆ·åœ¨å¯¹è¯å¼€å§‹æ—¶å£°æ˜ç‰ˆæœ¬å·ï¼ˆå¦‚"æœ¬æ¬¡æ›´æ–°ç‰ˆæœ¬ä¸º v7.11.2"ï¼‰ï¼ŒAI åœ¨æ•´ä¸ªå¯¹è¯ä¸­å¿…é¡»ä½¿ç”¨è¯¥ç‰ˆæœ¬å·
2. **ç¦æ­¢æ“…è‡ªæ¨é€**ï¼šAI ä¸å¾—åœ¨æ²¡æœ‰ç”¨æˆ·æ˜ç¡®æŒ‡ä»¤çš„æƒ…å†µä¸‹æ‰§è¡Œ `git push`
3. **ç¦æ­¢æ“…è‡ªå‡çº§ç‰ˆæœ¬å·**ï¼šå³ä½¿å¯¹è¯è·¨è¶Šå¤šæ¬¡ä¿®æ”¹ï¼Œç‰ˆæœ¬å·ä¿æŒç”¨æˆ·æŒ‡å®šçš„å€¼ä¸å˜
4. **ä»£ç æ³¨é‡Šç‰ˆæœ¬å·**ï¼šæ–°å¢/ä¿®æ”¹çš„ä»£ç æ³¨é‡Šåº”ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„ç‰ˆæœ¬å·ï¼ˆå¦‚ `// [v7.11.2] ä¿®å¤...`ï¼‰
5. **æ¨é€åå‡çº§**ï¼šåªæœ‰åœ¨ç”¨æˆ·è¦æ±‚æ¨é€åï¼Œä¸‹æ¬¡å¯¹è¯æ‰èƒ½ä½¿ç”¨æ–°ç‰ˆæœ¬å·

### æ›´æ–°ç‰ˆæœ¬å·ï¼ˆ5 ä¸ªä½ç½®ï¼‰
1. `<title>` æ ‡ç­¾ï¼ˆçº¦ç¬¬ 12 è¡Œï¼‰
2. å…³äºé¡µ `<p>ç‰ˆæœ¬ vX.X.X</p>`ï¼ˆçº¦ç¬¬ 5701 è¡Œï¼‰
3. `APP_VERSION` å¸¸é‡ï¼ˆçº¦ç¬¬ 6606 è¡Œï¼‰
4. å¯åŠ¨æ—¥å¿— `console.log("App vX.X.X...")`ï¼ˆçº¦ç¬¬ 9787 è¡Œï¼‰
5. `sw.js` æ–‡ä»¶å¤´éƒ¨ï¼ˆ2 å¤„ï¼‰

### æ›´æ–° sw.js
```javascript
// Time Bank Service Worker - vX.X.X
const CACHE_NAME = 'timebank-cache-vX.X.X';
```

### ç‰ˆæœ¬æ—¥å¿—è§„åˆ™
- âš ï¸ **ä»…åœ¨ç”¨æˆ·æ˜ç¡®è¦æ±‚æ—¶**æ‰æ’°å†™ç‰ˆæœ¬æ—¥å¿—
- æ—¥å¿—æŒ‰ç‰ˆæœ¬å·**é™åºæ’åˆ—**ï¼ˆæœ€æ–°ç‰ˆæœ¬åœ¨æœ€ä¸Šé¢ï¼‰
- åªæœ‰**å½“å‰ç‰ˆæœ¬**ä¿ç•™åœ¨å¤–é¢ï¼Œå†å²ç‰ˆæœ¬ç§»å…¥ `<details>` åŒºåŸŸï¼ˆæ ‡é¢˜ä¸ºã€Œç‰ˆæœ¬æ›´æ–°æ—¥å¿—ã€ï¼‰
- æ›´æ–°æ—¥å¿—ä½äºçº¦ç¬¬ 5718 è¡Œ

### æ–‡ä»¶åŒæ­¥
```powershell
Copy-Item "android_project/app/src/main/assets/www/index.html" "index.html" -Force
```

---

## 1.6 å¼€å‘æ³¨æ„äº‹é¡¹

### ä¿®æ”¹å‰ç«¯ä»£ç  (index.html)
- æ–‡ä»¶å·¨å¤§ï¼ˆ~30,000 è¡Œï¼‰ï¼Œ**å¿…é¡»å…ˆç”¨ grep_search å®šä½**ï¼Œå†ç”¨ read_file è¯»å–ä¸Šä¸‹æ–‡
- ä½¿ç”¨ `replace_string_in_file` æ—¶æä¾› **3-5 è¡Œä¸Šä¸‹æ–‡**ï¼Œç¡®ä¿å”¯ä¸€åŒ¹é…
- ä¿®æ”¹åç”¨ `get_errors` æ£€æŸ¥è¯­æ³•é”™è¯¯

### å¸¸ç”¨æœç´¢å…³é”®è¯
| åŠŸèƒ½æ¨¡å— | æœç´¢å…³é”®è¯ |
|---------|-----------|
| äº‘ç«¯åŒæ­¥ | `DAL.` / `cloudApp` / `subscribeAll` |
| ä»»åŠ¡ç®¡ç† | `taskList` / `addTask` / `completeTask` |
| äº¤æ˜“è®°å½• | `transaction` / `addTransaction` |
| ç¡çœ ç®¡ç† | `sleepSettings` / `sleepState` / `ç¡çœ æ—¶é—´ç®¡ç†` |
| å±å¹•æ—¶é—´ | `screenTimeSettings` / `autoSettle` |
| å‡è¡¡æ¨¡å¼ | `balanceMode` / `getBalanceMultiplier` |
| ç™»å½•è®¤è¯ | `handleEmailLogin` / `signInWithPassword` |
| ç‰ˆæœ¬ä¿¡æ¯ | `APP_VERSION` / `æ›´æ–°æ—¥å¿—` |

### æ·»åŠ æ–°çš„ JS æ¡¥æ¥æ–¹æ³•
1. åœ¨ `WebAppInterface.java` æ·»åŠ :
   ```java
   @JavascriptInterface
   public void newMethod(String param) { ... }
   ```
2. åœ¨ `index.html` è°ƒç”¨:
   ```javascript
   if (window.Android?.newMethod) {
       window.Android.newMethod("value");
   }
   ```

### å¸¸ç”¨åŸç”Ÿæ–¹æ³• (Android)
| æ–¹æ³• | ç”¨é€” |
|------|------|
| `Android.saveFileDirectly(filename, content)` | ä¿å­˜æ–‡ä»¶åˆ°ä¸‹è½½ç›®å½• |
| `Android.vibrate(ms)` | éœ‡åŠ¨ |
| `Android.getDeviceId()` | è·å–è®¾å¤‡ ID |
| `Android.saveLoginCredentials(email, password)` | ä¿å­˜ç™»å½•å‡­æ® |
| `Android.getSavedLoginPassword()` | è¯»å–ä¿å­˜çš„å¯†ç  |
| `Android.isAutoLoginEnabled()` | æ£€æŸ¥è‡ªåŠ¨ç™»å½•çŠ¶æ€ |

---

## 1.7 å¸¸è§é—®é¢˜æ’æŸ¥

### Q: ä¿®æ”¹åé¡µé¢æ²¡å˜åŒ–ï¼Ÿ
1. æ¸…é™¤ WebView ç¼“å­˜ (Android è®¾ç½® â†’ åº”ç”¨ â†’ æ¸…é™¤æ•°æ®)
2. æ£€æŸ¥æ˜¯å¦åŒæ­¥äº†æ ¹ç›®å½•çš„ `index.html`
3. Service Worker å¯èƒ½ç¼“å­˜äº†æ—§æ–‡ä»¶

### Q: äº‘ç«¯æ•°æ®ä¸åŒæ­¥ï¼Ÿ
1. æ£€æŸ¥ç™»å½•çŠ¶æ€: æœç´¢ `cloudAuthState`
2. æŸ¥çœ‹ Watch ç›‘å¬: æœç´¢ `subscribeAll`
3. ç¡®è®¤ `_openid` å­—æ®µæ­£ç¡®

### Q: ä»»åŠ¡æ’åºä¸æŒä¹…åŒ–ï¼Ÿ
- `saveData()` ä¸ä¿å­˜ä»»åŠ¡åˆ°äº‘ç«¯
- éœ€è¦è°ƒç”¨ `DAL.saveTask(task)` åŒæ­¥æ¯ä¸ªä¿®æ”¹çš„ä»»åŠ¡

### Q: replace_string_in_file å¤±è´¥ï¼Ÿ
1. ä½¿ç”¨ `read_file` è¯»å–ç²¾ç¡®å†…å®¹
2. æ£€æŸ¥ç¼©è¿›å’Œç©ºæ ¼æ˜¯å¦å®Œå…¨åŒ¹é…
3. å°è¯•æ›´çŸ­çš„å”¯ä¸€å­—ç¬¦ä¸²

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šç‰ˆæœ¬æ›´æ–°æ—¥å¿—

> æœ¬éƒ¨åˆ†è®°å½•æ¯æ¬¡æ›´æ–°çš„å…³é”®æ”¹åŠ¨å’ŒæŠ€æœ¯ç»†èŠ‚ã€‚**æ¯æ¬¡å¼€å§‹å·¥ä½œå‰å¿…é¡»é˜…è¯»ç†è§£**ï¼Œé˜²æ­¢é‡å¤è¸©å‘æˆ–ç ´åå·²æœ‰åŠŸèƒ½ã€‚
> 
> âš ï¸ **å¼ºåˆ¶è§„åˆ™**ï¼šæ¯æ¬¡æ›´æ–°æ¶‰åŠå…³é”®æŠ€æœ¯ç»†èŠ‚æˆ–é‡è¦æ”¹åŠ¨æ—¶ï¼Œå¿…é¡»å°†å…¶æ·»åŠ åˆ°æ­¤éƒ¨åˆ†ã€‚

### ğŸ“ è®°å½•æ ¼å¼è¦æ±‚
- **ç²¾ç®€æ–‡å­—**ï¼šé¿å…å†—é•¿æè¿°ï¼Œç”¨ä»£ç ç¤ºä¾‹æ›¿ä»£æ–‡å­—è¯´æ˜
- **æ ‡æ³¨ä¿®æ”¹**ï¼šä»£ç å—æ³¨æ˜ã€Œä¿®æ”¹å‰ â†’ ä¿®æ”¹åã€ä¾¿äºå›æº¯
- **å…³é”®ä½ç½®**ï¼šæ ‡æ³¨æ–‡ä»¶åå’Œå¤§è‡´è¡Œå·
- **é—®é¢˜é“¾**ï¼šå¤æ‚é—®é¢˜è®°å½•æ ¹å› é“¾ï¼ˆé—®é¢˜A â†’ å¯¼è‡´B â†’ è¡¨ç°ä¸ºCï¼‰

### âœ… ä»€ä¹ˆç®—â€œå…³é”®æ”¹åŠ¨â€ï¼ˆå¼ºåˆ¶éµå®ˆï¼‰
- **æ¶æ„/æ•°æ®å±‚**ï¼šåŒæ­¥æœºåˆ¶ã€å­˜å‚¨ç»“æ„ã€è·¨è®¾å¤‡ä¸€è‡´æ€§ã€æƒé™/å®‰å…¨è§„åˆ™ã€æ ¸å¿ƒæµç¨‹é‡æ„
- **é«˜é£é™© Bug ä¿®å¤**ï¼šä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€è·¨è®¾å¤‡ä¸ä¸€è‡´ã€æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨çš„é—®é¢˜
- **æ¥å£/åè®®å˜æ›´**ï¼šå½±å“å¤šç«¯æˆ–äº‘ç«¯æ•°æ®å…¼å®¹æ€§çš„å­—æ®µ/æ ¼å¼å˜æ›´

### âŒ ä¸è®°å½•ä¸ºâ€œå…³é”®æ”¹åŠ¨â€
- çº¯ UI/æ ·å¼/é—´è·/æ–‡å­—
- ç®€å•æ•°å€¼è°ƒæ•´ï¼ˆå¦‚æ•°é‡ã€é—´éš”ã€é˜ˆå€¼ï¼‰
- ç¼“å­˜ç‰ˆæœ¬å·/Service Worker åç§°æ›´æ–°

---
## v7.15.0 (2026-02-05) - å±å¹•æ—¶é—´å°ç»„ä»¶å¸ƒå±€ä¼˜åŒ–

### å…³é”®æ”¹åŠ¨

#### 1) å±å¹•æ—¶é—´å°ç»„ä»¶ç™¾åˆ†æ¯”å­—ä½“ç»Ÿä¸€ [v7.15.0]
**æ–‡ä»¶**: `widget_screen_time_*.xml`, `ScreenTimeWidget*Provider.java`

**ä¿®æ”¹å†…å®¹**:
```text
- ç»å…¸/æ¯›ç»ç’ƒ/ç³»ç»Ÿé€æ˜/é«˜é€æ˜æ¸å˜å››ç§æ ·å¼ç»Ÿä¸€ä½¿ç”¨ 20sp å­—ä½“
- ç»å…¸æ ·å¼ TextView: textSize="20sp", maxLines="1", singleLine="true"
- é€šé€æ ·å¼ Bitmap: createGradientTextBitmap(..., 20)
- å¸ƒå±€ç»“æ„: å·¦ä¾§æ ‡é¢˜+æ—¶é•¿/é™é¢ (weight=1), å³ä¾§ç™¾åˆ†æ¯” (wrap_content)
```

---
## v7.14.0 (2026-02-05) - æ¡Œé¢å°ç»„ä»¶å…¨æ–°å‡çº§

### å…³é”®æ”¹åŠ¨

#### 1) æ‚¬æµ®çª—æ™ºèƒ½ç‚¹å‡»æš‚åœåŠŸèƒ½ä¿®å¤ï¼ˆå…³é”®ä¿®å¤ï¼‰
**é—®é¢˜**: æŸäº› Android 12+ / 16 è®¾å¤‡ä¸Š"åœ¨å…³è”åº”ç”¨å†… â†’ æš‚åœè®¡æ—¶ + è¿”å› Time Bank"åŠŸèƒ½ä¸­çš„æš‚åœåŠŸèƒ½å¤±æ•ˆ

**æ ¹å› åˆ†æ**:
- `getRunningAppProcesses()` åœ¨ Android 10+ ä¸Šå—é™ï¼Œè¿”å›ä¿¡æ¯ä¸å®Œæ•´
- `process.importance` åˆ¤æ–­è¿‡äºä¸¥æ ¼ï¼ŒæŸäº›è®¾å¤‡ä¸Šå‰å°åº”ç”¨å¯èƒ½æ˜¯ `IMPORTANCE_FOREGROUND_SERVICE`
- ç¼ºå°‘è°ƒè¯•æ—¥å¿—ï¼Œæ— æ³•å®šä½é—®é¢˜

**ä¿®å¤æ–¹æ¡ˆ**:
```text
- æ–°å¢ UsageStatsManager ä½œä¸ºå¤‡é€‰æ£€æµ‹æ–¹æ¡ˆï¼ˆAndroid 5.0+ï¼‰
- æ”¾å®½è¿›ç¨‹é‡è¦æ€§åˆ¤æ–­ï¼šæ¥å— FOREGROUND æˆ– FOREGROUND_SERVICE
- æ–°å¢ getTopAppPackageViaUsageStats() æ–¹æ³•é€šè¿‡ä½¿ç”¨ç»Ÿè®¡æŸ¥è¯¢å‰å°åº”ç”¨
- æ–°å¢è¯¦ç»†è°ƒè¯•æ—¥å¿—ï¼ˆDEBUG_LOG å¼€å…³ï¼ŒTAG="FloatingTimer"ï¼‰
- isAppInForeground() åŒæ­¥å¢å¼ºï¼Œä½¿ç”¨ç›¸åŒçš„åŒé‡éªŒè¯æœºåˆ¶
```

**Logcat è°ƒè¯•**:
```
# ç­›é€‰å…³é”®è¯
package:com.jianglicheng.timebank tag:FloatingTimer

# è°ƒè¯•æ­¥éª¤
1. å¼€å¯æ‚¬æµ®çª—è®¡æ—¶å™¨å¹¶å…³è”åº”ç”¨
2. æ‰“å¼€å…³è”åº”ç”¨ï¼Œç‚¹å‡»æ‚¬æµ®çª—

#### 2) å±å¹•æ—¶é—´å°ç»„ä»¶ UI ä¼˜åŒ–
**æ–‡ä»¶**: `ScreenTimeWidgetProvider.java`, `widget_screen_time_classic.xml`, `widget_screen_time_classic_info.xml`

**ä¿®æ”¹å†…å®¹**:
```text
- å°ºå¯¸è°ƒæ•´ï¼š2Ã—2 â†’ 2Ã—1ï¼ˆä¸æ—¶é—´ä½™é¢å°ç»„ä»¶ä¸€è‡´ï¼‰
- å¸ƒå±€é‡æ„ï¼šæ°´å¹³æ’åˆ—ï¼Œå·¦ä¾§æ ‡é¢˜+ç™¾åˆ†æ¯”ï¼Œå³ä¾§ä½¿ç”¨é‡/é™é¢
- åœ†è§’ç»Ÿä¸€ï¼š20dpï¼ˆä¸æ—¶é—´ä½™é¢å°ç»„ä»¶ä¸€è‡´ï¼‰
- èƒŒæ™¯æ ·å¼ï¼šçº¯è‰² â†’ æ¸å˜è‰²ï¼ˆä¸é¦–é¡µå±å¹•æ—¶é—´å¡ç‰‡ä¸€è‡´ï¼‰
  * â‰¤33%: ç»¿è‰²æ¸å˜ (#27ae60 â†’ #1abc9c)
  * 34%-66%: è“è‰²æ¸å˜ (#3498db â†’ #9b59b6)
  * 67%-100%: æ©™è‰²æ¸å˜ (#f39c12 â†’ #e74c3c)
  * >100%: çº¢è‰²æ¸å˜ (#e74c3c â†’ #8e44ad)
- ç§»é™¤è¿›åº¦æ¡ï¼ˆ2Ã—1 å°ºå¯¸é™åˆ¶ï¼‰
- æ–°å¢æ¸å˜èƒŒæ™¯ drawableï¼šwidget_screen_time_green/blue/orange/red.xml
```

**åˆ é™¤æ–‡ä»¶**:
- `widget_screen_time_classic_bg.xml`ï¼ˆè¢«æ–°çš„æ¸å˜èƒŒæ™¯æ›¿æ¢ï¼‰

#### 3) æ—¶é—´ä½™é¢å°ç»„ä»¶æ¸å˜è‰²æ–¹æ¡ˆ [v7.14.0]
**æ–‡ä»¶**: `BalanceWidgetProvider.java`, `widget_balance_*.xml`

**åŠŸèƒ½**: æ ¹æ®ä½™é¢åŒºé—´è‡ªåŠ¨åˆ‡æ¢æ¸å˜èƒŒæ™¯é¢œè‰²ï¼ˆä¸å±å¹•æ—¶é—´å°ç»„ä»¶é…è‰²ä¸€è‡´ï¼‰

**åŒºé—´é…è‰²**:
```text
>24å°æ—¶:  è“è‰²æ¸å˜ (#3498db â†’ #9b59b6)   - ä½™é¢å……è¶³
0~24h:    ç»¿è‰²æ¸å˜ (#27ae60 â†’ #1abc9c)   - ç†æƒ³åŒºé—´ â­
-24~0h:   æ©™è‰²æ¸å˜ (#f39c12 â†’ #e74c3c)   - ä½™é¢åå°‘
<-24h:    çº¢è‰²æ¸å˜ (#e74c3c â†’ #8e44ad)   - ä½™é¢ä¸è¶³
```

**ä¿®æ”¹å†…å®¹**:
- BalanceWidgetProvider: ç®€åŒ–åŒºé—´é€»è¾‘ä¸º 4 æ¡£ï¼ˆç»¿/è“/æ©™/çº¢ï¼‰
- æ–‡å­—é¢œè‰²: ç»Ÿä¸€ç™½è‰²ï¼ˆåœ¨æ¸å˜èƒŒæ™¯ä¸Šæ›´æ¸…æ™°ï¼‰

**èƒŒæ™¯æ–‡ä»¶**:
- widget_balance_green.xml (#27ae60 â†’ #1abc9c)
- widget_balance_blue.xml (#3498db â†’ #9b59b6)
- widget_balance_orange.xml (#f39c12 â†’ #e74c3c)
- widget_balance_red.xml (#e74c3c â†’ #8e44ad)

**åˆ é™¤æ–‡ä»¶**:
- widget_balance_purple.xml / yellow.xmlï¼ˆåŒºé—´åˆå¹¶åä¸å†ä½¿ç”¨ï¼‰
- widget_balance_bg.xmlï¼ˆæ—§èƒŒæ™¯ï¼‰
- æç®€å’Œè¯¦æƒ…å°ç»„ä»¶ç›¸å…³æ–‡ä»¶
```

#### 4) å°ç»„ä»¶é€šé€æ¨¡å¼ä¸‰ç§æ–¹æ¡ˆ [v7.14.0]
**æ–‡ä»¶**: `BalanceWidgetGlass/System/TransparentProvider.java`, `ScreenTimeWidgetGlass/System/TransparentProvider.java`

**ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”**:
```text
æ–¹æ¡ˆä¸€ï¼šæ¯›ç»ç’ƒæ–‡å­—æ¸å˜
- èƒŒæ™¯: è‡ªç„¶åŠé€æ˜ç°è‰² (#40f5f5f5) + ç™½è‰²è¾¹æ¡†ï¼ˆä¸æ³›ç™½ï¼‰
- æ ‡ç­¾: **æ·±ç°è‰²** (#333333, alpha=0.95)
- æ•°å­—: **åŠ¨æ€æ¸å˜ Bitmap**ï¼ˆéšæ•°æ®å˜è‰²ï¼‰

æ–¹æ¡ˆäºŒï¼šç³»ç»Ÿé€æ˜
- èƒŒæ™¯: è¾ƒæµ…é€æ˜ (#60ffffff)
- æ ‡ç­¾: **æ·±ç°è‰²** (#333333)
- æ•°å­—: **åŠ¨æ€æ¸å˜ Bitmap**ï¼ˆæ–°å¢æ¸å˜æ•ˆæœï¼‰

æ–¹æ¡ˆä¸‰ï¼šé«˜é€æ˜æ¸å˜
- èƒŒæ™¯: 25% é€æ˜åº¦æ¸å˜è‰² + ç™½è‰²è¾¹æ¡†
- æ ‡ç­¾: **æ·±ç°è‰²** (#333333)
- æ•°å­—: **åŠ¨æ€æ¸å˜ Bitmap**ï¼ˆæ–°å¢æ¸å˜æ•ˆæœï¼‰

**æ¸å˜å®ç°**: æ‰€æœ‰é€šé€æ¨¡å¼å°ç»„ä»¶ä½¿ç”¨ Canvas.drawText() + LinearGradient ç»˜åˆ¶æ¸å˜æ–‡å­—

æ–¹æ¡ˆäºŒï¼šç³»ç»Ÿé€æ˜
- èƒŒæ™¯: è¾ƒæµ…é€æ˜ (#60ffffff)
- æ–‡å­—: æ·±ç°è‰² (#2c3e50)
- ç‰¹ç‚¹: ä¾èµ–ç³»ç»Ÿ launcher æ¨¡ç³Šå¤„ç†ï¼Œæ•ˆæœå› æ‰‹æœºè€Œå¼‚

æ–¹æ¡ˆä¸‰ï¼šé«˜é€æ˜æ¸å˜
- èƒŒæ™¯: 25% é€æ˜åº¦æ¸å˜è‰² + ç™½è‰²è¾¹æ¡†
- æ–‡å­—: æ·±ç°è‰² (#2c3e50)
- ç‰¹ç‚¹: éšä½™é¢/å±å¹•æ—¶é—´æ¯”ä¾‹å˜è‰²ï¼Œå…¼é¡¾é€šé€æ„Ÿå’ŒåŠŸèƒ½æ€§
```

**æ–°å¢ Provider** (6ä¸ª):
- æ—¶é—´ä½™é¢: BalanceWidgetGlassProvider / SystemProvider / TransparentProvider
- å±å¹•æ—¶é—´: ScreenTimeWidgetGlassProvider / SystemProvider / TransparentProvider

**æ–°å¢å¸ƒå±€** (6ä¸ª):
- widget_balance_glass.xml / system.xml / transparent.xml
- widget_screen_time_glass.xml / system.xml / transparent.xml

**æ–°å¢èƒŒæ™¯** (6ä¸ª):
- widget_glass_bg.xml / widget_system_bg.xml
- widget_transparent_green.xml / blue.xml / orange.xml / red.xml

**æ–°å¢é…ç½®** (6ä¸ª):
- widget_balance_glass_info.xml / system_info.xml / transparent_info.xml
- widget_screen_time_glass_info.xml / system_info.xml / transparent_info.xml

**ä¿®æ”¹æ–‡ä»¶**:
- AndroidManifest.xml: æ³¨å†Œ 6 ä¸ªæ–°çš„å°ç»„ä»¶
- strings.xml: æ·»åŠ  6 ä¸ªæè¿°å­—ç¬¦ä¸²
- WebAppInterface.updateWidgets(): åŒæ­¥æ›´æ–°æ‰€æœ‰ 8 ç§å°ç»„ä»¶
```

#### 4) æ¡Œé¢å°ç»„ä»¶æ·»åŠ å¼•å¯¼ [v7.14.0]
**æ–‡ä»¶**: `index.html`, `WebAppInterface.java`

**åŠŸèƒ½**: åœ¨è®¾ç½®é¡µå¤–è§‚è®¾ç½®ä¸­æ–°å¢ã€Œæ¡Œé¢å°ç»„ä»¶ã€å…¥å£ï¼Œç‚¹å‡»å¼¹å‡ºå°ç»„ä»¶é€‰æ‹©å™¨

**å¼¹çª—å†…å®¹**:
```text
- 2Ã—2 ç½‘æ ¼å±•ç¤º 8 ç§å°ç»„ä»¶é¢„è§ˆå›¾
- å·¦åˆ—ï¼šå±å¹•æ—¶é—´ç³»åˆ—ï¼ˆæ¸å˜ã€æ¯›ç»ç’ƒã€ç³»ç»Ÿé€æ˜ã€é«˜é€æ˜æ¸å˜ï¼‰
- å³åˆ—ï¼šæ—¶é—´ä½™é¢ç³»åˆ—ï¼ˆæ¸å˜ã€æ¯›ç»ç’ƒã€ç³»ç»Ÿé€æ˜ã€é«˜é€æ˜æ¸å˜ï¼‰
- æ¯ä¸ªé¢„è§ˆå›¾æ¨¡æ‹ŸçœŸå®æ ·å¼å’Œé…è‰²
- ç‚¹å‡»å°ç»„ä»¶æ˜¾ç¤ºæ·»åŠ å¼•å¯¼æç¤º
```

**æŠ€æœ¯å®ç°**:
```text
- Android 8.0+ (API 26+) æ”¯æŒ requestPinAppWidget() æ–¹æ³•
- è°ƒç”¨åä¼šå¼¹å‡ºç³»ç»Ÿçº§å¯¹è¯æ¡†ï¼Œç”¨æˆ·ç‚¹å‡»ç¡®è®¤å³å¯æ·»åŠ 
- ä½ç‰ˆæœ¬æˆ–ä¸æ”¯æŒçš„è®¾å¤‡ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨æ·»åŠ å¼•å¯¼
- å‰ç«¯è°ƒç”¨ï¼šAndroid.addWidgetToHomeScreen(widgetType)
- åŸç”Ÿå¤„ç†ï¼šæ ¹æ®ç±»å‹è·å–å¯¹åº” Providerï¼Œè°ƒç”¨ç³»ç»Ÿ API
```

**æ–°å¢ä»£ç **:
- openWidgetSelector() / closeWidgetSelector()
- addWidgetToHomeScreen() - è°ƒç”¨åŸç”Ÿæ–¹æ³•
- showWidgetGuide() - æ˜¾ç¤ºæ·»åŠ æ–¹æ³•å¼•å¯¼
- WebAppInterface.addWidgetToHomeScreen() - åŸç”Ÿå®ç°
```

---
## v7.13.0 (2026-02-04) - æ‚¬æµ®çª—è®¡æ—¶å™¨äº¤äº’å¢å¼º

### å…³é”®æ”¹åŠ¨

#### 1) æ‚¬æµ®çª—ç‚¹å‡»è¡Œä¸ºæ™ºèƒ½åˆ¤æ–­
**æ–‡ä»¶**: `FloatingTimerService.java`, `WebAppInterface.java`, `index.html`
```text
- TimerInfo æ–°å¢ appPackage å­—æ®µå­˜å‚¨å…³è”åº”ç”¨åŒ…å
- æ–°å¢ isAppInForeground()ï¼šåˆ¤æ–­ Time Bank æ˜¯å¦åœ¨å‰å°
- æ–°å¢ handleFloatingTimerClick()ï¼šæ™ºèƒ½åˆ¤æ–­ç‚¹å‡»è¡Œä¸º
  * å¦‚æœ Time Bank åœ¨å‰å°ï¼šæ¢å¤è®¡æ—¶ï¼ˆå¦‚æœæš‚åœï¼‰+ è·³è½¬å…³è”åº”ç”¨
  * å¦‚æœ Time Bank åœ¨åå°ï¼šæ‰“å¼€ Time Bank ä¸»ç•Œé¢ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
- WebAppInterface.startFloatingTimer() æ–°å¢ appPackage å‚æ•°
- å‰ç«¯å¯åŠ¨æ‚¬æµ®çª—æ—¶ä¼ å…¥ task.appPackage
```

#### 2) æ‚¬æµ®çª—è®¡æ—¶å™¨è¯´æ˜æŒ‰é’®
**æ–‡ä»¶**: `index.html`
```text
- è®¾ç½®é¡µã€Œæ‚¬æµ®çª—è®¡æ—¶å™¨ã€å¼€å…³æ ‡é¢˜æ—æ–°å¢è¯´æ˜æŒ‰é’®ï¼ˆ?ï¼‰
- ä»»åŠ¡ç¼–è¾‘é¡µã€Œæ‚¬æµ®çª—è®¡æ—¶å™¨ã€å¼€å…³æ ‡é¢˜æ—æ–°å¢è¯´æ˜æŒ‰é’®ï¼ˆ?ï¼‰
- æ–°å¢æ‚¬æµ®çª—è®¡æ—¶å™¨è¯´æ˜å¼¹çª—ï¼ŒåŒ…å«åŠŸèƒ½ä»‹ç»å’Œä½¿ç”¨æç¤º
- æ–°å¢å¼¹çª—é€šé€æ¨¡å¼æ ·å¼æ”¯æŒ
- æ–°å¢ showFloatingTimerInfoModal() / hideFloatingTimerInfoModal() å‡½æ•°
```

#### 3) ã€Œå…¨éƒ¨ä»»åŠ¡ã€è¾¹ä¸ŠæŒ‰é’®é¢œè‰²ä¿®å¤
**æ–‡ä»¶**: `index.html`
```text
- view-switch-btn é¢œè‰²ä» --text-color-light æ”¹ä¸º --section-title-color
- section-title-group å†…çš„ info-button é¢œè‰²æ”¹ä¸º --section-title-color
- ç¡®ä¿æŒ‰é’®é¢œè‰²ä¸æ ‡é¢˜é¢œè‰²ä¸€è‡´ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†
```

#### 4) è®¾ç½®é¡µã€Œå…³äºã€æ”¹ä¸ºå¯æŠ˜å 
**æ–‡ä»¶**: `index.html`
```text
- å°†å…³äºéƒ¨åˆ†æ”¹ä¸º details/summary å¯æŠ˜å ç»“æ„
- summary æ ·å¼ä¸ã€Œç‰ˆæœ¬æ›´æ–°æ—¥å¿—ã€ç»Ÿä¸€ï¼ˆç§»é™¤è‡ªå®šä¹‰æ ·å¼ï¼‰
- é‡æ–°æ’ç‰ˆè‘—ä½œæƒä¿¡æ¯ï¼š
  * ä½¿ç”¨ flex å¸ƒå±€å·¦å³å¯¹é½æ˜¾ç¤ºï¼ˆæ ‡ç­¾: å€¼ï¼‰
  * è½¯ä»¶åç§°å³ä¾§æ˜¾ç¤ºï¼Œé™åˆ¶æœ€å¤§å®½åº¦é¿å…æ¢è¡Œ
  * ä½¿ç”¨ CSS å˜é‡é€‚é…æ·±è‰²/æµ…è‰²ä¸»é¢˜
  * ç‰ˆæƒæ‰€æœ‰ç®€åŒ–ä¸º"å§œåŠ›æˆ"ï¼Œé‚®ç®±å•ç‹¬ä¸€è¡Œ
  * åº•éƒ¨ç‰ˆæƒä¿¡æ¯æ”¹ä¸ºå•è¡Œç´§å‡‘æ˜¾ç¤º
- ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤ºæ•ˆæœï¼Œå‡å°‘ä¸å¿…è¦çš„æ¢è¡Œ
```

#### 5) Android çŠ¶æ€æ é«˜åº¦é€‚é…
**æ–‡ä»¶**: `WebAppInterface.java`, `index.html`
```text
- WebAppInterface æ–°å¢ getStatusBarHeight() æ–¹æ³•
- index.html æ–°å¢ --status-bar-height CSS å˜é‡
- index.html æ–°å¢ setAndroidStatusBarHeight() JS å‡½æ•°
- .header padding å¢åŠ  var(--status-bar-height) å˜é‡
```

#### 6) æ¡Œé¢ç«¯ä»»åŠ¡å¡ç‰‡æ‹–æ‹½é‡æ–°è®¾è®¡
**æ–‡ä»¶**: `index.html`
```text
- ç§»é™¤ HTML5 drag API å®ç°ï¼ˆå…¼å®¹æ€§é—®é¢˜ï¼‰
- æ–°å¢æ¡Œé¢ç«¯ä¸“ç”¨æ‹–æ‹½æ–¹æ¡ˆï¼š
  * é¼ æ ‡å·¦é”®æŒ‰ä¸‹ â†’ ç§»åŠ¨è¶…è¿‡10pxå¼€å§‹æ‹–åŠ¨ â†’ é¼ æ ‡é‡Šæ”¾å®Œæˆäº¤æ¢
  * æ”¯æŒé¼ æ ‡å’Œè§¦æ§æ¿æ“ä½œ
  * æ‹–åŠ¨æ—¶å¡ç‰‡è·Ÿéšé¼ æ ‡ç§»åŠ¨
  * å…¶ä»–å¡ç‰‡å¹³æ»‘è¿‡æ¸¡åˆ°æ–°ä½ç½®
  * é‡Šæ”¾åä¿å­˜æ’åºå¹¶åŒæ­¥äº‘ç«¯
- æ–°å¢å‡½æ•°ï¼šhandleDesktopTaskDragStart/Move/End, updateDesktopCardPositions
```

#### 7) ç½‘é¡µç«¯ä¼‘çœ æ¢å¤åæ•°æ®åŒæ­¥ä¿®å¤ï¼ˆå…³é”®ä¿®å¤ï¼‰
**æ–‡ä»¶**: `index.html`
```text
é—®é¢˜ï¼šç½‘é¡µç«¯é•¿æ—¶é—´ä¼‘çœ åï¼Œwatchè¿æ¥æ–­å¼€ï¼Œæ— æ³•åŠæ—¶è·å–å®‰å“ç«¯æ›´æ–°
      å¯¼è‡´"ä»»åŠ¡æŒç»­è®¡æ—¶"ã€"ç¼ºå¤±æ–°è®°å½•"ã€"ç›‘å¬å¤±æ•ˆ"

ä¿®å¤æªæ–½ï¼š
- triggerSync() æ–°å¢ runningTasks å†²çªæ£€æµ‹ (checkRunningTasksConflict)
  * æ£€æµ‹æœ¬åœ°æœ‰ä½†äº‘ç«¯æ²¡æœ‰çš„ä»»åŠ¡ï¼ˆå…¶ä»–è®¾å¤‡å·²å…³é—­ï¼‰
  * æ£€æµ‹äº‘ç«¯æœ‰ä½†æœ¬åœ°æ²¡æœ‰çš„ä»»åŠ¡ï¼ˆå…¶ä»–è®¾å¤‡æ–°å¯åŠ¨ï¼‰
  * å‘ç”¨æˆ·æ˜¾ç¤ºå†²çªæç¤º
  
- checkAndRebuildWatchers() å¢å¼ºï¼š
  * æ–°å¢ forceRebuild å‚æ•°
  * ä¼‘çœ æ¢å¤åå¼ºåˆ¶é‡å»ºæ‰€æœ‰ watch è¿æ¥
  * é‡å»ºæˆåŠŸåé‡ç½® isRecoveringFromHibernate æ ‡å¿—
  
- visibilitychange/focus äº‹ä»¶å¤„ç†ï¼š
  * é•¿æ—¶é—´ä¼‘çœ åå¼ºåˆ¶é‡å»º watchï¼ˆå¸¦500mså»¶è¿Ÿç¡®ä¿æ•°æ®å·²åŠ è½½ï¼‰
  * çŸ­æ—¶é—´ä¼‘çœ åªæ£€æŸ¥å¤±æ•ˆè¿æ¥
  
- WebAppInterface.java æ–°å¢ï¼š
  * getStatusBarHeight() æ–¹æ³•ï¼ˆé…åˆé¡¶éƒ¨çŠ¶æ€æ é€‚é…ï¼‰
```

#### 8) ç¡çœ æ¡å½¢å›¾æ˜¾ç¤ºé”™è¯¯ä¿®å¤ï¼ˆä¸‹åˆå…¥ç¡æ˜¾ç¤ºå¼‚å¸¸ï¼‰
**æ–‡ä»¶**: `index.html` (~L27154)
```text
é—®é¢˜ï¼šä¸‹åˆå…¥ç¡ï¼ˆ13:22ï¼‰ä½†è®¡åˆ’æ—¶é—´æ˜¯æ™šä¸Šï¼ˆ22:30ï¼‰ï¼Œæ¡å½¢å›¾æ˜¾ç¤ºå¼‚å¸¸
      - å…¥ç¡æ—¶é—´ç™¾åˆ†æ¯”è®¡ç®—è¶…è¿‡100%ï¼Œæ˜¾ç¤ºåœ¨æœ€å³ä¾§å¤–
      - æ¡å½¢å›¾å®½åº¦æçª„ï¼ˆåªæœ‰ä¸€ç‚¹ç‚¹é˜´å½±ï¼‰
      - å¥–åŠ±æ˜¾ç¤ºé”™è¯¯ï¼ˆ-0.2ï¼‰

åŸå› ï¼štimeToPercent() å‡½æ•°æŠŠä¸‹åˆ1ç‚¹å½“æˆ"æ¬¡æ—¥ä¸‹åˆ1ç‚¹"è®¡ç®—ï¼Œ
      å¯¼è‡´ç›¸å¯¹å°æ—¶æ•°è¶…å‡ºåæ ‡è½´èŒƒå›´

ä¿®å¤ï¼š
- timeToPercent() æ–°å¢ isWakeTime å‚æ•°
- å¯¹äºå…¥ç¡æ—¶é—´ï¼šå¦‚æœåœ¨è½´èŒƒå›´ä¹‹åï¼ˆå¦‚13:22ï¼Œè½´ä»21:30å¼€å§‹ï¼‰ï¼Œ
  è¯´æ˜æ˜¯å‰ä¸€å¤©çš„ä¸‹åˆï¼Œå‡å»24å°æ—¶
- å¯¹äºèµ·åºŠæ—¶é—´ï¼šå¦‚æœåœ¨è½´èŒƒå›´ä¹‹å‰ï¼ˆå¦‚01:05ï¼‰ï¼ŒåŠ ä¸Š24å°æ—¶
- æ­£ç¡®è®¡ç®—ç›¸å¯¹ä½ç½®ç™¾åˆ†æ¯”
```

#### 9) ç¡çœ æ—¶åŒºé—®é¢˜ä¿®å¤ï¼ˆå…³é”®ä¿®å¤ï¼‰
**æ–‡ä»¶**: `index.html`
```text
é—®é¢˜ï¼šç”¨æˆ·å®é™…å…¥ç¡æ—¶é—´21:22ï¼Œä½†è®°å½•æ˜¾ç¤ºä¸º13:22ï¼ˆå·®8å°æ—¶ï¼‰
      ç–‘ä¼¼Android WebViewä¸­Date.now()æ—¶åŒºå¤„ç†ä¸ä¸€è‡´

æ ¹æœ¬åŸå› åˆ†æï¼š
- Date.now()åº”è¿”å›UTCæ—¶é—´æˆ³ï¼ˆæ ‡å‡†è¡Œä¸ºï¼‰
- ä½†æŸäº›Android WebViewå¯èƒ½è¿”å›æœ¬åœ°æ—¶é—´æˆ³
- å¯¼è‡´åŒ—äº¬æ—¶é—´21:22è¢«è®°å½•ä¸ºUTC 13:22ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰

ä¿®å¤æªæ–½ï¼ˆä¿æŒUTCæ ‡å‡†ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼‰ï¼š
1. æ–°å¢getCurrentUTCTimestamp()å‡½æ•°
   - ä½¿ç”¨Date.UTC()æ˜¾å¼ç”ŸæˆUTCæ—¶é—´æˆ³
   - é¿å…ä¾èµ–WebViewçš„Date.now()å®ç°

2. startSleepRecording()ä¸­ä½¿ç”¨getCurrentUTCTimestamp()
   æ›¿ä»£Date.now()è®°å½•å…¥ç¡æ—¶é—´

3. æ‰‹åŠ¨ç¡çœ è¡¥å½•ä¸­æ˜¾å¼æ·»åŠ ç§’(:00)
   - new Date(`${date}T${time}:00`)ç¡®ä¿æœ¬åœ°æ—¶é—´æ­£ç¡®è§£æ

è¯„ä¼°ï¼šä¿æŒUTCæ—¶é—´æˆ³æ–¹æ¡ˆï¼ˆä¸æ”¹ä¸ºåŒ—äº¬æ—¶é—´ç”Ÿæˆï¼‰
- ç¬¦åˆå›½é™…æ ‡å‡†
- è·¨æ—¶åŒºå…¼å®¹æ€§å¥½
- æ•°æ®å­˜å‚¨ç»Ÿä¸€
```

#### 10) ç¡çœ æŠ¥å‘Šå¼¹çª—ä¿®å¤ä¸ä¼˜åŒ–ï¼ˆv7.13.0ï¼‰
**æ–‡ä»¶**: `index.html` (~L26320)
```text
é—®é¢˜ï¼š
1. æ˜¨å¤©ã€å‰å¤©ç­‰æ—¥æœŸçš„æ¡å½¢å›¾ç‚¹å‡»æ— ååº”
2. éœ€è¦å¢åŠ æ˜ŸæœŸæ˜¾ç¤º
3. è®¡åˆ’æ—¶é—´æ˜¾ç¤ºæ ¼å¼éœ€è¦ç²¾ç®€

ä¿®å¤æ–¹æ¡ˆï¼ˆæœ€å°åŒ–ä¿®æ”¹ï¼‰ï¼š
1. showSleepReportModal() æ·»åŠ é˜²å¾¡æ€§æ£€æŸ¥ï¼š
   if (!record || !record.sleepStartTime || !record.wakeTime) return;
   - è§£å†³ getSleepRecordForDate è¿”å› null æ—¶å´©æºƒé—®é¢˜

2. æ—¥æœŸæ ¼å¼ï¼ˆé¿å…åŒå±‚æ‹¬å·ï¼‰ï¼š
   - ä»Šæ—¥å‘¨ä¸€ï¼ˆä¸æ˜¯"ä»Šæ—¥ï¼ˆå‘¨ä¸€ï¼‰"ï¼‰
   - æ˜¨æ—¥å‘¨æ—¥
   - 2æœˆ3æ—¥å‘¨ä¸€

3. è®¡åˆ’æ—¶é—´æ ¼å¼ç²¾ç®€ï¼š
   åŸï¼šè®¡åˆ’å…¥ç¡ 22:30 Â· è®¡åˆ’èµ·åºŠ 06:30 Â· ç›®æ ‡ 8å°æ—¶
   æ–°ï¼šè®¡åˆ’æ—¶é—´ 22:30~06:30 Â· 8å°æ—¶0åˆ†
```

#### 11) ç¡çœ æ—¶åŒºä¸¥é‡ Bug ä¿®å¤ï¼ˆv7.13.1ï¼‰ã€å…³é”®ä¿®å¤ã€‘
**æ–‡ä»¶**: `index.html` (~L26599)
```text
é—®é¢˜ï¼ˆä¸¥é‡ï¼‰ï¼š
- ç”¨æˆ·åŒ—äº¬æ—¶é—´ 00:05 å…¥ç¡ï¼Œè¢«é”™è¯¯è®°å½•ä¸º 08:05
- å¯¼è‡´ç¡çœ æ—¶é—´æ˜¾ç¤ºå’Œè®¡ç®—å®Œå…¨é”™è¯¯

æ ¹å› åˆ†æï¼š
- getCurrentUTCTimestamp() å®ç°é”™è¯¯
- ä½¿ç”¨ new Date() è·å–æœ¬åœ°æ—¶é—´ç»„ä»¶
- ç”¨ Date.UTC() æŠŠæœ¬åœ°å°æ—¶å½“æˆ UTC å°æ—¶æ„é€ æ—¶é—´æˆ³
- ç»“æœï¼šåŒ—äº¬æ—¶é—´ 00:05 â†’ é”™è¯¯åœ°ç”Ÿæˆ UTC 00:05 æ—¶é—´æˆ³

ä¿®å¤ï¼š
- ç›´æ¥è¿”å› Date.now()ï¼Œå®ƒæœ¬èº«å°±æ˜¯ UTC æ—¶é—´æˆ³
- åˆ é™¤é”™è¯¯çš„ Date.UTC() æ„é€ é€»è¾‘

æ•™è®­ï¼š
- Date.UTC(year, month, day, hours...) ä¼šæŠŠå‚æ•°å½“æˆ UTC æ—¶é—´
- å¦‚æœç”¨æœ¬åœ°æ—¶é—´ç»„ä»¶è°ƒç”¨ Date.UTC()ï¼Œä¼šäº§ç”Ÿæ—¶åŒºåç§»é”™è¯¯
- Date.now() æˆ– new Date().getTime() æœ¬èº«å°±æ˜¯ UTC æ—¶é—´æˆ³
```

---
## v7.11.4 (2026-02-03) - æ— å…³é”®æ”¹åŠ¨

### å…³é”®æ”¹åŠ¨
ï¼ˆä»… UI é—´è·ä¸ç¼“å­˜ç‰ˆæœ¬æ›´æ–°ï¼Œä¸è®°å½•ä¸ºå…³é”®æ”¹åŠ¨ï¼‰

## v7.11.3 (2026-02-03) - ç¡çœ åŒæ­¥æœºåˆ¶

### å…³é”®æ”¹åŠ¨

#### 1) ç¡çœ è®¾ç½®/çŠ¶æ€æ”¹ä¸ºäº‘ç«¯å…±äº« + å®æ—¶ç›‘å¬
**æ–‡ä»¶**: `index.html` (~L24880, ~L10880)
```text
deviceSleepSettings/deviceSleepState â†’ sleepSettingsShared/sleepStateShared
Profile watch å¢åŠ  applySleepSettingsFromCloud/applySleepStateFromCloud
```

#### 2) ç¡çœ è®¾ç½®å…±äº«ä¸ºå”¯ä¸€çœŸç›¸ï¼ˆå¼ºåˆ¶åº”ç”¨äº‘ç«¯ï¼‰
**æ–‡ä»¶**: `index.html` (~L25080, ~L10890)
```text
applySleepSettingsFromCloud å¢åŠ  forceï¼›shared/watch å¼ºåˆ¶è¦†ç›–æœ¬åœ°
```

## v7.11.2 (2026-02-02) - è®¾ç½®é‡å¯åä¸¢å¤±é—®é¢˜ï¼ˆä¸‰å±‚é—®é¢˜ä¿®å¤ï¼‰

### é—®é¢˜é“¾ï¼ˆé‡è¦ç»éªŒï¼‰
```
é—®é¢˜1: WebView localStorage ä¸å¯é 
    â†“ ä¿®å¤åå‘ç°
é—®é¢˜2: initApp() ä¸­ updateNotificationSettingsUI() å´©æºƒï¼Œé˜»æ–­åç»­ init å‡½æ•°
    â†“ ä¿®å¤åå‘ç°  
é—®é¢˜3: åˆ†ç±»æ ‡ç­¾å­˜å‚¨ä½ç½®åˆ†ç¦»ï¼ŒinitScreenTimeSettings æœªä» profile.screenTimeCategories æ¢å¤
```

### è°ƒè¯•ç»éªŒ
1. **WebView console.log è¢«ç³»ç»Ÿè¿‡æ»¤** â†’ éœ€ç”¨åŸç”Ÿæ–¹æ³•æ‰“æ—¥å¿—æ‰èƒ½çœ‹åˆ°çœŸç›¸
2. **é”™è¯¯ä¼šä¼ æ’­é˜»æ–­** â†’ ä¸€ä¸ªæ—©æœŸé”™è¯¯ä¼šä¸­æ–­åç»­æ‰€æœ‰åˆå§‹åŒ–ï¼Œå¿…é¡»ç”¨ try-catch éš”ç¦»
3. **æ¶æ„å¤æ‚æ€§** â†’ åŒä¸€åŠŸèƒ½çš„æ•°æ®å¯èƒ½åˆ†æ•£åœ¨å¤šä¸ªä½ç½®å­˜å‚¨

### å…³é”®ä¿®å¤

#### 1. Android åŸç”Ÿå­˜å‚¨ï¼ˆè§£å†³ localStorage ä¸å¯é ï¼‰
**æ–‡ä»¶**: `WebAppInterface.java`
```java
// æ–°å¢æ–¹æ³•
@JavascriptInterface
public void saveScreenTimeSettingsNative(String json) {
    prefs.edit().putString("screenTimeSettings", json).apply();
}
@JavascriptInterface
public String getScreenTimeSettingsNative() {
    return prefs.getString("screenTimeSettings", null);
}
// åŒç†: saveSleepSettingsNative, getSleepSettingsNative, saveSleepStateNative, getSleepStateNative
// è°ƒè¯•ç”¨: nativeLog(String tag, String message)
```

#### 2. é˜²æ­¢ initApp ä¸­æ–­ï¼ˆtry-catch éš”ç¦»ï¼‰
**æ–‡ä»¶**: `index.html` (~L11638)
```javascript
// ä¿®æ”¹å‰
updateNotificationSettingsUI();
initScreenTimeSettings();
initSleepSettings();

// ä¿®æ”¹å
try { updateNotificationSettingsUI(); } catch (e) { console.error(e); }
try { initScreenTimeSettings(); } catch (e) { console.error(e); }
try { initSleepSettings(); } catch (e) { console.error(e); }
```

#### 3. åˆ†ç±»æ ‡ç­¾ä»äº‘ç«¯æ¢å¤
**æ–‡ä»¶**: `index.html`

**å­˜å‚¨æ¶æ„**ï¼ˆå¯¼è‡´é—®é¢˜çš„æ ¹å› ï¼‰:
```
deviceScreenTimeSettings[deviceId]  â†’ enabled, dailyLimit ç­‰ï¼ˆè®¾å¤‡ä¸“å±ï¼‰
profile.screenTimeCategories        â†’ earnCategory, spendCategoryï¼ˆè·¨è®¾å¤‡å…±äº«ï¼‰
```

**ä¿®å¤**: åœ¨ `initScreenTimeSettings()` ä¸­æ·»åŠ  (~L27305):
```javascript
// [v7.11.2] ä»äº‘ç«¯æ¢å¤åˆ†ç±»æ ‡ç­¾
if (isLoggedIn() && DAL.profileData?.screenTimeCategories) {
    const categories = DAL.profileData.screenTimeCategories;
    if (categories.earnCategory !== undefined) {
        screenTimeSettings.earnCategory = categories.earnCategory;
    }
    if (categories.spendCategory !== undefined) {
        screenTimeSettings.spendCategory = categories.spendCategory;
    }
}
```

**ä¿®å¤**: åœ¨ `updateScreenTimeCategories()` ä¸­æ·»åŠ åŸç”Ÿå­˜å‚¨ (~L27791):
```javascript
// ä¿®æ”¹åˆ†ç±»ååŒæ­¥åˆ°åŸç”Ÿå­˜å‚¨
if (window.Android?.saveScreenTimeSettingsNative) {
    window.Android.saveScreenTimeSettingsNative(JSON.stringify(screenTimeSettings));
}
```

#### 4. è®¾å¤‡è¿ç§»æ¢å¤
```javascript
function getLatestDeviceSettings(deviceSettingsMap) {
    // éå†æ‰€æœ‰è®¾å¤‡é…ç½®ï¼Œè¿”å› lastUpdated æœ€æ–°çš„
    // ç”¨äºé‡è£…å deviceId æ”¹å˜æ—¶æ¢å¤è®¾ç½®
}
```

---
## v7.11.1 (2026-02-02) - è·¨è®¾å¤‡åŒæ­¥ä¸æ¢å¤

### å…³é”®æ”¹åŠ¨
**æ–‡ä»¶**: `index.html`

- å‡è¡¡æ¨¡å¼ï¼šæ”¹ä¸ºäº‘ç«¯å”¯ä¸€çœŸç›¸ï¼Œå¿½ç•¥æœ¬åœ°ç¼“å­˜
- è‡ªåŠ¨æ£€æµ‹è¡¥å½•ï¼šæ”¹ä¸ºå¤šè®¾å¤‡åŸå§‹è®°å½•ï¼ˆ`autoDetectRawRecords`ï¼‰+ æ±‡æ€»ç”Ÿæˆæœ€ç»ˆè¡¥å½•/ä¿®æ­£äº¤æ˜“
- è‡ªåŠ¨æ£€æµ‹å¤„ç†æ—¥æœŸï¼šäº‘ç«¯å…¨å±€è®°å½•ï¼ˆ`autoDetectProcessedDates`ï¼‰ï¼Œé¿å…é‡å¤ç»“ç®—
- ç½‘é¡µç«¯é•¿æ—¶é—´ä¼‘çœ æ¢å¤ï¼šç™»å½•æ€å¾…æ¢å¤æ—¶è·³è¿‡æœ¬åœ°ç¼“å­˜å¹¶ç­‰å¾…äº‘ç«¯ï¼Œé˜²æ­¢æ—§æ•°æ®è¦†ç›–
- ç½‘é¡µç«¯æ¢å¤è¶…æ—¶å…œåº•ï¼šå¼ºåˆ¶åˆ·æ–°ç™»å½•çŠ¶æ€å¹¶é‡æ‹‰äº‘ç«¯æ•°æ®

## v7.11.0 (2026-02-01) - æ— å…³é”®æ”¹åŠ¨

### å…³é”®æ”¹åŠ¨
ï¼ˆå¼•å¯¼å®šä½ä¸äº¤äº’ä¼˜åŒ–ä¸º UI/ä½“éªŒå±‚è°ƒæ•´ï¼Œä¸è®°å½•ä¸ºå…³é”®æ”¹åŠ¨ï¼‰

## v7.10.1 (2026-01-31) - æ— å…³é”®æ”¹åŠ¨

### å…³é”®æ”¹åŠ¨
ï¼ˆæ–°æ‰‹å¼•å¯¼å®šä½ä¸äº¤äº’ä¼˜åŒ–ä¸º UI/ä½“éªŒå±‚è°ƒæ•´ï¼Œä¸è®°å½•ä¸ºå…³é”®æ”¹åŠ¨ï¼‰

#### 5. ä¿®å¤æ¶ˆè´¹ä»»åŠ¡æˆ’é™¤è®¾ç½®æ˜¾ç¤º
- `ensureOnboardingHabitEnabled()` ç°åœ¨ä¼šè°ƒç”¨ `updateTaskTypeUI()` ç¡®ä¿æˆ’é™¤è®¾ç½®åŒºåŸŸæ­£ç¡®æ˜¾ç¤º

#### 6. å¼•å¯¼ç»“æŸæ¸…ç†
- `finishTaskOnboarding()` å…³é—­æ‰€æœ‰æ‰“å¼€çš„å¼¹çª—å’Œèœå•ï¼Œé‡ç½®çŠ¶æ€

#### 7. å¼•å¯¼èœå•ç¼–è¾‘æµç¨‹ä¿®å¤
**æ–‡ä»¶**: `index.html`
- æ¢å¤ä»»åŠ¡å¼•å¯¼æ­¥éª¤ç»“æ„ï¼ˆè¡¥å› `pick-earn-task`ï¼‰ï¼Œç§»é™¤â€œç‚¹å‡»èœå•â€æ­¥éª¤ï¼Œä»…ä¿ç•™â€œè¿›å…¥ç¼–è¾‘â€ã€‚
- æ–°å¢ `openOnboardingMenuEdit(taskId)`ï¼šæ‰“å¼€èœå•å¹¶ä¸ºâ€œç¼–è¾‘â€é¡¹ç»‘å®šå…œåº•ç‚¹å‡»ï¼Œç¡®ä¿è¿›å…¥ç¼–è¾‘å¼¹çª—ã€‚
- æ¶ˆè´¹ç±»ä»»åŠ¡å¼•å¯¼åˆ‡æ¢æ—¶å…³é—­ä¸Šä¸€ä»»åŠ¡ç¼–è¾‘å¼¹çª—ï¼Œé¿å…é˜»æ–­åç»­å¼•å¯¼ã€‚

#### 8. å¼•å¯¼ç¼–è¾‘å¼¹çª—æ»šåŠ¨é‡ç½®
**æ–‡ä»¶**: `index.html`
- `openOnboardingEditTask()` åœ¨å¼•å¯¼æœŸé—´æ‰“å¼€ç¼–è¾‘å¼¹çª—åé‡ç½®æ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œé¿å…åœç•™åœ¨åº•éƒ¨å¯¼è‡´å®šä½å¤±è´¥ã€‚

#### 9. æ¶ˆè´¹å¼•å¯¼å®šä½ä¿®å¤
**æ–‡ä»¶**: `index.html`
- â€œè¿›å…¥æˆ’é™¤é…ç½®â€æ­¥éª¤ç›®æ ‡æ”¹ä¸º `#habitToggleContainer` å¹¶æ»šåŠ¨å®šä½ï¼Œé¿å…é”™è¯¯æŒ‡å‘ä»»åŠ¡ç±»å‹ã€‚

#### 10. æ¶ˆè´¹å¼•å¯¼ä¿å­˜æŒ‰é’®å®šä½
**æ–‡ä»¶**: `index.html`
- â€œä¿å­˜ä¸ºæˆ‘çš„ä»»åŠ¡â€æ­¥éª¤æ”¹ç”¨ `getVisibleElement('#submitBtn')` å¹¶æ»šåŠ¨å®šä½ï¼Œé¿å…æŒ‰é’®ä¸å¯è§å¯¼è‡´å¡ä½ã€‚

#### 11. æ¶ˆè´¹æˆ’é™¤æ­¥éª¤ç­‰å¾…æ—¶é—´
**æ–‡ä»¶**: `index.html`
- ä¸ºæ¶ˆè´¹æˆ’é™¤ç›¸å…³æ­¥éª¤å¢åŠ  `waitTime`ï¼Œç¡®ä¿ä¹ æƒ¯æˆ’é™¤ UI åˆ‡æ¢å®Œæˆåå†å®šä½å¼•å¯¼ã€‚

### æŠ€æœ¯è¦ç‚¹
- **æ»šåŠ¨å®¹å™¨è¯†åˆ«**: å¼¹çª—å†…å…ƒç´ ä½¿ç”¨ `.modal-content` æ»šåŠ¨ï¼Œä¸»é¡µé¢ä½¿ç”¨ `#appScrollContainer`
- **æ»šåŠ¨å›è°ƒ**: ç›‘å¬ `scroll` äº‹ä»¶ç»“æŸï¼ˆ80ms æ— æ»šåŠ¨ï¼‰åè§¦å‘å›è°ƒ
- **åŒé‡ rAF**: ä½¿ç”¨ä¸¤æ¬¡ `requestAnimationFrame` ç¡®ä¿æµè§ˆå™¨å®Œæˆå¸ƒå±€è®¡ç®—
- **èœå•é”å®š**: `onboardingMenuLocked` æ ‡å¿—é˜²æ­¢ç‚¹å‡»/æ»šåŠ¨å…³é—­èœå•

---

## v7.10.0 (2026-01-31) - é¦–æ¬¡å¯åŠ¨ç¤ºä¾‹å¯¼å…¥å¼¹çª—

### å…³é”®æ”¹åŠ¨
**æ–‡ä»¶**: `index.html`
- é¦–æ¬¡å¯åŠ¨æ—¶å¼¹å‡ºç¤ºä¾‹æ•°æ®å¼•å¯¼å¼¹çª—ï¼Œå±•ç¤ºä¸¤æ¡ç¤ºä¾‹ä»»åŠ¡å¹¶å¼•å¯¼å¯¼å…¥ã€‚
- æ–°å¢ `tb_first_launch_demo_shown`/`tb_onboarding_pending` æ ‡è®°ï¼Œé¿å…é‡å¤å¼¹çª—å¹¶ä¸ºåç»­å¯¼è§ˆç•™é’©å­ã€‚
- æ–°å¢åˆ›å»ºä»»åŠ¡æ–°æ‰‹å¼•å¯¼ï¼ˆFAB â†’ ä»»åŠ¡ç±»å‹ â†’ ç±»å‹é€‰é¡¹ï¼‰ä¸å¯¼è§ˆå®šä½ä¼˜åŒ–ï¼ŒåŒ…å« `tb_task_onboarding_pending`/`tb_task_onboarding_done` çŠ¶æ€ã€‚
- ä»»åŠ¡ç±»å‹é€‰æ‹©åæ–°å¢ç»†åˆ†å¼•å¯¼ï¼ˆæŒ‰æ¬¡/è®¡æ—¶/è¾¾æ ‡/æ¶ˆè´¹ï¼‰ï¼Œè¦†ç›–ä¹ æƒ¯ç³»ç»Ÿã€æ‚¬æµ®çª—ä¸æˆ’é™¤ä¹ æƒ¯è¯´æ˜ï¼›å¯¼è§ˆå®šä½é€‚é… `visualViewport` å¹¶æ”¯æŒæ»šåŠ¨æ—¶é‡å®šä½ã€‚
- åˆ›å»ºä»»åŠ¡å¼•å¯¼æ”¹ä¸ºâ€œä¼˜ç§€ä»»åŠ¡ç¤ºä¾‹â€çš„ç¼–è¾‘å¼å¼•å¯¼ï¼ˆä» FAB ç›´è¾¾ç¤ºä¾‹ç¼–è¾‘é¡µï¼‰ï¼Œå±•ç¤ºä¹ æƒ¯ç³»ç»Ÿã€æ‚¬æµ®çª—ã€æˆ’é™¤æŒ‘æˆ˜ä¸å…³è”åº”ç”¨ç­‰é«˜çº§èƒ½åŠ›ã€‚
- åˆ›å»ºä»»åŠ¡å¼•å¯¼æ”¹ä¸ºåœ¨ä»»åŠ¡åˆ—è¡¨é€‰æ‹©åˆé€‚ä»»åŠ¡ï¼Œé€šè¿‡â€œèœå•â†’ç¼–è¾‘â€è¿›å…¥ç¼–è¾‘é¡µç»§ç»­å¼•å¯¼ï¼Œè¦†ç›–å€ç‡ã€æ‚¬æµ®çª—ã€ä¹ æƒ¯ä¸æˆ’é™¤é…ç½®ï¼Œå¹¶å¯¹ä¸‹æ–¹æ­¥éª¤è¿›è¡ŒæŒ‰éœ€æ»šåŠ¨å®šä½ã€‚
- åˆ›å»ºä»»åŠ¡å¼•å¯¼ä¼˜å…ˆé€‰å–å¼€å¯ä¹ æƒ¯çš„ä»»åŠ¡ï¼Œå¹¶åœ¨èœå•ä¿æŒå±•å¼€æ—¶èšç„¦â€œç¼–è¾‘â€æŒ‰é’®ï¼›ä»…åœ¨å…ƒç´ ä¸åœ¨è§†å£æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨ã€‚

---

## v7.9.13 (2026-01-31) - å‡è¡¡æ¨¡å¼é™åˆ¶ç§»é™¤ä¸æ¯æ—¥è¯¦æƒ…è¯´æ˜ä¼˜åŒ–

### å…³é”®æ”¹åŠ¨
**æ–‡ä»¶**: `index.html`
- ç§»é™¤å‡è¡¡æ¨¡å¼ 180 å¤©é”å®šé™åˆ¶ï¼Œå…è®¸éšæ—¶å¼€å¯/å…³é—­ï¼Œå¹¶åˆ é™¤ç›¸å…³æç¤ºä¸å€’è®¡æ—¶æ–‡æ¡ˆã€‚
- æ¯æ—¥è¯¦æƒ…æ ‡é¢˜çš„â€œï¼Ÿâ€è¯´æ˜æŒ‰é’®æ ·å¼ä¸å…¶ä»–åŒºåŸŸä¿æŒä¸€è‡´ï¼ˆé€šé€æ¨¡å¼ä¸‹ç»Ÿä¸€æ ·å¼ï¼‰ã€‚
- æ¯æ—¥è¯¦æƒ…è¯´æ˜å¼¹çª—æ”¹ä¸ºåˆ—è¡¨å¼æ’ç‰ˆï¼Œç»“æ„ä¸å…¶ä»–è¯´æ˜å¼¹çª—ä¸€è‡´ã€‚

---

## v7.9.12 (2026-01-31) - ç‰ˆæœ¬å·ä¸ç¼“å­˜æ›´æ–°

### å…³é”®æ”¹åŠ¨
**æ–‡ä»¶**: `index.html`, `sw.js`
- ç‰ˆæœ¬å·å‡çº§åˆ° `v7.9.12`ã€‚
- Service Worker ç¼“å­˜åæ›´æ–°ä¸º `timebank-cache-v7.9.12`ã€‚

---

## v7.9.11 (2026-01-31) - é€šé€æ¨¡å¼å¯è¯»æ€§ä¿®å¤

### é—®é¢˜èƒŒæ™¯
ç¡çœ æŠ¥å‘Šä¸æ¯æ—¥è¯¦æƒ…è¯´æ˜æŒ‰é’®åœ¨é€šé€æ¨¡å¼ä¸‹å¯¹æ¯”åº¦ä¸è¶³ï¼Œå¯¼è‡´æ–‡å­—ä¸æŒ‰é’®å¯è¯»æ€§å·®ã€‚

### è§£å†³æ–¹æ¡ˆ
1. æå‡ç¡çœ æŠ¥å‘Šå¼¹çª—çš„æ–‡å­—å¯¹æ¯”ä¸æ˜ç»†åŒºåŸŸèƒŒæ™¯ï¼Œç¡®ä¿é€šé€æ¨¡å¼ä¸‹æ¸…æ™°å¯è¯»ã€‚
2. å¼ºåŒ–æ¯æ—¥è¯¦æƒ…å¼¹çª—â€œï¼Ÿâ€è¯´æ˜æŒ‰é’®åœ¨é€šé€æ¨¡å¼ä¸‹çš„è¾¹æ¡†ä¸èƒŒæ™¯å¯¹æ¯”åº¦ã€‚

### å…³é”®æ”¹åŠ¨

#### 1. ç¡çœ æŠ¥å‘Šé€šé€æ¨¡å¼æ ·å¼å¢å¼º
**æ–‡ä»¶**: `index.html`
- ä¸º `#sleepReportModal` çš„ `text-muted` æ–‡æœ¬æå‡äº®åº¦ä¸é˜´å½±ã€‚
- ä¸º `.sleep-report-details` å¢åŠ åŠé€æ˜èƒŒæ™¯ã€è¾¹æ¡†ä¸å†…è¾¹è·ï¼Œå¢å¼ºå¯è¯»æ€§ã€‚

#### 2. æ¯æ—¥è¯¦æƒ…è¯´æ˜æŒ‰é’®é€šé€æ¨¡å¼å¯è¯»æ€§
**æ–‡ä»¶**: `index.html`
- ä¸º `#dayDetailModal .info-button` è®¾ç½®æ›´é«˜å¯¹æ¯”çš„è¾¹æ¡†ã€æ–‡å­—ä¸èƒŒæ™¯è‰²ã€‚

#### 3. ç‰ˆæœ¬å·ä¸ç¼“å­˜æ›´æ–°
**æ–‡ä»¶**: `index.html`, `sw.js`
- ç‰ˆæœ¬å·å‡çº§åˆ° `v7.9.11` å¹¶æ›´æ–° Service Worker ç¼“å­˜åã€‚

#### 4. ç½‘é¡µç«¯ç™»å½•æ¢å¤é˜²æŠ¤
**æ–‡ä»¶**: `index.html`
- å¯åŠ¨æ—¶ä»¥ `DAL.getCurrentUid()` åˆ¤å®šç™»å½•ï¼Œé¿å…ä»…å‡­ç¼“å­˜å¯¼è‡´è¯¯åˆ¤æœªç™»å½•ã€‚
- ç½‘é¡µç«¯ç™»å½•çŠ¶æ€å¾…æ¢å¤æ—¶ï¼Œå»¶è¿ŸåŠ è½½æœ¬åœ°ç¼“å­˜ï¼Œå¹¶è½®è¯¢ç­‰å¾… UID å°±ç»ªåå†åŠ è½½äº‘ç«¯æ•°æ®ã€‚
- `loadData()` åœ¨æ£€æµ‹åˆ°ç™»å½•æ€æˆ–å¾…æ¢å¤ç™»å½•æ€æ—¶è·³è¿‡æœ¬åœ°ç¼“å­˜ï¼Œé¿å…æ—§æ•°æ®è¦†ç›–äº‘ç«¯ã€‚

---

## v7.9.10 (2026-01-30) - è¡¥å½•è¿èƒœè·¨è®¾å¤‡åŒæ­¥ä¿®å¤

### é—®é¢˜èƒŒæ™¯
è¡¥å½•è§¦å‘ `rebuildHabitStreak()` åï¼Œè¿èƒœä¸è¡¥å‘å¥–åŠ±ä»…æ›´æ–°æœ¬åœ°ä»»åŠ¡/äº¤æ˜“ï¼Œäº‘ç«¯æœªåŒæ­¥ï¼Œå¯¼è‡´å…¶ä»–è®¾å¤‡ä¸Šè¿èƒœå¼‚å¸¸ä¸­æ–­ã€‚

### è§£å†³æ–¹æ¡ˆ
1. é‡å»ºè¿èƒœååŒæ­¥ä»»åŠ¡ä¸äº¤æ˜“åˆ°äº‘ç«¯ï¼Œç¡®ä¿è·¨è®¾å¤‡ä¸€è‡´ã€‚
2. æ–°å¢äº¤æ˜“æ›´æ–°èƒ½åŠ›ï¼Œç”¨äºè¡¥å½•é‡å»ºæ—¶ä¿®æ­£ `isStreakAdvancement` ä¸å¥–åŠ±é‡‘é¢ã€‚

### å…³é”®æ”¹åŠ¨

#### 1. è¿èƒœé‡å»ºåäº‘åŒæ­¥
**æ–‡ä»¶**: `index.html`
- `rebuildHabitStreak()` è®°å½•å˜æ›´å‰å¿«ç…§ï¼Œè®¡ç®—å˜æ›´çš„äº¤æ˜“åˆ—è¡¨ã€‚
- æ–°å¢ `syncHabitRebuildToCloud()`ï¼šåŒæ­¥æ›´æ–°åçš„ä»»åŠ¡ä¸äº¤æ˜“åˆ° CloudBaseã€‚

#### 2. äº‘ç«¯äº¤æ˜“æ›´æ–°æ¥å£
**æ–‡ä»¶**: `index.html`
- æ–°å¢ `DAL.updateTransaction(tx, prevTx)`ï¼šæ›´æ–°äº¤æ˜“å­—æ®µï¼Œå¹¶æ ¹æ®å˜æ›´è°ƒæ•´æ—¥æ±‡æ€»ä¸ç¼“å­˜ä½™é¢ã€‚

#### 3. æ‰‹åŠ¨è¡¥å½•æ˜¾ç¤ºæ ¼å¼ç»Ÿä¸€
**æ–‡ä»¶**: `index.html`
- `parseTransactionDescription()`ï¼šæ‰‹åŠ¨è¡¥å½•è®°å½•æŒ‰æ­£å¸¸å®Œæˆæ ¼å¼è§£æï¼Œä»…ä¿ç•™ğŸ“…å›¾æ ‡ã€‚
- è¡¥å½•å«ä¹ æƒ¯å¥–åŠ±ä¸”å‡è¡¡æ¨¡å¼æ—¶ï¼ŒåŸºç¡€å¥–åŠ±ä¸å†è¢«è¯¯åˆ¤ä¸º 0 ç§’ã€‚
- æ‰‹åŠ¨è¡¥å½•æ ‡é¢˜å¼ºåˆ¶çº¯å‡€ï¼Œä»…å±•ç¤ºä»»åŠ¡åï¼›æ—¶é—´/å€ç‡/å‡è¡¡ä¿¡æ¯å…¨éƒ¨è¿›å…¥è¯¦æƒ…è¡Œã€‚
- å…¼å®¹å…¨è§’æ‹¬å·ä¸â€œå‡è¡¡æ¨¡å¼â€åç¼€ï¼Œé¿å…æ ‡é¢˜æ®‹ç•™ä¸è®¡æ—¶è¯¦æƒ…ä¸¢å¤±ã€‚
- æ‰‹åŠ¨è¡¥å½•è®¡æ—¶ç±»åœ¨æè¿°è§£æå¤±è´¥æ—¶å›é€€é‡å»ºâ€œæ—¶é•¿ Ã— ä»»åŠ¡å€ç‡ (+å‡è¡¡å€ç‡)â€ã€‚
- å…¼å®¹â€œè¡¥å½•ï¼šâ€å…¨è§’å†’å·ä¸ isBackdate æ ‡è®°ï¼Œç¡®ä¿æ‰‹åŠ¨è¡¥å½•è§£æå¿…èµ°ç»Ÿä¸€æ ¼å¼ã€‚

#### 4. æ¯æ—¥è¯¦æƒ…å›¾ä¾‹è¯´æ˜æŒ‰é’®
**æ–‡ä»¶**: `index.html`
- æ–°å¢ `showDayDetailLegend()` å¹¶åœ¨æ¯æ—¥è¯¦æƒ…æ ‡é¢˜å³ä¾§æ·»åŠ è¯´æ˜æŒ‰é’®ï¼Œè§£é‡Šå›¾æ ‡å«ä¹‰ä¸å½©è‰²å€ç‡/å¥–åŠ±æ ‡è¯†ã€‚

#### 5. ç¡çœ è®°å½•å±•ç¤ºç»Ÿä¸€ä¸è‡ªåŠ¨ç»“ç®—æè¿°è¡¥é½
**æ–‡ä»¶**: `index.html`
- è‡ªåŠ¨ç¡çœ ç»“ç®—äº¤æ˜“è¡¥é½ `description` å­—æ®µï¼ˆ`ğŸ˜´ å¤œé—´ç¡çœ : <time>`ï¼‰ã€‚
- æ—  description çš„ç¡çœ è®°å½•åœ¨è§£ææ—¶ç»Ÿä¸€æ ‡é¢˜ä¸ºâ€œå¤œé—´ç¡çœ æ—¶é—´â€ï¼Œå¹¶ä½¿ç”¨ğŸ˜´å›¾æ ‡ã€‚

#### 6. è¯´æ˜å¼¹çª—é¢œè‰²ç¤ºä¾‹ä¿®å¤
**æ–‡ä»¶**: `index.html`
- `.multiplier-good/.multiplier-bad/.bonus-target/.bonus-habit` é¢œè‰²æ ·å¼æ”¹ä¸ºå…¨å±€ç±»ï¼Œç¡®ä¿è¯´æ˜å¼¹çª—æ­£ç¡®ç€è‰²ã€‚

#### 7. ç‰ˆæœ¬å·æ›´æ–°ä¸ç¼“å­˜æ›´æ–°
**æ–‡ä»¶**: `index.html`, `sw.js`
- ç‰ˆæœ¬å·å‡çº§åˆ° `v7.9.10` å¹¶æ›´æ–° Service Worker ç¼“å­˜åã€‚

---

## v7.9.9 (2026-01-29) - æœªç™»å½•ä½“éªŒä¸ç¤ºä¾‹æ•°æ®æ¸…ç†

### é—®é¢˜èƒŒæ™¯
æœªç™»å½•çŠ¶æ€ä¸‹ä»»åŠ¡æ— æ³•ç¨³å®šåˆ›å»º/åˆ é™¤ï¼›æ–°ç”¨æˆ·è¯•ç”¨é˜¶æ®µç¼ºä¹å¯è§çš„å®Œæ•´ç¤ºä¾‹æ•°æ®ï¼›ç™»å½•åç¤ºä¾‹æ•°æ®ä¸ç”¨æˆ·è‡ªå»ºæ•°æ®æ··æ‚ã€‚

### è§£å†³æ–¹æ¡ˆ
1. æ–°ç”¨æˆ·æœªç™»å½•æ—¶è‡ªåŠ¨åŠ è½½ç¤ºä¾‹æ•°æ®ï¼Œå®Œæ•´å±•ç¤ºâ€œæœ€è¿‘ä»»åŠ¡/å…¨éƒ¨ä»»åŠ¡â€ã€‚
2. ç™»å½•æˆåŠŸåæ— æç¤ºæ¸…ç†ç¤ºä¾‹æ•°æ®ï¼ˆä»…åˆ é™¤ demo_ ä»»åŠ¡ä¸äº¤æ˜“ï¼‰ï¼Œä¿ç•™ç”¨æˆ·è‡ªå»ºæ•°æ®ã€‚
3. ç™»å½•åè‹¥äº‘ç«¯æ— æ•°æ®ï¼Œè‡ªåŠ¨ä½¿ç”¨æœ¬åœ°æ•°æ®ä½œä¸ºåˆå§‹åŒæ­¥æºï¼›æ— æœ¬åœ°æ•°æ®åˆ™åˆ›å»ºç©º Profileã€‚

### å…³é”®æ”¹åŠ¨

#### 1. ç™»å½•åˆ¤å®šæ›´ä¸¥æ ¼
**æ–‡ä»¶**: `index.html`
- `isLoggedIn()` ç°åœ¨è¦æ±‚å­˜åœ¨æœ‰æ•ˆ `uid`ï¼Œé¿å…â€œä¼ªç™»å½•â€çŠ¶æ€é˜»æ–­æœ¬åœ°ä¿å­˜ã€‚

#### 2. ç¤ºä¾‹æ•°æ®é€»è¾‘é‡æ„
**æ–‡ä»¶**: `index.html`
- `checkAndBootstrap()`ï¼šä¿æŒç©ºç™½çŠ¶æ€ï¼Œä»…æ˜¾ç¤ºâ€œç¤ºä¾‹æ•°æ®å¯¼å…¥â€CTAã€‚
- æ–°å¢ `cleanupDemoDataLocal()` / `cleanupDemoDataOnLogin()`ï¼šé™é»˜æ¸…ç† demo æ•°æ®å¹¶é‡ç®—ä½™é¢ã€‚
- `maybeCleanupDemoDataOnFirstUse()` æ”¹ä¸ºæ— æç¤ºï¼ˆé¿å…å¼¹çª—å¹²æ‰°ï¼‰ã€‚
- `initDemoData()`ï¼šæ¸…ç©ºæŠ˜å çŠ¶æ€å¹¶é‡ç®—ä½™é¢ï¼Œç¡®ä¿ç¤ºä¾‹ä»»åŠ¡å¯è§ä¸”ä½™é¢å¯å˜æ›´ï¼›ç¤ºä¾‹ä½™é¢ç›®æ ‡è°ƒä¸º 2 å°æ—¶ 30 åˆ†ã€‚
- `initDemoData()`ï¼šä½™é¢è¡¥å·®æ”¹ä¸ºå¾ªç¯ä¿®æ­£ï¼Œç¡®ä¿å¤§åå·®ä¹Ÿèƒ½æ”¶æ•›åˆ°ç›®æ ‡å€¼ã€‚

#### 5. æœªç™»å½•ç¤ºä¾‹æ¨¡å¼çš„â€œå…¨éƒ¨ä»»åŠ¡/ä½™é¢ä¸æ›´æ–°â€ä¿®å¤
**æ–‡ä»¶**: `index.html`
- è¡¥å……å…¨å±€ `profileData` é»˜è®¤å€¼ï¼Œé¿å…æœªç™»å½•åœºæ™¯ä¸‹ `updateCategoryTasks()` è¯»å–æœªå£°æ˜å˜é‡è€Œä¸­æ–­åç»­ UI æ›´æ–°ï¼ˆå¯¼è‡´â€œå…¨éƒ¨ä»»åŠ¡ä¸ºç©ºã€ä½™é¢ä¸å˜â€ï¼‰ã€‚

#### 6. Android ä¸‰é”®å¯¼èˆªæ é¿è®©
**æ–‡ä»¶**: `index.html`, `MainActivity.java`, `WebAppInterface.java`
- æ–°å¢ `--android-nav-bottom` å˜é‡å¹¶å°†åº•éƒ¨æ /æ»šåŠ¨å®¹å™¨ padding ä¸ç³»ç»Ÿå¯¼èˆªæ é«˜åº¦ç›¸åŠ ã€‚
- é€šè¿‡ `WindowInsets` ç›‘å¬å¯¼èˆªæ é«˜åº¦å˜åŒ–å¹¶å›ä¼  JS è°ƒæ•´ã€‚
- æä¾› `getNavigationBarHeight()` å…œåº•æ¥å£ã€‚

#### 3. ç™»å½•åæ•°æ®åˆå§‹åŒ–æµç¨‹ç»Ÿä¸€
**æ–‡ä»¶**: `index.html`
- æ–°å¢ `handlePostLoginDataInit()`ï¼šç»Ÿä¸€å¤„ç†ç™»å½•åæ•°æ®åŠ è½½ã€ç¤ºä¾‹æ¸…ç†ä¸æœ¬åœ°â†’äº‘ç«¯å¼•å¯¼åŒæ­¥ã€‚

#### 4. äº‘ç«¯é¦–æ¬¡åŒæ­¥æœªå®Œæˆæ—¶ä»å…è®¸æœ¬åœ°ä¿å­˜
**æ–‡ä»¶**: `index.html`
- `saveData()` åœ¨ `hasCompletedFirstCloudSync=false` æ—¶ä¿ç•™æœ¬åœ°ç¼“å­˜ï¼Œé¿å…ç¦»çº¿çŠ¶æ€ä»»åŠ¡æ“ä½œä¸¢å¤±ã€‚

---

## v7.9.4 (2026-01-26) - è‡ªåŠ¨é‡æ–°ç™»å½•åŠŸèƒ½

### é—®é¢˜èƒŒæ™¯
ç”¨æˆ·æ‰‹æœºæ¯å¤©æ™šä¸Šè‡ªåŠ¨å…³æœºã€æ¸…æ™¨è‡ªåŠ¨å¼€æœºåï¼Œç™»å½•çŠ¶æ€ä¼šä¸¢å¤±ï¼Œéœ€è¦æ‰‹åŠ¨é‡æ–°è¾“å…¥é‚®ç®±å’Œå¯†ç ç™»å½•ã€‚

### è§£å†³æ–¹æ¡ˆ
å®ç°è‡ªåŠ¨é‡æ–°ç™»å½•åŠŸèƒ½ï¼šç™»å½•æˆåŠŸåä¿å­˜å‡­æ®ï¼Œè®¾å¤‡é‡å¯åè‡ªåŠ¨ä½¿ç”¨ä¿å­˜çš„å‡­æ®é‡æ–°ç™»å½•ã€‚

### å…³é”®æ”¹åŠ¨

#### 1. CloudBase SDK æŒä¹…åŒ–é…ç½®
**æ–‡ä»¶**: `index.html` (initCloudBase å‡½æ•°ï¼Œçº¦ L8644)
```javascript
app = sdk.init({
    env: TCB_ENV_ID,
    region: 'ap-shanghai',
    persistence: 'local'   // [v7.9.4] æŒä¹…åŒ–åˆ° localStorage
});
```

#### 2. Android ç«¯å‡­æ®å­˜å‚¨
**æ–‡ä»¶**: `WebAppInterface.java` (æ–°å¢æ–¹æ³•)
- `saveLoginCredentials(email, password)` - ä¿å­˜é‚®ç®±å’Œ Base64 ç¼–ç çš„å¯†ç 
- `getSavedLoginPassword()` - è¯»å–è§£ç åçš„å¯†ç 
- `isAutoLoginEnabled()` - æ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨ç™»å½•
- `clearLoginCredentials()` - æ¸…é™¤ä¿å­˜çš„å¯†ç 
- `setAutoLoginEnabled(enabled)` - è®¾ç½®è‡ªåŠ¨ç™»å½•å¼€å…³

#### 3. è‡ªåŠ¨é‡æ–°ç™»å½•é€»è¾‘
**æ–‡ä»¶**: `index.html` (æ–°å¢ tryAutoReLogin å‡½æ•°ï¼Œçº¦ L8700)
```javascript
async function tryAutoReLogin() {
    // ä» Android SharedPreferences æˆ– localStorage è·å–ä¿å­˜çš„å‡­æ®
    // å¦‚æœæœ‰å‡­æ®ä¸”å¯ç”¨è‡ªåŠ¨ç™»å½•ï¼Œæ‰§è¡Œç™»å½•
    // ç™»å½•æˆåŠŸååŠ è½½äº‘ç«¯æ•°æ®
}
```

#### 4. ç™»å½•æˆåŠŸåä¿å­˜å‡­æ®
**æ–‡ä»¶**: `index.html` (handleEmailLogin å‡½æ•°ï¼Œçº¦ L27260)
- é»˜è®¤å¯ç”¨"è®°ä½ç™»å½•"ï¼ˆå¤é€‰æ¡†éšè—ä½†åŠŸèƒ½ä¿ç•™ï¼‰
- ä¿å­˜å‡­æ®åˆ° Android SharedPreferences å’Œ localStorage

#### 5. ç™»å‡ºæ—¶æ¸…ç†å‡­æ®
**æ–‡ä»¶**: `index.html` (handleLogout å‡½æ•°ï¼Œçº¦ L27640)
- è°ƒç”¨ `Android.clearLoginCredentials()` æ¸…é™¤å¯†ç 
- æ¸…é™¤ localStorage ä¸­çš„æ‰€æœ‰ç™»å½•ç›¸å…³æ•°æ®

### å®‰å…¨è¯´æ˜
- å¯†ç å­˜å‚¨åœ¨ SharedPreferences ä¸­ä½¿ç”¨ MODE_PRIVATEï¼ˆä»…æœ¬åº”ç”¨å¯è®¿é—®ï¼‰
- å¯†ç ä½¿ç”¨ Base64 ç¼–ç å­˜å‚¨ï¼ˆé˜²æ­¢æ˜æ–‡ï¼Œä½†ä¸æ˜¯å¼ºåŠ å¯†ï¼‰
- ç™»å‡ºæ—¶è‡ªåŠ¨æ¸…é™¤æ‰€æœ‰å‡­æ®

---

## v7.9.3 (2026-01-26) - ç³»ç»Ÿåˆ†ç±»ç®¡ç†ä¸äº‘ç«¯åŒæ­¥å¢å¼º

### 1. ç¡çœ åˆ†ç±»æ ‡ç­¾åŠŸèƒ½

**æ–°å¢æ•°æ®ç»“æ„**:
```javascript
sleepSettings.earnCategory = null;  // ç¡çœ å¥–åŠ±åˆ†ç±»
sleepSettings.spendCategory = null; // ç¡çœ æƒ©ç½šåˆ†ç±»

// Profile ä¸­æ–°å¢ï¼ˆæ‰€æœ‰è®¾å¤‡å…±äº«ï¼‰
profile.sleepTimeCategories = {
    earnCategory: string | null,
    spendCategory: string | null,
    lastUpdated: ISO string
}
```

**æ–°å¢å‡½æ•°**:
- `showSleepCategorySelectModal(type)` - æ˜¾ç¤ºåˆ†ç±»é€‰æ‹©å¼¹çª—
- `selectSleepCategory(item)` - é€‰æ‹©åˆ†ç±»
- `updateSleepCategories()` - æ›´æ–°åˆ†ç±»è®¾ç½®å¹¶äº‘ç«¯åŒæ­¥
- `initSleepCategoryDisplay()` - åˆå§‹åŒ–åˆ†ç±»æ˜¾ç¤º

### 2. åˆ†ç±»å¼ºåˆ¶åº”ç”¨ï¼ˆæ ¸å¿ƒæ”¹åŠ¨ï¼‰

**ä¿®æ”¹å‡½æ•°**: `getTransactionCategory(t)` (çº¦ L16976)

**åŸé€»è¾‘**: ä¼˜å…ˆä½¿ç”¨è®°å½•ä¸­çš„ `category` å­—æ®µ
**æ–°é€»è¾‘**: å§‹ç»ˆä½¿ç”¨å½“å‰è®¾ç½®çš„åˆ†ç±»ï¼Œå¿½ç•¥è®°å½•ä¸­çš„å€¼

```javascript
function getTransactionCategory(t) {
    if (t.isSystem) {
        // å±å¹•æ—¶é—´ï¼šå§‹ç»ˆä½¿ç”¨å½“å‰è®¾ç½®
        if (t.systemType === 'screen-time' || t.taskName === 'å±å¹•æ—¶é—´ç®¡ç†') {
            if (t.type === 'earn' && screenTimeSettings.earnCategory) {
                return screenTimeSettings.earnCategory;
            }
            // ...
        }
        // ç¡çœ ï¼šå§‹ç»ˆä½¿ç”¨å½“å‰è®¾ç½®
        if (t.sleepData || t.napData || t.taskName === 'ğŸ˜´ ç¡çœ æ—¶é—´ç®¡ç†') {
            // ...
        }
    }
}
```

**ä¼˜åŠ¿**: æ— éœ€ä¿®æ”¹äº‘ç«¯æ•°æ®ï¼Œè®¾ç½®æ›´æ”¹åç«‹å³ç”Ÿæ•ˆã€‚

### 3. Watch è‡ªåŠ¨é‡è¿æœºåˆ¶

**æ–°å¢å˜é‡**:
```javascript
const watchConnected = { task: false, transaction: false, running: false, profile: false, daily: false };
const watchReconnectAttempts = { ... };
const watchReconnectTimers = {};
```

**æ–°å¢å‡½æ•°**:
- `scheduleWatchReconnect(reason)` - è°ƒåº¦é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- `checkAndRebuildWatchers()` - æ£€æŸ¥å¹¶é‡å»ºå¤±æ•ˆçš„ watchers

**å¿ƒè·³æ£€æµ‹**: æ¯30ç§’æ£€æŸ¥ watch è¿æ¥çŠ¶æ€

### 4. åˆç¡é—¹é’Ÿä¿®å¤

**Java ä¿®æ”¹**: `AlarmReceiver.java`
- ä½¿ç”¨ `RingtoneManager` æ’­æ”¾ç³»ç»Ÿé—¹é’Ÿé“ƒå£°
- æ”¯æŒéœ‡åŠ¨

**JS ä¿®æ”¹**: `startNap()` å‡½æ•°è°ƒç”¨ `Android.setNapAlarm(wakeTimeMs, ALARM_ID_NAP)`

### 5. ç™»å½•çŠ¶æ€æ£€æµ‹

**æ–°å¢æ ‡è®°**:
```javascript
localStorage.setItem('timebankExpectedLoggedIn', 'true');
```

**æ£€æµ‹å‡½æ•°**: `checkLoginStateOnResume()` - æ£€æµ‹æ„å¤–ç™»å‡ºå¹¶æç¤ºç”¨æˆ·

### 6. æ•°å­—è¾“å…¥æ¡†ä¼˜åŒ–

éšè— number è¾“å…¥æ¡†çš„ç®­å¤´ï¼ˆç”µè„‘ç«¯ spinnerï¼‰ï¼š
```css
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
}
input[type="number"] { -moz-appearance: textfield; }
```

---

## å†å²ç‰ˆæœ¬è¦ç‚¹

### v7.8.3 - ç™»å½•é‚®ç®±ä¿å­˜
- ç™»å½•æˆåŠŸåä¿å­˜é‚®ç®±åˆ° Android SharedPreferences
- ç™»å½•çŠ¶æ€ä¸¢å¤±æ—¶è‡ªåŠ¨å¡«å……é‚®ç®±

### v7.4.0+ - ç¡çœ æ—¶é—´ç®¡ç†ç³»ç»Ÿ
- å®Œæ•´çš„ç¡çœ å¥–æƒ©è®¡ç®—é€»è¾‘
- ç¡çœ è®°å½•å­˜å‚¨åœ¨ tb_transactionï¼ˆsleepData å­—æ®µï¼‰

### v7.3.0+ - å‡è¡¡æ¨¡å¼
- æ ¹æ®ä½™é¢è°ƒæ•´èµšå–æ•ˆç‡
- `getBalanceMultiplier()` å‡½æ•°

### v6.6.0 - å¤šè¡¨æ¶æ„è¿ç§»
- ä»å•ä¸€ JSON è¿ç§»åˆ° 5 å¼ ç‹¬ç«‹è¡¨
- DAL (Data Access Layer) è®¾è®¡

### v5.10.0+ - å¡ç‰‡å †å ç³»ç»Ÿ
- å„å¡ç‰‡ç‹¬ç«‹å±•å¼€çŠ¶æ€
- ä¸Šä¸‹æ»‘åŠ¨æ‰‹åŠ¿å¤„ç†

---

## å¸¸ç”¨è°ƒè¯•å‘½ä»¤

```powershell
# åŒæ­¥æ–‡ä»¶
Copy-Item "android_project/app/src/main/assets/www/index.html" "index.html" -Force

# Git æäº¤
git add -A; git commit -m "feat: æè¿°"; git push

# æœç´¢ä»£ç 
grep_search "å…³é”®è¯"
```

---

## Android Studio Logcat æ—¥å¿—ç­›é€‰

```
# WebView/JavaScript æ—¥å¿—
package:com.jianglicheng.timebank tag:chromium

# é”™è¯¯æ—¥å¿—
package:com.jianglicheng.timebank level:error
```

---

*æœ€åæ›´æ–°: 2026-02-02*

