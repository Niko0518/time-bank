<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间银行 - Time Bank v3.7.2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.1);
            --text-color: #333;
            --text-color-light: #666;
            --border-color: #ddd;
            --input-bg: #fff;
            --header-text: white;
            --section-title-color: white;
            --btn-secondary-bg: #f5f5f5;
            --btn-secondary-text: #666;
            --btn-secondary-border: #ddd;
            --habit-border-width: 4px;

            --color-primary: #2196F3;
            --color-positive: #4CAF50;
            --color-negative: #f44336;
            --color-warning: #FF9800;
            --color-neutral: #607D8B;
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --card-bg: rgba(42, 42, 42, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.3);
            --text-color: #e0e0e0;
            --text-color-light: #aaa;
            --border-color: #444;
            --input-bg: #2a2a2a;
            --header-text: #e0e0e0;
            --section-title-color: #e0e0e0;
            --btn-secondary-bg: #3a3a3a;
            --btn-secondary-text: #e0e0e0;
            --btn-secondary-border: #555;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            padding-bottom: 80px; /* 为底部标签栏留出空间 */
        }

        .header {
            text-align: center;
            padding: 20px;
            color: var(--header-text);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .balance-card {
            margin: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        @media (max-width: 480px) {
            .balance-card { margin: 15px; }
        }


        .balance-card.negative {
            background: rgba(255, 235, 238, 0.95);
            border-color: var(--color-negative);
        }
        [data-theme="dark"] .balance-card.negative {
            background: rgba(40, 20, 20, 0.95);
        }

        .balance-title {
            font-size: 0.9rem;
            color: var(--text-color-light);
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--color-primary);
        }

        .daily-changes {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .daily-change {
            color: var(--text-color-light);
        }

        /* 标签页 */
        .tab-content {
            display: none;
            padding: 0 20px;
        }
        @media (max-width: 480px) {
            .tab-content { padding: 0 15px; }
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 20px 0 15px 0;
            color: var(--section-title-color);
        }

        .recent-tasks-grid, .category-tasks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .task-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 16px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .task-card.is-habit::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--habit-border-width);
            background-color: var(--habit-color, #ccc);
        }

        .task-card.is-habit {
            padding-left: calc(12px + var(--habit-border-width));
        }


        .task-card.compact { padding: 10px; }
        .task-card.compact.is-habit { padding-left: calc(10px + var(--habit-border-width)); }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .task-info { flex: 1; min-width: 0; }

        .task-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-name-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .task-edit-btn {
            background: none;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-color-light);
            padding: 2px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .task-edit-btn:hover { background: var(--btn-secondary-bg); color: var(--text-color); }

        .task-details {
            font-size: 0.75rem;
            color: var(--text-color-light);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .task-category {
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .task-completion-count {
            color: var(--color-positive);
            font-weight: 500;
            font-size: 0.7rem;
        }

        .task-actions { display: flex; gap: 4px; flex-shrink: 0; flex-wrap: wrap; justify-content: flex-end; }
        .task-actions.compact { gap: 3px; }

        .task-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 36px;
            text-align: center;
        }
        
        .task-btn.icon-btn { font-size: 0.9rem; padding: 4px; }
        .task-btn.compact { padding: 3px 6px; font-size: 0.65rem; min-width: 32px; }

        .task-btn.edit { background: var(--btn-secondary-bg); color: var(--btn-secondary-text); padding: 5px 8px; min-width: 36px; }
        .task-btn.primary { background: var(--color-primary); color: white; }
        .task-btn.success { background: var(--color-positive); color: white; }
        .task-btn.warning { background: var(--color-warning); color: white; }
        .task-btn.danger { background: var(--color-negative); color: white; }
        .task-btn.secondary { background: #9E9E9E; color: white; }
        .task-btn.info { background: #17a2b8; color: white; }
        .task-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }

        .task-timer { margin-top: 10px; font-size: 0.9rem; font-weight: 600; color: var(--color-primary); }
        .task-progress { margin-top: 5px; font-size: 0.85rem; color: var(--text-color-light); }

        .category-tasks { margin-bottom: 20px; }
        .category-header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease; }
        .category-header:hover { background: rgba(255, 255, 255, 1); }
        .category-info { display: flex; align-items: center; gap: 10px; }
        .category-color { width: 12px; height: 12px; border-radius: 50%; }
        .category-name { font-weight: 600; font-size: 0.95rem; }
        .category-count { color: var(--text-color-light); font-size: 0.85rem; }
        .category-toggle { transition: transform 0.2s ease; font-size: 0.8rem; color: var(--text-color-light); }
        .category-header.collapsed .category-toggle { transform: rotate(-90deg); }
        .category-tasks-list { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease; }
        .category-tasks-list.collapsed { max-height: 0; }
        
        .empty-message { text-align: center; color: rgba(255, 255, 255, 0.7); font-style: italic; padding: 40px 20px; }
        [data-theme="dark"] .empty-message { color: rgba(255, 255, 255, 0.5); }
        
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--color-primary); color: white; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4); transition: all 0.3s ease; z-index: 1000; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6); }

        .bottom-tabs { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); display: flex; border-top: 1px solid rgba(0, 0, 0, 0.1); z-index: 1000; }
        .tab-button { flex: 1; padding: 12px 8px; border: none; background: none; text-align: center; cursor: pointer; transition: all 0.2s ease; font-size: 0.75rem; color: var(--text-color-light); }
        .tab-button.active { color: var(--color-primary); background: rgba(33, 150, 243, 0.1); }
        .tab-icon { font-size: 1.2rem; margin-bottom: 4px; }
        [data-theme="dark"] .bottom-tabs { background: var(--card-bg); border-top-color: var(--border-color); }
        [data-theme="dark"] .tab-button.active { background: rgba(33, 150, 243, 0.2); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        .modal.show { display: flex; align-items: center; justify-content: center; opacity: 1; }
        .modal-content { background: var(--input-bg); border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 20px; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal.show .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: 600; color: var(--text-color); }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color-light); padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color); }
        .form-input, .form-select { width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s ease; background-color: var(--input-bg); color: var(--text-color); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--color-primary); }
        .form-input.error, .form-select.error { border-color: var(--color-negative); }
        .error-message { color: var(--color-negative); font-size: 0.85rem; margin-top: 5px; display: none; }
        .error-message.show { display: block; }
        .hidden { display: none !important; }

        .time-presets { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .time-preset { padding: 6px 12px; background: var(--btn-secondary-bg); border: 1px solid var(--btn-secondary-border); border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; }
        .time-preset:hover { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .recommendations { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .recommendation-item { padding: 4px 8px; background: #e3f2fd; border: 1px solid var(--color-primary); border-radius: 12px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; color: var(--color-primary); }
        .recommendation-item:hover { background: var(--color-primary); color: white; }
        [data-theme="dark"] .recommendation-item { background: rgba(33, 150, 243, 0.2); border-color: var(--color-primary); }

        .color-selector-container { margin-top: 15px; }
        .color-selector { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; }
        .color-swatch { width: 100%; padding-bottom: 100%; border-radius: 50%; cursor: pointer; position: relative; border: 2px solid transparent; transition: all 0.2s ease; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: var(--color-primary); }
        .color-swatch.disabled { cursor: not-allowed; opacity: 0.3; }
        .color-swatch .checkmark { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1rem; }
        .color-swatch.selected .checkmark { display: block; }

        .form-buttons { display: flex; gap: 10px; margin-top: 30px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-secondary { background: var(--btn-secondary-bg); color: var(--btn-secondary-text); }
        .btn-danger { background: var(--color-negative); color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        
        .habit-settings { border: 2px solid var(--color-primary); border-radius: 8px; padding: 15px; margin-top: 20px; background-color: rgba(33, 150, 243, 0.05); }
        [data-theme="dark"] .habit-settings { background-color: rgba(33, 150, 243, 0.1); }
        .habit-settings-title { font-size: 1rem; font-weight: 600; color: var(--color-primary); margin-bottom: 20px; }
        .habit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .habit-reward-rule { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px; }
        .habit-reward-rule .form-input, .habit-reward-rule .form-select { padding: 8px; font-size: 0.9rem; }
        .remove-reward-btn { background: var(--color-negative); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold; }

        .report-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px var(--card-shadow);
            margin-top: 20px; 
        }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .report-title { font-size: 1.1rem; font-weight: 600; color: var(--text-color); }
        .report-filters { display: flex; gap: 5px; }
        .report-filters button, .analysis-controls button { padding: 6px 12px; font-size: 0.8rem; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-color); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; }
        .report-filters button.active, .analysis-controls button.active { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }

        .flow-chart-container { display: flex; flex-direction: column; gap: 15px; }
        .flow-bar-wrapper { display: flex; align-items: center; gap: 10px; }
        .flow-bar-label { font-size: 0.9rem; font-weight: 500; width: 60px; color: var(--text-color-light); }
        .flow-bar { flex: 1; display: flex; height: 24px; border-radius: 6px; overflow: hidden; background-color: var(--border-color); }
        .flow-bar-segment { height: 100%; transition: width 0.3s ease; position: relative; }
        .flow-bar-segment .tooltip { visibility: hidden; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.2s; font-size: 0.8rem; white-space: nowrap; }
        .flow-bar-segment:hover .tooltip { visibility: visible; opacity: 1; }

        .heatmap-nav { display: flex; align-items: center; gap: 10px; }
        .heatmap-nav button { background: none; border: 1px solid var(--border-color); color: var(--text-color); border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
        .heatmap-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
        .heatmap-month-label { font-size: 0.9rem; font-weight: 600; width: 100px; text-align: center; }
        .heatmap-grid-wrapper { margin-top: 15px; }
        .heatmap-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 0.7rem; text-align: center; margin-bottom: 5px; color: var(--text-color-light); }
        .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .heatmap-day, .heatmap-spacer { width: 100%; padding-bottom: 100%; position: relative; }
        .heatmap-day { cursor: pointer; }
        .heatmap-day-content { position: absolute; top:0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; background-color: var(--btn-secondary-bg); border-radius: 4px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .heatmap-day:hover .heatmap-day-content { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 2; }
        
        .heatmap-day-content.net-surplus-1 { background-color: #9be9a8; }
        .heatmap-day-content.net-surplus-2 { background-color: #40c463; }
        .heatmap-day-content.net-surplus-3 { background-color: #216e39; color: white; }
        .heatmap-day-content.net-deficit-1 { background-color: #ffcdd2; }
        .heatmap-day-content.net-deficit-2 { background-color: #e57373; }
        .heatmap-day-content.net-deficit-3 { background-color: #f44336; color: white; }
        [data-theme="dark"] .heatmap-day-content.net-surplus-1 { background-color: #0e4429; }
        [data-theme="dark"] .heatmap-day-content.net-surplus-2 { background-color: #006d32; }
        [data-theme="dark"] .heatmap-day-content.net-surplus-3 { background-color: #26a641; }
        [data-theme="dark"] .heatmap-day-content.net-deficit-1 { background-color: #4a1e1e; }
        [data-theme="dark"] .heatmap-day-content.net-deficit-2 { background-color: #992e2e; }
        [data-theme="dark"] .heatmap-day-content.net-deficit-3 { background-color: #c93333; }
        
        .heatmap-legend { display: flex; justify-content: flex-end; align-items: center; gap: 5px; font-size: 0.75rem; color: var(--text-color-light); margin-top: 10px; flex-wrap: wrap; }
        .legend-box { width: 12px; height: 12px; border-radius: 2px; }
        
        .analysis-table-container { max-height: 400px; overflow-y: auto; }
        .analysis-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .analysis-table th, .analysis-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .analysis-table th { font-weight: 600; cursor: pointer; user-select: none; }
        .analysis-table th.sort-asc::after { content: ' ▲'; }
        .analysis-table th.sort-desc::after { content: ' ▼'; }
        .text-positive { color: var(--color-positive); font-weight: 500; }
        .text-negative { color: var(--color-negative); font-weight: 500; }
        .text-neutral { color: var(--color-neutral); font-weight: 500; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .stat-card { background: var(--card-bg); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 16px var(--card-shadow); }
        .stat-value { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        #totalEarned.stat-value { color: var(--color-primary); }
        #totalSpent.stat-value { color: #E64A19; }
        .stat-label { font-size: 0.85rem; color: var(--text-color-light); }
        
        .settings-section { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 16px var(--card-shadow); }
        .settings-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: var(--text-color); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .setting-item:last-child { border-bottom: none; }
        .setting-info { flex: 1; }
        .setting-name { font-weight: 500; margin-bottom: 2px; }
        .setting-desc { font-size: 0.85rem; color: var(--text-color-light); }
        
        .theme-selector { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .theme-option { flex: 1; padding: 8px; text-align: center; background: none; border: none; cursor: pointer; font-size: 0.85rem; color: var(--text-color); transition: background-color 0.2s ease; border-left: 1px solid var(--border-color); }
        .theme-option:first-child { border-left: none; }
        .theme-option.active { background: var(--color-primary); color: white; }

        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-primary); }
        input:checked + .slider:before { transform: translateX(26px); }

        .threshold-input { width: 80px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; margin-left: 10px; background-color: var(--input-bg); color: var(--text-color); }

        .data-buttons { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }
        .data-btn { flex: 1; padding: 12px; border: 2px solid var(--color-primary); border-radius: 8px; background: white; color: var(--color-primary); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .data-btn:hover { background: var(--color-primary); color: white; }
        [data-theme="dark"] .data-btn { background: var(--card-bg); color: var(--color-primary); }
        [data-theme="dark"] .data-btn:hover { background: var(--color-primary); color: white; }
        .file-input { display: none; }
        
        .about-section details { margin-top: 15px; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; }
        .about-section summary { font-weight: 500; cursor: pointer; outline: none; }
        .about-section p { font-size: 0.9rem; line-height: 1.6; margin: 10px 0; color: var(--text-color-light); }
        .about-section ul { list-style-position: inside; padding-left: 10px; }
        .about-section li { font-size: 0.9rem; margin-bottom: 5px; }
        .version-history-item { margin-bottom: 15px; }
        .version-history-container { max-height: 300px; overflow-y: auto; padding-right: 10px; }

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); gap: 8px; }
        .history-item:last-child { border-bottom: none; }
        .history-info { flex: 1; min-width: 0; }
        .history-description { font-weight: 500; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-time { font-size: 0.8rem; color: var(--text-color-light); }
        .history-amount { font-weight: 600; font-size: 0.9rem; }
        .history-amount.positive { color: var(--color-positive); }
        .history-amount.negative { color: var(--color-negative); }
        .undo-btn { background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border: 1px solid var(--btn-secondary-border); padding: 4px 8px; font-size: 0.75rem; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
        .undo-btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .day-detail-summary { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); text-align: center; }
        .day-detail-net { font-size: 1.2rem; font-weight: bold; margin-bottom: 8px; }
        .day-detail-stats { font-size: 0.9rem; color: var(--text-color-light); }

        /* [v3.7.2] New styles for Analysis Dashboard */
        #analysisDashboard { display: flex; flex-direction: column; gap: 20px; }
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .kpi-card { background: var(--card-bg); border-radius: 12px; padding: 15px; text-align: center; }
        .kpi-label { font-size: 0.8rem; color: var(--text-color-light); margin-bottom: 8px; }
        .kpi-value { font-size: 1.1rem; font-weight: 600; word-wrap: break-word; }
        .kpi-value.positive { color: var(--color-positive); }
        .kpi-value.negative { color: var(--color-negative); }
        
        .chart-container { background: var(--card-bg); border-radius: 12px; padding: 15px; }
        .chart-title { font-size: 0.95rem; font-weight: 600; text-align: center; margin-bottom: 15px; }

        .leaderboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .leaderboard-chart { display: flex; flex-direction: column; gap: 8px; }
        .leaderboard-item { display: grid; grid-template-columns: 70px 1fr; align-items: center; gap: 8px; font-size: 0.8rem; cursor: pointer; }
        .leaderboard-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color-light); text-align: right;}
        .leaderboard-bar-wrapper { width: 100%; background: var(--border-color); border-radius: 4px; position: relative; }
        .leaderboard-bar { height: 18px; border-radius: 4px; transition: width 0.5s ease; position: relative; }
        .leaderboard-bar-value { position: absolute; top: 50%; transform: translateY(-50%); font-size: 0.7rem; font-weight: 500; }
        .leaderboard-bar-value.inside { right: 5px; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .leaderboard-bar-value.outside { left: calc(100% + 5px); color: var(--text-color); }
        .leaderboard-bar.earn { background-color: var(--color-positive); }
        .leaderboard-bar.spend { background-color: var(--color-negative); }

        .trend-chart-container { display: grid; grid-template-columns: 1fr; gap: 20px;}
        .trend-chart { width: 100%; display: flex; justify-content: space-around; gap: 4px; overflow: visible; padding-bottom: 10px; }
        .trend-day { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; background: var(--border-color); border-radius: 4px; position: relative; cursor: pointer; }
        .trend-day .tooltip { visibility: hidden; background-color: rgba(0,0,0,0.8); color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 110%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.2s; font-size: 0.75rem; white-space: nowrap; pointer-events: none; }
        .trend-day:hover .tooltip { visibility: visible; opacity: 1; }
        .trend-segment { width: 100%; transition: height 0.3s ease; }
        .trend-date-label { font-size: 0.7rem; color: var(--text-color-light); text-align: center; margin-top: 4px; }
        
        .analysis-filters { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; }
        .analysis-view-switcher { display: flex; gap: 5px; }
        
        .chart-legend { display: flex; flex-wrap: wrap; gap: 4px 8px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.7rem; }
        .legend-color-box { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
        .legend-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #tableContainerWrapper { margin-top: 20px; }

        @media (max-width: 480px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .kpi-value { font-size: 1rem; }
            .leaderboard-item { grid-template-columns: 60px 1fr; }
        }

        /* 全局过渡动画 */
        * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        [data-theme="dark"] .balance-title, [data-theme="dark"] .daily-change { color: var(--text-color-light); }
    </style>
</head>
<body>
    <div class="header">
        <h1>时间银行</h1>
        <p>Time Bank v3.7.2 - 数据修复与图表优化</p>
    </div>

    <div class="balance-card" id="balanceCard">
        <div class="balance-title">当前余额</div>
        <div class="balance-amount" id="balanceAmount">0秒</div>
        <div class="daily-changes">
            <div class="daily-change">今日获得: <span id="dailyEarned">0秒</span></div>
            <div class="daily-change">今日消费: <span id="dailySpent">0秒</span></div>
        </div>
    </div>

    <div class="tab-content active" id="earnTab">
        <div class="recent-tasks">
            <div class="section-title">最近任务</div>
            <div id="recentEarnTasks" class="recent-tasks-grid"></div>
        </div>
        
        <div class="section-title">分类任务</div>
        <div id="categoryEarnTasks"></div>
    </div>

    <div class="tab-content" id="spendTab">
        <div class="recent-tasks">
            <div class="section-title">最近任务</div>
            <div id="recentSpendTasks" class="recent-tasks-grid"></div>
        </div>
        
        <div class="section-title">分类任务</div>
        <div id="categorySpendTasks"></div>
    </div>

    <div class="tab-content" id="reportTab">
        
        <div class="stats-grid" style="margin-top: 20px;">
            <div class="stat-card">
                <div class="stat-value" id="totalEarned">0秒</div>
                <div class="stat-label">总获得时间</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">0秒</div>
                <div class="stat-label">总消费时间</div>
            </div>
        </div>

        <div class="report-section">
            <div class="report-header">
                <h2 class="report-title">时间流图</h2>
                <div class="report-filters" id="flowChartFilters">
                    <button class="active" data-period="7d">最近7天</button>
                    <button data-period="30d">最近30天</button>
                    <button data-period="all">全部时间</button>
                </div>
            </div>
            <div id="flowChartContainer" class="flow-chart-container"></div>
        </div>
        
        <div class="report-section">
             <div class="report-header">
                <h2 class="report-title">活动日历</h2>
                <div class="heatmap-nav">
                    <button id="heatmapPrevMonth">&lt;</button>
                    <span id="heatmapMonthLabel"></span>
                    <button id="heatmapNextMonth">&gt;</button>
                </div>
            </div>
            <div class="heatmap-grid-wrapper">
                <div class="heatmap-weekdays">
                    <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                </div>
                <div id="heatmapGrid" class="heatmap-grid"></div>
            </div>
            <div class="heatmap-legend" id="heatmapLegend"></div>
        </div>

        <div class="report-section">
            <div class="report-header">
                 <h2 class="report-title">时间洞察仪表盘</h2>
            </div>
            <div id="analysisDashboard">
                <div class="analysis-filters" id="analysisDashboardFilters"></div>
                <div class="kpi-grid" id="kpiGrid"></div>
                <div class="leaderboard-grid" id="leaderboardGrid"></div>
            </div>
        </div>

        <div class="report-section" id="trendChartWrapper">
             <div class="report-header">
                 <h2 class="report-title">趋势演变</h2>
            </div>
            <div id="trendChartContainerWrapper"></div>
        </div>

        <div class="report-section" id="tableWrapper">
             <div class="report-header">
                 <h2 class="report-title">详细数据</h2>
            </div>
            <div id="tableContainerWrapper"></div>
        </div>
    </div>

    <div class="tab-content" id="settingsTab">
        <div class="settings-section">
            <div class="settings-title">外观设置</div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">主题模式</div>
                    <div class="setting-desc">选择亮色、暗色或跟随系统</div>
                </div>
                <div class="theme-selector">
                    <button class="theme-option" data-theme-value="light" onclick="setTheme('light')">亮色</button>
                    <button class="theme-option" data-theme-value="dark" onclick="setTheme('dark')">暗色</button>
                    <button class="theme-option" data-theme-value="system" onclick="setTheme('system')">系统</button>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-title">通知设置</div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">成就通知</div>
                    <div class="setting-desc">完成任务或达成目标时显示通知</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="achievementNotificationToggle" onchange="toggleAchievementNotifications()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">长时间运行提醒</div>
                    <div class="setting-desc">任务运行超过设定时间时提醒</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="longRunningNotificationToggle" onchange="toggleLongRunningNotifications()">
                    <span class="slider"></span>
                </label>
                <input type="number" id="longRunningThreshold" class="threshold-input" 
                       value="3600" min="300" step="300" onchange="updateLongRunningThreshold()" 
                       placeholder="秒">
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">余额不足提醒</div>
                    <div class="setting-desc">余额低于设定值时提醒</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="lowBalanceNotificationToggle" onchange="toggleLowBalanceNotifications()">
                    <span class="slider"></span>
                </label>
                <input type="number" id="lowBalanceThreshold" class="threshold-input" 
                       value="1800" min="0" step="300" onchange="updateLowBalanceThreshold()" 
                       placeholder="秒">
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-title">数据管理</div>
            <div class="data-buttons">
                <button class="data-btn" onclick="exportData()">导出数据</button>
                <button class="data-btn" onclick="document.getElementById('importFile').click()">导入数据</button>
                <button class="data-btn" onclick="clearAllData()">清空数据</button>
            </div>
            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
        </div>
        
        <div class="settings-section about-section">
            <div class="settings-title">关于</div>
            <div class="version-history-item">
                <p><strong>版本 v3.7.2 (2025-10-16)</strong></p>
                <ul>
                    <li><strong>[修复]</strong> 新增智能数据修复引擎，可自动修复旧版交易记录，解决“未知任务”问题。</li>
                    <li><strong>[优化]</strong> 仪表盘图表采用"Top N + 其他"模式，聚焦核心信息。</li>
                    <li><strong>[修复]</strong> 修复了排行榜短进度条的标签显示问题，并优化了趋势图的布局与交互。</li>
                    <li><strong>[UI]</strong> 仪表盘、趋势图、数据表格的筛选器已独立，交互更灵活。KPI标签已动态化，消除歧义。</li>
                </ul>
            </div>
            <details>
                <summary>历史版本更新</summary>
                <div class="version-history-container">
                    <div class="version-history-item">
                        <p><strong>版本 v3.7.1 (2025-10-16)</strong></p>
                        <ul>
                            <li><strong>[新功能]</strong> "深度分析"模块升级为动态仪表盘，新增"按分类/按任务"切换，以排行榜和趋势图取代静态图表。</li>
                            <li><strong>[新功能]</strong> 排行榜直观展示时间来源和去向，趋势图（堆叠图）动态展示各项活动随时间的变化。</li>
                            <li><strong>[交互]</strong> 仪表盘支持点击图例进行下钻筛选，深入分析单个项目。</li>
                        </ul>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <button class="fab" id="fabButton" onclick="showTaskModal()">+</button>

    <div class="bottom-tabs">
        <button class="tab-button active" onclick="switchTab('earn')">
            <div class="tab-icon">⏰</div>
            <div>获得时间</div>
        </button>
        <button class="tab-button" onclick="switchTab('spend')">
            <div class="tab-icon">🎯</div>
            <div>消费时间</div>
        </button>
        <button class="tab-button" onclick="switchTab('report')">
            <div class="tab-icon">📊</div>
            <div>报告</div>
        </button>
        <button class="tab-button" onclick="switchTab('settings')">
            <div class="tab-icon">⚙️</div>
            <div>设置</div>
        </button>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">创建新任务</div>
                <button class="close-btn" onclick="hideTaskModal()">×</button>
            </div>
            <form id="taskForm" onsubmit="saveTask(event)">
                <div class="form-group">
                    <label class="form-label">任务名称 *</label>
                    <input type="text" id="taskName" class="form-input" placeholder="输入任务名称" required>
                    <div class="error-message" id="taskNameError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">任务类型 *</label>
                    <select id="taskType" class="form-select" onchange="updateFormForTaskType()" required>
                        <option value="">请选择任务类型</option>
                        <option value="reward">固定奖励</option>
                        <option value="continuous">持续奖励</option>
                        <option value="continuous_target">达标奖励</option>
                        <option value="instant_redeem">即时兑换</option>
                        <option value="continuous_redeem">持续消耗</option>
                    </select>
                    <div class="error-message" id="taskTypeError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">任务分类 *</label>
                    <input type="text" id="taskCategory" class="form-input" placeholder="输入分类名称" required>
                    <div class="recommendations" id="categoryRecommendations"></div>
                    <div class="error-message" id="taskCategoryError"></div>
                </div>

                <div class="form-group hidden" id="colorSelectorContainer">
                    <label class="form-label">分类颜色 (可选)</label>
                    <div id="earnColorSelector" class="color-selector hidden"></div>
                    <div id="spendColorSelector" class="color-selector hidden"></div>
                </div>


                <div class="form-group hidden" id="fixedTimeGroup">
                    <label class="form-label" id="fixedTimeLabel">奖励时间 (秒) *</label>
                    <input type="text" id="fixedTime" class="form-input" placeholder="例如：1800">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 900)">15分钟</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 1800)">30分钟</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 3600)">1小时</div>
                    </div>
                    <div class="error-message" id="fixedTimeError"></div>
                </div>

                <div class="form-group hidden" id="consumeTimeGroup">
                    <label class="form-label">消费时间 (秒) *</label>
                    <input type="text" id="consumeTime" class="form-input" placeholder="例如：1800">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 900)">15分钟</div>
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 1800)">30分钟</div>
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 3600)">1小时</div>
                    </div>
                    <div class="error-message" id="consumeTimeError"></div>
                </div>

                <div class="form-group hidden" id="multiplierGroup">
                    <label class="form-label">时间倍率 *</label>
                    <input type="text" id="multiplier" class="form-input" placeholder="例如：1.0">
                    <div class="error-message" id="multiplierError"></div>
                </div>

                <div class="form-group hidden" id="targetTimeGroup">
                    <label class="form-label">目标时长 (秒) *</label>
                    <input type="text" id="targetTime" class="form-input" placeholder="例如：3600">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('targetTime', 3600)">1小时</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 7200)">2小时</div>
                    </div>
                    <div class="error-message" id="targetTimeError"></div>
                </div>

                <div class="form-group hidden" id="bonusRewardGroup">
                    <label class="form-label">额外奖励 (秒)</label>
                    <input type="text" id="bonusReward" class="form-input" placeholder="例如：1800，可不填">
                     <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 900)">15分钟</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 1800)">30分钟</div>
                    </div>
                    <div class="error-message" id="bonusRewardError"></div>
                </div>

                <div class="form-group hidden" id="habitToggleContainer">
                    <div class="setting-item" style="padding: 0;">
                        <div class="setting-info">
                            <div class="setting-name">设置为习惯</div>
                            <div class="setting-desc">开启连续打卡和额外奖励</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="isHabitToggle" onchange="toggleHabitSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="habit-settings hidden" id="habitSettingsGroup">
                    <div class="habit-settings-title">习惯设置</div>
                    <div class="habit-grid">
                        <div class="form-group">
                            <label class="form-label">周期</label>
                            <select id="habitPeriod" class="form-select">
                                <option value="daily">每天</option>
                                <option value="weekly">每周</option>
                                <option value="monthly">每月</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label class="form-label">时长</label>
                            <div style="display: flex; gap: 5px;">
                                <select id="habitDurationType" class="form-select" onchange="toggleHabitDurationInput()">
                                    <option value="infinite">无限</option>
                                    <option value="days">持续天数</option>
                                    <option value="weeks">持续周数</option>
                                </select>
                                <input type="number" id="habitDurationValue" class="form-input hidden" placeholder="天数">
                            </div>
                        </div>
                    </div>

                     <div class="form-group">
                        <label class="form-label">每日完成上限</label>
                        <input type="number" id="habitDailyLimit" class="form-input" value="1" min="1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">习惯奖励 (可添加多个)</label>
                        <div id="habitRewardsContainer"></div>
                        <button type="button" class="btn btn-secondary" style="width: 100%; padding: 8px; margin-top: 10px;" onclick="addHabitRewardRule()">+ 添加奖励规则</button>
                    </div>
                </div>


                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">取消</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">创建任务</button>
                    <button type="button" class="btn btn-danger hidden" id="deleteBtn" onclick="deleteTask()">删除任务</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="historyModalTitle">任务历史</div>
                <button class="close-btn" onclick="hideHistoryModal()">×</button>
            </div>
            <div id="historyContent">
                <div class="empty-message">暂无历史记录</div>
            </div>
        </div>
    </div>

    <div class="modal" id="dayDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="dayDetailModalTitle">每日详情</div>
                <button class="close-btn" onclick="hideDayDetailModal()">×</button>
            </div>
            <div id="dayDetailContent"></div>
        </div>
    </div>

    <script>
        const APP_VERSION = '3.7.2';
        let currentBalance = 0;
        let tasks = [];
        let transactions = [];
        let categoryColors = new Map();
        let collapsedCategories = new Set();
        let runningTasks = new Map();
        let currentEditingTask = null;
        let timerInterval = null;
        let dailyChanges = {};
        let currentHistoryTask = null;
        let currentSelectedColor = null;

        let reportState = {
            flowChartPeriod: '7d',
            heatmapDate: new Date(),
            analysisPeriod: 'all',
            analysisView: 'category',
            analysisItemFilter: null,
            trendPeriod: '30d',
            trendView: 'category',
            tablePeriod: 'all',
            tableView: 'category'
        };
        
        let notificationSettings = {
            achievement: true, longRunning: true, longRunningThreshold: 3600,
            lowBalance: true, lowBalanceThreshold: 1800
        };
        
        const earnColors = [ '#007f5f', '#2b9348', '#55a630', '#80b918', '#aacc00', '#bfd200', '#d4d700', '#dddf00', '#eeef20', '#ffff3f', '#ade8f4', '#48cae4', '#00b4d8', '#0096c7', '#0077b6', '#023e8a' ];
        const spendColors = [ '#ffbe0b', '#fb5607', '#ff006e', '#8338ec', '#3a86ff', '#ef476f', '#f78c6b', '#ffd166', '#c9184a', '#ff4d6d', '#ff8fa3', '#ffb3c1', '#fca311', '#e85d04', '#dc2f02', '#9d0208' ];

        // --- App Initialization ---
        function initApp() {
            loadData();
            renderColorSelectors();
            updateAllUI();
            updateNotificationSettingsUI();
            startGlobalTimer();
            if ('Notification' in window && notificationSettings.achievement && Notification.permission === 'default') {
                requestNotificationPermission();
            }
            setupReportEventListeners();
        }

        function startGlobalTimer() { if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => updateRunningTimers(), 1000); }

        // --- UI Rendering & Updates ---
        function updateAllUI() {
            updateRecentTasks();
            updateCategoryTasks();
            updateBalance();
            if(document.getElementById('reportTab').classList.contains('active')) {
                updateAllReports();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.closest('.tab-button').classList.add('active');
            document.getElementById('fabButton').style.display = (tabName === 'report' || tabName === 'settings') ? 'none' : 'block';
            if (tabName === 'report') {
                reportState.heatmapDate = new Date();
                updateAllReports();
            }
        }

        function updateRecentTasks() {
            const earnTasks = tasks.filter(t => ['reward', 'continuous', 'continuous_target'].includes(t.type));
            const spendTasks = tasks.filter(t => ['instant_redeem', 'continuous_redeem'].includes(t.type));
            const sortByLastUsed = (taskList) => [...taskList].sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0)).slice(0, 6);
            renderTaskList('recentEarnTasks', sortByLastUsed(earnTasks));
            renderTaskList('recentSpendTasks', sortByLastUsed(spendTasks));
        }

        function updateCategoryTasks() {
            const earnTasks = tasks.filter(t => ['reward', 'continuous', 'continuous_target'].includes(t.type));
            const spendTasks = tasks.filter(t => ['instant_redeem', 'continuous_redeem'].includes(t.type));
            renderCategoryTasks('categoryEarnTasks', groupTasksByCategory(earnTasks));
            renderCategoryTasks('categorySpendTasks', groupTasksByCategory(spendTasks));
        }
        
        function groupTasksByCategory(taskList) {
            return taskList.reduce((acc, task) => { (acc[task.category] = acc[task.category] || []).push(task); return acc; }, {});
        }

        function renderCategoryTasks(containerId, tasksByCategory) {
            const container = document.getElementById(containerId);
            if (Object.keys(tasksByCategory).length === 0) { container.innerHTML = `<div class="empty-message" style="color:var(--text-color-light)">暂无任务</div>`; return; }
            container.innerHTML = Object.entries(tasksByCategory).map(([category, categoryTasks]) => {
                const isCollapsed = collapsedCategories.has(category);
                const color = categoryColors.get(category) || '#666';
                categoryTasks.sort((a, b) => (b.isHabit ? 1 : 0) - (a.isHabit ? 1 : 0));
                return `<div class="category-tasks"><div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${category}')"><div class="category-info"><div class="category-color" style="background-color: ${color}"></div><div class="category-name">${category}</div><div class="category-count">(${categoryTasks.length})</div></div><div class="category-toggle">▼</div></div><div class="category-tasks-list ${isCollapsed ? 'collapsed' : ''}"><div class="category-tasks-grid">${renderTaskCards(categoryTasks, true)}</div></div></div>`;
            }).join('');
        }

        function renderTaskList(containerId, taskList) {
            const container = document.getElementById(containerId);
            if (taskList.length === 0) { container.innerHTML = `<div class="empty-message" style="color:var(--text-color-light)">暂无最近任务</div>`; return; }
            container.innerHTML = renderTaskCards(taskList, true);
        }
        
        function renderTaskCards(taskList, isCompact = false) {
            return taskList.map(task => {
                const runningTask = runningTasks.get(task.id); const isRunning = !!runningTask; const isPaused = runningTask?.isPaused;
                const color = categoryColors.get(task.category) || '#666';
                let detailsHtml = `<span class="task-category" style="background-color: ${color}">${task.category}</span>`;
                if (task.isHabit) { const unitMap = { daily: '天', weekly: '周', monthly: '月' }; const streak = task.habitDetails.streak || 0; const periodText = unitMap[task.habitDetails.period] || '次'; detailsHtml += ` <span class="task-completion-count">已连续 ${streak} ${periodText}</span>`; }
                else if ((task.completionCount || 0) > 0) { detailsHtml += ` <span class="task-completion-count">已完成 ${task.completionCount} 次</span>`; }
                let actionsHtml = ''; let progressHtml = '';
                if (task.type === 'reward') { detailsHtml += ` • 奖励 ${formatTime(task.fixedTime, false)}`; actionsHtml = `<button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="历史">📋</button><button class="task-btn success" onclick="completeTask('${task.id}')">完成</button>`; }
                else if (['continuous', 'continuous_redeem', 'continuous_target'].includes(task.type)) {
                    detailsHtml += ` • ${task.multiplier}倍率` + (task.type.includes('redeem') ? '消耗' : '');
                    if (task.type === 'continuous_target') detailsHtml += ` • 目标 ${formatTime(task.targetTime, false).replace(/0秒$/, '').trim()}`;
                    if (isRunning) { const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        if (isPaused) { actionsHtml = `<button class="task-btn primary icon-btn" onclick="resumeTask('${task.id}')" title="继续">▶️</button><button class="task-btn secondary icon-btn" onclick="cancelTask('${task.id}')" title="取消">❌</button><button class="task-btn danger icon-btn" onclick="stopTask('${task.id}')" title="结束">⏹️</button>`; progressHtml = `<div class="task-timer">已暂停：${formatTime(totalSeconds)}</div>`; }
                        else { actionsHtml = `<button class="task-btn warning icon-btn" onclick="pauseTask('${task.id}')" title="暂停">⏸️</button><button class="task-btn secondary icon-btn" onclick="cancelTask('${task.id}')" title="取消">❌</button><button class="task-btn danger icon-btn" onclick="stopTask('${task.id}')" title="结束">⏹️</button>`; progressHtml = `<div class="task-timer">运行中：${formatTime(totalSeconds)}</div>`; }
                        if (task.type === 'continuous_target') { const progress = Math.min((totalSeconds / task.targetTime) * 100, 100); progressHtml += `<div class="task-progress">进度：${progress.toFixed(1)}% ${runningTask.achieved ? '✅ 已达标' : ''}</div>`; }
                    } else { actionsHtml = `<button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="历史">📋</button><button class="task-btn primary" onclick="startTask('${task.id}')">开始</button>`; }
                } else if (task.type === 'instant_redeem') { detailsHtml += ` • 消费 ${formatTime(task.consumeTime, false)}`; actionsHtml = `<button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="历史">📋</button><button class="task-btn danger" onclick="redeemTask('${task.id}')">兑换</button>`; }
                const compactClass = isCompact ? 'compact' : ''; const habitClass = task.isHabit ? 'is-habit' : ''; const habitStyle = task.isHabit ? `style="--habit-color: ${color}"` : '';
                return `<div class="task-card ${compactClass} ${habitClass}" ${habitStyle}><div class="task-header"><div class="task-info"><div class="task-name"><span class="task-name-text" title="${task.name}">${task.name}</span><button class="task-edit-btn" onclick="editTask(tasks.find(t => t.id === '${task.id}'))" title="编辑">✏️</button></div><div class="task-details">${detailsHtml}</div></div><div class="task-actions ${compactClass}">${actionsHtml}</div></div>${progressHtml}</div>`;
            }).join('');
        }
        
        function updateRunningTimers() {
            let hasChanges = false;
            runningTasks.forEach((runningTask, taskId) => {
                if (runningTask.isPaused) return; hasChanges = true;
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    const totalSeconds = Math.floor((runningTask.elapsedTime + Date.now() - runningTask.startTime)) / 1000;
                    if (task.type === 'continuous_target' && !runningTask.achieved && totalSeconds >= task.targetTime) { runningTask.achieved = true; showNotification('🎯 达标提醒', `任务"${task.name}"已达到目标时间！`, 'achievement'); }
                    if (notificationSettings.longRunning && totalSeconds > 0 && totalSeconds > 0 && totalSeconds % notificationSettings.longRunningThreshold === 0) { showNotification('⏰ 长时间运行提醒', `任务"${task.name}"已运行${formatTime(totalSeconds)}`, 'longRunning'); }
                }
            });
            if (hasChanges) { updateRecentTasks(); updateCategoryTasks(); }
        }

        function toggleCategory(category) { collapsedCategories.has(category) ? collapsedCategories.delete(category) : collapsedCategories.add(category); saveData(); updateCategoryTasks(); }

        function updateBalance() {
            const balanceCard = document.getElementById('balanceCard');
            const balanceAmount = document.getElementById('balanceAmount');
            balanceAmount.textContent = formatTime(currentBalance);
            balanceCard.classList.toggle('negative', currentBalance < 0);
            balanceAmount.style.color = currentBalance < 0 ? 'var(--color-negative)' : (currentBalance < notificationSettings.lowBalanceThreshold ? 'var(--color-warning)' : 'var(--color-primary)');
            const todayChanges = dailyChanges[new Date().toDateString()] || { earned: 0, spent: 0 };
            document.getElementById('dailyEarned').textContent = formatTime(todayChanges.earned);
            document.getElementById('dailySpent').textContent = formatTime(todayChanges.spent);
            if (notificationSettings.lowBalance && currentBalance >= 0 && currentBalance < notificationSettings.lowBalanceThreshold) { showNotification('⚠️ 余额不足', `当前余额仅剩 ${formatTime(currentBalance)}`, 'lowBalance'); }
        }

        // --- Task Management ---
        function showTaskModal() {
            currentEditingTask = null; currentSelectedColor = null;
            document.getElementById('modalTitle').textContent = '创建新任务'; document.getElementById('submitBtn').textContent = '创建任务';
            document.getElementById('deleteBtn').classList.add('hidden'); document.getElementById('taskForm').reset();
            updateFormForTaskType(); toggleHabitSettings(false);
            document.getElementById('habitRewardsContainer').innerHTML = ''; document.getElementById('taskModal').classList.add('show');
        }

        function hideTaskModal() { document.getElementById('taskModal').classList.remove('show'); clearFormErrors(); }

        function editTask(task) {
            currentEditingTask = task; currentSelectedColor = categoryColors.get(task.category);
            document.getElementById('modalTitle').textContent = '编辑任务'; document.getElementById('submitBtn').textContent = '保存修改';
            document.getElementById('deleteBtn').classList.remove('hidden'); const form = document.getElementById('taskForm');
            form.taskName.value = task.name; form.taskCategory.value = task.category; form.taskType.value = task.type;
            if (task.fixedTime) form.fixedTime.value = task.fixedTime; if (task.consumeTime) form.consumeTime.value = task.consumeTime;
            if (task.multiplier) form.multiplier.value = task.multiplier; if (task.targetTime) form.targetTime.value = task.targetTime;
            if (task.bonusReward) form.bonusReward.value = task.bonusReward;
            document.getElementById('isHabitToggle').checked = task.isHabit || false;
            if (task.isHabit && task.habitDetails) {
                document.getElementById('habitPeriod').value = task.habitDetails.period; document.getElementById('habitDurationType').value = task.habitDetails.duration.type;
                document.getElementById('habitDailyLimit').value = task.habitDetails.dailyLimit || 1;
                if (task.habitDetails.duration.type !== 'infinite') document.getElementById('habitDurationValue').value = task.habitDetails.duration.value;
                const rewardsContainer = document.getElementById('habitRewardsContainer'); rewardsContainer.innerHTML = '';
                task.habitDetails.rewards.forEach(rule => addHabitRewardRule(rule));
            } else { document.getElementById('habitRewardsContainer').innerHTML = ''; document.getElementById('habitDailyLimit').value = 1; }
            updateFormForTaskType(); toggleHabitSettings(task.isHabit); toggleHabitDurationInput();
            document.getElementById('taskModal').classList.add('show');
        }

        function deleteTask() { if (!currentEditingTask) return; if (confirm(`确定要删除任务"${currentEditingTask.name}"吗？`)) { runningTasks.delete(currentEditingTask.id); tasks = tasks.filter(t => t.id !== currentEditingTask.id); saveData(); updateAllUI(); hideTaskModal(); } }
        
        function updateFormForTaskType() {
            const taskType = document.getElementById('taskType').value;
            const earnTypes = ['reward', 'continuous', 'continuous_target'];
            const colorSelectorContainer = document.getElementById('colorSelectorContainer');
            const earnColorSelector = document.getElementById('earnColorSelector');
            const spendColorSelector = document.getElementById('spendColorSelector');
            document.querySelectorAll('#taskForm .form-group[id$="Group"]').forEach(el => el.classList.add('hidden'));
            
            if (taskType) {
                colorSelectorContainer.classList.remove('hidden');
                const isEarn = earnTypes.includes(taskType);
                earnColorSelector.classList.toggle('hidden', !isEarn);
                spendColorSelector.classList.toggle('hidden', isEarn);
                renderColorSelectors(currentEditingTask ? categoryColors.get(currentEditingTask.category) : null);
            } else {
                colorSelectorContainer.classList.add('hidden');
            }
            
            const habitToggle = document.getElementById('habitToggleContainer');
            if (earnTypes.includes(taskType)) habitToggle.classList.remove('hidden');
            else { habitToggle.classList.add('hidden'); document.getElementById('isHabitToggle').checked = false; toggleHabitSettings(false); }
            switch (taskType) {
                case 'reward': document.getElementById('fixedTimeGroup').classList.remove('hidden'); break;
                case 'continuous': document.getElementById('multiplierGroup').classList.remove('hidden'); break;
                case 'continuous_target': ['multiplierGroup', 'targetTimeGroup', 'bonusRewardGroup'].forEach(id => document.getElementById(id).classList.remove('hidden')); break;
                case 'instant_redeem': document.getElementById('consumeTimeGroup').classList.remove('hidden'); break;
                case 'continuous_redeem': document.getElementById('multiplierGroup').classList.remove('hidden'); break;
            }
            updateCategoryRecommendations(taskType);
        }

        function toggleHabitSettings(forceState) {
            const isHabit = typeof forceState === 'boolean' ? forceState : document.getElementById('isHabitToggle').checked;
            document.getElementById('habitSettingsGroup').classList.toggle('hidden', !isHabit);
            const fixedTimeLabel = document.getElementById('fixedTimeLabel');
            if(fixedTimeLabel) fixedTimeLabel.textContent = isHabit ? '基础奖励 (秒) *' : '奖励时间 (秒) *';
        }
        
        function toggleHabitDurationInput() { const durationType = document.getElementById('habitDurationType').value; const valueInput = document.getElementById('habitDurationValue'); valueInput.classList.toggle('hidden', durationType === 'infinite'); valueInput.placeholder = durationType === 'days' ? '天数' : '周数'; }

        function addHabitRewardRule(rule = null) {
            const container = document.getElementById('habitRewardsContainer'); const ruleDiv = document.createElement('div');
            ruleDiv.className = 'habit-reward-rule'; const type = rule ? rule.type : 'fixed'; const start = rule ? rule.start : 1; const value = rule ? rule.value : '';
            ruleDiv.innerHTML = `<select class="form-select reward-type"><option value="fixed" ${type === 'fixed' ? 'selected' : ''}>固定奖励</option><option value="incremental" ${type === 'incremental' ? 'selected' : ''}>递增奖励</option></select><input type="number" class="form-input reward-start" placeholder="从第 N 周期" value="${start}" min="1"><input type="number" class="form-input reward-value" placeholder="奖励值(秒)" value="${value}"><button type="button" class="remove-reward-btn" onclick="this.parentElement.remove()">-</button>`;
            container.appendChild(ruleDiv);
        }

        function setTimePreset(fieldId, seconds) { document.getElementById(fieldId).value = seconds; }

        function saveTask(event) {
            event.preventDefault(); clearFormErrors();
            const formData = { name: document.getElementById('taskName').value.trim(), category: document.getElementById('taskCategory').value.trim(), type: document.getElementById('taskType').value, isHabit: document.getElementById('isHabitToggle').checked };
            let hasError = !formData.name || !formData.category || !formData.type;
            if (!formData.name) showFieldError('taskName', '请输入任务名称'); if (!formData.category) showFieldError('taskCategory', '请输入任务分类'); if (!formData.type) showFieldError('taskType', '请选择任务类型');
            
            const parseAndValidate = (id, fieldName, isFloat = false) => { const input = document.getElementById(id); const value = isFloat ? parseFloat(input.value) : parseInt(input.value); if (isNaN(value) || value <= 0) { showFieldError(id, `请输入有效的${fieldName}`); hasError = true; } return value; };
            const parseAndValidateOptional = (id, fieldName) => { const input = document.getElementById(id); if (!input.value) return 0; const value = parseInt(input.value); if (isNaN(value) || value < 0) { showFieldError(id, `请输入有效的${fieldName}`); hasError = true; } return value; }
            
            switch (formData.type) {
                case 'reward': formData.fixedTime = parseAndValidate('fixedTime', '奖励时间'); break;
                case 'instant_redeem': formData.consumeTime = parseAndValidate('consumeTime', '消费时间'); break;
                case 'continuous': case 'continuous_redeem': formData.multiplier = parseAndValidate('multiplier', '时间倍率', true); break;
                case 'continuous_target': formData.multiplier = parseAndValidate('multiplier', '时间倍率', true); formData.targetTime = parseAndValidate('targetTime', '目标时长'); formData.bonusReward = parseAndValidateOptional('bonusReward', '额外奖励'); break;
            }

            if (formData.isHabit) {
                const dailyLimit = parseInt(document.getElementById('habitDailyLimit').value);
                formData.habitDetails = { period: document.getElementById('habitPeriod').value, duration: { type: document.getElementById('habitDurationType').value, value: document.getElementById('habitDurationValue').value ? parseInt(document.getElementById('habitDurationValue').value) : 0 }, dailyLimit: isNaN(dailyLimit) || dailyLimit < 1 ? 1 : dailyLimit, rewards: [] };
                if (formData.habitDetails.duration.type !== 'infinite' && formData.habitDetails.duration.value <= 0) { alert('请输入有效的持续时长'); hasError = true; }
                document.querySelectorAll('.habit-reward-rule').forEach(ruleEl => { const type = ruleEl.querySelector('.reward-type').value; const start = parseInt(ruleEl.querySelector('.reward-start').value); const value = parseInt(ruleEl.querySelector('.reward-value').value); if (!isNaN(start) && start > 0 && !isNaN(value) && value > 0) { formData.habitDetails.rewards.push({ type, start, value }); } else { alert('习惯奖励规则填写不完整或无效'); hasError = true; } });
            }
            if (hasError) return;
            
            let colorToSet = currentSelectedColor;
            if (currentEditingTask) {
                const oldCategory = currentEditingTask.category;
                if (oldCategory !== formData.category) {
                    if (categoryColors.has(formData.category)) { colorToSet = categoryColors.get(formData.category); } 
                    else if (!colorToSet) { colorToSet = getRandomAvailableColor(formData.type); }
                    const oldCategoryInUse = tasks.some(t => t.id !== currentEditingTask.id && t.category === oldCategory);
                    if (!oldCategoryInUse) categoryColors.delete(oldCategory);
                }
            } else {
                if (categoryColors.has(formData.category)) { colorToSet = categoryColors.get(formData.category); } 
                else if (!colorToSet) { colorToSet = getRandomAvailableColor(formData.type); }
            }
            categoryColors.set(formData.category, colorToSet);

            if (currentEditingTask) { 
                if (currentEditingTask.isHabit && !formData.isHabit) delete currentEditingTask.habitDetails; 
                else if (!currentEditingTask.isHabit && formData.isHabit) { formData.habitDetails.streak = 0; formData.habitDetails.lastCompletionDate = null; } 
                else if (currentEditingTask.isHabit && formData.isHabit) { formData.habitDetails.streak = currentEditingTask.habitDetails.streak; formData.habitDetails.lastCompletionDate = currentEditingTask.habitDetails.lastCompletionDate; }
                Object.assign(currentEditingTask, formData); 
            } else { 
                const newTask = { id: Date.now().toString(), ...formData, completionCount: 0, lastUsed: 0 }; 
                if (newTask.isHabit) { newTask.habitDetails.streak = 0; newTask.habitDetails.lastCompletionDate = null; } 
                tasks.push(newTask); 
            }
            saveData(); updateAllUI(); hideTaskModal();
        }

        function showFieldError(fieldId, message) { const field = document.getElementById(fieldId); const errorElement = document.getElementById(fieldId + 'Error'); field.classList.add('error'); errorElement.textContent = message; errorElement.classList.add('show'); }
        function clearFormErrors() { document.querySelectorAll('.form-input.error, .form-select.error').forEach(el => el.classList.remove('error')); document.querySelectorAll('.error-message.show').forEach(el => el.classList.remove('show')); }

        // --- Task Actions ---
        function completeTask(taskId) { const task = tasks.find(t => t.id === taskId); if (!task) return; task.lastUsed = Date.now(); if (task.isHabit) { const todayStr = getLocalDateString(new Date()); const completionsToday = transactions.filter(t => t.taskId === taskId && getLocalDateString(t.timestamp) === todayStr).length; if (completionsToday >= (task.habitDetails.dailyLimit || 1)) { alert('已达到此习惯的每日完成上限'); return; } processHabitCompletion(task, task.fixedTime); } else processNormalCompletion(task); saveData(); updateAllUI(); }
        function processNormalCompletion(task, earnedTime = task.fixedTime, descriptionDetails = '') { currentBalance += earnedTime; task.completionCount = (task.completionCount || 0) + 1; addTransaction({ type: 'earn', taskId: task.id, taskName: task.name, amount: earnedTime, description: `完成任务: ${task.name}${descriptionDetails}` }); updateDailyChanges('earned', earnedTime); showNotification('🎉 任务完成', `获得 ${formatTime(earnedTime)} 时间奖励！`, 'achievement'); }
        function processHabitCompletion(task, baseReward, descriptionDetails = '') {
            const todayStr = getLocalDateString(new Date());
            const isNewPeriod = task.habitDetails.lastCompletionDate !== todayStr;
            let totalReward = baseReward; let bonusDescription = '';
            if (isNewPeriod) {
                checkHabitStreak(task); task.habitDetails.streak = (task.habitDetails.streak || 0) + 1; task.habitDetails.lastCompletionDate = todayStr;
                let habitBonusReward = 0;
                task.habitDetails.rewards.forEach(rule => { if (task.habitDetails.streak >= rule.start) habitBonusReward += (rule.type === 'fixed') ? rule.value : (rule.value * task.habitDetails.streak); });
                totalReward += habitBonusReward; if (habitBonusReward > 0) bonusDescription = ` (含习惯奖励 ${formatTime(habitBonusReward)})`;
                const unitMap = { daily: '天', weekly: '周', monthly: '月' }; const periodText = unitMap[task.habitDetails.period] || '次';
                showNotification('⭐ 习惯已完成!', `连续${task.habitDetails.streak}${periodText}! 获得 ${formatTime(totalReward)} 时间`, 'achievement');
            } else showNotification('👍 习惯重复完成', `获得基础奖励 ${formatTime(baseReward)}`, 'achievement');
            currentBalance += totalReward; task.completionCount = (task.completionCount || 0) + 1;
            addTransaction({ type: 'earn', taskId: task.id, taskName: task.name, amount: totalReward, description: `完成习惯: ${task.name}${descriptionDetails}${bonusDescription}`, isStreakAdvancement: isNewPeriod });
            updateDailyChanges('earned', totalReward);
        }
        function checkHabitStreak(task) { const { lastCompletionDate, period } = task.habitDetails; if (!lastCompletionDate) { task.habitDetails.streak = 0; return; } const today = new Date(); today.setHours(0, 0, 0, 0); const lastDate = new Date(lastCompletionDate); lastDate.setHours(0, 0, 0, 0); let isBroken = false; const diffDays = (today - lastDate) / 86400000; if (period === 'daily' && diffDays > 1) isBroken = true; else if (period === 'weekly') { const todayDay = today.getDay() === 0 ? 7 : today.getDay(); const startOfThisWeek = new Date(today.getTime() - (todayDay - 1) * 86400000); if (lastDate < startOfThisWeek && diffDays > 7) isBroken = true; } else if (period === 'monthly') { const isDifferentMonth = today.getFullYear() > lastDate.getFullYear() || today.getMonth() > lastDate.getMonth(); const isConsecutiveMonth = today.getFullYear() === lastDate.getFullYear() && today.getMonth() === lastDate.getMonth() + 1; if (isDifferentMonth && !isConsecutiveMonth) isBroken = true; } if (isBroken) { task.habitDetails.streak = 0; showNotification('❗ 习惯中断', `"${task.name}" 连续纪录已中断`, 'achievement'); } }
        function startTask(taskId) { runningTasks.set(taskId, { startTime: Date.now(), elapsedTime: 0, isPaused: false, achieved: false }); saveData(); updateRecentTasks(); updateCategoryTasks(); showNotification('▶️ 任务开始', `开始执行任务: ${tasks.find(t=>t.id===taskId).name}`, 'achievement'); }
        function pauseTask(taskId) { const r = runningTasks.get(taskId); if (!r || r.isPaused) return; r.elapsedTime += Date.now() - r.startTime; r.isPaused = true; saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function resumeTask(taskId) { const r = runningTasks.get(taskId); if (!r || !r.isPaused) return; r.startTime = Date.now(); r.isPaused = false; saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function cancelTask(taskId) { runningTasks.delete(taskId); saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function stopTask(taskId) {
            const task = tasks.find(t => t.id === taskId); const runningTask = runningTasks.get(taskId); if (!task || !runningTask) return;
            const totalSeconds = Math.floor((runningTask.elapsedTime + (runningTask.isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
            runningTasks.delete(taskId); task.lastUsed = Date.now();
            if (totalSeconds > 0) {
                if (['continuous', 'continuous_target'].includes(task.type)) {
                    let baseEarnedTime = Math.floor(totalSeconds * task.multiplier); let earnedTimeDescription = ` (${formatTime(totalSeconds)} × ${task.multiplier})`;
                    const targetMet = task.type === 'continuous_target' && (runningTask.achieved || totalSeconds >= task.targetTime);
                    if (targetMet) { baseEarnedTime += task.bonusReward; if (task.bonusReward > 0) earnedTimeDescription += ` + ${formatTime(task.bonusReward)} 达标奖励`; }
                    const habitConditionMet = task.isHabit && (task.type === 'continuous' || targetMet);
                    if (habitConditionMet) { const todayStr = getLocalDateString(new Date()); const completionsToday = transactions.filter(t => t.taskId === taskId && getLocalDateString(t.timestamp) === todayStr).length; if (completionsToday >= (task.habitDetails.dailyLimit || 1)) { alert('已达到此习惯的每日完成上限'); saveData(); updateAllUI(); return; } processHabitCompletion(task, baseEarnedTime, earnedTimeDescription); }
                    else processNormalCompletion(task, baseEarnedTime, earnedTimeDescription);
                } else if (task.type === 'continuous_redeem') { const spentTime = Math.floor(totalSeconds * task.multiplier); currentBalance -= spentTime; task.completionCount = (task.completionCount || 0) + 1; addTransaction({ type: 'spend', taskId: task.id, taskName: task.name, amount: spentTime, description: `连续消费: ${task.name} (${formatTime(totalSeconds)} × ${task.multiplier})` }); updateDailyChanges('spent', spentTime); showNotification('💸 任务消费', `消费 ${formatTime(spentTime)} 时间`, 'achievement'); }
            }
            saveData(); updateAllUI();
        }
        function redeemTask(taskId) {
            const task = tasks.find(t => t.id === taskId); if (!task) return;
            if (currentBalance < task.consumeTime) return alert('余额不足，无法兑换此项目');
            if (!confirm(`确定要消费 ${formatTime(task.consumeTime)} 兑换"${task.name}"吗？`)) return;
            currentBalance -= task.consumeTime; task.completionCount = (task.completionCount || 0) + 1; task.lastUsed = Date.now();
            addTransaction({ type: 'spend', taskId: task.id, taskName: task.name, amount: task.consumeTime, description: `兑换项目: ${task.name}` });
            updateDailyChanges('spent', task.consumeTime); saveData(); updateAllUI(); showNotification('🎁 兑换成功', `成功兑换: ${task.name}`, 'achievement');
        }

        // --- History Modal ---
        function showTaskHistory(taskId) {
            const task = tasks.find(t => t.id === taskId); if (!task) return; currentHistoryTask = task;
            document.getElementById('historyModalTitle').textContent = `${task.name} - 历史记录`;
            const taskTransactions = transactions.filter(t => t.taskId === taskId).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const historyContent = document.getElementById('historyContent');
            if (taskTransactions.length === 0) historyContent.innerHTML = '<div class="empty-message">暂无历史记录</div>';
            else { historyContent.innerHTML = taskTransactions.map(transaction => { const isPositive = transaction.type === 'earn'; return `<div class="history-item" id="history-item-${transaction.id}"><div class="history-info"><div class="history-description">${transaction.description}</div><div class="history-time">${formatDateTime(transaction.timestamp)}</div></div><div class="history-amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : '-'}${formatTime(transaction.amount)}</div><button class="undo-btn" onclick="undoTransaction('${transaction.id}')" title="撤回此条记录">撤回</button></div>`; }).join(''); }
            document.getElementById('historyModal').classList.add('show');
        }
        function undoTransaction(transactionId) {
            const transactionIndex = transactions.findIndex(t => t.id === transactionId); if (transactionIndex === -1) return;
            const transaction = transactions[transactionIndex];
            if (!confirm(`确定要撤回这条记录吗？\n\n描述: ${transaction.description}\n金额: ${transaction.type === 'earn' ? '+' : '-'}${formatTime(transaction.amount)}\n\n此操作将影响总余额、每日统计和任务完成次数，且无法恢复。`)) return;
            if (transaction.type === 'earn') { currentBalance -= transaction.amount; updateDailyChanges('earned', -transaction.amount, new Date(transaction.timestamp)); } 
            else { currentBalance += transaction.amount; updateDailyChanges('spent', -transaction.amount, new Date(transaction.timestamp)); }
            const task = tasks.find(t => t.id === transaction.taskId);
            if (task) {
                if (task.completionCount > 0) task.completionCount--;
                if (task.isHabit && transaction.isStreakAdvancement) {
                     const undoneDateStr = getLocalDateString(transaction.timestamp);
                     if (task.habitDetails.lastCompletionDate === undoneDateStr) {
                        if (task.habitDetails.streak > 0) task.habitDetails.streak--;
                        const previousTransactions = transactions.filter(t => t.id !== transactionId && t.taskId === task.id && t.isStreakAdvancement).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        task.habitDetails.lastCompletionDate = previousTransactions.length > 0 ? getLocalDateString(previousTransactions[0].timestamp) : null;
                     }
                }
            }
            transactions.splice(transactionIndex, 1); saveData(); updateAllUI();
            const historyItemElement = document.getElementById(`history-item-${transactionId}`);
            if (historyItemElement) { historyItemElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease'; historyItemElement.style.opacity = '0'; historyItemElement.style.transform = 'translateX(20px)'; setTimeout(() => { historyItemElement.remove(); if (!document.getElementById('historyContent').querySelector('.history-item')) document.getElementById('historyContent').innerHTML = '<div class="empty-message">暂无历史记录</div>'; }, 300); }
            showNotification('↩️ 操作已撤回', `成功撤回记录: ${transaction.taskName}`, 'achievement');
        }
        function hideHistoryModal() { document.getElementById('historyModal').classList.remove('show'); currentHistoryTask = null; }

        // --- Transactions & Daily Changes ---
        function addTransaction(transaction) { transaction.timestamp = new Date().toISOString(); transaction.id = Date.now().toString() + Math.random().toString(36).substr(2, 9); transactions.unshift(transaction); if (transactions.length > 1000) transactions.pop(); }
        function updateDailyChanges(type, amount, date = new Date()) { const dateString = date.toDateString(); if (!dailyChanges[dateString]) dailyChanges[dateString] = { earned: 0, spent: 0 }; dailyChanges[dateString][type] += amount; }
        
        // --- Reports Page ---
        function setupReportEventListeners() {
            document.getElementById('flowChartFilters').addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { reportState.flowChartPeriod = e.target.dataset.period; document.querySelectorAll('#flowChartFilters button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); updateFlowChart(); } });
            document.getElementById('heatmapPrevMonth').addEventListener('click', () => navigateHeatmap(-1)); document.getElementById('heatmapNextMonth').addEventListener('click', () => navigateHeatmap(1));
        }
        function updateSummaryStats() {
            const totalEarned = transactions.filter(t => t.type === 'earn').reduce((sum, t) => sum + t.amount, 0); const totalSpent = transactions.filter(t => t.type === 'spend').reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('totalEarned').textContent = formatTime(totalEarned);
            document.getElementById('totalSpent').textContent = formatTime(totalSpent);
        }
        function updateAllReports() {
            updateSummaryStats();
            updateFlowChart();
            updateActivityHeatmap();
            updateAnalysisDashboard();
            updateTrendChart();
            updateDetailedDataTable();
        }
        function getFilteredTransactions(period) {
            let filtered = transactions.filter(t => !t.undone);
            if (period === 'all') return filtered;
            const now = new Date();
            let startDate;
            if (period === '7d') startDate = new Date(new Date().setDate(now.getDate() - 7));
            else if (period === '30d') startDate = new Date(new Date().setDate(now.getDate() - 30));
            return filtered.filter(t => new Date(t.timestamp) >= startDate);
        }
        function updateFlowChart() {
            const filtered = getFilteredTransactions(reportState.flowChartPeriod); const container = document.getElementById('flowChartContainer');
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-message" style="color:var(--text-color-light)">此期间无数据</div>'; return; }
            const processData = (type) => { const data = new Map(); filtered.filter(t => t.type === type).forEach(t => { const task = tasks.find(tsk => tsk.id === t.taskId); const category = task ? task.category : '未知'; data.set(category, (data.get(category) || 0) + t.amount); }); const total = Array.from(data.values()).reduce((sum, val) => sum + val, 0); const sorted = Array.from(data.entries()).sort((a, b) => b[1] - a[1]); let segments = sorted.slice(0, 4).map(([category, amount]) => ({ category, amount, percent: total > 0 ? (amount / total) * 100 : 0 })); if (sorted.length > 4) { const otherAmount = sorted.slice(4).reduce((sum, [, amount]) => sum + amount, 0); segments.push({ category: '其它', amount: otherAmount, percent: total > 0 ? (otherAmount / total) * 100 : 0 }); } return { segments, total }; };
            const { segments: earnedSegments, total: totalEarned } = processData('earn'); const { segments: spentSegments, total: totalSpent } = processData('spend');
            const renderBar = (label, segments, total) => `<div class="flow-bar-wrapper"><div class="flow-bar-label">${label}<br><small>${formatTime(total)}</small></div><div class="flow-bar">${segments.map(s => `<div class="flow-bar-segment" style="width: ${s.percent}%; background-color: ${s.category === '其它' ? '#ccc' : (categoryColors.get(s.category) || '#888')};"><span class="tooltip">${s.category}: ${formatTime(s.amount)} (${s.percent.toFixed(1)}%)</span></div>`).join('')}</div></div>`;
            container.innerHTML = (totalEarned > 0 ? renderBar('获得', earnedSegments, totalEarned) : '') + (totalSpent > 0 ? renderBar('消费', spentSegments, totalSpent) : '');
        }
        function navigateHeatmap(offset) { reportState.heatmapDate.setMonth(reportState.heatmapDate.getMonth() + offset); updateActivityHeatmap(); }
        
        function updateActivityHeatmap() {
            const container = document.getElementById('heatmapGrid'); 
            const legendContainer = document.getElementById('heatmapLegend'); 
            const label = document.getElementById('heatmapMonthLabel');
            
            const dailyData = new Map();
            transactions.filter(t => !t.undone).forEach(t => {
                const localDateStr = getLocalDateString(t.timestamp);
                if (!dailyData.has(localDateStr)) {
                    dailyData.set(localDateStr, { earned: 0, spent: 0 });
                }
                
                if (t.type) {
                    const typeKey = t.type === 'earn' ? 'earned' : 'spent';
                    dailyData.get(localDateStr)[typeKey] += t.amount;
                } else {
                    if (t.amount > 0) dailyData.get(localDateStr).earned += t.amount;
                    else dailyData.get(localDateStr).spent += Math.abs(t.amount);
                }
            });
            
            const year = reportState.heatmapDate.getFullYear(); 
            const month = reportState.heatmapDate.getMonth();
            label.textContent = `${year}年 ${month + 1}月`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay(); 
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = '';
            for(let i = 0; i < firstDayOfMonth; i++) { html += `<div class="heatmap-spacer"></div>`; }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const localDateStr = getLocalDateString(currentDate);
                const data = dailyData.get(localDateStr);
                let colorClass = '';

                if (data) {
                    const net = data.earned - data.spent;
                    colorClass = getHeatmapColorClass(net);
                }
                html += `<div class="heatmap-day" onclick="showDayDetails('${localDateStr}')"><div class="heatmap-day-content ${colorClass}">${day}</div></div>`;
            }
            container.innerHTML = html;
            
            const nextMonth = new Date(year, month + 1, 1);
            document.getElementById('heatmapNextMonth').disabled = nextMonth > new Date();
            legendContainer.innerHTML = `赤字 <div class="legend-item"><div class="legend-box" style="background-color: #ffcdd2;"></div><div class="legend-box" style="background-color: #e57373;"></div><div class="legend-box" style="background-color: #f44336;"></div></div> | <div class="legend-item"><div class="legend-box" style="background-color: #9be9a8;"></div><div class="legend-box" style="background-color: #40c463;"></div><div class="legend-box" style="background-color: #216e39;"></div></div> 盈余`;
        }
        
        function showDayDetails(localDateStr) {
            const modal = document.getElementById('dayDetailModal'); 
            const title = document.getElementById('dayDetailModalTitle'); 
            const content = document.getElementById('dayDetailContent');
            title.textContent = `${localDateStr} 详情`;
            
            const dayTransactions = transactions
                .filter(t => !t.undone && getLocalDateString(t.timestamp) === localDateStr)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if (dayTransactions.length === 0) { 
                content.innerHTML = '<div class="empty-message">本日无活动记录</div>'; 
                modal.classList.add('show'); 
                return; 
            }
            
            const dailyEarned = dayTransactions.reduce((sum, t) => sum + (t.type === 'earn' ? t.amount : (!t.type && t.amount > 0 ? t.amount : 0)), 0);
            const dailySpent = dayTransactions.reduce((sum, t) => sum + (t.type === 'spend' ? t.amount : (!t.type && t.amount < 0 ? Math.abs(t.amount) : 0)), 0);
            const dailyNet = dailyEarned - dailySpent;
            
            const netClass = dailyNet > 0 ? 'positive' : (dailyNet < 0 ? 'negative' : '');
            const netSign = dailyNet > 0 ? '+' : (dailyNet < 0 ? '' : '');
            
            let summaryHtml = `<div class="day-detail-summary"><div class="day-detail-net ${netClass}">净值: ${netSign}${formatTime(dailyNet)}</div><div class="day-detail-stats"><span>获得: <span class="positive">${formatTime(dailyEarned)}</span></span> | <span>消费: <span class="negative">${formatTime(dailySpent)}</span></span></div></div>`;
            let listHtml = dayTransactions.map(transaction => {
                const isPositive = transaction.type === 'earn' || (!transaction.type && transaction.amount > 0);
                const amount = Math.abs(transaction.amount);
                return `<div class="history-item"><div class="history-info" title="${transaction.description}"><div class="history-description">${transaction.description}</div><div class="history-time">${new Date(transaction.timestamp).toLocaleTimeString('zh-CN')}</div></div><div class="history-amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : '-'}${formatTime(amount)}</div></div>`;
            }).join('');
            
            content.innerHTML = summaryHtml + listHtml;
            modal.classList.add('show');
        }

        function hideDayDetailModal() { document.getElementById('dayDetailModal').classList.remove('show'); }

        // --- Analysis Dashboard ---
        function updateAnalysisDashboard() {
            renderAnalysisFilters();
            const filteredTransactions = getFilteredTransactions(reportState.analysisPeriod);
            const { aggregatedData } = processDashboardData(filteredTransactions, reportState.analysisView);
            let finalData = aggregatedData;
            if (reportState.analysisItemFilter) {
                finalData = aggregatedData.filter(item => item.name === reportState.analysisItemFilter);
            }
            renderKpiCards(filteredTransactions, finalData);
            renderLeaderboardCharts(aggregatedData);
        }

        function updateTrendChart() {
            const container = document.getElementById('trendChartContainerWrapper');
            const filtersHTML = `<div class="analysis-filters">
                <div class="analysis-view-switcher report-filters">
                    <button class="${reportState.trendView === 'category' ? 'active' : ''}" onclick="setTrendView('category')">按分类</button>
                    <button class="${reportState.trendView === 'task' ? 'active' : ''}" onclick="setTrendView('task')">按任务</button>
                </div>
                <div class="report-filters">
                    <button class="${reportState.trendPeriod === '7d' ? 'active' : ''}" onclick="setTrendPeriod('7d')">最近7天</button>
                    <button class="${reportState.trendPeriod === '30d' ? 'active' : ''}" onclick="setTrendPeriod('30d')">最近30天</button>
                </div>
            </div>`;
            const chartsHTML = `<div class="trend-chart-container" id="trendChartContainer"></div>`;
            container.innerHTML = filtersHTML + chartsHTML;
            
            const filteredTransactions = getFilteredTransactions(reportState.trendPeriod);
            const { aggregatedData, trendData } = processDashboardData(filteredTransactions, reportState.trendView);
            renderTrendCharts(trendData, aggregatedData);
        }

        function updateDetailedDataTable() {
            const container = document.getElementById('tableContainerWrapper');
            const filtersHTML = `<div class="analysis-filters">
                <div class="analysis-view-switcher report-filters">
                    <button class="${reportState.tableView === 'category' ? 'active' : ''}" onclick="setTableView('category')">按分类</button>
                    <button class="${reportState.tableView === 'task' ? 'active' : ''}" onclick="setTableView('task')">按任务</button>
                </div>
                <div class="report-filters">
                    <button class="${reportState.tablePeriod === '7d' ? 'active' : ''}" onclick="setTablePeriod('7d')">最近7天</button>
                    <button class="${reportState.tablePeriod === '30d' ? 'active' : ''}" onclick="setTablePeriod('30d')">最近30天</button>
                    <button class="${reportState.tablePeriod === 'all' ? 'active' : ''}" onclick="setTablePeriod('all')">全部</button>
                </div>
            </div>`;
            const tableHTML = `<div class="analysis-table-container">
                <table class="analysis-table" id="analysisTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>`;
            container.innerHTML = filtersHTML + tableHTML;
            
            const filteredTransactions = getFilteredTransactions(reportState.tablePeriod);
            const { aggregatedData } = processDashboardData(filteredTransactions, reportState.tableView);
            renderDetailedDataTable(aggregatedData);
        }

        function renderAnalysisFilters() {
            const container = document.getElementById('analysisDashboardFilters');
            let viewSwitcherHTML = `<div class="analysis-view-switcher report-filters">
                <button class="${reportState.analysisView === 'category' ? 'active' : ''}" onclick="setAnalysisView('category')">按分类</button>
                <button class="${reportState.analysisView === 'task' ? 'active' : ''}" onclick="setAnalysisView('task')">按任务</button>
            </div>`;
            let periodFilterHTML = `<div class="report-filters">
                <button class="${reportState.analysisPeriod === '7d' ? 'active' : ''}" onclick="setAnalysisPeriod('7d')">最近7天</button>
                <button class="${reportState.analysisPeriod === '30d' ? 'active' : ''}" onclick="setAnalysisPeriod('30d')">最近30天</button>
                <button class="${reportState.analysisPeriod === 'all' ? 'active' : ''}" onclick="setAnalysisPeriod('all')">全部</button>
            </div>`;
            let itemFilterHTML = '';
            if (reportState.analysisItemFilter) {
                itemFilterHTML = `<button class="report-filters active" onclick="setAnalysisItemFilter(null)">当前筛选: ${reportState.analysisItemFilter} &times;</button>`;
            }
            container.innerHTML = `<div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-between;">${viewSwitcherHTML}${periodFilterHTML}</div>${itemFilterHTML}`;
        }

        function setAnalysisPeriod(period) { reportState.analysisPeriod = period; updateAnalysisDashboard(); }
        function setAnalysisView(view) { reportState.analysisView = view; reportState.analysisItemFilter = null; updateAnalysisDashboard(); }
        function setAnalysisItemFilter(name) { if (name === '其他') return; reportState.analysisItemFilter = name; updateAnalysisDashboard(); }
        function setTrendPeriod(period) { reportState.trendPeriod = period; updateTrendChart(); }
        function setTrendView(view) { reportState.trendView = view; updateTrendChart(); }
        function setTablePeriod(period) { reportState.tablePeriod = period; updateDetailedDataTable(); }
        function setTableView(view) { reportState.tableView = view; updateDetailedDataTable(); }

        function renderKpiCards(transactions, data) {
            const container = document.getElementById('kpiGrid');
            if (transactions.length === 0) {
                container.innerHTML = ''; return;
            }

            const uniqueDays = new Set(transactions.map(t => getLocalDateString(t.timestamp))).size;
            const totalNet = data.reduce((sum, item) => sum + item.net, 0);
            const avgDailyNet = uniqueDays > 0 ? totalNet / uniqueDays : 0;
            const fullDataset = processDashboardData(transactions, reportState.analysisView).aggregatedData;
            const sortedByEarned = [...fullDataset].sort((a,b) => b.earned - a.earned);
            const sortedBySpent = [...fullDataset].sort((a,b) => b.spent - a.spent);
            const topEarner = sortedByEarned.length > 0 && sortedByEarned[0].earned > 0 ? sortedByEarned[0].name : '无';
            const topSpender = sortedBySpent.length > 0 && sortedBySpent[0].spent > 0 ? sortedBySpent[0].name : '无';
            
            let kpiLabel = "总净时间";
            if (reportState.analysisPeriod === '7d') kpiLabel = "7日内净时间";
            if (reportState.analysisPeriod === '30d') kpiLabel = "30日内净时间";
            if (reportState.analysisItemFilter) kpiLabel = `"${reportState.analysisItemFilter}"净时间`;

            container.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">平均每日净增</div>
                    <div class="kpi-value ${avgDailyNet >= 0 ? 'positive' : 'negative'}">${avgDailyNet >= 0 ? '+' : ''}${formatTime(avgDailyNet)}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">${kpiLabel}</div>
                    <div class="kpi-value ${totalNet >= 0 ? 'positive' : 'negative'}">${totalNet >= 0 ? '+' : ''}${formatTime(totalNet)}</div>
                </div>
                ${reportState.analysisItemFilter ? '' : `
                <div class="kpi-card">
                    <div class="kpi-label">主要时间来源</div>
                    <div class="kpi-value positive">${topEarner}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">主要时间去向</div>
                    <div class="kpi-value negative">${topSpender}</div>
                </div>`}
            `;
        }
        
        function renderLeaderboardCharts(data) {
            const container = document.getElementById('leaderboardGrid');
            const topN = reportState.analysisView === 'category' ? 3 : 5;

            const createChartHTML = (sourceData, type) => {
                const valueKey = type === 'earn' ? 'earned' : 'spent';
                let chartData = sourceData.filter(d => d[valueKey] > 0).sort((a,b) => b[valueKey] - a[valueKey]);
                
                if (chartData.length > topN) {
                    const othersValue = chartData.slice(topN).reduce((acc, item) => acc + item[valueKey], 0);
                    chartData = chartData.slice(0, topN);
                    if (othersValue > 0) chartData.push({ name: '其他', [valueKey]: othersValue });
                }

                if (chartData.length === 0) return '';
                
                const title = type === 'earn' ? '时间来源排行' : '时间去向排行';
                const maxVal = chartData.length > 0 ? chartData[0][valueKey] : 0;
                
                const itemsHTML = chartData.map(item => {
                    const value = item[valueKey];
                    const percent = maxVal > 0 ? (value / maxVal) * 100 : 0;
                    
                    // Simple estimation: 1 hour text is roughly 50-60px.
                    // Let's use a percentage-based heuristic for simplicity.
                    const isShortBar = percent < 35; 
                    const valueClass = isShortBar ? 'outside' : 'inside';

                    return `
                        <div class="leaderboard-item" ${item.name !== '其他' ? `onclick="setAnalysisItemFilter('${item.name}')"` : ''} title="${item.name}">
                            <div class="leaderboard-label">${item.name}</div>
                            <div class="leaderboard-bar-wrapper">
                                <div class="leaderboard-bar ${type}" style="width: ${percent}%;">
                                    ${!isShortBar ? `<span class="leaderboard-bar-value ${valueClass}">${formatTime(value)}</span>` : ''}
                                </div>
                                ${isShortBar ? `<span class="leaderboard-bar-value ${valueClass}">${formatTime(value)}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                return `<div class="chart-container">${title ? `<div class="chart-title">${title}</div>` : ''}<div class="leaderboard-chart">${itemsHTML}</div></div>`;
            };

            container.innerHTML = createChartHTML(data, 'earn') + createChartHTML(data, 'spend');
        }

        function renderTrendCharts(trendData, allAggregatedData) {
            const container = document.getElementById('trendChartContainer');
            const topN = reportState.trendView === 'category' ? 3 : 5;
            
            const createChartHTML = (type) => {
                const valueKey = type === 'earned' ? 'earned' : 'spent';
                const title = valueKey === 'earned' ? '获得时间趋势' : '消费时间趋势';
                const dates = Object.keys(trendData).sort();
                
                if (dates.length === 0) return '';
                
                const topItems = new Set(allAggregatedData
                    .filter(d => d[valueKey] > 0)
                    .sort((a,b) => b[valueKey] - a[valueKey])
                    .slice(0, topN)
                    .map(d => d.name));

                if(topItems.size === 0 && !Object.values(trendData).some(d => Object.keys(d[type]).length > 0)) return `<div class="chart-container"><div class="chart-title">${title}</div><div class="empty-message" style="padding: 20px 0; color: var(--text-color-light);">无数据</div></div>`;

                const maxDailyTotal = Math.max(1, ...dates.map(date => {
                    return Object.values(trendData[date][type]).reduce((sum, val) => sum + val, 0);
                }));

                const daysHTML = dates.map(date => {
                    const dayData = trendData[date][type];
                    let dailyTotal = 0;
                    let othersValue = 0;
                    const segments = [];
                    const tooltipEntries = {};

                    for(const name in dayData) {
                        const value = dayData[name];
                        dailyTotal += value;
                        tooltipEntries[name] = value;
                        if (topItems.has(name)) {
                            segments.push({ name, value });
                        } else {
                            othersValue += value;
                        }
                    }
                    if (othersValue > 0) {
                        segments.push({ name: '其他', value: othersValue });
                        tooltipEntries['其他'] = othersValue;
                    }
                    
                    const tooltipContent = Object.entries(tooltipEntries).sort((a,b)=>b[1]-a[1]).map(([name, value]) => `<div>${name}: ${formatTime(value)}</div>`).join('');
                    
                    const segmentsHTML = segments.sort((a,b) => b.value - a.value).map(item => {
                        const height = dailyTotal > 0 ? (item.value / dailyTotal) * 100 : 0;
                        let color;
                        if(item.name === '其他') {
                            color = '#cccccc';
                        } else {
                             color = reportState.trendView === 'category' ? categoryColors.get(item.name) : categoryColors.get(tasks.find(t => t.name === item.name)?.category);
                        }
                        return `<div class="trend-segment" style="height: ${height}%; background-color: ${color || '#ccc'}"></div>`;
                    }).join('');

                    const totalHeight = maxDailyTotal > 0 ? (dailyTotal / maxDailyTotal) * 100 : 0;
                    return `<div>
                                <div class="trend-day" style="height: ${Math.max(totalHeight, 2)}%;">
                                    ${segmentsHTML}
                                    <span class="tooltip"><b>${date}</b><hr style="border-color: #555; margin: 4px 0;">${tooltipContent}<b>总计: ${formatTime(dailyTotal)}</b></span>
                                </div>
                                <div class="trend-date-label">${new Date(date).getDate()}</div>
                            </div>`;
                }).join('');
                
                const legendItems = allAggregatedData.filter(d => d[valueKey] > 0).sort((a,b) => b[valueKey] - a[valueKey]);
                const topLegend = legendItems.slice(0, topN);
                if (legendItems.length > topN) topLegend.push({ name: '其他' });

                const legendHTML = topLegend.map(item => {
                    let color;
                    if (item.name === '其他') {
                        color = '#cccccc';
                    } else {
                        color = reportState.trendView === 'category' ? categoryColors.get(item.name) : categoryColors.get(item.category);
                    }
                    return `<div class="legend-item" ${item.name !== '其他' ? `onclick="setAnalysisItemFilter('${item.name}')"`: ''}>
                                <div class="legend-color-box" style="background-color:${color || '#ccc'};"></div>
                                <div class="legend-label">${item.name}</div>
                            </div>`;
                }).join('');

                return `
                    <div class="chart-title">${title}</div>
                    <div class="trend-chart" style="height: 150px;">${daysHTML}</div>
                    <div class="chart-legend">${legendHTML}</div>
                `;
            };
            
            container.innerHTML = createChartHTML('earned') + createChartHTML('spent');
        }

        function renderDetailedDataTable(data) {
            const table = document.getElementById('analysisTable'); const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody');
            
            const headers = reportState.tableView === 'category' ?
                { name: '分类', net: '净值', earned: '获得', spent: '消费', count: '次数' } :
                { name: '任务', category: '分类', net: '净值', earned: '获得', spent: '消费', count: '次数' };
                
            thead.innerHTML = `<tr>${Object.values(headers).map(value => `<th>${value}</th>`).join('')}</tr>`;
            
            const sortedData = [...data].sort((a,b) => b.net - a.net);

            tbody.innerHTML = sortedData.length > 0 ? sortedData.map(row => {
                const netText = row.net >= 0 ? `+${formatTime(row.net)}` : `-${formatTime(Math.abs(row.net))}`;
                const netClass = row.net > 0 ? 'text-positive' : (row.net < 0 ? 'text-negative' : 'text-neutral');
                
                if (reportState.tableView === 'category') {
                    return `<tr><td>${row.name}</td><td class="${netClass}">${netText}</td><td>${formatTime(row.earned)}</td><td>${formatTime(row.spent)}</td><td>${row.count}</td></tr>`;
                } else {
                    return `<tr><td>${row.name}</td><td>${row.category}</td><td class="${netClass}">${netText}</td><td>${formatTime(row.earned)}</td><td>${formatTime(row.spent)}</td><td>${row.count}</td></tr>`;
                }
            }).join('') : `<tr><td colspan="${Object.keys(headers).length}" class="empty-message" style="color:var(--text-color);">无匹配数据</td></tr>`;
        }

        function processDashboardData(transactionsToProcess, view) {
            const dataMap = new Map();
            const trendData = {};

            const getItemNameAndCategory = (t) => {
                const task = tasks.find(tsk => tsk.id === t.taskId);
                if (view === 'category') {
                    return { name: task ? task.category : '未知', category: null };
                }
                return { name: t.taskName || task?.name || '未知任务', category: task?.category };
            };

            transactionsToProcess.forEach(t => {
                const { name, category } = getItemNameAndCategory(t);
                if (!name) return;

                if (!dataMap.has(name)) {
                    dataMap.set(name, { name, category, earned: 0, spent: 0, net: 0, count: 0 });
                }
                
                const item = dataMap.get(name);
                const isEarn = t.type ? t.type === 'earn' : t.amount > 0;
                const amount = Math.abs(t.amount);
                if (isEarn) { item.earned += amount; item.net += amount; } 
                else { item.spent += amount; item.net -= amount; }
                item.count++;

                const dateStr = getLocalDateString(t.timestamp);
                if (!trendData[dateStr]) trendData[dateStr] = { earned: {}, spent: {} };
                const trendType = isEarn ? 'earned' : 'spent';
                trendData[dateStr][trendType][name] = (trendData[dateStr][trendType][name] || 0) + amount;
            });

            return { aggregatedData: Array.from(dataMap.values()), trendData };
        }
        
        // --- Utilities & Settings ---
        function getLocalDateString(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getHeatmapColorClass(net) {
            if (net === 0) return '';
            const absNet = Math.abs(net);
            if (net > 0) {
                if (absNet < 3600) return 'net-surplus-1';
                if (absNet < 10800) return 'net-surplus-2';
                return 'net-surplus-3';
            } else {
                if (absNet < 3600) return 'net-deficit-1';
                if (absNet < 10800) return 'net-deficit-2';
                return 'net-deficit-3';
            }
        }

        function updateCategoryRecommendations(taskType) { let relevantCategories = []; if (taskType) { const isEarnType = ['reward', 'continuous', 'continuous_target'].includes(taskType); const filteredTasks = tasks.filter(task => { const taskIsEarn = ['reward', 'continuous', 'continuous_target'].includes(task.type); return isEarnType === taskIsEarn; }); relevantCategories = [...new Set(filteredTasks.map(t => t.category))]; } else { relevantCategories = [...new Set(tasks.map(t => t.category))]; } document.getElementById('categoryRecommendations').innerHTML = relevantCategories.map(cat => `<div class="recommendation-item" onclick="selectCategory('${cat}')">${cat}</div>`).join(''); }
        function selectCategory(category) { document.getElementById('taskCategory').value = category; }
        
        function formatTime(seconds) {
            if (seconds === null || isNaN(seconds)) return '0秒';
            if (seconds < 0) return '-' + formatTime(-seconds);
            if (seconds === 0) return '0秒';
            seconds = Math.round(seconds);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            const parts = [];
            if (h > 0) parts.push(`${h}小时`);
            if (m > 0) parts.push(`${m}分钟`);
            if (h === 0 && s > 0) {
                parts.push(`${s}秒`);
            }
            return parts.length > 0 ? parts.join('') : '0秒';
        }

        function formatDateTime(timestamp) { const d = new Date(timestamp), n = new Date(); const diff = (new Date(n.toDateString()) - new Date(d.toDateString())) / 86400000; if (diff === 0) return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); if (diff === 1) return '昨天 ' + d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); if (diff < 7) return `${diff}天前`; return d.toLocaleDateString('zh-CN'); }
        function requestNotificationPermission() { if ('Notification' in window) Notification.requestPermission(); }
        function showNotification(title, body, type) { if (!notificationSettings[type] || !('Notification' in window) || Notification.permission !== 'granted') return; new Notification(title, { body, icon: '/favicon.ico' }); }
        function toggleAchievementNotifications() { notificationSettings.achievement = document.getElementById('achievementNotificationToggle').checked; if (notificationSettings.achievement && Notification.permission === 'default') requestNotificationPermission(); saveData(); }
        function toggleLongRunningNotifications() { notificationSettings.longRunning = document.getElementById('longRunningNotificationToggle').checked; saveData(); }
        function updateLongRunningThreshold() { const v = parseInt(document.getElementById('longRunningThreshold').value); if (v >= 300) { notificationSettings.longRunningThreshold = v; saveData(); } }
        function toggleLowBalanceNotifications() { notificationSettings.lowBalance = document.getElementById('lowBalanceNotificationToggle').checked; saveData(); }
        function updateLowBalanceThreshold() { const v = parseInt(document.getElementById('lowBalanceThreshold').value); if (v >= 0) { notificationSettings.lowBalanceThreshold = v; saveData(); updateBalance(); } }
        function updateNotificationSettingsUI() { document.getElementById('achievementNotificationToggle').checked = notificationSettings.achievement; document.getElementById('longRunningNotificationToggle').checked = notificationSettings.longRunning; document.getElementById('longRunningThreshold').value = notificationSettings.longRunningThreshold; document.getElementById('lowBalanceNotificationToggle').checked = notificationSettings.lowBalance; document.getElementById('lowBalanceThreshold').value = notificationSettings.lowBalanceThreshold; }
        
        let systemThemeListener = null;
        function applyTheme(theme) { if (systemThemeListener) { window.matchMedia('(prefers-color-scheme: dark)').removeEventListener('change', systemThemeListener); systemThemeListener = null; } if (theme === 'system') { const p = window.matchMedia('(prefers-color-scheme: dark)').matches; document.body.setAttribute('data-theme', p ? 'dark' : 'light'); systemThemeListener = e => document.body.setAttribute('data-theme', e.matches ? 'dark' : 'light'); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', systemThemeListener); } else { document.body.setAttribute('data-theme', theme); } document.querySelectorAll('.theme-option').forEach(b => b.classList.toggle('active', b.dataset.themeValue === theme)); }
        function setTheme(theme) { applyTheme(theme); localStorage.setItem('themePreference', theme); }
        
        // --- Data Persistence ---
        function exportData() {
            const migratedTransactions = transactions.map(t => {
                if (t.type) return t;
                const isEarn = t.amount > 0;
                const task = tasks.find(tsk => tsk.id === t.taskId);
                return {
                    ...t,
                    type: isEarn ? 'earn' : 'spend',
                    amount: Math.abs(t.amount),
                    taskName: t.taskName || (task ? task.name : '未知任务')
                };
            });

            const d = { version: APP_VERSION, currentBalance, tasks, transactions: migratedTransactions, categoryColors: [...categoryColors], collapsedCategories: [...collapsedCategories], dailyChanges, notificationSettings, exportTime: new Date().toISOString() }; 
            const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' }); 
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `timebank_backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(a.href); showNotification('📁 数据已导出', '所有历史数据已更新为最新格式。', 'achievement'); 
        }

        function importData(event) {
            const f = event.target.files[0]; if (!f) return;
            const r = new FileReader();
            r.onload = function(e) {
                try {
                    let d = JSON.parse(e.target.result);
                    if (!d.version || !Array.isArray(d.tasks)) throw new Error('无效的数据格式');
                    if (!confirm('导入数据将覆盖当前所有数据，确定要继续吗？')) return;

                    d = repairAndMigrateData(d);

                    currentBalance = d.currentBalance || 0;
                    tasks = d.tasks || [];
                    transactions = d.transactions || [];
                    categoryColors = new Map(d.categoryColors || []);
                    collapsedCategories = new Set(d.collapsedCategories || []);
                    dailyChanges = d.dailyChanges || {};
                    if (d.notificationSettings) notificationSettings = { ...notificationSettings, ...d.notificationSettings };
                    runningTasks.clear();
                    saveData();
                    updateAllUI();
                    updateNotificationSettingsUI();
                    showNotification('📥 导入完成', '数据已成功导入并修复。', 'achievement');
                } catch (error) {
                    alert('导入失败：' + error.message);
                }
            };
            r.readAsText(f);
            event.target.value = '';
        }
        function clearAllData() { if (!confirm('确定要清空所有数据吗？此操作无法撤销！') || !confirm('最后确认：这将删除所有任务、交易记录和设置，确定要继续吗？')) return; localStorage.removeItem('timeBankData'); localStorage.removeItem('themePreference'); location.reload(); }
        
        function saveData() { const data = { version: APP_VERSION, currentBalance, tasks, transactions, categoryColors: [...categoryColors], collapsedCategories: [...collapsedCategories], runningTasks: [...runningTasks], dailyChanges, notificationSettings }; localStorage.setItem('timeBankData', JSON.stringify(data)); }
        
        function repairAndMigrateData(data) {
            if (!data.transactions || !Array.isArray(data.transactions) || !Array.isArray(data.tasks)) {
                return data;
            }

            let repairedCount = 0;
            const taskNameMap = new Map(data.tasks.map(task => [task.name, task.id]));

            data.transactions.forEach(t => {
                let needsUpdate = false;
                
                if (!t.taskId && t.description) {
                    const match = t.description.match(/"([^"]+)"/);
                    if (match && match[1]) {
                        const taskNameInDesc = match[1];
                        if (taskNameMap.has(taskNameInDesc)) {
                            t.taskId = taskNameMap.get(taskNameInDesc);
                            if (!t.taskName) {
                                t.taskName = taskNameInDesc;
                            }
                            repairedCount++;
                            needsUpdate = true;
                        }
                    }
                }

                if (!t.type) {
                     const isEarn = t.amount > 0;
                     t.type = isEarn ? 'earn' : 'spend';
                     t.amount = Math.abs(t.amount);
                     needsUpdate = true;
                }
            });

            if (repairedCount > 0) {
                console.log(`[Data Repair] Successfully repaired ${repairedCount} transactions by adding missing task IDs.`);
            }
            return data;
        }

        function loadData() {
            try {
                const s = localStorage.getItem('timeBankData');
                if (s) {
                    let d = JSON.parse(s);
                    
                    let dataWasRepaired = false;
                    const originalTransactions = JSON.stringify(d.transactions);

                    d = repairAndMigrateData(d); 
                    
                    if(JSON.stringify(d.transactions) !== originalTransactions) {
                        dataWasRepaired = true;
                    }

                    if (!d.version || d.version < APP_VERSION || dataWasRepaired) {
                        d.version = APP_VERSION;
                        localStorage.setItem('timeBankData', JSON.stringify(d)); 
                        if (dataWasRepaired) console.log("Persisted repaired data to local storage.");
                    }
                    
                    currentBalance = d.currentBalance || 0;
                    tasks = d.tasks || [];
                    transactions = d.transactions || [];
                    categoryColors = new Map(d.categoryColors || []);
                    collapsedCategories = new Set(d.collapsedCategories || []);
                    runningTasks = new Map(d.runningTasks || []);
                    dailyChanges = d.dailyChanges || {};
                    if (d.notificationSettings) notificationSettings = { ...notificationSettings, ...d.notificationSettings };
                }
                const t = localStorage.getItem('themePreference') || 'system';
                setTheme(t);
            } catch (error) { console.error('加载数据失败:', error); }
        }
        
        // --- Color Management for Categories ---
        function renderColorSelectors(editingColor = null) {
            const usedColors = Array.from(categoryColors.values());
            const render = (containerId, colors) => {
                const container = document.getElementById(containerId);
                container.innerHTML = colors.map(color => {
                    const isUsed = usedColors.includes(color);
                    const isDisabled = isUsed && color !== editingColor;
                    const isSelected = color === currentSelectedColor;
                    return `<div class="color-swatch ${isDisabled ? 'disabled' : ''} ${isSelected ? 'selected' : ''}" style="background-color: ${color};" data-color="${color}"><span class="checkmark">✔</span></div>`;
                }).join('');
            };
            render('earnColorSelector', earnColors);
            render('spendColorSelector', spendColors);
        }
        function handleColorSelection(event) {
            const swatch = event.target.closest('.color-swatch');
            if (!swatch || swatch.classList.contains('disabled')) return;
            currentSelectedColor = swatch.dataset.color;
            const selector = swatch.parentElement;
            selector.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            swatch.classList.add('selected');
        }
        function getRandomAvailableColor(taskType) {
            const isEarn = ['reward', 'continuous', 'continuous_target'].includes(taskType);
            const colorPalette = isEarn ? earnColors : spendColors;
            const usedColors = new Set(Array.from(categoryColors.values()));
            const availableColors = colorPalette.filter(c => !usedColors.has(c));
            if (availableColors.length > 0) { return availableColors[Math.floor(Math.random() * availableColors.length)]; }
            return colorPalette[Math.floor(Math.random() * colorPalette.length)];
        }

        // --- Event Listeners ---
        document.getElementById('earnColorSelector').addEventListener('click', handleColorSelection);
        document.getElementById('spendColorSelector').addEventListener('click', handleColorSelection);
        document.addEventListener('DOMContentLoaded', initApp);
        window.addEventListener('beforeunload', saveData);
        document.addEventListener('click', e => { if (e.target.classList.contains('modal')) { if (e.target.id === 'taskModal') hideTaskModal(); else if (e.target.id === 'historyModal') hideHistoryModal(); else if (e.target.id === 'dayDetailModal') hideDayDetailModal(); } });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { if (document.getElementById('taskModal').classList.contains('show')) hideTaskModal(); else if (document.getElementById('historyModal').classList.contains('show')) hideHistoryModal(); else if (document.getElementById('dayDetailModal').classList.contains('show')) hideDayDetailModal(); } else if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); showTaskModal(); } });
    </script>
</body>
</html>