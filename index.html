<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间银行 - Time Bank v3.8.1</title>
    <style>
        /* --- [v3.7.7] Fixed Layout Implementation --- */
        :root {
            /* 1.3.2. Spacing Tokens */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 24px;
            --space-xxl: 32px;

            /* Other variables */
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.1);
            --text-color: #333;
            --text-color-light: #666;
            --border-color: #ddd;
            --input-bg: #fff;
            --header-text: white;
            --section-title-color: white;
            --btn-secondary-bg: #f5f5f5;
            --btn-secondary-text: #666;
            --btn-secondary-border: #ddd;
            --habit-border-width: 4px;
            --dropdown-bg: #ffffff;
            --dropdown-shadow: rgba(0, 0, 0, 0.15);
            --color-primary: #2196F3;
            --color-positive: #4CAF50;
            --color-negative: #f44336;
            --color-warning: #FF9800;
            --color-neutral: #607D8B;
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --card-bg: rgba(42, 42, 42, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.3);
            --text-color: #e0e0e0;
            --text-color-light: #aaa;
            --border-color: #444;
            --input-bg: #2a2a2a;
            --header-text: #e0e0e0;
            --section-title-color: #e0e0e0;
            --btn-secondary-bg: #3a3a3a;
            --btn-secondary-text: #e0e0e0;
            --btn-secondary-border: #555;
            --dropdown-bg: #3a3a3a;
            --dropdown-shadow: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            padding-bottom: 80px;
            /* [v3.7.9] 修复：禁止页面横向弹性滚动，防止“偏离中心”感 */
            overscroll-behavior-x: contain;
        }

        .header {
            text-align: center;
            padding: var(--space-xl);
            padding-bottom: 0;
            color: var(--header-text);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: var(--space-sm);
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Main Container for consistent padding */
        .main-container {
            padding: 0 var(--space-lg);
        }
        @media (min-width: 480px) {
            .main-container { padding: 0 var(--space-xl); }
        }

        .balance-card {
            margin-top: var(--space-lg);
            margin-bottom: var(--space-lg);
            background: var(--card-bg);
            border-radius: 15px;
            padding: var(--space-lg);
            text-align: center;
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
        }

        .balance-card.negative { background: rgba(255, 235, 238, 0.95); border-color: var(--color-negative); }
        [data-theme="dark"] .balance-card.negative { background: rgba(40, 20, 20, 0.95); }
        .balance-title { font-size: 0.9rem; color: var(--text-color-light); margin-bottom: var(--space-sm); }
        /* [v3.7.8] 优化：减小字号，防止小屏溢出 */
        .balance-amount { font-size: 2.2rem; font-weight: bold; margin-bottom: var(--space-lg); color: var(--color-primary); }
        .daily-changes { display: flex; justify-content: space-between; font-size: 0.8rem; }
        .daily-change { color: var(--text-color-light); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: var(--space-xl) 0 var(--space-lg) 0;
            color: var(--section-title-color);
        }

        /* 2.3. Fixed Grid Layout - 强制双列 */
        .recent-tasks-grid, .category-tasks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 强制双列 */
            gap: var(--space-md);
        }
        @media (min-width: 480px) {
            .recent-tasks-grid, .category-tasks-grid {
                gap: var(--space-lg);
            }
        }
        
        /* Task Card Styles */
        .task-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: var(--space-md);
            box-shadow: 0 4px 16px var(--card-shadow);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: visible;
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .task-card.is-habit::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: var(--habit-border-width); background-color: var(--habit-color, #ccc); }
        .task-card.is-habit { padding-left: calc(var(--space-md) + var(--habit-border-width)); }
        .task-row { display: flex; align-items: center; min-width: 0; }
        .task-row.title-row { justify-content: space-between; gap: var(--space-sm); margin-bottom: var(--space-xs); }
        
        .task-name { font-size: 0.9rem; font-weight: 600; flex: 1; word-wrap: break-word; white-space: normal; }
        @media (min-width: 1080px) { .task-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } }

        .task-details { font-size: 0.75rem; color: var(--text-color-light); display: flex; flex-wrap: wrap; align-items: center; gap: 6px; }
        .task-parameters { font-size: 0.8rem; color: var(--text-color-light); justify-content: flex-start; padding: 2px 0; }
        .task-category { color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500; }
        .task-completion-count { color: var(--color-positive); font-weight: 500; font-size: 0.7rem; }
        
        /* [v3.7.8] 修复：减小gap，防止按钮组撑宽卡片 */
        .task-actions { display: flex; gap: var(--space-xs); width: 100%; margin-top: var(--space-xs); }
        .task-btn { padding: 8px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; text-align: center; flex: 1; }
        .task-btn.wide { padding: 10px; }
        .task-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .task-btn.primary { background: var(--color-primary); color: white; } .task-btn.success { background: var(--color-positive); color: white; } .task-btn.warning { background: var(--color-warning); color: white; } .task-btn.danger { background: var(--color-negative); color: white; } .task-btn.secondary { background: #9E9E9E; color: white; }

        .task-timer-status { width: 100%; text-align: center; margin-top: var(--space-xs); }
        .task-timer { font-size: 0.9rem; font-weight: 600; color: var(--color-primary); }
        
        .more-btn { background: none; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; color: var(--text-color-light); padding: 0 4px; border-radius: 4px; flex-shrink: 0; line-height: 1; }
        .more-btn:hover { background: var(--btn-secondary-bg); color: var(--text-color); }
        .task-card-menu { display: none; position: absolute; top: 35px; right: 10px; background: var(--dropdown-bg); border-radius: 8px; box-shadow: 0 4px 12px var(--dropdown-shadow); z-index: 10; overflow: hidden; border: 1px solid var(--border-color); }
        .task-card-menu.show { display: block; }
        .task-card-menu-item { padding: 10px 15px; font-size: 0.85rem; color: var(--text-color); cursor: pointer; white-space: nowrap; }
        .task-card-menu-item:hover { background: rgba(0,0,0,0.05); }
        [data-theme="dark"] .task-card-menu-item:hover { background: rgba(255,255,255,0.1); }
        
        .category-tasks { margin-bottom: var(--space-xl); }
        .category-header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: var(--space-md) var(--space-lg); border-radius: 10px; margin-bottom: var(--space-md); cursor: pointer; }
        .category-header:hover { background: rgba(255, 255, 255, 1); }
        .category-info { display: flex; align-items: center; gap: var(--space-md); }
        .category-color { width: 12px; height: 12px; border-radius: 50%; }
        .category-name { font-weight: 600; font-size: 0.95rem; }
        .category-count { color: var(--text-color-light); font-size: 0.85rem; }
        .category-toggle { transition: transform 0.2s ease; font-size: 0.8rem; color: var(--text-color-light); }
        .category-header.collapsed .category-toggle { transform: rotate(-90deg); }
        .category-tasks-list { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease; }
        .category-tasks-list.collapsed { max-height: 0; }
        
        .empty-message { text-align: center; color: rgba(255, 255, 255, 0.7); font-style: italic; padding: 40px 20px; }
        [data-theme="dark"] .empty-message { color: rgba(255, 255, 255, 0.5); }
        
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--color-primary); color: white; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4); z-index: 1000; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6); }

        .bottom-tabs { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); display: flex; border-top: 1px solid rgba(0, 0, 0, 0.1); z-index: 1000; }
        .tab-button { flex: 1; padding: 12px 8px; border: none; background: none; text-align: center; cursor: pointer; font-size: 0.75rem; color: var(--text-color-light); }
        .tab-button.active { color: var(--color-primary); background: rgba(33, 150, 243, 0.1); }
        .tab-icon { font-size: 1.2rem; margin-bottom: var(--space-xs); }
        [data-theme="dark"] .bottom-tabs { background: var(--card-bg); border-top-color: var(--border-color); }
        [data-theme="dark"] .tab-button.active { background: rgba(33, 150, 243, 0.2); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        .modal.show { display: flex; align-items: center; justify-content: center; opacity: 1; }
        .modal-content { background: var(--input-bg); border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: var(--space-xl); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal.show .modal-content { transform: scale(1); }
        /* [v3.8.1] 禁止 Day Detail Modal 横向滚动 */
        #dayDetailModal .modal-content { overflow-x: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); }
        .modal-title { font-size: 1.2rem; font-weight: 600; color: var(--text-color); }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color-light); padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }

        .form-group { margin-bottom: var(--space-xl); }
        .form-label { display: block; margin-bottom: var(--space-sm); font-weight: 500; color: var(--text-color); }
        .form-input, .form-select { width: 100%; padding: var(--space-md); border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: var(--input-bg); color: var(--text-color); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--color-primary); }
        .form-input.error, .form-select.error { border-color: var(--color-negative); }
        .error-message { color: var(--color-negative); font-size: 0.85rem; margin-top: var(--space-sm); display: none; }
        .error-message.show { display: block; }
        .hidden { display: none !important; }

        .time-presets { display: flex; gap: var(--space-sm); margin-top: var(--space-sm); flex-wrap: wrap; }
        .time-preset { padding: 6px 12px; background: var(--btn-secondary-bg); border: 1px solid var(--btn-secondary-border); border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
        .time-preset:hover { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .recommendations { display: flex; gap: var(--space-sm); margin-top: var(--space-sm); flex-wrap: wrap; }
        .recommendation-item { padding: 4px 8px; background: #e3f2fd; border: 1px solid var(--color-primary); border-radius: 12px; font-size: 0.8rem; cursor: pointer; color: var(--color-primary); }
        .recommendation-item:hover { background: var(--color-primary); color: white; }
        [data-theme="dark"] .recommendation-item { background: rgba(33, 150, 243, 0.2); border-color: var(--color-primary); }

        .color-selector { display: grid; grid-template-columns: repeat(8, 1fr); gap: var(--space-sm); }
        .color-swatch { width: 100%; padding-bottom: 100%; border-radius: 50%; cursor: pointer; position: relative; border: 2px solid transparent; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: var(--color-primary); }
        .color-swatch.disabled { cursor: not-allowed; opacity: 0.3; }
        .color-swatch .checkmark { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1rem; }
        .color-swatch.selected .checkmark { display: block; }

        /* [v3.8.1] 修复：模态框按钮布局 */
        .form-buttons { display: flex; gap: var(--space-md); margin-top: var(--space-xxl); justify-content: flex-end; }
        .form-buttons .btn { flex: 0 0 auto; /* Remove flex: 1 */ white-space: nowrap; }
        .form-buttons .btn-secondary { margin-right: auto; /* Push cancel to the left */ }
        .btn { padding: var(--space-md); border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .btn-primary { background: var(--color-primary); color: white; } .btn-secondary { background: var(--btn-secondary-bg); color: var(--btn-secondary-text); } .btn-danger { background: var(--color-negative); color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        
        .habit-settings { border: 2px solid var(--color-primary); border-radius: 8px; padding: var(--space-lg); margin-top: var(--space-xl); background-color: rgba(33, 150, 243, 0.05); }
        [data-theme="dark"] .habit-settings { background-color: rgba(33, 150, 243, 0.1); }
        .habit-settings-title { font-size: 1rem; font-weight: 600; color: var(--color-primary); margin-bottom: var(--space-xl); }
        .habit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); }
        .habit-reward-rule { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: var(--space-md); align-items: center; padding: var(--space-md); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: var(--space-md); }
        .habit-reward-rule .form-input, .habit-reward-rule .form-select { padding: var(--space-sm); font-size: 0.9rem; }
        .remove-reward-btn { background: var(--color-negative); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold; }

        .report-section { background: var(--card-bg); border-radius: 12px; padding: var(--space-lg); margin-bottom: var(--space-xl); box-shadow: 0 4px 16px var(--card-shadow); }
        @media(min-width: 1441px) { .report-section { padding: var(--space-xl); } }

        .report-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md); margin-bottom: var(--space-lg); }
        .report-title { font-size: 1.1rem; font-weight: 600; color: var(--text-color); }
        /* [v3.8.0] 优化：允许筛选器组在必要时换行 */
        .report-filters { display: flex; gap: var(--space-sm); flex-wrap: wrap; }
        /* [v3.8.1] 优化：略微缩小字体和padding */
        /* [v3.7.9] 修复：将 'nowrap' 应用到所有筛选器按钮，包括 .analysis-view-switcher button */
        .report-filters button, .analysis-controls button, .analysis-view-switcher button { padding: 4px 8px; font-size: 0.75rem; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-color); border-radius: 6px; cursor: pointer; white-space: nowrap; }
        .report-filters button.active, .analysis-controls button.active, .analysis-view-switcher button.active { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }

        .flow-chart-container { display: flex; flex-direction: column; gap: var(--space-lg); }
        .flow-bar-wrapper { display: flex; align-items: center; gap: var(--space-md); }
        .flow-bar-label { font-size: 0.9rem; font-weight: 500; width: 60px; color: var(--text-color-light); }
        .flow-bar { flex: 1; display: flex; height: 24px; border-radius: 6px; overflow: hidden; background-color: var(--border-color); }
        .flow-bar-segment { height: 100%; position: relative; }
        .flow-bar-segment .tooltip { visibility: hidden; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; font-size: 0.8rem; white-space: nowrap; }
        .flow-bar-segment:hover .tooltip { visibility: visible; opacity: 1; }

        .heatmap-nav { display: flex; align-items: center; gap: var(--space-md); }
        .heatmap-nav button { background: none; border: 1px solid var(--border-color); color: var(--text-color); border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
        .heatmap-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
        .heatmap-month-label { font-size: 0.9rem; font-weight: 600; width: 100px; text-align: center; }
        .heatmap-grid-wrapper { margin-top: var(--space-lg); }
        .heatmap-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 0.7rem; text-align: center; margin-bottom: 5px; color: var(--text-color-light); }
        .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .heatmap-day, .heatmap-spacer { width: 100%; padding-bottom: 100%; position: relative; }
        .heatmap-day { cursor: pointer; }
        .heatmap-day-content { position: absolute; top:0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; background-color: var(--btn-secondary-bg); border-radius: 4px; }
        .heatmap-day:hover .heatmap-day-content { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 2; }
        
        .heatmap-day-content.net-surplus-1 { background-color: #9be9a8; } .heatmap-day-content.net-surplus-2 { background-color: #40c463; } .heatmap-day-content.net-surplus-3 { background-color: #216e39; color: white; }
        .heatmap-day-content.net-deficit-1 { background-color: #ffcdd2; } .heatmap-day-content.net-deficit-2 { background-color: #e57373; } .heatmap-day-content.net-deficit-3 { background-color: #f44336; color: white; }
        [data-theme="dark"] .heatmap-day-content.net-surplus-1 { background-color: #0e4429; } [data-theme="dark"] .heatmap-day-content.net-surplus-2 { background-color: #006d32; } [data-theme="dark"] .heatmap-day-content.net-surplus-3 { background-color: #26a641; }
        [data-theme="dark"] .heatmap-day-content.net-deficit-1 { background-color: #4a1e1e; } [data-theme="dark"] .heatmap-day-content.net-deficit-2 { background-color: #992e2e; } [data-theme="dark"] .heatmap-day-content.net-deficit-3 { background-color: #c93333; }
        
        .heatmap-legend { display: flex; justify-content: flex-end; align-items: center; gap: 5px; font-size: 0.75rem; color: var(--text-color-light); margin-top: var(--space-md); flex-wrap: wrap; }
        .legend-box { width: 12px; height: 12px; border-radius: 2px; }
        
        .analysis-table-container { max-height: 400px; overflow-y: auto; }
        .analysis-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .analysis-table th, .analysis-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .analysis-table th { font-weight: 600; user-select: none; }
        /* [v3.8.1] 新增：让表格时间段不换行 */
        .analysis-table td:nth-child(3) { /* Assuming amount is 3rd column */ white-space: nowrap; }
        .analysis-table td:nth-child(4) { /* Assuming amount is 4th column for task view */ white-space: nowrap; }
        .analysis-table td:nth-child(5) { /* Assuming avg_time is 5th column for task view */ white-space: nowrap; }
        .text-positive { color: var(--color-positive); font-weight: 500; } .text-negative { color: var(--color-negative); font-weight: 500; } .text-neutral { color: var(--color-neutral); font-weight: 500; }

        /* [v3.8.1] 新增：任务名称滚动样式 */
        .task-name-scrollable {
            display: block; 
            max-width: 80px; /* 根据 "逆水寒手游" 长度调整 */
            overflow-x: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: grab;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .task-name-scrollable::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Opera */
        }
        /* [v3.8.1] 允许触摸/悬停时滚动 */
        .task-name-scrollable:focus, 
        .task-name-scrollable:hover { 
            overflow-x: auto;
            text-overflow: clip; 
        }

        /* Report Stats Grid - 强制双列 */
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* 强制双列 */
            gap: var(--space-lg); 
            /* [v3.7.9] 修复：统一顶部边距，防止切换tab时跳动 */
            margin-top: var(--space-lg); 
            margin-bottom: var(--space-xl); 
        }
        
        /* [v3.7.9] 修复：添加 min-width: 0 解决网格内容溢出 */
        .stat-card { background: var(--card-bg); border-radius: 12px; padding: var(--space-lg); text-align: center; box-shadow: 0 4px 16px var(--card-shadow); min-width: 0; }
        /* [v3.8.0] 优化：再次调小字号，并移除 overflow，以满足“不允许省略”的需求 */
        .stat-value { font-size: 1.2rem; font-weight: bold; margin-bottom: var(--space-sm); white-space: nowrap; }
        #totalEarned.stat-value { color: var(--color-primary); } #totalSpent.stat-value { color: #E64A19; }
        .stat-label { font-size: 0.85rem; color: var(--text-color-light); }
        
        .settings-section { background: var(--card-bg); border-radius: 12px; padding: var(--space-xl); margin-bottom: var(--space-xl); box-shadow: 0 4px 16px var(--card-shadow); }
        .settings-title { font-size: 1.1rem; font-weight: 600; margin-bottom: var(--space-xl); color: var(--text-color); }
        
        /* [v3.7.6] Refactored Notification Settings Layout */
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg) 0; border-bottom: 1px solid var(--border-color); gap: var(--space-lg); }
        .setting-item:last-child { border-bottom: none; }
        .setting-info { flex: 1; min-width: 0; }
        .setting-name { font-weight: 500; margin-bottom: 2px; }
        .setting-desc { font-size: 0.85rem; color: var(--text-color-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .setting-controls { display: flex; align-items: center; gap: var(--space-md); }

        .theme-selector { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .theme-option { flex: 1; padding: 8px; text-align: center; background: none; border: none; cursor: pointer; font-size: 0.85rem; color: var(--text-color); border-left: 1px solid var(--border-color); }
        .theme-option:first-child { border-left: none; }
        .theme-option.active { background: var(--color-primary); color: white; }

        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        .threshold-input { width: 80px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; background-color: var(--input-bg); color: var(--text-color); }

        .data-buttons { display: flex; gap: var(--space-md); margin-top: var(--space-lg); justify-content: center; }
        .data-btn { flex: 1; padding: var(--space-md); border: 2px solid var(--color-primary); border-radius: 8px; background: white; color: var(--color-primary); font-size: 0.9rem; font-weight: 500; cursor: pointer; text-align: center; }
        .data-btn:hover { background: var(--color-primary); color: white; }
        [data-theme="dark"] .data-btn { background: var(--card-bg); color: var(--color-primary); }
        [data-theme="dark"] .data-btn:hover { background: var(--color-primary); color: white; }
        .file-input { display: none; }
        
        .about-section details { margin-top: var(--space-lg); border: 1px solid var(--border-color); border-radius: 8px; padding: var(--space-md) var(--space-lg); }
        .about-section summary { font-weight: 500; cursor: pointer; outline: none; }
        .about-section p { font-size: 0.9rem; line-height: 1.6; margin: var(--space-md) 0; color: var(--text-color-light); }
        .about-section ul { list-style-position: inside; padding-left: var(--space-md); }
        .about-section li { font-size: 0.9rem; margin-bottom: var(--space-sm); }
        .version-history-container { max-height: 300px; overflow-y: auto; padding-right: var(--space-md); }

        /* [v3.8.1] Day Detail Modal 样式 */
        .history-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: var(--space-md) 0; 
            border-bottom: 1px solid var(--border-color); 
            gap: var(--space-sm); 
        }
        .history-item:last-child { border-bottom: none; }
        .history-info { flex-grow: 1; min-width: 0; } /* Allow info to shrink */
        .history-description { font-weight: 500; margin-bottom: 2px; }
        .history-description .desc-line-1,
        .history-description .desc-line-2 {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; /* Ensure they take full width */
        }
        .history-description .desc-line-2 {
            font-size: 0.8rem;
            color: var(--text-color-light);
        }
        .history-time { font-size: 0.8rem; color: var(--text-color-light); }
        .history-amount-wrapper { flex-shrink: 0; width: 80px; text-align: right; } /* Fixed width for amount */
        .history-amount { font-weight: 600; font-size: 0.9rem; }
        .history-amount.positive { color: var(--color-positive); } 
        .history-amount.negative { color: var(--color-negative); }
        .undo-btn { background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border: 1px solid var(--btn-secondary-border); padding: 4px 8px; font-size: 0.75rem; border-radius: 5px; cursor: pointer; flex-shrink: 0; }
        .undo-btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .day-detail-summary { margin-bottom: var(--space-lg); padding-bottom: var(--space-lg); border-bottom: 1px solid var(--border-color); text-align: center; }
        .day-detail-net { font-size: 1.2rem; font-weight: bold; margin-bottom: var(--space-sm); }
        .day-detail-stats { font-size: 0.9rem; color: var(--text-color-light); }

        #analysisDashboard { display: flex; flex-direction: column; gap: var(--space-xl); }
        
        /* KPI Grid - 强制双列 */
        .kpi-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; /* 强制双列 */
            gap: var(--space-lg); 
        }

        .kpi-card { background: var(--card-bg); border-radius: 12px; padding: var(--space-lg); text-align: center; }
        .kpi-label { font-size: 0.8rem; color: var(--text-color-light); margin-bottom: var(--space-sm); }
        .kpi-value { font-size: 1.1rem; font-weight: 600; word-wrap: break-word; }
        .kpi-value.positive { color: var(--color-positive); } .kpi-value.negative { color: var(--color-negative); }
        /* [v3.8.0] 仅为时间值KPI添加不换行和省略号 */
        .kpi-value.kpi-time {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chart-container { background: var(--card-bg); border-radius: 12px; padding: var(--space-lg); }
        .chart-title { font-size: 0.95rem; font-weight: 600; text-align: center; margin-bottom: var(--space-lg); }

        .leaderboard-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-xl); }
        .leaderboard-chart { display: flex; flex-direction: column; gap: var(--space-sm); }
        /* [v3.7.9] 修复：添加 min-width: 0 解决网格内容溢出 */
        .leaderboard-item { display: grid; grid-template-columns: 70px 1fr; align-items: center; gap: var(--space-sm); font-size: 0.8rem; cursor: pointer; min-width: 0; }
        .leaderboard-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color-light); text-align: right;}
        .leaderboard-bar-wrapper { width: 100%; background: var(--border-color); border-radius: 4px; position: relative; }
        .leaderboard-bar { height: 18px; border-radius: 4px; position: relative; }
        .leaderboard-bar-value { position: absolute; top: 50%; transform: translateY(-50%); font-size: 0.7rem; font-weight: 500; }
        .leaderboard-bar-value.inside { right: 5px; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        /* [v3.7.9] 修复：移除错误的 'left' 属性，改由 JS 动态设置 */
        .leaderboard-bar-value.outside { color: var(--text-color); }
        .leaderboard-bar.earn { background-color: var(--color-positive); } .leaderboard-bar.spend { background-color: var(--color-negative); }

        .trend-chart-container { display: grid; grid-template-columns: 1fr; gap: var(--space-xl);}
        .trend-chart { width: 100%; display: flex; justify-content: space-between; gap: 2px; overflow: hidden; padding-bottom: var(--space-md); }
        .trend-day { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; background: var(--border-color); border-radius: 4px; position: relative; cursor: pointer; }
        .trend-day .tooltip { visibility: hidden; background-color: rgba(0,0,0,0.8); color: #fff; text-align: left; border-radius: 6px; padding: var(--space-sm); position: absolute; z-index: 10; bottom: 110%; left: 50%; transform: translateX(-50%); opacity: 0; font-size: 0.75rem; white-space: nowrap; pointer-events: none; }
        .trend-day:hover .tooltip { visibility: visible; opacity: 1; }
        .trend-segment { width: 100%; }
        .trend-date-label { font-size: 0.7rem; color: var(--text-color-light); text-align: center; margin-top: var(--space-xs); }
        
        /* [v3.7.9] 修复：还原 nowrap，并重构布局以实现左右对齐且不溢出 */
        .analysis-filters { 
            display: flex; 
            flex-wrap: nowrap; 
            justify-content: space-between; 
            align-items: center; 
            gap: var(--space-md); 
            margin-bottom: var(--space-md); 
        }
        /* [v3.7.9] 修复：使左侧容器可伸缩和换行，右侧容器固定 */
        .analysis-filters > div:first-child { flex: 1 1 auto; min-width: 0; display: flex; flex-wrap: wrap; gap: var(--space-sm); align-items: center; }
        .analysis-filters > div:last-child { flex: 0 0 auto; }
        
        .analysis-view-switcher { display: flex; gap: var(--space-sm); }
        
        .chart-legend { display: flex; flex-wrap: wrap; gap: var(--space-xs) var(--space-sm); margin-top: var(--space-md); }
        .legend-item { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.7rem; }
        .legend-color-box { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
        .legend-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #tableContainerWrapper { margin-top: var(--space-xl); }
    </style>
</head>
<body>
    <div class="header">
        <h1>时间银行</h1>
        <p>Time Bank v3.8.1</p>
    </div>

    <div class="main-container">

        <div class="balance-card" id="balanceCard">
            <div class="balance-title">当前余额</div>
            <div class="balance-amount" id="balanceAmount">0秒</div>
            <div class="daily-changes">
                <div class="daily-change">今日获得: <span id="dailyEarned">0秒</span></div>
                <div class="daily-change">今日消费: <span id="dailySpent">0秒</span></div>
            </div>
        </div>

        <div class="tab-content active" id="earnTab">
            <div class="recent-tasks">
                <div class="section-title">最近任务</div>
                <div id="recentEarnTasks" class="recent-tasks-grid"></div>
            </div>
            
            <div class="section-title">分类任务</div>
            <div id="categoryEarnTasks"></div>
        </div>

        <div class="tab-content" id="spendTab">
            <div class="recent-tasks">
                <div class="section-title">最近任务</div>
                <div id="recentSpendTasks" class="recent-tasks-grid"></div>
            </div>
            
            <div class="section-title">分类任务</div>
            <div id="categorySpendTasks"></div>
        </div>

        <div class="tab-content" id="reportTab">
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalEarned">0秒</div>
                    <div class="stat-label">总获得时间</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSpent">0秒</div>
                    <div class="stat-label">总消费时间</div>
                </div>
            </div>

            <div class="report-section">
                <div class="report-header">
                    <h2 class="report-title">时间流图</h2>
                    <div class="report-filters" id="flowChartFilters">
                        <button class="active" data-period="7d">7天内</button>
                        <button data-period="30d">30天内</button>
                        <button data-period="all">全部</button>
                    </div>
                </div>
                <div id="flowChartContainer" class="flow-chart-container"></div>
            </div>
            
            <div class="report-section">
                 <div class="report-header">
                    <h2 class="report-title">活动日历</h2>
                    <div class="heatmap-nav">
                        <button id="heatmapPrevMonth">&lt;</button>
                        <span id="heatmapMonthLabel"></span>
                        <button id="heatmapNextMonth">&gt;</button>
                    </div>
                </div>
                <div class="heatmap-grid-wrapper">
                    <div class="heatmap-weekdays">
                        <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                    </div>
                    <div id="heatmapGrid" class="heatmap-grid"></div>
                </div>
                <div class="heatmap-legend" id="heatmapLegend"></div>
            </div>

            <div class="report-section">
                <div class="report-header">
                    <h2 class="report-title">时间洞察仪表盘</h2>
                </div>
                <div class="analysis-filters" id="analysisDashboardFilters">
                    </div>
                <div id="analysisDashboard">
                    <div class="kpi-grid" id="kpiGrid"></div>
                    <div class="leaderboard-grid" id="leaderboardGrid"></div>
                </div>
            </div>

            <div class="report-section" id="trendChartWrapper">
                <div class="report-header">
                    <h2 class="report-title">趋势演变</h2>
                </div>
                <div id="trendChartContainerWrapper"></div>
            </div>

            <div class="report-section" id="tableWrapper">
                <div class="report-header">
                    <h2 class="report-title">详细数据</h2>
                </div>
                <div id="tableContainerWrapper"></div>
            </div>
        </div>

        <div class="tab-content" id="settingsTab">
            <div class="settings-section">
                <div class="settings-title">外观设置</div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">主题模式</div>
                        <div class="setting-desc">选择亮色、暗色或跟随系统</div>
                    </div>
                    <div class="setting-controls">
                        <div class="theme-selector">
                            <button class="theme-option" data-theme-value="light" onclick="setTheme('light')">亮色</button>
                            <button class="theme-option" data-theme-value="dark" onclick="setTheme('dark')">暗色</button>
                            <button class="theme-option" data-theme-value="system" onclick="setTheme('system')">系统</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">通知设置</div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">成就通知</div>
                        <div class="setting-desc">完成任务或达成目标时显示通知</div>
                    </div>
                    <div class="setting-controls">
                        <label class="switch">
                            <input type="checkbox" id="achievementNotificationToggle" onchange="toggleAchievementNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">长时间运行提醒</div>
                        <div class="setting-desc">任务运行超过设定时间时提醒</div>
                    </div>
                    <div class="setting-controls">
                        <input type="number" id="longRunningThreshold" class="threshold-input" 
                               value="3600" min="300" step="300" onchange="updateLongRunningThreshold()" 
                               placeholder="秒">
                        <label class="switch">
                            <input type="checkbox" id="longRunningNotificationToggle" onchange="toggleLongRunningNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">余额不足提醒</div>
                        <div class="setting-desc">余额低于设定值时提醒</div>
                    </div>
                    <div class="setting-controls">
                        <input type="number" id="lowBalanceThreshold" class="threshold-input" 
                               value="1800" min="0" step="300" onchange="updateLowBalanceThreshold()" 
                               placeholder="秒">
                        <label class="switch">
                            <input type="checkbox" id="lowBalanceNotificationToggle" onchange="toggleLowBalanceNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">数据管理</div>
                <div class="data-buttons">
                    <button class="data-btn" onclick="exportData()">导出数据</button>
                    <button class="data-btn" onclick="document.getElementById('importFile').click()">导入数据</button>
                    <button class="data-btn" onclick="clearAllData()">清空数据</button>
                </div>
                <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
            </div>
            
            <div class="settings-section about-section">
                <div class="settings-title">关于</div>
                 <div class="version-history-item">
                    <p><strong>版本 v3.8.1 (2025-10-17)</strong></p>
                    <ul>
                        <li><strong>[UI]</strong> 优化编辑任务模态框按钮布局，缩短文本为“保存”/“删除”，确保不换行且“保存”居右。</li>
                        <li><strong>[修复]</strong> 修复了任务卡片运行时，点击“更多”菜单会闪烁关闭的问题。</li>
                        <li><strong>[UI]</strong> 优化活动日历详情：描述限制为两行+省略号，时间右对齐且宽度固定，禁止模态框横向滚动。</li>
                        <li><strong>[UI]</strong> 进一步缩小“分类”/“任务”切换按钮字体，确保在小屏下单行显示。</li>
                        <li><strong>[功能]</strong> 重构详细数据表格（任务视图）：移除“分类”列，新增“平均时间”列及排序；限制任务名称宽度并允许局部滚动；确保时间值不换行。</li>
                    </ul>
                </div>
                 <div class="version-history-item">
                    <p><strong>版本 v3.8.0 (2025-10-17)</strong></p>
                    <ul>
                        <li><strong>[功能]</strong> 重构“详细数据”表格：删除“净值”列，合并“获得/消费”列，并为新列和“次数”列添加多状态排序功能。</li>
                        <li><strong>[UI/JS]</strong> 采纳用户方案，将“按分类”缩短为“分类”，“最近7天”缩短为“7天内”等，以解决筛选器栏在小屏幕上的重叠问题。</li>
                        <li><strong>[UI]</strong> 移除“总获得/消费”卡片的省略号，并微调字体，以满足“不允许省略”的需求。</li>
                        <li><strong>[UI/JS]</strong> 将“分钟”显示统一为“分”；为KPI卡片中的时间值添加不换行和省略号保护，同时允许“主要来源”等文本卡片换行。</li>
                    </ul>
                </div>
                 <div class="version-history-item">
                    <p><strong>版本 v3.7.9 (2025-10-17)</strong></p>
                    <ul>
                        <li><strong>[修复-根本性]</strong> 修复了报告页 `stats-grid` 和 `leaderboard-item` 因 `min-width: auto` 导致的网格内容溢出问题，彻底解决了页面横向滚动和卡片超出屏幕的问题。</li>
                        <li><strong>[修复]</strong> 修复了报告页筛选器栏在小屏上无法正确左右对齐的布局问题，并确保按钮组（如“按分类”）文本不再换行。</li>
                        <li><strong>[修复]</strong> 修复了排行榜值在进度条外部显示时，定位错误并导致页面溢出的问题。</li>
                        <li><strong>[修复]</strong> 修复了切换到“报告”标签页时，因顶部外边距不一致导致的页面垂直跳动问题。</li>
                        <li><strong>[优化]</strong> 为页面添加 `overscroll-behavior-x: contain`，禁止移动端横向弹性滚动，提升了页面的“固定感”。</li>
                    </ul>
                </div>
                 <div class="version-history-item">
                    <p><strong>版本 v3.7.8 (2025-10-17)</strong></p>
                    <ul>
                        <li><strong>[修复]</strong> 修正了在小屏幕上，报告页筛选器栏（`.analysis-filters`）因 `flex-wrap: nowrap` 导致页面横向溢出的问题，该问题也是导致底部导航栏不稳定的根源。</li>
                        <li><strong>[修复]</strong> 修复了报告页筛选器按钮（如“最近7天”）文本会换行的问题。</li>
                        <li><strong>[修复]</strong> 修复了任务卡片在开始计时后，按钮组（暂停/取消/结束）会撑宽卡片，导致布局跳动的问题。</li>
                        <li><strong>[优化]</strong> 适度减小了主页余额（`.balance-amount`）和报告页统计（`.stat-value`）的字号，以优化小屏显示。</li>
                    </ul>
                </div>
                 <div class="version-history-item">
                    <p><strong>版本 v3.7.7 (2025-10-16)</strong></p>
                    <ul>
                        <li><strong>[UI修复]</strong> 移除了所有关于“紧凑模式”、“标准模式”、“宽敞模式”的响应式代码和文字描述，统一为**固定标准布局**。</li>
                        <li><strong>[UI修复]</strong> 强制任务卡片、报告页总计统计卡片、KPI卡片在所有屏幕尺寸下都使用**双列**布局。</li>
                        <li><strong>[UI优化]</strong> 优化报告页筛选器栏的Flexbox布局，强制“按视图”和“按周期”筛选器**不换行**且**左右对齐**。</li>
                    </ul>
                </div>
                <details>
                    <summary>历史版本更新</summary>
                    <div class="version-history-container">
                        <div class="version-history-item">
                             <p><strong>版本 v3.7.6 (2025-10-16)</strong></p>
                             <ul>
                                <li><strong>[修复]</strong> 统一了所有页面的主内容边距，解决了余额卡片与下方任务列表边距不一致的问题。</li>
                                <li><strong>[修复]</strong> 增加了报告页各分析模块之间的标准间距，解决了组件堆叠过于紧凑的问题。</li>
                                <li><strong>[修复]</strong> 为报告页中缺失标题的“趋势演变”和“详细数据”模块补全了标题。</li>
                                <li><strong>[UI重构]</strong> 重新设计了“通知设置”的布局，使开关对齐、输入框尺寸合理，整体更美观。</li>
                                <li><strong>[UI优化]</strong> 根据规范，优化了设置页描述文本的显示方式，优先单行展示。</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                             <p><strong>版本 v3.7.5 (2025-10-16)</strong></p>
                             <ul>
                                <li><strong>[规范]</strong> 全面应用了《UI布局与响应式规范》，对整个应用的布局和间距进行了标准化重构。</li>
                                <li><strong>[修复]</strong> 修复了报告页“总获得/消费时间”在高分辨率下可能换行的问题，现已强制单行显示。</li>
                                <li><strong>[修复]</strong> 修复了报告页“时间洞察仪表盘”的KPI卡片在标准模式下变为单列的问题，现已恢复为规范的2列布局。</li>
                                <li><strong>[修复]</strong> 修复了报告页各处筛选器的对齐方式，现已遵循“分组对齐”规范。</li>
                                <li><strong>[优化]</strong> 根据规范，为不同屏幕宽度模式（紧凑、标准、宽敞）应用了更合适的间距和边距和边距，提升了整体视觉美感。</li>
                                <li><strong>[优化]</strong> 任务卡片名称现在会根据规范，在`1080px`宽度下自动在“换行”和“单行省略”之间切换。</li>
                            </ul>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </div> <button class="fab" id="fabButton" onclick="showTaskModal()">+</button>

    <div class="bottom-tabs">
        <button class="tab-button active" onclick="switchTab('earn')"> <div class="tab-icon">⏰</div> <div>获得时间</div> </button>
        <button class="tab-button" onclick="switchTab('spend')"> <div class="tab-icon">🎯</div> <div>消费时间</div> </button>
        <button class="tab-button" onclick="switchTab('report')"> <div class="tab-icon">📊</div> <div>报告</div> </button>
        <button class="tab-button" onclick="switchTab('settings')"> <div class="tab-icon">⚙️</div> <div>设置</div> </button>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">创建新任务</div>
                <button class="close-btn" onclick="hideTaskModal()">×</button>
            </div>
            <form id="taskForm" onsubmit="saveTask(event)">
                 <div class="form-group"> <label class="form-label">任务名称 *</label> <input type="text" id="taskName" class="form-input" placeholder="输入任务名称" required> <div class="error-message" id="taskNameError"></div> </div>
                 <div class="form-group"> <label class="form-label">任务类型 *</label> <select id="taskType" class="form-select" onchange="updateFormForTaskType()" required> <option value="">请选择任务类型</option> <option value="reward">固定奖励</option> <option value="continuous">持续奖励</option> <option value="continuous_target">达标奖励</option> <option value="instant_redeem">即时兑换</option> <option value="continuous_redeem">持续消耗</option> </select> <div class="error-message" id="taskTypeError"></div> </div>
                 <div class="form-group"> <label class="form-label">任务分类 *</label> <input type="text" id="taskCategory" class="form-input" placeholder="输入分类名称" required> <div class="recommendations" id="categoryRecommendations"></div> <div class="error-message" id="taskCategoryError"></div> </div>
                 <div class="form-group hidden" id="colorSelectorContainer"> <label class="form-label">分类颜色 (可选)</label> <div id="earnColorSelector" class="color-selector hidden"></div> <div id="spendColorSelector" class="color-selector hidden"></div> </div>
                 <div class="form-group hidden" id="fixedTimeGroup"> <label class="form-label" id="fixedTimeLabel">奖励时间 (秒) *</label> <input type="text" id="fixedTime" class="form-input" placeholder="例如：1800"> <div class="time-presets"> <div class="time-preset" onclick="setTimePreset('fixedTime', 900)">15分钟</div> <div class="time-preset" onclick="setTimePreset('fixedTime', 1800)">30分钟</div> <div class="time-preset" onclick="setTimePreset('fixedTime', 3600)">1小时</div> </div> <div class="error-message" id="fixedTimeError"></div> </div>
                 <div class="form-group hidden" id="consumeTimeGroup"> <label class="form-label">消费时间 (秒) *</label> <input type="text" id="consumeTime" class="form-input" placeholder="例如：1800"> <div class="time-presets"> <div class="time-preset" onclick="setTimePreset('consumeTime', 900)">15分钟</div> <div class="time-preset" onclick="setTimePreset('consumeTime', 1800)">30分钟</div> <div class="time-preset" onclick="setTimePreset('consumeTime', 3600)">1小时</div> </div> <div class="error-message" id="consumeTimeError"></div> </div>
                 <div class="form-group hidden" id="multiplierGroup"> <label class="form-label">时间倍率 *</label> <input type="text" id="multiplier" class="form-input" placeholder="例如：1.0"> <div class="error-message" id="multiplierError"></div> </div>
                 <div class="form-group hidden" id="targetTimeGroup"> <label class="form-label">目标时长 (秒) *</label> <input type="text" id="targetTime" class="form-input" placeholder="例如：3600"> <div class="time-presets"> <div class="time-preset" onclick="setTimePreset('targetTime', 3600)">1小时</div> <div class="time-preset" onclick="setTimePreset('targetTime', 7200)">2小时</div> </div> <div class="error-message" id="targetTimeError"></div> </div>
                 <div class="form-group hidden" id="bonusRewardGroup"> <label class="form-label">额外奖励 (秒)</label> <input type="text" id="bonusReward" class="form-input" placeholder="例如：1800，可不填"> <div class="time-presets"> <div class="time-preset" onclick="setTimePreset('bonusReward', 900)">15分钟</div> <div class="time-preset" onclick="setTimePreset('bonusReward', 1800)">30分钟</div> </div> <div class="error-message" id="bonusRewardError"></div> </div>
                 <div class="form-group hidden" id="habitToggleContainer"> <div class="setting-item" style="padding: 0; border: none;"> <div class="setting-info"> <div class="setting-name">设置为习惯</div> <div class="setting-desc">开启连续打卡和额外奖励</div> </div> <div class="setting-controls"><label class="switch"> <input type="checkbox" id="isHabitToggle" onchange="toggleHabitSettings()"> <span class="slider"></span> </label></div> </div> </div>
                 <div class="habit-settings hidden" id="habitSettingsGroup"> <div class="habit-settings-title">习惯设置</div> <div class="habit-grid"> <div class="form-group"> <label class="form-label">周期</label> <select id="habitPeriod" class="form-select"> <option value="daily">每天</option> <option value="weekly">每周</option> <option value="monthly">每月</option> </select> </div> <div class="form-group"> <label class="form-label">时长</label> <div style="display: flex; gap: 5px;"> <select id="habitDurationType" class="form-select" onchange="toggleHabitDurationInput()"> <option value="infinite">无限</option> <option value="days">持续天数</option> <option value="weeks">持续周数</option> </select> <input type="number" id="habitDurationValue" class="form-input hidden" placeholder="天数"> </div> </div> </div> <div class="form-group"> <label class="form-label">每日完成上限</label> <input type="number" id="habitDailyLimit" class="form-input" value="1" min="1"> </div> <div class="form-group"> <label class="form-label">习惯奖励 (可添加多个)</label> <div id="habitRewardsContainer"></div> <button type="button" class="btn btn-secondary" style="width: 100%; padding: 8px; margin-top: 10px;" onclick="addHabitRewardRule()">+ 添加奖励规则</button> </div> </div>
                 <div class="form-buttons"> 
                     <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">取消</button> 
                     <button type="button" class="btn btn-danger hidden" id="deleteBtn" onclick="deleteTask()">删除</button> 
                     <button type="submit" class="btn btn-primary" id="submitBtn">创建</button> 
                 </div>
            </form>
        </div>
    </div>

    <div class="modal" id="historyModal"> <div class="modal-content"> <div class="modal-header"> <div class="modal-title" id="historyModalTitle">任务历史</div> <button class="close-btn" onclick="hideHistoryModal()">×</button> </div> <div id="historyContent"></div> </div> </div>
    <div class="modal" id="dayDetailModal"> <div class="modal-content"> <div class="modal-header"> <div class="modal-title" id="dayDetailModalTitle">每日详情</div> <button class="close-btn" onclick="hideDayDetailModal()">×</button> </div> <div id="dayDetailContent"></div> </div> </div>

    <script>
        // [v3.8.1]
        const APP_VERSION = '3.8.1';
        let currentBalance = 0; let tasks = []; let transactions = []; let categoryColors = new Map(); let collapsedCategories = new Set(); let runningTasks = new Map(); let currentEditingTask = null; let timerInterval = null; let dailyChanges = {}; let currentHistoryTask = null; let currentSelectedColor = null;
        // [v3.8.0] 增加 tableSortKey 状态，默认为绝对值降序
        let reportState = { flowChartPeriod: '7d', heatmapDate: new Date(), analysisPeriod: 'all', analysisView: 'category', analysisItemFilter: null, trendPeriod: '30d', trendView: 'category', tablePeriod: 'all', tableView: 'category', tableSortKey: 'amount_abs_desc' };
        let notificationSettings = { achievement: true, longRunning: true, longRunningThreshold: 3600, lowBalance: true, lowBalanceThreshold: 1800 };
        const earnColors = [ '#007f5f', '#2b9348', '#55a630', '#80b918', '#aacc00', '#bfd200', '#d4d700', '#dddf00', '#eeef20', '#ffff3f', '#ade8f4', '#48cae4', '#00b4d8', '#0096c7', '#0077b6', '#023e8a' ];
        const spendColors = [ '#ffbe0b', '#fb5607', '#ff006e', '#8338ec', '#3a86ff', '#ef476f', '#f78c6b', '#ffd166', '#c9184a', '#ff4d6d', '#ff8fa3', '#ffb3c1', '#fca311', '#e85d04', '#dc2f02', '#9d0208' ];
        function initApp() { loadData(); renderColorSelectors(); updateAllUI(); updateNotificationSettingsUI(); startGlobalTimer(); if ('Notification' in window && notificationSettings.achievement && Notification.permission === 'default') { requestNotificationPermission(); } setupReportEventListeners(); }
        function startGlobalTimer() { if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => updateRunningTimers(), 1000); }
        function updateAllUI() { updateRecentTasks(); updateCategoryTasks(); updateBalance(); if(document.getElementById('reportTab').classList.contains('active')) { updateAllReports(); } }
        function switchTab(tabName) { document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active')); document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active')); document.getElementById(tabName + 'Tab').classList.add('active'); event.target.closest('.tab-button').classList.add('active'); document.getElementById('fabButton').style.display = (tabName === 'report' || tabName === 'settings') ? 'none' : 'block'; if (tabName === 'report') { reportState.heatmapDate = new Date(); updateAllReports(); } }
        function updateRecentTasks() { const earnTasks = tasks.filter(t => ['reward', 'continuous', 'continuous_target'].includes(t.type)); const spendTasks = tasks.filter(t => ['instant_redeem', 'continuous_redeem'].includes(t.type)); const sortByLastUsed = (taskList) => [...taskList].sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0)).slice(0, 6); renderTaskList('recentEarnTasks', sortByLastUsed(earnTasks)); renderTaskList('recentSpendTasks', sortByLastUsed(spendTasks)); }
        function updateCategoryTasks() { const earnTasks = tasks.filter(t => ['reward', 'continuous', 'continuous_target'].includes(t.type)); const spendTasks = tasks.filter(t => ['instant_redeem', 'continuous_redeem'].includes(t.type)); renderCategoryTasks('categoryEarnTasks', groupTasksByCategory(earnTasks)); renderCategoryTasks('categorySpendTasks', groupTasksByCategory(spendTasks)); }
        function groupTasksByCategory(taskList) { return taskList.reduce((acc, task) => { (acc[task.category] = acc[task.category] || []).push(task); return acc; }, {}); }
        function renderCategoryTasks(containerId, tasksByCategory) { const container = document.getElementById(containerId); if (Object.keys(tasksByCategory).length === 0) { container.innerHTML = `<div class="empty-message" style="color:var(--text-color-light)">暂无任务</div>`; return; } container.innerHTML = Object.entries(tasksByCategory).map(([category, categoryTasks]) => { const isCollapsed = collapsedCategories.has(category); const color = categoryColors.get(category) || '#666'; categoryTasks.sort((a, b) => (b.isHabit ? 1 : 0) - (a.isHabit ? 1 : 0)); return `<div class="category-tasks"><div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${category}')"><div class="category-info"><div class="category-color" style="background-color: ${color}"></div><div class="category-name">${category}</div><div class="category-count">(${categoryTasks.length})</div></div><div class="category-toggle">▼</div></div><div class="category-tasks-list ${isCollapsed ? 'collapsed' : ''}"><div class="category-tasks-grid">${renderTaskCards(categoryTasks)}</div></div></div>`; }).join(''); }
        function renderTaskList(containerId, taskList) { const container = document.getElementById(containerId); if (taskList.length === 0) { container.innerHTML = `<div class="empty-message" style="color:var(--text-color-light)">暂无最近任务</div>`; return; } container.innerHTML = renderTaskCards(taskList); }
        function renderTaskCards(taskList) { return taskList.map(task => { const runningTask = runningTasks.get(task.id); const isRunning = !!runningTask; const color = categoryColors.get(task.category) || '#666'; const habitClass = task.isHabit ? 'is-habit' : ''; const habitStyle = task.isHabit ? `style="--habit-color: ${color}"` : ''; const titleRow = `<div class="task-row title-row"><div class="task-name" title="${task.name}">${task.name}</div><button class="more-btn" onclick="toggleTaskMenu(event, '${task.id}')">...</button><div class="task-card-menu" id="menu-${task.id}"><div class="task-card-menu-item" onclick="editTask(tasks.find(t => t.id === '${task.id}'))">✏️ 编辑</div><div class="task-card-menu-item" onclick="showTaskHistory('${task.id}')">📋 历史</div></div></div>`; let statusDetails = `<span class="task-category" style="background-color: ${color}">${task.category}</span>`; if (task.isHabit) { const unitMap = { daily: '天', weekly: '周', monthly: '月' }; const streak = task.habitDetails.streak || 0; const periodText = unitMap[task.habitDetails.period] || '次'; statusDetails += ` <span class="task-completion-count">已连续 ${streak} ${periodText}</span>`; } else if ((task.completionCount || 0) > 0) { statusDetails += ` <span class="task-completion-count">已完成 ${task.completionCount} 次</span>`; } const statusRow = `<div class="task-row"><div class="task-details">${statusDetails}</div></div>`; let paramsText = ''; switch (task.type) { case 'reward': paramsText = `奖励: ${formatTime(task.fixedTime, false)}`; break; case 'continuous': paramsText = `${task.multiplier}倍率`; break; case 'continuous_target': paramsText = `${task.multiplier}倍率 • 目标 ${formatTime(task.targetTime, false).replace(/0秒$/, '').trim()}`; break; case 'instant_redeem': paramsText = `消费: ${formatTime(task.consumeTime, false)}`; break; case 'continuous_redeem': paramsText = `${task.multiplier}倍率消耗`; break; } const paramsRow = `<div class="task-row task-parameters">${paramsText}</div>`; let actionRow = ''; let timerRow = ''; if (isRunning) { const isPaused = runningTask.isPaused; const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000); const pauseResumeBtn = isPaused ? `<button class="task-btn primary" onclick="resumeTask('${task.id}')">继续</button>` : `<button class="task-btn warning" onclick="pauseTask('${task.id}')">暂停</button>`; actionRow = `<div class="task-row task-actions">${pauseResumeBtn}<button class="task-btn secondary" onclick="cancelTask('${task.id}')">取消</button><button class="task-btn danger" onclick="stopTask('${task.id}')">结束</button></div>`; let timerText = isPaused ? `已暂停：${formatTime(totalSeconds)}` : `运行中：${formatTime(totalSeconds)}`; if (task.type === 'continuous_target') { const progress = Math.min((totalSeconds / task.targetTime) * 100, 100); timerText += ` (${progress.toFixed(1)}%${runningTask.achieved ? ' ✅' : ''})`; } timerRow = `<div class="task-row task-timer-status"><div class="task-timer">${timerText}</div></div>`; } else { let actionButton = ''; switch (task.type) { case 'reward': actionButton = `<button class="task-btn success wide" onclick="completeTask('${task.id}')">完成</button>`; break; case 'instant_redeem': actionButton = `<button class="task-btn danger wide" onclick="redeemTask('${task.id}')">兑换</button>`; break; default: actionButton = `<button class="task-btn primary wide" onclick="startTask('${task.id}')">开始</button>`; break; } actionRow = `<div class="task-row task-actions">${actionButton}</div>`; } return `<div class="task-card ${habitClass}" ${habitStyle} data-task-id="${task.id}">${titleRow}${statusRow}${paramsRow}${actionRow}${timerRow}</div>`; }).join(''); }
        function toggleTaskMenu(event, taskId) { event.stopPropagation(); const allMenus = document.querySelectorAll('.task-card-menu'); const currentMenu = document.getElementById(`menu-${taskId}`); allMenus.forEach(menu => { if (menu.id !== `menu-${taskId}`) { menu.classList.remove('show'); } }); if (currentMenu) { currentMenu.classList.toggle('show'); } }
        document.addEventListener('click', (event) => { if (!event.target.closest('.task-card')) { document.querySelectorAll('.task-card-menu').forEach(menu => { menu.classList.remove('show'); }); } });
        
        // [v3.8.1] 优化：仅更新计时器文本，不重绘卡片
        function updateRunningTimers() { 
            let needsReportUpdate = false; // Flag if any timer actually ran
            runningTasks.forEach((runningTask, taskId) => { 
                if (runningTask.isPaused) return; 
                
                needsReportUpdate = true; // Mark that at least one timer is active
                const task = tasks.find(t => t.id === taskId); 
                if (task) { 
                    const totalSeconds = Math.floor((runningTask.elapsedTime + Date.now() - runningTask.startTime)) / 1000; 
                    
                    // Check target achievement
                    if (task.type === 'continuous_target' && !runningTask.achieved && totalSeconds >= task.targetTime) { 
                        runningTask.achieved = true; 
                        showNotification('🎯 达标提醒', `任务"${task.name}"已达到目标时间！`, 'achievement'); 
                    } 
                    
                    // Check long running notification
                    if (notificationSettings.longRunning && totalSeconds > 0 && totalSeconds % notificationSettings.longRunningThreshold === 0) { 
                        showNotification('⏰ 长时间运行提醒', `任务"${task.name}"已运行${formatTime(totalSeconds)}`, 'longRunning'); 
                    }

                    // Update timer text directly in DOM
                    const timerElement = document.querySelector(`.task-card[data-task-id="${taskId}"] .task-timer`);
                    if (timerElement) {
                        let timerText = `运行中：${formatTime(totalSeconds)}`;
                        if (task.type === 'continuous_target') {
                            const progress = Math.min((totalSeconds / task.targetTime) * 100, 100);
                            timerText += ` (${progress.toFixed(1)}%${runningTask.achieved ? ' ✅' : ''})`;
                        }
                        timerElement.textContent = timerText;
                    }
                } 
            }); 
            // If any timer ran, potentially update the daily balance in the header
            if (needsReportUpdate) {
                // We only need to update the balance if a timer *could* affect it,
                // but a simple periodic update is often easier. Let's update balance display.
                // updateBalance(); // Consider if this causes performance issues
            }
        } 

        function toggleCategory(category) { collapsedCategories.has(category) ? collapsedCategories.delete(category) : collapsedCategories.add(category); saveData(); updateCategoryTasks(); }
        function updateBalance() { const balanceCard = document.getElementById('balanceCard'); const balanceAmount = document.getElementById('balanceAmount'); balanceAmount.textContent = formatTime(currentBalance); balanceCard.classList.toggle('negative', currentBalance < 0); balanceAmount.style.color = currentBalance < 0 ? 'var(--color-negative)' : (currentBalance < notificationSettings.lowBalanceThreshold ? 'var(--color-warning)' : 'var(--color-primary)'); const todayChanges = dailyChanges[new Date().toDateString()] || { earned: 0, spent: 0 }; document.getElementById('dailyEarned').textContent = formatTime(todayChanges.earned); document.getElementById('dailySpent').textContent = formatTime(todayChanges.spent); if (notificationSettings.lowBalance && currentBalance >= 0 && currentBalance < notificationSettings.lowBalanceThreshold) { showNotification('⚠️ 余额不足', `当前余额仅剩 ${formatTime(currentBalance)}`, 'lowBalance'); } }
        
        // [v3.8.1] 优化：缩短按钮文本
        function showTaskModal() { currentEditingTask = null; currentSelectedColor = null; document.getElementById('modalTitle').textContent = '创建新任务'; document.getElementById('submitBtn').textContent = '创建'; document.getElementById('deleteBtn').classList.add('hidden'); document.getElementById('taskForm').reset(); updateFormForTaskType(); toggleHabitSettings(false); document.getElementById('habitRewardsContainer').innerHTML = ''; document.getElementById('taskModal').classList.add('show'); }
        function hideTaskModal() { document.getElementById('taskModal').classList.remove('show'); clearFormErrors(); }
        // [v3.8.1] 优化：缩短按钮文本
        function editTask(task) { currentEditingTask = task; currentSelectedColor = categoryColors.get(task.category); document.getElementById('modalTitle').textContent = '编辑任务'; document.getElementById('submitBtn').textContent = '保存'; document.getElementById('deleteBtn').classList.remove('hidden'); document.getElementById('deleteBtn').textContent = '删除'; /* Ensure delete button text is also short */ const form = document.getElementById('taskForm'); form.taskName.value = task.name; form.taskCategory.value = task.category; form.taskType.value = task.type; if (task.fixedTime) form.fixedTime.value = task.fixedTime; if (task.consumeTime) form.consumeTime.value = task.consumeTime; if (task.multiplier) form.multiplier.value = task.multiplier; if (task.targetTime) form.targetTime.value = task.targetTime; if (task.bonusReward) form.bonusReward.value = task.bonusReward; document.getElementById('isHabitToggle').checked = task.isHabit || false; if (task.isHabit && task.habitDetails) { document.getElementById('habitPeriod').value = task.habitDetails.period; document.getElementById('habitDurationType').value = task.habitDetails.duration.type; document.getElementById('habitDailyLimit').value = task.habitDetails.dailyLimit || 1; if (task.habitDetails.duration.type !== 'infinite') document.getElementById('habitDurationValue').value = task.habitDetails.duration.value; const rewardsContainer = document.getElementById('habitRewardsContainer'); rewardsContainer.innerHTML = ''; task.habitDetails.rewards.forEach(rule => addHabitRewardRule(rule)); } else { document.getElementById('habitRewardsContainer').innerHTML = ''; document.getElementById('habitDailyLimit').value = 1; } updateFormForTaskType(); toggleHabitSettings(task.isHabit); toggleHabitDurationInput(); document.getElementById('taskModal').classList.add('show'); }
        
        function deleteTask() { if (!currentEditingTask) return; if (confirm(`确定要删除任务"${currentEditingTask.name}"吗？`)) { runningTasks.delete(currentEditingTask.id); tasks = tasks.filter(t => t.id !== currentEditingTask.id); saveData(); updateAllUI(); hideTaskModal(); } }
        function updateFormForTaskType() { const taskType = document.getElementById('taskType').value; const earnTypes = ['reward', 'continuous', 'continuous_target']; const colorSelectorContainer = document.getElementById('colorSelectorContainer'); const earnColorSelector = document.getElementById('earnColorSelector'); const spendColorSelector = document.getElementById('spendColorSelector'); document.querySelectorAll('#taskForm .form-group[id$="Group"]').forEach(el => el.classList.add('hidden')); if (taskType) { colorSelectorContainer.classList.remove('hidden'); const isEarn = earnTypes.includes(taskType); earnColorSelector.classList.toggle('hidden', !isEarn); spendColorSelector.classList.toggle('hidden', isEarn); renderColorSelectors(currentEditingTask ? categoryColors.get(currentEditingTask.category) : null); } else { colorSelectorContainer.classList.add('hidden'); } const habitToggle = document.getElementById('habitToggleContainer'); if (earnTypes.includes(taskType)) habitToggle.classList.remove('hidden'); else { habitToggle.classList.add('hidden'); document.getElementById('isHabitToggle').checked = false; toggleHabitSettings(false); } switch (taskType) { case 'reward': document.getElementById('fixedTimeGroup').classList.remove('hidden'); break; case 'continuous': document.getElementById('multiplierGroup').classList.remove('hidden'); break; case 'continuous_target': ['multiplierGroup', 'targetTimeGroup', 'bonusRewardGroup'].forEach(id => document.getElementById(id).classList.remove('hidden')); break; case 'instant_redeem': document.getElementById('consumeTimeGroup').classList.remove('hidden'); break; case 'continuous_redeem': document.getElementById('multiplierGroup').classList.remove('hidden'); break; } updateCategoryRecommendations(taskType); }
        function toggleHabitSettings(forceState) { const isHabit = typeof forceState === 'boolean' ? forceState : document.getElementById('isHabitToggle').checked; document.getElementById('habitSettingsGroup').classList.toggle('hidden', !isHabit); const fixedTimeLabel = document.getElementById('fixedTimeLabel'); if(fixedTimeLabel) fixedTimeLabel.textContent = isHabit ? '基础奖励 (秒) *' : '奖励时间 (秒) *'; }
        function toggleHabitDurationInput() { const durationType = document.getElementById('habitDurationType').value; const valueInput = document.getElementById('habitDurationValue'); valueInput.classList.toggle('hidden', durationType === 'infinite'); valueInput.placeholder = durationType === 'days' ? '天数' : '周数'; }
        function addHabitRewardRule(rule = null) { const container = document.getElementById('habitRewardsContainer'); const ruleDiv = document.createElement('div'); ruleDiv.className = 'habit-reward-rule'; const type = rule ? rule.type : 'fixed'; const start = rule ? rule.start : 1; const value = rule ? rule.value : ''; ruleDiv.innerHTML = `<select class="form-select reward-type"><option value="fixed" ${type === 'fixed' ? 'selected' : ''}>固定奖励</option><option value="incremental" ${type === 'incremental' ? 'selected' : ''}>递增奖励</option></select><input type="number" class="form-input reward-start" placeholder="从第 N 周期" value="${start}" min="1"><input type="number" class="form-input reward-value" placeholder="奖励值(秒)" value="${value}"><button type="button" class="remove-reward-btn" onclick="this.parentElement.remove()">-</button>`; container.appendChild(ruleDiv); }
        function setTimePreset(fieldId, seconds) { document.getElementById(fieldId).value = seconds; }
        function saveTask(event) { event.preventDefault(); clearFormErrors(); const formData = { name: document.getElementById('taskName').value.trim(), category: document.getElementById('taskCategory').value.trim(), type: document.getElementById('taskType').value, isHabit: document.getElementById('isHabitToggle').checked }; let hasError = !formData.name || !formData.category || !formData.type; if (!formData.name) showFieldError('taskName', '请输入任务名称'); if (!formData.category) showFieldError('taskCategory', '请输入任务分类'); if (!formData.type) showFieldError('taskType', '请选择任务类型'); const parseAndValidate = (id, fieldName, isFloat = false) => { const input = document.getElementById(id); const value = isFloat ? parseFloat(input.value) : parseInt(input.value); if (isNaN(value) || value <= 0) { showFieldError(id, `请输入有效的${fieldName}`); hasError = true; } return value; }; const parseAndValidateOptional = (id, fieldName) => { const input = document.getElementById(id); if (!input.value) return 0; const value = parseInt(input.value); if (isNaN(value) || value < 0) { showFieldError(id, `请输入有效的${fieldName}`); hasError = true; } return value; }
        switch (formData.type) { case 'reward': formData.fixedTime = parseAndValidate('fixedTime', '奖励时间'); break; case 'instant_redeem': formData.consumeTime = parseAndValidate('consumeTime', '消费时间'); break; case 'continuous': case 'continuous_redeem': formData.multiplier = parseAndValidate('multiplier', '时间倍率', true); break; case 'continuous_target': formData.multiplier = parseAndValidate('multiplier', '时间倍率', true); formData.targetTime = parseAndValidate('targetTime', '目标时长'); formData.bonusReward = parseAndValidateOptional('bonusReward', '额外奖励'); break; }
        if (formData.isHabit) { const dailyLimit = parseInt(document.getElementById('habitDailyLimit').value); formData.habitDetails = { period: document.getElementById('habitPeriod').value, duration: { type: document.getElementById('habitDurationType').value, value: document.getElementById('habitDurationValue').value ? parseInt(document.getElementById('habitDurationValue').value) : 0 }, dailyLimit: isNaN(dailyLimit) || dailyLimit < 1 ? 1 : dailyLimit, rewards: [] }; if (formData.habitDetails.duration.type !== 'infinite' && formData.habitDetails.duration.value <= 0) { alert('请输入有效的持续时长'); hasError = true; } document.querySelectorAll('.habit-reward-rule').forEach(ruleEl => { const type = ruleEl.querySelector('.reward-type').value; const start = parseInt(ruleEl.querySelector('.reward-start').value); const value = parseInt(ruleEl.querySelector('.reward-value').value); if (!isNaN(start) && start > 0 && !isNaN(value) && value > 0) { formData.habitDetails.rewards.push({ type, start, value }); } else { alert('习惯奖励规则填写不完整或无效'); hasError = true; } }); }
        if (hasError) return; let colorToSet = currentSelectedColor; if (currentEditingTask) { const oldCategory = currentEditingTask.category; if (oldCategory !== formData.category) { if (categoryColors.has(formData.category)) { colorToSet = categoryColors.get(formData.category); } else if (!colorToSet) { colorToSet = getRandomAvailableColor(formData.type); } const oldCategoryInUse = tasks.some(t => t.id !== currentEditingTask.id && t.category === oldCategory); if (!oldCategoryInUse) categoryColors.delete(oldCategory); } } else { if (categoryColors.has(formData.category)) { colorToSet = categoryColors.get(formData.category); } else if (!colorToSet) { colorToSet = getRandomAvailableColor(formData.type); } }
        categoryColors.set(formData.category, colorToSet); if (currentEditingTask) { if (currentEditingTask.isHabit && !formData.isHabit) delete currentEditingTask.habitDetails; else if (!currentEditingTask.isHabit && formData.isHabit) { formData.habitDetails.streak = 0; formData.habitDetails.lastCompletionDate = null; } else if (currentEditingTask.isHabit && formData.isHabit) { formData.habitDetails.streak = currentEditingTask.habitDetails.streak; formData.habitDetails.lastCompletionDate = currentEditingTask.habitDetails.lastCompletionDate; } Object.assign(currentEditingTask, formData); } else { const newTask = { id: Date.now().toString(), ...formData, completionCount: 0, lastUsed: 0 }; if (newTask.isHabit) { newTask.habitDetails.streak = 0; newTask.habitDetails.lastCompletionDate = null; } tasks.push(newTask); }
        saveData(); updateAllUI(); hideTaskModal(); }
        function showFieldError(fieldId, message) { const field = document.getElementById(fieldId); const errorElement = document.getElementById(fieldId + 'Error'); field.classList.add('error'); errorElement.textContent = message; errorElement.classList.add('show'); }
        function clearFormErrors() { document.querySelectorAll('.form-input.error, .form-select.error').forEach(el => el.classList.remove('error')); document.querySelectorAll('.error-message.show').forEach(el => el.classList.remove('show')); }
        function completeTask(taskId) { const task = tasks.find(t => t.id === taskId); if (!task) return; task.lastUsed = Date.now(); if (task.isHabit) { const todayStr = getLocalDateString(new Date()); const completionsToday = transactions.filter(t => t.taskId === taskId && getLocalDateString(t.timestamp) === todayStr).length; if (completionsToday >= (task.habitDetails.dailyLimit || 1)) { alert('已达到此习惯的每日完成上限'); return; } processHabitCompletion(task, task.fixedTime); } else processNormalCompletion(task); saveData(); updateAllUI(); }
        function processNormalCompletion(task, earnedTime = task.fixedTime, descriptionDetails = '') { currentBalance += earnedTime; task.completionCount = (task.completionCount || 0) + 1; addTransaction({ type: 'earn', taskId: task.id, taskName: task.name, amount: earnedTime, description: `完成任务: ${task.name}${descriptionDetails}` }); updateDailyChanges('earned', earnedTime); showNotification('🎉 任务完成', `获得 ${formatTime(earnedTime)} 时间奖励！`, 'achievement'); }
        function processHabitCompletion(task, baseReward, descriptionDetails = '') { const todayStr = getLocalDateString(new Date()); const isNewPeriod = task.habitDetails.lastCompletionDate !== todayStr; let totalReward = baseReward; let bonusDescription = ''; if (isNewPeriod) { checkHabitStreak(task); task.habitDetails.streak = (task.habitDetails.streak || 0) + 1; task.habitDetails.lastCompletionDate = todayStr; let habitBonusReward = 0; task.habitDetails.rewards.forEach(rule => { if (task.habitDetails.streak >= rule.start) habitBonusReward += (rule.type === 'fixed') ? rule.value : (rule.value * task.habitDetails.streak); }); totalReward += habitBonusReward; if (habitBonusReward > 0) bonusDescription = ` (含习惯奖励 ${formatTime(habitBonusReward)})`; const unitMap = { daily: '天', weekly: '周', monthly: '月' }; const periodText = unitMap[task.habitDetails.period] || '次'; showNotification('⭐ 习惯已完成!', `连续${task.habitDetails.streak}${periodText}! 获得 ${formatTime(totalReward)} 时间`, 'achievement'); } else showNotification('👍 习惯重复完成', `获得基础奖励 ${formatTime(baseReward)}`, 'achievement'); currentBalance += totalReward; task.completionCount = (task.completionCount || 0) + 1; addTransaction({ type: 'earn', taskId: task.id, taskName: task.name, amount: totalReward, description: `完成习惯: ${task.name}${descriptionDetails}${bonusDescription}`, isStreakAdvancement: isNewPeriod }); updateDailyChanges('earned', totalReward); }
        function checkHabitStreak(task) { const { lastCompletionDate, period } = task.habitDetails; if (!lastCompletionDate) { task.habitDetails.streak = 0; return; } const today = new Date(); today.setHours(0, 0, 0, 0); const lastDate = new Date(lastCompletionDate); lastDate.setHours(0, 0, 0, 0); let isBroken = false; const diffDays = (today - lastDate) / 86400000; if (period === 'daily' && diffDays > 1) isBroken = true; else if (period === 'weekly') { const todayDay = today.getDay() === 0 ? 7 : today.getDay(); const startOfThisWeek = new Date(today.getTime() - (todayDay - 1) * 86400000); if (lastDate < startOfThisWeek && diffDays > 7) isBroken = true; } else if (period === 'monthly') { const isDifferentMonth = today.getFullYear() > lastDate.getFullYear() || today.getMonth() > lastDate.getMonth(); const isConsecutiveMonth = today.getFullYear() === lastDate.getFullYear() && today.getMonth() === lastDate.getMonth() + 1; if (isDifferentMonth && !isConsecutiveMonth) isBroken = true; } if (isBroken) { task.habitDetails.streak = 0; showNotification('❗ 习惯中断', `"${task.name}" 连续纪录已中断`, 'achievement'); } }
        function startTask(taskId) { runningTasks.set(taskId, { startTime: Date.now(), elapsedTime: 0, isPaused: false, achieved: false }); saveData(); updateRecentTasks(); updateCategoryTasks(); showNotification('▶️ 任务开始', `开始执行任务: ${tasks.find(t=>t.id===taskId).name}`, 'achievement'); }
        function pauseTask(taskId) { const r = runningTasks.get(taskId); if (!r || r.isPaused) return; r.elapsedTime += Date.now() - r.startTime; r.isPaused = true; saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function resumeTask(taskId) { const r = runningTasks.get(taskId); if (!r || !r.isPaused) return; r.startTime = Date.now(); r.isPaused = false; saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function cancelTask(taskId) { runningTasks.delete(taskId); saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function stopTask(taskId) { const task = tasks.find(t => t.id === taskId); const runningTask = runningTasks.get(taskId); if (!task || !runningTask) return; const totalSeconds = Math.floor((runningTask.elapsedTime + (runningTask.isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000); runningTasks.delete(taskId); task.lastUsed = Date.now(); if (totalSeconds > 0) { if (['continuous', 'continuous_target'].includes(task.type)) { let baseEarnedTime = Math.floor(totalSeconds * task.multiplier); let earnedTimeDescription = ` (${formatTime(totalSeconds)} × ${task.multiplier})`; const targetMet = task.type === 'continuous_target' && (runningTask.achieved || totalSeconds >= task.targetTime); if (targetMet) { baseEarnedTime += task.bonusReward; if (task.bonusReward > 0) earnedTimeDescription += ` + ${formatTime(task.bonusReward)} 达标奖励`; } const habitConditionMet = task.isHabit && (task.type === 'continuous' || targetMet); if (habitConditionMet) { const todayStr = getLocalDateString(new Date()); const completionsToday = transactions.filter(t => t.taskId === taskId && getLocalDateString(t.timestamp) === todayStr).length; if (completionsToday >= (task.habitDetails.dailyLimit || 1)) { alert('已达到此习惯的每日完成上限'); saveData(); updateAllUI(); return; } processHabitCompletion(task, baseEarnedTime, earnedTimeDescription); } else processNormalCompletion(task, baseEarnedTime, earnedTimeDescription); } else if (task.type === 'continuous_redeem') { const spentTime = Math.floor(totalSeconds * task.multiplier); currentBalance -= spentTime; task.completionCount = (task.completionCount || 0) + 1; addTransaction({ type: 'spend', taskId: task.id, taskName: task.name, amount: spentTime, description: `连续消费: ${task.name} (${formatTime(totalSeconds)} × ${task.multiplier})` }); updateDailyChanges('spent', spentTime); showNotification('💸 任务消费', `消费 ${formatTime(spentTime)} 时间`, 'achievement'); } } saveData(); updateAllUI(); }
        function redeemTask(taskId) { const task = tasks.find(t => t.id === taskId); if (!task) return; if (currentBalance < task.consumeTime) return alert('余额不足，无法兑换此项目'); if (!confirm(`确定要消费 ${formatTime(task.consumeTime)} 兑换"${task.name}"吗？`)) return; currentBalance -= task.consumeTime; task.completionCount = (task.completionCount || 0) + 1; task.lastUsed = Date.now(); addTransaction({ type: 'spend', taskId: task.id, taskName: task.name, amount: task.consumeTime, description: `兑换项目: ${task.name}` }); updateDailyChanges('spent', task.consumeTime); saveData(); updateAllUI(); showNotification('🎁 兑换成功', `成功兑换: ${task.name}`, 'achievement'); }
        function showTaskHistory(taskId) { const task = tasks.find(t => t.id === taskId); if (!task) return; currentHistoryTask = task; document.getElementById('historyModalTitle').textContent = `${task.name} - 历史记录`; const taskTransactions = transactions.filter(t => t.taskId === taskId).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); const historyContent = document.getElementById('historyContent'); if (taskTransactions.length === 0) historyContent.innerHTML = '<div class="empty-message">暂无历史记录</div>'; else { historyContent.innerHTML = taskTransactions.map(transaction => { const isPositive = transaction.type === 'earn'; return `<div class="history-item" id="history-item-${transaction.id}"><div class="history-info"><div class="history-description">${transaction.description}</div><div class="history-time">${formatDateTime(transaction.timestamp)}</div></div><div class="history-amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : '-'}${formatTime(transaction.amount)}</div><button class="undo-btn" onclick="undoTransaction('${transaction.id}')" title="撤回此条记录">撤回</button></div>`; }).join(''); } document.getElementById('historyModal').classList.add('show'); }
        function undoTransaction(transactionId) { const transactionIndex = transactions.findIndex(t => t.id === transactionId); if (transactionIndex === -1) return; const transaction = transactions[transactionIndex]; if (!confirm(`确定要撤回这条记录吗？\n\n描述: ${transaction.description}\n金额: ${transaction.type === 'earn' ? '+' : '-'}${formatTime(transaction.amount)}\n\n此操作将影响总余额、每日统计和任务完成次数，且无法恢复。`)) return; if (transaction.type === 'earn') { currentBalance -= transaction.amount; updateDailyChanges('earned', -transaction.amount, new Date(transaction.timestamp)); } else { currentBalance += transaction.amount; updateDailyChanges('spent', -transaction.amount, new Date(transaction.timestamp)); } const task = tasks.find(t => t.id === transaction.taskId); if (task) { if (task.completionCount > 0) task.completionCount--; if (task.isHabit && transaction.isStreakAdvancement) { const undoneDateStr = getLocalDateString(transaction.timestamp); if (task.habitDetails.lastCompletionDate === undoneDateStr) { if (task.habitDetails.streak > 0) task.habitDetails.streak--; const previousTransactions = transactions.filter(t => t.id !== transactionId && t.taskId === task.id && t.isStreakAdvancement).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); task.habitDetails.lastCompletionDate = previousTransactions.length > 0 ? getLocalDateString(previousTransactions[0].timestamp) : null; } } } transactions.splice(transactionIndex, 1); saveData(); updateAllUI(); const historyItemElement = document.getElementById(`history-item-${transactionId}`); if (historyItemElement) { historyItemElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease'; historyItemElement.style.opacity = '0'; historyItemElement.style.transform = 'translateX(20px)'; setTimeout(() => { historyItemElement.remove(); if (!document.getElementById('historyContent').querySelector('.history-item')) document.getElementById('historyContent').innerHTML = '<div class="empty-message">暂无历史记录</div>'; }, 300); } showNotification('↩️ 操作已撤回', `成功撤回记录: ${transaction.taskName}`, 'achievement'); }
        function hideHistoryModal() { document.getElementById('historyModal').classList.remove('show'); currentHistoryTask = null; }
        function addTransaction(transaction) { transaction.timestamp = new Date().toISOString(); transaction.id = Date.now().toString() + Math.random().toString(36).substr(2, 9); transactions.unshift(transaction); if (transactions.length > 1000) transactions.pop(); }
        function updateDailyChanges(type, amount, date = new Date()) { const dateString = date.toDateString(); if (!dailyChanges[dateString]) dailyChanges[dateString] = { earned: 0, spent: 0 }; dailyChanges[dateString][type] += amount; }
        function setupReportEventListeners() { document.getElementById('flowChartFilters').addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { reportState.flowChartPeriod = e.target.dataset.period; document.querySelectorAll('#flowChartFilters button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); updateFlowChart(); } }); document.getElementById('heatmapPrevMonth').addEventListener('click', () => navigateHeatmap(-1)); document.getElementById('heatmapNextMonth').addEventListener('click', () => navigateHeatmap(1)); }
        function updateSummaryStats() { const totalEarned = transactions.filter(t => t.type === 'earn').reduce((sum, t) => sum + t.amount, 0); const totalSpent = transactions.filter(t => t.type === 'spend').reduce((sum, t) => sum + t.amount, 0); document.getElementById('totalEarned').textContent = formatTime(totalEarned); document.getElementById('totalSpent').textContent = formatTime(totalSpent); }
        function updateAllReports() { updateSummaryStats(); updateFlowChart(); updateActivityHeatmap(); updateAnalysisDashboard(); updateTrendChart(); updateDetailedDataTable(); }
        function getFilteredTransactions(period) { let filtered = transactions.filter(t => !t.undone); if (period === 'all') return filtered; const now = new Date(); let startDate; if (period === '7d') startDate = new Date(new Date().setDate(now.getDate() - 7)); else if (period === '30d') startDate = new Date(new Date().setDate(now.getDate() - 30)); return filtered.filter(t => new Date(t.timestamp) >= startDate); }
        function updateFlowChart() { const filtered = getFilteredTransactions(reportState.flowChartPeriod); const container = document.getElementById('flowChartContainer'); if (filtered.length === 0) { container.innerHTML = '<div class="empty-message" style="color:var(--text-color-light)">此期间无数据</div>'; return; } const processData = (type) => { const data = new Map(); filtered.filter(t => t.type === type).forEach(t => { const task = tasks.find(tsk => tsk.id === t.taskId); const category = task ? task.category : '未知'; data.set(category, (data.get(category) || 0) + t.amount); }); const total = Array.from(data.values()).reduce((sum, val) => sum + val, 0); const sorted = Array.from(data.entries()).sort((a, b) => b[1] - a[1]); let segments = sorted.slice(0, 4).map(([category, amount]) => ({ category, amount, percent: total > 0 ? (amount / total) * 100 : 0 })); if (sorted.length > 4) { const otherAmount = sorted.slice(4).reduce((sum, [, amount]) => sum + amount, 0); segments.push({ category: '其它', amount: otherAmount, percent: total > 0 ? (otherAmount / total) * 100 : 0 }); } return { segments, total }; }; const { segments: earnedSegments, total: totalEarned } = processData('earn'); const { segments: spentSegments, total: totalSpent } = processData('spend'); const renderBar = (label, segments, total) => `<div class="flow-bar-wrapper"><div class="flow-bar-label">${label}<br><small>${formatTime(total)}</small></div><div class="flow-bar">${segments.map(s => `<div class="flow-bar-segment" style="width: ${s.percent}%; background-color: ${s.category === '其它' ? '#ccc' : (categoryColors.get(s.category) || '#888')};"><span class="tooltip">${s.category}: ${formatTime(s.amount)} (${s.percent.toFixed(1)}%)</span></div>`).join('')}</div></div>`; container.innerHTML = (totalEarned > 0 ? renderBar('获得', earnedSegments, totalEarned) : '') + (totalSpent > 0 ? renderBar('消费', spentSegments, totalSpent) : ''); }
        function navigateHeatmap(offset) { reportState.heatmapDate.setMonth(reportState.heatmapDate.getMonth() + offset); updateActivityHeatmap(); }
        function updateActivityHeatmap() { const container = document.getElementById('heatmapGrid'); const legendContainer = document.getElementById('heatmapLegend'); const label = document.getElementById('heatmapMonthLabel'); const dailyData = new Map(); transactions.filter(t => !t.undone).forEach(t => { const localDateStr = getLocalDateString(t.timestamp); if (!dailyData.has(localDateStr)) { dailyData.set(localDateStr, { earned: 0, spent: 0 }); } if (t.type) { const typeKey = t.type === 'earn' ? 'earned' : 'spent'; dailyData.get(localDateStr)[typeKey] += t.amount; } else { if (t.amount > 0) dailyData.get(localDateStr).earned += t.amount; else dailyData.get(localDateStr).spent += Math.abs(t.amount); } }); const year = reportState.heatmapDate.getFullYear(); const month = reportState.heatmapDate.getMonth(); label.textContent = `${year}年 ${month + 1}月`; const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); let html = ''; for(let i = 0; i < firstDayOfMonth; i++) { html += `<div class="heatmap-spacer"></div>`; } for (let day = 1; day <= daysInMonth; day++) { const currentDate = new Date(year, month, day); const localDateStr = getLocalDateString(currentDate); const data = dailyData.get(localDateStr); let colorClass = ''; if (data) { const net = data.earned - data.spent; colorClass = getHeatmapColorClass(net); } html += `<div class="heatmap-day" onclick="showDayDetails('${localDateStr}')"><div class="heatmap-day-content ${colorClass}">${day}</div></div>`; } container.innerHTML = html; const nextMonth = new Date(year, month + 1, 1); document.getElementById('heatmapNextMonth').disabled = nextMonth > new Date(); legendContainer.innerHTML = `赤字 <div class="legend-item"><div class="legend-box" style="background-color: #ffcdd2;"></div><div class="legend-box" style="background-color: #e57373;"></div><div class="legend-box" style="background-color: #f44336;"></div></div> | <div class="legend-item"><div class="legend-box" style="background-color: #9be9a8;"></div><div class="legend-box" style="background-color: #40c463;"></div><div class="legend-box" style="background-color: #216e39;"></div></div> 盈余`; }
        
        // [v3.8.1] 重构：优化 Day Detail 显示
        function showDayDetails(localDateStr) {
            const modal = document.getElementById('dayDetailModal');
            const title = document.getElementById('dayDetailModalTitle');
            const content = document.getElementById('dayDetailContent');
            title.textContent = `${localDateStr} 详情`;
            const dayTransactions = transactions
                .filter(t => !t.undone && getLocalDateString(t.timestamp) === localDateStr)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (dayTransactions.length === 0) {
                content.innerHTML = '<div class="empty-message">本日无活动记录</div>';
                modal.classList.add('show');
                return;
            }

            const dailyEarned = dayTransactions.reduce((sum, t) => sum + (t.type === 'earn' ? t.amount : (!t.type && t.amount > 0 ? t.amount : 0)), 0);
            const dailySpent = dayTransactions.reduce((sum, t) => sum + (t.type === 'spend' ? t.amount : (!t.type && t.amount < 0 ? Math.abs(t.amount) : 0)), 0);
            const dailyNet = dailyEarned - dailySpent;
            const netClass = dailyNet > 0 ? 'positive' : (dailyNet < 0 ? 'negative' : '');
            const netSign = dailyNet > 0 ? '+' : (dailyNet < 0 ? '' : '');

            let summaryHtml = `<div class="day-detail-summary">
                                <div class="day-detail-net ${netClass}">净值: ${netSign}${formatTime(dailyNet)}</div>
                                <div class="day-detail-stats">
                                    <span>获得: <span class="positive">${formatTime(dailyEarned)}</span></span> | 
                                    <span>消费: <span class="negative">${formatTime(dailySpent)}</span></span>
                                </div>
                            </div>`;

            let listHtml = dayTransactions.map(transaction => {
                const isPositive = transaction.type === 'earn' || (!transaction.type && transaction.amount > 0);
                const amount = Math.abs(transaction.amount);

                // 解析描述为两行
                let descLine1 = transaction.description;
                let descLine2 = '';
                const descMatch = transaction.description.match(/^([^:]+):\s*"?([^"(]+)"?(?:\s*\((.*)\))?$/);
                if (descMatch) {
                    descLine1 = descMatch[2].trim(); // Task name
                    descLine2 = descMatch[3] ? descMatch[3].trim() : ''; // Details in parentheses
                } else {
                    // Fallback if regex doesn't match
                    descLine1 = transaction.description;
                }

                return `<div class="history-item">
                            <div class="history-info" title="${transaction.description}">
                                <div class="history-description">
                                    <div class="desc-line-1">${descLine1}</div>
                                    <div class="desc-line-2">${descLine2}</div>
                                </div>
                                <div class="history-time">${new Date(transaction.timestamp).toLocaleTimeString('zh-CN')}</div>
                            </div>
                            <div class="history-amount-wrapper">
                                <div class="history-amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : '-'}${formatTime(amount)}</div>
                            </div>
                        </div>`;
            }).join('');

            content.innerHTML = summaryHtml + listHtml;
            modal.classList.add('show');
        }

        function hideDayDetailModal() { document.getElementById('dayDetailModal').classList.remove('show'); }
        
        // [v3.8.0] 新增：表格排序函数
        // [v3.8.1] 增加 avg_time 排序
        function setTableSort(key) {
            const currentSort = reportState.tableSortKey;
            if (key === 'amount') {
                if (currentSort === 'amount_desc') reportState.tableSortKey = 'amount_asc';
                else if (currentSort === 'amount_asc') reportState.tableSortKey = 'amount_abs_desc';
                else if (currentSort === 'amount_abs_desc') reportState.tableSortKey = 'amount_abs_asc';
                else if (currentSort === 'amount_abs_asc') reportState.tableSortKey = 'amount_desc';
                else reportState.tableSortKey = 'amount_desc'; // Default if coming from other keys
            } else if (key === 'count') {
                if (currentSort === 'count_desc') reportState.tableSortKey = 'count_asc';
                else reportState.tableSortKey = 'count_desc';
            } else if (key === 'avg_time') {
                 if (currentSort === 'avg_time_desc') reportState.tableSortKey = 'avg_time_asc';
                 else reportState.tableSortKey = 'avg_time_desc';
            }
            updateDetailedDataTable();
        }

        function updateAnalysisDashboard() { renderAnalysisFilters(); const filteredTransactions = getFilteredTransactions(reportState.analysisPeriod); const { aggregatedData } = processDashboardData(filteredTransactions, reportState.analysisView); let finalData = aggregatedData; if (reportState.analysisItemFilter) { finalData = aggregatedData.filter(item => item.name === reportState.analysisItemFilter); } renderKpiCards(filteredTransactions, finalData); renderLeaderboardCharts(aggregatedData); }
        function updateTrendChart() { const container = document.getElementById('trendChartContainerWrapper'); 
            // [v3.8.0] 缩短按钮文本
            const filtersHTML = `<div class="analysis-filters"> <div> <div class="analysis-view-switcher report-filters"> <button class="${reportState.trendView === 'category' ? 'active' : ''}" onclick="setTrendView('category')">分类</button> <button class="${reportState.trendView === 'task' ? 'active' : ''}" onclick="setTrendView('task')">任务</button> </div> </div> <div class="report-filters"> <button class="${reportState.trendPeriod === '7d' ? 'active' : ''}" onclick="setTrendPeriod('7d')">7天内</button> <button class="${reportState.trendPeriod === '30d' ? 'active' : ''}" onclick="setTrendPeriod('30d')">30天内</button> </div> </div>`; 
            const chartsHTML = `<div class="trend-chart-container" id="trendChartContainer"></div>`; container.innerHTML = filtersHTML + chartsHTML; const filteredTransactions = getFilteredTransactions(reportState.trendPeriod); const { aggregatedData, trendData } = processDashboardData(filteredTransactions, reportState.trendView); renderTrendCharts(trendData, aggregatedData); }
        function updateDetailedDataTable() { const container = document.getElementById('tableContainerWrapper'); 
            // [v3.8.0] 缩短按钮文本
            const filtersHTML = `<div class="analysis-filters"> <div> <div class="analysis-view-switcher report-filters"> <button class="${reportState.tableView === 'category' ? 'active' : ''}" onclick="setTableView('category')">分类</button> <button class="${reportState.tableView === 'task' ? 'active' : ''}" onclick="setTableView('task')">任务</button> </div> </div> <div class="report-filters"> <button class="${reportState.tablePeriod === '7d' ? 'active' : ''}" onclick="setTablePeriod('7d')">7天内</button> <button class="${reportState.tablePeriod === '30d' ? 'active' : ''}" onclick="setTablePeriod('30d')">30天内</button> <button class="${reportState.tablePeriod === 'all' ? 'active' : ''}" onclick="setTablePeriod('all')">全部</button> </div> </div>`; 
            const tableHTML = `<div class="analysis-table-container"> <table class="analysis-table" id="analysisTable"> <thead></thead> <tbody></tbody> </table> </div>`; container.innerHTML = filtersHTML + tableHTML; const filteredTransactions = getFilteredTransactions(reportState.tablePeriod); const { aggregatedData } = processDashboardData(filteredTransactions, reportState.tableView); 
            // [v3.8.1] 计算平均时间
            aggregatedData.forEach(row => {
                row.avgTime = row.count > 0 ? (row.earned + row.spent) / row.count : 0;
            });
            renderDetailedDataTable(aggregatedData); }
        function renderAnalysisFilters() { const container = document.getElementById('analysisDashboardFilters'); 
            // [v3.8.0] 缩短按钮文本
            let viewSwitcherHTML = `<div class="analysis-view-switcher report-filters"> <button class="${reportState.analysisView === 'category' ? 'active' : ''}" onclick="setAnalysisView('category')">分类</button> <button class="${reportState.analysisView === 'task' ? 'active' : ''}" onclick="setAnalysisView('task')">任务</button> </div>`; 
            let periodFilterHTML = `<div class="report-filters"> <button class="${reportState.analysisPeriod === '7d' ? 'active' : ''}" onclick="setAnalysisPeriod('7d')">7天内</button> <button class="${reportState.analysisPeriod === '30d' ? 'active' : ''}" onclick="setAnalysisPeriod('30d')">30天内</button> <button class="${reportState.analysisPeriod === 'all' ? 'active' : ''}" onclick="setAnalysisPeriod('all')">全部</button> </div>`; 
            let itemFilterHTML = ''; if (reportState.analysisItemFilter) { itemFilterHTML = `<button class="report-filters active" onclick="setAnalysisItemFilter(null)">当前筛选: ${reportState.analysisItemFilter} &times;</button>`; }
            /* [v3.7.9] 修复：为动态生成的 div 添加样式，以实现正确的 flex 布局 */
            const leftGroup = `<div>${viewSwitcherHTML} ${itemFilterHTML}</div>`; 
            const rightGroup = `<div>${periodFilterHTML}</div>`; 
            container.innerHTML = leftGroup + rightGroup; }
        function setAnalysisPeriod(period) { reportState.analysisPeriod = period; updateAnalysisDashboard(); }
        function setAnalysisView(view) { reportState.analysisView = view; reportState.analysisItemFilter = null; updateAnalysisDashboard(); }
        function setAnalysisItemFilter(name) { if (name === '其他') return; reportState.analysisItemFilter = name; updateAnalysisDashboard(); }
        function setTrendPeriod(period) { reportState.trendPeriod = period; updateTrendChart(); }
        function setTrendView(view) { reportState.trendView = view; updateTrendChart(); }
        function setTablePeriod(period) { reportState.tablePeriod = period; updateDetailedDataTable(); }
        function setTableView(view) { reportState.tableView = view; updateDetailedDataTable(); }
        function renderKpiCards(transactions, data) { const container = document.getElementById('kpiGrid'); if (transactions.length === 0) { container.innerHTML = ''; return; } const uniqueDays = new Set(transactions.map(t => getLocalDateString(t.timestamp))).size; const totalNet = data.reduce((sum, item) => sum + item.net, 0); const avgDailyNet = uniqueDays > 0 ? totalNet / uniqueDays : 0; const fullDataset = processDashboardData(transactions, reportState.analysisView).aggregatedData; const sortedByEarned = [...fullDataset].sort((a,b) => b.earned - a.earned); const sortedBySpent = [...fullDataset].sort((a,b) => b.spent - a.spent); const topEarner = sortedByEarned.length > 0 && sortedByEarned[0].earned > 0 ? sortedByEarned[0].name : '无'; const topSpender = sortedBySpent.length > 0 && sortedBySpent[0].spent > 0 ? sortedBySpent[0].name : '无'; let kpiLabel = "总净时间"; if (reportState.analysisPeriod === '7d') kpiLabel = "7日内净时间"; if (reportState.analysisPeriod === '30d') kpiLabel = "30日内净时间"; if (reportState.analysisItemFilter) kpiLabel = `"${reportState.analysisItemFilter}"净时间`; 
            // [v3.8.0] 为时间值KPI添加 'kpi-time' 类
            container.innerHTML = ` <div class="kpi-card"> <div class="kpi-label">平均每日净增</div> <div class="kpi-value kpi-time ${avgDailyNet >= 0 ? 'positive' : 'negative'}">${avgDailyNet >= 0 ? '+' : ''}${formatTime(avgDailyNet)}</div> </div> <div class="kpi-card"> <div class="kpi-label">${kpiLabel}</div> <div class="kpi-value kpi-time ${totalNet >= 0 ? 'positive' : 'negative'}">${totalNet >= 0 ? '+' : ''}${formatTime(totalNet)}</div> </div> ${reportState.analysisItemFilter ? '' : ` <div class="kpi-card"> <div class="kpi-label">主要时间来源</div> <div class="kpi-value positive">${topEarner}</div> </div> <div class="kpi-card"> <div class="kpi-label">主要时间去向</div> <div class="kpi-value negative">${topSpender}</div> </div>`} `; }
        function renderLeaderboardCharts(data) { const container = document.getElementById('leaderboardGrid'); const topN = reportState.analysisView === 'category' ? 3 : 5; const createChartHTML = (sourceData, type) => { const valueKey = type === 'earn' ? 'earned' : 'spent'; let chartData = sourceData.filter(d => d[valueKey] > 0).sort((a,b) => b[valueKey] - a[valueKey]); if (chartData.length > topN) { const othersValue = chartData.slice(topN).reduce((acc, item) => acc + item[valueKey], 0); chartData = chartData.slice(0, topN); if (othersValue > 0) chartData.push({ name: '其他', [valueKey]: othersValue }); } if (chartData.length === 0) return ''; const title = type === 'earn' ? '时间来源排行' : '时间去向排行'; const maxVal = chartData.length > 0 ? chartData[0][valueKey] : 0; const itemsHTML = chartData.map(item => { const value = item[valueKey]; const percent = maxVal > 0 ? (value / maxVal) * 100 : 0; const tempSpan = document.createElement('span'); tempSpan.style.fontSize = '0.7rem'; tempSpan.style.visibility = 'hidden'; tempSpan.style.position = 'absolute'; tempSpan.textContent = formatTime(value); document.body.appendChild(tempSpan); const textWidth = tempSpan.offsetWidth + 10; document.body.removeChild(tempSpan); const barWidth = (document.querySelector('.leaderboard-bar-wrapper')?.offsetWidth || 200) * (percent / 100); const isShortBar = textWidth > barWidth; const valueClass = isShortBar ? 'outside' : 'inside'; return ` <div class="leaderboard-item" ${item.name !== '其他' ? `onclick="setAnalysisItemFilter('${item.name}')"` : ''} title="${item.name}"> <div class="leaderboard-label">${item.name}</div> <div class="leaderboard-bar-wrapper"> <div class="leaderboard-bar ${type}" style="width: ${percent}%;"> ${!isShortBar ? `<span class="leaderboard-bar-value ${valueClass}">${formatTime(value)}</span>` : ''} </div> ${isShortBar ? `<span class="leaderboard-bar-value ${valueClass}" style="left: calc(${percent}% + 5px);">${formatTime(value)}</span>` : ''} </div> </div> `; }).join(''); return `<div class="chart-container">${title ? `<div class="chart-title">${title}</div>` : ''}<div class="leaderboard-chart">${itemsHTML}</div></div>`; }; container.innerHTML = createChartHTML(data, 'earn') + createChartHTML(data, 'spend'); }
        function renderTrendCharts(trendData, allAggregatedData) { const container = document.getElementById('trendChartContainer'); const topN = reportState.trendView === 'category' ? 3 : 5; const createChartHTML = (type) => { const valueKey = type === 'earned' ? 'earned' : 'spent'; const title = valueKey === 'earned' ? '获得时间趋势' : '消费时间趋势'; const dates = Object.keys(trendData).sort(); if (dates.length === 0) return ''; const topItems = new Set(allAggregatedData .filter(d => d[valueKey] > 0) .sort((a,b) => b[valueKey] - a[valueKey]) .slice(0, topN) .map(d => d.name)); if(topItems.size === 0 && !Object.values(trendData).some(d => Object.keys(d[type]).length > 0)) return `<div class="chart-container"><div class="chart-title">${title}</div><div class="empty-message" style="padding: 20px 0; color: var(--text-color-light);">无数据</div></div>`; const maxDailyTotal = Math.max(1, ...dates.map(date => { return Object.values(trendData[date][type]).reduce((sum, val) => sum + val, 0); })); const daysHTML = dates.map(date => { const dayData = trendData[date][type]; let dailyTotal = 0; let othersValue = 0; const segments = []; const tooltipEntries = {}; for(const name in dayData) { const value = dayData[name]; dailyTotal += value; tooltipEntries[name] = value; if (topItems.has(name)) { segments.push({ name, value }); } else { othersValue += value; } } if (othersValue > 0) { segments.push({ name: '其他', value: othersValue }); tooltipEntries['其他'] = othersValue; } const tooltipContent = Object.entries(tooltipEntries).sort((a,b)=>b[1]-a[1]).map(([name, value]) => `<div>${name}: ${formatTime(value)}</div>`).join(''); const segmentsHTML = segments.sort((a,b) => b.value - a.value).map(item => { const height = dailyTotal > 0 ? (item.value / dailyTotal) * 100 : 0; let color; if(item.name === '其他') { color = '#cccccc'; } else { color = reportState.trendView === 'category' ? categoryColors.get(item.name) : categoryColors.get(tasks.find(t => t.name === item.name)?.category); } return `<div class="trend-segment" style="height: ${height}%; background-color: ${color || '#ccc'}"></div>`; }).join(''); const totalHeight = maxDailyTotal > 0 ? (dailyTotal / maxDailyTotal) * 100 : 0; return `<div> <div class="trend-day" style="height: 150px;"> <div style="height:${totalHeight}%; width: 100%; display: flex; flex-direction: column; justify-content: flex-end; border-radius: 4px; overflow: hidden;"> ${segmentsHTML} </div> <span class="tooltip"><b>${date}</b><hr style="border-color: #555; margin: 4px 0;">${tooltipContent}<b>总计: ${formatTime(dailyTotal)}</b></span> </div> <div class="trend-date-label">${new Date(date).getDate()}</div> </div>`; }).join(''); const legendItems = allAggregatedData.filter(d => d[valueKey] > 0).sort((a,b) => b[valueKey] - a[b.value]); const topLegend = legendItems.slice(0, topN); if (legendItems.length > topN) topLegend.push({ name: '其他' }); const legendHTML = topLegend.map(item => { let color; if (item.name === '其他') { color = '#cccccc'; } else { color = reportState.trendView === 'category' ? categoryColors.get(item.name) : categoryColors.get(item.category); } return `<div class="legend-item" ${item.name !== '其他' ? `onclick="setAnalysisItemFilter('${item.name}')"`: ''}> <div class="legend-color-box" style="background-color:${color || '#ccc'};"></div> <div class="legend-label">${item.name}</div> </div>`; }).join(''); return ` <div class="chart-title">${title}</div> <div class="trend-chart">${daysHTML}</div> <div class="chart-legend">${legendHTML}</div> `; }; container.innerHTML = createChartHTML('earned') + createChartHTML('spent'); }
        
        // [v3.8.0] 重构：实现表格排序、合并列、删除列
        // [v3.8.1] 再次重构：移除分类（任务视图），增加平均时间+排序，任务名滚动
        function renderDetailedDataTable(data) {
            const table = document.getElementById('analysisTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            // [v3.8.0] 新增排序逻辑
            // [v3.8.1] 增加 avg_time 排序
            const sortKey = reportState.tableSortKey;
            const sortedData = [...data].sort((a, b) => {
                switch (sortKey) {
                    case 'amount_desc': return b.net - a.net;
                    case 'amount_asc': return a.net - b.net;
                    case 'amount_abs_desc': return Math.abs(b.net) - Math.abs(a.net);
                    case 'amount_abs_asc': return Math.abs(a.net) - Math.abs(b.net);
                    case 'count_desc': return b.count - a.count;
                    case 'count_asc': return a.count - b.count;
                    case 'avg_time_desc': return b.avgTime - a.avgTime;
                    case 'avg_time_asc': return a.avgTime - b.avgTime;
                    default: return Math.abs(b.net) - Math.abs(a.net); // Default to abs amount desc
                }
            });

            // [v3.8.0] 新增排序指示器
            // [v3.8.1] 增加 avg_time 指示器
            const getSortIndicator = (key) => {
                if (key === 'amount') {
                    if (sortKey === 'amount_desc') return ' ▼'; // Amount Desc
                    if (sortKey === 'amount_asc') return ' ▲'; // Amount Asc
                    if (sortKey === 'amount_abs_desc') return ' |▼|'; // Abs Amount Desc
                    if (sortKey === 'amount_abs_asc') return ' |▲|'; // Abs Amount Asc
                }
                if (key === 'count') {
                    if (sortKey === 'count_desc') return ' ▼'; // Count Desc
                    if (sortKey === 'count_asc') return ' ▲'; // Count Asc
                }
                 if (key === 'avg_time') {
                    if (sortKey === 'avg_time_desc') return ' ▼'; // Avg Time Desc
                    if (sortKey === 'avg_time_asc') return ' ▲'; // Avg Time Asc
                }
                return '';
            };

            // [v3.8.1] 根据视图确定表头
            const isTaskView = reportState.tableView === 'task';
            const headers = isTaskView 
                ? { name: '任务', amount: '获得/消费', avg_time: '平均时间', count: '次数' } 
                : { name: '分类', amount: '获得/消费', count: '次数' };
            
            const headerKeys = Object.keys(headers);
            thead.innerHTML = `<tr>${headerKeys.map(key => {
                const sortable = (key === 'amount' || key === 'count' || key === 'avg_time');
                const onClick = sortable ? `onclick="setTableSort('${key}')"` : '';
                return `<th ${onClick} style="${sortable ? 'cursor: pointer;' : ''}">${headers[key]}${getSortIndicator(key)}</th>`;
            }).join('')}</tr>`;

            // [v3.8.1] 新表体渲染
            tbody.innerHTML = sortedData.length > 0 ? sortedData.map(row => {
                let amountText, amountClass;
                if (row.net > 0) {
                    amountText = `+${formatTime(row.earned)}`;
                    amountClass = 'text-positive';
                } else if (row.net < 0) {
                    amountText = `-${formatTime(row.spent)}`;
                    amountClass = 'text-negative';
                } else {
                    amountText = formatTime(0);
                    amountClass = 'text-neutral';
                }

                const nameCell = `<td><div class="task-name-scrollable" tabindex="0">${row.name}</div></td>`;
                const amountCell = `<td class="${amountClass}" style="white-space: nowrap;">${amountText}</td>`;
                const countCell = `<td>${row.count}</td>`;
                const avgTimeCell = isTaskView ? `<td style="white-space: nowrap;">${formatTime(row.avgTime)}</td>` : '';

                if (isTaskView) {
                     return `<tr>${nameCell}${amountCell}${avgTimeCell}${countCell}</tr>`;
                } else {
                    return `<tr>${nameCell}${amountCell}${countCell}</tr>`;
                }
            }).join('') : `<tr><td colspan="${headerKeys.length}" class="empty-message" style="color:var(--text-color);">无匹配数据</td></tr>`;
        }

        function processDashboardData(transactionsToProcess, view) { const dataMap = new Map(); const trendData = {}; const getItemNameAndCategory = (t) => { const task = tasks.find(tsk => tsk.id === t.taskId); if (view === 'category') { return { name: task ? task.category : '未知', category: null }; } return { name: t.taskName || task?.name || '未知任务', category: task?.category }; }; transactionsToProcess.forEach(t => { const { name, category } = getItemNameAndCategory(t); if (!name) return; if (!dataMap.has(name)) { dataMap.set(name, { name, category, earned: 0, spent: 0, net: 0, count: 0 }); } const item = dataMap.get(name); const isEarn = t.type ? t.type === 'earn' : t.amount > 0; const amount = Math.abs(t.amount); if (isEarn) { item.earned += amount; item.net += amount; } else { item.spent += amount; item.net -= amount; } item.count++; const dateStr = getLocalDateString(t.timestamp); if (!trendData[dateStr]) trendData[dateStr] = { earned: {}, spent: {} }; const trendType = isEarn ? 'earned' : 'spent'; trendData[dateStr][trendType][name] = (trendData[dateStr][trendType][name] || 0) + amount; }); return { aggregatedData: Array.from(dataMap.values()), trendData }; }
        function getLocalDateString(date) { const d = new Date(date); const year = d.getFullYear(); const month = (d.getMonth() + 1).toString().padStart(2, '0'); const day = d.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getHeatmapColorClass(net) { if (net === 0) return ''; const absNet = Math.abs(net); if (net > 0) { if (absNet < 3600) return 'net-surplus-1'; if (absNet < 10800) return 'net-surplus-2'; return 'net-surplus-3'; } else { if (absNet < 3600) return 'net-deficit-1'; if (absNet < 10800) return 'net-deficit-2'; return 'net-deficit-3'; } }
        function updateCategoryRecommendations(taskType) { let relevantCategories = []; if (taskType) { const isEarnType = ['reward', 'continuous', 'continuous_target'].includes(taskType); const filteredTasks = tasks.filter(task => { const taskIsEarn = ['reward', 'continuous', 'continuous_target'].includes(task.type); return isEarnType === taskIsEarn; }); relevantCategories = [...new Set(filteredTasks.map(t => t.category))]; } else { relevantCategories = [...new Set(tasks.map(t => t.category))]; } document.getElementById('categoryRecommendations').innerHTML = relevantCategories.map(cat => `<div class="recommendation-item" onclick="selectCategory('${cat}')">${cat}</div>`).join(''); }
        function selectCategory(category) { document.getElementById('taskCategory').value = category; }
        
        // [v3.8.0] 优化："分钟" -> "分"
        function formatTime(seconds) { if (seconds === null || isNaN(seconds)) return '0秒'; if (seconds < 0) return '-' + formatTime(-seconds); if (seconds === 0) return '0秒'; seconds = Math.round(seconds); const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = seconds % 60; const parts = []; if (h > 0) parts.push(`${h}小时`); if (m > 0) parts.push(`${m}分`); if (h === 0 && s > 0) { parts.push(`${s}秒`); } return parts.length > 0 ? parts.join('') : '0秒'; }
        
        function formatDateTime(timestamp) { const d = new Date(timestamp), n = new Date(); const diff = (new Date(n.toDateString()) - new Date(d.toDateString())) / 86400000; if (diff === 0) return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); if (diff === 1) return '昨天 ' + d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); if (diff < 7) return `${diff}天前`; return d.toLocaleDateString('zh-CN'); }
        function requestNotificationPermission() { if ('Notification' in window) Notification.requestPermission(); }
        function showNotification(title, body, type) { if (!notificationSettings[type] || !('Notification' in window) || Notification.permission !== 'granted') return; new Notification(title, { body, icon: '/favicon.ico' }); }
        function toggleAchievementNotifications() { notificationSettings.achievement = document.getElementById('achievementNotificationToggle').checked; if (notificationSettings.achievement && Notification.permission === 'default') requestNotificationPermission(); saveData(); }
        function toggleLongRunningNotifications() { notificationSettings.longRunning = document.getElementById('longRunningNotificationToggle').checked; saveData(); }
        function updateLongRunningThreshold() { const v = parseInt(document.getElementById('longRunningThreshold').value); if (v >= 300) { notificationSettings.longRunningThreshold = v; saveData(); } }
        function toggleLowBalanceNotifications() { notificationSettings.lowBalance = document.getElementById('lowBalanceNotificationToggle').checked; saveData(); }
        function updateLowBalanceThreshold() { const v = parseInt(document.getElementById('lowBalanceThreshold').value); if (v >= 0) { notificationSettings.lowBalanceThreshold = v; saveData(); updateBalance(); } }
        function updateNotificationSettingsUI() { document.getElementById('achievementNotificationToggle').checked = notificationSettings.achievement; document.getElementById('longRunningNotificationToggle').checked = notificationSettings.longRunning; document.getElementById('longRunningThreshold').value = notificationSettings.longRunningThreshold; document.getElementById('lowBalanceNotificationToggle').checked = notificationSettings.lowBalance; document.getElementById('lowBalanceThreshold').value = notificationSettings.lowBalanceThreshold; }
        let systemThemeListener = null;
        function applyTheme(theme) { if (systemThemeListener) { window.matchMedia('(prefers-color-scheme: dark)').removeEventListener('change', systemThemeListener); systemThemeListener = null; } if (theme === 'system') { const p = window.matchMedia('(prefers-color-scheme: dark)').matches; document.body.setAttribute('data-theme', p ? 'dark' : 'light'); systemThemeListener = e => document.body.setAttribute('data-theme', e.matches ? 'dark' : 'light'); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', systemThemeListener); } else { document.body.setAttribute('data-theme', theme); } document.querySelectorAll('.theme-option').forEach(b => b.classList.toggle('active', b.dataset.themeValue === theme)); }
        function setTheme(theme) { applyTheme(theme); localStorage.setItem('themePreference', theme); }
        function exportData() { const migratedTransactions = transactions.map(t => { if (t.type) return t; const isEarn = t.amount > 0; const task = tasks.find(tsk => tsk.id === t.taskId); return { ...t, type: isEarn ? 'earn' : 'spend', amount: Math.abs(t.amount), taskName: t.taskName || (task ? task.name : '未知任务') }; }); const d = { version: APP_VERSION, currentBalance, tasks, transactions: migratedTransactions, categoryColors: [...categoryColors], collapsedCategories: [...collapsedCategories], dailyChanges, notificationSettings, reportState, /* [v3.8.1] Save reportState */ exportTime: new Date().toISOString() }; const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `timebank_backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(a.href); showNotification('📁 数据已导出', '所有历史数据已更新为最新格式。', 'achievement'); }
        function importData(event) { const f = event.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = function(e) { try { let d = JSON.parse(e.target.result); if (!d.version || !Array.isArray(d.tasks)) throw new Error('无效的数据格式'); if (!confirm('导入数据将覆盖当前所有数据，确定要继续吗？')) return; d = repairAndMigrateData(d); currentBalance = d.currentBalance || 0; tasks = d.tasks || []; transactions = d.transactions || []; categoryColors = new Map(d.categoryColors || []); collapsedCategories = new Set(d.collapsedCategories || []); dailyChanges = d.dailyChanges || {}; if (d.notificationSettings) notificationSettings = { ...notificationSettings, ...d.notificationSettings }; if (d.reportState) reportState = { ...reportState, ...d.reportState }; /* [v3.8.1] Load reportState */ runningTasks.clear(); saveData(); updateAllUI(); updateNotificationSettingsUI(); showNotification('📥 导入完成', '数据已成功导入并修复。', 'achievement'); } catch (error) { alert('导入失败：' + error.message); } }; r.readAsText(f); event.target.value = ''; }
        function clearAllData() { if (!confirm('确定要清空所有数据吗？此操作无法撤销！') || !confirm('最后确认：这将删除所有任务、交易记录和设置，确定要继续吗？')) return; localStorage.removeItem('timeBankData'); localStorage.removeItem('themePreference'); location.reload(); }
        // [v3.8.1] Save reportState
        function saveData() { const data = { version: APP_VERSION, currentBalance, tasks, transactions, categoryColors: [...categoryColors], collapsedCategories: [...collapsedCategories], runningTasks: [...runningTasks], dailyChanges, notificationSettings, reportState }; localStorage.setItem('timeBankData', JSON.stringify(data)); }
        function repairAndMigrateData(data) { if (!data.transactions || !Array.isArray(data.transactions) || !Array.isArray(data.tasks)) { return data; } let repairedCount = 0; const taskNameMap = new Map(data.tasks.map(task => [task.name, task.id])); data.transactions.forEach(t => { let needsUpdate = false; if (!t.taskId && t.description) { const match = t.description.match(/"([^"]+)"/); if (match && match[1]) { const taskNameInDesc = match[1]; if (taskNameMap.has(taskNameInDesc)) { t.taskId = taskNameMap.get(taskNameInDesc); if (!t.taskName) { t.taskName = taskNameInDesc; } repairedCount++; needsUpdate = true; } } } if (!t.type) { const isEarn = t.amount > 0; t.type = isEarn ? 'earn' : 'spend'; t.amount = Math.abs(t.amount); needsUpdate = true; } }); if (repairedCount > 0) { console.log(`[Data Repair] Successfully repaired ${repairedCount} transactions by adding missing task IDs.`); } return data; }
        function loadData() { try { const s = localStorage.getItem('timeBankData'); if (s) { let d = JSON.parse(s); let dataWasRepaired = false; const originalTransactions = JSON.stringify(d.transactions); d = repairAndMigrateData(d); if(JSON.stringify(d.transactions) !== originalTransactions) { dataWasRepaired = true; } 
            // [v3.8.1] Ensure reportState exists and has the new tableSortKey
            const defaultSortKey = 'amount_abs_desc';
            if (!d.reportState) {
                 d.reportState = { ...reportState, tableSortKey: defaultSortKey }; // Use current default state
             } else if (!d.reportState.tableSortKey) {
                 d.reportState.tableSortKey = defaultSortKey; // Add missing key
             }
            if (!d.version || d.version < APP_VERSION || dataWasRepaired) { d.version = APP_VERSION; saveData(); if (dataWasRepaired) console.log("Persisted repaired data to local storage."); } 
            currentBalance = d.currentBalance || 0; tasks = d.tasks || []; transactions = d.transactions || []; categoryColors = new Map(d.categoryColors || []); collapsedCategories = new Set(d.collapsedCategories || []); runningTasks = new Map(d.runningTasks || []); dailyChanges = d.dailyChanges || {}; 
            if (d.notificationSettings) notificationSettings = { ...notificationSettings, ...d.notificationSettings };
            // [v3.8.1] Load reportState, ensuring default values for potentially missing keys
             if (d.reportState) reportState = { ...reportState, ...d.reportState };
        } const t = localStorage.getItem('themePreference') || 'system'; setTheme(t); } catch (error) { console.error('加载数据失败:', error); } }
        function renderColorSelectors(editingColor = null) { const usedColors = Array.from(categoryColors.values()); const render = (containerId, colors) => { const container = document.getElementById(containerId); container.innerHTML = colors.map(color => { const isUsed = usedColors.includes(color); const isDisabled = isUsed && color !== editingColor; const isSelected = color === currentSelectedColor; return `<div class="color-swatch ${isDisabled ? 'disabled' : ''} ${isSelected ? 'selected' : ''}" style="background-color: ${color};" data-color="${color}"><span class="checkmark">✔</span></div>`; }).join(''); }; render('earnColorSelector', earnColors); render('spendColorSelector', spendColors); }
        function handleColorSelection(event) { const swatch = event.target.closest('.color-swatch'); if (!swatch || swatch.classList.contains('disabled')) return; currentSelectedColor = swatch.dataset.color; const selector = swatch.parentElement; selector.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected')); swatch.classList.add('selected'); }
        function getRandomAvailableColor(taskType) { const isEarn = ['reward', 'continuous', 'continuous_target'].includes(taskType); const colorPalette = isEarn ? earnColors : spendColors; const usedColors = new Set(Array.from(categoryColors.values())); const availableColors = colorPalette.filter(c => !usedColors.has(c)); if (availableColors.length > 0) { return availableColors[Math.floor(Math.random() * availableColors.length)]; } return colorPalette[Math.floor(Math.random() * colorPalette.length)]; }
        document.getElementById('earnColorSelector').addEventListener('click', handleColorSelection);
        document.getElementById('spendColorSelector').addEventListener('click', handleColorSelection);
        document.addEventListener('DOMContentLoaded', initApp);
        window.addEventListener('beforeunload', saveData);
        document.addEventListener('click', e => { if (e.target.classList.contains('modal')) { if (e.target.id === 'taskModal') hideTaskModal(); else if (e.target.id === 'historyModal') hideHistoryModal(); else if (e.target.id === 'dayDetailModal') hideDayDetailModal(); } });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { if (document.getElementById('taskModal').classList.contains('show')) hideTaskModal(); else if (document.getElementById('historyModal').classList.contains('show')) hideHistoryModal(); else if (document.getElementById('dayDetailModal').classList.contains('show')) hideDayDetailModal(); } else if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); showTaskModal(); } });
    </script>
</body>
</html>