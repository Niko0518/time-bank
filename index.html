<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´é“¶è¡Œ - Time Bank v2.8</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSSå˜é‡å®šä¹‰ - æ”¯æŒäº®è‰²å’Œæš—è‰²ä¸»é¢˜ */
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.1);
            --border-color: #eee;
            --input-bg: #f8f9fa;
            --header-text: white;
            --section-title-color: white;
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --text-color: #e0e0e0;
            --card-bg: rgba(45, 45, 45, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.3);
            --border-color: #444;
            --input-bg: #2a2a2a;
            --header-text: #e0e0e0;
            --section-title-color: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨æ ‡ç­¾æ ç•™å‡ºç©ºé—´ */
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            padding: 20px;
            color: var(--header-text);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .balance-card {
            margin: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .balance-card.negative {
            background: rgba(255, 235, 238, 0.95);
            border: 2px solid #f44336;
        }

        .balance-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .daily-changes {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .daily-change {
            color: #666;
        }

        /* æ ‡ç­¾é¡µ */
        .tab-content {
            display: none;
            padding: 0 20px;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 20px 0 15px 0;
            color: var(--section-title-color);
        }

        /* ä»»åŠ¡å¡ç‰‡ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .task-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 16px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .task-info {
            flex: 1;
            min-width: 0;
        }

        .task-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-name-text {
            flex: 1;
        }

        .task-edit-btn {
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            color: #666;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .task-edit-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .task-details {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        .task-category {
            background: #2196F3;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .task-completion-count {
            color: #4CAF50;
            font-weight: 500;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ–çš„æŒ‰é’®å¸ƒå±€ */
        .task-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
            flex-wrap: wrap;
            justify-content: flex-end;
            max-width: 50%;
        }

        .task-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 44px; /* ç¡®ä¿è§¦æ‘¸å‹å¥½çš„æœ€å°å°ºå¯¸ */
            text-align: center;
        }

        .task-btn.edit {
            background: #f5f5f5;
            color: #666;
            padding: 5px 8px;
            min-width: 36px;
        }

        .task-btn.primary {
            background: #2196F3;
            color: white;
        }

        .task-btn.success {
            background: #4CAF50;
            color: white;
        }

        .task-btn.warning {
            background: #FF9800;
            color: white;
        }

        .task-btn.danger {
            background: #f44336;
            color: white;
        }

        .task-btn.secondary {
            background: #9E9E9E;
            color: white;
        }

        .task-btn.info {
            background: #17a2b8;
            color: white;
        }

        .task-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .task-timer {
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2196F3;
        }

        .task-progress {
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
        }

        /* åˆ†ç±»ä»»åŠ¡ */
        .category-tasks {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-header:hover {
            background: rgba(255, 255, 255, 1);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .category-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .category-count {
            color: #666;
            font-size: 0.85rem;
        }

        .category-toggle {
            transition: transform 0.2s ease;
            font-size: 0.8rem;
            color: #666;
        }

        .category-header.collapsed .category-toggle {
            transform: rotate(-90deg);
        }

        .category-tasks-list {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-tasks-list.collapsed {
            max-height: 0;
        }

        /* æœ€è¿‘ä»»åŠ¡ */
        .recent-tasks {
            margin-bottom: 30px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            padding: 40px 20px;
        }

        /* æ‚¬æµ®æŒ‰é’® */
        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6);
        }

        /* åº•éƒ¨æ ‡ç­¾æ  */
        .bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            color: #666;
        }

        .tab-button.active {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .tab-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .form-input.error, .form-select.error {
            border-color: #f44336;
        }

        .error-message {
            color: #f44336;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        /* æ—¶é—´é¢„è®¾æŒ‰é’® */
        .time-presets {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .time-preset {
            padding: 6px 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-preset:hover {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        /* åˆ†ç±»æ¨è */
        .recommendations {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .recommendation-item {
            padding: 4px 8px;
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .recommendation-item:hover {
            background: #2196F3;
            color: white;
        }

        /* è¡¨å•æŒ‰é’® */
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* æŠ¥å‘Šé¡µé¢ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .transaction-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .transaction-time {
            font-size: 0.8rem;
            color: #666;
        }

        .transaction-amount {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .transaction-amount.positive {
            color: #4CAF50;
        }

        .transaction-amount.negative {
            color: #f44336;
        }

        /* è®¾ç½®é¡µé¢ */
        .settings-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .settings-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .setting-desc {
            font-size: 0.85rem;
            color: #666;
        }

        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .threshold-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        /* æ•°æ®ç®¡ç†æŒ‰é’® */
        .data-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .data-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            background: white;
            color: #2196F3;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .data-btn:hover {
            background: #2196F3;
            color: white;
        }

        .file-input {
            display: none;
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ä¼˜åŒ– */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .balance-amount {
                font-size: 2rem;
            }

            .balance-card {
                margin: 15px;
                padding: 15px;
            }

            .tab-content {
                padding: 0 15px;
            }

            /* ä»»åŠ¡å¡ç‰‡ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .task-card {
                padding: 12px;
                margin-bottom: 8px;
            }

            .task-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .task-actions {
                max-width: 100%;
                justify-content: flex-start;
                gap: 8px;
            }

            .task-btn {
                flex: 1;
                min-width: 0;
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .task-btn.edit {
                flex: 0 0 auto;
                min-width: 44px;
                padding: 8px;
            }

            /* å½“æŒ‰é’®è¶…è¿‡3ä¸ªæ—¶ï¼Œä½¿ç”¨ç½‘æ ¼å¸ƒå±€ */
            .task-actions.many-buttons {
                display: grid;
                grid-template-columns: auto 1fr 1fr;
                gap: 8px;
            }

            .task-actions.many-buttons .task-btn.edit {
                grid-row: 1 / 3;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }

            .form-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .data-buttons {
                flex-direction: column;
            }

            /* åº•éƒ¨æ ‡ç­¾æ ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .tab-button {
                padding: 10px 4px;
                font-size: 0.7rem;
            }

            .tab-icon {
                font-size: 1.1rem;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            .task-btn {
                font-size: 0.75rem;
                padding: 6px 8px;
            }

            .balance-amount {
                font-size: 1.8rem;
            }

            .header h1 {
                font-size: 1.3rem;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 10px;
            }

            .balance-card {
                margin: 10px;
                padding: 15px;
            }

            .balance-amount {
                font-size: 1.8rem;
            }

            .fab {
                bottom: 80px;
                right: 15px;
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }
        }

        /* ä»»åŠ¡å†å²æ¨¡æ€æ¡†æ ·å¼ */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            flex: 1;
        }

        .history-description {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .history-time {
            font-size: 0.8rem;
            color: #666;
        }

        .history-amount {
            font-weight: 600;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .history-amount.positive {
            color: #4CAF50;
        }

        .history-amount.negative {
            color: #f44336;
        }

        .undo-btn {
            padding: 4px 8px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .undo-btn:hover {
            background: #f57c00;
        }

        .undo-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ç®€æ´è®¾ç½®ç•Œé¢æ ·å¼ */
        .settings-section {
            margin-bottom: 25px;
        }

        .settings-row {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }

        .settings-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .settings-list {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item span {
            font-size: 0.9rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .settings-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-btn.primary {
            background: #4CAF50;
            color: white;
        }

        .settings-btn.primary-outline {
            background: transparent;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .settings-btn.danger {
            background: #f44336;
            color: white;
        }

        .settings-btn.danger-outline {
            background: transparent;
            color: #f44336;
            border: 1px solid #f44336;
        }

        .settings-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .settings-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.85rem;
            text-align: center;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .unit {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .file-input {
            display: none;
        }

        .version-info {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .version-text {
            margin-bottom: 10px;
        }

        .app-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .version-desc {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .version-features {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.8;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>æ—¶é—´é“¶è¡Œ v2.8</h1>
        <p>ç®¡ç†æ‚¨çš„æ—¶é—´ï¼Œç§¯ç´¯æ‚¨çš„è´¢å¯Œ</p>
    </div>

    <!-- ä½™é¢å¡ç‰‡ -->
    <div class="balance-card" id="balanceCard">
        <div class="balance-title">å½“å‰ä½™é¢</div>
        <div class="balance-amount" id="currentBalanceAmount">0ç§’</div>
        <div class="daily-changes">
            <div class="daily-change" id="yesterdayChange">æ˜¨æ—¥å˜åŒ–: +0åˆ†é’Ÿ</div>
            <div class="daily-change" id="todayChange">ä»Šæ—¥å˜åŒ–: +0åˆ†é’Ÿ</div>
        </div>
    </div>

    <!-- è·å¾—æ—¶é—´æ ‡ç­¾é¡µ -->
    <div class="tab-content active" id="earnTab">
        <!-- æœ€è¿‘ä»»åŠ¡ -->
        <div class="recent-tasks">
            <div class="section-title">æœ€è¿‘ä»»åŠ¡</div>
            <div id="recentEarnTasks"></div>
        </div>

        <!-- åˆ†ç±»ä»»åŠ¡ -->
        <div id="categoryEarnTasks"></div>
    </div>

    <!-- æ¶ˆè€—æ—¶é—´æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="spendTab">
        <!-- æœ€è¿‘ä»»åŠ¡ -->
        <div class="recent-tasks">
            <div class="section-title">æœ€è¿‘ä»»åŠ¡</div>
            <div id="recentSpendTasks"></div>
        </div>

        <!-- åˆ†ç±»ä»»åŠ¡ -->
        <div id="categorySpendTasks"></div>
    </div>

    <!-- æŠ¥å‘Šæ ‡ç­¾é¡µ -->
    <div class="tab-content" id="reportTab">
        <div class="section-title">æ•°æ®æ¦‚è§ˆ</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalEarned">0ç§’</div>
                <div class="stat-label">æ€»è·å¾—æ—¶é—´</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">0ç§’</div>
                <div class="stat-label">æ€»æ¶ˆè€—æ—¶é—´</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentBalance">0ç§’</div>
                <div class="stat-label">å½“å‰ä½™é¢</div>
            </div>
        </div>

        <div class="section-title">äº¤æ˜“å†å²</div>
        <div class="transaction-list" id="transactionList">
            <div class="empty-message">æš‚æ— äº¤æ˜“è®°å½•</div>
        </div>
    </div>

    <!-- è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="settingsTab">
        <!-- æ•°æ®ç®¡ç† -->
        <div class="settings-section">
            <div class="section-title">æ•°æ®ç®¡ç†</div>
            
            <div class="settings-row">
                <div class="settings-group">
                    <button class="settings-btn danger" onclick="clearTimeData()">æ¸…é™¤æ—¶é—´æ•°æ®</button>
                    <button class="settings-btn danger-outline" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
                </div>
                <div class="settings-group">
                    <button class="settings-btn primary" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                    <button class="settings-btn primary-outline" onclick="document.getElementById('importFile').click()">å¯¼å…¥æ•°æ®</button>
                    <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
                </div>
            </div>
        </div>

        <!-- ä¸»é¢˜è®¾ç½® -->
        <div class="settings-section">
            <div class="section-title">ä¸»é¢˜è®¾ç½®</div>
            
            <div class="settings-list">
                <div class="settings-item">
                    <span>å¤œé—´æ¨¡å¼</span>
                    <label class="toggle">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <span>è·Ÿéšç³»ç»Ÿä¸»é¢˜</span>
                    <label class="toggle">
                        <input type="checkbox" id="systemThemeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥è®¾ç½® -->
        <div class="settings-section">
            <div class="section-title">é€šçŸ¥è®¾ç½®</div>
            
            <div class="settings-list">
                <div class="settings-item">
                    <span>å¯ç”¨é€šçŸ¥</span>
                    <label class="toggle">
                        <input type="checkbox" id="notificationsEnabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <span>è¾¾æ ‡ä»»åŠ¡å®Œæˆé€šçŸ¥</span>
                    <label class="toggle">
                        <input type="checkbox" id="achievementNotification">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <span>é•¿æ—¶é—´è¿è¡Œæé†’</span>
                    <div class="settings-controls">
                        <label class="toggle">
                            <input type="checkbox" id="longRunningNotification">
                            <span class="toggle-slider"></span>
                        </label>
                        <input type="number" class="settings-input" id="longRunningThreshold" value="3600" min="300" step="300">
                        <span class="unit">ç§’</span>
                    </div>
                </div>
                
                <div class="settings-item">
                    <span>ä½™é¢ä¸è¶³é¢„è­¦</span>
                    <div class="settings-controls">
                        <label class="toggle">
                            <input type="checkbox" id="lowBalanceNotification">
                            <span class="toggle-slider"></span>
                        </label>
                        <input type="number" class="settings-input" id="lowBalanceThreshold" value="1800" min="300" step="300">
                        <span class="unit">ç§’</span>
                    </div>
                </div>
                
                <div class="settings-item">
                    <span>ä¸æ´»è·ƒä»»åŠ¡æé†’</span>
                    <div class="settings-controls">
                        <label class="toggle">
                            <input type="checkbox" id="inactiveTaskNotification">
                            <span class="toggle-slider"></span>
                        </label>
                        <input type="number" class="settings-input" id="inactiveTaskThreshold" value="86400" min="3600" step="3600">
                        <span class="unit">ç§’</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å…³äº -->
        <div class="settings-section">
            <div class="section-title">å…³äº</div>
            <div class="version-info">
                <div class="version-text">
                    <div class="app-title">æ—¶é—´é“¶è¡Œ v2.8</div>
                    <div class="version-desc">å¢å¼ºç‰ˆ - ç°ä»£åŒ–ç•Œé¢è®¾è®¡</div>
                </div>
                <div class="version-features">
                    è®¡æ—¶å™¨æŒä¹…åŒ– â€¢ ä»»åŠ¡å†å²æŸ¥çœ‹ â€¢ æ•°æ®æ¸…é™¤åŠŸèƒ½ â€¢ ç°ä»£åŒ–è®¾ç½®ç•Œé¢
                </div>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®åˆ›å»ºæŒ‰é’® -->
    <button class="fab" onclick="showTaskModal()" id="fabButton">+</button>

    <!-- åº•éƒ¨æ ‡ç­¾æ  -->
    <div class="bottom-tabs">
        <button class="tab-button active" onclick="switchTab('earn')">
            <div class="tab-icon">â¬†ï¸</div>
            <div>è·å¾—æ—¶é—´</div>
        </button>
        <button class="tab-button" onclick="switchTab('spend')">
            <div class="tab-icon">â¬‡ï¸</div>
            <div>æ¶ˆè€—æ—¶é—´</div>
        </button>
        <button class="tab-button" onclick="switchTab('report')">
            <div class="tab-icon">ğŸ“Š</div>
            <div>æŠ¥å‘Š</div>
        </button>
        <button class="tab-button" onclick="switchTab('settings')">
            <div class="tab-icon">âš™ï¸</div>
            <div>è®¾ç½®</div>
        </button>
    </div>

    <!-- ä»»åŠ¡åˆ›å»º/ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">åˆ›å»ºä»»åŠ¡</div>
                <button class="close-btn" onclick="hideTaskModal()">Ã—</button>
            </div>
            <form id="taskForm" onsubmit="submitTask(event)">
                <!-- ä»»åŠ¡åç§° -->
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡åç§° *</label>
                    <input type="text" id="taskName" class="form-input" placeholder="ä¾‹å¦‚ï¼šé˜…è¯»ã€è¿åŠ¨ã€å­¦ä¹ " required>
                    <div class="error-message" id="taskNameError"></div>
                </div>

                <!-- åˆ†ç±» -->
                <div class="form-group">
                    <label class="form-label">åˆ†ç±» *</label>
                    <input type="text" id="taskCategory" class="form-input" placeholder="ä¾‹å¦‚ï¼šå­¦ä¹ ã€å¥åº·ã€å¨±ä¹" required>
                    <div class="recommendations" id="categoryRecommendations">
                        <!-- å†å²åˆ†ç±»æ¨èå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="error-message" id="taskCategoryError"></div>
                </div>

                <!-- ä»»åŠ¡ç±»å‹ -->
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡ç±»å‹ *</label>
                    <select id="taskType" class="form-select" onchange="updateFormFields()" required>
                        <option value="">è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹</option>
                        <option value="reward">å¥–åŠ±ä»»åŠ¡ï¼ˆå®Œæˆè·å¾—å›ºå®šæ—¶é—´ï¼‰</option>
                        <option value="continuous">æŒç»­ä»»åŠ¡ï¼ˆè‡ªç”±ï¼‰ï¼ˆæŒ‰æ—¶é•¿è·å¾—æ—¶é—´ï¼‰</option>
                        <option value="continuous_target">æŒç»­ä»»åŠ¡ï¼ˆè¾¾æ ‡ï¼‰ï¼ˆè¾¾åˆ°ç›®æ ‡è·å¾—é¢å¤–å¥–åŠ±ï¼‰</option>
                        <option value="instant_redeem">å³æ—¶å…‘æ¢ï¼ˆæ¶ˆè€—å›ºå®šæ—¶é—´ï¼‰</option>
                        <option value="continuous_redeem">æŒç»­å…‘æ¢ï¼ˆæŒ‰æ—¶é•¿æ¶ˆè€—æ—¶é—´ï¼‰</option>
                    </select>
                    <div class="error-message" id="taskTypeError"></div>
                </div>

                <!-- å›ºå®šæ—¶é—´å­—æ®µï¼ˆå¥–åŠ±ä»»åŠ¡å’Œå³æ—¶å…‘æ¢ï¼‰ -->
                <div class="form-group hidden" id="fixedTimeGroup">
                    <label class="form-label">å›ºå®šæ—¶é—´ (ç§’) *</label>
                    <input type="text" id="fixedTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š3600ï¼ˆ1å°æ—¶ï¼‰">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 900)">15åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 1800)">30åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 3600)">1å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 7200)">2å°æ—¶</div>
                    </div>
                    <div class="error-message" id="fixedTimeError"></div>
                </div>

                <!-- æ—¶é—´å€ç‡å­—æ®µï¼ˆæŒç»­ä»»åŠ¡å’ŒæŒç»­å…‘æ¢ï¼‰ -->
                <div class="form-group hidden" id="multiplierGroup">
                    <label class="form-label">æ—¶é—´å€ç‡ *</label>
                    <input type="text" id="multiplier" class="form-input" placeholder="ä¾‹å¦‚ï¼š1.0ï¼ˆ1å€ï¼‰ã€1.5ï¼ˆ1.5å€ï¼‰">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setMultiplierPreset(0.5)">0.5å€</div>
                        <div class="time-preset" onclick="setMultiplierPreset(1.0)">1å€</div>
                        <div class="time-preset" onclick="setMultiplierPreset(1.5)">1.5å€</div>
                        <div class="time-preset" onclick="setMultiplierPreset(2.0)">2å€</div>
                    </div>
                    <div class="error-message" id="multiplierError"></div>
                </div>

                <!-- ç›®æ ‡æ—¶é•¿å­—æ®µï¼ˆè¾¾æ ‡ä»»åŠ¡ä¸“ç”¨ï¼‰ -->
                <div class="form-group hidden" id="targetTimeGroup">
                    <label class="form-label">ç›®æ ‡æ—¶é•¿ (ç§’) *</label>
                    <input type="text" id="targetTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š3600ï¼ˆ1å°æ—¶ï¼‰">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('targetTime', 1800)">30åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 3600)">1å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 5400)">1.5å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 7200)">2å°æ—¶</div>
                    </div>
                    <div class="error-message" id="targetTimeError"></div>
                </div>

                <!-- é¢å¤–å¥–åŠ±å­—æ®µï¼ˆè¾¾æ ‡ä»»åŠ¡ä¸“ç”¨ï¼‰ -->
                <div class="form-group hidden" id="bonusRewardGroup">
                    <label class="form-label">é¢å¤–å¥–åŠ± (ç§’) *</label>
                    <input type="text" id="bonusReward" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800ï¼ˆ30åˆ†é’Ÿï¼‰">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 900)">15åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 1800)">30åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 3600)">1å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 5400)">1.5å°æ—¶</div>
                    </div>
                    <div class="error-message" id="bonusRewardError"></div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">åˆ›å»ºä»»åŠ¡</button>
                    <button type="button" class="btn btn-danger hidden" id="deleteBtn" onclick="deleteTask()">åˆ é™¤ä»»åŠ¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ä»»åŠ¡å†å²æ¨¡æ€æ¡† -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="historyModalTitle">ä»»åŠ¡å†å²</div>
                <button class="close-btn" onclick="hideHistoryModal()">Ã—</button>
            </div>
            <div id="historyContent">
                <div class="empty-message">æš‚æ— å†å²è®°å½•</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentBalance = 0;
        let tasks = [];
        let transactions = [];
        let categoryColors = new Map();
        let collapsedCategories = new Set();
        let runningTasks = new Map(); // å­˜å‚¨è¿è¡Œä¸­çš„ä»»åŠ¡çŠ¶æ€
        let currentEditingTask = null;
        let timerInterval = null; // å…¨å±€è®¡æ—¶å™¨
        let dailyChanges = {}; // æ¯æ—¥å˜åŒ–è®°å½•
        let currentHistoryTask = null; // å½“å‰æŸ¥çœ‹å†å²çš„ä»»åŠ¡
        
        // é€šçŸ¥è®¾ç½®
        let notificationSettings = {
            enabled: false,
            achievement: true,
            longRunning: true,
            longRunningThreshold: 3600,
            lowBalance: true,
            lowBalanceThreshold: 1800,
            inactiveTask: false,
            inactiveTaskThreshold: 86400
        };

        // é¢œè‰²é…ç½®
        const colors = [
            '#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#F44336',
            '#00BCD4', '#8BC34A', '#FFC107', '#E91E63', '#607D8B',
            '#3F51B5', '#009688', '#CDDC39', '#795548', '#FF5722'
        ];

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            loadData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            updateCategoryRecommendations();
            updateNotificationSettings();
            
            // å¯åŠ¨å…¨å±€è®¡æ—¶å™¨
            startGlobalTimer();
            
            // è¯·æ±‚é€šçŸ¥æƒé™
            if ('Notification' in window && Notification.permission === 'default') {
                requestNotificationPermission();
            }
        }

        // å¯åŠ¨å…¨å±€è®¡æ—¶å™¨
        function startGlobalTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                updateRunningTimers();
            }, 1000);
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾æŒ‰é’®
            event.target.closest('.tab-button').classList.add('active');
            
            // æ ¹æ®æ ‡ç­¾é¡µæ›´æ–°æ‚¬æµ®æŒ‰é’®æ˜¾ç¤º
            const fabButton = document.getElementById('fabButton');
            if (tabName === 'report' || tabName === 'settings') {
                fabButton.style.display = 'none';
            } else {
                fabButton.style.display = 'block';
            }
        }

        // æ›´æ–°æœ€è¿‘ä»»åŠ¡ - ä¿®å¤æ’åºè§†è§‰è·³è·ƒé—®é¢˜
        function updateRecentTasks() {
            const earnTasks = tasks.filter(t => t.type === 'reward' || t.type === 'continuous' || t.type === 'continuous_target');
            const spendTasks = tasks.filter(t => t.type === 'instant_redeem' || t.type === 'continuous_redeem');
            
            // è·å–å½“å‰æ˜¾ç¤ºçš„ä»»åŠ¡é¡ºåºï¼ˆé¿å…é‡æ–°æ’åºå¯¼è‡´çš„è§†è§‰è·³è·ƒï¼‰
            const currentEarnOrder = getCurrentTaskOrder('recentEarnTasks');
            const currentSpendOrder = getCurrentTaskOrder('recentSpendTasks');
            
            // æŒ‰æœ€åä½¿ç”¨æ—¶é—´æ’åºï¼Œä½†ä¿æŒå½“å‰æ˜¾ç¤ºä»»åŠ¡çš„ç›¸å¯¹ä½ç½®
            const sortByLastUsedWithStability = (taskList, currentOrder) => {
                const sortedTasks = [...taskList].sort((a, b) => {
                    if (!a.lastUsed && !b.lastUsed) return 0;
                    if (!a.lastUsed) return 1;
                    if (!b.lastUsed) return -1;
                    return new Date(b.lastUsed) - new Date(a.lastUsed);
                });
                
                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„ä»»åŠ¡åœ¨æ–°æ’åºä¸­ä»ç„¶å­˜åœ¨ï¼Œä¿æŒå…¶ä½ç½®ç¨³å®š
                if (currentOrder.length > 0) {
                    const stableSorted = [];
                    const remaining = [...sortedTasks];
                    
                    // é¦–å…ˆä¿æŒå½“å‰æ˜¾ç¤ºä»»åŠ¡çš„é¡ºåº
                    currentOrder.forEach(taskId => {
                        const taskIndex = remaining.findIndex(t => t.id === taskId);
                        if (taskIndex !== -1) {
                            stableSorted.push(remaining.splice(taskIndex, 1)[0]);
                        }
                    });
                    
                    // ç„¶åæ·»åŠ æ–°çš„ä»»åŠ¡
                    stableSorted.push(...remaining);
                    
                    return stableSorted.slice(0, 3);
                }
                
                return sortedTasks.slice(0, 3);
            };
            
            const recentEarnTasks = sortByLastUsedWithStability(earnTasks, currentEarnOrder);
            const recentSpendTasks = sortByLastUsedWithStability(spendTasks, currentSpendOrder);
            
            renderTaskList('recentEarnTasks', recentEarnTasks);
            renderTaskList('recentSpendTasks', recentSpendTasks);
        }

        // è·å–å½“å‰ä»»åŠ¡æ˜¾ç¤ºé¡ºåº
        function getCurrentTaskOrder(containerId) {
            const container = document.getElementById(containerId);
            const taskCards = container.querySelectorAll('.task-card');
            const order = [];
            
            taskCards.forEach(card => {
                const editBtn = card.querySelector('.task-edit-btn, .task-btn.edit');
                if (editBtn && editBtn.onclick) {
                    const onclickStr = editBtn.onclick.toString();
                    const match = onclickStr.match(/t\.id === '([^']+)'/);
                    if (match) {
                        order.push(match[1]);
                    }
                }
            });
            
            return order;
        }

        // æ›´æ–°åˆ†ç±»ä»»åŠ¡
        function updateCategoryTasks() {
            const earnTasks = tasks.filter(t => t.type === 'reward' || t.type === 'continuous' || t.type === 'continuous_target');
            const spendTasks = tasks.filter(t => t.type === 'instant_redeem' || t.type === 'continuous_redeem');
            
            const earnTasksByCategory = groupTasksByCategory(earnTasks);
            const spendTasksByCategory = groupTasksByCategory(spendTasks);
            
            renderCategoryTasks('categoryEarnTasks', earnTasksByCategory);
            renderCategoryTasks('categorySpendTasks', spendTasksByCategory);
        }

        // æŒ‰åˆ†ç±»åˆ†ç»„ä»»åŠ¡
        function groupTasksByCategory(taskList) {
            const grouped = {};
            taskList.forEach(task => {
                if (!grouped[task.category]) {
                    grouped[task.category] = [];
                }
                grouped[task.category].push(task);
            });
            return grouped;
        }

        // æ¸²æŸ“åˆ†ç±»ä»»åŠ¡
        function renderCategoryTasks(containerId, tasksByCategory) {
            const container = document.getElementById(containerId);
            
            if (Object.keys(tasksByCategory).length === 0) {
                container.innerHTML = '<div class="empty-message">æš‚æ— ä»»åŠ¡</div>';
                return;
            }
            
            let html = '';
            Object.entries(tasksByCategory).forEach(([category, categoryTasks]) => {
                const isCollapsed = collapsedCategories.has(category);
                const color = categoryColors.get(category) || '#666';
                
                html += `
                    <div class="category-tasks">
                        <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${category}')">
                            <div class="category-info">
                                <div class="category-color" style="background-color: ${color}"></div>
                                <div class="category-name">${category}</div>
                                <div class="category-count">(${categoryTasks.length})</div>
                            </div>
                            <div class="category-toggle">â–¼</div>
                        </div>
                        <div class="category-tasks-list ${isCollapsed ? 'collapsed' : ''}">
                            ${renderTaskCards(categoryTasks)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTaskList(containerId, taskList) {
            const container = document.getElementById(containerId);
            
            if (taskList.length === 0) {
                container.innerHTML = '<div class="empty-message">æš‚æ— æœ€è¿‘ä»»åŠ¡</div>';
                return;
            }
            
            container.innerHTML = renderTaskCards(taskList);
        }

        // æ¸²æŸ“ä»»åŠ¡å¡ç‰‡ - æ”¹è¿›ç‰ˆæœ¬ï¼Œä¼˜åŒ–æŒ‰é’®å¸ƒå±€
        function renderTaskCards(taskList) {
            return taskList.map(task => {
                const runningTask = runningTasks.get(task.id);
                const isRunning = !!runningTask;
                const isPaused = runningTask && runningTask.isPaused;
                const color = categoryColors.get(task.category) || '#666';
                
                let detailsHtml = `<span class="task-category" style="background-color: ${color}">${task.category}</span>`;
                
                // æ˜¾ç¤ºå®Œæˆæ¬¡æ•°
                if (task.completionCount && task.completionCount > 0) {
                    detailsHtml += ` <span class="task-completion-count">å·²å®Œæˆ ${task.completionCount} æ¬¡</span>`;
                }
                
                let actionsHtml = '';
                let progressHtml = '';
                
                if (task.type === 'reward') {
                    detailsHtml += ` â€¢ å¥–åŠ± ${formatTime(task.fixedTime)}`;
                    actionsHtml = `
                        <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                        <button class="task-btn success" onclick="completeTask('${task.id}')">å®Œæˆ</button>
                    `;
                } else if (task.type === 'continuous') {
                    detailsHtml += ` â€¢ ${task.multiplier}å€ç‡`;
                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        if (isPaused) {
                            actionsHtml = `
                                <button class="task-btn primary" onclick="resumeTask('${task.id}')">ç»§ç»­</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `<div class="task-timer">å·²æš‚åœï¼š${formatTime(totalSeconds)}</div>`;
                        } else {
                            actionsHtml = `
                                <button class="task-btn warning" onclick="pauseTask('${task.id}')">æš‚åœ</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `<div class="task-timer">è¿è¡Œä¸­ï¼š${formatTime(totalSeconds)}</div>`;
                        }
                    } else {
                        actionsHtml = `
                            <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                            <button class="task-btn primary" onclick="startTask('${task.id}')">å¼€å§‹</button>
                        `;
                    }
                } else if (task.type === 'continuous_target') {
                    detailsHtml += ` â€¢ ${task.multiplier}å€ç‡ â€¢ ç›®æ ‡ ${formatTime(task.targetTime)}`;
                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        const progress = Math.min((totalSeconds / task.targetTime) * 100, 100);
                        if (isPaused) {
                            actionsHtml = `
                                <button class="task-btn primary" onclick="resumeTask('${task.id}')">ç»§ç»­</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `
                                <div class="task-timer">å·²æš‚åœï¼š${formatTime(totalSeconds)}</div>
                                <div class="task-progress">
                                    è¿›åº¦ï¼š${progress.toFixed(1)}% ${runningTask.achieved ? 'âœ… å·²è¾¾æ ‡' : ''}
                                </div>
                            `;
                        } else {
                            actionsHtml = `
                                <button class="task-btn warning" onclick="pauseTask('${task.id}')">æš‚åœ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `
                                <div class="task-timer">è¿è¡Œä¸­ï¼š${formatTime(totalSeconds)}</div>
                                <div class="task-progress">
                                    è¿›åº¦ï¼š${progress.toFixed(1)}% ${runningTask.achieved ? 'âœ… å·²è¾¾æ ‡' : ''}
                                </div>
                            `;
                        }
                    } else {
                        actionsHtml = `
                            <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                            <button class="task-btn primary" onclick="startTask('${task.id}')">å¼€å§‹</button>
                        `;
                        if (task.achieved) {
                            progressHtml = `<div class="task-progress">âœ… å·²è¾¾æ ‡</div>`;
                        }
                    }
                } else if (task.type === 'instant_redeem') {
                    detailsHtml += ` â€¢ æ¶ˆè€— ${formatTime(task.fixedTime)}`;
                    actionsHtml = `
                        <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                        <button class="task-btn danger" onclick="completeTask('${task.id}')">å…‘æ¢</button>
                    `;
                } else if (task.type === 'continuous_redeem') {
                    detailsHtml += ` â€¢ ${task.multiplier}å€ç‡`;
                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        if (isPaused) {
                            actionsHtml = `
                                <button class="task-btn primary" onclick="resumeTask('${task.id}')">ç»§ç»­</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `<div class="task-timer">å·²æš‚åœï¼š${formatTime(totalSeconds)}</div>`;
                        } else {
                            actionsHtml = `
                                <button class="task-btn warning" onclick="pauseTask('${task.id}')">æš‚åœ</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `<div class="task-timer">è¿è¡Œä¸­ï¼š${formatTime(totalSeconds)}</div>`;
                        }
                    } else {
                        actionsHtml = `
                            <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                            <button class="task-btn primary" onclick="startTask('${task.id}')">å¼€å§‹</button>
                        `;
                    }
                }
                
                return `
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-info">
                                <div class="task-name">
                                    <div class="task-name-text">${task.name}</div>
                                    <button class="task-edit-btn" onclick="showTaskModal(tasks.find(t => t.id === '${task.id}'))" title="ç¼–è¾‘">âœï¸</button>
                                </div>
                                <div class="task-details">${detailsHtml}</div>
                            </div>
                            <div class="task-actions">${actionsHtml}</div>
                        </div>
                        ${progressHtml}
                    </div>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºä»»åŠ¡å†å²
        function showTaskHistory(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentHistoryTask = task;
            
            const modal = document.getElementById('historyModal');
            const modalTitle = document.getElementById('historyModalTitle');
            const historyContent = document.getElementById('historyContent');
            
            modalTitle.textContent = `${task.name} - å†å²è®°å½•`;
            
            // è·å–è¯¥ä»»åŠ¡çš„æ‰€æœ‰äº¤æ˜“è®°å½•
            const taskTransactions = transactions.filter(t => 
                t.description.includes(`"${task.name}"`)
            );
            
            if (taskTransactions.length === 0) {
                historyContent.innerHTML = '<div class="empty-message">æš‚æ— å†å²è®°å½•</div>';
            } else {
                historyContent.innerHTML = taskTransactions.map(transaction => `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-description">${transaction.description}</div>
                            <div class="history-time">${formatDateTime(transaction.timestamp)}</div>
                        </div>
                        <div class="history-amount ${transaction.amount > 0 ? 'positive' : 'negative'}">
                            ${transaction.amount > 0 ? '+' : ''}${formatTime(Math.abs(transaction.amount))}
                        </div>
                        <button class="undo-btn" onclick="undoTransaction('${transaction.id}')" 
                                ${transaction.undone ? 'disabled' : ''}>
                            ${transaction.undone ? 'å·²æ’¤é”€' : 'æ’¤é”€'}
                        </button>
                    </div>
                `).join('');
            }
            
            modal.classList.add('show');
        }

        // éšè—ä»»åŠ¡å†å²æ¨¡æ€æ¡†
        function hideHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.remove('show');
            currentHistoryTask = null;
        }

        // æ’¤é”€äº¤æ˜“
        function undoTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction || transaction.undone) return;
            
            if (confirm('ç¡®å®šè¦æ’¤é”€è¿™æ¬¡æ“ä½œå—ï¼Ÿæ—¶é—´å°†è¢«å½’è¿˜åˆ°ä½™é¢ä¸­ã€‚')) {
                // æ ‡è®°äº¤æ˜“ä¸ºå·²æ’¤é”€
                transaction.undone = true;
                
                // å½’è¿˜æ—¶é—´åˆ°ä½™é¢
                currentBalance -= transaction.amount;
                
                // æ·»åŠ æ’¤é”€è®°å½•
                addTransaction(`æ’¤é”€æ“ä½œï¼š${transaction.description}`, -transaction.amount);
                
                // å‡å°‘ä»»åŠ¡å®Œæˆæ¬¡æ•°
                if (currentHistoryTask) {
                    currentHistoryTask.completionCount = Math.max(0, (currentHistoryTask.completionCount || 1) - 1);
                }
                
                saveData();
                updateBalance();
                updateRecentTasks();
                updateCategoryTasks();
                updateReports();
                
                // åˆ·æ–°å†å²æ˜¾ç¤º
                showTaskHistory(currentHistoryTask.id);
            }
        }

        // åˆ‡æ¢åˆ†ç±»æŠ˜å çŠ¶æ€
        function toggleCategory(category) {
            if (collapsedCategories.has(category)) {
                collapsedCategories.delete(category);
            } else {
                collapsedCategories.add(category);
            }
            updateCategoryTasks();
            saveData();
        }

        // æ˜¾ç¤ºä»»åŠ¡æ¨¡æ€æ¡†
        function showTaskModal(task = null) {
            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTitle');
            const submitBtn = document.getElementById('submitBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            
            currentEditingTask = task;
            
            if (task) {
                modalTitle.textContent = 'ç¼–è¾‘ä»»åŠ¡';
                submitBtn.textContent = 'ä¿å­˜ä¿®æ”¹';
                deleteBtn.classList.remove('hidden');
                
                // å¡«å……è¡¨å•æ•°æ®
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskCategory').value = task.category;
                document.getElementById('taskType').value = task.type;
                
                updateFormFields();
                
                if (task.fixedTime !== undefined) {
                    document.getElementById('fixedTime').value = task.fixedTime;
                }
                if (task.multiplier !== undefined) {
                    document.getElementById('multiplier').value = task.multiplier;
                }
                if (task.targetTime !== undefined) {
                    document.getElementById('targetTime').value = task.targetTime;
                }
                if (task.bonusReward !== undefined) {
                    document.getElementById('bonusReward').value = task.bonusReward;
                }
            } else {
                modalTitle.textContent = 'åˆ›å»ºä»»åŠ¡';
                submitBtn.textContent = 'åˆ›å»ºä»»åŠ¡';
                deleteBtn.classList.add('hidden');
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('taskForm').reset();
                updateFormFields();
            }
            
            modal.classList.add('show');
            updateCategoryRecommendations();
        }

        // éšè—ä»»åŠ¡æ¨¡æ€æ¡†
        function hideTaskModal() {
            const modal = document.getElementById('taskModal');
            modal.classList.remove('show');
            currentEditingTask = null;
            
            // æ¸…é™¤é”™è¯¯çŠ¶æ€
            document.querySelectorAll('.form-input, .form-select').forEach(input => {
                input.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.remove('show');
            });
        }

        // æ›´æ–°è¡¨å•å­—æ®µæ˜¾ç¤º
        function updateFormFields() {
            const taskType = document.getElementById('taskType').value;
            const fixedTimeGroup = document.getElementById('fixedTimeGroup');
            const multiplierGroup = document.getElementById('multiplierGroup');
            const targetTimeGroup = document.getElementById('targetTimeGroup');
            const bonusRewardGroup = document.getElementById('bonusRewardGroup');
            
            // éšè—æ‰€æœ‰å­—æ®µ
            fixedTimeGroup.classList.add('hidden');
            multiplierGroup.classList.add('hidden');
            targetTimeGroup.classList.add('hidden');
            bonusRewardGroup.classList.add('hidden');
            
            // æ ¹æ®ä»»åŠ¡ç±»å‹æ˜¾ç¤ºç›¸åº”å­—æ®µ
            switch (taskType) {
                case 'reward':
                case 'instant_redeem':
                    fixedTimeGroup.classList.remove('hidden');
                    break;
                case 'continuous':
                case 'continuous_redeem':
                    multiplierGroup.classList.remove('hidden');
                    break;
                case 'continuous_target':
                    multiplierGroup.classList.remove('hidden');
                    targetTimeGroup.classList.remove('hidden');
                    bonusRewardGroup.classList.remove('hidden');
                    break;
            }
        }

        // è®¾ç½®æ—¶é—´é¢„è®¾
        function setTimePreset(fieldId, seconds) {
            document.getElementById(fieldId).value = seconds;
        }

        // è®¾ç½®å€ç‡é¢„è®¾
        function setMultiplierPreset(multiplier) {
            document.getElementById('multiplier').value = multiplier;
        }

        // éªŒè¯æ•°å­—è¾“å…¥
        function validateNumberInput(value, fieldName) {
            if (!value || value.trim() === '') {
                return { valid: false, message: `${fieldName}ä¸èƒ½ä¸ºç©º` };
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) {
                return { valid: false, message: `${fieldName}å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—` };
            }
            
            if (num <= 0) {
                return { valid: false, message: `${fieldName}å¿…é¡»å¤§äº0` };
            }
            
            return { valid: true, value: num };
        }

        // æäº¤ä»»åŠ¡è¡¨å•
        function submitTask(event) {
            event.preventDefault();
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
            document.querySelectorAll('.form-input, .form-select').forEach(input => {
                input.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.remove('show');
            });
            
            // è·å–è¡¨å•æ•°æ®
            const name = document.getElementById('taskName').value.trim();
            const category = document.getElementById('taskCategory').value.trim();
            const type = document.getElementById('taskType').value;
            
            let isValid = true;
            
            // éªŒè¯åŸºæœ¬å­—æ®µ
            if (!name) {
                showFieldError('taskName', 'taskNameError', 'ä»»åŠ¡åç§°ä¸èƒ½ä¸ºç©º');
                isValid = false;
            }
            
            if (!category) {
                showFieldError('taskCategory', 'taskCategoryError', 'åˆ†ç±»ä¸èƒ½ä¸ºç©º');
                isValid = false;
            }
            
            if (!type) {
                showFieldError('taskType', 'taskTypeError', 'è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹');
                isValid = false;
            }
            
            // éªŒè¯ç±»å‹ç‰¹å®šå­—æ®µ
            let taskData = { name, category, type };
            
            switch (type) {
                case 'reward':
                case 'instant_redeem':
                    const fixedTimeValidation = validateNumberInput(
                        document.getElementById('fixedTime').value,
                        'å›ºå®šæ—¶é—´'
                    );
                    if (!fixedTimeValidation.valid) {
                        showFieldError('fixedTime', 'fixedTimeError', fixedTimeValidation.message);
                        isValid = false;
                    } else {
                        taskData.fixedTime = Math.round(fixedTimeValidation.value);
                    }
                    break;
                    
                case 'continuous':
                case 'continuous_redeem':
                    const multiplierValidation = validateNumberInput(
                        document.getElementById('multiplier').value,
                        'æ—¶é—´å€ç‡'
                    );
                    if (!multiplierValidation.valid) {
                        showFieldError('multiplier', 'multiplierError', multiplierValidation.message);
                        isValid = false;
                    } else {
                        taskData.multiplier = multiplierValidation.value;
                    }
                    break;
                    
                case 'continuous_target':
                    const targetMultiplierValidation = validateNumberInput(
                        document.getElementById('multiplier').value,
                        'æ—¶é—´å€ç‡'
                    );
                    const targetTimeValidation = validateNumberInput(
                        document.getElementById('targetTime').value,
                        'ç›®æ ‡æ—¶é•¿'
                    );
                    const bonusRewardValidation = validateNumberInput(
                        document.getElementById('bonusReward').value,
                        'é¢å¤–å¥–åŠ±'
                    );
                    
                    if (!targetMultiplierValidation.valid) {
                        showFieldError('multiplier', 'multiplierError', targetMultiplierValidation.message);
                        isValid = false;
                    } else {
                        taskData.multiplier = targetMultiplierValidation.value;
                    }
                    
                    if (!targetTimeValidation.valid) {
                        showFieldError('targetTime', 'targetTimeError', targetTimeValidation.message);
                        isValid = false;
                    } else {
                        taskData.targetTime = Math.round(targetTimeValidation.value);
                    }
                    
                    if (!bonusRewardValidation.valid) {
                        showFieldError('bonusReward', 'bonusRewardError', bonusRewardValidation.message);
                        isValid = false;
                    } else {
                        taskData.bonusReward = Math.round(bonusRewardValidation.value);
                    }
                    break;
            }
            
            if (!isValid) {
                return;
            }
            
            if (currentEditingTask) {
                // ç¼–è¾‘ç°æœ‰ä»»åŠ¡
                const taskIndex = tasks.findIndex(t => t.id === currentEditingTask.id);
                if (taskIndex !== -1) {
                    // ä¿ç•™åŸæœ‰çš„IDã€åˆ›å»ºæ—¶é—´ã€æœ€åä½¿ç”¨æ—¶é—´å’Œå®Œæˆæ¬¡æ•°
                    taskData.id = currentEditingTask.id;
                    taskData.createdAt = currentEditingTask.createdAt;
                    taskData.lastUsed = currentEditingTask.lastUsed;
                    taskData.achieved = currentEditingTask.achieved || false;
                    taskData.completionCount = currentEditingTask.completionCount || 0;
                    
                    tasks[taskIndex] = taskData;
                }
            } else {
                // åˆ›å»ºæ–°ä»»åŠ¡
                taskData.id = generateId();
                taskData.createdAt = new Date().toISOString();
                taskData.lastUsed = null;
                taskData.achieved = false;
                taskData.completionCount = 0;
                
                tasks.push(taskData);
            }
            
            // åˆ†é…åˆ†ç±»é¢œè‰²
            if (!categoryColors.has(category)) {
                const colorIndex = categoryColors.size % colors.length;
                categoryColors.set(category, colors[colorIndex]);
            }
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
            updateCategoryRecommendations();
            hideTaskModal();
        }

        // æ˜¾ç¤ºå­—æ®µé”™è¯¯
        function showFieldError(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            
            field.classList.add('error');
            error.textContent = message;
            error.classList.add('show');
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask() {
            if (!currentEditingTask) return;
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                // åœæ­¢ä»»åŠ¡ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
                if (runningTasks.has(currentEditingTask.id)) {
                    stopTask(currentEditingTask.id);
                }
                
                // ä»ä»»åŠ¡åˆ—è¡¨ä¸­ç§»é™¤
                tasks = tasks.filter(t => t.id !== currentEditingTask.id);
                
                saveData();
                updateRecentTasks();
                updateCategoryTasks();
                hideTaskModal();
            }
        }

        // å¼€å§‹ä»»åŠ¡ - æ”¹è¿›çš„æŒä¹…åŒ–ç‰ˆæœ¬
        function startTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
            task.lastUsed = new Date().toISOString();
            
            if (task.type === 'continuous' || task.type === 'continuous_redeem' || task.type === 'continuous_target') {
                // æŒç»­ä»»åŠ¡ï¼šé‡æ–°å¼€å§‹è®¡æ—¶ï¼ˆæ¯æ¬¡éƒ½ä»0å¼€å§‹ï¼‰
                const now = Date.now();
                runningTasks.set(taskId, {
                    startTime: now,
                    elapsedTime: 0, // æ¯æ¬¡éƒ½ä»0å¼€å§‹
                    achieved: false, // é‡ç½®è¾¾æ ‡çŠ¶æ€
                    isPaused: false,
                    lastSaveTime: now // æ·»åŠ æœ€åä¿å­˜æ—¶é—´ç”¨äºæŒä¹…åŒ–
                });
                
                // é‡ç½®ä»»åŠ¡çš„è¾¾æ ‡çŠ¶æ€
                if (task.type === 'continuous_target') {
                    task.achieved = false;
                }
            }
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
        }

        // æš‚åœä»»åŠ¡ - æ”¹è¿›çš„æŒä¹…åŒ–ç‰ˆæœ¬
        function pauseTask(taskId) {
            const runningTask = runningTasks.get(taskId);
            if (!runningTask || runningTask.isPaused) return;
            
            const now = Date.now();
            // è®¡ç®—å·²è¿è¡Œæ—¶é—´å¹¶æš‚åœ
            runningTask.elapsedTime += now - runningTask.startTime;
            runningTask.isPaused = true;
            runningTask.startTime = now; // æ›´æ–°å¼€å§‹æ—¶é—´ä¸ºæš‚åœæ—¶é—´
            runningTask.lastSaveTime = now; // æ›´æ–°ä¿å­˜æ—¶é—´
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
        }

        // æ¢å¤ä»»åŠ¡ - æ”¹è¿›çš„æŒä¹…åŒ–ç‰ˆæœ¬
        function resumeTask(taskId) {
            const runningTask = runningTasks.get(taskId);
            if (!runningTask || !runningTask.isPaused) return;
            
            const now = Date.now();
            // æ¢å¤è®¡æ—¶
            runningTask.isPaused = false;
            runningTask.startTime = now;
            runningTask.lastSaveTime = now; // æ›´æ–°ä¿å­˜æ—¶é—´
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
        }

        // åœæ­¢ä»»åŠ¡
        function stopTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const runningTask = runningTasks.get(taskId);
            if (!runningTask) return;
            
            // è®¡ç®—æ€»æ—¶é—´
            const totalTime = runningTask.elapsedTime + (runningTask.isPaused ? 0 : Date.now() - runningTask.startTime);
            const totalSeconds = Math.floor(totalTime / 1000);
            
            let earnedTime = 0;
            let description = '';
            
            if (task.type === 'continuous') {
                // æŒç»­ä»»åŠ¡ï¼ˆè‡ªç”±ï¼‰
                earnedTime = Math.floor(totalSeconds * task.multiplier);
                description = `å®ŒæˆæŒç»­ä»»åŠ¡"${task.name}"`;
            } else if (task.type === 'continuous_redeem') {
                // æŒç»­å…‘æ¢
                earnedTime = -Math.floor(totalSeconds * task.multiplier);
                description = `è¿›è¡ŒæŒç»­å…‘æ¢"${task.name}"`;
            } else if (task.type === 'continuous_target') {
                // æŒç»­ä»»åŠ¡ï¼ˆè¾¾æ ‡ï¼‰
                const baseTime = Math.floor(totalSeconds * task.multiplier);
                
                if (totalSeconds >= task.targetTime) {
                    // è¾¾æ ‡ï¼šåŸºç¡€æ—¶é—´ + é¢å¤–å¥–åŠ±
                    earnedTime = baseTime + task.bonusReward;
                    description = `å®Œæˆè¾¾æ ‡ä»»åŠ¡"${task.name}"ï¼ˆå·²è¾¾æ ‡ï¼‰`;
                    task.achieved = true;
                } else {
                    // æœªè¾¾æ ‡ï¼šåªæœ‰åŸºç¡€æ—¶é—´
                    earnedTime = baseTime;
                    description = `å®ŒæˆæŒç»­ä»»åŠ¡"${task.name}"ï¼ˆæœªè¾¾æ ‡ï¼‰`;
                }
            }
            
            // å¢åŠ å®Œæˆæ¬¡æ•°
            task.completionCount = (task.completionCount || 0) + 1;
            
            // æ›´æ–°ä½™é¢å’Œäº¤æ˜“è®°å½•
            currentBalance += earnedTime;
            addTransaction(description, earnedTime);
            
            // ç§»é™¤è¿è¡ŒçŠ¶æ€
            runningTasks.delete(taskId);
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
        }

        // å–æ¶ˆä»»åŠ¡
        function cancelTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const runningTask = runningTasks.get(taskId);
            if (!runningTask) return;
            
            // ç›´æ¥ç§»é™¤è¿è¡ŒçŠ¶æ€ï¼Œä¸è®¡å…¥ä»»åŠ¡æ—¶é—´å’Œæ¬¡æ•°
            runningTasks.delete(taskId);
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
        }

        // å®Œæˆä»»åŠ¡
        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
            task.lastUsed = new Date().toISOString();
            
            let earnedTime = 0;
            let description = '';
            
            if (task.type === 'reward') {
                // å¥–åŠ±ä»»åŠ¡
                earnedTime = task.fixedTime;
                description = `å®Œæˆå¥–åŠ±ä»»åŠ¡"${task.name}"`;
            } else if (task.type === 'instant_redeem') {
                // å³æ—¶å…‘æ¢
                earnedTime = -task.fixedTime;
                description = `è¿›è¡Œå³æ—¶å…‘æ¢"${task.name}"`;
            }
            
            // å¢åŠ å®Œæˆæ¬¡æ•°
            task.completionCount = (task.completionCount || 0) + 1;
            
            // æ›´æ–°ä½™é¢å’Œäº¤æ˜“è®°å½•
            currentBalance += earnedTime;
            addTransaction(description, earnedTime);
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
        }

        // æ›´æ–°è¿è¡Œä¸­çš„ä»»åŠ¡è®¡æ—¶å™¨
        function updateRunningTimers() {
            let hasUpdate = false;
            
            runningTasks.forEach((runningTask, taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (!task) {
                    runningTasks.delete(taskId);
                    return;
                }
                
                // å¦‚æœä»»åŠ¡æš‚åœï¼Œä¸æ›´æ–°è®¡æ—¶
                if (runningTask.isPaused) {
                    return;
                }
                
                // è®¡ç®—å½“å‰æ€»æ—¶é—´
                const currentTotalTime = runningTask.elapsedTime + (Date.now() - runningTask.startTime);
                const totalSeconds = Math.floor(currentTotalTime / 1000);
                
                // æ£€æŸ¥è¾¾æ ‡ä»»åŠ¡æ˜¯å¦è¾¾æ ‡
                if (task.type === 'continuous_target' && !runningTask.achieved && totalSeconds >= task.targetTime) {
                    runningTask.achieved = true;
                    task.achieved = true;
                    
                    // å‘é€è¾¾æ ‡é€šçŸ¥
                    if (notificationSettings.enabled && notificationSettings.achievement) {
                        sendNotification('æ—¶é—´é“¶è¡Œæé†’', `æ­å–œï¼æ‚¨çš„ä»»åŠ¡"${task.name}"å·²è¾¾æ ‡ï¼`);
                    }
                    
                    hasUpdate = true;
                }
                
                // æ£€æŸ¥é•¿æ—¶é—´è¿è¡Œæé†’
                if (task.type === 'continuous_redeem' && 
                    notificationSettings.enabled && 
                    notificationSettings.longRunning &&
                    totalSeconds > 0 && 
                    totalSeconds % notificationSettings.longRunningThreshold === 0) {
                    
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    let timeStr = '';
                    if (hours > 0) {
                        timeStr = `${hours}å°æ—¶`;
                        if (minutes > 0) timeStr += `${minutes}åˆ†é’Ÿ`;
                    } else {
                        timeStr = `${minutes}åˆ†é’Ÿ`;
                    }
                    
                    sendNotification('æ—¶é—´é“¶è¡Œæé†’', `æ‚¨çš„ä»»åŠ¡"${task.name}"å·²è¿è¡Œè¶…è¿‡${timeStr}ï¼Œæ³¨æ„ä¼‘æ¯å“¦ï¼`);
                }
                
                // å®šæœŸä¿å­˜æ•°æ®ï¼ˆæ¯30ç§’ä¿å­˜ä¸€æ¬¡ï¼‰
                const now = Date.now();
                if (now - runningTask.lastSaveTime >= 30000) {
                    runningTask.lastSaveTime = now;
                    hasUpdate = true;
                }
            });
            
            if (hasUpdate) {
                saveData();
            }
            
            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            updateRecentTasks();
            updateCategoryTasks();
        }

        // æ›´æ–°åˆ†ç±»æ¨è
        function updateCategoryRecommendations() {
            const categories = [...new Set(tasks.map(t => t.category))];
            const container = document.getElementById('categoryRecommendations');
            
            if (categories.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = categories.map(category => 
                `<div class="recommendation-item" onclick="setCategoryRecommendation('${category}')">${category}</div>`
            ).join('');
        }

        // è®¾ç½®åˆ†ç±»æ¨è
        function setCategoryRecommendation(category) {
            document.getElementById('taskCategory').value = category;
        }

        // æ·»åŠ äº¤æ˜“è®°å½•
        function addTransaction(description, amount) {
            const now = new Date();
            const todayKey = now.toISOString().split('T')[0]; // YYYY-MM-DD

            transactions.unshift({
                id: generateId(),
                description,
                amount,
                timestamp: now.toISOString(),
                undone: false // æ·»åŠ æ’¤é”€çŠ¶æ€æ ‡è®°
            });

            // æ›´æ–°æ¯æ—¥å˜åŒ–
            if (!dailyChanges) {
                dailyChanges = {};
            }
            if (!dailyChanges[todayKey]) {
                dailyChanges[todayKey] = 0;
            }
            dailyChanges[todayKey] += amount;

            // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
            if (transactions.length > 100) {
                transactions = transactions.slice(0, 100);
            }
        }

        // æ›´æ–°ä½™é¢æ˜¾ç¤º
        function updateBalance() {
            const balanceCard = document.getElementById("balanceCard");
            const balanceAmount = document.getElementById("currentBalanceAmount");

            balanceAmount.textContent = formatTime(currentBalance);

            // è®¾ç½®æ•°å­—é¢œè‰²
            if (currentBalance < 0) {
                balanceCard.classList.add("negative");
                balanceAmount.style.color = "#f44336"; // çº¢è‰²
            } else if (currentBalance > 0) {
                balanceCard.classList.remove("negative");
                balanceAmount.style.color = "#2196F3"; // è“è‰²
            } else {
                balanceCard.classList.remove("negative");
                balanceAmount.style.color = "#888"; // ç°è‰²
            }

            // æ›´æ–°ä»Šæ—¥/æ˜¨æ—¥å˜åŒ–
            updateDailyChanges();
            
            // æ£€æŸ¥ä½™é¢ä¸è¶³é¢„è­¦
            if (notificationSettings.enabled && 
                notificationSettings.lowBalance && 
                currentBalance > 0 && 
                currentBalance <= notificationSettings.lowBalanceThreshold) {
                
                const timeStr = formatTime(currentBalance);
                sendNotification("æ—¶é—´é“¶è¡Œæé†’", `æ‚¨çš„æ—¶é—´ä½™é¢å·²ä¸è¶³${timeStr}ï¼Œè¯·åŠæ—¶è¡¥å……å“¦ï¼`);
            }
        }

        // æ›´æ–°ä»Šæ—¥/æ˜¨æ—¥å˜åŒ–
        function updateDailyChanges() {
            const today = new Date();
            const todayKey = today.toISOString().split('T')[0];

            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const yesterdayKey = yesterday.toISOString().split('T')[0];

            const todayChange = (dailyChanges && dailyChanges[todayKey]) || 0;
            const yesterdayChange = (dailyChanges && dailyChanges[yesterdayKey]) || 0;

            const todayChangeElement = document.getElementById('todayChange');
            const yesterdayChangeElement = document.getElementById('yesterdayChange');

            if (todayChangeElement) {
                todayChangeElement.textContent = `ä»Šæ—¥å˜åŒ–: ${todayChange >= 0 ? '+' : ''}${formatTime(Math.abs(todayChange))}`;
                todayChangeElement.style.color = todayChange >= 0 ? '#4CAF50' : '#f44336';
            }
            if (yesterdayChangeElement) {
                yesterdayChangeElement.textContent = `æ˜¨æ—¥å˜åŒ–: ${yesterdayChange >= 0 ? '+' : ''}${formatTime(Math.abs(yesterdayChange))}`;
                yesterdayChangeElement.style.color = yesterdayChange >= 0 ? '#4CAF50' : '#f44336';
            }
        }

        // æ›´æ–°æŠ¥å‘Š
        function updateReports() {
            const totalEarned = transactions
                .filter(t => t.amount > 0 && !t.undone)
                .reduce((sum, t) => sum + t.amount, 0);

            const totalSpent = Math.abs(transactions
                .filter(t => t.amount < 0 && !t.undone)
                .reduce((sum, t) => sum + t.amount, 0));

            const totalTasks = transactions.filter(t => !t.undone).length;

            document.getElementById('totalEarned').textContent = formatTime(totalEarned);
            document.getElementById('totalSpent').textContent = formatTime(totalSpent);
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById("currentBalance").textContent = formatTime(currentBalance);

            // æ›´æ–°äº¤æ˜“å†å²
            const transactionList = document.getElementById('transactionList');
            const activeTransactions = transactions.filter(t => !t.undone);
            
            if (activeTransactions.length === 0) {
                transactionList.innerHTML = '<div class="empty-message">æš‚æ— äº¤æ˜“è®°å½•</div>';
            } else {
                transactionList.innerHTML = activeTransactions.map(transaction => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-name">${transaction.description}</div>
                            <div class="transaction-time">${formatDateTime(transaction.timestamp)}</div>
                        </div>
                        <div class="transaction-amount ${transaction.amount > 0 ? 'positive' : 'negative'}">
                            ${transaction.amount > 0 ? '+' : ''}${formatTime(Math.abs(transaction.amount))}
                        </div>
                    </div>
                `).join('');
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º (å•è¡Œæ™ºèƒ½æ˜¾ç¤º)
        function formatTime(totalSeconds) {
            if (totalSeconds === 0) return '0ç§’';
            const absSeconds = Math.abs(totalSeconds);
            
            if (absSeconds >= 86400) { // è¶…è¿‡24å°æ—¶ï¼Œæ˜¾ç¤ºå¤©å’Œå°æ—¶
                const days = Math.floor(absSeconds / 86400);
                const hours = Math.floor((absSeconds % 86400) / 3600);
                return `${days}å¤©${hours}å°æ—¶`;
            } else if (absSeconds >= 3600) { // è¶…è¿‡1å°æ—¶ï¼Œæ˜¾ç¤ºå°æ—¶å’Œåˆ†é’Ÿ
                const hours = Math.floor(absSeconds / 3600);
                const minutes = Math.floor((absSeconds % 3600) / 60);
                return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
            } else if (absSeconds >= 60) { // è¶…è¿‡1åˆ†é’Ÿï¼Œæ˜¾ç¤ºåˆ†é’Ÿå’Œç§’
                const minutes = Math.floor(absSeconds / 60);
                const seconds = absSeconds % 60;
                return `${minutes}åˆ†é’Ÿ${seconds}ç§’`;
            } else { // å°äº1åˆ†é’Ÿï¼Œæ˜¾ç¤ºç§’
                return `${absSeconds}ç§’`;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // é€šçŸ¥ç›¸å…³å‡½æ•°
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationSettings.enabled = true;
                        updateNotificationSettings();
                        saveData();
                    }
                });
            }
        }

        function sendNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyUzYuNDggMjIgMTIgMjJTMjIgMTcuNTIgMjIgMTJTMTcuNTIgMiAxMiAyWk0xMyAxN0gxMVYxNUgxM1YxN1pNMTMgMTNIMTFWN0gxM1YxM1oiIGZpbGw9IiMyMTk2RjMiLz4KPC9zdmc+',
                    tag: 'timebank-notification'
                });
            }
        }

        function updateNotificationSettings() {
            document.getElementById('notificationsEnabled').checked = notificationSettings.enabled;
            document.getElementById('achievementNotification').checked = notificationSettings.achievement;
            document.getElementById('longRunningNotification').checked = notificationSettings.longRunning;
            document.getElementById('longRunningThreshold').value = notificationSettings.longRunningThreshold;
            document.getElementById('lowBalanceNotification').checked = notificationSettings.lowBalance;
            document.getElementById('lowBalanceThreshold').value = notificationSettings.lowBalanceThreshold;
            document.getElementById('inactiveTaskNotification').checked = notificationSettings.inactiveTask;
            document.getElementById('inactiveTaskThreshold').value = notificationSettings.inactiveTaskThreshold;
        }

        // é€šçŸ¥è®¾ç½®äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            // é€šçŸ¥æ€»å¼€å…³
            document.getElementById('notificationsEnabled').addEventListener('change', function(e) {
                if (e.target.checked && Notification.permission !== 'granted') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            notificationSettings.enabled = true;
                        } else {
                            e.target.checked = false;
                            notificationSettings.enabled = false;
                        }
                        saveData();
                    });
                } else {
                    notificationSettings.enabled = e.target.checked;
                    saveData();
                }
            });

            // å…¶ä»–é€šçŸ¥å¼€å…³
            document.getElementById('achievementNotification').addEventListener('change', function(e) {
                notificationSettings.achievement = e.target.checked;
                saveData();
            });

            document.getElementById('longRunningNotification').addEventListener('change', function(e) {
                notificationSettings.longRunning = e.target.checked;
                saveData();
            });

            document.getElementById('longRunningThreshold').addEventListener('change', function(e) {
                notificationSettings.longRunningThreshold = parseInt(e.target.value);
                saveData();
            });

            document.getElementById('lowBalanceNotification').addEventListener('change', function(e) {
                notificationSettings.lowBalance = e.target.checked;
                saveData();
            });

            document.getElementById('lowBalanceThreshold').addEventListener('change', function(e) {
                notificationSettings.lowBalanceThreshold = parseInt(e.target.value);
                saveData();
            });

            document.getElementById('inactiveTaskNotification').addEventListener('change', function(e) {
                notificationSettings.inactiveTask = e.target.checked;
                saveData();
            });

            document.getElementById('inactiveTaskThreshold').addEventListener('change', function(e) {
                notificationSettings.inactiveTaskThreshold = parseInt(e.target.value);
                saveData();
            });
        });

        // æ•°æ®æŒä¹…åŒ– - æ”¹è¿›çš„ç‰ˆæœ¬
        function saveData() {
            const data = {
                currentBalance,
                tasks,
                transactions,
                categoryColors: Array.from(categoryColors.entries()),
                collapsedCategories: Array.from(collapsedCategories),
                runningTasks: Array.from(runningTasks.entries()).map(([id, task]) => {
                    // ä¿å­˜æ—¶è®¡ç®—å½“å‰çš„å®é™…å·²è¿è¡Œæ—¶é—´
                    const now = Date.now();
                    const actualElapsedTime = task.elapsedTime + (task.isPaused ? 0 : now - task.startTime);
                    return [id, {
                        ...task,
                        elapsedTime: actualElapsedTime,
                        startTime: now, // ä¿å­˜å½“å‰æ—¶é—´ä½œä¸ºæ–°çš„å¼€å§‹æ—¶é—´
                        lastSaveTime: now
                    }];
                }),
                notificationSettings,
                dailyChanges,
                version: '2.8'
            };
            localStorage.setItem('timeBankData', JSON.stringify(data));
        }

        // æ•°æ®åŠ è½½ - æ”¹è¿›çš„ç‰ˆæœ¬
        function loadData() {
            const data = localStorage.getItem('timeBankData');
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    currentBalance = parsed.currentBalance || 0;
                    tasks = parsed.tasks || [];
                    transactions = parsed.transactions || [];
                    categoryColors = new Map(parsed.categoryColors || []);
                    collapsedCategories = new Set(parsed.collapsedCategories || []);
                    notificationSettings = { ...notificationSettings, ...(parsed.notificationSettings || {}) };
                    dailyChanges = parsed.dailyChanges || {};
                    
                    // æ¢å¤è¿è¡Œä¸­çš„ä»»åŠ¡çŠ¶æ€ - æ”¹è¿›çš„é€»è¾‘
                    if (parsed.runningTasks) {
                        const now = Date.now();
                        runningTasks = new Map(parsed.runningTasks.map(([id, task]) => {
                            // å¦‚æœä»»åŠ¡æ˜¯æš‚åœçŠ¶æ€ï¼Œç›´æ¥æ¢å¤
                            if (task.isPaused) {
                                return [id, {
                                    ...task,
                                    startTime: now,
                                    lastSaveTime: now
                                }];
                            } else {
                                // å¦‚æœä»»åŠ¡æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œè®¡ç®—ä»ä¸Šæ¬¡ä¿å­˜åˆ°ç°åœ¨çš„æ—¶é—´å·®
                                const timeSinceLastSave = now - task.startTime;
                                return [id, {
                                    ...task,
                                    startTime: now, // é‡æ–°è®¾ç½®å¼€å§‹æ—¶é—´ä¸ºå½“å‰æ—¶é—´
                                    elapsedTime: task.elapsedTime + timeSinceLastSave,
                                    lastSaveTime: now
                                }];
                            }
                        }));
                    }
                    
                    // ç¡®ä¿æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰completionCountå­—æ®µ
                    tasks.forEach(task => {
                        if (task.completionCount === undefined) {
                            task.completionCount = 0;
                        }
                    });
                    
                    // ç¡®ä¿æ‰€æœ‰äº¤æ˜“éƒ½æœ‰undoneå­—æ®µ
                    transactions.forEach(transaction => {
                        if (transaction.undone === undefined) {
                            transaction.undone = false;
                        }
                    });
                } catch (e) {
                    console.error('Failed to load data:', e);
                }
            }
        }

        // æ•°æ®æ¸…é™¤åŠŸèƒ½
        function clearTimeData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ—¶é—´æ•°æ®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰äº¤æ˜“è®°å½•å’Œä½™é¢ï¼Œä½†ä¿ç•™ä»»åŠ¡è®¾ç½®ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            // æ¸…é™¤æ—¶é—´ç›¸å…³æ•°æ®
            transactions = [];
            runningTasks.clear();
            currentBalance = 0;
            dailyChanges = {};
            
            // é‡ç½®ä»»åŠ¡çš„å®Œæˆç»Ÿè®¡
            tasks.forEach(task => {
                task.completionCount = 0;
                task.lastCompleted = null;
            });
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            
            alert('æ—¶é—´æ•°æ®å·²æ¸…é™¤ï¼');
        }

        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ä»»åŠ¡ã€æ—¶é—´è®°å½•å’Œè®¾ç½®ï¼Œæ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            // æ¸…é™¤æ‰€æœ‰æ•°æ®
            tasks = [];
            transactions = [];
            runningTasks.clear();
            currentBalance = 0;
            dailyChanges = {};
            categoryColors.clear();
            collapsedCategories.clear();
            
            // é‡ç½®é€šçŸ¥è®¾ç½®ä¸ºé»˜è®¤å€¼
            notificationSettings = {
                enabled: false,
                achievement: true,
                longRunning: true,
                longRunningThreshold: 30,
                lowBalance: true,
                lowBalanceThreshold: 300,
                inactiveTask: true,
                inactiveTaskThreshold: 7
            };
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('timeBankData');
            
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            updateCategoryRecommendations();
            updateNotificationSettings();
            
            alert('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼');
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = {
                currentBalance,
                tasks,
                transactions,
                categoryColors: Array.from(categoryColors.entries()),
                collapsedCategories: Array.from(collapsedCategories),
                notificationSettings,
                exportDate: new Date().toISOString(),
                version: '2.8'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timebank_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥æ•°æ®
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                        currentBalance = data.currentBalance || 0;
                        tasks = data.tasks || [];
                        transactions = data.transactions || [];
                        categoryColors = new Map(data.categoryColors || []);
                        collapsedCategories = new Set(data.collapsedCategories || []);
                        notificationSettings = { ...notificationSettings, ...(data.notificationSettings || {}) };
                        
                        // æ¸…é™¤è¿è¡Œä¸­çš„ä»»åŠ¡çŠ¶æ€
                        runningTasks.clear();
                        
                        // ç¡®ä¿æ‰€æœ‰ä»»åŠ¡éƒ½æœ‰completionCountå­—æ®µ
                        tasks.forEach(task => {
                            if (task.completionCount === undefined) {
                                task.completionCount = 0;
                            }
                        });
                        
                        // ç¡®ä¿æ‰€æœ‰äº¤æ˜“éƒ½æœ‰undoneå­—æ®µ
                        transactions.forEach(transaction => {
                            if (transaction.undone === undefined) {
                                transaction.undone = false;
                            }
                        });

                        saveData();
                        updateBalance();
                        updateRecentTasks();
                        updateCategoryTasks();
                        updateReports();
                        updateCategoryRecommendations();
                        updateNotificationSettings();
                        
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    }
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                }
            };
            reader.readAsText(file);
        }

        // ä¸»é¢˜ç®¡ç†åŠŸèƒ½
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemThemeEnabled = localStorage.getItem('systemTheme') === 'true';
            
            // æ›´æ–°å¼€å…³çŠ¶æ€
            document.getElementById('systemThemeToggle').checked = systemThemeEnabled;
            
            if (systemThemeEnabled) {
                // è·Ÿéšç³»ç»Ÿä¸»é¢˜
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                setTheme(prefersDark ? 'dark' : 'light');
                document.getElementById('darkModeToggle').checked = prefersDark;
                document.getElementById('darkModeToggle').disabled = true;
            } else {
                // ä½¿ç”¨ä¿å­˜çš„ä¸»é¢˜
                const theme = savedTheme || 'light';
                setTheme(theme);
                document.getElementById('darkModeToggle').checked = theme === 'dark';
                document.getElementById('darkModeToggle').disabled = false;
            }
            
            // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (document.getElementById('systemThemeToggle').checked) {
                    setTheme(e.matches ? 'dark' : 'light');
                    document.getElementById('darkModeToggle').checked = e.matches;
                }
            });
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            if (!document.getElementById('systemThemeToggle').checked) {
                localStorage.setItem('theme', theme);
            }
        }

        function toggleDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const systemThemeToggle = document.getElementById('systemThemeToggle');
            
            if (systemThemeToggle.checked) {
                return; // å¦‚æœè·Ÿéšç³»ç»Ÿä¸»é¢˜ï¼Œä¸å…è®¸æ‰‹åŠ¨åˆ‡æ¢
            }
            
            const newTheme = darkModeToggle.checked ? 'dark' : 'light';
            setTheme(newTheme);
        }

        function toggleSystemTheme() {
            const systemThemeToggle = document.getElementById('systemThemeToggle');
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            localStorage.setItem('systemTheme', systemThemeToggle.checked);
            
            if (systemThemeToggle.checked) {
                // å¯ç”¨è·Ÿéšç³»ç»Ÿä¸»é¢˜
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                setTheme(prefersDark ? 'dark' : 'light');
                darkModeToggle.checked = prefersDark;
                darkModeToggle.disabled = true;
                localStorage.removeItem('theme'); // æ¸…é™¤æ‰‹åŠ¨è®¾ç½®çš„ä¸»é¢˜
            } else {
                // ç¦ç”¨è·Ÿéšç³»ç»Ÿä¸»é¢˜
                darkModeToggle.disabled = false;
                const currentTheme = darkModeToggle.checked ? 'dark' : 'light';
                setTheme(currentTheme);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            initTheme();
            
            // ç»‘å®šä¸»é¢˜åˆ‡æ¢äº‹ä»¶
            document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
            document.getElementById('systemThemeToggle').addEventListener('change', toggleSystemTheme);
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideTaskModal();
            }
        });

        document.getElementById('historyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideHistoryModal();
            }
        });
    </script>
</body>
</html>

