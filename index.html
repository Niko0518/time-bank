<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´é“¶è¡Œ - Time Bank v3.2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSSå˜é‡å®šä¹‰ - æ”¯æŒäº®è‰²å’Œæš—è‰²ä¸»é¢˜ */
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.1);
            --text-color: #333;
            --border-color: #ddd;
            --input-bg: #fff;
            --header-text: white;
            --section-title-color: white;
            --btn-secondary-bg: #f5f5f5;
            --btn-secondary-text: #666;
            --btn-secondary-border: #ddd;
            --habit-border-width: 4px;
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --card-bg: rgba(42, 42, 42, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.3);
            --text-color: #e0e0e0 !important;
            --border-color: #444;
            --input-bg: #2a2a2a;
            --header-text: #e0e0e0;
            --section-title-color: #e0e0e0 !important;
            --btn-secondary-bg: #3a3a3a;
            --btn-secondary-text: #e0e0e0;
            --btn-secondary-border: #555;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨æ ‡ç­¾æ ç•™å‡ºç©ºé—´ */
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            padding: 20px;
            color: var(--header-text);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .balance-card {
            margin: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .balance-card.negative {
            background: rgba(255, 235, 238, 0.95);
            border: 2px solid #f44336;
        }

        .balance-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .daily-changes {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .daily-change {
            color: #666;
        }

        /* æ ‡ç­¾é¡µ */
        .tab-content {
            display: none;
            padding: 0 20px;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 20px 0 15px 0;
            color: var(--section-title-color);
        }

        /* æœ€è¿‘ä»»åŠ¡ç½‘æ ¼å¸ƒå±€ - ä¸€è¡Œä¸¤ä¸ªï¼Œæ˜¾ç¤ºä¸‰è¡Œï¼ˆå…±6ä¸ªï¼‰ */
        .recent-tasks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* åˆ†ç±»ä»»åŠ¡ç½‘æ ¼å¸ƒå±€ - ä¸€è¡Œä¸¤ä¸ª */
        .category-tasks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* ä»»åŠ¡å¡ç‰‡ - ç²¾ç®€ç‰ˆ */
        .task-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 16px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden; /* For the border */
        }

        /* ä¹ æƒ¯ä»»åŠ¡çš„è¾¹æ¡† */
        .task-card.is-habit::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--habit-border-width);
            background-color: var(--habit-color, #ccc);
        }

        .task-card.is-habit {
            padding-left: calc(12px + var(--habit-border-width));
        }


        .task-card.compact {
            padding: 10px;
        }
        .task-card.compact.is-habit {
            padding-left: calc(10px + var(--habit-border-width));
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .task-info {
            flex: 1;
            min-width: 0;
        }

        .task-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-name-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .task-edit-btn {
            background: none;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            color: #666;
            padding: 2px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .task-edit-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .task-details {
            font-size: 0.75rem;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .task-category {
            background: #2196F3;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .task-completion-count {
            color: #4CAF50;
            font-weight: 500;
            font-size: 0.7rem;
        }

        /* ç²¾ç®€ç‰ˆæŒ‰é’®å¸ƒå±€ */
        .task-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .task-actions.compact {
            gap: 3px;
        }

        .task-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 36px; /* ç²¾ç®€ç‰ˆæ›´å°çš„æœ€å°å°ºå¯¸ */
            text-align: center;
        }
        
        /* è¿è¡Œä¸­ä»»åŠ¡çš„å›¾æ ‡æŒ‰é’®æ ·å¼ */
        .task-btn.icon-btn {
            font-size: 0.9rem; /* å¢å¤§å›¾æ ‡å°ºå¯¸ */
            padding: 4px;
        }


        .task-btn.compact {
            padding: 3px 6px;
            font-size: 0.65rem;
            min-width: 32px;
        }

        .task-btn.edit {
            background: #f5f5f5;
            color: #666;
            padding: 5px 8px;
            min-width: 36px;
        }

        .task-btn.primary {
            background: #2196F3;
            color: white;
        }

        .task-btn.success {
            background: #4CAF50;
            color: white;
        }

        .task-btn.warning {
            background: #FF9800;
            color: white;
        }

        .task-btn.danger {
            background: #f44336;
            color: white;
        }

        .task-btn.secondary {
            background: #9E9E9E;
            color: white;
        }

        .task-btn.info {
            background: #17a2b8;
            color: white;
        }

        .task-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .task-timer {
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2196F3;
        }

        .task-progress {
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
        }

        /* åˆ†ç±»ä»»åŠ¡ */
        .category-tasks {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-header:hover {
            background: rgba(255, 255, 255, 1);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .category-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .category-count {
            color: #666;
            font-size: 0.85rem;
        }

        .category-toggle {
            transition: transform 0.2s ease;
            font-size: 0.8rem;
            color: #666;
        }

        .category-header.collapsed .category-toggle {
            transform: rotate(-90deg);
        }

        .category-tasks-list {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-tasks-list.collapsed {
            max-height: 0;
        }

        /* æœ€è¿‘ä»»åŠ¡ */
        .recent-tasks {
            margin-bottom: 30px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            padding: 40px 20px;
        }
        [data-theme="dark"] .empty-message {
             color: rgba(255, 255, 255, 0.5);
        }

        /* æ‚¬æµ®æŒ‰é’® */
        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6);
        }

        /* åº•éƒ¨æ ‡ç­¾æ  */
        .bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            color: #666;
        }

        .tab-button.active {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .tab-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .form-input.error, .form-select.error {
            border-color: #f44336;
        }

        .error-message {
            color: #f44336;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        /* æ—¶é—´é¢„è®¾æŒ‰é’® */
        .time-presets {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .time-preset {
            padding: 6px 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-preset:hover {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        /* åˆ†ç±»æ¨è */
        .recommendations {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .recommendation-item {
            padding: 4px 8px;
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .recommendation-item:hover {
            background: #2196F3;
            color: white;
        }

        /* è¡¨å•æŒ‰é’® */
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* ä¹ æƒ¯è®¾ç½®æ ·å¼ */
        .habit-settings {
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            background-color: rgba(33, 150, 243, 0.05);
        }

        [data-theme="dark"] .habit-settings {
             background-color: rgba(33, 150, 243, 0.1);
        }

        .habit-settings-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2196F3;
            margin-bottom: 20px;
        }

        .habit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .habit-reward-rule {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .habit-reward-rule .form-input, .habit-reward-rule .form-select {
            padding: 8px;
            font-size: 0.9rem;
        }

        .remove-reward-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
        }

        /* æŠ¥å‘Šé¡µé¢ */
        .report-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            box-shadow: 0 4px 16px var(--card-shadow);
        }

        [data-theme="light"] .report-section {
             background: rgba(255, 255, 255, 0.95);
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .report-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .report-filters {
            display: flex;
            gap: 5px;
        }
        .report-filters button, .analysis-controls button {
            padding: 6px 12px;
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--text-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .report-filters button.active, .analysis-controls button.active {
            background-color: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        /* æµé‡å›¾ */
        .flow-chart-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .flow-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .flow-bar-label {
            font-size: 0.9rem;
            font-weight: 500;
            width: 60px;
        }
        .flow-bar {
            flex: 1;
            display: flex;
            height: 24px;
            border-radius: 6px;
            overflow: hidden;
            background-color: var(--border-color);
        }
        .flow-bar-segment {
            height: 100%;
            transition: width 0.3s ease;
            position: relative;
        }
        .flow-bar-segment .tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        .flow-bar-segment:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* çƒ­åŠ›å›¾ */
        .heatmap-container {
            overflow-x: auto;
            padding: 10px 0;
        }
        .heatmap-grid {
            display: inline-grid;
            grid-auto-flow: column;
            grid-template-rows: repeat(7, 1fr);
            gap: 3px;
        }
        .heatmap-day {
            width: 15px;
            height: 15px;
            background-color: var(--border-color);
            border-radius: 3px;
            position: relative;
        }
        .heatmap-day[data-level='0'] { background-color: #ebedf0; }
        .heatmap-day[data-level='1'] { background-color: #9be9a8; }
        .heatmap-day[data-level='2'] { background-color: #40c463; }
        .heatmap-day[data-level='3'] { background-color: #30a14e; }
        .heatmap-day[data-level='4'] { background-color: #216e39; }
        .heatmap-day[data-level='-1'] { background-color: #ffcdd2; }
        .heatmap-day[data-level='-2'] { background-color: #ef9a9a; }
        .heatmap-day[data-level='-3'] { background-color: #e57373; }
        .heatmap-day[data-level='-4'] { background-color: #f44336; }
        [data-theme="dark"] .heatmap-day[data-level='0'] { background-color: #2d333b; }
        [data-theme="dark"] .heatmap-day[data-level='1'] { background-color: #0e4429; }
        [data-theme="dark"] .heatmap-day[data-level='2'] { background-color: #006d32; }
        [data-theme="dark"] .heatmap-day[data-level='3'] { background-color: #26a641; }
        [data-theme="dark"] .heatmap-day[data-level='4'] { background-color: #39d353; }
        [data-theme="dark"] .heatmap-day[data-level='-1'] { background-color: #4a1e1e; }
        [data-theme="dark"] .heatmap-day[data-level='-2'] { background-color: #6f2626; }
        [data-theme="dark"] .heatmap-day[data-level='-3'] { background-color: #992e2e; }
        [data-theme="dark"] .heatmap-day[data-level='-4'] { background-color: #c93333; }
        .heatmap-day .tooltip {
            min-width: 180px;
        }
        .heatmap-legend {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: #666;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-box { width: 12px; height: 12px; border-radius: 2px; }
        [data-theme="dark"] .heatmap-legend { color: #bbb; }
        
        /* åˆ†æè¡¨æ ¼ */
        .analysis-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .analysis-search {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        .analysis-table-container {
             max-height: 400px;
             overflow-y: auto;
        }
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .analysis-table th, .analysis-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .analysis-table th {
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }
        .analysis-table th.sort-asc::after { content: ' â–²'; }
        .analysis-table th.sort-desc::after { content: ' â–¼'; }
        .text-positive { color: #2196F3; font-weight: 500; }
        .text-negative { color: #f44336; font-weight: 500; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px var(--card-shadow);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        /* è®¾ç½®é¡µé¢ */
        .settings-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px var(--card-shadow);
        }

        .settings-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .setting-desc {
            font-size: 0.85rem;
            color: #666;
        }
        
        /* ä¸»é¢˜é€‰æ‹©æŒ‰é’®ç»„ */
        .theme-selector {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .theme-option {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-color);
            transition: background-color 0.2s ease;
            border-left: 1px solid var(--border-color);
        }

        .theme-option:first-child {
            border-left: none;
        }

        .theme-option.active {
            background: #2196F3;
            color: white;
        }


        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .threshold-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        /* æ•°æ®ç®¡ç†æŒ‰é’® */
        .data-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .data-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            background: white;
            color: #2196F3;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .data-btn:hover {
            background: #2196F3;
            color: white;
        }

        .file-input {
            display: none;
        }
        
        /* å…³äº/ç‰ˆæœ¬ä¿¡æ¯æ ·å¼ */
        .about-section details {
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
        }
        .about-section summary {
            font-weight: 500;
            cursor: pointer;
            outline: none;
        }
        .about-section p {
            font-size: 0.9rem;
            line-height: 1.6;
            margin: 10px 0;
        }
        .about-section ul {
            list-style-position: inside;
            padding-left: 10px;
        }
        .about-section li {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        [data-theme="dark"] .about-section p, [data-theme="dark"] .about-section li {
            color: #bbb;
        }
        /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ä¼˜åŒ– */
        @media (max-width: 480px) {
            .header h1 { font-size: 1.5rem; }
            .balance-amount { font-size: 2rem; }
            .balance-card { margin: 15px; padding: 15px; }
            .tab-content { padding: 0 15px; }

            .task-card { padding: 12px; margin-bottom: 8px; }
            .task-card.is-habit { padding-left: calc(12px + var(--habit-border-width)); }
            .task-header { flex-direction: column; align-items: stretch; gap: 12px; }
            .task-actions { max-width: 100%; justify-content: flex-start; gap: 8px; }
            .task-btn { flex: 1; min-width: 0; padding: 8px 12px; font-size: 0.8rem; }
            .task-btn.edit { flex: 0 0 auto; min-width: 44px; padding: 8px; }
            .task-actions.many-buttons { display: grid; grid-template-columns: auto 1fr 1fr; gap: 8px; }
            .task-actions.many-buttons .task-btn.edit { grid-row: 1 / 3; }

            .modal-content { width: 95%; padding: 15px; }
            .form-buttons { flex-direction: column; }
            .btn { width: 100%; }
            .stats-grid { grid-template-columns: 1fr; gap: 10px; }
            .stat-card { padding: 15px; }
            .stat-value { font-size: 1.2rem; }

            .tab-button { padding: 10px 4px; font-size: 0.7rem; }
            .tab-icon { font-size: 1.1rem; }
            .habit-grid, .habit-reward-rule { grid-template-columns: 1fr; }
            .analysis-table { font-size: 0.75rem; }
            .analysis-table th, .analysis-table td { padding: 8px 6px;}
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            .task-btn { font-size: 0.75rem; padding: 6px 8px; }
            .balance-amount { font-size: 1.8rem; }
            .header h1 { font-size: 1.3rem; }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { padding: 10px; }
            .balance-card { margin: 10px; padding: 15px; }
            .balance-amount { font-size: 1.8rem; }
            .fab { bottom: 80px; right: 15px; width: 48px; height: 48px; font-size: 1.2rem; }
        }

        /* ä»»åŠ¡å†å²æ¨¡æ€æ¡†æ ·å¼ */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); gap: 8px; }
        .history-item:last-child { border-bottom: none; }
        .history-info { flex: 1; }
        .history-description { font-weight: 500; margin-bottom: 2px; }
        .history-time { font-size: 0.8rem; color: #666; }
        .history-amount { font-weight: 600; font-size: 0.9rem; }
        .history-amount.positive { color: #4CAF50; }
        .history-amount.negative { color: #f44336; }
        .undo-btn { background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border: 1px solid var(--btn-secondary-border); padding: 4px 8px; font-size: 0.75rem; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
        .undo-btn:hover { opacity: 0.8; transform: translateY(-1px); }

        /* ä¸»é¢˜åˆ‡æ¢åŠ¨ç”» */
        * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }

        /* æš—è‰²ä¸»é¢˜ä¸‹çš„ç‰¹æ®Šæ ·å¼ */
        [data-theme="dark"] .modal-content, [data-theme="dark"] .settings-section, [data-theme="dark"] .stat-card, [data-theme="dark"] .report-section { background: var(--card-bg); color: var(--text-color); }
        [data-theme="dark"] .form-label, [data-theme="dark"] .settings-title, [data-theme="dark"] .report-title { color: var(--text-color); }
        [data-theme="dark"] .form-input, [data-theme="dark"] .form-select, [data-theme="dark"] .analysis-search { background: var(--input-bg); color: var(--text-color); border-color: var(--border-color); }
        [data-theme="dark"] .category-header { background: var(--card-bg); color: var(--text-color); }
        [data-theme="dark"] .category-header:hover { background: rgba(255, 255, 255, 0.1); }
        [data-theme="dark"] .bottom-tabs { background: var(--card-bg); border-top-color: var(--border-color); }
        [data-theme="dark"] .tab-button { color: #999; }
        [data-theme="dark"] .tab-button.active { color: #2196F3; background: rgba(33, 150, 243, 0.2); }
        [data-theme="dark"] .task-edit-btn:hover { background: rgba(255, 255, 255, 0.1); color: var(--text-color); }
        [data-theme="dark"] .data-btn { background: var(--card-bg); color: #2196F3; }
        [data-theme="dark"] .data-btn:hover { background: #2196F3; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ—¶é—´é“¶è¡Œ</h1>
        <p>Time Bank v3.2.1 - åˆ†æç¨³å®šç‰ˆ</p>
    </div>

    <div class="balance-card" id="balanceCard">
        <div class="balance-title">å½“å‰ä½™é¢</div>
        <div class="balance-amount" id="balanceAmount">0ç§’</div>
        <div class="daily-changes">
            <div class="daily-change">ä»Šæ—¥è·å¾—: <span id="dailyEarned">0ç§’</span></div>
            <div class="daily-change">ä»Šæ—¥æ¶ˆè´¹: <span id="dailySpent">0ç§’</span></div>
        </div>
    </div>

    <div class="tab-content active" id="earnTab">
        <div class="recent-tasks">
            <div class="section-title">æœ€è¿‘ä»»åŠ¡</div>
            <div id="recentEarnTasks"></div>
        </div>
        
        <div class="section-title">åˆ†ç±»ä»»åŠ¡</div>
        <div id="categoryEarnTasks"></div>
    </div>

    <div class="tab-content" id="spendTab">
        <div class="recent-tasks">
            <div class="section-title">æœ€è¿‘ä»»åŠ¡</div>
            <div id="recentSpendTasks"></div>
        </div>
        
        <div class="section-title">åˆ†ç±»ä»»åŠ¡</div>
        <div id="categorySpendTasks"></div>
    </div>

    <div class="tab-content" id="reportTab">
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalEarned">0ç§’</div>
                <div class="stat-label">æ€»è·å¾—æ—¶é—´</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">0ç§’</div>
                <div class="stat-label">æ€»æ¶ˆè´¹æ—¶é—´</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedTasks">0</div>
                <div class="stat-label">å·²å®Œæˆæ¬¡æ•°</div>
            </div>
        </div>

        <div class="report-section">
            <div class="report-header">
                <h2 class="report-title">æ—¶é—´æµå›¾</h2>
                <div class="report-filters" id="flowChartFilters">
                    <button class="active" data-period="7d">æœ€è¿‘7å¤©</button>
                    <button data-period="30d">æœ€è¿‘30å¤©</button>
                    <button data-period="all">å…¨éƒ¨æ—¶é—´</button>
                </div>
            </div>
            <div id="flowChartContainer" class="flow-chart-container"></div>
        </div>
        
        <div class="report-section">
            <div class="report-header">
                 <h2 class="report-title">æ´»åŠ¨æ—¥å† (æœ€è¿‘6ä¸ªæœˆ)</h2>
            </div>
            <div class="heatmap-container">
                <div id="heatmapContainer" class="heatmap-grid"></div>
            </div>
            <div class="heatmap-legend" id="heatmapLegend"></div>
        </div>

        <div class="report-section">
            <div class="report-header">
                 <h2 class="report-title">æ·±åº¦åˆ†æ</h2>
            </div>
            <div class="analysis-controls">
                <div id="analysisViewToggle">
                    <button class="active" data-view="category">æŒ‰åˆ†ç±»</button>
                    <button data-view="task">æŒ‰ä»»åŠ¡</button>
                </div>
                <input type="text" id="analysisSearch" class="analysis-search" placeholder="æœç´¢...">
            </div>
            <div class="analysis-table-container">
                <table class="analysis-table" id="analysisTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="tab-content" id="settingsTab">
        <div class="settings-section">
            <div class="settings-title">å¤–è§‚è®¾ç½®</div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">ä¸»é¢˜æ¨¡å¼</div>
                    <div class="setting-desc">é€‰æ‹©äº®è‰²ã€æš—è‰²æˆ–è·Ÿéšç³»ç»Ÿ</div>
                </div>
                <div class="theme-selector">
                    <button class="theme-option" data-theme-value="light" onclick="setTheme('light')">äº®è‰²</button>
                    <button class="theme-option" data-theme-value="dark" onclick="setTheme('dark')">æš—è‰²</button>
                    <button class="theme-option" data-theme-value="system" onclick="setTheme('system')">ç³»ç»Ÿ</button>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-title">é€šçŸ¥è®¾ç½®</div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">æˆå°±é€šçŸ¥</div>
                    <div class="setting-desc">å®Œæˆä»»åŠ¡æˆ–è¾¾æˆç›®æ ‡æ—¶æ˜¾ç¤ºé€šçŸ¥</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="achievementNotificationToggle" onchange="toggleAchievementNotifications()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">é•¿æ—¶é—´è¿è¡Œæé†’</div>
                    <div class="setting-desc">ä»»åŠ¡è¿è¡Œè¶…è¿‡è®¾å®šæ—¶é—´æ—¶æé†’</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="longRunningNotificationToggle" onchange="toggleLongRunningNotifications()">
                    <span class="slider"></span>
                </label>
                <input type="number" id="longRunningThreshold" class="threshold-input" 
                       value="3600" min="300" step="300" onchange="updateLongRunningThreshold()" 
                       placeholder="ç§’">
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">ä½™é¢ä¸è¶³æé†’</div>
                    <div class="setting-desc">ä½™é¢ä½äºè®¾å®šå€¼æ—¶æé†’</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="lowBalanceNotificationToggle" onchange="toggleLowBalanceNotifications()">
                    <span class="slider"></span>
                </label>
                <input type="number" id="lowBalanceThreshold" class="threshold-input" 
                       value="1800" min="0" step="300" onchange="updateLowBalanceThreshold()" 
                       placeholder="ç§’">
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-title">æ•°æ®ç®¡ç†</div>
            <div class="data-buttons">
                <button class="data-btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="data-btn" onclick="document.getElementById('importFile').click()">å¯¼å…¥æ•°æ®</button>
                <button class="data-btn" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
            </div>
            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
        </div>
        
        <div class="settings-section about-section">
            <div class="settings-title">å…³äº</div>
             <p><strong>ç‰ˆæœ¬ v3.2.1 (2025-10-15)</strong></p>
            <ul>
                <li><strong>ä¼˜åŒ–</strong>: ä¸ºæ´»åŠ¨æ—¥å†çƒ­å›¾å¢åŠ é¢œè‰²å›¾ä¾‹ï¼Œä½¿å…¶æ›´æ˜“ç†è§£ã€‚</li>
                <li><strong>ä¼˜åŒ–</strong>: æ·±åº¦åˆ†æè¡¨æ ¼â€œæŒ‰åˆ†ç±»â€è§†å›¾åˆå¹¶æ”¶æ”¯ä¸ºâ€œå‡€å€¼â€ï¼Œå¹¶ç”¨é¢œè‰²åŒºåˆ†ã€‚</li>
                <li><strong>æ–°åŠŸèƒ½</strong>: æ·±åº¦åˆ†æè¡¨æ ¼å¢åŠ â€œå æ¯”â€åˆ—ï¼Œæ˜¾ç¤ºå„é¡¹ç›®å¯¹æ€»æ”¶æ”¯çš„è´¡çŒ®åº¦ã€‚</li>
            </ul>
            <details>
                <summary>å†å²ç‰ˆæœ¬æ›´æ–°</summary>
                <div>
                    <p><strong>ç‰ˆæœ¬ v3.2.0 (2025-10-15)</strong></p>
                    <ul>
                        <li><strong>[é‡ç£…] æŠ¥å‘Šé¡µé¢é‡æ„ï¼š</strong>æ–°å¢äº¤äº’å¼æ—¶é—´æµå›¾ã€æ´»åŠ¨æ—¥å†çƒ­å›¾å’Œæ·±åº¦åˆ†æè¡¨æ ¼ï¼Œæä¾›å¼ºå¤§çš„æ•°æ®æ´å¯Ÿèƒ½åŠ›ã€‚</li>
                    </ul>
                     <p><strong>ç‰ˆæœ¬ v3.1.0 (2025-10-15)</strong></p>
                    <ul>
                        <li><strong>[æ–°åŠŸèƒ½] ä¹ æƒ¯ç³»ç»Ÿå¢å¼ºï¼š</strong>ç°åœ¨æ‰€æœ‰è·å¾—æ—¶é—´çš„ä»»åŠ¡ç±»å‹ï¼ˆæŒç»­å¥–åŠ±ã€è¾¾æ ‡å¥–åŠ±ï¼‰éƒ½å¯ä»¥è¢«è®¾ç½®ä¸ºä¹ æƒ¯ã€‚</li>
                        <li><strong>[æ–°åŠŸèƒ½] è¾¾æ ‡ä¹ æƒ¯ï¼š</strong>å¯¹äºâ€œè¾¾æ ‡å¥–åŠ±â€ç±»å‹çš„ä¹ æƒ¯ï¼Œåªæœ‰åœ¨è¾¾åˆ°ç›®æ ‡æ—¶é•¿åï¼Œæ‰ä¼šè®¡ä¸ºä¸€æ¬¡æˆåŠŸçš„ä¹ æƒ¯æ‰“å¡ã€‚</li>
                    </ul>
                </div>
            </details>
        </div>
    </div>

    <button class="fab" id="fabButton" onclick="showTaskModal()">+</button>

    <div class="bottom-tabs">
        <button class="tab-button active" onclick="switchTab('earn')">
            <div class="tab-icon">â°</div>
            <div>è·å¾—æ—¶é—´</div>
        </button>
        <button class="tab-button" onclick="switchTab('spend')">
            <div class="tab-icon">ğŸ¯</div>
            <div>æ¶ˆè´¹æ—¶é—´</div>
        </button>
        <button class="tab-button" onclick="switchTab('report')">
            <div class="tab-icon">ğŸ“Š</div>
            <div>æŠ¥å‘Š</div>
        </button>
        <button class="tab-button" onclick="switchTab('settings')">
            <div class="tab-icon">âš™ï¸</div>
            <div>è®¾ç½®</div>
        </button>
    </div>

    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">åˆ›å»ºæ–°ä»»åŠ¡</div>
                <button class="close-btn" onclick="hideTaskModal()">Ã—</button>
            </div>
            <form id="taskForm" onsubmit="saveTask(event)">
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡åç§° *</label>
                    <input type="text" id="taskName" class="form-input" placeholder="è¾“å…¥ä»»åŠ¡åç§°" required>
                    <div class="error-message" id="taskNameError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡åˆ†ç±» *</label>
                    <input type="text" id="taskCategory" class="form-input" placeholder="è¾“å…¥åˆ†ç±»åç§°" required>
                    <div class="recommendations" id="categoryRecommendations"></div>
                    <div class="error-message" id="taskCategoryError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡ç±»å‹ *</label>
                    <select id="taskType" class="form-select" onchange="updateFormForTaskType()" required>
                        <option value="">è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹</option>
                        <option value="reward">å›ºå®šå¥–åŠ±</option>
                        <option value="continuous">æŒç»­å¥–åŠ±</option>
                        <option value="continuous_target">è¾¾æ ‡å¥–åŠ±</option>
                        <option value="instant_redeem">å³æ—¶å…‘æ¢</option>
                        <option value="continuous_redeem">æŒç»­æ¶ˆè€—</option>
                    </select>
                    <div class="error-message" id="taskTypeError"></div>
                </div>

                <div class="form-group hidden" id="fixedTimeGroup">
                    <label class="form-label" id="fixedTimeLabel">å¥–åŠ±æ—¶é—´ (ç§’) *</label>
                    <input type="text" id="fixedTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 900)">15åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 1800)">30åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 3600)">1å°æ—¶</div>
                    </div>
                    <div class="error-message" id="fixedTimeError"></div>
                </div>

                <div class="form-group hidden" id="consumeTimeGroup">
                    <label class="form-label">æ¶ˆè´¹æ—¶é—´ (ç§’) *</label>
                    <input type="text" id="consumeTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 900)">15åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 1800)">30åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 3600)">1å°æ—¶</div>
                    </div>
                    <div class="error-message" id="consumeTimeError"></div>
                </div>

                <div class="form-group hidden" id="multiplierGroup">
                    <label class="form-label">æ—¶é—´å€ç‡ *</label>
                    <input type="text" id="multiplier" class="form-input" placeholder="ä¾‹å¦‚ï¼š1.0">
                    <div class="error-message" id="multiplierError"></div>
                </div>

                <div class="form-group hidden" id="targetTimeGroup">
                    <label class="form-label">ç›®æ ‡æ—¶é•¿ (ç§’) *</label>
                    <input type="text" id="targetTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š3600">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('targetTime', 3600)">1å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 7200)">2å°æ—¶</div>
                    </div>
                    <div class="error-message" id="targetTimeError"></div>
                </div>

                <div class="form-group hidden" id="bonusRewardGroup">
                    <label class="form-label">é¢å¤–å¥–åŠ± (ç§’)</label>
                    <input type="text" id="bonusReward" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800ï¼Œå¯ä¸å¡«">
                     <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 900)">15åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 1800)">30åˆ†é’Ÿ</div>
                    </div>
                    <div class="error-message" id="bonusRewardError"></div>
                </div>

                <div class="form-group hidden" id="habitToggleContainer">
                    <div class="setting-item" style="padding: 0;">
                        <div class="setting-info">
                            <div class="setting-name">è®¾ç½®ä¸ºä¹ æƒ¯</div>
                            <div class="setting-desc">å¼€å¯è¿ç»­æ‰“å¡å’Œé¢å¤–å¥–åŠ±</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="isHabitToggle" onchange="toggleHabitSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="habit-settings hidden" id="habitSettingsGroup">
                    <div class="habit-settings-title">ä¹ æƒ¯è®¾ç½®</div>
                    <div class="habit-grid">
                        <div class="form-group">
                            <label class="form-label">å‘¨æœŸ</label>
                            <select id="habitPeriod" class="form-select">
                                <option value="daily">æ¯å¤©</option>
                                <option value="weekly">æ¯å‘¨</option>
                                <option value="monthly">æ¯æœˆ</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label class="form-label">æ—¶é•¿</label>
                            <div style="display: flex; gap: 5px;">
                                <select id="habitDurationType" class="form-select" onchange="toggleHabitDurationInput()">
                                    <option value="infinite">æ— é™</option>
                                    <option value="days">æŒç»­å¤©æ•°</option>
                                    <option value="weeks">æŒç»­å‘¨æ•°</option>
                                </select>
                                <input type="number" id="habitDurationValue" class="form-input hidden" placeholder="å¤©æ•°">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ä¹ æƒ¯å¥–åŠ± (å¯æ·»åŠ å¤šä¸ª)</label>
                        <div id="habitRewardsContainer"></div>
                        <button type="button" class="btn btn-secondary" style="width: 100%; padding: 8px; margin-top: 10px;" onclick="addHabitRewardRule()">+ æ·»åŠ å¥–åŠ±è§„åˆ™</button>
                    </div>
                </div>


                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">åˆ›å»ºä»»åŠ¡</button>
                    <button type="button" class="btn btn-danger hidden" id="deleteBtn" onclick="deleteTask()">åˆ é™¤ä»»åŠ¡</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="historyModalTitle">ä»»åŠ¡å†å²</div>
                <button class="close-btn" onclick="hideHistoryModal()">Ã—</button>
            </div>
            <div id="historyContent">
                <div class="empty-message">æš‚æ— å†å²è®°å½•</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentBalance = 0;
        let tasks = [];
        let transactions = [];
        let categoryColors = new Map();
        let collapsedCategories = new Set();
        let runningTasks = new Map();
        let currentEditingTask = null;
        let timerInterval = null;
        let dailyChanges = {};
        let currentHistoryTask = null;

        // æŠ¥å‘Šé¡µçŠ¶æ€
        let reportState = {
            flowChartPeriod: '7d',
            analysisView: 'category',
            analysisSearchTerm: '',
            analysisSort: {
                column: 'net',
                direction: 'desc'
            }
        };
        
        // é€šçŸ¥è®¾ç½®
        let notificationSettings = {
            achievement: true,
            longRunning: true,
            longRunningThreshold: 3600,
            lowBalance: true,
            lowBalanceThreshold: 1800
        };

        // é¢œè‰²é…ç½®
        const colors = [
            '#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#F44336',
            '#00BCD4', '#8BC34A', '#FFC107', '#E91E63', '#607D8B',
            '#3F51B5', '#009688', '#CDDC39', '#795548', '#FF5722'
        ];

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            loadData();
            updateAllUI();
            updateCategoryRecommendations();
            updateNotificationSettingsUI();
            startGlobalTimer();
            if ('Notification' in window && notificationSettings.achievement && Notification.permission === 'default') {
                requestNotificationPermission();
            }
            setupReportEventListeners();
        }

        // å¯åŠ¨å…¨å±€è®¡æ—¶å™¨
        function startGlobalTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => updateRunningTimers(), 1000);
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.closest('.tab-button').classList.add('active');
            document.getElementById('fabButton').style.display = (tabName === 'report' || tabName === 'settings') ? 'none' : 'block';
            if (tabName === 'report') {
                updateAllReports();
            }
        }

        // æ›´æ–°æœ€è¿‘ä»»åŠ¡
        function updateRecentTasks() {
            const earnTasks = tasks.filter(t => ['reward', 'continuous', 'continuous_target'].includes(t.type));
            const spendTasks = tasks.filter(t => ['instant_redeem', 'continuous_redeem'].includes(t.type));
            const sortByLastUsed = (taskList) => [...taskList].sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0)).slice(0, 6);
            renderTaskList('recentEarnTasks', sortByLastUsed(earnTasks));
            renderTaskList('recentSpendTasks', sortByLastUsed(spendTasks));
        }

        // æ›´æ–°åˆ†ç±»ä»»åŠ¡
        function updateCategoryTasks() {
            const earnTasks = tasks.filter(t => ['reward', 'continuous', 'continuous_target'].includes(t.type));
            const spendTasks = tasks.filter(t => ['instant_redeem', 'continuous_redeem'].includes(t.type));
            renderCategoryTasks('categoryEarnTasks', groupTasksByCategory(earnTasks));
            renderCategoryTasks('categorySpendTasks', groupTasksByCategory(spendTasks));
        }

        // æŒ‰åˆ†ç±»åˆ†ç»„ä»»åŠ¡
        function groupTasksByCategory(taskList) {
            return taskList.reduce((acc, task) => {
                (acc[task.category] = acc[task.category] || []).push(task);
                return acc;
            }, {});
        }

        // æ¸²æŸ“åˆ†ç±»ä»»åŠ¡
        function renderCategoryTasks(containerId, tasksByCategory) {
            const container = document.getElementById(containerId);
            if (Object.keys(tasksByCategory).length === 0) {
                container.innerHTML = '<div class="empty-message">æš‚æ— ä»»åŠ¡</div>';
                return;
            }
            container.innerHTML = Object.entries(tasksByCategory).map(([category, categoryTasks]) => {
                const isCollapsed = collapsedCategories.has(category);
                const color = categoryColors.get(category) || '#666';
                categoryTasks.sort((a, b) => (b.isHabit ? 1 : 0) - (a.isHabit ? 1 : 0));
                return `
                    <div class="category-tasks">
                        <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${category}')">
                            <div class="category-info">
                                <div class="category-color" style="background-color: ${color}"></div>
                                <div class="category-name">${category}</div>
                                <div class="category-count">(${categoryTasks.length})</div>
                            </div>
                            <div class="category-toggle">â–¼</div>
                        </div>
                        <div class="category-tasks-list ${isCollapsed ? 'collapsed' : ''}">
                            <div class="category-tasks-grid">${renderTaskCards(categoryTasks, true)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTaskList(containerId, taskList) {
            const container = document.getElementById(containerId);
            if (taskList.length === 0) {
                container.innerHTML = '<div class="empty-message">æš‚æ— æœ€è¿‘ä»»åŠ¡</div>';
                return;
            }
            const content = renderTaskCards(taskList, true);
            container.innerHTML = (containerId === 'recentEarnTasks' || containerId === 'recentSpendTasks') ? `<div class="recent-tasks-grid">${content}</div>` : content;
        }

        // æ¸²æŸ“ä»»åŠ¡å¡ç‰‡
        function renderTaskCards(taskList, isCompact = false) {
            return taskList.map(task => {
                const runningTask = runningTasks.get(task.id);
                const isRunning = !!runningTask;
                const isPaused = runningTask?.isPaused;
                const color = categoryColors.get(task.category) || '#666';
                
                let detailsHtml = `<span class="task-category" style="background-color: ${color}">${task.category}</span>`;
                if (task.isHabit) {
                    const unitMap = { daily: 'å¤©', weekly: 'å‘¨', monthly: 'æœˆ' };
                    const streak = task.habitDetails.streak || 0;
                    const periodText = unitMap[task.habitDetails.period] || 'æ¬¡';
                    detailsHtml += ` <span class="task-completion-count">å·²è¿ç»­ ${streak} ${periodText}</span>`;
                } else if ((task.completionCount || 0) > 0) {
                    detailsHtml += ` <span class="task-completion-count">å·²å®Œæˆ ${task.completionCount} æ¬¡</span>`;
                }
                
                let actionsHtml = '';
                let progressHtml = '';
                
                if (task.type === 'reward') {
                    detailsHtml += ` â€¢ å¥–åŠ± ${formatTime(task.fixedTime)}`;
                    actionsHtml = `<button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button><button class="task-btn success" onclick="completeTask('${task.id}')">å®Œæˆ</button>`;
                } else if (['continuous', 'continuous_redeem', 'continuous_target'].includes(task.type)) {
                    detailsHtml += ` â€¢ ${task.multiplier}å€ç‡` + (task.type.includes('redeem') ? 'æ¶ˆè€—' : '');
                    if (task.type === 'continuous_target') detailsHtml += ` â€¢ ç›®æ ‡ ${formatTime(task.targetTime).replace(/0ç§’$/, '').trim()}`;

                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        if (isPaused) {
                            actionsHtml = `<button class="task-btn primary icon-btn" onclick="resumeTask('${task.id}')" title="ç»§ç»­">â–¶ï¸</button><button class="task-btn secondary icon-btn" onclick="cancelTask('${task.id}')" title="å–æ¶ˆ">âŒ</button><button class="task-btn danger icon-btn" onclick="stopTask('${task.id}')" title="ç»“æŸ">â¹ï¸</button>`;
                            progressHtml = `<div class="task-timer">å·²æš‚åœï¼š${formatTime(totalSeconds)}</div>`;
                        } else {
                            actionsHtml = `<button class="task-btn warning icon-btn" onclick="pauseTask('${task.id}')" title="æš‚åœ">â¸ï¸</button><button class="task-btn secondary icon-btn" onclick="cancelTask('${task.id}')" title="å–æ¶ˆ">âŒ</button><button class="task-btn danger icon-btn" onclick="stopTask('${task.id}')" title="ç»“æŸ">â¹ï¸</button>`;
                            progressHtml = `<div class="task-timer">è¿è¡Œä¸­ï¼š${formatTime(totalSeconds)}</div>`;
                        }
                        if (task.type === 'continuous_target') {
                            const progress = Math.min((totalSeconds / task.targetTime) * 100, 100);
                            progressHtml += `<div class="task-progress">è¿›åº¦ï¼š${progress.toFixed(1)}% ${runningTask.achieved ? 'âœ… å·²è¾¾æ ‡' : ''}</div>`;
                        }
                    } else {
                        actionsHtml = `<button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button><button class="task-btn primary" onclick="startTask('${task.id}')">å¼€å§‹</button>`;
                    }
                } else if (task.type === 'instant_redeem') {
                    detailsHtml += ` â€¢ æ¶ˆè´¹ ${formatTime(task.consumeTime)}`;
                    actionsHtml = `<button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button><button class="task-btn danger" onclick="redeemTask('${task.id}')">å…‘æ¢</button>`;
                }
                
                const compactClass = isCompact ? 'compact' : '';
                const habitClass = task.isHabit ? 'is-habit' : '';
                const habitStyle = task.isHabit ? `style="--habit-color: ${color}"` : '';

                return `
                    <div class="task-card ${compactClass} ${habitClass}" ${habitStyle}>
                        <div class="task-header">
                            <div class="task-info">
                                <div class="task-name"><span class="task-name-text" title="${task.name}">${task.name}</span><button class="task-edit-btn" onclick="editTask(tasks.find(t => t.id === '${task.id}'))" title="ç¼–è¾‘">âœï¸</button></div>
                                <div class="task-details">${detailsHtml}</div>
                            </div>
                            <div class="task-actions ${compactClass}">${actionsHtml}</div>
                        </div>
                        ${progressHtml}
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°è¿è¡Œä¸­çš„è®¡æ—¶å™¨
        function updateRunningTimers() {
            let hasChanges = false;
            runningTasks.forEach((runningTask, taskId) => {
                if (runningTask.isPaused) return;
                hasChanges = true;
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    const totalSeconds = Math.floor((runningTask.elapsedTime + Date.now() - runningTask.startTime)) / 1000;
                    if (task.type === 'continuous_target' && !runningTask.achieved && totalSeconds >= task.targetTime) {
                        runningTask.achieved = true;
                        showNotification('ğŸ¯ è¾¾æ ‡æé†’', `ä»»åŠ¡"${task.name}"å·²è¾¾åˆ°ç›®æ ‡æ—¶é—´ï¼`, 'achievement');
                    }
                    if (notificationSettings.longRunning && totalSeconds > 0 && totalSeconds % notificationSettings.longRunningThreshold === 0) {
                        showNotification('â° é•¿æ—¶é—´è¿è¡Œæé†’', `ä»»åŠ¡"${task.name}"å·²è¿è¡Œ${formatTime(totalSeconds)}`, 'longRunning');
                    }
                }
            });
            if (hasChanges) {
                updateRecentTasks();
                updateCategoryTasks();
            }
        }

        // åˆ‡æ¢åˆ†ç±»æŠ˜å çŠ¶æ€
        function toggleCategory(category) {
            collapsedCategories.has(category) ? collapsedCategories.delete(category) : collapsedCategories.add(category);
            saveData();
            updateCategoryTasks();
        }

        // æ˜¾ç¤º/éšè— ä»»åŠ¡æ¨¡æ€æ¡†
        function showTaskModal() {
            currentEditingTask = null;
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºæ–°ä»»åŠ¡';
            document.getElementById('submitBtn').textContent = 'åˆ›å»ºä»»åŠ¡';
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('taskForm').reset();
            updateFormForTaskType();
            toggleHabitSettings(false);
            document.getElementById('habitRewardsContainer').innerHTML = '';
            document.getElementById('taskModal').classList.add('show');
        }

        function hideTaskModal() {
            document.getElementById('taskModal').classList.remove('show');
            clearFormErrors();
        }

        // ç¼–è¾‘ä»»åŠ¡
        function editTask(task) {
            currentEditingTask = task;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ä»»åŠ¡';
            document.getElementById('submitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
            document.getElementById('deleteBtn').classList.remove('hidden');
            
            const form = document.getElementById('taskForm');
            form.taskName.value = task.name;
            form.taskCategory.value = task.category;
            form.taskType.value = task.type;
            if (task.fixedTime) form.fixedTime.value = task.fixedTime;
            if (task.consumeTime) form.consumeTime.value = task.consumeTime;
            if (task.multiplier) form.multiplier.value = task.multiplier;
            if (task.targetTime) form.targetTime.value = task.targetTime;
            if (task.bonusReward) form.bonusReward.value = task.bonusReward;
            
            document.getElementById('isHabitToggle').checked = task.isHabit || false;
            
            if (task.isHabit && task.habitDetails) {
                document.getElementById('habitPeriod').value = task.habitDetails.period;
                document.getElementById('habitDurationType').value = task.habitDetails.duration.type;
                if (task.habitDetails.duration.type !== 'infinite') {
                    document.getElementById('habitDurationValue').value = task.habitDetails.duration.value;
                }
                const rewardsContainer = document.getElementById('habitRewardsContainer');
                rewardsContainer.innerHTML = '';
                task.habitDetails.rewards.forEach(rule => addHabitRewardRule(rule));
            } else {
                 document.getElementById('habitRewardsContainer').innerHTML = '';
            }
            
            updateFormForTaskType();
            toggleHabitSettings(task.isHabit);
            toggleHabitDurationInput();

            document.getElementById('taskModal').classList.add('show');
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask() {
            if (!currentEditingTask) return;
            if (confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${currentEditingTask.name}"å—ï¼Ÿ`)) {
                runningTasks.delete(currentEditingTask.id);
                tasks = tasks.filter(t => t.id !== currentEditingTask.id);
                saveData();
                updateAllUI();
                hideTaskModal();
            }
        }
        
        // æ›´æ–°æ‰€æœ‰UI
        function updateAllUI() {
            updateRecentTasks();
            updateCategoryTasks();
            updateBalance();
            updateSummaryStats();
        }

        // æ›´æ–°è¡¨å•å­—æ®µæ˜¾ç¤º
        function updateFormForTaskType() {
            const taskType = document.getElementById('taskType').value;
            const earnTypes = ['reward', 'continuous', 'continuous_target'];
            document.querySelectorAll('#taskForm .form-group[id$="Group"]').forEach(el => el.classList.add('hidden'));
            const habitToggle = document.getElementById('habitToggleContainer');
            
            if (earnTypes.includes(taskType)) {
                habitToggle.classList.remove('hidden');
            } else {
                habitToggle.classList.add('hidden');
                document.getElementById('isHabitToggle').checked = false;
                toggleHabitSettings(false);
            }

            switch (taskType) {
                case 'reward': document.getElementById('fixedTimeGroup').classList.remove('hidden'); break;
                case 'continuous': document.getElementById('multiplierGroup').classList.remove('hidden'); break;
                case 'continuous_target': ['multiplierGroup', 'targetTimeGroup', 'bonusRewardGroup'].forEach(id => document.getElementById(id).classList.remove('hidden')); break;
                case 'instant_redeem': document.getElementById('consumeTimeGroup').classList.remove('hidden'); break;
                case 'continuous_redeem': document.getElementById('multiplierGroup').classList.remove('hidden'); break;
            }
        }

        // åˆ‡æ¢ä¹ æƒ¯è®¾ç½®æ˜¾ç¤º
        function toggleHabitSettings(forceState) {
            const isHabit = typeof forceState === 'boolean' ? forceState : document.getElementById('isHabitToggle').checked;
            document.getElementById('habitSettingsGroup').classList.toggle('hidden', !isHabit);
            const fixedTimeLabel = document.getElementById('fixedTimeLabel');
            if(fixedTimeLabel) {
                fixedTimeLabel.textContent = isHabit ? 'åŸºç¡€å¥–åŠ± (ç§’) *' : 'å¥–åŠ±æ—¶é—´ (ç§’) *';
            }
        }
        
        function toggleHabitDurationInput() {
            const durationType = document.getElementById('habitDurationType').value;
            const valueInput = document.getElementById('habitDurationValue');
            valueInput.classList.toggle('hidden', durationType === 'infinite');
            valueInput.placeholder = durationType === 'days' ? 'å¤©æ•°' : 'å‘¨æ•°';
        }

        function addHabitRewardRule(rule = null) {
            const container = document.getElementById('habitRewardsContainer');
            const ruleDiv = document.createElement('div');
            ruleDiv.className = 'habit-reward-rule';
            const type = rule ? rule.type : 'fixed';
            const start = rule ? rule.start : 1;
            const value = rule ? rule.value : '';
            ruleDiv.innerHTML = `
                <select class="form-select reward-type">
                    <option value="fixed" ${type === 'fixed' ? 'selected' : ''}>å›ºå®šå¥–åŠ±</option>
                    <option value="incremental" ${type === 'incremental' ? 'selected' : ''}>é€’å¢å¥–åŠ±</option>
                </select>
                <input type="number" class="form-input reward-start" placeholder="ä»ç¬¬ N å‘¨æœŸ" value="${start}" min="1">
                <input type="number" class="form-input reward-value" placeholder="å¥–åŠ±å€¼(ç§’)" value="${value}">
                <button type="button" class="remove-reward-btn" onclick="this.parentElement.remove()">-</button>
            `;
            container.appendChild(ruleDiv);
        }

        // è®¾ç½®æ—¶é—´é¢„è®¾å€¼
        function setTimePreset(fieldId, seconds) {
            document.getElementById(fieldId).value = seconds;
        }

        // ä¿å­˜ä»»åŠ¡
        function saveTask(event) {
            event.preventDefault();
            clearFormErrors();
            const formData = { name: document.getElementById('taskName').value.trim(), category: document.getElementById('taskCategory').value.trim(), type: document.getElementById('taskType').value, isHabit: document.getElementById('isHabitToggle').checked };
            let hasError = !formData.name || !formData.category || !formData.type;
            if (!formData.name) showFieldError('taskName', 'è¯·è¾“å…¥ä»»åŠ¡åç§°');
            if (!formData.category) showFieldError('taskCategory', 'è¯·è¾“å…¥ä»»åŠ¡åˆ†ç±»');
            if (!formData.type) showFieldError('taskType', 'è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹');
            
            const parseAndValidate = (id, fieldName, isFloat = false) => {
                const input = document.getElementById(id);
                const value = isFloat ? parseFloat(input.value) : parseInt(input.value);
                if (isNaN(value) || value <= 0) { showFieldError(id, `è¯·è¾“å…¥æœ‰æ•ˆçš„${fieldName}`); hasError = true; }
                return value;
            };
            const parseAndValidateOptional = (id, fieldName) => {
                const input = document.getElementById(id);
                if (!input.value) return 0;
                const value = parseInt(input.value);
                if (isNaN(value) || value < 0) { showFieldError(id, `è¯·è¾“å…¥æœ‰æ•ˆçš„${fieldName}`); hasError = true; }
                return value;
            }
            
            switch (formData.type) {
                case 'reward': formData.fixedTime = parseAndValidate('fixedTime', 'å¥–åŠ±æ—¶é—´'); break;
                case 'instant_redeem': formData.consumeTime = parseAndValidate('consumeTime', 'æ¶ˆè´¹æ—¶é—´'); break;
                case 'continuous': case 'continuous_redeem': formData.multiplier = parseAndValidate('multiplier', 'æ—¶é—´å€ç‡', true); break;
                case 'continuous_target':
                    formData.multiplier = parseAndValidate('multiplier', 'æ—¶é—´å€ç‡', true);
                    formData.targetTime = parseAndValidate('targetTime', 'ç›®æ ‡æ—¶é•¿');
                    formData.bonusReward = parseAndValidateOptional('bonusReward', 'é¢å¤–å¥–åŠ±');
                    break;
            }

            if (formData.isHabit) {
                formData.habitDetails = { period: document.getElementById('habitPeriod').value, duration: { type: document.getElementById('habitDurationType').value, value: document.getElementById('habitDurationValue').value ? parseInt(document.getElementById('habitDurationValue').value) : 0 }, rewards: [] };
                if (formData.habitDetails.duration.type !== 'infinite' && formData.habitDetails.duration.value <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŒç»­æ—¶é•¿'); hasError = true; }
                document.querySelectorAll('.habit-reward-rule').forEach(ruleEl => {
                    const type = ruleEl.querySelector('.reward-type').value;
                    const start = parseInt(ruleEl.querySelector('.reward-start').value);
                    const value = parseInt(ruleEl.querySelector('.reward-value').value);
                    if (!isNaN(start) && start > 0 && !isNaN(value) && value > 0) { formData.habitDetails.rewards.push({ type, start, value }); } 
                    else { alert('ä¹ æƒ¯å¥–åŠ±è§„åˆ™å¡«å†™ä¸å®Œæ•´æˆ–æ— æ•ˆ'); hasError = true; }
                });
            }
            if (hasError) return;
            
            if (currentEditingTask) {
                if (currentEditingTask.isHabit && !formData.isHabit) { delete currentEditingTask.habitDetails; } 
                else if (!currentEditingTask.isHabit && formData.isHabit) { formData.habitDetails.streak = 0; formData.habitDetails.lastCompletionDate = null; } 
                else if (currentEditingTask.isHabit && formData.isHabit) { formData.habitDetails.streak = currentEditingTask.habitDetails.streak; formData.habitDetails.lastCompletionDate = currentEditingTask.habitDetails.lastCompletionDate; }
                Object.assign(currentEditingTask, formData);
            } else {
                const newTask = { id: Date.now().toString(), ...formData, completionCount: 0, lastUsed: 0 };
                if (newTask.isHabit) { newTask.habitDetails.streak = 0; newTask.habitDetails.lastCompletionDate = null; }
                tasks.push(newTask);
            }
            
            if (!categoryColors.has(formData.category)) {
                const usedColors = Array.from(categoryColors.values());
                const newColor = colors.find(c => !usedColors.includes(c)) || colors[Math.floor(Math.random() * colors.length)];
                categoryColors.set(formData.category, newColor);
            }
            
            saveData();
            updateAllUI();
            updateCategoryRecommendations();
            hideTaskModal();
        }

        // æ˜¾ç¤º/æ¸…é™¤ è¡¨å•é”™è¯¯
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            field.classList.add('error');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }
        function clearFormErrors() {
            document.querySelectorAll('.form-input.error, .form-select.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message.show').forEach(el => el.classList.remove('show'));
        }

        // å®Œæˆä»»åŠ¡ (å›ºå®šå¥–åŠ±)
        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            if (task.isHabit) { completeHabitTask(task, task.fixedTime); } 
            else { completeNormalTask(task); }
        }
        // å®Œæˆæ™®é€šä»»åŠ¡ (éä¹ æƒ¯)
        function completeNormalTask(task) {
            currentBalance += task.fixedTime;
            task.completionCount = (task.completionCount || 0) + 1;
            task.lastUsed = Date.now();
            addTransaction({ type: 'earn', taskId: task.id, taskName: task.name, amount: task.fixedTime, description: `å®Œæˆä»»åŠ¡: ${task.name}` });
            updateDailyChanges('earned', task.fixedTime);
            saveData();
            updateAllUI();
            showNotification('ğŸ‰ ä»»åŠ¡å®Œæˆ', `è·å¾— ${formatTime(task.fixedTime)} æ—¶é—´å¥–åŠ±ï¼`, 'achievement');
        }
        // å®Œæˆä¹ æƒ¯ä»»åŠ¡ (é€šç”¨å‡½æ•°)
        function completeHabitTask(task, baseReward, descriptionDetails = '') {
            checkHabitStreak(task);
            task.habitDetails.streak++;
            task.habitDetails.lastCompletionDate = new Date().toISOString().split('T')[0];
            let habitBonusReward = 0;
            task.habitDetails.rewards.forEach(rule => {
                if (task.habitDetails.streak >= rule.start) {
                    habitBonusReward += (rule.type === 'fixed') ? rule.value : (rule.value * task.habitDetails.streak);
                }
            });
            const totalReward = baseReward + habitBonusReward;
            const bonusDescription = habitBonusReward > 0 ? ` (å«ä¹ æƒ¯å¥–åŠ± ${formatTime(habitBonusReward)})` : '';
            currentBalance += totalReward;
            task.completionCount = (task.completionCount || 0) + 1;
            task.lastUsed = Date.now();
            addTransaction({ type: 'earn', taskId: task.id, taskName: task.name, amount: totalReward, description: `å®Œæˆä¹ æƒ¯: ${task.name}${descriptionDetails}${bonusDescription}` });
            updateDailyChanges('earned', totalReward);
            saveData();
            updateAllUI();
            const unitMap = { daily: 'å¤©', weekly: 'å‘¨', monthly: 'æœˆ' };
            const periodText = unitMap[task.habitDetails.period] || 'æ¬¡';
            showNotification('â­ ä¹ æƒ¯å·²å®Œæˆ!', `è¿ç»­${task.habitDetails.streak}${periodText}! è·å¾— ${formatTime(totalReward)} æ—¶é—´`, 'achievement');
        }
        // æ£€æŸ¥ä¹ æƒ¯è¿ç»­æ€§
        function checkHabitStreak(task) {
            const { lastCompletionDate, period } = task.habitDetails;
            if (!lastCompletionDate) return;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const lastDate = new Date(lastCompletionDate); lastDate.setHours(0, 0, 0, 0);
            let isBroken = false;
            const diffDays = (today - lastDate) / 86400000;

            if (period === 'daily' && diffDays > 1) isBroken = true;
            else if (period === 'weekly') {
                const todayDay = today.getDay() === 0 ? 7 : today.getDay();
                const startOfThisWeek = new Date(today.getTime() - (todayDay - 1) * 86400000);
                if (lastDate < startOfThisWeek && diffDays > 7) isBroken = true;
            } else if (period === 'monthly') {
                const isDifferentMonth = today.getFullYear() > lastDate.getFullYear() || today.getMonth() > lastDate.getMonth();
                const isConsecutiveMonth = today.getFullYear() === lastDate.getFullYear() && today.getMonth() === lastDate.getMonth() + 1;
                if (isDifferentMonth && !isConsecutiveMonth) isBroken = true;
            }
            if (isBroken) {
                task.habitDetails.streak = 0;
                showNotification('â— ä¹ æƒ¯ä¸­æ–­', `"${task.name}" è¿ç»­çºªå½•å·²ä¸­æ–­`, 'achievement');
            }
        }
        // å¼€å§‹/æš‚åœ/ç»§ç»­/å–æ¶ˆ/ç»“æŸ è¿ç»­ä»»åŠ¡
        function startTask(taskId) { runningTasks.set(taskId, { startTime: Date.now(), elapsedTime: 0, isPaused: false, achieved: false }); saveData(); updateRecentTasks(); updateCategoryTasks(); showNotification('â–¶ï¸ ä»»åŠ¡å¼€å§‹', `å¼€å§‹æ‰§è¡Œä»»åŠ¡: ${tasks.find(t=>t.id===taskId).name}`, 'achievement'); }
        function pauseTask(taskId) { const r = runningTasks.get(taskId); if (!r || r.isPaused) return; r.elapsedTime += Date.now() - r.startTime; r.isPaused = true; saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function resumeTask(taskId) { const r = runningTasks.get(taskId); if (!r || !r.isPaused) return; r.startTime = Date.now(); r.isPaused = false; saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function cancelTask(taskId) { runningTasks.delete(taskId); saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function stopTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const runningTask = runningTasks.get(taskId);
            if (!task || !runningTask) return;

            const totalSeconds = Math.floor((runningTask.elapsedTime + (runningTask.isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
            runningTasks.delete(taskId);
            task.lastUsed = Date.now();

            if (totalSeconds > 0) {
                if (['continuous', 'continuous_target'].includes(task.type)) {
                    let baseEarnedTime = Math.floor(totalSeconds * task.multiplier);
                    let earnedTimeDescription = ` (${formatTime(totalSeconds)} Ã— ${task.multiplier})`;
                    if (task.type === 'continuous_target' && (runningTask.achieved || totalSeconds >= task.targetTime)) {
                        baseEarnedTime += task.bonusReward;
                        if (task.bonusReward > 0) earnedTimeDescription += ` + ${formatTime(task.bonusReward)} è¾¾æ ‡å¥–åŠ±`;
                    }
                    const habitConditionMet = task.isHabit && (task.type === 'continuous' || (task.type === 'continuous_target' && totalSeconds >= task.targetTime));
                    if (habitConditionMet) {
                        completeHabitTask(task, baseEarnedTime, earnedTimeDescription);
                    } else {
                        currentBalance += baseEarnedTime;
                        task.completionCount = (task.completionCount || 0) + 1;
                        addTransaction({ type: 'earn', taskId: task.id, taskName: task.name, amount: baseEarnedTime, description: `ä»»åŠ¡: ${task.name}${earnedTimeDescription}` });
                        updateDailyChanges('earned', baseEarnedTime);
                        showNotification('ğŸ‰ ä»»åŠ¡å®Œæˆ', `è·å¾— ${formatTime(baseEarnedTime)} æ—¶é—´å¥–åŠ±ï¼`, 'achievement');
                    }
                } else if (task.type === 'continuous_redeem') {
                    const spentTime = Math.floor(totalSeconds * task.multiplier);
                    currentBalance -= spentTime;
                    task.completionCount = (task.completionCount || 0) + 1;
                    addTransaction({ type: 'spend', taskId: task.id, taskName: task.name, amount: spentTime, description: `è¿ç»­æ¶ˆè´¹: ${task.name} (${formatTime(totalSeconds)} Ã— ${task.multiplier})` });
                    updateDailyChanges('spent', spentTime);
                    showNotification('ğŸ’¸ ä»»åŠ¡æ¶ˆè´¹', `æ¶ˆè´¹ ${formatTime(spentTime)} æ—¶é—´`, 'achievement');
                }
            }
            saveData();
            updateAllUI();
        }
        // å…‘æ¢å³æ—¶æ¶ˆè´¹ä»»åŠ¡
        function redeemTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            if (currentBalance < task.consumeTime) return alert('ä½™é¢ä¸è¶³ï¼Œæ— æ³•å…‘æ¢æ­¤é¡¹ç›®');
            if (!confirm(`ç¡®å®šè¦æ¶ˆè´¹ ${formatTime(task.consumeTime)} å…‘æ¢"${task.name}"å—ï¼Ÿ`)) return;
            currentBalance -= task.consumeTime;
            task.completionCount = (task.completionCount || 0) + 1;
            task.lastUsed = Date.now();
            addTransaction({ type: 'spend', taskId: task.id, taskName: task.name, amount: task.consumeTime, description: `å…‘æ¢é¡¹ç›®: ${task.name}` });
            updateDailyChanges('spent', task.consumeTime);
            saveData();
            updateAllUI();
            showNotification('ğŸ å…‘æ¢æˆåŠŸ', `æˆåŠŸå…‘æ¢: ${task.name}`, 'achievement');
        }

        // æ˜¾ç¤ºä»»åŠ¡å†å²
        function showTaskHistory(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            currentHistoryTask = task;
            document.getElementById('historyModalTitle').textContent = `${task.name} - å†å²è®°å½•`;
            const taskTransactions = transactions.filter(t => t.taskId === taskId).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const historyContent = document.getElementById('historyContent');
            if (taskTransactions.length === 0) {
                historyContent.innerHTML = '<div class="empty-message">æš‚æ— å†å²è®°å½•</div>';
            } else {
                historyContent.innerHTML = taskTransactions.map(transaction => {
                    const isPositive = transaction.type === 'earn';
                    return `
                        <div class="history-item" id="history-item-${transaction.id}">
                            <div class="history-info">
                                <div class="history-description">${transaction.description}</div>
                                <div class="history-time">${formatDateTime(transaction.timestamp)}</div>
                            </div>
                            <div class="history-amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : '-'}${formatTime(transaction.amount)}</div>
                            <button class="undo-btn" onclick="undoTransaction('${transaction.id}')" title="æ’¤å›æ­¤æ¡è®°å½•">æ’¤å›</button>
                        </div>
                    `;
                }).join('');
            }
            document.getElementById('historyModal').classList.add('show');
        }
        // æ’¤å›äº¤æ˜“
        function undoTransaction(transactionId) {
            const transactionIndex = transactions.findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) return;
            const transaction = transactions[transactionIndex];
            if (!confirm(`ç¡®å®šè¦æ’¤å›è¿™æ¡è®°å½•å—ï¼Ÿ\n\næè¿°: ${transaction.description}\né‡‘é¢: ${transaction.type === 'earn' ? '+' : '-'}${formatTime(transaction.amount)}\n\næ­¤æ“ä½œå°†å½±å“æ€»ä½™é¢ã€æ¯æ—¥ç»Ÿè®¡å’Œä»»åŠ¡å®Œæˆæ¬¡æ•°ï¼Œä¸”æ— æ³•æ¢å¤ã€‚`)) return;

            if (transaction.type === 'earn') {
                currentBalance -= transaction.amount;
                updateDailyChanges('earned', -transaction.amount, new Date(transaction.timestamp));
            } else {
                currentBalance += transaction.amount;
                updateDailyChanges('spent', -transaction.amount, new Date(transaction.timestamp));
            }
            const task = tasks.find(t => t.id === transaction.taskId);
            if (task && task.completionCount > 0) task.completionCount--;
            transactions.splice(transactionIndex, 1);
            saveData();
            updateAllUI();

            const historyItemElement = document.getElementById(`history-item-${transactionId}`);
            if (historyItemElement) {
                historyItemElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                historyItemElement.style.opacity = '0';
                historyItemElement.style.transform = 'translateX(20px)';
                setTimeout(() => {
                    historyItemElement.remove();
                    if (!document.getElementById('historyContent').querySelector('.history-item')) {
                        document.getElementById('historyContent').innerHTML = '<div class="empty-message">æš‚æ— å†å²è®°å½•</div>';
                    }
                }, 300);
            }
            showNotification('â†©ï¸ æ“ä½œå·²æ’¤å›', `æˆåŠŸæ’¤å›è®°å½•: ${transaction.taskName}`, 'achievement');
        }
        function hideHistoryModal() { document.getElementById('historyModal').classList.remove('show'); currentHistoryTask = null; }

        // æ·»åŠ äº¤æ˜“è®°å½•
        function addTransaction(transaction) { transaction.timestamp = new Date().toISOString(); transaction.id = Date.now().toString() + Math.random().toString(36).substr(2, 9); transactions.unshift(transaction); if (transactions.length > 1000) transactions.pop(); }
        // æ›´æ–°æ¯æ—¥å˜åŒ–
        function updateDailyChanges(type, amount, date = new Date()) { const dateString = date.toDateString(); if (!dailyChanges[dateString]) dailyChanges[dateString] = { earned: 0, spent: 0 }; dailyChanges[dateString][type] += amount; }
        // æ›´æ–°ä½™é¢æ˜¾ç¤º
        function updateBalance() {
            const balanceCard = document.getElementById('balanceCard');
            const balanceAmount = document.getElementById('balanceAmount');
            balanceAmount.textContent = formatTime(currentBalance);
            balanceCard.classList.toggle('negative', currentBalance < 0);
            balanceAmount.style.color = currentBalance < 0 ? '#f44336' : (currentBalance < notificationSettings.lowBalanceThreshold ? '#FF9800' : '#2196F3');
            const todayChanges = dailyChanges[new Date().toDateString()] || { earned: 0, spent: 0 };
            document.getElementById('dailyEarned').textContent = formatTime(todayChanges.earned);
            document.getElementById('dailySpent').textContent = formatTime(todayChanges.spent);
            if (notificationSettings.lowBalance && currentBalance >= 0 && currentBalance < notificationSettings.lowBalanceThreshold) { showNotification('âš ï¸ ä½™é¢ä¸è¶³', `å½“å‰ä½™é¢ä»…å‰© ${formatTime(currentBalance)}`, 'lowBalance'); }
        }

        // --- æŠ¥å‘Šé¡µé¢æ ¸å¿ƒé€»è¾‘ ---
        function setupReportEventListeners() {
            document.getElementById('flowChartFilters').addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    reportState.flowChartPeriod = e.target.dataset.period;
                    document.querySelectorAll('#flowChartFilters button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    updateFlowChart();
                }
            });
            document.getElementById('analysisViewToggle').addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    reportState.analysisView = e.target.dataset.view;
                    document.querySelectorAll('#analysisViewToggle button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    reportState.analysisSort = { column: 'net', direction: 'desc' }; // Reset sort
                    updateAnalysisTable();
                }
            });
            document.getElementById('analysisSearch').addEventListener('input', e => {
                reportState.analysisSearchTerm = e.target.value.toLowerCase();
                updateAnalysisTable();
            });
        }
        function updateSummaryStats() {
            const totalEarned = transactions.filter(t => t.type === 'earn').reduce((sum, t) => sum + t.amount, 0);
            const totalSpent = transactions.filter(t => t.type === 'spend').reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('totalEarned').textContent = formatTime(totalEarned);
            document.getElementById('totalSpent').textContent = formatTime(totalSpent);
            document.getElementById('totalTasks').textContent = tasks.length;
            document.getElementById('completedTasks').textContent = tasks.reduce((sum, t) => sum + (t.completionCount || 0), 0);
        }
        function updateAllReports() {
            updateFlowChart();
            updateActivityHeatmap();
            updateAnalysisTable();
        }
        function getFilteredTransactions() {
            const now = new Date();
            let startDate;
            if (reportState.flowChartPeriod === '7d') startDate = new Date(now.setDate(now.getDate() - 7));
            else if (reportState.flowChartPeriod === '30d') startDate = new Date(now.setDate(now.getDate() - 30));
            else return transactions;
            return transactions.filter(t => new Date(t.timestamp) >= startDate);
        }
        function updateFlowChart() {
            const filtered = getFilteredTransactions();
            const container = document.getElementById('flowChartContainer');
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-message">æ­¤æœŸé—´æ— æ•°æ®</div>'; return; }
            const processData = (type) => {
                const data = new Map();
                filtered.filter(t => t.type === type).forEach(t => {
                    const task = tasks.find(tsk => tsk.id === t.taskId);
                    const category = task ? task.category : 'æœªçŸ¥';
                    data.set(category, (data.get(category) || 0) + t.amount);
                });
                const total = Array.from(data.values()).reduce((sum, val) => sum + val, 0);
                const sorted = Array.from(data.entries()).sort((a, b) => b[1] - a[1]);
                let segments = sorted.slice(0, 4).map(([category, amount]) => ({ category, amount, percent: total > 0 ? (amount / total) * 100 : 0 }));
                if (sorted.length > 4) {
                    const otherAmount = sorted.slice(4).reduce((sum, [, amount]) => sum + amount, 0);
                    segments.push({ category: 'å…¶å®ƒ', amount: otherAmount, percent: total > 0 ? (otherAmount / total) * 100 : 0 });
                }
                return { segments, total };
            };
            const { segments: earnedSegments, total: totalEarned } = processData('earn');
            const { segments: spentSegments, total: totalSpent } = processData('spend');
            const renderBar = (label, segments, total) => `
                <div class="flow-bar-wrapper">
                    <div class="flow-bar-label">${label}<br><small>${formatTime(total)}</small></div>
                    <div class="flow-bar">
                        ${segments.map(s => `
                            <div class="flow-bar-segment" style="width: ${s.percent}%; background-color: ${s.category === 'å…¶å®ƒ' ? '#ccc' : (categoryColors.get(s.category) || '#888')};">
                                <span class="tooltip">${s.category}: ${formatTime(s.amount)} (${s.percent.toFixed(1)}%)</span>
                            </div>`).join('')}
                    </div>
                </div>`;
            container.innerHTML = (totalEarned > 0 ? renderBar('è·å¾—', earnedSegments, totalEarned) : '') + (totalSpent > 0 ? renderBar('æ¶ˆè´¹', spentSegments, totalSpent) : '');
        }
        function updateActivityHeatmap() {
            const container = document.getElementById('heatmapContainer');
            const legendContainer = document.getElementById('heatmapLegend');
            const dailyData = new Map();
            transactions.forEach(t => {
                const dateStr = new Date(t.timestamp).toISOString().split('T')[0];
                if (!dailyData.has(dateStr)) dailyData.set(dateStr, { earned: 0, spent: 0, tasks: {} });
                const day = dailyData.get(dateStr);
                day[t.type] += t.amount;
                day.tasks[t.taskName] = (day.tasks[t.taskName] || 0) + 1;
            });
            
            let html = '';
            const today = new Date();
            const startDate = new Date();
            startDate.setDate(today.getDate() - 180);
            
            for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const data = dailyData.get(dateStr);
                let level = 0;
                let tooltip = `<strong>${dateStr}</strong><br>æ— æ´»åŠ¨`;
                if (data) {
                    const net = data.earned - data.spent;
                    const topTasks = Object.entries(data.tasks).sort((a, b) => b[1] - a[1]).slice(0, 3).map(([name, count]) => `${name} (x${count})`).join('<br>');
                    tooltip = `<strong>${dateStr}</strong><br>è·å¾—: ${formatTime(data.earned)}<br>æ¶ˆè´¹: ${formatTime(data.spent)}<br><b>å‡€å€¼: ${net >= 0 ? '+' : '-'}${formatTime(Math.abs(net))}</b><br><hr>${topTasks}`;
                    if (net > 3600 * 2) level = 4; else if (net > 3600) level = 3; else if (net > 1800) level = 2; else if (net > 0) level = 1;
                    else if (net < -3600) level = -4; else if (net < -1800) level = -3; else if (net < -600) level = -2; else if (net < 0) level = -1;
                }
                html += `<div class="heatmap-day" data-level="${level}"><span class="tooltip">${tooltip}</span></div>`;
            }
            container.innerHTML = html;
            legendContainer.innerHTML = `
                èµ¤å­— 
                <div class="legend-item"><div class="legend-box" style="background-color: #ffcdd2;"></div></div>
                <div class="legend-item"><div class="legend-box" style="background-color: #e57373;"></div></div>
                <div class="legend-item"><div class="legend-box" style="background-color: #f44336;"></div></div>
                 | 
                <div class="legend-item"><div class="legend-box" style="background-color: #ebedf0;"></div></div>
                 | 
                <div class="legend-item"><div class="legend-box" style="background-color: #9be9a8;"></div></div>
                <div class="legend-item"><div class="legend-box" style="background-color: #30a14e;"></div></div>
                <div class="legend-item"><div class="legend-box" style="background-color: #216e39;"></div></div>
                 ç›ˆä½™`;
        }
        function updateAnalysisTable() {
            const table = document.getElementById('analysisTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            const data = processAnalysisData();

            const headers = reportState.analysisView === 'category' 
                ? { name: 'åˆ†ç±»', net: 'å‡€å€¼', count: 'æ¬¡æ•°', percentage: 'å æ¯”' }
                : { name: 'ä»»åŠ¡', category: 'åˆ†ç±»', net: 'æ€»æ—¶é—´', count: 'æ¬¡æ•°', avg: 'å¹³å‡', percentage: 'å æ¯”' };
            
            thead.innerHTML = `<tr>${Object.entries(headers).map(([key, value]) => `<th data-sort="${key}">${value}</th>`).join('')}</tr>`;
            
            tbody.innerHTML = data.length > 0 ? data.map(row => {
                const net = row.net;
                const netText = net > 0 ? `+${formatTime(net)}` : (net < 0 ? `-${formatTime(Math.abs(net))}` : '0');
                const netClass = net > 0 ? 'text-positive' : (net < 0 ? 'text-negative' : '');
                const percentageText = row.percentage > 0.01 ? `${row.percentage.toFixed(1)}%` : '-';

                if (reportState.analysisView === 'category') {
                    return `<tr><td>${row.name}</td><td class="${netClass}">${netText}</td><td>${row.count}</td><td>${percentageText}</td></tr>`;
                } else {
                    const avg = row.count > 0 ? formatTime(Math.floor((row.earned + row.spent) / row.count)) : '-';
                    return `<tr><td>${row.name}</td><td>${row.category}</td><td class="${netClass}">${netText}</td><td>${row.count}</td><td>${avg}</td><td>${percentageText}</td></tr>`;
                }
            }).join('') : `<tr><td colspan="${Object.keys(headers).length}" class="empty-message" style="color:var(--text-color);">æ— åŒ¹é…æ•°æ®</td></tr>`;
            
            document.querySelectorAll('#analysisTable th').forEach(th => {
                const sortKey = th.dataset.sort;
                if (sortKey === reportState.analysisSort.column) {
                    th.classList.add(reportState.analysisSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
                th.addEventListener('click', () => {
                    const currentDirection = reportState.analysisSort.column === sortKey ? reportState.analysisSort.direction : 'desc';
                    reportState.analysisSort = { column: sortKey, direction: currentDirection === 'desc' ? 'asc' : 'desc' };
                    updateAnalysisTable();
                });
            });
        }
        function processAnalysisData() {
            const allTaskDataMap = new Map();
            tasks.forEach(task => allTaskDataMap.set(task.id, { earned: 0, spent: 0 }));
            transactions.forEach(t => {
                if (allTaskDataMap.has(t.taskId)) allTaskDataMap.get(t.taskId)[t.type] += t.amount;
            });
            const allTaskData = Array.from(allTaskDataMap.values());
            const totalEarned = allTaskData.reduce((sum, task) => sum + task.earned, 0);
            const totalSpent = allTaskData.reduce((sum, task) => sum + task.spent, 0);

            const dataMap = new Map();
            const term = reportState.analysisSearchTerm;

            if (reportState.analysisView === 'category') {
                tasks.forEach(task => { if(!dataMap.has(task.category)) dataMap.set(task.category, { name: task.category, earned: 0, spent: 0, net: 0, count: 0, percentage: 0 }); });
                transactions.forEach(t => {
                    const task = tasks.find(tsk => tsk.id === t.taskId);
                    const category = task ? task.category : 'æœªçŸ¥';
                    if (!dataMap.has(category)) return;
                    const item = dataMap.get(category);
                    item[t.type] += t.amount;
                    item.net += (t.type === 'earn' ? t.amount : -t.amount);
                    item.count++;
                });
                dataMap.forEach(item => {
                    if (item.net >= 0 && totalEarned > 0) item.percentage = (item.earned / totalEarned) * 100;
                    else if (item.net < 0 && totalSpent > 0) item.percentage = (item.spent / totalSpent) * 100;
                });
            } else {
                tasks.forEach(task => dataMap.set(task.id, { id: task.id, name: task.name, category: task.category, earned: 0, spent: 0, net: 0, count: 0, percentage: 0 }));
                transactions.forEach(t => {
                    if (!dataMap.has(t.taskId)) return;
                    const item = dataMap.get(t.taskId);
                    item[t.type] += t.amount;
                    item.net += (t.type === 'earn' ? t.amount : -t.amount);
                    item.count++;
                });
                dataMap.forEach(item => {
                    const isEarn = item.net >= 0;
                    if (isEarn && totalEarned > 0) item.percentage = (item.earned / totalEarned) * 100;
                    else if (!isEarn && totalSpent > 0) item.percentage = (item.spent / totalSpent) * 100;
                });
            }
            
            let filteredData = Array.from(dataMap.values()).filter(item => item.name.toLowerCase().includes(term) || (item.category && item.category.toLowerCase().includes(term)));
            
            const { column, direction } = reportState.analysisSort;
            filteredData.sort((a, b) => {
                let valA = a[column], valB = b[column];
                if (column === 'percentage') { valA = a.percentage || 0; valB = b.percentage || 0; }
                if (typeof valA === 'string') return direction === 'asc' ? valA.localeCompare(valB, 'zh-CN') : valB.localeCompare(valA, 'zh-CN');
                return direction === 'asc' ? valA - valB : valB - valA;
            });
            return filteredData;
        }

        // --- å…¶å®ƒ ---
        function updateCategoryRecommendations() { const c = [...new Set(tasks.map(t => t.category))]; document.getElementById('categoryRecommendations').innerHTML = c.map(cat => `<div class="recommendation-item" onclick="selectCategory('${cat}')">${cat}</div>`).join(''); }
        function selectCategory(category) { document.getElementById('taskCategory').value = category; }
        function formatTime(seconds) { if (seconds < 0) return '-' + formatTime(-seconds); const h = Math.floor(seconds / 3600), m = Math.floor((seconds % 3600) / 60), s = seconds % 60; const p = []; if (h > 0) p.push(`${h}å°æ—¶`); if (m > 0) p.push(`${m}åˆ†é’Ÿ`); if (s > 0 || p.length === 0) p.push(`${s}ç§’`); return p.join(''); }
        function formatDateTime(timestamp) { const d = new Date(timestamp), n = new Date(); const diff = (new Date(n.toDateString()) - new Date(d.toDateString())) / 86400000; if (diff === 0) return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); if (diff === 1) return 'æ˜¨å¤© ' + d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); if (diff < 7) return `${diff}å¤©å‰`; return d.toLocaleDateString('zh-CN'); }
        function requestNotificationPermission() { if ('Notification' in window) Notification.requestPermission(); }
        function showNotification(title, body, type) { if (!notificationSettings[type] || !('Notification' in window) || Notification.permission !== 'granted') return; new Notification(title, { body, icon: '/favicon.ico' }); }
        function toggleAchievementNotifications() { notificationSettings.achievement = document.getElementById('achievementNotificationToggle').checked; if (notificationSettings.achievement && Notification.permission === 'default') requestNotificationPermission(); saveData(); }
        function toggleLongRunningNotifications() { notificationSettings.longRunning = document.getElementById('longRunningNotificationToggle').checked; saveData(); }
        function updateLongRunningThreshold() { const v = parseInt(document.getElementById('longRunningThreshold').value); if (v >= 300) { notificationSettings.longRunningThreshold = v; saveData(); } }
        function toggleLowBalanceNotifications() { notificationSettings.lowBalance = document.getElementById('lowBalanceNotificationToggle').checked; saveData(); }
        function updateLowBalanceThreshold() { const v = parseInt(document.getElementById('lowBalanceThreshold').value); if (v >= 0) { notificationSettings.lowBalanceThreshold = v; saveData(); updateBalance(); } }
        function updateNotificationSettingsUI() { document.getElementById('achievementNotificationToggle').checked = notificationSettings.achievement; document.getElementById('longRunningNotificationToggle').checked = notificationSettings.longRunning; document.getElementById('longRunningThreshold').value = notificationSettings.longRunningThreshold; document.getElementById('lowBalanceNotificationToggle').checked = notificationSettings.lowBalance; document.getElementById('lowBalanceThreshold').value = notificationSettings.lowBalanceThreshold; }
        
        let systemThemeListener = null;
        function applyTheme(theme) { if (systemThemeListener) { window.matchMedia('(prefers-color-scheme: dark)').removeEventListener('change', systemThemeListener); systemThemeListener = null; } if (theme === 'system') { const p = window.matchMedia('(prefers-color-scheme: dark)').matches; document.body.setAttribute('data-theme', p ? 'dark' : 'light'); systemThemeListener = e => document.body.setAttribute('data-theme', e.matches ? 'dark' : 'light'); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', systemThemeListener); } else { document.body.setAttribute('data-theme', theme); } document.querySelectorAll('.theme-option').forEach(b => b.classList.toggle('active', b.dataset.themeValue === theme)); }
        function setTheme(theme) { applyTheme(theme); localStorage.setItem('themePreference', theme); }
        
        function exportData() { const d = { version: '3.2.1', currentBalance, tasks, transactions, categoryColors: [...categoryColors], collapsedCategories: [...collapsedCategories], dailyChanges, notificationSettings, exportTime: new Date().toISOString() }; const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `timebank_backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(a.href); showNotification('ğŸ“ å¯¼å‡ºå®Œæˆ', 'æ•°æ®å·²æˆåŠŸå¯¼å‡ºåˆ°æ–‡ä»¶', 'achievement'); }
        function importData(event) { const f = event.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = function(e) { try { const d = JSON.parse(e.target.result); if (!d.version || !Array.isArray(d.tasks)) throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼'); if (!confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) return; currentBalance = d.currentBalance || 0; tasks = d.tasks || []; transactions = d.transactions || []; categoryColors = new Map(d.categoryColors || []); collapsedCategories = new Set(d.collapsedCategories || []); dailyChanges = d.dailyChanges || {}; if (d.notificationSettings) notificationSettings = { ...notificationSettings, ...d.notificationSettings }; runningTasks.clear(); saveData(); updateAllUI(); updateCategoryRecommendations(); updateNotificationSettingsUI(); showNotification('ğŸ“¥ å¯¼å…¥å®Œæˆ', 'æ•°æ®å·²æˆåŠŸå¯¼å…¥', 'achievement'); } catch (error) { alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message); } }; r.readAsText(f); event.target.value = ''; }
        function clearAllData() { if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼') || !confirm('æœ€åç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ä»»åŠ¡ã€äº¤æ˜“è®°å½•å’Œè®¾ç½®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) return; localStorage.removeItem('timeBankData'); localStorage.removeItem('themePreference'); location.reload(); }
        
        function saveData() { const data = { currentBalance, tasks, transactions, categoryColors: [...categoryColors], collapsedCategories: [...collapsedCategories], runningTasks: [...runningTasks], dailyChanges, notificationSettings }; localStorage.setItem('timeBankData', JSON.stringify(data)); }
        function loadData() { try { const s = localStorage.getItem('timeBankData'); if (s) { const d = JSON.parse(s); currentBalance = d.currentBalance || 0; tasks = d.tasks || []; transactions = d.transactions || []; categoryColors = new Map(d.categoryColors || []); collapsedCategories = new Set(d.collapsedCategories || []); runningTasks = new Map(d.runningTasks || []); dailyChanges = d.dailyChanges || {}; if (d.notificationSettings) notificationSettings = { ...notificationSettings, ...d.notificationSettings }; } const t = localStorage.getItem('themePreference') || 'system'; setTheme(t); } catch (error) { console.error('åŠ è½½æ•°æ®å¤±è´¥:', error); } }
        
        document.addEventListener('DOMContentLoaded', initApp);
        window.addEventListener('beforeunload', saveData);
        document.addEventListener('click', e => { if (e.target.classList.contains('modal')) { if (e.target.id === 'taskModal') hideTaskModal(); else if (e.target.id === 'historyModal') hideHistoryModal(); } });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { if (document.getElementById('taskModal').classList.contains('show')) hideTaskModal(); else if (document.getElementById('historyModal').classList.contains('show')) hideHistoryModal(); } else if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); showTaskModal(); } });
    </script>
</body>
</html>