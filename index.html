<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间银行 - Time Bank v2.8</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSS变量定义 - 支持亮色和暗色主题 */
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-color: #333;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.1);
            --border-color: #eee;
            --input-bg: #f8f9fa;
            --header-text: white;
            --section-title-color: white;
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --text-color: #e0e0e0;
            --card-bg: rgba(45, 45, 45, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.3);
            --border-color: #444;
            --input-bg: #2a2a2a;
            --header-text: #e0e0e0;
            --section-title-color: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            padding-bottom: 80px; /* 为底部标签栏留出空间 */
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            padding: 20px;
            color: var(--header-text);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .balance-card {
            margin: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .balance-card.negative {
            background: rgba(255, 235, 238, 0.95);
            border: 2px solid #f44336;
        }

        .balance-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .daily-changes {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .daily-change {
            color: #666;
        }

        /* 标签页 */
        .tab-content {
            display: none;
            padding: 0 20px;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 20px 0 15px 0;
            color: var(--section-title-color);
        }

        /* 任务卡片 - 移动端优化 */
        .task-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 16px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .task-info {
            flex: 1;
            min-width: 0;
        }

        .task-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-name-text {
            flex: 1;
        }

        .task-edit-btn {
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            color: #666;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .task-edit-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .task-details {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }

        .task-category {
            background: #2196F3;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .task-completion-count {
            color: #4CAF50;
            font-weight: 500;
        }

        /* 移动端优化的按钮布局 */
        .task-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
            flex-wrap: wrap;
            justify-content: flex-end;
            max-width: 50%;
        }

        .task-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 44px; /* 确保触摸友好的最小尺寸 */
            text-align: center;
        }

        .task-btn.edit {
            background: #f5f5f5;
            color: #666;
            padding: 5px 8px;
            min-width: 36px;
        }

        .task-btn.primary {
            background: #2196F3;
            color: white;
        }

        .task-btn.success {
            background: #4CAF50;
            color: white;
        }

        .task-btn.warning {
            background: #FF9800;
            color: white;
        }

        .task-btn.danger {
            background: #f44336;
            color: white;
        }

        .task-btn.secondary {
            background: #9E9E9E;
            color: white;
        }

        .task-btn.info {
            background: #17a2b8;
            color: white;
        }

        .task-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .task-timer {
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2196F3;
        }

        .task-progress {
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
        }

        /* 分类任务 */
        .category-tasks {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-header:hover {
            background: rgba(255, 255, 255, 1);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .category-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .category-count {
            color: #666;
            font-size: 0.85rem;
        }

        .category-toggle {
            transition: transform 0.2s ease;
            font-size: 0.8rem;
            color: #666;
        }

        .category-header.collapsed .category-toggle {
            transform: rotate(-90deg);
        }

        .category-tasks-list {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-tasks-list.collapsed {
            max-height: 0;
        }

        /* 最近任务 */
        .recent-tasks {
            margin-bottom: 30px;
        }

        /* 空状态 */
        .empty-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            padding: 40px 20px;
        }

        /* 悬浮按钮 */
        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6);
        }

        /* 底部标签栏 */
        .bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            color: #666;
        }

        .tab-button.active {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .tab-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .form-input.error, .form-select.error {
            border-color: #f44336;
        }

        .error-message {
            color: #f44336;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        /* 时间预设按钮 */
        .time-presets {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .time-preset {
            padding: 6px 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-preset:hover {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        /* 分类推荐 */
        .recommendations {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .recommendation-item {
            padding: 4px 8px;
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .recommendation-item:hover {
            background: #2196F3;
            color: white;
        }

        /* 表单按钮 */
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* 报告页面 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .transaction-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .transaction-time {
            font-size: 0.8rem;
            color: #666;
        }

        .transaction-amount {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .transaction-amount.positive {
            color: #4CAF50;
        }

        .transaction-amount.negative {
            color: #f44336;
        }

        /* 设置页面 */
        .settings-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .settings-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .setting-desc {
            font-size: 0.85rem;
            color: #666;
        }

        /* 开关样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .threshold-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        /* 数据管理按钮 */
        .data-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .data-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            background: white;
            color: #2196F3;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .data-btn:hover {
            background: #2196F3;
            color: white;
        }

        .file-input {
            display: none;
        }

        /* 移动端响应式设计优化 */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .balance-amount {
                font-size: 2rem;
            }

            .balance-card {
                margin: 15px;
                padding: 15px;
            }

            .tab-content {
                padding: 0 15px;
            }

            /* 任务卡片移动端优化 */
            .task-card {
                padding: 12px;
                margin-bottom: 8px;
            }

            .task-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .task-actions {
                max-width: 100%;
                justify-content: flex-start;
                gap: 8px;
            }

            .task-btn {
                flex: 1;
                min-width: 0;
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .task-btn.edit {
                flex: 0 0 auto;
                min-width: 44px;
                padding: 8px;
            }

            /* 当按钮超过3个时，使用网格布局 */
            .task-actions.many-buttons {
                display: grid;
                grid-template-columns: auto 1fr 1fr;
                gap: 8px;
            }

            .task-actions.many-buttons .task-btn.edit {
                grid-row: 1 / 3;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }

            .form-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .data-buttons {
                flex-direction: column;
            }

            /* 底部标签栏移动端优化 */
            .tab-button {
                padding: 10px 4px;
                font-size: 0.7rem;
            }

            .tab-icon {
                font-size: 1.1rem;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 360px) {
            .task-btn {
                font-size: 0.75rem;
                padding: 6px 8px;
            }

            .balance-amount {
                font-size: 1.8rem;
            }

            .header h1 {
                font-size: 1.3rem;
            }
        }

        /* 横屏模式优化 */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 10px;
            }

            .balance-card {
                margin: 10px;
                padding: 15px;
            }

            .balance-amount {
                font-size: 1.8rem;
            }

            .fab {
                bottom: 80px;
                right: 15px;
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }
        }

        /* 任务历史模态框样式 */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            flex: 1;
        }

        .history-description {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .history-time {
            font-size: 0.8rem;
            color: #666;
        }

        .history-amount {
            font-weight: 600;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .history-amount.positive {
            color: #4CAF50;
        }

        .history-amount.negative {
            color: #f44336;
        }

        .undo-btn {
            padding: 4px 8px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .undo-btn:hover {
            background: #f57c00;
        }

        .undo-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* 简洁设置界面样式 */
        .settings-section {
            margin-bottom: 25px;
        }

        .settings-row {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            transition: all 0.3s ease;
        }

        .settings-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .settings-list {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item span {
            font-size: 0.9rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .settings-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-btn.primary {
            background: #4CAF50;
            color: white;
        }

        .settings-btn.primary-outline {
            background: transparent;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .settings-btn.danger {
            background: #f44336;
            color: white;
        }

        .settings-btn.danger-outline {
            background: transparent;
            color: #f44336;
            border: 1px solid #f44336;
        }

        .settings-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .settings-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.85rem;
            text-align: center;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .unit {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .file-input {
            display: none;
        }

        .version-info {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .version-text {
            margin-bottom: 10px;
        }

        .app-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .version-desc {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .version-features {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.8;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- 头部 -->
    <div class="header">
        <h1>时间银行 v2.8</h1>
        <p>管理您的时间，积累您的财富</p>
    </div>

    <!-- 余额卡片 -->
    <div class="balance-card" id="balanceCard">
        <div class="balance-title">当前余额</div>
        <div class="balance-amount" id="currentBalanceAmount">0秒</div>
        <div class="daily-changes">
            <div class="daily-change" id="yesterdayChange">昨日变化: +0分钟</div>
            <div class="daily-change" id="todayChange">今日变化: +0分钟</div>
        </div>
    </div>

    <!-- 获得时间标签页 -->
    <div class="tab-content active" id="earnTab">
        <!-- 最近任务 -->
        <div class="recent-tasks">
            <div class="section-title">最近任务</div>
            <div id="recentEarnTasks"></div>
        </div>

        <!-- 分类任务 -->
        <div id="categoryEarnTasks"></div>
    </div>

    <!-- 消耗时间标签页 -->
    <div class="tab-content" id="spendTab">
        <!-- 最近任务 -->
        <div class="recent-tasks">
            <div class="section-title">最近任务</div>
            <div id="recentSpendTasks"></div>
        </div>

        <!-- 分类任务 -->
        <div id="categorySpendTasks"></div>
    </div>

    <!-- 报告标签页 -->
    <div class="tab-content" id="reportTab">
        <div class="section-title">数据概览</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalEarned">0秒</div>
                <div class="stat-label">总获得时间</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">0秒</div>
                <div class="stat-label">总消耗时间</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">总任务数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentBalance">0秒</div>
                <div class="stat-label">当前余额</div>
            </div>
        </div>

        <div class="section-title">交易历史</div>
        <div class="transaction-list" id="transactionList">
            <div class="empty-message">暂无交易记录</div>
        </div>
    </div>

    <!-- 设置标签页 -->
    <div class="tab-content" id="settingsTab">
        <!-- 数据管理 -->
        <div class="settings-section">
            <div class="section-title">数据管理</div>
            
            <div class="settings-row">
                <div class="settings-group">
                    <button class="settings-btn danger" onclick="clearTimeData()">清除时间数据</button>
                    <button class="settings-btn danger-outline" onclick="clearAllData()">清除所有数据</button>
                </div>
                <div class="settings-group">
                    <button class="settings-btn primary" onclick="exportData()">导出数据</button>
                    <button class="settings-btn primary-outline" onclick="document.getElementById('importFile').click()">导入数据</button>
                    <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
                </div>
            </div>
        </div>

        <!-- 主题设置 -->
        <div class="settings-section">
            <div class="section-title">主题设置</div>
            
            <div class="settings-list">
                <div class="settings-item">
                    <span>夜间模式</span>
                    <label class="toggle">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <span>跟随系统主题</span>
                    <label class="toggle">
                        <input type="checkbox" id="systemThemeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- 通知设置 -->
        <div class="settings-section">
            <div class="section-title">通知设置</div>
            
            <div class="settings-list">
                <div class="settings-item">
                    <span>启用通知</span>
                    <label class="toggle">
                        <input type="checkbox" id="notificationsEnabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <span>达标任务完成通知</span>
                    <label class="toggle">
                        <input type="checkbox" id="achievementNotification">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <span>长时间运行提醒</span>
                    <div class="settings-controls">
                        <label class="toggle">
                            <input type="checkbox" id="longRunningNotification">
                            <span class="toggle-slider"></span>
                        </label>
                        <input type="number" class="settings-input" id="longRunningThreshold" value="3600" min="300" step="300">
                        <span class="unit">秒</span>
                    </div>
                </div>
                
                <div class="settings-item">
                    <span>余额不足预警</span>
                    <div class="settings-controls">
                        <label class="toggle">
                            <input type="checkbox" id="lowBalanceNotification">
                            <span class="toggle-slider"></span>
                        </label>
                        <input type="number" class="settings-input" id="lowBalanceThreshold" value="1800" min="300" step="300">
                        <span class="unit">秒</span>
                    </div>
                </div>
                
                <div class="settings-item">
                    <span>不活跃任务提醒</span>
                    <div class="settings-controls">
                        <label class="toggle">
                            <input type="checkbox" id="inactiveTaskNotification">
                            <span class="toggle-slider"></span>
                        </label>
                        <input type="number" class="settings-input" id="inactiveTaskThreshold" value="86400" min="3600" step="3600">
                        <span class="unit">秒</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 关于 -->
        <div class="settings-section">
            <div class="section-title">关于</div>
            <div class="version-info">
                <div class="version-text">
                    <div class="app-title">时间银行 v2.8</div>
                    <div class="version-desc">增强版 - 现代化界面设计</div>
                </div>
                <div class="version-features">
                    计时器持久化 • 任务历史查看 • 数据清除功能 • 现代化设置界面
                </div>
            </div>
        </div>
    </div>

    <!-- 悬浮创建按钮 -->
    <button class="fab" onclick="showTaskModal()" id="fabButton">+</button>

    <!-- 底部标签栏 -->
    <div class="bottom-tabs">
        <button class="tab-button active" onclick="switchTab('earn')">
            <div class="tab-icon">⬆️</div>
            <div>获得时间</div>
        </button>
        <button class="tab-button" onclick="switchTab('spend')">
            <div class="tab-icon">⬇️</div>
            <div>消耗时间</div>
        </button>
        <button class="tab-button" onclick="switchTab('report')">
            <div class="tab-icon">📊</div>
            <div>报告</div>
        </button>
        <button class="tab-button" onclick="switchTab('settings')">
            <div class="tab-icon">⚙️</div>
            <div>设置</div>
        </button>
    </div>

    <!-- 任务创建/编辑模态框 -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">创建任务</div>
                <button class="close-btn" onclick="hideTaskModal()">×</button>
            </div>
            <form id="taskForm" onsubmit="submitTask(event)">
                <!-- 任务名称 -->
                <div class="form-group">
                    <label class="form-label">任务名称 *</label>
                    <input type="text" id="taskName" class="form-input" placeholder="例如：阅读、运动、学习" required>
                    <div class="error-message" id="taskNameError"></div>
                </div>

                <!-- 分类 -->
                <div class="form-group">
                    <label class="form-label">分类 *</label>
                    <input type="text" id="taskCategory" class="form-input" placeholder="例如：学习、健康、娱乐" required>
                    <div class="recommendations" id="categoryRecommendations">
                        <!-- 历史分类推荐将在这里动态生成 -->
                    </div>
                    <div class="error-message" id="taskCategoryError"></div>
                </div>

                <!-- 任务类型 -->
                <div class="form-group">
                    <label class="form-label">任务类型 *</label>
                    <select id="taskType" class="form-select" onchange="updateFormFields()" required>
                        <option value="">请选择任务类型</option>
                        <option value="reward">奖励任务（完成获得固定时间）</option>
                        <option value="continuous">持续任务（自由）（按时长获得时间）</option>
                        <option value="continuous_target">持续任务（达标）（达到目标获得额外奖励）</option>
                        <option value="instant_redeem">即时兑换（消耗固定时间）</option>
                        <option value="continuous_redeem">持续兑换（按时长消耗时间）</option>
                    </select>
                    <div class="error-message" id="taskTypeError"></div>
                </div>

                <!-- 固定时间字段（奖励任务和即时兑换） -->
                <div class="form-group hidden" id="fixedTimeGroup">
                    <label class="form-label">固定时间 (秒) *</label>
                    <input type="text" id="fixedTime" class="form-input" placeholder="例如：3600（1小时）">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 900)">15分钟</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 1800)">30分钟</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 3600)">1小时</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 7200)">2小时</div>
                    </div>
                    <div class="error-message" id="fixedTimeError"></div>
                </div>

                <!-- 时间倍率字段（持续任务和持续兑换） -->
                <div class="form-group hidden" id="multiplierGroup">
                    <label class="form-label">时间倍率 *</label>
                    <input type="text" id="multiplier" class="form-input" placeholder="例如：1.0（1倍）、1.5（1.5倍）">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setMultiplierPreset(0.5)">0.5倍</div>
                        <div class="time-preset" onclick="setMultiplierPreset(1.0)">1倍</div>
                        <div class="time-preset" onclick="setMultiplierPreset(1.5)">1.5倍</div>
                        <div class="time-preset" onclick="setMultiplierPreset(2.0)">2倍</div>
                    </div>
                    <div class="error-message" id="multiplierError"></div>
                </div>

                <!-- 目标时长字段（达标任务专用） -->
                <div class="form-group hidden" id="targetTimeGroup">
                    <label class="form-label">目标时长 (秒) *</label>
                    <input type="text" id="targetTime" class="form-input" placeholder="例如：3600（1小时）">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('targetTime', 1800)">30分钟</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 3600)">1小时</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 5400)">1.5小时</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 7200)">2小时</div>
                    </div>
                    <div class="error-message" id="targetTimeError"></div>
                </div>

                <!-- 额外奖励字段（达标任务专用） -->
                <div class="form-group hidden" id="bonusRewardGroup">
                    <label class="form-label">额外奖励 (秒) *</label>
                    <input type="text" id="bonusReward" class="form-input" placeholder="例如：1800（30分钟）">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 900)">15分钟</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 1800)">30分钟</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 3600)">1小时</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 5400)">1.5小时</div>
                    </div>
                    <div class="error-message" id="bonusRewardError"></div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">取消</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">创建任务</button>
                    <button type="button" class="btn btn-danger hidden" id="deleteBtn" onclick="deleteTask()">删除任务</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 任务历史模态框 -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="historyModalTitle">任务历史</div>
                <button class="close-btn" onclick="hideHistoryModal()">×</button>
            </div>
            <div id="historyContent">
                <div class="empty-message">暂无历史记录</div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentBalance = 0;
        let tasks = [];
        let transactions = [];
        let categoryColors = new Map();
        let collapsedCategories = new Set();
        let runningTasks = new Map(); // 存储运行中的任务状态
        let currentEditingTask = null;
        let timerInterval = null; // 全局计时器
        let dailyChanges = {}; // 每日变化记录
        let currentHistoryTask = null; // 当前查看历史的任务
        
        // 通知设置
        let notificationSettings = {
            enabled: false,
            achievement: true,
            longRunning: true,
            longRunningThreshold: 3600,
            lowBalance: true,
            lowBalanceThreshold: 1800,
            inactiveTask: false,
            inactiveTaskThreshold: 86400
        };

        // 颜色配置
        const colors = [
            '#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#F44336',
            '#00BCD4', '#8BC34A', '#FFC107', '#E91E63', '#607D8B',
            '#3F51B5', '#009688', '#CDDC39', '#795548', '#FF5722'
        ];

        // 初始化应用
        function initApp() {
            loadData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            updateCategoryRecommendations();
            updateNotificationSettings();
            
            // 启动全局计时器
            startGlobalTimer();
            
            // 请求通知权限
            if ('Notification' in window && Notification.permission === 'default') {
                requestNotificationPermission();
            }
        }

        // 启动全局计时器
        function startGlobalTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                updateRunningTimers();
            }, 1000);
        }

        // 标签页切换
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签按钮的激活状态
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 激活选中的标签按钮
            event.target.closest('.tab-button').classList.add('active');
            
            // 根据标签页更新悬浮按钮显示
            const fabButton = document.getElementById('fabButton');
            if (tabName === 'report' || tabName === 'settings') {
                fabButton.style.display = 'none';
            } else {
                fabButton.style.display = 'block';
            }
        }

        // 更新最近任务 - 修复排序视觉跳跃问题
        function updateRecentTasks() {
            const earnTasks = tasks.filter(t => t.type === 'reward' || t.type === 'continuous' || t.type === 'continuous_target');
            const spendTasks = tasks.filter(t => t.type === 'instant_redeem' || t.type === 'continuous_redeem');
            
            // 获取当前显示的任务顺序（避免重新排序导致的视觉跳跃）
            const currentEarnOrder = getCurrentTaskOrder('recentEarnTasks');
            const currentSpendOrder = getCurrentTaskOrder('recentSpendTasks');
            
            // 按最后使用时间排序，但保持当前显示任务的相对位置
            const sortByLastUsedWithStability = (taskList, currentOrder) => {
                const sortedTasks = [...taskList].sort((a, b) => {
                    if (!a.lastUsed && !b.lastUsed) return 0;
                    if (!a.lastUsed) return 1;
                    if (!b.lastUsed) return -1;
                    return new Date(b.lastUsed) - new Date(a.lastUsed);
                });
                
                // 如果当前显示的任务在新排序中仍然存在，保持其位置稳定
                if (currentOrder.length > 0) {
                    const stableSorted = [];
                    const remaining = [...sortedTasks];
                    
                    // 首先保持当前显示任务的顺序
                    currentOrder.forEach(taskId => {
                        const taskIndex = remaining.findIndex(t => t.id === taskId);
                        if (taskIndex !== -1) {
                            stableSorted.push(remaining.splice(taskIndex, 1)[0]);
                        }
                    });
                    
                    // 然后添加新的任务
                    stableSorted.push(...remaining);
                    
                    return stableSorted.slice(0, 3);
                }
                
                return sortedTasks.slice(0, 3);
            };
            
            const recentEarnTasks = sortByLastUsedWithStability(earnTasks, currentEarnOrder);
            const recentSpendTasks = sortByLastUsedWithStability(spendTasks, currentSpendOrder);
            
            renderTaskList('recentEarnTasks', recentEarnTasks);
            renderTaskList('recentSpendTasks', recentSpendTasks);
        }

        // 获取当前任务显示顺序
        function getCurrentTaskOrder(containerId) {
            const container = document.getElementById(containerId);
            const taskCards = container.querySelectorAll('.task-card');
            const order = [];
            
            taskCards.forEach(card => {
                const editBtn = card.querySelector('.task-edit-btn, .task-btn.edit');
                if (editBtn && editBtn.onclick) {
                    const onclickStr = editBtn.onclick.toString();
                    const match = onclickStr.match(/t\.id === '([^']+)'/);
                    if (match) {
                        order.push(match[1]);
                    }
                }
            });
            
            return order;
        }

        // 更新分类任务
        function updateCategoryTasks() {
            const earnTasks = tasks.filter(t => t.type === 'reward' || t.type === 'continuous' || t.type === 'continuous_target');
            const spendTasks = tasks.filter(t => t.type === 'instant_redeem' || t.type === 'continuous_redeem');
            
            const earnTasksByCategory = groupTasksByCategory(earnTasks);
            const spendTasksByCategory = groupTasksByCategory(spendTasks);
            
            renderCategoryTasks('categoryEarnTasks', earnTasksByCategory);
            renderCategoryTasks('categorySpendTasks', spendTasksByCategory);
        }

        // 按分类分组任务
        function groupTasksByCategory(taskList) {
            const grouped = {};
            taskList.forEach(task => {
                if (!grouped[task.category]) {
                    grouped[task.category] = [];
                }
                grouped[task.category].push(task);
            });
            return grouped;
        }

        // 渲染分类任务
        function renderCategoryTasks(containerId, tasksByCategory) {
            const container = document.getElementById(containerId);
            
            if (Object.keys(tasksByCategory).length === 0) {
                container.innerHTML = '<div class="empty-message">暂无任务</div>';
                return;
            }
            
            let html = '';
            Object.entries(tasksByCategory).forEach(([category, categoryTasks]) => {
                const isCollapsed = collapsedCategories.has(category);
                const color = categoryColors.get(category) || '#666';
                
                html += `
                    <div class="category-tasks">
                        <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${category}')">
                            <div class="category-info">
                                <div class="category-color" style="background-color: ${color}"></div>
                                <div class="category-name">${category}</div>
                                <div class="category-count">(${categoryTasks.length})</div>
                            </div>
                            <div class="category-toggle">▼</div>
                        </div>
                        <div class="category-tasks-list ${isCollapsed ? 'collapsed' : ''}">
                            ${renderTaskCards(categoryTasks)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 渲染任务列表
        function renderTaskList(containerId, taskList) {
            const container = document.getElementById(containerId);
            
            if (taskList.length === 0) {
                container.innerHTML = '<div class="empty-message">暂无最近任务</div>';
                return;
            }
            
            container.innerHTML = renderTaskCards(taskList);
        }

        // 渲染任务卡片 - 改进版本，优化按钮布局
        function renderTaskCards(taskList) {
            return taskList.map(task => {
                const runningTask = runningTasks.get(task.id);
                const isRunning = !!runningTask;
                const isPaused = runningTask && runningTask.isPaused;
                const color = categoryColors.get(task.category) || '#666';
                
                let detailsHtml = `<span class="task-category" style="background-color: ${color}">${task.category}</span>`;
                
                // 显示完成次数
                if (task.completionCount && task.completionCount > 0) {
                    detailsHtml += ` <span class="task-completion-count">已完成 ${task.completionCount} 次</span>`;
                }
                
                let actionsHtml = '';
                let progressHtml = '';
                
                if (task.type === 'reward') {
                    detailsHtml += ` • 奖励 ${formatTime(task.fixedTime)}`;
                    actionsHtml = `
                        <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="历史">📋</button>
                        <button class="task-btn success" onclick="completeTask('${task.id}')">完成</button>
                    `;
                } else if (task.type === 'continuous') {
                    detailsHtml += ` • ${task.multiplier}倍率`;
                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        if (isPaused) {
                            actionsHtml = `
                                <button class="task-btn primary" onclick="resumeTask('${task.id}')">继续</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">取消</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">结束</button>
                            `;
                            progressHtml = `<div class="task-timer">已暂停：${formatTime(totalSeconds)}</div>`;
                        } else {
                            actionsHtml = `
                                <button class="task-btn warning" onclick="pauseTask('${task.id}')">暂停</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">取消</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">结束</button>
                            `;
                            progressHtml = `<div class="task-timer">运行中：${formatTime(totalSeconds)}</div>`;
                        }
                    } else {
                        actionsHtml = `
                            <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="历史">📋</button>
                            <button class="task-btn primary" onclick="startTask('${task.id}')">开始</button>
                        `;
                    }
                } else if (task.type === 'continuous_target') {
                    detailsHtml += ` • ${task.multiplier}倍率 • 目标 ${formatTime(task.targetTime)}`;
                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        const progress = Math.min((totalSeconds / task.targetTime) * 100, 100);
                        if (isPaused) {
                            actionsHtml = `
                                <button class="task-btn primary" onclick="resumeTask('${task.id}')">继续</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">结束</button>
                            `;
                            progressHtml = `
                                <div class="task-timer">已暂停：${formatTime(totalSeconds)}</div>
                                <div class="task-progress">
                                    进度：${progress.toFixed(1)}% ${runningTask.achieved ? '✅ 已达标' : ''}
                                </div>
                            `;
                        } else {
                            actionsHtml = `
                                <button class="task-btn warning" onclick="pauseTask('${task.id}')">暂停</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">结束</button>
                            `;
                            progressHtml = `
                                <div class="task-timer">运行中：${formatTime(totalSeconds)}</div>
                                <div class="task-progress">
                                    进度：${progress.toFixed(1)}% ${runningTask.achieved ? '✅ 已达标' : ''}
                                </div>
                            `;
                        }
                    } else {
                        actionsHtml = `
                            <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="历史">📋</button>
                            <button class="task-btn primary" onclick="startTask('${task.id}')">开始</button>
                        `;
                        if (task.achieved) {
                            progressHtml = `<div class="task-progress">✅ 已达标</div>`;
                        }
                    }
                } else if (task.type === 'instant_redeem') {
                    detailsHtml += ` • 消耗 ${formatTime(task.fixedTime)}`;
                    actionsHtml = `
                        <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="历史">📋</button>
                        <button class="task-btn danger" onclick="completeTask('${task.id}')">兑换</button>
                    `;
                } else if (task.type === 'continuous_redeem') {
                    detailsHtml += ` • ${task.multiplier}倍率`;
                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        if (isPaused) {
                            actionsHtml = `
                                <button class="task-btn primary" onclick="resumeTask('${task.id}')">继续</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">取消</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">结束</button>
                            `;
                            progressHtml = `<div class="task-timer">已暂停：${formatTime(totalSeconds)}</div>`;
                        } else {
                            actionsHtml = `
                                <button class="task-btn warning" onclick="pauseTask('${task.id}')">暂停</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">取消</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">结束</button>
                            `;
                            progressHtml = `<div class="task-timer">运行中：${formatTime(totalSeconds)}</div>`;
                        }
                    } else {
                        actionsHtml = `
                            <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="历史">📋</button>
                            <button class="task-btn primary" onclick="startTask('${task.id}')">开始</button>
                        `;
                    }
                }
                
                return `
                    <div class="task-card">
                        <div class="task-header">
                            <div class="task-info">
                                <div class="task-name">
                                    <div class="task-name-text">${task.name}</div>
                                    <button class="task-edit-btn" onclick="showTaskModal(tasks.find(t => t.id === '${task.id}'))" title="编辑">✏️</button>
                                </div>
                                <div class="task-details">${detailsHtml}</div>
                            </div>
                            <div class="task-actions">${actionsHtml}</div>
                        </div>
                        ${progressHtml}
                    </div>
                `;
            }).join('');
        }

        // 显示任务历史
        function showTaskHistory(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentHistoryTask = task;
            
            const modal = document.getElementById('historyModal');
            const modalTitle = document.getElementById('historyModalTitle');
            const historyContent = document.getElementById('historyContent');
            
            modalTitle.textContent = `${task.name} - 历史记录`;
            
            // 获取该任务的所有交易记录
            const taskTransactions = transactions.filter(t => 
                t.description.includes(`"${task.name}"`)
            );
            
            if (taskTransactions.length === 0) {
                historyContent.innerHTML = '<div class="empty-message">暂无历史记录</div>';
            } else {
                historyContent.innerHTML = taskTransactions.map(transaction => `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-description">${transaction.description}</div>
                            <div class="history-time">${formatDateTime(transaction.timestamp)}</div>
                        </div>
                        <div class="history-amount ${transaction.amount > 0 ? 'positive' : 'negative'}">
                            ${transaction.amount > 0 ? '+' : ''}${formatTime(Math.abs(transaction.amount))}
                        </div>
                        <button class="undo-btn" onclick="undoTransaction('${transaction.id}')" 
                                ${transaction.undone ? 'disabled' : ''}>
                            ${transaction.undone ? '已撤销' : '撤销'}
                        </button>
                    </div>
                `).join('');
            }
            
            modal.classList.add('show');
        }

        // 隐藏任务历史模态框
        function hideHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.remove('show');
            currentHistoryTask = null;
        }

        // 撤销交易
        function undoTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction || transaction.undone) return;
            
            if (confirm('确定要撤销这次操作吗？时间将被归还到余额中。')) {
                // 标记交易为已撤销
                transaction.undone = true;
                
                // 归还时间到余额
                currentBalance -= transaction.amount;
                
                // 添加撤销记录
                addTransaction(`撤销操作：${transaction.description}`, -transaction.amount);
                
                // 减少任务完成次数
                if (currentHistoryTask) {
                    currentHistoryTask.completionCount = Math.max(0, (currentHistoryTask.completionCount || 1) - 1);
                }
                
                saveData();
                updateBalance();
                updateRecentTasks();
                updateCategoryTasks();
                updateReports();
                
                // 刷新历史显示
                showTaskHistory(currentHistoryTask.id);
            }
        }

        // 切换分类折叠状态
        function toggleCategory(category) {
            if (collapsedCategories.has(category)) {
                collapsedCategories.delete(category);
            } else {
                collapsedCategories.add(category);
            }
            updateCategoryTasks();
            saveData();
        }

        // 显示任务模态框
        function showTaskModal(task = null) {
            const modal = document.getElementById('taskModal');
            const modalTitle = document.getElementById('modalTitle');
            const submitBtn = document.getElementById('submitBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            
            currentEditingTask = task;
            
            if (task) {
                modalTitle.textContent = '编辑任务';
                submitBtn.textContent = '保存修改';
                deleteBtn.classList.remove('hidden');
                
                // 填充表单数据
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskCategory').value = task.category;
                document.getElementById('taskType').value = task.type;
                
                updateFormFields();
                
                if (task.fixedTime !== undefined) {
                    document.getElementById('fixedTime').value = task.fixedTime;
                }
                if (task.multiplier !== undefined) {
                    document.getElementById('multiplier').value = task.multiplier;
                }
                if (task.targetTime !== undefined) {
                    document.getElementById('targetTime').value = task.targetTime;
                }
                if (task.bonusReward !== undefined) {
                    document.getElementById('bonusReward').value = task.bonusReward;
                }
            } else {
                modalTitle.textContent = '创建任务';
                submitBtn.textContent = '创建任务';
                deleteBtn.classList.add('hidden');
                
                // 清空表单
                document.getElementById('taskForm').reset();
                updateFormFields();
            }
            
            modal.classList.add('show');
            updateCategoryRecommendations();
        }

        // 隐藏任务模态框
        function hideTaskModal() {
            const modal = document.getElementById('taskModal');
            modal.classList.remove('show');
            currentEditingTask = null;
            
            // 清除错误状态
            document.querySelectorAll('.form-input, .form-select').forEach(input => {
                input.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.remove('show');
            });
        }

        // 更新表单字段显示
        function updateFormFields() {
            const taskType = document.getElementById('taskType').value;
            const fixedTimeGroup = document.getElementById('fixedTimeGroup');
            const multiplierGroup = document.getElementById('multiplierGroup');
            const targetTimeGroup = document.getElementById('targetTimeGroup');
            const bonusRewardGroup = document.getElementById('bonusRewardGroup');
            
            // 隐藏所有字段
            fixedTimeGroup.classList.add('hidden');
            multiplierGroup.classList.add('hidden');
            targetTimeGroup.classList.add('hidden');
            bonusRewardGroup.classList.add('hidden');
            
            // 根据任务类型显示相应字段
            switch (taskType) {
                case 'reward':
                case 'instant_redeem':
                    fixedTimeGroup.classList.remove('hidden');
                    break;
                case 'continuous':
                case 'continuous_redeem':
                    multiplierGroup.classList.remove('hidden');
                    break;
                case 'continuous_target':
                    multiplierGroup.classList.remove('hidden');
                    targetTimeGroup.classList.remove('hidden');
                    bonusRewardGroup.classList.remove('hidden');
                    break;
            }
        }

        // 设置时间预设
        function setTimePreset(fieldId, seconds) {
            document.getElementById(fieldId).value = seconds;
        }

        // 设置倍率预设
        function setMultiplierPreset(multiplier) {
            document.getElementById('multiplier').value = multiplier;
        }

        // 验证数字输入
        function validateNumberInput(value, fieldName) {
            if (!value || value.trim() === '') {
                return { valid: false, message: `${fieldName}不能为空` };
            }
            
            const num = parseFloat(value);
            if (isNaN(num)) {
                return { valid: false, message: `${fieldName}必须是有效数字` };
            }
            
            if (num <= 0) {
                return { valid: false, message: `${fieldName}必须大于0` };
            }
            
            return { valid: true, value: num };
        }

        // 提交任务表单
        function submitTask(event) {
            event.preventDefault();
            
            // 清除之前的错误状态
            document.querySelectorAll('.form-input, .form-select').forEach(input => {
                input.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.remove('show');
            });
            
            // 获取表单数据
            const name = document.getElementById('taskName').value.trim();
            const category = document.getElementById('taskCategory').value.trim();
            const type = document.getElementById('taskType').value;
            
            let isValid = true;
            
            // 验证基本字段
            if (!name) {
                showFieldError('taskName', 'taskNameError', '任务名称不能为空');
                isValid = false;
            }
            
            if (!category) {
                showFieldError('taskCategory', 'taskCategoryError', '分类不能为空');
                isValid = false;
            }
            
            if (!type) {
                showFieldError('taskType', 'taskTypeError', '请选择任务类型');
                isValid = false;
            }
            
            // 验证类型特定字段
            let taskData = { name, category, type };
            
            switch (type) {
                case 'reward':
                case 'instant_redeem':
                    const fixedTimeValidation = validateNumberInput(
                        document.getElementById('fixedTime').value,
                        '固定时间'
                    );
                    if (!fixedTimeValidation.valid) {
                        showFieldError('fixedTime', 'fixedTimeError', fixedTimeValidation.message);
                        isValid = false;
                    } else {
                        taskData.fixedTime = Math.round(fixedTimeValidation.value);
                    }
                    break;
                    
                case 'continuous':
                case 'continuous_redeem':
                    const multiplierValidation = validateNumberInput(
                        document.getElementById('multiplier').value,
                        '时间倍率'
                    );
                    if (!multiplierValidation.valid) {
                        showFieldError('multiplier', 'multiplierError', multiplierValidation.message);
                        isValid = false;
                    } else {
                        taskData.multiplier = multiplierValidation.value;
                    }
                    break;
                    
                case 'continuous_target':
                    const targetMultiplierValidation = validateNumberInput(
                        document.getElementById('multiplier').value,
                        '时间倍率'
                    );
                    const targetTimeValidation = validateNumberInput(
                        document.getElementById('targetTime').value,
                        '目标时长'
                    );
                    const bonusRewardValidation = validateNumberInput(
                        document.getElementById('bonusReward').value,
                        '额外奖励'
                    );
                    
                    if (!targetMultiplierValidation.valid) {
                        showFieldError('multiplier', 'multiplierError', targetMultiplierValidation.message);
                        isValid = false;
                    } else {
                        taskData.multiplier = targetMultiplierValidation.value;
                    }
                    
                    if (!targetTimeValidation.valid) {
                        showFieldError('targetTime', 'targetTimeError', targetTimeValidation.message);
                        isValid = false;
                    } else {
                        taskData.targetTime = Math.round(targetTimeValidation.value);
                    }
                    
                    if (!bonusRewardValidation.valid) {
                        showFieldError('bonusReward', 'bonusRewardError', bonusRewardValidation.message);
                        isValid = false;
                    } else {
                        taskData.bonusReward = Math.round(bonusRewardValidation.value);
                    }
                    break;
            }
            
            if (!isValid) {
                return;
            }
            
            if (currentEditingTask) {
                // 编辑现有任务
                const taskIndex = tasks.findIndex(t => t.id === currentEditingTask.id);
                if (taskIndex !== -1) {
                    // 保留原有的ID、创建时间、最后使用时间和完成次数
                    taskData.id = currentEditingTask.id;
                    taskData.createdAt = currentEditingTask.createdAt;
                    taskData.lastUsed = currentEditingTask.lastUsed;
                    taskData.achieved = currentEditingTask.achieved || false;
                    taskData.completionCount = currentEditingTask.completionCount || 0;
                    
                    tasks[taskIndex] = taskData;
                }
            } else {
                // 创建新任务
                taskData.id = generateId();
                taskData.createdAt = new Date().toISOString();
                taskData.lastUsed = null;
                taskData.achieved = false;
                taskData.completionCount = 0;
                
                tasks.push(taskData);
            }
            
            // 分配分类颜色
            if (!categoryColors.has(category)) {
                const colorIndex = categoryColors.size % colors.length;
                categoryColors.set(category, colors[colorIndex]);
            }
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
            updateCategoryRecommendations();
            hideTaskModal();
        }

        // 显示字段错误
        function showFieldError(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            
            field.classList.add('error');
            error.textContent = message;
            error.classList.add('show');
        }

        // 删除任务
        function deleteTask() {
            if (!currentEditingTask) return;
            
            if (confirm('确定要删除这个任务吗？此操作不可撤销。')) {
                // 停止任务（如果正在运行）
                if (runningTasks.has(currentEditingTask.id)) {
                    stopTask(currentEditingTask.id);
                }
                
                // 从任务列表中移除
                tasks = tasks.filter(t => t.id !== currentEditingTask.id);
                
                saveData();
                updateRecentTasks();
                updateCategoryTasks();
                hideTaskModal();
            }
        }

        // 开始任务 - 改进的持久化版本
        function startTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // 更新最后使用时间
            task.lastUsed = new Date().toISOString();
            
            if (task.type === 'continuous' || task.type === 'continuous_redeem' || task.type === 'continuous_target') {
                // 持续任务：重新开始计时（每次都从0开始）
                const now = Date.now();
                runningTasks.set(taskId, {
                    startTime: now,
                    elapsedTime: 0, // 每次都从0开始
                    achieved: false, // 重置达标状态
                    isPaused: false,
                    lastSaveTime: now // 添加最后保存时间用于持久化
                });
                
                // 重置任务的达标状态
                if (task.type === 'continuous_target') {
                    task.achieved = false;
                }
            }
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
        }

        // 暂停任务 - 改进的持久化版本
        function pauseTask(taskId) {
            const runningTask = runningTasks.get(taskId);
            if (!runningTask || runningTask.isPaused) return;
            
            const now = Date.now();
            // 计算已运行时间并暂停
            runningTask.elapsedTime += now - runningTask.startTime;
            runningTask.isPaused = true;
            runningTask.startTime = now; // 更新开始时间为暂停时间
            runningTask.lastSaveTime = now; // 更新保存时间
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
        }

        // 恢复任务 - 改进的持久化版本
        function resumeTask(taskId) {
            const runningTask = runningTasks.get(taskId);
            if (!runningTask || !runningTask.isPaused) return;
            
            const now = Date.now();
            // 恢复计时
            runningTask.isPaused = false;
            runningTask.startTime = now;
            runningTask.lastSaveTime = now; // 更新保存时间
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
        }

        // 停止任务
        function stopTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const runningTask = runningTasks.get(taskId);
            if (!runningTask) return;
            
            // 计算总时间
            const totalTime = runningTask.elapsedTime + (runningTask.isPaused ? 0 : Date.now() - runningTask.startTime);
            const totalSeconds = Math.floor(totalTime / 1000);
            
            let earnedTime = 0;
            let description = '';
            
            if (task.type === 'continuous') {
                // 持续任务（自由）
                earnedTime = Math.floor(totalSeconds * task.multiplier);
                description = `完成持续任务"${task.name}"`;
            } else if (task.type === 'continuous_redeem') {
                // 持续兑换
                earnedTime = -Math.floor(totalSeconds * task.multiplier);
                description = `进行持续兑换"${task.name}"`;
            } else if (task.type === 'continuous_target') {
                // 持续任务（达标）
                const baseTime = Math.floor(totalSeconds * task.multiplier);
                
                if (totalSeconds >= task.targetTime) {
                    // 达标：基础时间 + 额外奖励
                    earnedTime = baseTime + task.bonusReward;
                    description = `完成达标任务"${task.name}"（已达标）`;
                    task.achieved = true;
                } else {
                    // 未达标：只有基础时间
                    earnedTime = baseTime;
                    description = `完成持续任务"${task.name}"（未达标）`;
                }
            }
            
            // 增加完成次数
            task.completionCount = (task.completionCount || 0) + 1;
            
            // 更新余额和交易记录
            currentBalance += earnedTime;
            addTransaction(description, earnedTime);
            
            // 移除运行状态
            runningTasks.delete(taskId);
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
        }

        // 取消任务
        function cancelTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const runningTask = runningTasks.get(taskId);
            if (!runningTask) return;
            
            // 直接移除运行状态，不计入任务时间和次数
            runningTasks.delete(taskId);
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
        }

        // 完成任务
        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // 更新最后使用时间
            task.lastUsed = new Date().toISOString();
            
            let earnedTime = 0;
            let description = '';
            
            if (task.type === 'reward') {
                // 奖励任务
                earnedTime = task.fixedTime;
                description = `完成奖励任务"${task.name}"`;
            } else if (task.type === 'instant_redeem') {
                // 即时兑换
                earnedTime = -task.fixedTime;
                description = `进行即时兑换"${task.name}"`;
            }
            
            // 增加完成次数
            task.completionCount = (task.completionCount || 0) + 1;
            
            // 更新余额和交易记录
            currentBalance += earnedTime;
            addTransaction(description, earnedTime);
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
        }

        // 更新运行中的任务计时器
        function updateRunningTimers() {
            let hasUpdate = false;
            
            runningTasks.forEach((runningTask, taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (!task) {
                    runningTasks.delete(taskId);
                    return;
                }
                
                // 如果任务暂停，不更新计时
                if (runningTask.isPaused) {
                    return;
                }
                
                // 计算当前总时间
                const currentTotalTime = runningTask.elapsedTime + (Date.now() - runningTask.startTime);
                const totalSeconds = Math.floor(currentTotalTime / 1000);
                
                // 检查达标任务是否达标
                if (task.type === 'continuous_target' && !runningTask.achieved && totalSeconds >= task.targetTime) {
                    runningTask.achieved = true;
                    task.achieved = true;
                    
                    // 发送达标通知
                    if (notificationSettings.enabled && notificationSettings.achievement) {
                        sendNotification('时间银行提醒', `恭喜！您的任务"${task.name}"已达标！`);
                    }
                    
                    hasUpdate = true;
                }
                
                // 检查长时间运行提醒
                if (task.type === 'continuous_redeem' && 
                    notificationSettings.enabled && 
                    notificationSettings.longRunning &&
                    totalSeconds > 0 && 
                    totalSeconds % notificationSettings.longRunningThreshold === 0) {
                    
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    let timeStr = '';
                    if (hours > 0) {
                        timeStr = `${hours}小时`;
                        if (minutes > 0) timeStr += `${minutes}分钟`;
                    } else {
                        timeStr = `${minutes}分钟`;
                    }
                    
                    sendNotification('时间银行提醒', `您的任务"${task.name}"已运行超过${timeStr}，注意休息哦！`);
                }
                
                // 定期保存数据（每30秒保存一次）
                const now = Date.now();
                if (now - runningTask.lastSaveTime >= 30000) {
                    runningTask.lastSaveTime = now;
                    hasUpdate = true;
                }
            });
            
            if (hasUpdate) {
                saveData();
            }
            
            // 更新界面显示
            updateRecentTasks();
            updateCategoryTasks();
        }

        // 更新分类推荐
        function updateCategoryRecommendations() {
            const categories = [...new Set(tasks.map(t => t.category))];
            const container = document.getElementById('categoryRecommendations');
            
            if (categories.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = categories.map(category => 
                `<div class="recommendation-item" onclick="setCategoryRecommendation('${category}')">${category}</div>`
            ).join('');
        }

        // 设置分类推荐
        function setCategoryRecommendation(category) {
            document.getElementById('taskCategory').value = category;
        }

        // 添加交易记录
        function addTransaction(description, amount) {
            const now = new Date();
            const todayKey = now.toISOString().split('T')[0]; // YYYY-MM-DD

            transactions.unshift({
                id: generateId(),
                description,
                amount,
                timestamp: now.toISOString(),
                undone: false // 添加撤销状态标记
            });

            // 更新每日变化
            if (!dailyChanges) {
                dailyChanges = {};
            }
            if (!dailyChanges[todayKey]) {
                dailyChanges[todayKey] = 0;
            }
            dailyChanges[todayKey] += amount;

            // 只保留最近100条记录
            if (transactions.length > 100) {
                transactions = transactions.slice(0, 100);
            }
        }

        // 更新余额显示
        function updateBalance() {
            const balanceCard = document.getElementById("balanceCard");
            const balanceAmount = document.getElementById("currentBalanceAmount");

            balanceAmount.textContent = formatTime(currentBalance);

            // 设置数字颜色
            if (currentBalance < 0) {
                balanceCard.classList.add("negative");
                balanceAmount.style.color = "#f44336"; // 红色
            } else if (currentBalance > 0) {
                balanceCard.classList.remove("negative");
                balanceAmount.style.color = "#2196F3"; // 蓝色
            } else {
                balanceCard.classList.remove("negative");
                balanceAmount.style.color = "#888"; // 灰色
            }

            // 更新今日/昨日变化
            updateDailyChanges();
            
            // 检查余额不足预警
            if (notificationSettings.enabled && 
                notificationSettings.lowBalance && 
                currentBalance > 0 && 
                currentBalance <= notificationSettings.lowBalanceThreshold) {
                
                const timeStr = formatTime(currentBalance);
                sendNotification("时间银行提醒", `您的时间余额已不足${timeStr}，请及时补充哦！`);
            }
        }

        // 更新今日/昨日变化
        function updateDailyChanges() {
            const today = new Date();
            const todayKey = today.toISOString().split('T')[0];

            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const yesterdayKey = yesterday.toISOString().split('T')[0];

            const todayChange = (dailyChanges && dailyChanges[todayKey]) || 0;
            const yesterdayChange = (dailyChanges && dailyChanges[yesterdayKey]) || 0;

            const todayChangeElement = document.getElementById('todayChange');
            const yesterdayChangeElement = document.getElementById('yesterdayChange');

            if (todayChangeElement) {
                todayChangeElement.textContent = `今日变化: ${todayChange >= 0 ? '+' : ''}${formatTime(Math.abs(todayChange))}`;
                todayChangeElement.style.color = todayChange >= 0 ? '#4CAF50' : '#f44336';
            }
            if (yesterdayChangeElement) {
                yesterdayChangeElement.textContent = `昨日变化: ${yesterdayChange >= 0 ? '+' : ''}${formatTime(Math.abs(yesterdayChange))}`;
                yesterdayChangeElement.style.color = yesterdayChange >= 0 ? '#4CAF50' : '#f44336';
            }
        }

        // 更新报告
        function updateReports() {
            const totalEarned = transactions
                .filter(t => t.amount > 0 && !t.undone)
                .reduce((sum, t) => sum + t.amount, 0);

            const totalSpent = Math.abs(transactions
                .filter(t => t.amount < 0 && !t.undone)
                .reduce((sum, t) => sum + t.amount, 0));

            const totalTasks = transactions.filter(t => !t.undone).length;

            document.getElementById('totalEarned').textContent = formatTime(totalEarned);
            document.getElementById('totalSpent').textContent = formatTime(totalSpent);
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById("currentBalance").textContent = formatTime(currentBalance);

            // 更新交易历史
            const transactionList = document.getElementById('transactionList');
            const activeTransactions = transactions.filter(t => !t.undone);
            
            if (activeTransactions.length === 0) {
                transactionList.innerHTML = '<div class="empty-message">暂无交易记录</div>';
            } else {
                transactionList.innerHTML = activeTransactions.map(transaction => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-name">${transaction.description}</div>
                            <div class="transaction-time">${formatDateTime(transaction.timestamp)}</div>
                        </div>
                        <div class="transaction-amount ${transaction.amount > 0 ? 'positive' : 'negative'}">
                            ${transaction.amount > 0 ? '+' : ''}${formatTime(Math.abs(transaction.amount))}
                        </div>
                    </div>
                `).join('');
            }
        }

        // 格式化时间显示 (单行智能显示)
        function formatTime(totalSeconds) {
            if (totalSeconds === 0) return '0秒';
            const absSeconds = Math.abs(totalSeconds);
            
            if (absSeconds >= 86400) { // 超过24小时，显示天和小时
                const days = Math.floor(absSeconds / 86400);
                const hours = Math.floor((absSeconds % 86400) / 3600);
                return `${days}天${hours}小时`;
            } else if (absSeconds >= 3600) { // 超过1小时，显示小时和分钟
                const hours = Math.floor(absSeconds / 3600);
                const minutes = Math.floor((absSeconds % 3600) / 60);
                return `${hours}小时${minutes}分钟`;
            } else if (absSeconds >= 60) { // 超过1分钟，显示分钟和秒
                const minutes = Math.floor(absSeconds / 60);
                const seconds = absSeconds % 60;
                return `${minutes}分钟${seconds}秒`;
            } else { // 小于1分钟，显示秒
                return `${absSeconds}秒`;
            }
        }

        // 格式化日期时间
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // 通知相关函数
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationSettings.enabled = true;
                        updateNotificationSettings();
                        saveData();
                    }
                });
            }
        }

        function sendNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyUzYuNDggMjIgMTIgMjJTMjIgMTcuNTIgMjIgMTJTMTcuNTIgMiAxMiAyWk0xMyAxN0gxMVYxNUgxM1YxN1pNMTMgMTNIMTFWN0gxM1YxM1oiIGZpbGw9IiMyMTk2RjMiLz4KPC9zdmc+',
                    tag: 'timebank-notification'
                });
            }
        }

        function updateNotificationSettings() {
            document.getElementById('notificationsEnabled').checked = notificationSettings.enabled;
            document.getElementById('achievementNotification').checked = notificationSettings.achievement;
            document.getElementById('longRunningNotification').checked = notificationSettings.longRunning;
            document.getElementById('longRunningThreshold').value = notificationSettings.longRunningThreshold;
            document.getElementById('lowBalanceNotification').checked = notificationSettings.lowBalance;
            document.getElementById('lowBalanceThreshold').value = notificationSettings.lowBalanceThreshold;
            document.getElementById('inactiveTaskNotification').checked = notificationSettings.inactiveTask;
            document.getElementById('inactiveTaskThreshold').value = notificationSettings.inactiveTaskThreshold;
        }

        // 通知设置事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 通知总开关
            document.getElementById('notificationsEnabled').addEventListener('change', function(e) {
                if (e.target.checked && Notification.permission !== 'granted') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            notificationSettings.enabled = true;
                        } else {
                            e.target.checked = false;
                            notificationSettings.enabled = false;
                        }
                        saveData();
                    });
                } else {
                    notificationSettings.enabled = e.target.checked;
                    saveData();
                }
            });

            // 其他通知开关
            document.getElementById('achievementNotification').addEventListener('change', function(e) {
                notificationSettings.achievement = e.target.checked;
                saveData();
            });

            document.getElementById('longRunningNotification').addEventListener('change', function(e) {
                notificationSettings.longRunning = e.target.checked;
                saveData();
            });

            document.getElementById('longRunningThreshold').addEventListener('change', function(e) {
                notificationSettings.longRunningThreshold = parseInt(e.target.value);
                saveData();
            });

            document.getElementById('lowBalanceNotification').addEventListener('change', function(e) {
                notificationSettings.lowBalance = e.target.checked;
                saveData();
            });

            document.getElementById('lowBalanceThreshold').addEventListener('change', function(e) {
                notificationSettings.lowBalanceThreshold = parseInt(e.target.value);
                saveData();
            });

            document.getElementById('inactiveTaskNotification').addEventListener('change', function(e) {
                notificationSettings.inactiveTask = e.target.checked;
                saveData();
            });

            document.getElementById('inactiveTaskThreshold').addEventListener('change', function(e) {
                notificationSettings.inactiveTaskThreshold = parseInt(e.target.value);
                saveData();
            });
        });

        // 数据持久化 - 改进的版本
        function saveData() {
            const data = {
                currentBalance,
                tasks,
                transactions,
                categoryColors: Array.from(categoryColors.entries()),
                collapsedCategories: Array.from(collapsedCategories),
                runningTasks: Array.from(runningTasks.entries()).map(([id, task]) => {
                    // 保存时计算当前的实际已运行时间
                    const now = Date.now();
                    const actualElapsedTime = task.elapsedTime + (task.isPaused ? 0 : now - task.startTime);
                    return [id, {
                        ...task,
                        elapsedTime: actualElapsedTime,
                        startTime: now, // 保存当前时间作为新的开始时间
                        lastSaveTime: now
                    }];
                }),
                notificationSettings,
                dailyChanges,
                version: '2.8'
            };
            localStorage.setItem('timeBankData', JSON.stringify(data));
        }

        // 数据加载 - 改进的版本
        function loadData() {
            const data = localStorage.getItem('timeBankData');
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    currentBalance = parsed.currentBalance || 0;
                    tasks = parsed.tasks || [];
                    transactions = parsed.transactions || [];
                    categoryColors = new Map(parsed.categoryColors || []);
                    collapsedCategories = new Set(parsed.collapsedCategories || []);
                    notificationSettings = { ...notificationSettings, ...(parsed.notificationSettings || {}) };
                    dailyChanges = parsed.dailyChanges || {};
                    
                    // 恢复运行中的任务状态 - 改进的逻辑
                    if (parsed.runningTasks) {
                        const now = Date.now();
                        runningTasks = new Map(parsed.runningTasks.map(([id, task]) => {
                            // 如果任务是暂停状态，直接恢复
                            if (task.isPaused) {
                                return [id, {
                                    ...task,
                                    startTime: now,
                                    lastSaveTime: now
                                }];
                            } else {
                                // 如果任务是运行状态，计算从上次保存到现在的时间差
                                const timeSinceLastSave = now - task.startTime;
                                return [id, {
                                    ...task,
                                    startTime: now, // 重新设置开始时间为当前时间
                                    elapsedTime: task.elapsedTime + timeSinceLastSave,
                                    lastSaveTime: now
                                }];
                            }
                        }));
                    }
                    
                    // 确保所有任务都有completionCount字段
                    tasks.forEach(task => {
                        if (task.completionCount === undefined) {
                            task.completionCount = 0;
                        }
                    });
                    
                    // 确保所有交易都有undone字段
                    transactions.forEach(transaction => {
                        if (transaction.undone === undefined) {
                            transaction.undone = false;
                        }
                    });
                } catch (e) {
                    console.error('Failed to load data:', e);
                }
            }
        }

        // 数据清除功能
        function clearTimeData() {
            if (!confirm('确定要清除所有时间数据吗？这将清除所有交易记录和余额，但保留任务设置。此操作不可撤销！')) {
                return;
            }
            
            // 清除时间相关数据
            transactions = [];
            runningTasks.clear();
            currentBalance = 0;
            dailyChanges = {};
            
            // 重置任务的完成统计
            tasks.forEach(task => {
                task.completionCount = 0;
                task.lastCompleted = null;
            });
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            
            alert('时间数据已清除！');
        }

        function clearAllData() {
            if (!confirm('确定要清除所有数据吗？这将删除所有任务、时间记录和设置，恢复到初始状态。此操作不可撤销！')) {
                return;
            }
            
            // 清除所有数据
            tasks = [];
            transactions = [];
            runningTasks.clear();
            currentBalance = 0;
            dailyChanges = {};
            categoryColors.clear();
            collapsedCategories.clear();
            
            // 重置通知设置为默认值
            notificationSettings = {
                enabled: false,
                achievement: true,
                longRunning: true,
                longRunningThreshold: 30,
                lowBalance: true,
                lowBalanceThreshold: 300,
                inactiveTask: true,
                inactiveTaskThreshold: 7
            };
            
            // 清除本地存储
            localStorage.removeItem('timeBankData');
            
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            updateCategoryRecommendations();
            updateNotificationSettings();
            
            alert('所有数据已清除！');
        }

        // 导出数据
        function exportData() {
            const data = {
                currentBalance,
                tasks,
                transactions,
                categoryColors: Array.from(categoryColors.entries()),
                collapsedCategories: Array.from(collapsedCategories),
                notificationSettings,
                exportDate: new Date().toISOString(),
                version: '2.8'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timebank_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('导入数据将覆盖当前所有数据，确定要继续吗？')) {
                        currentBalance = data.currentBalance || 0;
                        tasks = data.tasks || [];
                        transactions = data.transactions || [];
                        categoryColors = new Map(data.categoryColors || []);
                        collapsedCategories = new Set(data.collapsedCategories || []);
                        notificationSettings = { ...notificationSettings, ...(data.notificationSettings || {}) };
                        
                        // 清除运行中的任务状态
                        runningTasks.clear();
                        
                        // 确保所有任务都有completionCount字段
                        tasks.forEach(task => {
                            if (task.completionCount === undefined) {
                                task.completionCount = 0;
                            }
                        });
                        
                        // 确保所有交易都有undone字段
                        transactions.forEach(transaction => {
                            if (transaction.undone === undefined) {
                                transaction.undone = false;
                            }
                        });

                        saveData();
                        updateBalance();
                        updateRecentTasks();
                        updateCategoryTasks();
                        updateReports();
                        updateCategoryRecommendations();
                        updateNotificationSettings();
                        
                        alert('数据导入成功！');
                    }
                } catch (error) {
                    alert('导入失败：文件格式不正确');
                }
            };
            reader.readAsText(file);
        }

        // 主题管理功能
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemThemeEnabled = localStorage.getItem('systemTheme') === 'true';
            
            // 更新开关状态
            document.getElementById('systemThemeToggle').checked = systemThemeEnabled;
            
            if (systemThemeEnabled) {
                // 跟随系统主题
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                setTheme(prefersDark ? 'dark' : 'light');
                document.getElementById('darkModeToggle').checked = prefersDark;
                document.getElementById('darkModeToggle').disabled = true;
            } else {
                // 使用保存的主题
                const theme = savedTheme || 'light';
                setTheme(theme);
                document.getElementById('darkModeToggle').checked = theme === 'dark';
                document.getElementById('darkModeToggle').disabled = false;
            }
            
            // 监听系统主题变化
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (document.getElementById('systemThemeToggle').checked) {
                    setTheme(e.matches ? 'dark' : 'light');
                    document.getElementById('darkModeToggle').checked = e.matches;
                }
            });
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            if (!document.getElementById('systemThemeToggle').checked) {
                localStorage.setItem('theme', theme);
            }
        }

        function toggleDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const systemThemeToggle = document.getElementById('systemThemeToggle');
            
            if (systemThemeToggle.checked) {
                return; // 如果跟随系统主题，不允许手动切换
            }
            
            const newTheme = darkModeToggle.checked ? 'dark' : 'light';
            setTheme(newTheme);
        }

        function toggleSystemTheme() {
            const systemThemeToggle = document.getElementById('systemThemeToggle');
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            localStorage.setItem('systemTheme', systemThemeToggle.checked);
            
            if (systemThemeToggle.checked) {
                // 启用跟随系统主题
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                setTheme(prefersDark ? 'dark' : 'light');
                darkModeToggle.checked = prefersDark;
                darkModeToggle.disabled = true;
                localStorage.removeItem('theme'); // 清除手动设置的主题
            } else {
                // 禁用跟随系统主题
                darkModeToggle.disabled = false;
                const currentTheme = darkModeToggle.checked ? 'dark' : 'light';
                setTheme(currentTheme);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            initTheme();
            
            // 绑定主题切换事件
            document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
            document.getElementById('systemThemeToggle').addEventListener('change', toggleSystemTheme);
        });

        // 点击模态框背景关闭
        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideTaskModal();
            }
        });

        document.getElementById('historyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideHistoryModal();
            }
        });
    </script>
</body>
</html>

