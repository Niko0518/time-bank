<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´é“¶è¡Œ - Time Bank v4.4.0</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ—¶é—´é“¶è¡Œ">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>
    <style>
        /* --- [v3.7.7] Fixed Layout Implementation --- */
        :root {
            /* 1.3.2. Spacing Tokens */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 24px;
            --space-xxl: 32px;

            /* Other variables */
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.1);
            --text-color: #333;
            --text-color-light: #666;
            --border-color: #ddd;
            --input-bg: #fff;
            --header-text: white;
            --section-title-color: white;
            --btn-secondary-bg: #f5f5f5;
            --btn-secondary-text: #666;
            --btn-secondary-border: #ddd;
            --habit-border-width: 2px; /* [v3.12.6] Reduced from 4px */
            --dropdown-bg: #ffffff;
            --dropdown-shadow: rgba(0, 0, 0, 0.15);
            --color-primary: #2196F3;
            --color-positive: #4CAF50;
            --color-negative: #f44336;
            --color-warning: #FF9800;
            --color-neutral: #607D8B;
            --color-other: #BDBDBD; /* [v3.10.4] Lighter Gray */
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --card-bg: rgba(42, 42, 42, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.3);
            --text-color: #e0e0e0;
            --text-color-light: #aaa;
            --border-color: #444;
            --input-bg: #2a2a2a;
            --header-text: #e0e0e0;
            --section-title-color: #e0e0e0;
            --btn-secondary-bg: #3a3a3a;
            --btn-secondary-text: #e0e0e0;
            --btn-secondary-border: #555;
            --dropdown-bg: #3a3a3a;
            --dropdown-shadow: rgba(0, 0, 0, 0.5);
            --color-other: #616161; /* [v3.10.4] Lighter Gray for Dark Mode */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            padding-bottom: 80px;
            overscroll-behavior-y: contain; /* Prevent pull-to-refresh */
            overflow-x: hidden; /* [v3.13.2] Prevent horizontal scroll */
        }

        .header {
            text-align: center;
            padding: var(--space-xl);
            padding-bottom: 0;
            color: var(--header-text);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: var(--space-sm);
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .main-container {
            padding: 0 var(--space-lg);
        }
        @media (min-width: 480px) {
            .main-container { padding: 0 var(--space-xl); }
        }

        .balance-card {
            margin-top: var(--space-lg);
            margin-bottom: var(--space-lg);
            background: var(--card-bg);
            border-radius: 15px;
            padding: var(--space-lg);
            text-align: center;
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            cursor: pointer; /* [v4.1.0] Added */
        }

        .balance-card.negative { background: rgba(255, 235, 238, 0.95); border-color: var(--color-negative); }
        [data-theme="dark"] .balance-card.negative { background: rgba(40, 20, 20, 0.95); }
        .balance-title { font-size: 0.9rem; color: var(--text-color-light); margin-bottom: var(--space-sm); }
        .balance-amount { font-size: 2.2rem; font-weight: bold; margin-bottom: var(--space-lg); color: var(--color-primary); }
        .daily-changes { display: flex; justify-content: space-between; font-size: 0.8rem; }
        .daily-change { color: var(--text-color-light); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: var(--space-xl) 0 var(--space-lg) 0;
            color: var(--section-title-color);
        }

        .recent-tasks-grid, .category-tasks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }
        @media (min-width: 480px) {
            .recent-tasks-grid, .category-tasks-grid {
                gap: var(--space-lg);
            }
        }
        
        .task-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: var(--space-md);
            box-shadow: 0 4px 16px var(--card-shadow);
            backdrop-filter: blur(10px);
            position: relative; /* Needed for ::before */
            overflow: visible;
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            min-width: 0; 
        }

        /* [v3.12.6] Add default border to all cards for visual consistency */
        .task-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            right: 0;
            box-shadow: inset 0 0 0 var(--habit-border-width) var(--border-color); /* Default border */
            border-radius: 12px;
            pointer-events: none;
        }

        /* [v3.12.5] Changed to full inset border shadow */
        /* [v3.12.6] Simplified to only override the color */
        .task-card.is-habit::before {
            /* All other properties are inherited from .task-card::before */
            box-shadow: inset 0 0 0 var(--habit-border-width) var(--habit-color, #ccc); /* Habit color override */
        }
        
        .task-row { display: flex; align-items: center; min-width: 0; }
        .task-row.title-row { justify-content: space-between; gap: var(--space-sm); margin-bottom: var(--space-xs); }
        
        /* [v3.17.1] UI Change: Limit task name width and prevent wrap */
        .task-name { 
            font-size: 0.9rem; 
            font-weight: 600; 
            flex: 1; 
            /* word-wrap: break-word; */ /* [v3.17.1] Removed */
            /* white-space: normal; */ /* [v3.17.1] Removed */
            white-space: nowrap; /* [v3.17.1] Added */
            overflow: hidden; /* [v3.17.1] Added */
            text-overflow: clip; /* [v3.17.1] Added */
            max-width: 7.5em; /* [v3.17.1] Added */
        }
        /* [v3.17.1] Removed @media rule for 1080px as requested */

        .task-details { font-size: 0.75rem; color: var(--text-color-light); display: flex; flex-wrap: wrap; align-items: center; gap: 6px; }
        .task-parameters { font-size: 0.8rem; color: var(--text-color-light); justify-content: flex-start; padding: 2px 0; }
        .task-category { color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 500; }
        .task-completion-count { color: var(--color-positive); font-weight: 500; font-size: 0.7rem; }
        
        .task-actions { display: flex; gap: var(--space-xs); width: 100%; margin-top: var(--space-xs); }
        .task-btn { padding: 8px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; text-align: center; flex: 1; }
        .task-btn.wide { padding: 10px; }
        .task-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        .task-btn.primary { background: var(--color-primary); color: white; } .task-btn.success { background: var(--color-positive); color: white; } .task-btn.warning { background: var(--color-warning); color: white; } .task-btn.danger { background: var(--color-negative); color: white; } .task-btn.secondary { background: #9E9E9E; color: white; }

        .task-timer-status { width: 100%; text-align: center; margin-top: var(--space-xs); }
        .task-timer { font-size: 0.9rem; font-weight: 600; color: var(--color-primary); }
        
        .more-btn { background: none; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; color: var(--text-color-light); padding: 0 4px; border-radius: 4px; flex-shrink: 0; line-height: 1; }
        .more-btn:hover { background: var(--btn-secondary-bg); color: var(--text-color); }
        .task-card-menu { display: none; position: absolute; top: 35px; right: 10px; background: var(--dropdown-bg); border-radius: 8px; box-shadow: 0 4px 12px var(--dropdown-shadow); z-index: 10; overflow: hidden; border: 1px solid var(--border-color); }
        .task-card-menu.show { display: block; }
        .task-card-menu-item { padding: 10px 15px; font-size: 0.85rem; color: var(--text-color); cursor: pointer; white-space: nowrap; }
        .task-card-menu-item:hover { background: rgba(0,0,0,0.05); }
        [data-theme="dark"] .task-card-menu-item:hover { background: rgba(255,255,255,0.1); }
        
        .category-tasks { margin-bottom: var(--space-xl); }
        .category-header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: var(--space-md) var(--space-lg); border-radius: 10px; margin-bottom: var(--space-md); cursor: pointer; }
        .category-header:hover { background: rgba(255, 255, 255, 1); }
        .category-info { display: flex; align-items: center; gap: var(--space-md); }
        .category-color { width: 12px; height: 12px; border-radius: 50%; }
        .category-name { font-weight: 600; font-size: 0.95rem; }
        .category-count { color: var(--text-color-light); font-size: 0.85rem; }
        .category-toggle { transition: transform 0.2s ease; font-size: 0.8rem; color: var(--text-color-light); }
        .category-header.collapsed .category-toggle { transform: rotate(-90deg); }
        .category-tasks-list { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease; }
        .category-tasks-list.collapsed { max-height: 0; }
        
        .empty-message { text-align: center; color: rgba(255, 255, 255, 0.7); font-style: italic; padding: 40px 20px; }
        [data-theme="dark"] .empty-message { color: rgba(255, 255, 255, 0.5); }
        
        .fab { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--color-primary); color: white; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4); z-index: 1000; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6); }

        .bottom-tabs { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); display: flex; border-top: 1px solid rgba(0, 0, 0, 0.1); z-index: 1000; }
        .tab-button { flex: 1; padding: 12px 8px; border: none; background: none; text-align: center; cursor: pointer; font-size: 0.75rem; color: var(--text-color-light); }
        .tab-button.active { color: var(--color-primary); background: rgba(33, 150, 243, 0.1); }
        .tab-icon { font-size: 1.2rem; margin-bottom: var(--space-xs); }
        [data-theme="dark"] .bottom-tabs { background: var(--card-bg); border-top-color: var(--border-color); }
        [data-theme="dark"] .tab-button.active { background: rgba(33, 150, 243, 0.2); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        .modal.show { display: flex; align-items: center; justify-content: center; opacity: 1; }
        .modal-content { background: var(--input-bg); border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: var(--space-xl); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal.show .modal-content { transform: scale(1); }
        #dayDetailModal .modal-content { overflow-x: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); }
        .modal-title { font-size: 1.2rem; font-weight: 600; color: var(--text-color); }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color-light); padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }

        .form-group { margin-bottom: var(--space-xl); }
        .form-label { display: block; margin-bottom: var(--space-sm); font-weight: 500; color: var(--text-color); }
        .form-input, .form-select { width: 100%; padding: var(--space-md); border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: var(--input-bg); color: var(--text-color); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--color-primary); }
        .form-input.error, .form-select.error { border-color: var(--color-negative); }
        .error-message { color: var(--color-negative); font-size: 0.85rem; margin-top: var(--space-sm); display: none; }
        .error-message.show { display: block; }
        .hidden { display: none !important; }

        .time-presets { display: flex; gap: var(--space-sm); margin-top: var(--space-sm); flex-wrap: wrap; }
        .time-preset { padding: 6px 12px; background: var(--btn-secondary-bg); border: 1px solid var(--btn-secondary-border); border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
        .time-preset:hover { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .recommendations { display: flex; gap: var(--space-sm); margin-top: var(--space-sm); flex-wrap: wrap; }
        .recommendation-item { padding: 4px 8px; background: #e3f2fd; border: 1px solid var(--color-primary); border-radius: 12px; font-size: 0.8rem; cursor: pointer; color: var(--color-primary); }
        .recommendation-item:hover { background: var(--color-primary); color: white; }
        [data-theme="dark"] .recommendation-item { background: rgba(33, 150, 243, 0.2); border-color: var(--color-primary); }

        .color-selector { display: grid; grid-template-columns: repeat(8, 1fr); gap: var(--space-sm); }
        .color-swatch { width: 100%; padding-bottom: 100%; border-radius: 50%; cursor: pointer; position: relative; border: 2px solid transparent; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: var(--color-primary); }
        .color-swatch.disabled { cursor: not-allowed; opacity: 0.3; }
        .color-swatch .checkmark { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1rem; }
        .color-swatch.selected .checkmark { display: block; }

        .form-buttons { display: flex; gap: var(--space-md); margin-top: var(--space-xxl); justify-content: flex-end; }
        .form-buttons .btn { flex: 0 0 auto; white-space: nowrap; }
        .form-buttons .btn-secondary:first-child { margin-right: auto; }
        .btn { padding: var(--space-md); border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .btn-primary { background: var(--color-primary); color: white; } .btn-secondary { background: var(--btn-secondary-bg); color: var(--btn-secondary-text); } .btn-danger { background: var(--color-negative); color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
        
        .habit-settings { border: 2px solid var(--color-primary); border-radius: 8px; padding: var(--space-lg); margin-top: var(--space-xl); background-color: rgba(33, 150, 243, 0.05); }
        [data-theme="dark"] .habit-settings { background-color: rgba(33, 150, 243, 0.1); }
        .habit-settings-title { font-size: 1rem; font-weight: 600; color: var(--color-primary); margin-bottom: var(--space-xl); }
        /* [v3.18.0] Increased grid columns to accommodate new input fields */
        .habit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); }
        .habit-reward-rule { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: var(--space-md); align-items: center; padding: var(--space-md); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: var(--space-md); }
        .habit-reward-rule .form-input, .habit-reward-rule .form-select { padding: var(--space-sm); font-size: 0.9rem; }
        .remove-reward-btn { background: var(--color-negative); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold; }

        .input-group { display: flex; gap: var(--space-sm); align-items: center; }
        .input-group input[type="number"] { width: 60px; text-align: right; }
        .input-group span { color: var(--text-color-light); font-size: 0.9rem; }

        .mode-switch { display: flex; justify-content: center; }
        .mode-switch button { flex: 1; padding: 8px; border: 1px solid var(--border-color); background: none; color: var(--text-color); cursor: pointer; font-size: 0.9rem; }
        .mode-switch button:first-child { border-radius: 6px 0 0 6px; border-right: none; }
        .mode-switch button:last-child { border-radius: 0 6px 6px 0; }
        .mode-switch button.active { background: var(--color-primary); color: white; border-color: var(--color-primary); }

        /* [v3.11.0] Backdate Modal Styles */
        #backdateModal .input-group { margin-bottom: var(--space-lg); }
        #backdateModal .mode-switch { margin-bottom: var(--space-lg); }

        .report-section { background: var(--card-bg); border-radius: 12px; padding: var(--space-lg); margin-bottom: var(--space-xl); box-shadow: 0 4px 16px var(--card-shadow); }
        @media(min-width: 1441px) { .report-section { padding: var(--space-xl); } }

        .report-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md); margin-bottom: var(--space-lg); }
        .report-title { font-size: 1.1rem; font-weight: 600; color: var(--text-color); }
        .report-filters { display: flex; gap: var(--space-sm); flex-wrap: wrap; }
        .report-filters button, .analysis-controls button, .analysis-view-switcher button { padding: 4px 8px; font-size: 0.8rem; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-color); border-radius: 6px; cursor: pointer; white-space: nowrap; }
        .report-filters button.active, .analysis-controls button.active, .analysis-view-switcher button.active { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }

        /* [v3.12.2] Further reduced Flow Chart gap */
        .flow-chart-container { 
            display: flex; 
            flex-direction: column; 
            gap: var(--space-sm); /* From md to sm */
        } 
        /* [v3.12.3] Adjust flow bar margin for precise spacing */
        .flow-bar-block { margin-bottom: var(--space-sm); } /* From lg to sm */
        .flow-bar-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: var(--space-sm); }
        .flow-bar-title { font-size: 0.95rem; font-weight: 600; color: var(--text-color); }
        .flow-bar-total { font-size: 0.9rem; color: var(--text-color-light); }
        .flow-bar { display: flex; height: 28px; border-radius: 6px; overflow: hidden; background-color: var(--border-color); width: 100%; }
        .flow-bar-segment { height: 100%; position: relative; border-right: 1px solid rgba(0,0,0,0.1); }
        .flow-bar-segment:last-child { border-right: none; }
        .flow-bar-segment .tooltip { visibility: hidden; background-color: rgba(51, 51, 51, 0.9); color: #fff; text-align: center; border-radius: 6px; padding: 6px 10px; position: absolute; z-index: 1; bottom: 130%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.2s; font-size: 0.8rem; white-space: nowrap; pointer-events: none; }
        .flow-bar-segment:hover .tooltip { visibility: visible; opacity: 1; }

        .heatmap-nav { display: flex; align-items: center; gap: var(--space-md); }
        .heatmap-nav button { background: none; border: 1px solid var(--border-color); color: var(--text-color); border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
        .heatmap-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
        .heatmap-month-label { font-size: 0.9rem; font-weight: 600; width: 100px; text-align: center; }
        .heatmap-grid-wrapper { margin-top: var(--space-lg); }
        .heatmap-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 0.7rem; text-align: center; margin-bottom: 5px; color: var(--text-color-light); }
        .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .heatmap-day, .heatmap-spacer { width: 100%; padding-bottom: 100%; position: relative; }
        .heatmap-day { cursor: pointer; }
        .heatmap-day-content { position: absolute; top:0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; background-color: var(--btn-secondary-bg); border-radius: 4px; }
        .heatmap-day:hover .heatmap-day-content { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 2; }
        
        .heatmap-day-content.net-surplus-1 { background-color: #9be9a8; } .heatmap-day-content.net-surplus-2 { background-color: #40c463; } .heatmap-day-content.net-surplus-3 { background-color: #216e39; color: white; }
        .heatmap-day-content.net-deficit-1 { background-color: #ffcdd2; } .heatmap-day-content.net-deficit-2 { background-color: #e57373; } .heatmap-day-content.net-deficit-3 { background-color: #f44336; color: white; }
        [data-theme="dark"] .heatmap-day-content.net-surplus-1 { background-color: #0e4429; } [data-theme="dark"] .heatmap-day-content.net-surplus-2 { background-color: #006d32; } [data-theme="dark"] .heatmap-day-content.net-surplus-3 { background-color: #26a641; }
        [data-theme="dark"] .heatmap-day-content.net-deficit-1 { background-color: #4a1e1e; } [data-theme="dark"] .heatmap-day-content.net-deficit-2 { background-color: #992e2e; } [data-theme="dark"] .heatmap-day-content.net-deficit-3 { background-color: #c93333; }
        
        .heatmap-legend { display: flex; justify-content: flex-end; align-items: center; gap: 5px; font-size: 0.75rem; color: var(--text-color-light); margin-top: var(--space-md); flex-wrap: wrap; }
        .legend-box { width: 12px; height: 12px; border-radius: 2px; }
        
        /* [v3.12.1] Fix table border overflow */
        .analysis-table-container { 
            overflow-x: auto; 
        }
        .analysis-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .analysis-table th, .analysis-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .analysis-table th { font-weight: 600; user-select: none; }
         .analysis-table td:nth-child(2),
         .analysis-table td:nth-child(3)
         { white-space: nowrap; }
        .table-footer-row td {
            padding: var(--space-md);
            text-align: center;
            border-bottom: none;
        }
        .show-more-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color-light);
            padding: var(--space-sm) var(--space-lg);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .show-more-btn:hover {
            background: var(--btn-secondary-bg);
        }

        .text-positive { color: var(--color-positive); font-weight: 500; } .text-negative { color: var(--color-negative); font-weight: 500; } .text-neutral { color: var(--color-neutral); font-weight: 500; }

        .task-name-scrollable {
            display: block; 
            max-width: 80px;
            overflow-x: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: grab;
            scrollbar-width: none;
            -ms-overflow-style: none;
            outline: none;
        }
        .task-name-scrollable::-webkit-scrollbar {
            display: none;
        }
        .task-name-scrollable:focus, 
        .task-name-scrollable:hover { 
            overflow-x: auto;
            text-overflow: clip; 
            cursor: grabbing;
        }
        
        .stat-card { background: var(--card-bg); border-radius: 12px; padding: var(--space-lg); text-align: center; box-shadow: 0 4px 16px var(--card-shadow); min-width: 0; }
        .stat-value { font-size: 1.2rem; font-weight: bold; margin-bottom: var(--space-sm); white-space: nowrap; }
        #totalEarned.stat-value { color: var(--color-primary); } #totalSpent.stat-value { color: #E64A19; }
        .stat-label { font-size: 0.85rem; color: var(--text-color-light); }
        
        .settings-section { background: var(--card-bg); border-radius: 12px; padding: var(--space-xl); margin-bottom: var(--space-xl); box-shadow: 0 4px 16px var(--card-shadow); }
        /* [v3.12.3] Reduce title margin */
        .settings-title { font-size: 1.1rem; font-weight: 600; margin-bottom: var(--space-md); color: var(--text-color); }
        
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg) 0; border-bottom: 1px solid var(--border-color); gap: var(--space-lg); }
        .setting-item:last-child { border-bottom: none; }
        .setting-info { flex: 1; min-width: 0; }
        .setting-name { font-weight: 500; margin-bottom: 2px; }
        .setting-desc { font-size: 0.85rem; color: var(--text-color-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .setting-controls { display: flex; align-items: center; gap: var(--space-md); }

        .theme-selector { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .theme-option { flex: 1; padding: 8px; text-align: center; background: none; border: none; cursor: pointer; font-size: 0.85rem; color: var(--text-color); border-left: 1px solid var(--border-color); }
        .theme-option:first-child { border-left: none; }
        .theme-option.active { background: var(--color-primary); color: white; }

        .switch { position: relative; display: inline-block; width: 50px; height: 24px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        .threshold-input { width: 80px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem; background-color: var(--input-bg); color: var(--text-color); }

        /* [v3.11.1] Ensure data buttons stay on one line */
        .data-buttons { display: flex; gap: var(--space-md); margin-top: var(--space-lg); justify-content: center; flex-wrap: nowrap; /* Prevent wrapping */ }
        .data-btn { flex: 1; /* Allow shrinking */ padding: var(--space-md); border: 2px solid var(--color-primary); border-radius: 8px; background: white; color: var(--color-primary); font-size: 0.9rem; font-weight: 500; cursor: pointer; text-align: center; white-space: nowrap; /* Prevent text wrapping inside button */ }
        .data-btn:hover { background: var(--color-primary); color: white; }
        [data-theme="dark"] .data-btn { background: var(--card-bg); color: var(--color-primary); }
        [data-theme="dark"] .data-btn:hover { background: var(--color-primary); color: white; }
        .file-input { display: none; }
        
        /* [v4.0.0] Styles for Auth UI */
        #authForm { display: grid; grid-template-columns: 1fr; gap: var(--space-md); }
        #authForm .form-group { margin-bottom: 0; }
        #authButtons { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-top: var(--space-lg); }
        #authStatus { 
            font-size: 0.9rem; 
            text-align: center; 
            margin-top: var(--space-lg);
            padding: var(--space-md);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        #authStatus.status-offline { background-color: rgba(108, 117, 125, 0.1); border-color: #6c757d; color: #6c757d; }
        #authStatus.status-online { background-color: rgba(76, 175, 80, 0.1); border-color: var(--color-positive); color: var(--color-positive); }
        #authStatus.status-error { background-color: rgba(244, 67, 54, 0.1); border-color: var(--color-negative); color: var(--color-negative); }
        #authStatus.status-syncing { background-color: rgba(33, 150, 243, 0.1); border-color: var(--color-primary); color: var(--color-primary); }
        [data-theme="dark"] #authStatus.status-offline { color: #aaa; }
        
        .about-section details { margin-top: var(--space-lg); border: 1px solid var(--border-color); border-radius: 8px; padding: var(--space-md) var(--space-lg); }
        .about-section summary { font-weight: 500; cursor: pointer; outline: none; }
        .about-section p { font-size: 0.9rem; line-height: 1.6; margin: var(--space-md) 0; color: var(--text-color-light); }
        .about-section ul { list-style-position: inside; padding-left: var(--space-md); }
        .about-section li { font-size: 0.9rem; margin-bottom: var(--space-sm); }
        .version-history-container { max-height: 300px; overflow-y: auto; padding-right: var(--space-md); }
        
        /* [v3.13.2] Style for code snippets in version history to prevent overflow */
        .about-section code {
            font-family: monospace;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.85em;
            word-break: break-all; /* Critical for preventing overflow */
        }
        [data-theme="dark"] .about-section code {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .history-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: var(--space-md) 0; 
            border-bottom: 1px solid var(--border-color); 
            gap: var(--space-sm); 
        }
        .history-item:last-child { border-bottom: none; }
        .history-info { flex-grow: 1; min-width: 0; }
        .history-description { font-weight: 500; margin-bottom: 2px; }
        .history-description .desc-line-1,
        .history-description .desc-line-2 {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        .history-description .desc-line-2 {
            font-size: 0.8rem;
            color: var(--text-color-light);
        }
        .history-time { font-size: 0.8rem; color: var(--text-color-light); }
        .history-amount-wrapper { flex-shrink: 0; width: 80px; text-align: right; }
        .history-amount { font-weight: 600; font-size: 0.9rem; }
        .history-amount.positive { color: var(--color-positive); } 
        .history-amount.negative { color: var(--color-negative); }
        .undo-btn { background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); border: 1px solid var(--btn-secondary-border); padding: 4px 8px; font-size: 0.75rem; border-radius: 5px; cursor: pointer; flex-shrink: 0; }
        .undo-btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .day-detail-summary { margin-bottom: var(--space-lg); padding-bottom: var(--space-lg); border-bottom: 1px solid var(--border-color); text-align: center; }
        .day-detail-net { font-size: 1.2rem; font-weight: bold; margin-bottom: var(--space-sm); }
        .day-detail-stats { font-size: 0.9rem; color: var(--text-color-light); }

        #analysisDashboard { display: flex; flex-direction: column; gap: var(--space-xl); }
        
        .kpi-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg); 
        }

        .kpi-card { background: var(--card-bg); border-radius: 12px; padding: var(--space-lg); text-align: center; }
        .kpi-label { font-size: 0.8rem; color: var(--text-color-light); margin-bottom: var(--space-sm); }
        .kpi-value { font-size: 1.1rem; font-weight: 600; word-wrap: break-word; }
        .kpi-value.positive { color: var(--color-positive); } .kpi-value.negative { color: var(--color-negative); }
        .kpi-value.kpi-time {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chart-container { background: var(--card-bg); border-radius: 12px; padding: var(--space-lg); }
        .chart-title { font-size: 0.95rem; font-weight: 600; text-align: center; margin-bottom: var(--space-lg); }

        .leaderboard-chart { display: flex; flex-direction: column; gap: var(--space-sm); }
        /* [v3.10.3] Leaderboard Layout Tweak for Category View */
        .leaderboard-chart.category-view .leaderboard-item { grid-template-columns: minmax(auto, 65px) 1fr; }
        .leaderboard-item { display: grid; grid-template-columns: minmax(auto, 80px) 1fr; align-items: center; gap: var(--space-sm); font-size: 0.8rem; cursor: pointer; min-width: 0; }
        .leaderboard-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color-light); text-align: right;}
        .leaderboard-bar-wrapper { width: 100%; background: var(--border-color); border-radius: 4px; position: relative; display: flex; align-items: center;}
        .leaderboard-bar { height: 18px; border-radius: 4px; }
        /* [v3.10.3] Leaderboard Label Style Update */
        .leaderboard-bar-value { 
            position: absolute; 
            font-size: 0.7rem; 
            font-weight: 500; 
            color: white; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            left: 5px; /* Always left-aligned */
            white-space: nowrap;
        }

        .swiper-container {
            overflow: hidden;
            position: relative;
            width: 100%;
        }
        .swiper-wrapper {
            display: flex;
            width: 200%; /* Default for 2 slides */
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .swiper-slide {
            width: 50%; /* Default for 2 slides */
            flex-shrink: 0;
            padding: 0 5px;
        }
        /* [v3.14.1] Re-enabled for interactive charts */
        .swiper-pagination {
           position: relative; /* Not absolute, so it sits in the layout flow */
           bottom: auto;
           padding-top: var(--space-sm); /* Space from chart */
           height: 12px; /* Fixed height to prevent jump */
           display: flex;
           justify-content: center;
           align-items: center;
           gap: 6px;
        }
        .swiper-pagination-bullet {
            /* [v3.14.1] Re-enabled */
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
            opacity: 0.7;
            cursor: pointer;
        }
        .swiper-pagination-bullet-active {
            background: var(--color-primary);
            opacity: 1;
        }

        .trend-chart-container { display: grid; grid-template-columns: 1fr; gap: var(--space-xl);}
        .trend-chart { width: 100%; display: flex; justify-content: space-between; gap: 2px; overflow: hidden; padding-bottom: var(--space-sm); }
        .trend-day { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; background: var(--border-color); border-radius: 4px; position: relative; cursor: pointer; }
        .trend-day .tooltip { visibility: hidden; background-color: rgba(0,0,0,0.8); color: #fff; text-align: left; border-radius: 6px; padding: var(--space-sm); position: absolute; z-index: 1; bottom: 110%; left: 50%; transform: translateX(-50%); opacity: 0; font-size: 0.75rem; white-space: nowrap; pointer-events: none; }
        .trend-day:hover .tooltip { visibility: visible; opacity: 1; }
        .trend-segment { width: 100%; }
        .trend-date-label { font-size: 0.7rem; color: var(--text-color-light); text-align: center; margin-top: var(--space-xs); }
        
        .analysis-filters { 
            display: flex; 
            flex-wrap: nowrap; 
            justify-content: space-between; 
            align-items: center; 
            gap: var(--space-md); 
            margin-bottom: var(--space-md); 
        }
        .analysis-filters > div:first-child { flex: 1 1 auto; min-width: 0; display: flex; flex-wrap: wrap; gap: var(--space-sm); align-items: center; } /* [v3.12.4] Reverted */
        .analysis-filters > div:last-child { flex: 0 0 auto; } /* [v3.12.4] Reverted */
        
        .analysis-view-switcher { display: flex; gap: var(--space-sm); }
        
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: var(--space-xs) var(--space-sm); margin-top: var(--space-xs); }
        .legend-item { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.7rem; }
        .legend-color-box { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
        .legend-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        
        #tableContainerWrapper { margin-top: var(--space-xl); }

        /* [v3.10.3] Pie Chart with Legend and Inner Labels */
        .pie-chart-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-md);
        }
        .pie-chart-container {
            position: relative;
            width: 180px; /* Centered pie area */
            height: 180px;
            margin: 0 auto;
        }
        .pie-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            background: conic-gradient( from 0deg, var(--color-other) 0% 100% );
        }
        .pie-chart::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 45%; /* Smaller hole */
            height: 45%;
            background: var(--card-bg);
            border-radius: 50%;
        }
        .pie-slice-labels {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .pie-slice-label {
            position: absolute;
            font-size: 10px;
            font-weight: 500;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            transform: translate(-50%, -50%);
            line-height: 1.2;
            text-align: center;
        }
         .pie-slice-label .time-value {
            font-size: 9px;
            opacity: 0.9;
        }
        .pie-chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: calc(180px * 0.45);
            height: calc(180px * 0.45);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .pie-center-title {
            font-size: 0.75rem;
            color: var(--text-color-light);
        }
        .pie-center-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
        }
        .pie-chart-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: var(--space-xs) var(--space-md);
            margin-top: var(--space-sm);
            padding: 0 var(--space-lg);
            width: 100%;
        }
        .pie-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-color-light);
        }
        .pie-legend-color-box {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        /* [v3.14.1] Increased min-height for pagination dots */
        #pieChartContainerWrapper.task-view-active {
            min-height: 248px; /* 228 + 20px for pagination */
        }
        #pieChartContainerWrapper.category-view-active {
            min-height: 208px; /* 188 + 20px for pagination */
        }
        #leaderboardContainerWrapper {
            min-height: 168px; /* 148 + 20px for pagination */
        }
        
        /* [v3.12.4] Specific override for dashboard filter alignment */
        #analysisDashboardFilters.analysis-filters > div:last-child {
            display: flex; /* Ensure it's a flex container to allow justify-content */
            justify-content: flex-end; /* Align the inner .report-filters to the right */
        }
        #analysisDashboardFilters .report-filters {
            width: auto; /* Prevent the button group from stretching unnecessarily */
        }
        
        /* [v3.14.1] FIX: Force dashboard filter bar to grow */
        #analysisDashboardFilters {
            flex-grow: 1;
        }
        
    </style>
</head>
<body>
<div class="header">
        <h1>æ—¶é—´é“¶è¡Œ</h1>
        <p>Time Bank v4.4.0</p>
    </div>

    <div class="main-container">

        <div class="balance-card" id="balanceCard" onclick="showTodayDetails()">
            <div class="balance-title">å½“å‰ä½™é¢</div>
            <div class="balance-amount" id="balanceAmount">0ç§’</div>
            <div class="daily-changes">
                <div class="daily-change">ä»Šæ—¥è·å¾—: <span id="dailyEarned">0ç§’</span></div>
                <div class="daily-change">ä»Šæ—¥æ¶ˆè´¹: <span id="dailySpent">0ç§’</span></div>
            </div>
        </div>

        <div class="tab-content active" id="earnTab">
            <div class="recent-tasks">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                    <span id="earnTasksTitle">æœ€è¿‘ä»»åŠ¡</span>
                    <button id="earnViewToggleBtn" class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; flex-shrink: 0;" onclick="toggleEarnView()">
                        ğŸ“… ä»Šæ—¥ä¹ æƒ¯
                    </button>
                </div>
                <div id="recentEarnTasks" class="recent-tasks-grid"></div>
            </div>
            
            <div class="section-title">åˆ†ç±»ä»»åŠ¡</div>
            <div id="categoryEarnTasks"></div>
        </div>

        <div class="tab-content" id="spendTab">
            <div class="recent-tasks">
                <div class="section-title">æœ€è¿‘ä»»åŠ¡</div>
                <div id="recentSpendTasks" class="recent-tasks-grid"></div>
            </div>
            
            <div class="section-title">åˆ†ç±»ä»»åŠ¡</div>
            <div id="categorySpendTasks"></div>
        </div>

        <div class="tab-content" id="reportTab">
            
            <div class="report-section">
                <div class="report-header">
                    <h2 class="report-title">æ—¶é—´æµå›¾</h2> <div class="report-filters" id="flowChartFilters">
                        <button class="active" data-period="7d">7å¤©å†…</button>
                        <button data-period="30d">30å¤©å†…</button>
                        <button data-period="all">å…¨éƒ¨</button>
                    </div>
                </div>
                <div id="flowChartContainer" class="flow-chart-container"></div>
            </div>
            
            <div class="report-section">
                 <div class="report-header">
                    <h2 class="report-title">æ´»åŠ¨æ—¥å†</h2>
                    <div class="heatmap-nav">
                        <button id="heatmapPrevMonth">&lt;</button>
                        <span id="heatmapMonthLabel"></span>
                        <button id="heatmapNextMonth">&gt;</button>
                    </div>
                </div>
                <div class="heatmap-grid-wrapper">
                    <div class="heatmap-weekdays">
                        <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
                    </div>
                    <div id="heatmapGrid" class="heatmap-grid"></div>
                </div>
                <div class="heatmap-legend" id="heatmapLegend"></div>
            </div>

            <div class="report-section">
                <div class="report-header">
                    <h2 class="report-title">æ—¶é—´æ´å¯Ÿä»ªè¡¨ç›˜</h2>
                    <div class="analysis-filters" id="analysisDashboardFilters"></div>
                </div>
                <div id="analysisDashboard">
                    <div class="kpi-grid" id="kpiGrid"></div>
                    
                    <div class="report-section" id="interactiveAnalysisWrapper" style="padding: 0; box-shadow: none; background: transparent;">
                        <div class="report-header">
                            <h2 class="report-title" style="color: var(--text-color);">äº’åŠ¨åˆ†æ</h2>
                            <div class="analysis-view-switcher report-filters" id="insightViewSwitcher"></div>
                        </div>
                        <div id="pieChartContainerWrapper"></div>
                        <div id="leaderboardContainerWrapper" class="hidden"></div>
                    </div>

                </div>
            </div>

            <div class="report-section" id="tableWrapper">
                <div class="report-header">
                    <h2 class="report-title">è¯¦ç»†æ•°æ®</h2>
                </div>
                <div id="tableContainerWrapper"></div>
            </div>

            <div class="report-section" id="trendChartWrapper">
                <div class="report-header">
                    <h2 class="report-title">è¶‹åŠ¿æ¼”å˜</h2>
                </div>
                <div id="trendChartContainerWrapper"></div>
            </div>

        </div>

        <div class="tab-content" id="settingsTab">
            <div class="settings-section">
                <div class="settings-title">å¤–è§‚è®¾ç½®</div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">ä¸»é¢˜æ¨¡å¼</div>
                        <div class="setting-desc">é€‰æ‹©äº®è‰²ã€æš—è‰²æˆ–è·Ÿéšç³»ç»Ÿ</div>
                    </div>
                    <div class="setting-controls">
                        <div class="theme-selector">
                            <button class="theme-option" data-theme-value="light" onclick="setTheme('light')">äº®è‰²</button>
                            <button class="theme-option" data-theme-value="dark" onclick="setTheme('dark')">æš—è‰²</button>
                            <button class="theme-option" data-theme-value="system" onclick="setTheme('system')">ç³»ç»Ÿ</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section" id="syncSection">
                <div class="settings-title">æ•°æ®åŒæ­¥</div>
                
                <div id="authStatusContainer" class="hidden">
                    <div id="authStatus" class="status-offline">æœªç™»å½•</div>
                    <button class="btn btn-danger" id="logoutButton" onclick="handleLogout()" style="width: 100%; margin-top: var(--space-lg);">é€€å‡ºç™»å½•</button>
                </div>

                <form id="authFormContainer">
                    <div id="authForm">
                        <div class="form-group">
                            <label for="authUsername" class="form-label">ç”¨æˆ·å</label>
                            <input type="text" id="authUsername" class="form-input" placeholder="è¾“å…¥ç”¨æˆ·å" required>
                        </div>
                        <div class="form-group">
                            <label for="authPassword" class="form-label">å¯†ç </label>
                            <input type="password" id="authPassword" class="form-input" placeholder="è¾“å…¥å¯†ç " required>
                        </div>
                        <div class="form-group hidden" id="authEmailGroup">
                            <label for="authEmail" class="form-label">é‚®ç®± (å¯é€‰)</label>
                            <input type="email" id="authEmail" class="form-input" placeholder="ç”¨äºæ‰¾å›å¯†ç ">
                        </div>
                    </div>
                    <div id="authButtons">
                        <button type="button" class="btn btn-secondary" id="registerButton" onclick="handleRegister()">æ³¨å†Œ</button>
                        <button type="button" class="btn btn-primary" id="loginButton" onclick="handleLogin()">ç™»å½•</button>
                    </div>
                    <div class="error-message" id="authError" style="text-align: center; margin-top: var(--space-lg);"></div>
                </form>
            </div>

            <div class="settings-section">
                <div class="settings-title">é€šçŸ¥è®¾ç½®</div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">æˆå°±é€šçŸ¥</div>
                        <div class="setting-desc">å®Œæˆä»»åŠ¡æˆ–è¾¾æˆç›®æ ‡æ—¶æ˜¾ç¤ºé€šçŸ¥</div>
                    </div>
                    <div class="setting-controls">
                        <label class="switch">
                            <input type="checkbox" id="achievementNotificationToggle" onchange="toggleAchievementNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">é•¿æ—¶é—´è¿è¡Œæé†’</div>
                        <div class="setting-desc">ä»»åŠ¡è¿è¡Œè¶…è¿‡è®¾å®šæ—¶é—´æ—¶æé†’</div>
                    </div>
                    <div class="setting-controls">
                        <input type="number" id="longRunningThreshold" class="threshold-input" 
                               value="3600" min="300" step="300" onchange="updateLongRunningThreshold()" 
                               placeholder="ç§’">
                        <label class="switch">
                            <input type="checkbox" id="longRunningNotificationToggle" onchange="toggleLongRunningNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">ä½™é¢ä¸è¶³æé†’</div>
                        <div class="setting-desc">ä½™é¢ä½äºè®¾å®šå€¼æ—¶æé†’</div>
                    </div>
                    <div class="setting-controls">
                        <input type="number" id="lowBalanceThreshold" class="threshold-input" 
                               value="1800" min="0" step="300" onchange="updateLowBalanceThreshold()" 
                               placeholder="ç§’">
                        <label class="switch">
                            <input type="checkbox" id="lowBalanceNotificationToggle" onchange="toggleLowBalanceNotifications()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">æ¯æ—¥ä¹ æƒ¯æé†’</div>
                        <div class="setting-desc">åœ¨æŒ‡å®šæ—¶é—´æé†’å½“å¤©æœªå®Œæˆçš„ä¹ æƒ¯</div>
                    </div>
                    <div class="setting-controls">
                        <input type="time" id="habitNudgeTime" class="threshold-input" style="width: 80px;" onchange="updateHabitNudgeTime()">
                        <label class="switch">
                            <input type="checkbox" id="habitNudgeToggle" onchange="toggleHabitNudge()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                 <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-name">é€šçŸ¥è¯Šæ–­</div>
                        </div>
                    <div class="setting-controls">
                         <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 0.9rem;" onclick="sendTestNotification()">å‘é€æµ‹è¯•é€šçŸ¥</button>
                    </div>
                </div>
                </div>

            <div class="settings-section">
                <div class="settings-title">æ•°æ®ç®¡ç†</div>
                <div class="data-buttons" id="data-btn-container">
                    <button class="data-btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                    <button class="data-btn" onclick="document.getElementById('importFile').click()">å¯¼å…¥æ•°æ®</button>
                    <button class="data-btn" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
                </div>
                <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
            </div>
            
            <div class="settings-section about-section">
                <div class="settings-title">å…³äº</div>
                
                <div class="version-history-item">
                    <p><strong>ç‰ˆæœ¬ v4.4.0 (2025-11-06)</strong></p>
                    <ul>
                        <li><strong>[Feat]</strong> å°†â€œæœ€è¿‘ä»»åŠ¡â€çš„æ˜¾ç¤ºä¸Šé™ä» 6 ä¸ªæ‹“å±•åˆ° 8 ä¸ªï¼ˆåº”ç”¨äºè·å¾—/æ¶ˆè´¹æ ‡ç­¾é¡µï¼‰ã€‚</li>
                        <li><strong>[Feat]</strong> åœ¨â€œè·å¾—æ—¶é—´â€æ ‡ç­¾é¡µæ–°å¢â€œæœ€è¿‘ä»»åŠ¡ / ä»Šæ—¥ä¹ æƒ¯â€è§†å›¾åˆ‡æ¢å™¨ã€‚</li>
                        <li><strong>[Feat]</strong> â€œä»Šæ—¥ä¹ æƒ¯â€è§†å›¾ä¼˜å…ˆæ˜¾ç¤ºâ€œå½“æ—¥æœªå®Œæˆâ€çš„æ¯æ—¥ä¹ æƒ¯ï¼Œå·²å®Œæˆçš„åˆ™æ²‰åº•ã€‚</li>
                        <li><strong>[UI]</strong> ä¼˜åŒ–ä¹ æƒ¯è¾¾æ ‡å¡ç‰‡æ–‡æœ¬ï¼Œç§»é™¤æ‹¬å·ï¼Œå¦‚ï¼š`å·²è¾¾æ ‡âœ…è¿ç»­Xå¤©`ã€‚</li>
                        <li><strong>[Fix]</strong> (é˜²å¾¡æ€§) ä¿®å¤äº† v4.4.0 æ–°å¢ UI å…ƒç´ åœ¨ JS å¯åŠ¨æ—¶å¯èƒ½æœªæ‰¾åˆ° (null)ï¼Œå¯¼è‡´åº”ç”¨å¯åŠ¨å¤±è´¥çš„æ½œåœ¨å´©æºƒ Bugã€‚</li>
                        <li><strong>[Admin]</strong> æ›´æ–° PWA ç¼“å­˜ç‰ˆæœ¬è‡³ `v4.4.0`ã€‚</li>
                    </ul>
                </div>

                <div class="version-history-item">
                    <p><strong>ç‰ˆæœ¬ v4.3.2 (2025-11-05)</strong></p>
                    <ul>
                        <li><strong>[Fix]</strong> ä¿®å¤äº† LiveQuery (å®æ—¶åŒæ­¥) æ›´æ–°UIæ—¶ï¼Œå›  `isSyncing` æ ‡å¿—å¯¼è‡´æ¸²æŸ“è¢«é˜»æ­¢çš„ Bug (UI å†»ç»“)ã€‚</li>
                        <li><strong>[Fix]</strong> ä¿®å¤äº† LiveQuery ä»…æ›´æ–°å†…å­˜æ•°æ®è€Œæœªæ›´æ–° `cloudDataObject` å¼•ç”¨ï¼Œå¯¼è‡´åå°è®¡æ—¶å™¨ä½¿ç”¨æ—§å¼•ç”¨è¦†ç›–äº‘ç«¯æ•°æ®çš„ä¸¥é‡ Bug (æ•°æ®ä¸¢å¤±)ã€‚</li>
                        <li><strong>[Admin]</strong> æ›´æ–° PWA ç¼“å­˜ç‰ˆæœ¬è‡³ `v4.3.2`ã€‚</li>
                    </ul>
                </div>
                
                 <details>
                    <summary>å†å²ç‰ˆæœ¬æ›´æ–°</summary>
                    <div class="version-history-container">

                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.3.1 (2025-11-04)</strong></p>
                            <ul>
                                <li><strong>[Fix]</strong> ä¿®å¤äº† `rebuildHabitStreak` å‡½æ•°ä¸­å›  `new Date("YYYY-MM-DD")` è§£ææ­§ä¹‰å¯¼è‡´çš„æ—¶åŒº Bugã€‚</li>
                                <li><strong>[Fix]</strong> è¯¥ Bug å¯¼è‡´åœ¨ç‰¹å®šæ—¶åŒºä¸‹ï¼Œè¿ç»­æ—¥æœŸçš„ `diffDays` è®¡ç®—é”™è¯¯ï¼Œä½¿å¾—è¡¥è®°ï¼ˆå¦‚è¡¥è®°æ˜¨å¤©ï¼‰å streak æ— æ³•æ­£ç¡®è¿ç»­è®¡ç®—ã€‚</li>
                                <li><strong>[Fix]</strong> ç°åœ¨å¼ºåˆ¶ä½¿ç”¨ `new Date(y, m, d)` æ„é€ å‡½æ•°åˆ›å»ºæœ¬åœ°æ—¥æœŸï¼Œç¡®ä¿æ—¥æœŸæ¯”è¾ƒçš„ç»å¯¹å¯é æ€§ã€‚</li>
                                <li><strong>[Admin]</strong> æ›´æ–° PWA ç¼“å­˜ç‰ˆæœ¬è‡³ `v4.3.1`ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.3.0 (2025-11-03)</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> å½»åº•é‡æ„â€œä¹ æƒ¯è¡¥è®°â€é€»è¾‘ï¼Œå¼•å…¥â€œStreak é‡å»ºâ€æœºåˆ¶ã€‚</li>
                                <li><strong>[Feat]</strong> è¡¥è®°æˆ–æ’¤å›ä¹ æƒ¯ä»»åŠ¡åï¼Œå°†è‡ªåŠ¨åŸºäºæ‰€æœ‰å†å²äº¤æ˜“é‡å»ºè¿ç»­çŠ¶æ€ï¼Œç¡®ä¿åœ¨ä»»ä½•æ“ä½œé¡ºåºä¸‹ï¼ˆå…ˆè¡¥è®°åå®Œæˆã€æˆ–å…ˆå®Œæˆåè¡¥è®°ï¼‰éƒ½èƒ½æ­£ç¡®å»¶ç»­ Streakã€‚</li>
                                <li><strong>[Fix]</strong> ä¿®å¤äº† v4.2.0 è¡¥è®°åŠŸèƒ½åœ¨ç‰¹å®šé¡ºåºä¸‹ï¼ˆå…ˆå®Œæˆä»Šå¤©å†è¡¥è®°æ˜¨å¤©ï¼‰ä¼šå¯¼è‡´ Streak é‡ç½®çš„ä¸¥é‡ Bugã€‚</li>
                                <li><strong>[Fix]</strong> ä¿®æ­£äº†â€œå…³äºâ€é¡µé¢ç‰ˆæœ¬æ—¥å¿—çš„å¸ƒå±€ï¼Œç¡®ä¿ v4.2.0 åŠæ›´æ—©ç‰ˆæœ¬è¢«æ­£ç¡®æŠ˜å ã€‚</li>
                                <li><strong>[Feat]</strong> è¡¥å…… v3.2.1 - v3.6.3 çš„å†å²ç‰ˆæœ¬æ›´æ–°æ—¥å¿—ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.2.1 (2025-11-02)</strong></p>
                            <ul>
                                <li><strong>[Fix]</strong> è¡¥å…… v1.0 - v3.0 çš„å†å²ç‰ˆæœ¬æ›´æ–°æ—¥å¿—ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.2.0 (2025-11-01)</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> æ‰©å±•è¡¥è®°åŠŸèƒ½ï¼šæ”¯æŒâ€œå›ºå®šå¥–åŠ±â€(Reward) ç±»ä»»åŠ¡ï¼ˆåŒ…æ‹¬ä¹ æƒ¯ï¼‰æŒ‰â€œæ¬¡æ•°â€è¿›è¡Œè¡¥è®°ã€‚</li>
                                <li><strong>[Feat]</strong> è¡¥è®°åŠŸèƒ½å¯ä¿®å¤ä¹ æƒ¯ï¼šè¡¥è®°â€œå›ºå®šå¥–åŠ±â€ç±»ä¹ æƒ¯ä»»åŠ¡æ—¶ï¼Œä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—å†å²è¿ç»­çŠ¶æ€ (Streak)ï¼Œä»¥æŒ½å›å› å¿˜è®°æ‰“å¡å¯¼è‡´çš„ä¸­æ–­ã€‚</li>
                                <li><strong>[Fix]</strong> ä¿®å¤ä¹ æƒ¯å¡ç‰‡UIé€»è¾‘ï¼šâ€œä»Šæ—¥å·²å®Œæˆ âœ…â€æ ‡è®°ç°åœ¨ä»…åœ¨è¾¾åˆ°â€œæ¯æ—¥å®Œæˆä¸Šé™â€ (Daily Limit) æ—¶æ‰æ˜¾ç¤ºï¼Œé¿å…åœ¨å¯å¤šæ¬¡å®Œæˆæ—¶äº§ç”Ÿè¯¯å¯¼ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.1.0 (2025-11-01)</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> å¢åŠ ä¾¿æ·æ“ä½œï¼Œç‚¹å‡»ä¸»ç•Œé¢çš„â€œæ—¶é—´ä½™é¢å¡ç‰‡â€å¯ç›´æ¥æŸ¥çœ‹â€œä»Šæ—¥è¯¦æƒ…â€ã€‚</li>
                                <li><strong>[Fix]</strong> å½»åº•ä¿®å¤äº† v4.0.5 é—ç•™çš„ Bugï¼šå¯¹äº N>1 çš„ä¹ æƒ¯ï¼ˆæ— è®ºæ¯æ—¥/æ¯å‘¨ï¼‰ï¼Œåœ¨æœªè¾¾æ ‡ä½†â€œä»Šå¤©æœ‰å®Œæˆâ€ï¼ˆå¦‚ 1/5ï¼‰æ—¶ï¼Œä¼šæ­£ç¡®æ˜¾ç¤º `å·²å®Œæˆ 1/5 æ¬¡`ï¼Œè€Œä¸æ˜¯ `ä»Šæ—¥å·²å®Œæˆ âœ…`ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.G.5 (2025-11-01)</strong></p>
                            <ul>
                                <li><strong>[Fix]</strong> ä¿®å¤äº† "æ¯æ—¥" ä¸” "ç›®æ ‡æ¬¡æ•° > 1" çš„ä¹ æƒ¯å¡ç‰‡é”™è¯¯æ˜¾ç¤ºä¸º "å·²è¿ç»­Xå¤©" çš„ Bugï¼Œç°åœ¨ä¼šæ­£ç¡®æ˜¾ç¤º "å·²å®Œæˆ X/N æ¬¡" è¿›åº¦ (å¦‚ "æ ‡å‡†ä¿¯å§æ’‘" ä»»åŠ¡)ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.0.4 (2025-10-31)</strong></p>
                            <ul>
                                <li><strong>[Fix]</strong> é‡æ„ä¹ æƒ¯å¡ç‰‡UIé€»è¾‘ï¼Œæ‰€æœ‰ç±»å‹ä¹ æƒ¯åœ¨å½“å¤©å®Œæˆåç»Ÿä¸€æ˜¾ç¤ºâ€œä»Šæ—¥å·²å®Œæˆ âœ…â€ã€‚</li>
                                <li><strong>[Fix]</strong> ä¿®å¤äº†å‘¨/æœˆä¹ æƒ¯åœ¨æœªå®Œæˆæ—¶é”™è¯¯æ˜¾ç¤ºâ€œå·²è¿ç»­Xå¤©â€çš„Bug (ç°åœ¨æ˜¾ç¤ºâ€œå·²å®ŒæˆX/Næ¬¡â€)ã€‚</li>
                                <li><strong>[Fix]</strong> (v4.0.3) æ¯æ—¥ä¹ æƒ¯åœ¨ä¸­æ–­åï¼Œå¡ç‰‡å°†æ˜¾ç¤ºâ€œæ˜¨æ—¥å·²ä¸­æ–­â€çŠ¶æ€ï¼Œç›´åˆ°ä¸‹æ¬¡æ‰“å¡ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.0.3 (2025-10-31)</strong></p>
                            <ul>
                                <li><strong>[Fix]</strong> é‡æ„äº†ä¹ æƒ¯å¡ç‰‡UIé€»è¾‘ï¼Œä¿®å¤äº†å‘¨/æœˆä¹ æƒ¯åœ¨æœªè¾¾æ ‡æ—¶é”™è¯¯æ˜¾ç¤ºâ€œå·²è¿ç»­Xå¤©â€çš„Bugã€‚</li>
                                <li><strong>[Fix]</strong> ä¿®å¤äº†å‘¨/æœˆä¹ æƒ¯å¡ç‰‡ç°åœ¨èƒ½æ­£ç¡®æ˜¾ç¤ºâ€œå·²å®Œæˆ X/N æ¬¡â€çš„è¿›åº¦ã€‚</li>
                                <li><strong>[Feat]</strong> æ¯æ—¥ä¹ æƒ¯åœ¨ä¸­æ–­åï¼Œå¡ç‰‡å°†æ˜¾ç¤ºâ€œæ˜¨æ—¥å·²ä¸­æ–­â€çŠ¶æ€ï¼Œç›´åˆ°ä¸‹æ¬¡æ‰“å¡ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.0.2 (2025-10-31)</strong></p>
                            <ul>
                                <li><strong>[Fix]</strong> ä¿®å¤äº† `sendTestNotification`ï¼ˆå‘é€æµ‹è¯•é€šçŸ¥ï¼‰æŒ‰é’®å› é”™è¯¯æ£€æŸ¥è®¾ç½®è€Œé™é»˜å¤±è´¥çš„ Bugã€‚</li>
                                <li><strong>[Fix]</strong> ä¿®å¤äº†ç™»å½•åâ€œæ•°æ®ç®¡ç†â€ï¼ˆå¯¼å‡º/å¯¼å…¥ï¼‰æ¨¡å—è¢«é”™è¯¯éšè—çš„ Bugã€‚</li>
                                <li><strong>[Fix]</strong> ç¼©çŸ­äº†ä»»åŠ¡æ¨¡æ€æ¡†ä¸­â€œå‘¨æœŸç›®æ ‡æ¬¡æ•°â€æ ‡ç­¾çš„æ–‡æœ¬ï¼Œä»¥é˜²æ­¢åœ¨ç§»åŠ¨ç«¯æ¢è¡Œç ´åå¸ƒå±€ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v4.0.0 (2025-10-31)</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> æ¶æ„å‡çº§ï¼šé›†æˆ LeanCloud BaaS æœåŠ¡ï¼Œå®ç°å¤šç«¯æ•°æ®å®æ—¶åŒæ­¥ã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢â€œæ•°æ®åŒæ­¥â€æ¨¡å—ï¼šæ”¯æŒç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€é€€å‡ºã€‚</li>
                                <li><strong>[Feat]</strong> å®ç°â€œäº‘ç«¯ä¼˜å…ˆâ€æ•°æ®æµï¼šç™»å½•åï¼Œæ•°æ®ä»äº‘ç«¯å®æ—¶è¯»å†™ï¼Œå¹¶è‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰è®¾å¤‡ã€‚</li>
                                <li><strong>[Feat]</strong> å®ç°â€œæœ¬åœ°æ¨¡å¼â€ï¼šæœªç™»å½•æ—¶ï¼Œåº”ç”¨ä¿æŒåŸæœ‰åŠŸèƒ½ï¼Œæ‰€æœ‰æ•°æ®è¯»å†™æœ¬åœ° `localStorage`ã€‚</li>
                                <li><strong>[Feat]</strong> é¦–æ¬¡ç™»å½•è‡ªåŠ¨è¿ç§»ï¼šæœ¬åœ°è€ç”¨æˆ·åœ¨é¦–æ¬¡ç™»å½•/æ³¨å†Œåï¼Œæ•°æ®å°†è‡ªåŠ¨ä¸Šä¼ è‡³äº‘ç«¯ã€‚</li>
                                <li><strong>[Refactor]</strong> é‡æ„ `loadData` å’Œ `saveData` å‡½æ•°ï¼Œä»¥æ”¯æŒæœ¬åœ°/äº‘ç«¯ä¸¤ç§æ¨¡å¼çš„æ— ç¼åˆ‡æ¢ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.18.0 (2025-10-28)</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> ä¹ æƒ¯ä»»åŠ¡æ–°å¢â€œå‘¨æœŸå†…ç›®æ ‡æ¬¡æ•°â€åŠŸèƒ½ï¼šæ”¯æŒè®¾ç½®æ¯å‘¨/æ¯æœˆéœ€è¦å®Œæˆçš„æ¬¡æ•° (N) æ‰èƒ½è¾¾æ ‡å’Œè§¦å‘è¿ç»­æ€§å¥–åŠ±ã€‚</li>
                                <li><strong>[Feat]</strong> ä»»åŠ¡å¡ç‰‡UIæ›´æ–°ï¼šå¯¹äºè®¾ç½®äº†ç›®æ ‡æ¬¡æ•° (N>1) çš„ä¹ æƒ¯ä»»åŠ¡ï¼Œæ˜¾ç¤ºè¿›åº¦â€œå·²å®Œæˆ X/N æ¬¡â€ã€‚</li>
                                <li><strong>[Fix]</strong> ä¿®å¤å¹¶ç»Ÿä¸€äº†æ‰€æœ‰ä¹ æƒ¯é€»è¾‘ä¸­å¯¹â€œå‘¨â€çš„è¾¹ç•Œåˆ¤æ–­ï¼Œå‘¨æœŸå§‹ç»ˆä¸ºå‘¨ä¸€è‡³å‘¨æ—¥ã€‚</li>
                                <li><strong>[Refactor]</strong> ä¼˜åŒ–äº†ä¹ æƒ¯è¾¾æ ‡é€»è¾‘ï¼Œç¡®ä¿ä¹ æƒ¯å¥–åŠ±ä»…åœ¨å‘¨æœŸå†…é¦–æ¬¡è¾¾æˆç›®æ ‡æ¬¡æ•°æ—¶è§¦å‘ï¼Œè¶…é¢å®Œæˆä»…è·å¾—åŸºç¡€å¥–åŠ±ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.17.3 (2025-10-27)</strong></p>
                            <ul>
                                <li><strong>[Fix]</strong> ä¿®å¤äº†â€œå¾ªç¯æé†’â€åŠŸèƒ½å› æ—¶åŒºè§£ææ­§ä¹‰å¯¼è‡´æé†’æ—¶é—´æ¼‚ç§»çš„ä¸¥é‡ Bugï¼ˆä¾‹å¦‚ 23:10 å˜ä¸ºæ¬¡æ—¥ 7:10ï¼‰ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.17.2 (2025-10-27)</strong></p>
                            <ul>
                                <li><strong>[Fix]</strong> ä¿®å¤äº†â€œå…³äºâ€é¡µé¢å¸ƒå±€é—®é¢˜ï¼Œç°åœ¨é»˜è®¤åªç›´æ¥æ˜¾ç¤ºæœ€æ–°ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—ï¼Œæ—§ç‰ˆæœ¬æ”¶çº³äºæŠ˜å åŒºåŸŸå†…ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.17.1 (2025-10-27)</strong></p>
                            <ul>
                                <li><strong>[Fix]</strong> ä¿®å¤äº†â€œå¾ªç¯æé†’â€åŠŸèƒ½çš„ä¸¥é‡ Bugã€‚è¯¥ Bug å¯¼è‡´åœ¨è®¡ç®—ä¸‹ä¸€æ¬¡æé†’æ—¶é—´æ—¶ï¼Œé”™è¯¯åœ°å°†æœ¬åœ°æ—¶é—´ï¼ˆå¦‚ 22:00ï¼‰è½¬æ¢ä¸º UTC æ—¶é—´ï¼ˆå¦‚æ¬¡æ—¥ 05:00ï¼‰ï¼Œå¯¼è‡´æé†’æ—¶é—´â€œæ¼‚ç§»â€åˆ°é”™è¯¯çš„æ—¶é—´ç‚¹ã€‚</li>
                                <li><strong>[UI]</strong> è°ƒæ•´äº†ä»»åŠ¡å¡ç‰‡ä¸Šä»»åŠ¡åç§°çš„ CSSï¼Œå¼ºåˆ¶å…¶ä¸æ¢è¡Œå¹¶é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé¿å…é•¿åç§°ç ´åå¸ƒå±€ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.17.0 (2025-10-26)</strong></p>
                            <ul>
                                <li><strong>[Refactor]</strong> é‡æ„â€œå…³äºâ€é¡µé¢å¸ƒå±€ï¼Œé»˜è®¤åªå±•å¼€æœ€æ–°ç‰ˆæœ¬æ—¥å¿—ã€‚</li>
                                <li><strong>[Fix]</strong> ä¿®æ­£â€œæŒ‰æ—¶é•¿è¡¥è®°â€æ—¶é—´æˆ³ï¼Œä½¿ç”¨è¡¥è®°æ“ä½œæ—¶åˆ»è€Œéå›ºå®šå€¼ã€‚</li>
                                <li><strong>[Feat]</strong> ä¸ºè¡¥è®°æ¡ç›®æ·»åŠ  ğŸ—“ï¸ æ ‡è®°ï¼Œå¹¶åœ¨å†å²è®°å½•ä¸­æ˜¾ç¤ºã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.16.0 (2025-10-26)</strong></p>
                            <ul>
                                <li><strong>[åŠŸèƒ½]</strong> å°†ä½™é¢ä¸ºè´Ÿæ—¶çš„æƒ©ç½šå€ç‡ä» 1.1 å€æé«˜åˆ° 1.2 å€ï¼Œå¹¶æ›´æ–°äº†æ‰€æœ‰ç›¸å…³æç¤ºã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> æé†’ç³»ç»Ÿä¼˜åŒ–ï¼šå¦‚æœä»»åŠ¡ï¼ˆåŒ…æ‹¬å•æ¬¡å’Œä¹ æƒ¯ï¼‰åœ¨æé†’è§¦å‘å‰å·²è¢«å®Œæˆï¼Œåˆ™è‡ªåŠ¨è·³è¿‡è¯¥æ¬¡é€šçŸ¥ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.15.1 (2025-10-25)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†â€œè®¾ç½®-æ•°æ®ç®¡ç†â€ä¸­â€œå¯¼å…¥æ•°æ®â€åŠŸèƒ½ç‚¹å‡»åæ— ååº”çš„ä¸¥é‡ Bugã€‚è¯¥é—®é¢˜ç”± v3.15.0 ä¸­ <code>FileReader</code> çš„æ–¹æ³•åæ‹¼å†™é”™è¯¯ (<code>readText</code> åº”ä¸º <code>readAsText</code>) å¯¼è‡´ã€‚</li>
                            </ul>
                        </div>
                         <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.15.0 (2025-10-25)</strong></p>
                            <ul>
                                <li><strong>[åŠŸèƒ½]</strong> æ–°å¢â€œæœªå®Œæˆä¹ æƒ¯æé†’â€ï¼šå¯åœ¨â€œè®¾ç½®-é€šçŸ¥è®¾ç½®â€ä¸­å¼€å¯ï¼Œåœ¨æ¯å¤©æŒ‡å®šæ—¶é—´æ£€æŸ¥å¹¶æé†’å½“å¤©æœªå®Œæˆçš„ä¹ æƒ¯ä»»åŠ¡ã€‚</li>
                                <li><strong>[åŠŸèƒ½]</strong> æ–°å¢â€œå¾ªç¯æé†’â€ï¼šåœ¨ç¼–è¾‘ä¹ æƒ¯ä»»åŠ¡æ—¶ï¼Œè‹¥è®¾ç½®äº†â€œå…·ä½“æ—¶é—´â€æé†’ï¼Œå¯é¢å¤–å¼€å¯â€œå¾ªç¯æé†’â€å¼€å…³ã€‚å¼€å¯åï¼Œæé†’è§¦å‘æ—¶ä¼šè‡ªåŠ¨æŒ‰ä¹ æƒ¯å‘¨æœŸè®¡ç®—å¹¶è®¾ç½®ä¸‹ä¸€æ¬¡æé†’æ—¶é—´ã€‚</li>
                            </ul>
                        </div>
                         <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.14.1 (2025-10-23)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†â€œæ—¶é—´æ´å¯Ÿä»ªè¡¨ç›˜â€ç­›é€‰å™¨åœ¨æ‰‹æœºç«¯æ¢è¡Œåï¼Œå³ä¾§æŒ‰é’®ç»„ï¼ˆâ€œ7å¤©å†…â€ç­‰ï¼‰æ— æ³•æ­£ç¡®é å³å¯¹é½çš„CSSå¸ƒå±€é—®é¢˜ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†â€œè¡¥è®°â€åŠŸèƒ½ï¼šåœ¨è¡¥è®°â€œæŒç»­æ¶ˆè€—â€ç±»ä»»åŠ¡æ—¶ï¼Œä¼šæ­£ç¡®æ£€æµ‹è¡¥è®°å½“æ—¥çš„å†å²ä½™é¢ï¼Œå¹¶åœ¨ä½™é¢ä¸ºè´Ÿæ—¶åº”ç”¨ 1.1 å€æƒ©ç½šã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†â€œæ—¶é—´æµå›¾â€ç­›é€‰å™¨æŒ‰é’®é«˜äº®çŠ¶æ€ä¸å®é™…åŠ è½½æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> æ¢å¤äº†â€œäº’åŠ¨åˆ†æâ€å›¾è¡¨ï¼ˆé¥¼å›¾/æ’è¡Œï¼‰ä¸‹æ–¹çš„åˆ†é¡µå°åœ†ç‚¹æŒ‡ç¤ºå™¨ï¼Œå¹¶ç¡®ä¿å…¶å›ºå®šåœ¨å›¾è¡¨ä¸‹æ–¹ï¼Œä¸ä¼šéšå›¾è¡¨æ»‘åŠ¨ã€‚</li>
                            </ul>
                        </div>
                         <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.14.0 (2025-10-23)</strong></p>
                            <ul>
                                <li><strong>[åŠŸèƒ½]</strong> æ–°å¢â€œè®¾ç½®æé†’â€ç³»ç»Ÿï¼šå¯ä¸ºä»»åŠ¡è®¾ç½®ä¸€æ¬¡æ€§æé†’ï¼Œæ”¯æŒâ€œå…·ä½“æ—¶é—´â€å’Œâ€œå€’è®¡æ—¶â€ä¸¤ç§æ¨¡å¼ã€‚æé†’ä»…å‘é€é€šçŸ¥ï¼Œä¸è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡ã€‚</li>
                                <li><strong>[åŠŸèƒ½]</strong> æ–°å¢â€œå®Œæˆåè‡ªåŠ¨åˆ é™¤â€é€‰é¡¹ï¼šé€‚ç”¨äºä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œåœ¨å®Œæˆåä¼šè‡ªåŠ¨ä»åˆ—è¡¨ä¸­ç§»é™¤ã€‚æ­¤é€‰é¡¹ä¸â€œä¹ æƒ¯ä»»åŠ¡â€äº’æ–¥ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> ä¼˜åŒ–äº†ä¹ æƒ¯ä»»åŠ¡å¡ç‰‡çš„UIï¼šå½“å¤©å®Œæˆä¸€æ¬¡åï¼ŒçŠ¶æ€ä¼šä»â€œå·²è¿ç»­Xå¤©â€å˜ä¸ºâ€œä»Šæ—¥å·²å®Œæˆ âœ…â€ï¼Œæä¾›æ›´æ¸…æ™°çš„å³æ—¶åé¦ˆã€‚</li>
                            </ul>
                        </div>
                         <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.13.2 (2025-10-22)</strong></p>
                            <ul>
                                 <li><strong>[ä¿®å¤]</strong> å¼•å…¥äº†æ•°æ®å®‰å…¨å¤‡ä»½ä¸æ¢å¤æœºåˆ¶ï¼Œé˜²æ­¢å› æµè§ˆå™¨æ„å¤–å…³é—­ç­‰åŸå› å¯¼è‡´æ•°æ®æŸååæ— æ³•åŠ è½½çš„é—®é¢˜ã€‚ç°åœ¨åº”ç”¨ä¼šè‡ªåŠ¨ä»ä¸Šä¸€æ¬¡çš„æœ‰æ•ˆå¤‡ä»½ä¸­æ¢å¤ã€‚</li>
                                 <li><strong>[ä¿®å¤]</strong> ä¿®æ­£äº† PWA é€šçŸ¥åŠŸèƒ½çš„é€»è¾‘ï¼Œè§£å†³äº†ç‚¹å‡»â€œå‘é€æµ‹è¯•é€šçŸ¥â€æ—¶æ— ååº”çš„é—®é¢˜ï¼Œå¹¶èƒ½åœ¨å¤±è´¥æ—¶æä¾›æ˜ç¡®çš„é”™è¯¯æç¤ºã€‚</li>
                                 <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†è®¾ç½®é¡µé¢ä¸­ï¼Œå› ç‰ˆæœ¬å†å²çš„é•¿æ–‡æœ¬æœªæ¢è¡Œå¯¼è‡´çš„é¡µé¢æ°´å¹³æº¢å‡ºã€å¸ƒå±€åç§»å’Œåº•éƒ¨å¯¼èˆªæ ä¸ç¨³å®šçš„é—®é¢˜ã€‚</li>
                            </ul>
                        </div>
        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.13.1 (2025-10-22)</strong></p>
                            <ul>
                                 <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†åœ¨å·²æ³¨å†Œ Service Worker çš„ PWA ç¯å¢ƒä¸‹ï¼Œè°ƒç”¨ <code>new Notification()</code> æ„é€ å‡½æ•°ä¼šå¤±è´¥çš„é—®é¢˜ã€‚ç°åœ¨æ‰€æœ‰é€šçŸ¥éƒ½é€šè¿‡ <code>ServiceWorkerRegistration.showNotification()</code> æ­£ç¡®è§¦å‘ï¼Œè§£å†³äº†â€œå‘é€æµ‹è¯•é€šçŸ¥â€åŠŸèƒ½å¤±æ•ˆçš„ Bugã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.13.0 (2025-10-22)</strong></p>
                            <ul>
                                 <li><strong>[åŠŸèƒ½]</strong> è°ƒæ•´äº†æ¶ˆè´¹é€»è¾‘ï¼šå½“æ—¶é—´ä½™é¢ä¸ºè´Ÿæ—¶ï¼Œä»å¯è¿›è¡Œâ€œå³æ—¶å…‘æ¢â€å’Œâ€œæŒç»­æ¶ˆè€—â€ç±»ä»»åŠ¡ã€‚</li>
                                 <li><strong>[åŠŸèƒ½]</strong> æ–°å¢æƒ©ç½šæœºåˆ¶ï¼šå½“ä½™é¢ä¸ºè´Ÿæ—¶æ‰§è¡Œä¸Šè¿°æ¶ˆè´¹ä»»åŠ¡ï¼Œå…¶å®é™…æ¶ˆè€—æ—¶é—´å°†æŒ‰ 1.1 å€è®¡ç®—ã€‚</li>
                            </ul>
                        </div>
        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.12.6 (2025-10-20)</strong></p>
                            <ul>
                                 <li><strong>[ä¼˜åŒ–]</strong> ä¸ºæ‰€æœ‰ä»»åŠ¡å¡ç‰‡æ·»åŠ äº† <code>2px</code> çš„æµ…ç°è‰²å†…åµŒè¾¹æ¡† (<code>var(--border-color)</code>)ï¼Œä»¥è§£å†³â€œä¹ æƒ¯ä»»åŠ¡â€çš„å½©è‰²è¾¹æ¡†å¯¼è‡´çš„è§†è§‰å¤§å°ä¸ä¸€è‡´é—®é¢˜ã€‚</li>
                                 <li><strong>[ä¼˜åŒ–]</strong> å°†æ‰€æœ‰å¡ç‰‡è¾¹æ¡†ï¼ˆåŒ…æ‹¬ä¹ æƒ¯ä»»åŠ¡ï¼‰çš„å®½åº¦ä» <code>4px</code> ç»Ÿä¸€å‡å°‘åˆ° <code>2px</code>ï¼Œä½¿ç•Œé¢æ›´ç²¾è‡´ã€‚</li>
                            </ul>
                        </div>
                        
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.12.5 (2025-10-20)</strong></p>
                            <ul>
                                 <li><strong>[ä¼˜åŒ–]</strong> ä¼˜åŒ–äº†â€œä¹ æƒ¯ä»»åŠ¡â€å¡ç‰‡çš„è§†è§‰æ ·å¼ï¼Œå°†åŸæœ‰çš„å·¦ä¾§å½©è‰²ç«–çº¿æ”¹ä¸ºç¯ç»•æ•´ä¸ªå¡ç‰‡çš„å†…åµŒå½©è‰²è¾¹æ¡†ï¼ŒåŒæ—¶ç¡®ä¿ä¸å½±å“å¡ç‰‡å¸ƒå±€æˆ–äº¤äº’ï¼ˆé€šè¿‡ <code>box-shadow: inset</code> å’Œ <code>pointer-events: none</code> å®ç°ï¼‰ã€‚</li>
                            </ul>
                        </div>
                       <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.12.4 (2025-10-20)</strong></p>
                            <ul>
                                 <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº† v3.12.3 å¼•å…¥çš„ä¸€ä¸ªä¸¥é‡å¸ƒå±€é—®é¢˜ï¼šå¯¹ä»ªè¡¨ç›˜è¿‡æ»¤å™¨ï¼ˆâ€œ7å¤©å†…â€ç­‰æŒ‰é’®ï¼‰çš„å³å¯¹é½ä¿®æ”¹é”™è¯¯åœ°å½±å“äº†â€œè¯¦ç»†æ•°æ®â€å’Œâ€œè¶‹åŠ¿æ¼”å˜â€é€‰é¡¹å¡çš„è¿‡æ»¤å™¨å¸ƒå±€ã€‚ç°å·²é€šè¿‡é«˜ç‰¹å¼‚æ€§ CSS è§„åˆ™ä¿®å¤æ­¤é—®é¢˜ï¼Œç¡®ä¿ä¿®æ”¹åªåº”ç”¨åœ¨â€œæ—¶é—´æ´å¯Ÿä»ªè¡¨ç›˜â€ã€‚</li>
                                 <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†æ ¸å¿ƒ <code>formatTime()</code> å‡½æ•°çš„é€»è¾‘ï¼Œä½¿å…¶åœ¨å°æ—¶ä¸º0ã€åˆ†é’Ÿå’Œç§’æ•°å‡å¤§äº0æ—¶ï¼ˆå¦‚ "15åˆ†30ç§’"ï¼‰ï¼Œèƒ½æ­£ç¡®æ˜¾ç¤ºç§’æ•°ã€‚æ­¤ä¿®å¤å½±å“â€œæ—¶é—´ä½™é¢å¡ç‰‡â€å’Œâ€œä»»åŠ¡è®¡æ—¶å™¨â€ã€‚</li>
                                 <li><strong>[ä¼˜åŒ–]</strong> è°ƒæ•´äº†â€œæ—¶é—´æµå›¾â€ä¸­æ¡å½¢å›¾çš„é—´è·ï¼Œå°†åº•éƒ¨ç©ºç™½å‡å°‘äº†50% (16px -> 8px)ï¼Œå¹¶å°†æ¡é—´è·å‡å°‘äº† 33% (24px -> 16px)ã€‚</li>
                                 <li><strong>[ä¼˜åŒ–]</strong> è°ƒæ•´äº†â€œæ—¶é—´æ´å¯Ÿä»ªè¡¨ç›˜â€é¡¶éƒ¨çš„è¿‡æ»¤å™¨å¸ƒå±€ï¼Œä½¿â€œ7å¤©å†…/30å¤©å†…/å…¨éƒ¨â€æ—¶æ®µæŒ‰é’®ç»„**çœŸæ­£**é å³å¯¹é½ã€‚</li>
                                 <li><strong>[ä¼˜åŒ–]</strong> å°†â€œè®¾ç½®â€é¡µé¢ä¸­å„éƒ¨åˆ†æ ‡é¢˜ï¼ˆå¦‚â€œå¤–è§‚è®¾ç½®â€ï¼‰ä¸å…¶ä¸‹æ–¹ç¬¬ä¸€é¡¹å†…å®¹ä¹‹é—´çš„é—´è·ç¼©çŸ­äº†50% (24px -> 12px)ã€‚</li>
                                 <li><strong>[ä¼˜åŒ–]</strong> å°†â€œè¯¦ç»†æ•°æ®â€è¡¨æ ¼ä¸­çš„æ ‡é¢˜ "è·å¾—/æ¶ˆè´¹" ä¿®æ”¹ä¸º "æ€»æ—¶é—´"ï¼Œ"å¹³å‡æ—¶é—´" ä¿®æ”¹ä¸º "å¹³å‡"ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.12.2 (2025-10-19)</strong></p>
                            <ul>
                                 <li><strong>[ä¼˜åŒ–]</strong> è¿›ä¸€æ­¥å‡å°‘äº†â€œäº’åŠ¨åˆ†æâ€å›¾è¡¨ä¸‹æ–¹çš„ç©ºç™½åŒºåŸŸï¼Œä½¿å¸ƒå±€æ›´ç´§å‡‘ã€‚</li>
                                 <li><strong>[ä¼˜åŒ–]</strong> å°†â€œè¯¦ç»†æ•°æ®â€è¡¨æ ¼ä¸­â€œå¹³å‡æ—¶é—´â€åˆ—çš„æ ¼å¼ä¿®æ”¹ä¸º "xx.xå°æ—¶"ã€‚</li>
                                 <li><strong>[ä¼˜åŒ–]</strong> å†æ¬¡ç¼©çŸ­äº†â€œæ—¶é—´æµå›¾â€ä¸­ä¸¤ä¸ªæ¡å½¢å›¾ä¹‹é—´çš„å‚ç›´é—´è·ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.12.1 (2025-10-19)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ä¼˜åŒ–äº†â€œäº’åŠ¨åˆ†æâ€ä¸­æ’è¡Œæ¦œè§†å›¾çš„é«˜åº¦ï¼Œå‡å°‘äº†å†…å®¹è¾ƒå°‘æ—¶çš„åº•éƒ¨ç©ºç™½ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ç§»é™¤äº†â€œäº’åŠ¨åˆ†æâ€ä¸­é¥¼å›¾/æ’è¡Œæ¦œä¸‹æ–¹çš„åˆ†é¡µåœ†ç‚¹æŒ‡ç¤ºå™¨ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> å°†â€œè¯¦ç»†æ•°æ®â€è¡¨æ ¼ä¸­â€œè·å¾—/æ¶ˆè´¹â€åˆ—çš„æ—¶é—´æ ¼å¼æ”¹ä¸ºä»¥å°æ—¶ä¸ºå•ä½ï¼ˆä¾‹å¦‚ "+1.5å°æ—¶"ï¼‰ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†â€œè¯¦ç»†æ•°æ®â€è¡¨æ ¼å³ä¾§è¾¹æ¡†å¯èƒ½æº¢å‡ºçš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> å°†â€œæ—¶é—´æµåŠ¨æ¦‚è§ˆâ€å¡ç‰‡æ ‡é¢˜æ”¹å›â€œæ—¶é—´æµå›¾â€ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> å‡å°äº†â€œæ—¶é—´æµå›¾â€ä¸­è·å¾—/æ¶ˆè´¹ä¸¤ä¸ªæ¡å½¢å›¾ä¹‹é—´çš„é—´è·ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.12.0 (2025-10-19)</strong></p>
                            <ul>
                                <li><strong>[åŠŸèƒ½]</strong> æ¢å¤å¹¶ä¼˜åŒ–äº†â€œæŠ¥å‘Šâ€é€‰é¡¹å¡ä¸­çš„â€œæ—¶é—´æµåŠ¨æ¦‚è§ˆâ€å›¾è¡¨ï¼Œç°åœ¨è‰²å—æŒ‰æ´»åŠ¨å—ï¼ˆåŒåˆ†ç±»è¿ç»­æ—¶æ®µï¼‰çš„æ—¶é—´é¡ºåºæ’åˆ—ï¼Œä»¥ä½“ç°æ—¶é—´æµåŠ¨æ€§ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†â€œäº’åŠ¨åˆ†æâ€ä¸­åˆ‡æ¢å›¾è¡¨/æ’è¡Œè§†å›¾æ—¶ï¼Œé¡¶éƒ¨çš„åˆ†é¡µåœ†ç‚¹çŸ­æš‚è·³åŠ¨çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ç§»é™¤]</strong> ç§»é™¤äº†â€œæŠ¥å‘Šâ€é€‰é¡¹å¡é¡¶éƒ¨çš„â€œæ€»è·å¾—/æ€»æ¶ˆè´¹æ—¶é—´â€ç»Ÿè®¡å¡ç‰‡ã€‚</li>
                            </ul>
                        </div>
                         <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.11.3 (2025-10-19)</strong></p>
                            <ul>
                                <li><strong>[ç§»é™¤]</strong> ç§»é™¤äº†â€œæŠ¥å‘Šâ€é€‰é¡¹å¡ä¸­çš„â€œæ—¶é—´æµå›¾â€å¡ç‰‡ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ä¼˜åŒ–äº†â€œäº’åŠ¨åˆ†æâ€æ¨¡å—çš„é«˜åº¦é€»è¾‘ï¼Œä¿®å¤äº†åœ¨â€œåˆ†ç±»è§†å›¾â€ä¸‹æŸ¥çœ‹é¥¼å›¾æ—¶åº•éƒ¨å­˜åœ¨è¿‡å¤šç©ºç™½çš„é—®é¢˜ï¼ŒåŒæ—¶ä¿ç•™äº†åˆ‡æ¢è§†å›¾æ—¶çš„é˜²æŠ–åŠ¨æ•ˆæœã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.11.2 (2025-10-19)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†â€œæ—¶é—´æ´å¯Ÿä»ªè¡¨ç›˜â€ä¸­ï¼Œåˆ‡æ¢â€œå›¾è¡¨â€å’Œâ€œæ’è¡Œâ€è§†å›¾æ—¶ï¼Œå› å®¹å™¨é«˜åº¦æŠ˜å å¯¼è‡´çš„é¡µé¢å¸ƒå±€è·³åŠ¨é—®é¢˜ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ä¼˜åŒ–äº†æŠ¥å‘Šä¸­å¯æ»‘åŠ¨å›¾è¡¨ (é¥¼å›¾/æ’è¡Œ/è¶‹åŠ¿) çš„è§¦æ‘¸é€»è¾‘ï¼Œè§£å†³äº†åœ¨ç§»åŠ¨ç«¯ä¸Šä¸‹æ»šåŠ¨é¡µé¢æ—¶ï¼Œå®¹æ˜“è¯¯è§¦å¯¼è‡´å›¾è¡¨å·¦å³åˆ‡æ¢çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> é‡æ„äº†â€œå…³äºâ€é¡µé¢çš„ç‰ˆæœ¬å†å²ç»“æ„ï¼Œå°†æœ€æ–°ç‰ˆæœ¬ç½®é¡¶æ˜¾ç¤ºï¼Œå¹¶å°†æ‰€æœ‰æ—§ç‰ˆæœ¬ç§»å…¥å¯æŠ˜å çš„â€œå†å²ç‰ˆæœ¬æ›´æ–°â€åŒºåŸŸï¼Œä»¥ä¿æŒç•Œé¢æ•´æ´ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.11.1 (2025-10-19)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†â€œäº’åŠ¨åˆ†æâ€ä¸­â€œä»»åŠ¡è§†å›¾â€ä¸‹çš„é¥¼å›¾å¯èƒ½æ˜¾ç¤ºè¶…è¿‡5ä¸ªä»»åŠ¡çš„é—®é¢˜ï¼Œç°åœ¨ä¸¥æ ¼æŒ‰ç…§Top 5 + å…¶ä»–è¿›è¡Œåˆ†ç»„ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> ç¡®ä¿â€œæ•°æ®ç®¡ç†â€ä¸­çš„å¯¼å‡º/å¯¼å…¥/æ¸…ç©ºæŒ‰é’®å§‹ç»ˆåœ¨åŒä¸€è¡Œæ˜¾ç¤ºï¼Œé˜²æ­¢åœ¨å°å±å¹•ä¸Šæ¢è¡Œã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> ç®€åŒ–äº†â€œé€šçŸ¥è¯Šæ–­â€è®¾ç½®é¡¹çš„ç•Œé¢ï¼Œç§»é™¤äº†æè¿°å’Œæç¤ºæ–‡å­—ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.11.0 (2025-10-19)</strong></p>
                            <ul>
                                <li><strong>[åŠŸèƒ½]</strong> æ–°å¢â€œè¡¥è®°â€åŠŸèƒ½ï¼šå¯åœ¨æŒç»­ç±»ä»»åŠ¡çš„â€œæ›´å¤šâ€èœå•ä¸­ï¼Œä¸ºè¿‡å»æ—¥æœŸè¡¥å½•è®°å½•ï¼ˆæ”¯æŒæŒ‰èµ·æ­¢æ—¶é—´æˆ–æŒ‰æ—¶é•¿ï¼‰ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†åœ¨åˆ†ç±»ä»»åŠ¡åˆ—è¡¨ä¸­å¯åŠ¨ä»»åŠ¡åï¼Œè¯¥ä»»åŠ¡å¡ç‰‡çš„è®¡æ—¶å™¨ä¸æ›´æ–°ã€èœå•æ— æ³•æ‰“å¼€çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> è°ƒæ•´äº†é¥¼å›¾åœ¨â€œåˆ†ç±»è§†å›¾â€ä¸‹çš„æ ‡ç­¾æ ¼å¼ï¼Œæ”¹ä¸ºä¸‰è¡Œæ˜¾ç¤ºï¼ˆåˆ†ç±»å/ç™¾åˆ†æ¯”/æ—¶é•¿ï¼‰ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> ä¼˜åŒ–äº†ä¹ æƒ¯ä»»åŠ¡å¡ç‰‡çš„å·¦ä¾§å½©è‰²è¾¹æ¡†å®ç°æ–¹å¼ï¼Œé¿å…å¡ç‰‡å†…å®¹å‘å³åç§»ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.10.5 (2025-10-18)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†ä¸€ä¸ª v3.10.4 å¼•å…¥çš„ä¸¥é‡Bugï¼šç”±äºå‡½æ•°åæ‹¼å†™é”™è¯¯ (<code>getItemNameAndVategory</code>)ï¼Œå¯¼è‡´â€œæ—¶é—´æ´å¯Ÿä»ªè¡¨ç›˜â€ã€â€œè¯¦ç»†æ•°æ®â€å’Œâ€œè¶‹åŠ¿æ¼”å˜â€æ¨¡å—çš„æ•°æ®æ— æ³•åŠ è½½ï¼Œå›¾è¡¨æ¶ˆå¤±ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.10.4 (2025-10-18)</strong></p>
                            <ul>
                                <li><strong>[åŠŸèƒ½]</strong> åˆ†ç±»è§†å›¾ä¸‹çš„æ‰‡å½¢å›¾æ ‡ç­¾ç°åœ¨ä¼šåŒæ—¶æ˜¾ç¤ºç™¾åˆ†æ¯”ã€æ—¶é•¿å’Œåˆ†ç±»åã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> æ‰‡å½¢å›¾æ—¶é•¿æ ¼å¼ä¼˜åŒ–ï¼š1å°æ—¶å†…ä»…æ˜¾ç¤ºåˆ†é’Ÿæ•°ï¼ˆä¾‹å¦‚ 45åˆ†ï¼‰ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> è°ƒäº®äº†å›¾è¡¨ï¼ˆæ‰‡å½¢å›¾ã€æ’è¡Œæ¦œï¼‰ä¸­â€œå…¶ä»–â€ç±»åˆ«çš„ç°è‰²ï¼Œä½¿å…¶æ›´æŸ”å’Œã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.10.3 (2025-10-18)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> å½»åº•ä¿®å¤äº†æ’è¡Œæ¦œçŸ­è¿›åº¦æ¡ä¸‹æ—¶é—´æ ‡ç­¾æ¢è¡Œçš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> ä¼˜åŒ–äº†â€œåˆ†ç±»è§†å›¾â€ä¸‹æ’è¡Œæ¦œçš„å¸ƒå±€ï¼Œä½¿å…¶åœ¨çŸ­æ ‡ç­¾ä¸‹æ›´ç¾è§‚ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> ä¼˜åŒ–äº†æ‰‡å½¢å›¾æ ‡ç­¾çš„å®šä½ï¼Œä½¿å…¶ä½äºæ‰‡å½¢åŒºåŸŸçš„è§†è§‰ä¸­å¿ƒã€‚</li>
                                <li><strong>[åŠŸèƒ½]</strong> â€œä»»åŠ¡è§†å›¾â€ä¸‹çš„æ‰‡å½¢å›¾æ ‡ç­¾ç°åœ¨ä¼šåŒæ—¶æ˜¾ç¤ºç™¾åˆ†æ¯”å’Œæ—¶é—´é•¿åº¦ã€‚</li>
                                <li><strong>[åŠŸèƒ½]</strong> â€œåˆ†ç±»è§†å›¾â€ä¸‹çš„æ‰‡å½¢å›¾ä¼šç›´æ¥æ˜¾ç¤ºåˆ†ç±»åï¼Œä¸å†ä½¿ç”¨å›¾ä¾‹ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.10.2 (2025-10-18)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ç§»é™¤äº†é¥¼å›¾çš„å¤–éƒ¨å¼•å¯¼çº¿å’Œæ ‡ç­¾ï¼Œæ”¹ä¸ºä½¿ç”¨å›¾ä¾‹ï¼Œä»¥è§£å†³åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ˜¾ç¤ºé—®é¢˜ã€‚</li>
                                <li><strong>[åŠŸèƒ½]</strong> é¥¼å›¾æ‰‡å½¢å†…éƒ¨æ–°å¢ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼Œæå‡æ•°æ®å¯è¯»æ€§ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> ç»Ÿä¸€äº†æ’è¡Œæ¦œä¸­æ—¶é—´æ•°å€¼çš„å­—ä½“æ ·å¼ï¼ˆç™½è‰²å¸¦é˜´å¥½ï¼‰ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> è°ƒæ•´äº†çŸ­è¿›åº¦æ¡çš„æ’è¡Œæ¦œæ ‡ç­¾ï¼Œä½¿å…¶å§‹ç»ˆæ˜¾ç¤ºåœ¨è¿›åº¦æ¡å†…éƒ¨å·¦ä¾§ã€‚</li>
<li><strong>[ä¼˜åŒ–]</strong> é’ˆå¯¹â€œåˆ†ç±»è§†å›¾â€ä¸‹çš„æ’è¡Œæ¦œï¼Œè°ƒæ•´äº†å¸ƒå±€ä»¥å‡å°‘å·¦ä¾§ç©ºç™½ï¼Œæ­¤ä¼˜åŒ–ä¸å½±å“â€œä»»åŠ¡è§†å›¾â€ã€‚</li>
                            </ul>
                        </div>
                         <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.10.1 (2025-10-18)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> é¥¼å›¾å¼•å¯¼çº¿ä»ç›´çº¿æ”¹ä¸ºæŠ˜çº¿ï¼ˆSVGå®ç°ï¼‰ï¼Œè§£å†³äº†æ ‡ç­¾é‡å å’ŒæŒ‡å‘ä¸å‡†çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> å°†æŠ¥å‘Šä¸­â€œä»»åŠ¡è§†å›¾â€ä¸‹çš„â€œè·å¾—â€é¢œè‰²ä½“ç³»ä»è“ç»¿è‰²ç³»è°ƒæ•´ä¸ºæ›´ç»Ÿä¸€çš„ç»¿è‰²æ¸å˜ç³»ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ vs3.10.0 (2025-10-18)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> å½»åº•é‡æ„äº†é¥¼å›¾æ ‡ç­¾çš„å®ç°æ–¹å¼ï¼Œä» Canvas ç»˜å›¾æ”¹ä¸ºä½¿ç”¨ HTML å…ƒç´ ï¼Œè§£å†³äº†æ ‡ç­¾æ˜¾ç¤ºä¸å…¨ã€æ¨¡ç³Šã€é‡å çš„é—®é¢˜ã€‚</li>
                                <li><strong>[åŠŸèƒ½]</strong> æ–°å¢ä»»åŠ¡è§†å›¾ä¸‹çš„é¢œè‰²æ ‡å‡†åŒ–ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> ä¼˜åŒ–äº†é¥¼å›¾æ ‡ç­¾çš„æ’å¸ƒé€»è¾‘ï¼Œä»¥é¿å…ç›¸äº’é®æŒ¡ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                             <p><strong>ç‰ˆæœ¬ v3.9.6 (2025-10-18)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†æ¶ˆè´¹é¥¼å›¾é”™è¯¯åœ°å°†æŸäº›åˆ†ç±»å½’å…¥â€œå…¶ä»–â€çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> é¥¼å›¾æ”¹ä¸ºä½¿ç”¨å¼•å‡ºçº¿æ ‡æ³¨ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> è°ƒæ•´äº†æ’è¡Œæ¦œçš„å¸ƒå±€ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> è¯¦ç»†æ•°æ®è¡¨æ–°å¢â€œå±•å¼€/æŠ˜å â€åŠŸèƒ½ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.9.5 (2025-10-18)</strong></p>
                            <ul>
                                <li><strong>[åŠŸèƒ½]</strong> æ–°å¢äº’åŠ¨åˆ†ææ¨¡å—ï¼Œæ”¯æŒåœ¨â€œå›¾è¡¨è§†å›¾â€å’Œâ€œæ’è¡Œè§†å›¾â€ä¹‹é—´åˆ‡æ¢ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.9.0 (2025-10-18)</strong></p>
                            <ul>
                                <li><strong>[åŠŸèƒ½]</strong> è¶‹åŠ¿å›¾é‡æ„ä¸ºå·¦å³æ»‘åŠ¨åˆ‡æ¢ã€‚</li>
                                <li><strong>[åŠŸèƒ½]</strong> æ–°å¢é€šçŸ¥è¯Šæ–­åŠŸèƒ½ã€‚</li>
                            </ul>
                        </div>
                       <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.8.2 (2025-10-17)</strong></p>
                             <ul>
                                 <li><strong>[ä¿®å¤]</strong> ä¿®æ­£ <code>formatTime</code> å‡½æ•°é€»è¾‘ã€‚</li>
                             </ul>
                         </div>

                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.6.3 (2025-10-16)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> é‡æ„äº†æ´»åŠ¨æ—¥å†çš„é¢œè‰²è®¡ç®—é€»è¾‘ï¼Œå¹¶é‡‡ç”¨æ›´å¯é çš„æ—¥æœŸæ ¼å¼åŒ–æ–¹æ³•ï¼Œå½»åº•è§£å†³äº†æ—¥å†æ–¹å—é¢œè‰²ä¸æ˜¾ç¤ºçš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ç»Ÿä¸€äº†åº”ç”¨å†…æ‰€æœ‰åŠŸèƒ½çš„æ—¥æœŸå¤„ç†æ–¹å¼ï¼Œç¡®ä¿æ•°æ®åœ¨ä»»ä½•æ—¶åŒºä¸‹éƒ½èƒ½å‡†ç¡®åœ°å½’å±åˆ°æ­£ç¡®çš„æœ¬åœ°æ—¥æœŸã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.6.2 (2025-10-16)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ä¿®å¤äº†æ´»åŠ¨æ—¥å†å› æ—¶åŒºå¤„ç†ä¸å½“å¯¼è‡´çš„æ•°æ®å½’å±é”™è¯¯ï¼Œç¡®ä¿äº†äº¤æ˜“è®°å½•æ˜¾ç¤ºåœ¨æ­£ç¡®çš„æœ¬åœ°æ—¥æœŸä¸‹ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> çº æ­£äº†æ¯æ—¥è¯¦æƒ…å¼¹çª—çš„æ•°æ®ç­›é€‰é€»è¾‘ï¼Œä½¿å…¶ä¸æ—¥å†çš„æœ¬åœ°æ—¥æœŸä¿æŒä¸€è‡´ï¼Œè§£å†³äº†æ•°æ®æ˜¾ç¤ºæ··æ·†çš„é—®é¢˜ã€‚</li>
                                <li><strong>[UI]</strong> ä¼˜åŒ–äº†â€œå…³äºâ€é¡µé¢ä¸­ç‰ˆæœ¬å†å²çš„ç»“æ„ï¼Œä»¥æ”¯æŒé•¿æœŸè®°å½•æ‰€æœ‰æ›´æ–°ä¿¡æ¯ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.6.1 (2025-10-16)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤]</strong> ä¸ºæŠ¥å‘Šé¡µé¢çš„å¡ç‰‡å¢åŠ äº†é¡¶éƒ¨å¤–è¾¹è·ï¼Œè§£å†³äº†ä¸ä¸Šæ–¹å…ƒç´ è¿‡äºè´´è¿‘çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¿®å¤]</strong> ä¿®æ­£äº†â€œæ·±åº¦åˆ†æâ€è¡¨æ ¼ä¸­ï¼Œä»»åŠ¡å¹³å‡æ—¶é—´å› ä¸å½“å–æ•´è€Œæ˜¾ç¤ºä¸º0çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> é‡æ„äº†æ—¶é—´æ ¼å¼åŒ–å‡½æ•°ï¼Œä½¿å…¶åœ¨å„ç§æƒ…å†µä¸‹éƒ½èƒ½æ›´å‡†ç¡®ã€ç¨³å®šåœ°æ˜¾ç¤ºæ—¶é—´ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.6.0 (2025-10-16)</strong></p>
                            <ul>
                                <li><strong>[UI] ç•Œé¢é£æ ¼è°ƒæ•´:</strong> æ•´ä½“UIé£æ ¼å‚ç…§æ—©æœŸç»å…¸ç‰ˆæœ¬è¿›è¡Œç„•æ–°ï¼Œæ¢å¤è“ç´«è‰²æ¸å˜èƒŒæ™¯å’Œç»å…¸è‰²è°ƒã€‚</li>
                                <li><strong>[UI] å¸ƒå±€ä¼˜åŒ–:</strong> è°ƒæ•´äº†ä»»åŠ¡å¡ç‰‡åŒºåŸŸçš„è¾¹è·ï¼Œä½¿å…¶ä¸ä½™é¢å¡ç‰‡å¯¹é½ï¼›å¹¶ç¡®ä¿ä»»åŠ¡å¡ç‰‡åœ¨æ‰‹æœºä¸Šå§‹ç»ˆä¸ºåŒåˆ—æ˜¾ç¤ºã€‚</li>
                                <li><strong>[UI] æŠ¥å‘Šé¡µç²¾ç®€:</strong> ç§»é™¤æ€»ä»»åŠ¡æ•°å’Œå®Œæˆæ¬¡æ•°ç»Ÿè®¡ï¼Œä½¿æ ¸å¿ƒæŒ‡æ ‡ï¼ˆæ€»è·å¾—/æ¶ˆè€—æ—¶é—´ï¼‰æ›´çªå‡ºï¼Œå¹¶è°ƒæ•´ä¸ºå•è¡Œæ˜¾ç¤ºã€‚</li>
                                <li><strong>[ä¼˜åŒ–] æ—¶é—´æ ¼å¼:</strong> ä¼˜åŒ–äº†ä½™é¢å’ŒæŠ¥å‘Šé¡µçš„æ—¶é—´æ˜¾ç¤ºï¼Œå½“è¶…è¿‡1å°æ—¶åï¼Œå°†è‡ªåŠ¨éšè—ç§’æ•°ï¼Œä½¿é˜…è¯»æ›´æ¸…æ™°ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.5.1 (2025-10-16)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤] ä»£ç åº“ç¨³å®šï¼š</strong>ç§»é™¤äº†æ‰€æœ‰é‡å¤çš„JavaScriptä»£ç ï¼Œè§£å†³äº†UIæ¸²æŸ“å¤±è´¥å’Œæ‰§è¡Œé”™è¯¯çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¿®å¤] æ•°æ®å…¼å®¹æ€§ï¼š</strong>ä¿®æ­£åçš„ä»£ç ç°åœ¨å¯ä»¥æ­£ç¡®åŠ è½½å¹¶è¿ç§»æ‰€æœ‰å…ˆå‰ç‰ˆæœ¬çš„æ•°æ®ã€‚</li>
                                <li><strong>[ä¿ç•™] åŠŸèƒ½å®Œæ•´ï¼š</strong>v3.5.0ç‰ˆæœ¬çš„æ‰€æœ‰åŠŸèƒ½ï¼ˆäº¤äº’å¼æ—¥å†ã€é¢œè‰²æ¢¯åº¦ã€å®Œæ•´ç‰ˆæœ¬å†å²ï¼‰ç°åœ¨å‡å¯æ­£å¸¸å·¥ä½œã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.5.0 (2025-10-16)</strong></p>
                            <ul>
                                <li><strong>[æ–°åŠŸèƒ½] äº¤äº’å¼æ´»åŠ¨æ—¥å†ï¼š</strong>ç‚¹å‡»æ—¥å†ä¸Šçš„ä»»æ„æ—¥æœŸï¼Œå¯ä»¥å¼¹çª—æŸ¥çœ‹å½“æ—¥æ‰€æœ‰çš„æ—¶é—´æ”¶æ”¯è¯¦æƒ…ã€‚</li>
                                <li><strong>[UI] æ—¥å†è§†è§‰é‡æ„ï¼š</strong>æ´»åŠ¨æ—¥å†çš„é¢œè‰²ä¸å†æ˜¯ç®€å•çš„æŒ‡ç¤ºæ¡ï¼Œè€Œæ˜¯æ•´ä¸ªè‰²å—ã€‚æ ¹æ®å½“æ—¥å‡€æ”¶æ”¯ï¼Œåˆ†ä¸º6ä¸ªç­‰çº§çš„çº¢/ç»¿è‰²é˜¶ï¼Œè§†è§‰å†²å‡»åŠ›æ›´å¼ºã€‚</li>
                                <li><strong>[ä¿®å¤] æ¢å¤å®Œæ•´ç‰ˆæœ¬å†å²ï¼š</strong>æ ¹æ®æ‚¨çš„è¦æ±‚ï¼Œå·²åœ¨â€œå…³äºâ€é¡µé¢ä¸­æ¢å¤å¹¶æ•´ç†äº†æ‰€æœ‰å†å²ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.4.2 (2025-10-16)</strong></p>
                            <ul>
                                <li><strong>[æ–°åŠŸèƒ½] è‡ªç”±é¢œè‰²é€‰æ‹©ï¼š</strong>åˆ›å»ºæˆ–ç¼–è¾‘ä»»åŠ¡æ—¶ï¼Œå¯ä»16ç§é¢„è®¾é¢œè‰²ä¸­ä¸ºåˆ†ç±»è‡ªç”±æŒ‡å®šé¢œè‰²ã€‚</li>
                                <li><strong>[ä¼˜åŒ–] éšæœºé¢œè‰²åˆ†é…ï¼š</strong>è‹¥ä¸æŒ‡å®šé¢œè‰²ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä»å¯ç”¨é¢œè‰²ä¸­éšæœºé€‰æ‹©ã€‚</li>
                                <li><strong>[UI] æ ‡ç­¾é¢œè‰²è°ƒä¼˜ï¼š</strong>å¼•å…¥ä¸¤å¥—å…¨æ–°çš„ã€æ›´å…·é«˜çº§æ„Ÿå’ŒåŒºåˆ†åº¦çš„è‰²æ¿ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.4.1 (2025-10-16)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤] å†å²æ ‡ç­¾é¢œè‰²ï¼š</strong>è‡ªåŠ¨ä¿®æ­£å†å²ä»»åŠ¡çš„æ ‡ç­¾é¢œè‰²ã€‚</li>
                                <li><strong>[ä¼˜åŒ–] æ ‡ç­¾é¢œè‰²å¤šæ ·æ€§ï¼š</strong>åŒä¸€ç±»å‹ä¸‹çš„ä¸åŒåˆ†ç±»æ ‡ç­¾é¢œè‰²ä¸åŒã€‚</li>
                                <li><strong>[æ–°åŠŸèƒ½] æ™ºèƒ½æ ‡ç­¾æ¨èï¼š</strong>æ ¹æ®ä»»åŠ¡ç±»å‹æ¨èå¸¸ç”¨æ ‡ç­¾ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.4.0 (2025-10-15)</strong></p>
                            <ul>
                                <li><strong>[UI] è‰²å½©ç³»ç»Ÿé‡æ„ï¼š</strong>å…¨é¢æ›´æ–°åº”ç”¨è‰²å½©æ–¹æ¡ˆï¼Œæå‡è§†è§‰ä¸“ä¸šæ€§å’Œä¿¡æ¯åŒºåˆ†åº¦ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.3.2 (2025-10-15)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤] æŠ¥å‘Šé¡µï¼š</strong>å½»åº•ä¿®å¤äº†æ´»åŠ¨æ—¥å†å¸ƒå±€æ··ä¹±çš„é—®é¢˜ï¼Œç°åœ¨å¯ä»¥æŒ‰æœˆæ­£ç¡®æ˜¾ç¤ºã€‚</li>
                                <li><strong>[ä¿®å¤] ä¹ æƒ¯ç³»ç»Ÿï¼š</strong>ä¿®å¤äº†é¦–æ¬¡å®Œæˆä¹ æƒ¯æ—¶è®¡æ•°ä¸ä»1å¼€å§‹çš„é—®é¢˜ã€‚</li>
                                <li><strong>[ä¿®å¤] æœ€è¿‘ä»»åŠ¡ï¼š</strong>ç¡®ä¿æ‰€æœ‰ç±»å‹çš„ä»»åŠ¡å®Œæˆåéƒ½èƒ½ç«‹å³å‡ºç°åœ¨â€œæœ€è¿‘ä»»åŠ¡â€åˆ—è¡¨ä¸­ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.3.1 (2025-10-15)</strong></p>
                            <ul>
                                <li><strong>[ä¿®å¤] ä¹ æƒ¯ç³»ç»Ÿå¢å¼ºï¼š</strong>ä¿®å¤äº†ä¹ æƒ¯ä»»åŠ¡å®Œæˆ/æ’¤å›æ—¶è¿ç»­å¤©æ•°çŠ¶æ€æ›´æ–°ä¸æ­£ç¡®ã€ä¸åŠæ—¶ã€å¯è¢«åˆ©ç”¨çš„å¤šä¸ªbugã€‚</li>
                                <li><strong>[æ–°åŠŸèƒ½] ä¹ æƒ¯æ¯æ—¥ä¸Šé™ï¼š</strong>ç°åœ¨å¯ä»¥ä¸ºæ¯ä¸ªä¹ æƒ¯ä»»åŠ¡è®¾ç½®æ¯æ—¥å®Œæˆæ¬¡æ•°ä¸Šé™ï¼Œé»˜è®¤ä¸º1æ¬¡ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.2.1 (2025-10-15)</strong></p>
                            <ul>
                                <li><strong>[ä¼˜åŒ–]</strong> ä¸ºæ´»åŠ¨æ—¥å†çƒ­å›¾å¢åŠ é¢œè‰²å›¾ä¾‹ï¼Œä½¿å…¶æ›´æ˜“ç†è§£ã€‚</li>
                                <li><strong>[ä¼˜åŒ–]</strong> æ·±åº¦åˆ†æè¡¨æ ¼â€œæŒ‰åˆ†ç±»â€è§†å›¾åˆå¹¶æ”¶æ”¯ä¸ºâ€œå‡€å€¼â€ï¼Œå¹¶ç”¨é¢œè‰²åŒºåˆ†ã€‚</li>
                                <li><strong>[æ–°åŠŸèƒ½]</strong> æ·±åº¦åˆ†æè¡¨æ ¼å¢åŠ â€œå æ¯”â€åˆ—ï¼Œæ˜¾ç¤ºå„é¡¹ç›®å¯¹æ€»æ”¶æ”¯çš„è´¡çŒ®åº¦ã€‚</li>
                            </ul>
                        </div>

                         <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v3.0</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> (é‡å¤§åŠŸèƒ½) æ–°å¢â€œä¹ æƒ¯ä»»åŠ¡â€(Habit) ç±»å‹ï¼Œæ”¯æŒè¿ç»­æ‰“å¡ã€‚</li>
                                <li><strong>[Feat]</strong> ä¹ æƒ¯ä»»åŠ¡æ”¯æŒè®¾ç½®å‘¨æœŸ (æ—¥/å‘¨/æœˆ)ã€æ—¶é•¿åŠå¤šç§å¥–åŠ±è§„åˆ™ï¼ˆå¦‚å›ºå®šå¥–åŠ±ã€é€’å¢å¥–åŠ±ï¼‰ã€‚</li>
                                <li><strong>[Feat]</strong> ä¹ æƒ¯ä»»åŠ¡å¡ç‰‡ç°åœ¨å¯ä»¥æ˜¾ç¤ºè¿ç»­æ‰“å¡ (Streak) çŠ¶æ€å’Œå¾½ç« ã€‚</li>
                                <li><strong>[Feat]</strong> é‡æ„è®¾ç½® (Settings) é¡µé¢UIï¼Œæ”¹ä¸ºæ›´ç°ä»£çš„åˆ—è¡¨æ ·å¼ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v2.9</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> åœ¨ä»»åŠ¡å†å²è®°å½•ä¸­å¢åŠ â€œæ’¤å›â€(Undo)åŠŸèƒ½ï¼Œå¯ä»¥æ’¤é”€å•æ¡æ“ä½œã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢â€œè·Ÿéšç³»ç»Ÿâ€ä¸»é¢˜é€‰é¡¹ (Auto Dark Mode)ã€‚</li>
                                <li><strong>[Feat]</strong> åœ¨è®¾ç½®é¡µé¢æ·»åŠ ç‰ˆæœ¬æ›´æ–°æ—¥å¿—åŠŸèƒ½ (<code>&lt;details&gt;</code> æ ‡ç­¾)ã€‚</li>
                                <li><strong>[Fix]</strong> ä¼˜åŒ–äº†è¿è¡Œä¸­ä»»åŠ¡çš„æ“ä½œæŒ‰é’®å¸ƒå±€ (Pause/Cancel/Stop)ï¼Œä½¿å…¶æ›´ç´§å‡‘ã€‚</li>
                                <li><strong>[Fix]</strong> å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ä¸å†éœ€è¦äºŒæ¬¡ç¡®è®¤ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v2.8</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> (é‡å¤§åŠŸèƒ½) å®ç°äº†è®¡æ—¶å™¨æŒä¹…åŒ–ã€‚ç°åœ¨åˆ·æ–°é¡µé¢åï¼Œæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡è®¡æ—¶å™¨å¯ä»¥è¢«æ¢å¤ã€‚</li>
                                <li><strong>[Feat]</strong> saveData ç°åœ¨ä¼šä¿å­˜ runningTasks çš„çŠ¶æ€ï¼ŒloadData ä¼šåœ¨å¯åŠ¨æ—¶æ¢å¤è¿™äº›ä»»åŠ¡ã€‚</li>
                                <li><strong>[Fix]</strong> ä¼˜åŒ–äº†ç§»åŠ¨ç«¯ä»»åŠ¡å¡ç‰‡çš„å¸ƒå±€å’ŒæŒ‰é’®è§¦æ‘¸ä½“éªŒã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v2.5</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> æ–°å¢â€œä»»åŠ¡å†å²è®°å½•â€æŸ¥çœ‹åŠŸèƒ½ï¼ˆç‚¹å‡»ä»»åŠ¡å¡ç‰‡ä¸Šçš„ "ğŸ“‹" å›¾æ ‡æˆ– "å†å²" æŒ‰é’®ï¼‰ã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢â€œä»»åŠ¡å®Œæˆæ¬¡æ•°â€ (Completion Count) ç»Ÿè®¡ï¼Œå¹¶æ˜¾ç¤ºåœ¨ä»»åŠ¡å¡ç‰‡ä¸Šã€‚</li>
                                <li><strong>[Feat]</strong> ä¼˜åŒ–åˆ†ç±»ç®¡ç†ï¼Œæ”¯æŒæŠ˜å /å±•å¼€åˆ†ç±»ä»»åŠ¡åˆ—è¡¨ã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢â€œè®¾ç½®â€é¡µé¢ï¼ŒåŒ…å«å¤šç§é€šçŸ¥å¼€å…³ (æˆå°±ã€é•¿æ—¶é—´è¿è¡Œã€ä½™é¢ä¸è¶³ã€ä¸æ´»è·ƒä»»åŠ¡)ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v2.4</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> (é‡å¤§åŠŸèƒ½) æŒç»­ä»»åŠ¡æ–°å¢â€œæš‚åœâ€(Pause) å’Œâ€œç»§ç»­â€(Resume) åŠŸèƒ½ã€‚</li>
                                <li><strong>[Feat]</strong> é‡æ–°è®¾è®¡äº†ä½™é¢å¡ç‰‡ï¼Œå¢åŠ äº†â€œä»Šæ—¥è·å¾—â€ã€â€œä»Šæ—¥æ¶ˆè€—â€å’Œâ€œè¿è¡Œä¸­â€ä»»åŠ¡çš„ç»Ÿè®¡æ˜¾ç¤ºã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v2.3</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> (é‡å¤§é‡æ„) å¼•å…¥äº†å¼ºå¤§çš„æ•°æ®è¿ç§»ç³»ç»Ÿï¼Œä»¥ç¡®ä¿æ—§ç‰ˆæœ¬æ•°æ®ï¼ˆv1.0, v2.0, v2.1, v2.2ï¼‰èƒ½å®‰å…¨å‡çº§åˆ°æ–°ç‰ˆæœ¬ã€‚</li>
                                <li><strong>[Feat]</strong> å¯¼å…¥æ•°æ®æ—¶ä¼šè¿›è¡Œæ™ºèƒ½ç‰ˆæœ¬æ£€æµ‹å’Œæ•°æ®éªŒè¯ã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢æ•°æ®è¿ç§»å¤±è´¥æ—¶çš„â€œè‡ªåŠ¨å¤‡ä»½â€å’Œâ€œå›æ»šâ€æœºåˆ¶ï¼Œä»¥ä¿éšœæ•°æ®å®‰å…¨ã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢â€œè‡ªå®šä¹‰æé†’â€åŠŸèƒ½ï¼Œå…è®¸ä¸ºä»»åŠ¡è®¾ç½®ç‰¹å®šæ—¶é—´æˆ–ç›¸å¯¹æ—¶é—´çš„æé†’ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v2.0 (åŸºäº Tailwind çš„åŸå‹)</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> (é‡å¤§é‡æ„) åº”ç”¨UIä»ç®€å•åˆ—è¡¨é‡æ„ä¸ºç°ä»£PWAé£æ ¼ (åº•éƒ¨æ ‡ç­¾æ ã€æ‚¬æµ®æŒ‰é’®ã€å¡ç‰‡å¼å¸ƒå±€)ã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢â€œè·å¾—æ—¶é—´â€å’Œâ€œæ¶ˆè´¹æ—¶é—´â€ä¸¤ä¸ªä¸»æ ‡ç­¾é¡µã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢â€œæœ€è¿‘ä»»åŠ¡â€å’Œâ€œæ‰€æœ‰ä»»åŠ¡â€ï¼ˆæŒ‰åˆ†ç±»ï¼‰çš„è§†å›¾ã€‚</li>
                                <li><strong>[Feat]</strong> ä»»åŠ¡åˆ†ç±»æ”¯æŒæŠ˜å /å±•å¼€ã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢â€œæŠ¥å‘Šâ€æ ‡ç­¾é¡µï¼ŒåŒ…å«æ•°æ®æ¦‚è§ˆï¼ˆæ€»è·å¾—/æ€»æ¶ˆè´¹ç­‰ï¼‰ã€‚</li>
                                <li><strong>[Feat]</strong> æ–°å¢â€œæ•°æ®ç®¡ç†â€åŠŸèƒ½ (å¯¼å…¥/å¯¼å‡ºæ•°æ®, æ¸…é™¤æ•°æ®)ã€‚</li>
                            </ul>
                        </div>
                        <div class="version-history-item">
                            <p><strong>ç‰ˆæœ¬ v1.0 (åŸºç¡€åŸå‹)</strong></p>
                            <ul>
                                <li><strong>[Feat]</strong> å®ç°äº†åº”ç”¨çš„æ ¸å¿ƒæ¦‚å¿µï¼šæ—¶é—´ä½™é¢ (currentBalance)ã€‚</li>
                                <li><strong>[Feat]</strong> å®ç°äº†å››ç§åŸºç¡€ä»»åŠ¡ç±»å‹ï¼šå¥–åŠ± (Reward)ã€æŒç»­ (Continuous)ã€å³æ—¶å…‘æ¢ (Instant Exchange)ã€æŒç»­å…‘æ¢ (Continuous Exchange)ã€‚</li>
                                <li><strong>[Feat]</strong> å®ç°äº†ä»»åŠ¡çš„åˆ›å»ºã€åˆ é™¤å’Œæ‰§è¡Œï¼ˆå¼€å§‹/åœæ­¢/å®Œæˆï¼‰ã€‚</li>
                                <li><strong>[Feat]</strong> å®ç°äº†äº¤æ˜“å†å²è®°å½•å’ŒåŸºç¡€çš„æŠ¥å‘ŠåŠŸèƒ½ã€‚</li>
                            </ul>
                        </div>
                         </div>
                </details>
            </div>
        </div>
    </div>

    <button class="fab" id="fabButton" onclick="showTaskModal()">+</button>
<div class="bottom-tabs">
        <button class="tab-button active" onclick="switchTab('earn')"> <div class="tab-icon">â°</div> <div>è·å¾—æ—¶é—´</div> </button>
        <button class="tab-button" onclick="switchTab('spend')"> <div class="tab-icon">ğŸ¯</div> <div>æ¶ˆè´¹æ—¶é—´</div> </button>
        <button class="tab-button" onclick="switchTab('report')"> <div class="tab-icon">ğŸ“Š</div> <div>æŠ¥å‘Š</div> </button>
        <button class="tab-button" onclick="switchTab('settings')"> <div class="tab-icon">âš™ï¸</div> <div>è®¾ç½®</div> </button>
    </div>
<div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">åˆ›å»ºæ–°ä»»åŠ¡</div>
                <button class="close-btn" onclick="hideTaskModal()">Ã—</button>
            </div>
            <form id="taskForm" onsubmit="saveTask(event)">
                 <div class="form-group"> <label class="form-label">ä»»åŠ¡åç§° *</label> <input type="text" id="taskName" class="form-input" placeholder="è¾“å…¥ä»»åŠ¡åç§°" required> <div class="error-message" id="taskNameError"></div> </div>
                 <div class="form-group"> <label class="form-label">ä»»åŠ¡ç±»å‹ *</label> <select type="text" id="taskType" class="form-select" onchange="updateFormForTaskType()" required> <option value="">è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹</option> <option value="reward">å›ºå®šå¥–åŠ±</option> <option value="continuous">æŒç»­å¥–åŠ±</option> <option value="continuous_target">è¾¾æ ‡å¥–åŠ±</option> <option value="instant_redeem">å³æ—¶å…‘æ¢</option> <option value="continuous_redeem">æŒç»­æ¶ˆè€—</option> </select> <div class="error-message" id="taskTypeError"></div> </div>
                 <div class="form-group"> <label class="form-label">ä»»åŠ¡åˆ†ç±» *</label> <input type="text" id="taskCategory" class="form-input" placeholder="è¾“å…¥åˆ†ç±»åç§°" required> <div class="recommendations" id="categoryRecommendations"></div> <div class="error-message" id="taskCategoryError"></div> </div>
                 <div class="form-group hidden" id="colorSelectorContainer"> <label class="form-label">åˆ†ç±»é¢œè‰² (å¯é€‰)</label> <div id="earnColorSelector" class="color-selector hidden"></div> <div id="spendColorSelector" class="color-selector hidden"></div> </div>
                 <div class="form-group hidden" id="fixedTimeGroup"> <label class="form-label" id="fixedTimeLabel">å¥–åŠ±æ—¶é—´ (ç§’) *</label> <input type="text" id="fixedTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800"> <div class="time-presets"> <div class="time-preset" onclick="setTimePreset('fixedTime', 900)">15åˆ†é’Ÿ</div> <div class="time-preset" onclick="setTimePreset('fixedTime', 1800)">30åˆ†é’Ÿ</div> <div class="time-preset" onclick="setTimePreset('fixedTime', 3600)">1å°æ—¶</div> </div> <div class="error-message" id="fixedTimeError"></div> </div>
                 <div class="form-group hidden" id="consumeTimeGroup"> <label class="form-label">æ¶ˆè´¹æ—¶é—´ (ç§’) *</label> <input type="text" id="consumeTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800"> <div class="time-presets"> <div class="time-preset" onclick="setTimePreset('consumeTime', 900)">15åˆ†é’Ÿ</div> <div class="time-preset" onclick="setTimePreset('consumeTime', 1800)">30åˆ†é’Ÿ</div> <div class="time-preset" onclick="setTimePreset('consumeTime', 3600)">1å°æ—¶</div> </div> <div class="error-message" id="consumeTimeError"></div> </div>
                 <div class="form-group hidden" id="multiplierGroup"> <label class="form-label">æ—¶é—´å€ç‡ *</label> <input type="text" id="multiplier" class="form-input" placeholder="ä¾‹å¦‚ï¼š1.0"> <div class="error-message" id="multiplierError"></div> </div>
                 <div class="form-group hidden" id="targetTimeGroup"> <label class="form-label">ç›®æ ‡æ—¶é•¿ (ç§’) *</label> <input type="text" id="targetTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š3600"> <div class="time-presets"> <div class="time-preset" onclick="setTimePreset('targetTime', 3600)">1å°æ—¶</div> <div class="time-preset" onclick="setTimePreset('targetTime', 7200)">2å°æ—¶</div> </div> <div class="error-message" id="targetTimeError"></div> </div>
                 <div class="form-group hidden" id="bonusRewardGroup"> <label class="form-label">é¢å¤–å¥–åŠ± (ç§’)</label> <input type="text" id="bonusReward" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800ï¼Œå¯ä¸å¡«"> <div class="time-presets"> <div class="time-preset" onclick="setTimePreset('bonusReward', 900)">15åˆ†é’Ÿ</div> <div class="time-preset" onclick="setTimePreset('bonusReward', 1800)">30åˆ†é’Ÿ</div> </div> <div class="error-message" id="bonusRewardError"></div> </div>
                 
                 <div class="form-group" id="habitToggleContainer"> <div class="setting-item" style="padding: 0; border: none;"> <div class="setting-info"> <div class="setting-name">è®¾ç½®ä¸ºä¹ æƒ¯</div> <div class="setting-desc">å¼€å¯è¿ç»­æ‰“å¡å’Œé¢å¤–å¥–åŠ±</div> </div> <div class="setting-controls"><label class="switch"> <input type="checkbox" id="isHabitToggle" onchange="toggleHabitSettings()"> <span class="slider"></span> </label></div> </div> </div>
                 <div class="habit-settings hidden" id="habitSettingsGroup"> 
                    <div class="habit-settings-title">ä¹ æƒ¯è®¾ç½®</div> 
                    <div class="habit-grid"> 
                        <div class="form-group"> <label class="form-label">å‘¨æœŸ</label> <select id="habitPeriod" class="form-select"> <option value="daily">æ¯å¤©</option> <option value="weekly">æ¯å‘¨</option> <option value="monthly">æ¯æœˆ</option> </select> </div> 
                        
                        <div class="form-group"> 
                            <label class="form-label">å‘¨æœŸç›®æ ‡æ¬¡æ•° *</label> 
                            <input type="number" id="targetCountInPeriod" class="form-input" value="1" min="1"> 
                        </div>
                        
                        <div class="form-group"> 
                            <label class="form-label">æ¯æ—¥å®Œæˆä¸Šé™</label> 
                            <input type="number" id="habitDailyLimit" class="form-input" value="1" min="1"> 
                        </div> 
                        
                        <div class="form-group"> 
                            <label class="form-label">æŒç»­æ—¶é•¿/å¤©æ•°</label> 
                            <div style="display: flex; gap: 5px;"> 
                                <select id="habitDurationType" class="form-select" onchange="toggleHabitDurationInput()"> 
                                    <option value="infinite">æ— é™</option> <option value="days">æŒç»­å¤©æ•°</option> <option value="weeks">æŒç»­å‘¨æ•°</option> 
                                </select> 
                                <input type="number" id="habitDurationValue" class="form-input hidden" placeholder="å¤©æ•°"> 
                            </div> 
                        </div> 
                    </div> 
                    
                    <div class="form-group"> 
                        <label class="form-label">ä¹ æƒ¯å¥–åŠ± (å¯æ·»åŠ å¤šä¸ª)</label> 
                        <div id="habitRewardsContainer"></div> 
                        <button type="button" class="btn btn-secondary" style="width: 100%; padding: 8px; margin-top: 10px;" onclick="addHabitRewardRule()">+ æ·»åŠ å¥–åŠ±è§„åˆ™</button> 
                    </div> 
                </div>

                 <div class="form-group" id="autoDeleteToggleContainer"> <div class="setting-item" style="padding: 0; border: none;"> <div class="setting-info"> <div class="setting-name">å®Œæˆåè‡ªåŠ¨åˆ é™¤</div> <div class="setting-desc">é€‚ç”¨äºä¸€æ¬¡æ€§çš„ã€æ— éœ€ä¿ç•™çš„ä»»åŠ¡</div> </div> <div class="setting-controls"><label class="switch"> <input type="checkbox" id="autoDeleteToggle"> <span class="slider"></span> </label></div> </div> </div>

                 <div class="form-group" id="reminderToggleContainer"> <div class="setting-item" style="padding: 0; border: none;"> <div class="setting-info"> <div class="setting-name">è®¾ç½®æé†’</div> <div class="setting-desc">åœ¨æŒ‡å®šæ—¶é—´æˆ–å€’è®¡æ—¶åå‘é€é€šçŸ¥</div> </div> <div class="setting-controls"><label class="switch"> <input type="checkbox" id="isReminderToggle"> <span class="slider"></span> </label></div> </div> </div>
                 <div class="habit-settings hidden" id="reminderSettingsGroup"> 
                    <div class="habit-settings-title">æé†’è®¾ç½®</div> 
                    <div class="form-group"> <label class="form-label">æé†’æ¨¡å¼</label> <div class="mode-switch" id="reminderModeSwitch"> <button type="button" class="active" data-mode="absolute">å…·ä½“æ—¶é—´</button> <button type="button" data-mode="relative">å€’è®¡æ—¶</button> </div> </div> 
                    
                    <div class="form-group hidden" id="recurringReminderToggleContainer">
                         <div class="setting-item" style="padding: 0; border: none;">
                            <div class="setting-info">
                                <div class="setting-name">å¾ªç¯æé†’</div>
                                <div class="setting-desc">æé†’è§¦å‘åï¼Œè‡ªåŠ¨æŒ‰ä¹ æƒ¯å‘¨æœŸè®¾ä¸ºä¸‹æ¬¡æé†’</div>
                            </div>
                            <div class="setting-controls">
                                <label class="switch">
                                    <input type="checkbox" id="isRecurringReminderToggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="reminderAbsoluteMode"> <div class="form-group"> <label class="form-label">æé†’æ—¶é—´ *</label> <input type="datetime-local" id="reminderDateTime" class="form-input"> </div> </div> 
                    <div id="reminderRelativeMode" class="hidden"> <div class="form-group"> <label class="form-label">å¤šé•¿æ—¶é—´åæé†’ *</label> <div class="input-group"> <input type="number" id="reminderHours" class="form-input" placeholder="0" min="0"> <span>å°æ—¶</span> <input type="number" id="reminderMinutes" class="form-input" placeholder="0" min="0" max="59"> <span>åˆ†é’Ÿ</span> </div> </div> </div> 
                </div>

                 <div class="form-buttons"> 
                     <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">å–æ¶ˆ</button> 
                     <button type="button" class="btn btn-danger hidden" id="deleteBtn" onclick="deleteTask()">åˆ é™¤</button> 
                     <button type="submit" class="btn btn-primary" id="submitBtn">åˆ›å»º</button> 
                 </div>
            </form>
        </div>
    </div>

    <div class="modal" id="historyModal"> <div class="modal-content"> <div class="modal-header"> <div class="modal-title" id="historyModalTitle">ä»»åŠ¡å†å²</div> <button class="close-btn" onclick="hideHistoryModal()">Ã—</button> </div> <div id="historyContent"></div> </div> </div>
    
    <div class="modal" id="dayDetailModal"> <div class="modal-content"> <div class="modal-header"> <div class="modal-title" id="dayDetailModalTitle">æ¯æ—¥è¯¦æƒ…</div> <button class="close-btn" onclick="hideDayDetailModal()">Ã—</button> </div> <div id="dayDetailContent"></div> </div> </div>

    <div class="modal" id="backdateModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="backdateModalTitle">è¡¥è®°ä»»åŠ¡</div>
                <button class="close-btn" onclick="hideBackdateModal()">Ã—</button>
            </div>
            <form id="backdateForm" onsubmit="saveBackdate(event)">
                <input type="hidden" id="backdateTaskId">
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡åç§°</label>
                    <p id="backdateTaskName" style="font-weight: 500;"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">è¡¥è®°æ—¥æœŸ *</label>
                    <input type="date" id="backdateDate" class="form-input" required>
                </div>
                <div class="form-group" id="backdateModeSwitchContainer">
                    <label class="form-label">è¡¥è®°æ¨¡å¼</label>
                    <div class="mode-switch">
                        <button type="button" class="active" data-mode="duration" onclick="switchBackdateMode('duration')">æŒ‰æ—¶é•¿</button>
                        <button type="button" data-mode="range" onclick="switchBackdateMode('range')">æŒ‰èµ·æ­¢æ—¶é—´</button>
                    </div>
                </div>

                <div id="backdateDurationMode">
                    <div class="form-group">
                        <label class="form-label">æ€»æ—¶é•¿ *</label>
                        <div class="input-group">
                            <input type="number" id="backdateHours" class="form-input" placeholder="0" min="0"> <span>å°æ—¶</span>
                            <input type="number" id="backdateMinutes" class="form-input" placeholder="0" min="0" max="59"> <span>åˆ†é’Ÿ</span>
                        </div>
                        <div class="error-message" id="backdateDurationError"></div>
                    </div>
                </div>

                <div id="backdateRangeMode" class="hidden">
                    <div class="form-group">
                        <label class="form-label">å¼€å§‹æ—¶é—´ *</label>
                        <input type="time" id="backdateStartTime" class="form-input">
                        <div class="error-message" id="backdateStartTimeError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç»“æŸæ—¶é—´ *</label>
                        <input type="time" id="backdateEndTime" class="form-input">
                        <div class="error-message" id="backdateEndTimeError"></div>
                    </div>
                </div>
                
                <div id="backdateCountMode" class="hidden">
                    <div class="form-group">
                        <label class="form-label">è¡¥è®°æ¬¡æ•° *</label>
                        <div class="input-group">
                            <input type="number" id="backdateCount" class="form-input" value="1" min="1" style="width: 100px;"> <span>æ¬¡</span>
                        </div>
                        <div class="error-message" id="backdateCountError"></div>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideBackdateModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ç¡®è®¤è¡¥è®°</button>
                </div>
            </form>
        </div>
    </div>
</body>
<script>
        // [v4.4.0]
        const APP_VERSION = '4.4.0';
        
        // --- [v4.0.0] LeanCloud Initialization ---
        const LC_APP_ID = 'lzgxiX7MCWDatxvj2c6Jxjlu-gzGzoHsz';
        const LC_APP_KEY = 'D33FJ9BdBl0TCHWS5Fbn9kAO';
        const LC_SERVER_URL = 'https://lzgxix7m.lc-cn-n1-shared.com';

        AV.init({
            appId: LC_APP_ID,
            appKey: LC_APP_KEY,
            serverURL: LC_SERVER_URL
        });
        
        // --- App State ---
        let currentBalance = 0; 
        let tasks = []; 
        let transactions = []; 
        let categoryColors = new Map(); 
        let collapsedCategories = new Set(); 
        let runningTasks = new Map(); 
        let earnTabViewMode = 'recent'; // [v4.4.0] 'recent' or 'habits'
        let currentEditingTask = null; 
        let timerInterval = null; 
        let dailyChanges = {}; 
        let currentHistoryTask = null; 
        let currentSelectedColor = null;
        let currentBackdateTaskId = null; // [v3.11.0] For backdate modal
        let currentBackdateMode = 'duration'; // [v3.11.0] 'duration' or 'range'

        let reportState = { 
            flowChartPeriod: '7d', // [v3.12.0] Restored
            heatmapDate: new Date(), 
            analysisPeriod: 'all', 
            analysisView: 'category', 
            analysisItemFilter: null, 
            trendPeriod: '30d', 
            trendView: 'category', 
            tablePeriod: 'all', 
            tableView: 'category', 
            tableSortKey: 'amount_abs_desc',
            tableVisibleRows: 10,
            insightView: 'chart',
            insightSubViewIndex: 0
        };
        // [v3.15.0] Added habitNudge settings
        let notificationSettings = { 
            achievement: true, 
            longRunning: true, 
            longRunningThreshold: 3600, 
            lowBalance: true, 
            lowBalanceThreshold: 1800,
            habitNudgeEnabled: false,
            habitNudgeTime: '21:00',
            lastNudgeDate: null
        };
        
        // --- [v4.0.0] Sync State ---
        let cloudDataObject = null; // Stores the AV.Object for the user's data
        let liveQuery = null;       // Stores the LiveQuery subscription
        let isSyncing = false;      // Flag to prevent save loops
        let isSaving = false;       // Flag to prevent concurrent saves
        let saveQueue = null;       // Queue for pending saves

        const earnColors = [ '#007f5f', '#2b9348', '#55a630', '#80b918', '#aacc00', '#bfd200', '#d4d700', '#dddf00', '#eeef20', '#ffff3f', '#ade8f4', '#48cae4', '#00b4d8', '#0096c7', '#0077b6', '#023e8a' ];
        const spendColors = [ '#ffbe0b', '#fb5607', '#ff006e', '#8338ec', '#3a86ff', '#ef476f', '#f78c6b', '#ffd166', '#c9184a', '#ff4d6d', '#ff8fa3', '#ffb3c1', '#fca311', '#e85d04', '#dc2f02', '#9d0208' ];
        // [v3.10.3] Standardized colors for task view
        const TASK_VIEW_EARN_COLORS = ['#4CAF50', '#66BB6A', '#81C784', '#A5D6A7', '#C8E6C9'];
        const TASK_VIEW_SPEND_COLORS = ['#f44336', '#FF5722', '#FF9800', '#FFC107', '#F8BBD0'];
        const OTHER_COLOR = '#BDBDBD'; // [v3.10.4] Lighter Gray (was #9E9E9E)

        // --- App Initialization and Core UI ---
        
        // [v4.0.0] Modified initApp
        function initApp() { 
            // 1. Init LeanCloud User
            const currentUser = AV.User.current();
            updateAuthUI(currentUser);
            
            // 2. Load Data (will check login state inside)
            loadData(); 
            
            // 3. Init UI components
            renderColorSelectors(); 
            updateNotificationSettingsUI(); 
            startGlobalTimer(); 
            if ('Notification' in window && notificationSettings.achievement && Notification.permission === 'default') { 
                requestNotificationPermission(); 
            } 
            setupReportEventListeners(); 
            setupTaskModalEventListeners(); 
        }
        
        function startGlobalTimer() { if (timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { updateRunningTimers(); checkReminders(); }, 1000); }
        
        function updateAllUI() { 
            // [v4.3.2] FIX 1: Removed "if (isSyncing) return;" to allow UI to refresh even during sync.
            // isSyncing flag is now only checked in saveData() to prevent save loops.
            updateRecentTasks(); 
            updateCategoryTasks(); 
            updateBalance(); 
            if(document.getElementById('reportTab').classList.contains('active')) { 
                updateAllReports(); 
            } 
        }
        
        function switchTab(tabName) { document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active')); document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active')); document.getElementById(tabName + 'Tab').classList.add('active'); event.target.closest('.tab-button').classList.add('active'); document.getElementById('fabButton').style.display = (tabName === 'report' || tabName === 'settings') ? 'none' : 'block'; if (tabName === 'report') { reportState.heatmapDate = new Date(); updateAllReports(); } }
        
        // --- Task Rendering ---
        
        // [v4.4.0] Reworked to support 'recent' vs 'habits' view and 8 items
        function updateRecentTasks() { 
            const earnTasks = tasks.filter(t => ['reward', 'continuous', 'continuous_target'].includes(t.type)); 
            const spendTasks = tasks.filter(t => ['instant_redeem', 'continuous_redeem'].includes(t.type));
            
            // [v4.4.0] Update slice from 6 to 8
            const sortByLastUsed = (taskList) => [...taskList].sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0)).slice(0, 8);
            
            // 1. Render Spend Tab (Always shows 8 recent)
            renderTaskList('recentSpendTasks', sortByLastUsed(spendTasks)); 
            
            // 2. Render Earn Tab (Based on view mode)
            if (earnTabViewMode === 'habits') {
                // Show "Today Habits" view
                const dailyHabits = tasks.filter(t => t.isHabit && t.habitDetails.period === 'daily');
                
                // Sort: Uncompleted first, then by creation ID (stable sort)
                dailyHabits.sort((a, b) => {
                    const aCompleted = isHabitCompletedToday(a);
                    const bCompleted = isHabitCompletedToday(b);
                    
                    if (aCompleted !== bCompleted) {
                        return aCompleted ? 1 : -1; // false (uncompleted) comes first
                    }
                    // If both are same state, sort by ID to keep order stable
                    return parseInt(a.id) - parseInt(b.id); 
                });
                
                renderTaskList('recentEarnTasks', dailyHabits.slice(0, 8));
                
            } else {
                // Show "Recent Tasks" view (Default)
                renderTaskList('recentEarnTasks', sortByLastUsed(earnTasks)); 
            }
            
            // 3. [v4.4.0] Safely update UI titles and buttons
            updateEarnTaskViewUI();
        }
        
        // [v4.4.0] New helper function for sorting habits
        function isHabitCompletedToday(task) {
            if (!task || !task.isHabit || task.habitDetails.period !== 'daily') {
                return false;
            }
            const todayStr = getLocalDateString(new Date());
            const completionsToday = transactions.filter(t => 
                t.taskId === task.id && 
                t.type === 'earn' && 
                getLocalDateString(t.timestamp) === todayStr
            ).length;
            
            const dailyLimit = task.habitDetails.dailyLimit || 1;
            return completionsToday >= dailyLimit;
        }

        // [v4.4.0] New SAFE UI update function (prevents startup crash)
        function updateEarnTaskViewUI() {
            const titleEl = document.getElementById('earnTasksTitle');
            const btnEl = document.getElementById('earnViewToggleBtn');

            // DEFENSE: If HTML wasn't updated, skip UI update to prevent crash
            if (!titleEl || !btnEl) {
                console.warn("Time Bank v4.4.0: 'earnTasksTitle' or 'earnViewToggleBtn' not found in DOM. Skipping UI update.");
                return;
            }

            if (earnTabViewMode === 'habits') {
                titleEl.textContent = 'ä»Šæ—¥ä¹ æƒ¯';
                btnEl.textContent = 'ğŸ”„ æœ€è¿‘ä»»åŠ¡';
            } else {
                titleEl.textContent = 'æœ€è¿‘ä»»åŠ¡';
                btnEl.textContent = 'ğŸ“… ä»Šæ—¥ä¹ æƒ¯';
            }
        }
        
        // [v4.4.0] New function to toggle the view
        function toggleEarnView() {
            earnTabViewMode = (earnTabViewMode === 'recent') ? 'habits' : 'recent';
            saveData();
            updateRecentTasks();
        }

        function groupTasksByCategory(taskList) { return taskList.reduce((acc, task) => { (acc[task.category] = acc[task.category] || []).push(task); return acc; }, {}); }
        function renderCategoryTasks(containerId, tasksByCategory) { const container = document.getElementById(containerId); if (Object.keys(tasksByCategory).length === 0) { container.innerHTML = `<div class="empty-message" style="color:var(--text-color-light)">æš‚æ— ä»»åŠ¡</div>`; return; } container.innerHTML = Object.entries(tasksByCategory).map(([category, categoryTasks]) => { const isCollapsed = collapsedCategories.has(category); const color = categoryColors.get(category) || '#666'; categoryTasks.sort((a, b) => (b.isHabit ? 1 : 0) - (a.isHabit ? 1 : 0)); return `<div class="category-tasks"><div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${category}')"><div class="category-info"><div class="category-color" style="background-color: ${color}"></div><div class="category-name">${category}</div><div class="category-count">(${categoryTasks.length})</div></div><div class="category-toggle">â–¼</div></div><div class="category-tasks-list ${isCollapsed ? 'collapsed' : ''}"><div class="category-tasks-grid">${renderTaskCards(categoryTasks)}</div></div></div>`; }).join(''); }
        function renderTaskList(containerId, taskList) { const container = document.getElementById(containerId); if (taskList.length === 0) { container.innerHTML = `<div class="empty-message" style="color:var(--text-color-light)">æš‚æ— æœ€è¿‘ä»»åŠ¡</div>`; return; } container.innerHTML = renderTaskCards(taskList); }
        
        // [v4.4.0] Updated renderTaskCards (Fix: "Today Done" logic; Feat: Backdate for all; UI: Habit text)
        function renderTaskCards(taskList) {
            const todayStr = getLocalDateString(new Date()); 
            return taskList.map(task => {
                const runningTask = runningTasks.get(task.id);
                const isRunning = !!runningTask;
                const color = categoryColors.get(task.category) || '#666';
                const habitClass = task.isHabit ? 'is-habit' : '';
                const habitStyle = task.isHabit ? `style="--habit-color: ${color}"` : '';
                
                // [v4.2.0] Backdate enabled for 'reward' and 'instant_redeem' as well
                const canBackdate = ['continuous', 'continuous_target', 'continuous_redeem', 'reward', 'instant_redeem'].includes(task.type);
                const backdateMenuItem = canBackdate ? `<div class="task-card-menu-item" onclick="showBackdateModal('${task.id}')">ğŸ—“ï¸ è¡¥è®°</div>` : '';

                const menuDiv = `<div class="task-card-menu"> 
                                    <div class="task-card-menu-item" onclick="editTask(tasks.find(t => t.id === '${task.id}'))">âœï¸ ç¼–è¾‘</div>
                                    <div class="task-card-menu-item" onclick="showTaskHistory('${task.id}')">ğŸ“‹ å†å²</div>
                                    ${backdateMenuItem}
                                </div>`;
                const titleRow = `<div class="task-row title-row">
                                    <div class="task-name" title="${task.name}">${task.name}</div>
                                    <button class="more-btn" onclick="toggleTaskMenu(event)">...</button>
                                    ${menuDiv}
                                </div>`; 
                                
                let statusDetails = `<span class="task-category" style="background-color: ${color}">${task.category}</span>`; 
                
                if (task.isHabit) {
                    // Get info for "today"
                    const periodInfoToday = getHabitPeriodInfo(task, transactions, new Date());
                    const targetCount = periodInfoToday.targetCount || 1; 
                    const dailyLimit = task.habitDetails.dailyLimit || 1;
                    const completionsToday = transactions.filter(t => t.taskId === task.id && getLocalDateString(t.timestamp) === todayStr).length;
                    
                    const isTargetAchieved = periodInfoToday.currentCount >= targetCount;
                    const isDailyLimitReached = completionsToday >= dailyLimit;
                    
                    const unitMap = { daily: 'å¤©', weekly: 'å‘¨', monthly: 'æœˆ' };
                    const periodText = unitMap[task.habitDetails.period] || 'æ¬¡';
                    
                    // [v4.2.0] New UI Logic Priority
                    
                    // Priority 1: Daily Limit Reached?
                    if (isDailyLimitReached) {
                        statusDetails += ` <span class="task-completion-count text-positive">ä»Šæ—¥å·²å®Œæˆ âœ…</span>`;
                    }
                    // Priority 2: Daily Limit NOT Reached, but Period Target IS Met?
                    else if (isTargetAchieved) {
                        // [v4.4.0] UI Text Fix
                        statusDetails += ` <span class="task-completion-count text-positive">å·²è¾¾æ ‡âœ…è¿ç»­${task.habitDetails.streak || 0}${periodText}</span>`;
                    }
                    // Priority 3: Neither Daily Limit nor Period Target Met.
                    else {
                        if (task.habitDetails.period === 'daily' && targetCount === 1) {
                            // Daily N=1 (Not met) -> Show streak/broken status
                            if (task.habitDetails.isBroken) {
                                statusDetails += ` <span class="task-completion-count text-negative">æ˜¨æ—¥å·²ä¸­æ–­</span>`;
                            } else {
                                const streak = task.habitDetails.streak || 0;
                                statusDetails += ` <span class="task-completion-count">å·²è¿ç»­ ${streak} ${periodText}</span>`;
                            }
                        } else {
                            // All N>1 habits OR Weekly/Monthly N=1 habits (Not met) -> Show progress
                            statusDetails += ` <span class="task-completion-count">å·²å®Œæˆ ${periodInfoToday.currentCount}/${targetCount} æ¬¡</span>`;
                        }
                    }
                    
                } else if ((task.completionCount || 0) > 0) { 
                    statusDetails += ` <span class="task-completion-count">å·²å®Œæˆ ${task.completionCount} æ¬¡</span>`; 
                } 
                
                const statusRow = `<div class="task-row"><div class="task-details">${statusDetails}</div></div>`; let paramsText = ''; switch (task.type) { case 'reward': paramsText = `å¥–åŠ±: ${formatTime(task.fixedTime, false)}`; break; case 'continuous': paramsText = `${task.multiplier}å€ç‡`; break; case 'continuous_target': paramsText = `${task.multiplier}å€ç‡ â€¢ ç›®æ ‡ ${formatTime(task.targetTime, false).replace(/0ç§’$/, '').trim()}`; break; case 'instant_redeem': paramsText = `æ¶ˆè´¹: ${formatTime(task.consumeTime, false)}`; break; case 'continuous_redeem': paramsText = `${task.multiplier}å€ç‡æ¶ˆè€—`; break; } const paramsRow = `<div class="task-row task-parameters">${paramsText}</div>`; let actionRow = ''; let timerRow = ''; if (isRunning) { const isPaused = runningTask.isPaused; const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000); const pauseResumeBtn = isPaused ? `<button class="task-btn primary" onclick="resumeTask('${task.id}')">ç»§ç»­</button>` : `<button class="task-btn warning" onclick="pauseTask('${task.id}')">æš‚åœ</button>`; actionRow = `<div class="task-row task-actions">${pauseResumeBtn}<button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button><button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button></div>`; let timerText = isPaused ? `å·²æš‚åœï¼š${formatTime(totalSeconds)}` : `è¿è¡Œä¸­ï¼š${formatTime(totalSeconds)}`; if (task.type === 'continuous_target') { const progress = Math.min((totalSeconds / task.targetTime) * 100, 100); timerText += ` (${progress.toFixed(1)}%${runningTask.achieved ? ' âœ…' : ''})`; } timerRow = `<div class="task-row task-timer-status"><div class="task-timer">${timerText}</div></div>`; } else { let actionButton = ''; switch (task.type) { case 'reward': actionButton = `<button class="task-btn success wide" onclick="completeTask('${task.id}')">å®Œæˆ</button>`; break; case 'instant_redeem': actionButton = `<button class="task-btn danger wide" onclick="redeemTask('${task.id}')">å…‘æ¢</button>`; break; default: actionButton = `<button class="task-btn primary wide" onclick="startTask(event, '${task.id}')">å¼€å§‹</button>`; break; } actionRow = `<div class="task-row task-actions">${actionButton}</div>`; } return `<div class="task-card ${habitClass}" ${habitStyle} data-task-id="${task.id}">${titleRow}${statusRow}${paramsRow}${actionRow}${timerRow}</div>`; 
            }).join(''); 
        }

        function toggleTaskMenu(event) { 
            event.stopPropagation(); 
            const card = event.target.closest('.task-card');
            if (!card) return;
            const currentMenu = card.querySelector('.task-card-menu');
            if (!currentMenu) return;
            const isCurrentlyShown = currentMenu.classList.contains('show');
            document.querySelectorAll('.task-card-menu.show').forEach(menu => { if (menu !== currentMenu) menu.classList.remove('show'); }); 
            currentMenu.classList.toggle('show', !isCurrentlyShown);
        }

        document.addEventListener('click', (event) => { 
            if (!event.target.closest('.task-card')) { 
                document.querySelectorAll('.task-card-menu.show').forEach(menu => menu.classList.remove('show')); 
            } else if (!event.target.closest('.more-btn') && !event.target.closest('.task-card-menu')) {
                 document.querySelectorAll('.task-card-menu.show').forEach(menu => menu.classList.remove('show')); 
            }
        });
        
        function updateRunningTimers() { 
            runningTasks.forEach((runningTask, taskId) => { 
                if (runningTask.isPaused) return; 
                const task = tasks.find(t => t.id === taskId); 
                if (task) { 
                    const totalSeconds = Math.floor((runningTask.elapsedTime + Date.now() - runningTask.startTime)) / 1000; 
                    if (task.type === 'continuous_target' && !runningTask.achieved && totalSeconds >= task.targetTime) { 
                        runningTask.achieved = true; 
                        showNotification('ğŸ¯ è¾¾æ ‡æé†’', `ä»»åŠ¡"${task.name}"å·²è¾¾åˆ°ç›®æ ‡æ—¶é—´ï¼`, 'achievement'); 
                    } 
                    if (notificationSettings.longRunning && totalSeconds > 0 && totalSeconds > notificationSettings.longRunningThreshold && (totalSeconds % notificationSettings.longRunningThreshold < 1)) {
                        showNotification('â° é•¿æ—¶é—´è¿è¡Œæé†’', `ä»»åŠ¡"${task.name}"å·²è¿è¡Œ${formatTime(totalSeconds)}`, 'longRunning'); 
                    }
                    
                    const timerElements = document.querySelectorAll(`.task-card[data-task-id="${taskId}"] .task-timer`);
                    if (timerElements.length > 0) {
                        let timerText = `è¿è¡Œä¸­ï¼š${formatTime(totalSeconds)}`;
                        if (task.type === 'continuous_target') {
                            const progress = Math.min((totalSeconds / task.targetTime) * 100, 100);
                            timerText += ` (${progress.toFixed(1)}%${runningTask.achieved ? ' âœ…' : ''})`;
                        }
                        timerElements.forEach(timerElement => timerElement.textContent = timerText);
                    }
                } 
            });
            
            // [v3.15.0] Daily Habit Nudge Check
            if (!notificationSettings.habitNudgeEnabled) return;
            const now = new Date();
            const todayStr = getLocalDateString(now);
            if (notificationSettings.lastNudgeDate === todayStr) return; // Already nudged today
            
            const [nudgeHours, nudgeMinutes] = notificationSettings.habitNudgeTime.split(':').map(Number);
            if (now.getHours() < nudgeHours || (now.getHours() === nudgeHours && now.getMinutes() < nudgeMinutes)) {
                return; // Not time yet
            }

            const uncompletedHabits = tasks.filter(t => t.isHabit).filter(t => {
                const { currentCount, targetCountInPeriod } = getHabitPeriodInfo(t, transactions, new Date());
                // For daily habits, targetCountInPeriod must be completed today
                if (t.habitDetails.period === 'daily') {
                    // Check if completions today < target
                    const completionsToday = transactions.filter(tx => 
                        tx.taskId === t.id && 
                        tx.type === 'earn' && 
                        getLocalDateString(tx.timestamp) === todayStr
                    ).length;
                    return completionsToday < (targetCountInPeriod || 1);
                }
                // For weekly/monthly habits, check if target has been achieved in the current period
                return currentCount < (targetCountInPeriod || 1);
            });
            
            if (uncompletedHabits.length > 0) {
                const title = 'ğŸŒ™ æ¯æ—¥ä¹ æƒ¯æé†’';
                const body = `æ‚¨ä»Šå¤©è¿˜æœ‰ ${uncompletedHabits.length} ä¸ªä¹ æƒ¯æœªå®Œæˆï¼Œä¾‹å¦‚ï¼š${uncompletedHabits[0].name}...`;
                // Use 'achievement' type as it's a general app notification, but control via 'habitNudgeEnabled'
                showNotification(title, body, 'achievement'); 
            }
            
            notificationSettings.lastNudgeDate = todayStr;
            saveData();
        } 
        
        function toggleCategory(category) { collapsedCategories.has(category) ? collapsedCategories.delete(category) : collapsedCategories.add(category); saveData(); updateCategoryTasks(); }
        function updateBalance() { const balanceCard = document.getElementById('balanceCard'); const balanceAmount = document.getElementById('balanceAmount'); balanceAmount.textContent = formatTime(currentBalance); balanceCard.classList.toggle('negative', currentBalance < 0); balanceAmount.style.color = currentBalance < 0 ? 'var(--color-negative)' : (currentBalance < notificationSettings.lowBalanceThreshold ? 'var(--color-warning)' : 'var(--color-primary)'); const todayChanges = dailyChanges[new Date().toDateString()] || { earned: 0, spent: 0 }; document.getElementById('dailyEarned').textContent = formatTime(todayChanges.earned); document.getElementById('dailySpent').textContent = formatTime(todayChanges.spent); if (notificationSettings.lowBalance && currentBalance >= 0 && currentBalance < notificationSettings.lowBalanceThreshold) { showNotification('âš ï¸ ä½™é¢ä¸è¶³', `å½“å‰ä½™é¢ä»…å‰© ${formatTime(currentBalance)}`, 'lowBalance'); } }
// --- Task Creation/Editing Modals ---
        function showTaskModal() { 
            currentEditingTask = null; 
            currentSelectedColor = null; 
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºæ–°ä»»åŠ¡'; 
            document.getElementById('submitBtn').textContent = 'åˆ›å»º'; 
            document.getElementById('deleteBtn').classList.add('hidden'); 
            document.getElementById('taskForm').reset(); 
            // [v3.18.0] Reset target count
            document.getElementById('targetCountInPeriod').value = 1; 
            document.getElementById('habitDailyLimit').value = 1; 
            updateFormForTaskType(); 
            toggleHabitSettings(false); 
            toggleReminderSettings(false); 
            toggleRecurringReminderVisibility(); 
            document.getElementById('habitRewardsContainer').innerHTML = ''; 
            document.getElementById('taskModal').classList.add('show'); 
        }
        function hideTaskModal() { document.getElementById('taskModal').classList.remove('show'); clearFormErrors(); }
        function editTask(task) { 
            currentEditingTask = task; 
            currentSelectedColor = categoryColors.get(task.category); 
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ä»»åŠ¡'; 
            document.getElementById('submitBtn').textContent = 'ä¿å­˜'; 
            document.getElementById('deleteBtn').classList.remove('hidden'); 
            const form = document.getElementById('taskForm'); 
            form.taskName.value = task.name; 
            form.taskCategory.value = task.category; 
            form.taskType.value = task.type; 
            if (task.fixedTime) form.fixedTime.value = task.fixedTime; 
            if (task.consumeTime) form.consumeTime.value = task.consumeTime; 
            if (task.multiplier) form.multiplier.value = task.multiplier; 
            if (task.targetTime) form.targetTime.value = task.targetTime; 
            if (task.bonusReward) form.bonusReward.value = task.bonusReward; 
            
            document.getElementById('isHabitToggle').checked = task.isHabit || false; 
            if (task.isHabit && task.habitDetails) { 
                document.getElementById('habitPeriod').value = task.habitDetails.period; 
                document.getElementById('habitDurationType').value = task.habitDetails.duration.type; 
                // [v3.18.0] Load new target count
                document.getElementById('targetCountInPeriod').value = task.habitDetails.targetCountInPeriod || 1; 
                document.getElementById('habitDailyLimit').value = task.habitDetails.dailyLimit || 1; 
                if (task.habitDetails.duration.type !== 'infinite') document.getElementById('habitDurationValue').value = task.habitDetails.duration.value; 
                const rewardsContainer = document.getElementById('habitRewardsContainer'); 
                rewardsContainer.innerHTML = ''; 
                task.habitDetails.rewards.forEach(rule => addHabitRewardRule(rule)); 
            } else { 
                document.getElementById('habitRewardsContainer').innerHTML = ''; 
                // [v3.18.0] Reset to default values
                document.getElementById('targetCountInPeriod').value = 1; 
                document.getElementById('habitDailyLimit').value = 1; 
            }
            
            document.getElementById('autoDeleteToggle').checked = task.autoDeleteOnCompletion || false;
            const hasReminder = task.reminderDetails && task.reminderDetails.status === 'pending';
            document.getElementById('isReminderToggle').checked = hasReminder;
            if (hasReminder) {
                const { mode, time, isRecurring } = task.reminderDetails;
                switchReminderMode(mode);
                if (mode === 'absolute') {
                    document.getElementById('reminderDateTime').value = time;
                    document.getElementById('isRecurringReminderToggle').checked = isRecurring || false; 
                } else { // relative
                    document.getElementById('reminderHours').value = Math.floor(time / 3600);
                    document.getElementById('reminderMinutes').value = Math.floor((time % 3600) / 60);
                }
            } else {
                switchReminderMode('absolute'); 
            }

            updateFormForTaskType(); 
            toggleHabitSettings(task.isHabit);
            toggleReminderSettings(hasReminder);
            toggleHabitDurationInput();
            toggleRecurringReminderVisibility(); 
            
            document.getElementById('taskModal').classList.add('show'); 
        }
        function deleteTask() { if (!currentEditingTask) return; if (confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${currentEditingTask.name}"å—ï¼Ÿ`)) { runningTasks.delete(currentEditingTask.id); tasks = tasks.filter(t => t.id !== currentEditingTask.id); saveData(); updateAllUI(); hideTaskModal(); } }
        function updateFormForTaskType() { const taskType = document.getElementById('taskType').value; const earnTypes = ['reward', 'continuous', 'continuous_target']; const colorSelectorContainer = document.getElementById('colorSelectorContainer'); const earnColorSelector = document.getElementById('earnColorSelector'); const spendColorSelector = document.getElementById('spendColorSelector'); document.querySelectorAll('#taskForm .form-group[id$="Group"]').forEach(el => el.classList.add('hidden')); if (taskType) { colorSelectorContainer.classList.remove('hidden'); const isEarn = earnTypes.includes(taskType); earnColorSelector.classList.toggle('hidden', !isEarn); spendColorSelector.classList.toggle('hidden', isEarn); renderColorSelectors(currentEditingTask ? categoryColors.get(currentEditingTask.category) : null); } else { colorSelectorContainer.classList.add('hidden'); } const habitToggle = document.getElementById('habitToggleContainer'); const autoDeleteToggle = document.getElementById('autoDeleteToggleContainer'); if (earnTypes.includes(taskType)) { habitToggle.classList.remove('hidden'); autoDeleteToggle.disabled = document.getElementById('isHabitToggle').checked; } else { habitToggle.classList.add('hidden'); document.getElementById('isHabitToggle').checked = false; toggleHabitSettings(false); autoDeleteToggle.disabled = false; } switch (taskType) { case 'reward': document.getElementById('fixedTimeGroup').classList.remove('hidden'); break; case 'continuous': document.getElementById('multiplierGroup').classList.remove('hidden'); break; case 'continuous_target': ['multiplierGroup', 'targetTimeGroup', 'bonusRewardGroup'].forEach(id => document.getElementById(id).classList.remove('hidden')); break; case 'instant_redeem': document.getElementById('consumeTimeGroup').classList.remove('hidden'); break; case 'continuous_redeem': document.getElementById('multiplierGroup').classList.remove('hidden'); break; } updateCategoryRecommendations(taskType); }
        function toggleHabitSettings(forceState) { 
            const isHabit = typeof forceState === 'boolean' ? forceState : document.getElementById('isHabitToggle').checked; 
            document.getElementById('habitSettingsGroup').classList.toggle('hidden', !isHabit); 
            document.getElementById('autoDeleteToggle').disabled = isHabit; 
            if (isHabit) document.getElementById('autoDeleteToggle').checked = false; 
            const fixedTimeLabel = document.getElementById('fixedTimeLabel'); 
            if(fixedTimeLabel) fixedTimeLabel.textContent = isHabit ? 'åŸºç¡€å¥–åŠ± (ç§’) *' : 'å¥–åŠ±æ—¶é—´ (ç§’) *'; 
            toggleRecurringReminderVisibility(); 
        }
        function toggleReminderSettings(forceState) { 
            const isReminder = typeof forceState === 'boolean' ? forceState : document.getElementById('isReminderToggle').checked; 
            document.getElementById('reminderSettingsGroup').classList.toggle('hidden', !isReminder); 
            toggleRecurringReminderVisibility(); 
        }
        function toggleRecurringReminderVisibility() {
            const container = document.getElementById('recurringReminderToggleContainer');
            const isHabit = document.getElementById('isHabitToggle').checked;
            const isReminder = document.getElementById('isReminderToggle').checked;
            const isAbsoluteMode = document.querySelector('#reminderModeSwitch .active').dataset.mode === 'absolute';
            
            const show = isHabit && isReminder && isAbsoluteMode;
            container.classList.toggle('hidden', !show);
            if (!show) {
                document.getElementById('isRecurringReminderToggle').checked = false;
            }
        }
        function switchReminderMode(mode) { 
            document.getElementById('reminderAbsoluteMode').classList.toggle('hidden', mode !== 'absolute'); 
            document.getElementById('reminderRelativeMode').classList.toggle('hidden', mode !== 'relative'); 
            document.querySelectorAll('#reminderModeSwitch button').forEach(btn => { btn.classList.toggle('active', btn.dataset.mode === mode); }); 
            toggleRecurringReminderVisibility(); 
        }
        function toggleHabitDurationInput() { const durationType = document.getElementById('habitDurationType').value; const valueInput = document.getElementById('habitDurationValue'); valueInput.classList.toggle('hidden', durationType === 'infinite'); valueInput.placeholder = durationType === 'days' ? 'å¤©æ•°' : 'å‘¨æ•°'; }
        function addHabitRewardRule(rule = null) { const container = document.getElementById('habitRewardsContainer'); const ruleDiv = document.createElement('div'); ruleDiv.className = 'habit-reward-rule'; const type = rule ? rule.type : 'fixed'; const start = rule ? rule.start : 1; const value = rule ? rule.value : ''; ruleDiv.innerHTML = `<select class="form-select reward-type"><option value="fixed" ${type === 'fixed' ? 'selected' : ''}>å›ºå®šå¥–åŠ±</option><option value="incremental" ${type === 'incremental' ? 'selected' : ''}>é€’å¢å¥–åŠ±</option></select><input type="number" class="form-input reward-start" placeholder="ä»ç¬¬ N å‘¨æœŸ" value="${start}" min="1"><input type="number" class="form-input reward-value" placeholder="å¥–åŠ±å€¼(ç§’)" value="${value}"><button type="button" class="remove-reward-btn" onclick="this.parentElement.remove()">-</button>`; container.appendChild(ruleDiv); }
        function setTimePreset(fieldId, seconds) { document.getElementById(fieldId).value = seconds; }
        
        // [v3.18.0] Updated saveTask to include targetCountInPeriod
        function saveTask(event) {
            event.preventDefault();
            clearFormErrors();
            
            const formData = {
                name: document.getElementById('taskName').value.trim(),
                category: document.getElementById('taskCategory').value.trim(),
                type: document.getElementById('taskType').value,
                isHabit: document.getElementById('isHabitToggle').checked,
                autoDeleteOnCompletion: document.getElementById('autoDeleteToggle').checked,
            };

            let hasError = !formData.name || !formData.category || !formData.type;
            if (!formData.name) showFieldError('taskName', 'è¯·è¾“å…¥ä»»åŠ¡åç§°');
            if (!formData.category) showFieldError('taskCategory', 'è¯·è¾“å…¥ä»»åŠ¡åˆ†ç±»');
            if (!formData.type) showFieldError('taskType', 'è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹');
            
            const parseAndValidate = (id, fieldName, isFloat = false) => { const input = document.getElementById(id); const value = isFloat ? parseFloat(input.value) : parseInt(input.value); if (isNaN(value) || value <= 0) { showFieldError(id, `è¯·è¾“å…¥æœ‰æ•ˆçš„${fieldName}`); hasError = true; } return value; };
            const parseAndValidateOptional = (id, fieldName) => { const input = document.getElementById(id); if (!input.value) return 0; const value = parseInt(input.value); if (isNaN(value) || value < 0) { showFieldError(id, `è¯·è¾“å…¥æœ‰æ•ˆçš„${fieldName}`); hasError = true; } return value; }
            
            switch (formData.type) { case 'reward': formData.fixedTime = parseAndValidate('fixedTime', 'å¥–åŠ±æ—¶é—´'); break; case 'instant_redeem': formData.consumeTime = parseAndValidate('consumeTime', 'æ¶ˆè´¹æ—¶é—´'); break; case 'continuous': case 'continuous_redeem': formData.multiplier = parseAndValidate('multiplier', 'æ—¶é—´å€ç‡', true); break; case 'continuous_target': formData.multiplier = parseAndValidate('multiplier', 'æ—¶é—´å€ç‡', true); formData.targetTime = parseAndValidate('targetTime', 'ç›®æ ‡æ—¶é•¿'); formData.bonusReward = parseAndValidateOptional('bonusReward', 'é¢å¤–å¥–åŠ±'); break; }
            
            if (formData.isHabit) {
                // [v3.18.0] New field: targetCountInPeriod
                const targetCountInPeriod = parseInt(document.getElementById('targetCountInPeriod').value);
                const dailyLimit = parseInt(document.getElementById('habitDailyLimit').value);
                
                // [v3.18.0] Validation
                if (isNaN(targetCountInPeriod) || targetCountInPeriod < 1) {
                    // [v4.0.2] Fix: Use correct ID for error
                    showFieldError('targetCountInPeriod', 'å‘¨æœŸç›®æ ‡æ¬¡æ•°å¿…é¡»å¤§äºç­‰äº1');
                    hasError = true;
                }
                
                formData.habitDetails = { 
                    period: document.getElementById('habitPeriod').value, 
                    duration: { 
                        type: document.getElementById('habitDurationType').value, 
                        value: document.getElementById('habitDurationValue').value ? parseInt(document.getElementById('habitDurationValue').value) : 0 
                    }, 
                    // [v3.18.0] Save new field
                    targetCountInPeriod: isNaN(targetCountInPeriod) || targetCountInPeriod < 1 ? 1 : targetCountInPeriod,
                    dailyLimit: isNaN(dailyLimit) || dailyLimit < 1 ? 1 : dailyLimit, 
                    rewards: [] 
                };
                
                if (formData.habitDetails.duration.type !== 'infinite' && formData.habitDetails.duration.value <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æŒç»­æ—¶é•¿'); hasError = true; }
                document.querySelectorAll('.habit-reward-rule').forEach(ruleEl => { const type = ruleEl.querySelector('.reward-type').value; const start = parseInt(ruleEl.querySelector('.reward-start').value); const value = parseInt(ruleEl.querySelector('.reward-value').value); if (!isNaN(start) && start > 0 && !isNaN(value) && value > 0) { formData.habitDetails.rewards.push({ type, start, value }); } else { alert('ä¹ æƒ¯å¥–åŠ±è§„åˆ™å¡«å†™ä¸å®Œæ•´æˆ–æ— æ•ˆ'); hasError = true; } });
            }

            if (document.getElementById('isReminderToggle').checked) {
                const mode = document.querySelector('#reminderModeSwitch .active').dataset.mode;
                let timeValue;
                let isRecurring = false; 
                
                if (mode === 'absolute') {
                    timeValue = document.getElementById('reminderDateTime').value;
                    if (!timeValue || new Date(timeValue) <= new Date()) {
                        alert('æé†’æ—¶é—´å¿…é¡»æ˜¯æœªæ¥çš„ä¸€ä¸ªæ—¶é—´ç‚¹'); hasError = true;
                    }
                    isRecurring = document.getElementById('isRecurringReminderToggle').checked; 
                } else { // relative
                    const hours = parseInt(document.getElementById('reminderHours').value || '0');
                    const minutes = parseInt(document.getElementById('reminderMinutes').value || '0');
                    timeValue = (hours * 3600) + (minutes * 60);
                    if (timeValue <= 0) {
                        alert('å€’è®¡æ—¶æ—¶é•¿å¿…é¡»å¤§äº0'); hasError = true;
                    }
                }
                if (!hasError) {
                    formData.reminderDetails = {
                        mode: mode,
                        time: mode === 'absolute' ? timeValue : timeValue,
                        isRecurring: isRecurring, 
                        creationTimestamp: mode === 'relative' ? Date.now() : null,
                        status: 'pending'
                    };
                }
            } else {
                formData.reminderDetails = null;
            }

            if (hasError) return;
            
            let colorToSet = currentSelectedColor; if (currentEditingTask) { const oldCategory = currentEditingTask.category; if (oldCategory !== formData.category) { if (categoryColors.has(formData.category)) { colorToSet = categoryColors.get(formData.category); } else if (!colorToSet) { colorToSet = getRandomAvailableColor(formData.type); } const oldCategoryInUse = tasks.some(t => t.id !== currentEditingTask.id && t.category === oldCategory); if (!oldCategoryInUse) categoryColors.delete(oldCategory); } } else { if (categoryColors.has(formData.category)) { colorToSet = categoryColors.get(formData.category); } else if (!colorToSet) { colorToSet = getRandomAvailableColor(formData.type); } }
            categoryColors.set(formData.category, colorToSet); 
            
            if (currentEditingTask) { 
                if (currentEditingTask.isHabit && !formData.isHabit) delete currentEditingTask.habitDetails; 
                else if (!currentEditingTask.isHabit && formData.isHabit) { 
                    formData.habitDetails.streak = 0; 
                    formData.habitDetails.lastCompletionDate = null; 
                    formData.habitDetails.isBroken = false; // [v4.0.3] Init property
                } 
                else if (currentEditingTask.isHabit && formData.isHabit) { 
                    formData.habitDetails.streak = currentEditingTask.habitDetails.streak; 
                    formData.habitDetails.lastCompletionDate = currentEditingTask.habitDetails.lastCompletionDate; 
                    formData.habitDetails.isBroken = currentEditingTask.habitDetails.isBroken || false; // [v4.0.3] Preserve property
                } 
                Object.assign(currentEditingTask, formData); 
            } else { 
                const newTask = { id: Date.now().toString(), ...formData, completionCount: 0, lastUsed: 0 }; 
                if (newTask.isHabit) { 
                    newTask.habitDetails.streak = 0; 
                    newTask.habitDetails.lastCompletionDate = null; 
                    newTask.habitDetails.isBroken = false; // [v4.0.3] Init property
                } 
                tasks.push(newTask); 
            }
            saveData(); updateAllUI(); hideTaskModal(); 
        }
        function showFieldError(fieldId, message) { const field = document.getElementById(fieldId); const errorElementId = fieldId.endsWith('Error') ? fieldId : fieldId + 'Error'; const errorElement = document.getElementById(errorElementId); if (field) field.classList.add('error'); if (errorElement) { errorElement.textContent = message; errorElement.classList.add('show'); } }
        function clearFormErrors() { document.querySelectorAll('.form-input.error, .form-select.error').forEach(el => el.classList.remove('error')); document.querySelectorAll('.error-message.show').forEach(el => el.classList.remove('show')); }
        
        // --- Task Actions ---
        function completeTask(taskId) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            const task = tasks[taskIndex];

            task.lastUsed = Date.now();
            if (task.isHabit) {
                const todayStr = getLocalDateString(new Date());
                const completionsToday = transactions.filter(t => t.taskId === taskId && getLocalDateString(t.timestamp) === todayStr).length;
                if (completionsToday >= (task.habitDetails.dailyLimit || 1)) {
                    alert('å·²è¾¾åˆ°æ­¤ä¹ æƒ¯çš„æ¯æ—¥å®Œæˆä¸Šé™');
                    return;
                }
                // [v3.18.0] Pass task directly to handle complex habit logic
                // [v4.2.0] Pass referenceDate (today)
                processHabitCompletion(task, task.fixedTime, new Date());
            } else {
                processNormalCompletion(task);
            }
            
            if (task.reminderDetails && task.reminderDetails.status === 'pending' && !task.reminderDetails.isRecurring) {
                task.reminderDetails.status = 'triggered'; 
            }

            if (task.autoDeleteOnCompletion) {
                tasks.splice(taskIndex, 1);
            }

            saveData();
            updateAllUI();
        }

        function processNormalCompletion(task, earnedTime = task.fixedTime, descriptionDetails = '', referenceDate = new Date()) { 
            currentBalance += earnedTime; 
            task.completionCount = (task.completionCount || 0) + 1; 
            addTransaction({ type: 'earn', taskId: task.id, taskName: task.name, amount: earnedTime, description: `å®Œæˆä»»åŠ¡: ${task.name}${descriptionDetails}`, timestamp: referenceDate.toISOString() }); 
            updateDailyChanges('earned', earnedTime, referenceDate); 
            
            // Only show notification if it's not a backdate
            if (getLocalDateString(referenceDate) === getLocalDateString(new Date())) {
                showNotification('ğŸ‰ ä»»åŠ¡å®Œæˆ', `è·å¾— ${formatTime(earnedTime)} æ—¶é—´å¥–åŠ±ï¼`, 'achievement'); 
            }
        }
        
        // [v4.2.0] New helper function to get transactions within the current habit period, relative to a referenceDate
        function getHabitPeriodInfo(task, transactionList, referenceDate = new Date()) {
            const period = task.habitDetails.period;
            const targetCount = task.habitDetails.targetCountInPeriod || 1; 
            
            // Normalize referenceDate to the start of that day
            const refDate = new Date(referenceDate);
            refDate.setHours(0, 0, 0, 0); 

            let periodStart;
            let periodEnd;

            if (period === 'daily') {
                periodStart = refDate;
                periodEnd = new Date(refDate);
                periodEnd.setDate(periodEnd.getDate() + 1);
            } else if (period === 'weekly') {
                // Week starts on Monday (1)
                const day = refDate.getDay(); // 0 (Sun) to 6 (Sat)
                const diff = day === 0 ? 6 : day - 1; // Days since Monday (0 if Mon, 6 if Sun)
                periodStart = new Date(refDate.getTime() - diff * 86400000); // Start of Monday
                periodEnd = new Date(periodStart.getTime() + 7 * 86400000); // Start of next Sunday
            } else if (period === 'monthly') {
                periodStart = new Date(refDate.getFullYear(), refDate.getMonth(), 1); // Start of the month
                periodEnd = new Date(refDate.getFullYear(), refDate.getMonth() + 1, 1); // Start of next month
            } else {
                // Fallback to daily
                periodStart = refDate;
                periodEnd = new Date(refDate);
                periodEnd.setDate(periodEnd.getDate() + 1);
            }
            
            const transactionsInPeriod = transactionList.filter(t => 
                t.taskId === task.id && 
                t.type === 'earn' &&
                new Date(t.timestamp) >= periodStart && 
                new Date(t.timestamp) < periodEnd
            );
            
            const currentCount = transactionsInPeriod.length;

            return { periodStart, periodEnd, currentCount, targetCount };
        }
        
        // [v4.2.0] Updated processHabitCompletion to accept a referenceDate
        // [v4.3.0] No longer rebuilds streak. Only checks and advances.
        function processHabitCompletion(task, baseReward, referenceDate, descriptionDetails = '') { 
            const refDateStr = getLocalDateString(referenceDate); 
            const isDaily = task.habitDetails.period === 'daily';

            // 1. Get current period count (X) and target (N) *relative to the referenceDate*
            // We pass ALL transactions so it can find the period correctly.
            const { currentCount, targetCount, periodStart, periodEnd } = getHabitPeriodInfo(task, transactions, referenceDate);
            const nextCount = currentCount + 1; // Count including this completion

            // Check if streak was already advanced in this *specific* period
            const alreadyAdvancedThisPeriod = transactions.some(t => {
                const txDate = new Date(t.timestamp);
                return t.taskId === task.id && t.isStreakAdvancement && txDate >= periodStart && txDate < periodEnd;
            });

            let finalReward = baseReward;
            let bonusDescription = '';
            let isAdvancement = false;
            let notificationTitle = 'ğŸ‘ ä¹ æƒ¯é‡å¤å®Œæˆ';
            let notificationBody = `è·å¾—åŸºç¡€å¥–åŠ± ${formatTime(baseReward)}`;

            // 2. Logic Branching
            if (nextCount < targetCount) {
                // Case 1: Not reached target yet (X < N)
                notificationTitle = 'ğŸ’ª ä¹ æƒ¯ç§¯ç´¯ä¸­';
                notificationBody = `å·²å®Œæˆ ${nextCount}/${targetCount} æ¬¡ã€‚ç»§ç»­åŠªåŠ›ï¼`;
            } else if (nextCount === targetCount && !alreadyAdvancedThisPeriod) {
                // Case 2: Just reached target (X = N) for the first time in this period
                isAdvancement = true; // Mark this transaction as the trigger

                // [v4.3.0] Check streak based on reference date, DO NOT rebuild
                checkHabitStreak(task, referenceDate);
                task.habitDetails.streak = (task.habitDetails.streak || 0) + 1; 
                task.habitDetails.isBroken = false; // [v4.0.3] Clear broken status on advancement
                
                // Calculate bonus reward based on the NEW streak
                let habitBonusReward = 0; 
                task.habitDetails.rewards.forEach(rule => { 
                    if (task.habitDetails.streak >= rule.start) {
                        habitBonusReward += (rule.type === 'fixed') ? rule.value : (rule.value * task.habitDetails.streak); 
                    }
                }); 
                
                finalReward += habitBonusReward; 
                if (habitBonusReward > 0) bonusDescription = ` (å«ä¹ æƒ¯å¥–åŠ± ${formatTime(habitBonusReward)})`; 
                
                const unitMap = { daily: 'å¤©', weekly: 'å‘¨', monthly: 'æœˆ' };
                const periodText = unitMap[task.habitDetails.period] || 'æ¬¡';
                notificationTitle = 'â­ ä¹ æƒ¯å·²è¾¾æ ‡!';
                notificationBody = `è¿ç»­${task.habitDetails.streak}${periodText}! è·å¾— ${formatTime(finalReward)} æ—¶é—´`; 
            } else {
                // Case 3: Target exceeded (X > N) or (X = N and already advanced)
                // Only basic reward, no streak update.
                notificationTitle = 'ğŸ‰ ä¹ æƒ¯è¶…é¢å®Œæˆ';
                notificationBody = `å·²å®Œæˆ ${nextCount}/${targetCount} æ¬¡ (å·²è¾¾æ ‡)ã€‚è·å¾—åŸºç¡€å¥–åŠ± ${formatTime(baseReward)}`;
            }

            // 3. Update Status and Transactions
            if (isAdvancement) {
                 // Only update the last completion date when an advancement occurs.
                task.habitDetails.lastCompletionDate = refDateStr;
            }
            task.completionCount = (task.completionCount || 0) + 1; // Always increment task total completion count
            currentBalance += finalReward; 
            updateDailyChanges('earned', finalReward, referenceDate);
            
            const isBackdate = descriptionDetails.includes('è¡¥è®°');
            addTransaction({ 
                type: 'earn', 
                taskId: task.id, 
                taskName: task.name, 
                amount: finalReward, 
                description: `${isBackdate ? '' : 'å®Œæˆä¹ æƒ¯: '}${task.name}${descriptionDetails}${bonusDescription}`, 
                isStreakAdvancement: isAdvancement,
                timestamp: referenceDate.toISOString(), // [v4.2.0] Use the reference date
                isBackdate: isBackdate
            }); 
            
            // Only show notification if it's not a backdate
            if (getLocalDateString(referenceDate) === getLocalDateString(new Date())) {
                showNotification(notificationTitle, notificationBody, 'achievement');
            }
        }

        // [v4.2.0] checkHabitStreak now also sets isBroken status AND accepts a referenceDate
        function checkHabitStreak(task, referenceDate = new Date()) { 
            const { lastCompletionDate, period } = task.habitDetails; 
            if (!lastCompletionDate) { 
                task.habitDetails.streak = 0; 
                task.habitDetails.isBroken = false; // [v4.0.3]
                return; 
            } 
            
            const refDate = new Date(referenceDate); 
            refDate.setHours(0, 0, 0, 0); 
            const lastDate = new Date(lastCompletionDate); 
            lastDate.setHours(0, 0, 0, 0); 
            
            // If the last completion was on or after the reference date, no need to check
            if (lastDate >= refDate) {
                task.habitDetails.isBroken = false;
                return;
            }
            
            let isBroken = false; 
            const diffDays = (refDate - lastDate) / 86400000; 

            // 1. Check if the gap is too large
            if (period === 'daily' && diffDays > 1) {
                isBroken = true;
            } else if (period === 'weekly') {
                // Check if lastDate was in the *previous* week relative to refDate
                const refDay = refDate.getDay() === 0 ? 7 : refDate.getDay(); 
                const startOfThisWeek = new Date(refDate.getTime() - (refDay - 1) * 86400000); 
                const startOfLastWeek = new Date(startOfThisWeek.getTime() - 7 * 86400000);
                
                // If the last completion was before the start of last week
                if (lastDate < startOfLastWeek) {
                    isBroken = true;
                }
            } else if (period === 'monthly') { 
                const refMonth = refDate.getFullYear() * 12 + refDate.getMonth();
                const lastMonth = lastDate.getFullYear() * 12 + lastDate.getMonth();
                
                // If the gap is more than one month
                if (refMonth > lastMonth + 1) {
                    isBroken = true;
                }
            }
            
            if (isBroken) { 
                task.habitDetails.streak = 0; 
                task.habitDetails.isBroken = true; // [v4.0.3] Set broken status
                
                // Only show notification if this check is happening "today"
                if (getLocalDateString(referenceDate) === getLocalDateString(new Date())) {
                    showNotification('â— ä¹ æƒ¯ä¸­æ–­', `"${task.name}" è¿ç»­çºªå½•å·²ä¸­æ–­`, 'achievement'); 
                }
            } else {
                task.habitDetails.isBroken = false; // [v4.0.3] Ensure not broken
            }
        }

        function startTask(event, taskId) { const task = tasks.find(t => t.id === taskId); if (!task) return; if (event && event.target.closest('.recent-tasks-grid') === null) { task.lastUsed = Date.now(); } runningTasks.set(taskId, { startTime: Date.now(), elapsedTime: 0, isPaused: false, achieved: false }); saveData(); updateAllUI(); showNotification(â–¶ï¸ ä»»åŠ¡å¼€å§‹', `å¼€å§‹æ‰§è¡Œä»»åŠ¡: ${task.name}`, 'achievement'); }
        function pauseTask(taskId) { const r = runningTasks.get(taskId); if (!r || r.isPaused) return; r.elapsedTime += Date.now() - r.startTime; r.isPaused = true; saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function resumeTask(taskId) { const r = runningTasks.get(taskId); if (!r || !r.isPaused) return; r.startTime = Date.now(); r.isPaused = false; saveData(); updateRecentTasks(); updateCategoryTasks(); }
        function cancelTask(taskId) { runningTasks.delete(taskId); saveData(); updateRecentTasks(); updateCategoryTasks(); }
        
        function stopTask(taskId) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            const runningTask = runningTasks.get(taskId);
            if (taskIndex === -1 || !runningTask) return;
            const task = tasks[taskIndex];

            const totalSeconds = Math.floor((runningTask.elapsedTime + (runningTask.isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
            runningTasks.delete(taskId);
            task.lastUsed = Date.now();
            
            if (totalSeconds > 0) {
                if (['continuous', 'continuous_target'].includes(task.type)) {
                    let baseEarnedTime = Math.floor(totalSeconds * task.multiplier);
                    let earnedTimeDescription = ` (${formatTime(totalSeconds)} Ã— ${task.multiplier})`;
                    const targetMet = task.type === 'continuous_target' && (runningTask.achieved || totalSeconds >= task.targetTime);
                    
                    if (targetMet) {
                        baseEarnedTime += task.bonusReward;
                        if (task.bonusReward > 0) earnedTimeDescription += ` + ${formatTime(task.bonusReward)} è¾¾æ ‡å¥–åŠ±`;
                    }
                    
                    if (task.isHabit) {
                        const todayStr = getLocalDateString(new Date());
                        const completionsToday = transactions.filter(t => t.taskId === taskId && getLocalDateString(t.timestamp) === todayStr).length;
                        if (completionsToday >= (task.habitDetails.dailyLimit || 1)) {
                            alert('å·²è¾¾åˆ°æ­¤ä¹ æƒ¯çš„æ¯æ—¥å®Œæˆä¸Šé™');
                        } else {
                            // [v3.18.0] Base reward is the earned time.
                            // [v4.2.0] Pass referenceDate (today)
                            processHabitCompletion(task, baseEarnedTime, new Date(), earnedTimeDescription);
                        }
                    } else {
                        processNormalCompletion(task, baseEarnedTime, earnedTimeDescription, new Date());
                    }
                } else if (task.type === 'continuous_redeem') {
                    const isPenalty = currentBalance < 0;
                    const baseSpentTime = Math.floor(totalSeconds * task.multiplier);
                    const finalSpentTime = isPenalty ? Math.floor(baseSpentTime * 1.2) : baseSpentTime;
                    let description = `è¿ç»­æ¶ˆè´¹: ${task.name} (${formatTime(totalSeconds)} Ã— ${task.multiplier})`;
                    if (isPenalty) description += ` (ä½™é¢ä¸è¶³, 1.2å€æ¶ˆè€—)`;
                    currentBalance -= finalSpentTime;
                    task.completionCount = (task.completionCount || 0) + 1;
                    addTransaction({ type: 'spend', taskId: task.id, taskName: task.name, amount: finalSpentTime, description: description });
                    updateDailyChanges('spent', finalSpentTime);
                    showNotification('ğŸ’¸ ä»»åŠ¡æ¶ˆè´¹', `æ¶ˆè´¹ ${formatTime(finalSpentTime)} æ—¶é—´`, 'achievement');
                }
            }
            
            if (task.reminderDetails && task.reminderDetails.status === 'pending' && !task.reminderDetails.isRecurring) {
                task.reminderDetails.status = 'triggered'; 
            }
            
            if (task.autoDeleteOnCompletion) {
                tasks.splice(taskIndex, 1);
            }
            
            saveData();
            updateAllUI();
        }
        
        function redeemTask(taskId) { 
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            const task = tasks[taskIndex];

            const isPenalty = currentBalance < 0;
            const baseCost = task.consumeTime;
            const finalCost = isPenalty ? Math.floor(baseCost * 1.2) : baseCost;
            let description = `å…‘æ¢é¡¹ç›®: ${task.name}`;
            
            const confirmMessage = `ç¡®å®šè¦æ¶ˆè´¹ ${formatTime(finalCost)}${isPenalty ? ' (å«1.2å€æƒ©ç½š)' : ''} å…‘æ¢"${task.name}"å—ï¼Ÿ${isPenalty ? '\n(å½“å‰ä½™é¢ä¸ºè´Ÿ)' : ''}`;
            
            if (!confirm(confirmMessage)) return; 
            
            if (isPenalty) description += ` (ä½™é¢ä¸è¶³, 1.2å€æ¶ˆè€—)`;

            currentBalance -= finalCost; 
            task.completionCount = (task.completionCount || 0) + 1; 
            task.lastUsed = Date.now(); 
            addTransaction({ type: 'spend', taskId: task.id, taskName: task.name, amount: finalCost, description: description }); 
            updateDailyChanges('spent', finalCost); 
            
            if (task.reminderDetails && task.reminderDetails.status === 'pending' && !task.reminderDetails.isRecurring) {
                task.reminderDetails.status = 'triggered'; 
            }
            
            if (task.autoDeleteOnCompletion) {
                tasks.splice(taskIndex, 1);
            }
            
            saveData(); 
            updateAllUI(); 
            showNotification('ğŸ å…‘æ¢æˆåŠŸ', `æˆåŠŸå…‘æ¢: ${task.name}`, 'achievement'); 
        }
        
        // --- History Modal and Undo ---
        function showTaskHistory(taskId) { 
            const task = tasks.find(t => t.id === taskId); 
            if (!task) return; 
            currentHistoryTask = task; 
            document.getElementById('historyModalTitle').textContent = `${task.name} - å†å²è®°å½•`; 
            const taskTransactions = transactions.filter(t => t.taskId === taskId).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 
            const historyContent = document.getElementById('historyContent'); 
            if (taskTransactions.length === 0) {
                historyContent.innerHTML = '<div class="empty-message">æš‚æ— å†å²è®°å½•</div>'; 
            } else { 
                historyContent.innerHTML = taskTransactions.map(transaction => { 
                    const isPositive = transaction.type === 'earn'; 
                    const backdateMarker = transaction.isBackdate ? 'ğŸ—“ï¸ ' : ''; 
                    const streakMarker = transaction.isStreakAdvancement ? 'â­ ' : ''; // [v3.18.0] Added streak marker
                    return `<div class="history-item" id="history-item-${transaction.id}">
                                <div class="history-info">
                                    <div class="history-description">${backdateMarker}${streakMarker}${transaction.description}</div>
                                    <div class="history-time">${formatDateTime(transaction.timestamp)}</div>
                                </div>
                                <div class="history-amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : '-'}${formatTime(transaction.amount)}</div>
                                <button class="undo-btn" onclick="undoTransaction('${transaction.id}')" title="æ’¤å›æ­¤æ¡è®°å½•">æ’¤å›</button>
                            </div>`; 
                }).join(''); 
            } 
            document.getElementById('historyModal').classList.add('show'); 
        }
// [v4.3.0] Modified undoTransaction to call rebuildHabitStreak
function undoTransaction(transactionId) { 
    const transactionIndex = transactions.findIndex(t => t.id === transactionId); 
    if (transactionIndex === -1) return; 
    const transaction = transactions[transactionIndex]; 
    if (!confirm(`ç¡®å®šè¦æ’¤å›è¿™æ¡è®°å½•å—ï¼Ÿ\n\næè¿°: ${transaction.description}\né‡‘é¢: ${transaction.type === 'earn' ? '+' : '-'}${formatTime(transaction.amount)}\n\næ­¤æ“ä½œå°†å½±å“æ€»ä½™é¢ã€æ¯æ—¥ç»Ÿè®¡å’Œä»»åŠ¡å®Œæˆæ¬¡æ•°ï¼Œä¸”æ— æ³•æ¢å¤ã€‚`)) return; 
    
    if (transaction.type === 'earn') { 
        currentBalance -= transaction.amount; 
        updateDailyChanges('earned', -transaction.amount, new Date(transaction.timestamp)); 
    } else { 
        currentBalance += transaction.amount; 
        updateDailyChanges('spent', -transaction.amount, new Date(transaction.timestamp)); 
    } 
    
    const task = tasks.find(t => t.id === transaction.taskId); 
    if (task) { 
        if (task.completionCount > 0) task.completionCount--; 
        
        // [v4.3.0] Remove complex logic. Just remove the transaction.
    } 
    
    transactions.splice(transactionIndex, 1); 
    
    // [v4.3.0] If it was a habit, trigger a full rebuild
    if (task && task.isHabit && task.type === 'reward') {
        rebuildHabitStreak(task);
        // We call save/update *after* the rebuild
    }
    
    saveData(); 
    updateAllUI(); 
    
    const historyItemElement = document.getElementById(`history-item-${transactionId}`); 
    if (historyItemElement) { 
        historyItemElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease'; 
        historyItemElement.style.opacity = '0'; 
        historyItemElement.style.transform = 'translateX(20px)'; 
        setTimeout(() => { 
            historyItemElement.remove(); 
            if (!document.getElementById('historyContent').querySelector('.history-item')) document.getElementById('historyContent').innerHTML = '<div class="empty-message">æš‚æ— å†å²è®°å½•</div>'; 
        }, 300); 
    } 
    showNotification('â†©ï¸ æ“ä½œå·²æ’¤å›', `æˆåŠŸæ’¤å›è®°å½•: ${transaction.taskName}`, 'achievement'); 
}
        function hideHistoryModal() { document.getElementById('historyModal').classList.remove('show'); currentHistoryTask = null; }
        
        // --- Backdate Modal ---
        // [v4.2.0] Updated showBackdateModal to support 'count' mode
        function showBackdateModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            currentBackdateTaskId = taskId;
            document.getElementById('backdateTaskName').textContent = task.name;
            document.getElementById('backdateTaskId').value = taskId;
            
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('backdateDate').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('backdateDate').max = `${yyyy}-${mm}-${dd}`;
            
            // Reset forms
            document.getElementById('backdateHours').value = '';
            document.getElementById('backdateMinutes').value = '';
            document.getElementById('backdateCount').value = '1';
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${hours}:${minutes}`;
            document.getElementById('backdateStartTime').value = currentTime;
            document.getElementById('backdateEndTime').value = currentTime;
            
            clearFormErrors();
            
            // [v4.2.0] Auto-select mode based on task type
            const isDurationTask = ['continuous', 'continuous_target', 'continuous_redeem'].includes(task.type);
            
            document.getElementById('backdateModeSwitchContainer').classList.toggle('hidden', !isDurationTask);
            document.getElementById('backdateDurationMode').classList.toggle('hidden', isDurationTask);
            document.getElementById('backdateRangeMode').classList.toggle('hidden', isDurationTask);
            document.getElementById('backdateCountMode').classList.toggle('hidden', isDurationTask);

            if (isDurationTask) {
                switchBackdateMode('duration');
            } else {
                // It's 'reward' or 'instant_redeem', force 'count' mode
                currentBackdateMode = 'count';
                document.getElementById('backdateDurationMode').classList.add('hidden');
                document.getElementById('backdateRangeMode').classList.add('hidden');
                document.getElementById('backdateCountMode').classList.remove('hidden');
            }
            
            document.getElementById('backdateModal').classList.add('show');
        }

        function hideBackdateModal() { document.getElementById('backdateModal').classList.remove('show'); currentBackdateTaskId = null; }
        
        // [v4.2.0] switchBackdateMode now only handles duration/range
        function switchBackdateMode(mode) {
            currentBackdateMode = mode;
            document.getElementById('backdateDurationMode').classList.toggle('hidden', mode !== 'duration');
            document.getElementById('backdateRangeMode').classList.toggle('hidden', mode === 'duration');
            document.querySelectorAll('#backdateModal .mode-switch button').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
            clearFormErrors();
        }
        
        // [v4.3.0] Reworked saveBackdate to NOT call processHabitCompletion, calls rebuildHabitStreak instead
        async function saveBackdate(event) {
            event.preventDefault(); clearFormErrors();
            const taskId = document.getElementById('backdateTaskId').value;
            const task = tasks.find(t => t.id === taskId);
            if (!task) { alert('å‘ç”Ÿé”™è¯¯ï¼šæ‰¾ä¸åˆ°ä»»åŠ¡'); return; }
            
            const dateStr = document.getElementById('backdateDate').value;
            if (!dateStr) { alert('è¯·é€‰æ‹©è¡¥è®°æ—¥æœŸ'); return; }

            // Set the timestamp to noon on the selected date to avoid timezone issues
            const [year, month, day] = dateStr.split('-').map(Number);
            const backdateTimestamp = new Date(year, month - 1, day, 12, 0, 0); 

            let hasError = false;
            let totalSeconds = 0;
            let completionCount = 0;
            
            if (currentBackdateMode === 'count') {
                completionCount = parseInt(document.getElementById('backdateCount').value);
                if (isNaN(completionCount) || completionCount < 1) {
                    showFieldError('backdateCount', 'è¡¥è®°æ¬¡æ•°å¿…é¡»å¤§äº0'); hasError = true;
                }
            } else if (currentBackdateMode === 'duration') {
                const hours = parseInt(document.getElementById('backdateHours').value || '0');
                const minutes = parseInt(document.getElementById('backdateMinutes').value || '0');
                if (isNaN(hours) || hours < 0 || isNaN(minutes) || minutes < 0 || minutes > 59) {
                    showFieldError('backdateDuration', 'è¯·è¾“å…¥æœ‰æ•ˆçš„å°æ—¶å’Œåˆ†é’Ÿ'); hasError = true;
                } else {
                    totalSeconds = (hours * 3600) + (minutes * 60);
                    if (totalSeconds <= 0) { showFieldError('backdateDuration', 'æ€»æ—¶é•¿å¿…é¡»å¤§äº0'); hasError = true; }
                }
                completionCount = 1; // Duration tasks are always 1 completion
            } else { // range mode
                const startTimeStr = document.getElementById('backdateStartTime').value;
                const endTimeStr = document.getElementById('backdateEndTime').value;
                if (!startTimeStr || !endTimeStr) {
                    if (!startTimeStr) showFieldError('backdateStartTime', 'è¯·è¾“å…¥å¼€å§‹æ—¶é—´');
                    if (!endTimeStr) showFieldError('backdateEndTime', 'è¯·è¾“å…¥ç»“æŸæ—¶é—´');
                    hasError = true;
                } else {
                    const startDateTime = new Date(`${dateStr}T${startTimeStr}`);
                    const endDateTime = new Date(`${dateStr}T${endTimeStr}`);
                    if (endDateTime <= startDateTime) { showFieldError('backdateEndTime', 'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´'); hasError = true; } 
                    else { totalSeconds = (endDateTime - startDateTime) / 1000; }
                }
                completionCount = 1; // Range tasks are always 1 completion
            }
            
            if (hasError) return;
            
            let totalAmountEarned = 0;
            let totalAmountSpent = 0;
            let didHabitBackdate = false;
            
            // --- Start processing loop ---
            for (let i = 0; i < completionCount; i++) {
                let amount = 0;
                let transactionType = '';
                let description = `è¡¥è®°: ${task.name}`;

                // --- Handle Habit Daily Limit Check ---
                if (task.isHabit) {
                    const dailyLimit = task.habitDetails.dailyLimit || 1;
                    // Get completions *on that day*, including ones we just added in this loop
                    const completionsOnBackdate = transactions.filter(t => 
                        t.taskId === taskId && 
                        t.type === 'earn' && 
                        getLocalDateString(t.timestamp) === dateStr
                    ).length;
                    
                    if (completionsOnBackdate >= dailyLimit) {
                        alert(`è¡¥è®°å¤±è´¥ï¼šä»»åŠ¡ "${task.name}" åœ¨ ${dateStr} çš„æ¯æ—¥ä¸Šé™ä¸º ${dailyLimit} æ¬¡ï¼Œæ— æ³•ç»§ç»­æ·»åŠ ã€‚`);
                        hasError = true;
                        break; // Stop the loop
                    }
                }

                // --- Calculate Amount and Type ---
                if (task.type === 'reward') {
                    transactionType = 'earn';
                    amount = task.fixedTime;
                    
                    if (task.isHabit) {
                        // [v4.3.0] This is the core logic change.
                        // We DO NOT call processHabitCompletion.
                        // We just add a simple transaction. The rebuild will handle the streak.
                        didHabitBackdate = true;
                        description += ' (è¡¥è®°)';
                    }
                    
                } else if (task.type === 'instant_redeem') {
                    transactionType = 'spend';
                    amount = task.consumeTime;
                    const netChangeSinceThen = transactions
                        .filter(t => new Date(t.timestamp) > backdateTimestamp)
                        .reduce((sum, t) => sum + (t.type === 'earn' ? t.amount : -t.amount), 0);
                    const historicalBalance = currentBalance - netChangeSinceThen;
                    const isPenalty = historicalBalance < 0;
                    
                    if (isPenalty) {
                        amount = Math.floor(amount * 1.2);
                        description += ` (å†å²ä½™é¢ä¸è¶³, 1.2å€æ¶ˆè€—)`;
                    }

                } else if (['continuous', 'continuous_target'].includes(task.type)) {
                    transactionType = 'earn';
                    amount = Math.floor(totalSeconds * task.multiplier);
                    description += ` (${formatTime(totalSeconds)} Ã— ${task.multiplier})`;
                    if (task.type === 'continuous_target' && totalSeconds >= task.targetTime && task.bonusReward > 0) {
                        amount += task.bonusReward;
                         description += ` + ${formatTime(task.bonusReward)} è¾¾æ ‡å¥–åŠ±`;
                    }

                } else if (task.type === 'continuous_redeem') {
                    transactionType = 'spend';
                    const netChangeSinceThen = transactions
                        .filter(t => new Date(t.timestamp) > backdateTimestamp)
                        .reduce((sum, t) => sum + (t.type === 'earn' ? t.amount : -t.amount), 0);
                    const historicalBalance = currentBalance - netChangeSinceThen;
                    const isPenalty = historicalBalance < 0;

                    amount = Math.floor(totalSeconds * task.multiplier);
                    if (isPenalty) {
                        amount = Math.floor(amount * 1.2);
                        description += ` (${formatTime(totalSeconds)} Ã— ${task.multiplier}) (å†å²ä½™é¢ä¸è¶³, 1.2å€æ¶ˆè€—)`;
                    } else {
                        description += ` (${formatTime(totalSeconds)} Ã— ${task.multiplier})`;
                    }
                }
                
                if (amount <= 0 && !didHabitBackdate) { 
                    alert('è®¡ç®—å‡ºçš„æ—¶é—´é‡ä¸º0ï¼Œæ— æ³•è¡¥è®°'); hasError = true; break; 
                }
                
                // --- Add Transaction (for non-habit reward tasks) ---
                addTransaction({ 
                    type: transactionType, 
                    taskId: task.id, 
                    taskName: task.name, 
                    amount: amount, 
                    description: description, 
                    timestamp: backdateTimestamp.toISOString(),
                    isBackdate: true,
                    isStreakAdvancement: false // [v4.3.0] ALWAYS false, rebuild will set it
                });
                
                if (transactionType === 'earn') { currentBalance += amount; totalAmountEarned += amount; updateDailyChanges('earned', amount, backdateTimestamp); } 
                else { currentBalance -= amount; totalAmountSpent += amount; updateDailyChanges('spent', amount, backdateTimestamp); }
                task.completionCount = (task.completionCount || 0) + 1;
            }
            // --- End processing loop ---

            // [v4.3.0] Trigger rebuild AFTER all transactions are added
            if (didHabitBackdate) {
                rebuildHabitStreak(task);
            }

            if (hasError) {
                // If we hit an error (like daily limit), we still save changes made up to that point
                saveData(); updateAllUI();
                return;
            }
            
            saveData(); updateAllUI(); hideBackdateModal();
            let notifyMsg = `æˆåŠŸä¸º ${dateStr} 
                            è¡¥è®° ${task.name}`;
            if (completionCount > 1) notifyMsg += ` ${completionCount} æ¬¡`;
            if (totalAmountEarned > 0) notifyMsg += ` (è·å¾— ${formatTime(totalAmountEarned)})`;
            if (totalAmountSpent > 0) notifyMsg += ` (æ¶ˆè´¹ ${formatTime(totalAmountSpent)})`;
            showNotification('ğŸ—“ï¸ è¡¥è®°æˆåŠŸ', notifyMsg, 'achievement');
        }

// [v4.3.0] New Function: Rebuilds habit streak from scratch based on transaction history
// [v4.3.1] Fix: Corrected date parsing to be timezone-safe
function rebuildHabitStreak(task) {
    if (!task || !task.isHabit) return;

    console.log(`Rebuilding streak for: ${task.name}`);

    // 1. Get all relevant transactions, sorted oldest-to-newest
    const taskTransactions = transactions
        .filter(t => t.taskId === task.id && t.type === 'earn')
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    // 2. Reset all streak advancement markers for this task
    transactions.forEach(t => {
        if (t.taskId === task.id) {
            t.isStreakAdvancement = false;
        }
    });

    // 3. Iterate and rebuild
    let newStreak = 0;
    let lastAdvancementDateStr = null; // The date (YYYY-MM-DD) of the last period that advanced the streak
    let lastAdvancementTransactionId = null;

    const { period, targetCountInPeriod } = task.habitDetails;
    const targetCount = targetCountInPeriod || 1;

    // Group transactions by their period
    const periods = new Map(); // Key: periodStartDateStr, Value: { count: number, lastTx: transaction }
    
    for (const tx of taskTransactions) {
        const txDate = new Date(tx.timestamp);
        
        // [v4.3.0] Get the *start* date of the period this tx belongs to
        let periodStartDate;
        if (period === 'daily') {
            periodStartDate = new Date(txDate.getFullYear(), txDate.getMonth(), txDate.getDate());
        } else if (period === 'weekly') {
            const day = txDate.getDay(); // 0 (Sun) to 6 (Sat)
            const diff = day === 0 ? 6 : day - 1; // Days since Monday (0 if Mon, 6 if Sun)
            periodStartDate = new Date(txDate.getTime() - diff * 86400000);
            periodStartDate.setHours(0, 0, 0, 0);
        } else { // monthly
            periodStartDate = new Date(txDate.getFullYear(), txDate.getMonth(), 1);
        }
        
        const periodKey = getLocalDateString(periodStartDate);
        
        if (!periods.has(periodKey)) {
            periods.set(periodKey, { count: 0, firstTxDate: txDate, advancementTx: null });
        }
        
        const periodData = periods.get(periodKey);
        periodData.count++;
        
        // If this transaction is the one that meets the target, mark it
        if (periodData.count === targetCount) {
            periodData.advancementTx = tx;
        }
    }

    // Now iterate through the periods *in order*
    const sortedPeriodKeys = Array.from(periods.keys()).sort();

    for (const periodKey of sortedPeriodKeys) {
        const periodData = periods.get(periodKey);
        
        // Check if this period met the target
        if (periodData.count >= targetCount) {
            const currentPeriodDate = new Date(periodData.firstTxDate);
            currentPeriodDate.setHours(0, 0, 0, 0);

            if (lastAdvancementDateStr) {
                // Check if this period is consecutive
                // [v4.3.1] Fix: Use timezone-safe date constructor
                const [y, m, d] = lastAdvancementDateStr.split('-').map(Number);
                const lastDate = new Date(y, m - 1, d); // Creates local midnight
                
                const diffDays = (currentPeriodDate - lastDate) / 86400000;
                let isConsecutive = false;

                if (period === 'daily') {
                    isConsecutive = (diffDays === 1);
                } else if (period === 'weekly') {
                    isConsecutive = (diffDays === 7);
                } else if (period === 'monthly') {
                    const lastMonth = lastDate.getFullYear() * 12 + lastDate.getMonth();
                    const currentMonth = currentPeriodDate.getFullYear() * 12 + currentPeriodDate.getMonth();
                    isConsecutive = (currentMonth === lastMonth + 1);
                }
                
                if (isConsecutive) {
                    newStreak++;
                } else {
                    newStreak = 1; // Streak broken, reset to 1
                }
            } else {
                newStreak = 1; // First ever advancement
            }
            
            lastAdvancementDateStr = getLocalDateString(currentPeriodDate);
            
            // Mark the transaction that caused the advancement
            if (periodData.advancementTx) {
                periodData.advancementTx.isStreakAdvancement = true;
                lastAdvancementTransactionId = periodData.advancementTx.id;
            }
        }
    }
    
    // 4. Apply new state
    task.habitDetails.streak = newStreak;
    
    // Find the actual timestamp of the last advancement
    if (lastAdvancementTransactionId) {
        const lastTx = transactions.find(t => t.id === lastAdvancementTransactionId);
        if (lastTx) {
            task.habitDetails.lastCompletionDate = getLocalDateString(lastTx.timestamp);
        } else {
            task.habitDetails.lastCompletionDate = null; // Should not happen
        }
    } else {
        task.habitDetails.lastCompletionDate = null;
    }

    // 5. Set UI status
    // Check streak against "today" to set isBroken flag for UI
    checkHabitStreak(task, new Date());
    console.log(`Rebuild complete. New streak: ${newStreak}, Last advancement: ${task.habitDetails.lastCompletionDate}`);
}
// --- Data Handling ---
        function addTransaction(transaction) { 
            transaction.timestamp = transaction.timestamp || new Date().toISOString(); 
            transaction.id = Date.now().toString() + Math.random().toString(36).substr(2, 9); 
            // [v3.18.0] isStreakAdvancement is optional
            transaction.isStreakAdvancement = transaction.isStreakAdvancement || false;
            transactions.unshift(transaction); 
            if (transactions.length > 1000) transactions.pop(); 
            // [v4.2.0] Re-sort transactions after adding, vital for backdating
            transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 
        }
        function updateDailyChanges(type, amount, date = new Date()) { const dateString = date.toDateString(); if (!dailyChanges[dateString]) dailyChanges[dateString] = { earned: 0, spent: 0 }; dailyChanges[dateString][type] += amount; }
        
        // --- Reports Tab ---
        function setupReportEventListeners() { 
            document.getElementById('flowChartFilters').addEventListener('click', e => { 
                if (e.target.tagName === 'BUTTON') { 
                    reportState.flowChartPeriod = e.target.dataset.period; 
                    document.querySelectorAll('#flowChartFilters button').forEach(btn => btn.classList.remove('active')); 
                    e.target.classList.add('active'); 
                    updateFlowChart(); 
                } 
            }); 
            document.getElementById('heatmapPrevMonth').addEventListener('click', () => navigateHeatmap(-1)); 
            document.getElementById('heatmapNextMonth').addEventListener('click', () => navigateHeatmap(1)); 
        }
        function updateAllReports() { 
            document.querySelectorAll('#flowChartFilters button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === reportState.flowChartPeriod);
            });
            updateFlowChart(); 
            updateActivityHeatmap(); 
            updateAnalysisDashboard(); 
            updateDetailedDataTable(); 
            updateTrendChart(); 
        }
        function getFilteredTransactions(period, sortBy = 'desc') { 
            let filtered = transactions.filter(t => !t.undone);
            if (period !== 'all') {
                const now = new Date(); 
                let startDate; 
                if (period === '7d') startDate = new Date(new Date().setDate(now.getDate() - 7)); 
                else if (period === '30d') startDate = new Date(new Date().setDate(now.getDate() - 30)); 
                filtered = filtered.filter(t => new Date(t.timestamp) >= startDate);
            }
            filtered.sort((a, b) => (sortBy === 'asc' ? new Date(a.timestamp) - new Date(b.timestamp) : new Date(b.timestamp) - new Date(a.timestamp)));
            return filtered; 
        }
        
        function updateFlowChart() {
            const container = document.getElementById('flowChartContainer');
            const filtered = getFilteredTransactions(reportState.flowChartPeriod, 'asc');
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-message" style="color:var(--text-color-light)">æ­¤æœŸé—´æ— æ•°æ®</div>'; return; }
            const processBlocks = (type) => { const blocks = []; let currentBlock = null; let totalDuration = 0; filtered.forEach(t => { const transactionType = t.type || (t.amount > 0 ? 'earn' : 'spend'); if (transactionType !== type) return; const task = tasks.find(tsk => tsk.id === t.taskId); const category = task ? task.category : 'æœªçŸ¥'; const amount = Math.abs(t.amount); totalDuration += amount; if (currentBlock && currentBlock.category === category) { currentBlock.duration += amount; } else { if (currentBlock) { blocks.push(currentBlock); } currentBlock = { category: category, duration: amount }; } }); if (currentBlock) { blocks.push(currentBlock); } return { blocks, totalDuration }; };
            const { blocks: earnBlocks, totalDuration: totalEarnDuration } = processBlocks('earn');
            const { blocks: spendBlocks, totalDuration: totalSpendDuration } = processBlocks('spend');
            const renderBar = (title, blocks, totalDuration) => { if (totalDuration === 0) return ''; const segmentsHTML = blocks.map(block => { const percent = (block.duration / totalDuration) * 100; const color = categoryColors.get(block.category) || '#888'; const tooltipText = `${block.category}: ${formatTime(block.duration)}`; const minWidthStyle = percent < 0.5 ? 'min-width: 2px;' : ''; return `<div class="flow-bar-segment" style="width: ${percent}%; background-color: ${color}; ${minWidthStyle}"><span class="tooltip">${tooltipText}</span></div>`; }).join(''); return `<div class="flow-bar-block"><div class="flow-bar-header"><div class="flow-bar-title">${title}</div><div class="flow-bar-total">æ€»è®¡: ${formatTime(totalDuration)}</div></div><div class="flow-bar">${segmentsHTML}</div></div>`; };
            container.innerHTML = renderBar('è·å¾—æ—¶é—´æµåŠ¨', earnBlocks, totalEarnDuration) + renderBar('æ¶ˆè´¹æ—¶é—´æµåŠ¨', spendBlocks, totalSpendDuration);
            if (container.innerHTML === '') { container.innerHTML = '<div class="empty-message" style="color:var(--text-color-light)">æ­¤æœŸé—´æ— æ•°æ®</div>'; }
        }

        function navigateHeatmap(offset) { reportState.heatmapDate.setMonth(reportState.heatmapDate.getMonth() + offset); updateActivityHeatmap(); }
        function updateActivityHeatmap() { const container = document.getElementById('heatmapGrid'); const legendContainer = document.getElementById('heatmapLegend'); const label = document.getElementById('heatmapMonthLabel'); const dailyData = new Map(); transactions.filter(t => !t.undone).forEach(t => { const localDateStr = getLocalDateString(t.timestamp); if (!dailyData.has(localDateStr)) { dailyData.set(localDateStr, { earned: 0, spent: 0 }); } if (t.type) { const typeKey = t.type === 'earn' ? 'earned' : 'spent'; dailyData.get(localDateStr)[typeKey] += t.amount; } else { if (t.amount > 0) dailyData.get(localDateStr).earned += t.amount; else dailyData.get(localDateStr).spent += Math.abs(t.amount); } }); const year = reportState.heatmapDate.getFullYear(); const month = reportState.heatmapDate.getMonth(); label.textContent = `${year}å¹´ ${month + 1}æœˆ`; const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); let html = ''; for(let i = 0; i < firstDayOfMonth; i++) { html += `<div class="heatmap-spacer"></div>`; } for (let day = 1; day <= daysInMonth; day++) { const currentDate = new Date(year, month, day); const localDateStr = getLocalDateString(currentDate); const data = dailyData.get(localDateStr); let colorClass = ''; if (data) { const net = data.earned - data.spent; colorClass = getHeatmapColorClass(net); } html += `<div class="heatmap-day" onclick="showDayDetails('${localDateStr}')"><div class="heatmap-day-content ${colorClass}">${day}</div></div>`; } container.innerHTML = html; const nextMonth = new Date(year, month + 1, 1); document.getElementById('heatmapNextMonth').disabled = nextMonth > new Date(); legendContainer.innerHTML = `å‡å°‘ <div class="legend-item"><div class="legend-box" style="background-color: #ffcdd2;"></div><div class="legend-box" style="background-color: #e57373;"></div><div class="legend-box" style="background-color: #f44336;"></div></div> | <div class="legend-item"><div class="legend-box" style="background-color: #9be9a8;"></div><div class="legend-box" style="background-color: #40c463;"></div><div class="legend-box" style="background-color: #216e39;"></div></div> å¢åŠ `; }
        
        function showDayDetails(localDateStr) { 
            const modal = document.getElementById('dayDetailModal'); 
            const title = document.getElementById('dayDetailModalTitle'); 
            const content = document.getElementById('dayDetailContent'); 
            
            // [v4.4.0] Fix: Handle potential null from getLocalDateString if date is invalid
            if (!localDateStr) {
                const todayStr = getLocalDateString(new Date());
                localDateStr = todayStr;
            }
            
            title.textContent = `${localDateStr} è¯¦æƒ…`; 
            const dayTransactions = transactions.filter(t => !t.undone && getLocalDateString(t.timestamp) === localDateStr).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 
            if (dayTransactions.length === 0) { 
                content.innerHTML = '<div class="empty-message">æœ¬æ—¥æ— æ´»åŠ¨è®°å½•</div>'; 
                modal.classList.add('show'); 
                return; 
            } 
            const dailyEarned = dayTransactions.reduce((sum, t) => sum + (t.type === 'earn' ? t.amount : (!t.type && t.amount > 0 ? t.amount : 0)), 0); 
            const dailySpent = dayTransactions.reduce((sum, t) => sum + (t.type === 'spend' ? t.amount : (!t.type && t.amount < 0 ? Math.abs(t.amount) : 0)), 0); 
            const dailyNet = dailyEarned - dailySpent; 
            const netClass = dailyNet > 0 ? 'positive' : (dailyNet < 0 ? 'negative' : ''); 
            const netSign = dailyNet > 0 ? '+' : (dailyNet < 0 ? '' : ''); 
            let summaryHtml = `<div class="day-detail-summary">
                                <div class="day-detail-net ${netClass}">å‡€å€¼: ${netSign}${formatTime(dailyNet)}</div>
                                <div class="day-detail-stats">
                                    <span>è·å¾—: <span class="positive">${formatTime(dailyEarned)}</span></span> | 
                                    <span>æ¶ˆè´¹: <span class="negative">${formatTime(dailySpent)}</span></span>
                                </div>
                            </div>`; 
            let listHtml = dayTransactions.map(transaction => { 
                const isPositive = transaction.type === 'earn' || (!transaction.type && transaction.amount > 0); 
                const amount = Math.abs(transaction.amount); 
                let descLine1 = transaction.description; 
                let descLine2 = ''; 
                const patterns = [/^([^:]+):\s*"?([^"(]+)"?(?:\s*\((.*)\))?$/, /^([^:]+):\s*(.*)$/]; 
                for (const pattern of patterns) { 
                    const descMatch = transaction.description.match(pattern); 
                    if (descMatch) { 
                        if (descMatch.length === 4 && descMatch[2]) { 
                            descLine1 = descMatch[2].trim(); 
                            descLine2 = descMatch[3] ? descMatch[3].trim() : ''; 
                        } else if (descMatch.length === 3) { 
                            descLine1 = descMatch[2].trim(); 
                        } 
                        break; 
                    } 
                } 
                const backdateMarker = transaction.isBackdate ? 'ğŸ—“ï¸ ' : ''; 
                const streakMarker = transaction.isStreakAdvancement ? 'â­ ' : ''; // [v3.18.0] Added streak marker
                return `<div class="history-item">
                            <div class="history-info" title="${transaction.description}">
                                <div class="history-description">
                                    <div class="desc-line-1">${backdateMarker}${streakMarker}${descLine1}</div> 
                                    <div class="desc-line-2">${descLine2}</div>
                                </div>
                                <div class="history-time">${new Date(transaction.timestamp).toLocaleTimeString('zh-CN')}</div>
                            </div>
                            <div class="history-amount-wrapper">
                                <div class="history-amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : '-'}${formatTime(amount)}</div>
                            </div>
                        </div>`; 
            }).join(''); 
            content.innerHTML = summaryHtml + listHtml; 
            modal.classList.add('show'); 
        }
        function hideDayDetailModal() { document.getElementById('dayDetailModal').classList.remove('show'); }
        
        // --- Dashboard & Analysis ---
        function updateAnalysisDashboard() { renderAnalysisFilters(); const filteredTransactions = getFilteredTransactions(reportState.analysisPeriod); const { aggregatedData } = processDashboardData(filteredTransactions, reportState.analysisView); let finalData = aggregatedData; if (reportState.analysisItemFilter) { finalData = aggregatedData.filter(item => item.name === reportState.analysisItemFilter); } renderKpiCards(filteredTransactions, finalData); updateInteractiveAnalysisModule(aggregatedData); }
        function renderAnalysisFilters() { const container = document.getElementById('analysisDashboardFilters'); let viewSwitcherHTML = `<div class="analysis-view-switcher report-filters"> <button class="${reportState.analysisView === 'category' ? 'active' : ''}" onclick="setAnalysisView('category')">åˆ†ç±»</button> <button class="${reportState.analysisView === 'task' ? 'active' : ''}" onclick="setAnalysisView('task')">ä»»åŠ¡</button> </div>`; let periodFilterHTML = `<div class="report-filters"> <button class="${reportState.analysisPeriod === '7d' ? 'active' : ''}" onclick="setAnalysisPeriod('7d')">7å¤©å†…</button> <button class="${reportState.analysisPeriod === '30d' ? 'active' : ''}" onclick="setAnalysisPeriod('30d')">30å¤©å†…</button> <button class="${reportState.analysisPeriod === 'all' ? 'active' : ''}" onclick="setAnalysisPeriod('all')">å…¨éƒ¨</button> </div>`; let itemFilterHTML = ''; if (reportState.analysisItemFilter) { itemFilterHTML = `<button class="report-filters active" onclick="setAnalysisItemFilter(null)">å½“å‰ç­›é€‰: ${reportState.analysisItemFilter} &times;</button>`; } const leftGroup = `<div>${viewSwitcherHTML} ${itemFilterHTML}</div>`; const rightGroup = `<div>${periodFilterHTML}</div>`; container.innerHTML = leftGroup + rightGroup; }
        
        function renderKpiCards(transactions, data) {
            const container = document.getElementById('kpiGrid');
            if (transactions.length === 0) { container.innerHTML = ''; return; }
            const uniqueDays = new Set(transactions.map(t => getLocalDateString(t.timestamp))).size;
            const totalNet = data.reduce((sum, item) => sum + item.net, 0);
            const avgDailyNet = uniqueDays > 0 ? totalNet / uniqueDays : 0;
            let kpiLabel = "æ€»å‡€æ—¶é—´";
            if (reportState.analysisPeriod === '7d') kpiLabel = "7æ—¥å†…å‡€æ—¶é—´";
            if (reportState.analysisPeriod === '30d') kpiLabel = "30æ—¥å†…å‡€æ—¶é—´";
            if (reportState.analysisItemFilter) kpiLabel = `"${reportState.analysisItemFilter}"å‡€æ—¶é—´`;
            container.innerHTML = `
                <div class="kpi-card"> <div class="kpi-label">å¹³å‡æ¯æ—¥å‡€å¢</div> <div class="kpi-value kpi-time ${avgDailyNet >= 0 ? 'positive' : 'negative'}">${avgDailyNet >= 0 ? '+' : ''}${formatTime(avgDailyNet)}</div> </div>
                <div class="kpi-card"> <div class="kpi-label">${kpiLabel}</div> <div class="kpi-value kpi-time ${totalNet >= 0 ? 'positive' : 'negative'}">${totalNet >= 0 ? '+' : ''}${formatTime(totalNet)}</div> </div>
            `;
        }

        function updateInteractiveAnalysisModule(aggregatedData) {
            const switcher = document.getElementById('insightViewSwitcher');
            switcher.innerHTML = `<button class="${reportState.insightView === 'chart' ? 'active' : ''}" onclick="setInsightView('chart')">å›¾è¡¨</button> <button class="${reportState.insightView === 'leaderboard' ? 'active' : ''}" onclick="setInsightView('leaderboard')">æ’è¡Œ</button>`;
            const pieContainer = document.getElementById('pieChartContainerWrapper');
            const leaderboardContainer = document.getElementById('leaderboardContainerWrapper');
            pieContainer.className = reportState.analysisView === 'task' ? 'task-view-active' : 'category-view-active';
            if (reportState.insightView === 'chart') {
                pieContainer.classList.remove('hidden');
                leaderboardContainer.classList.add('hidden');
                renderPieCharts(aggregatedData);
            } else {
                pieContainer.classList.add('hidden');
                leaderboardContainer.classList.remove('hidden');
                renderLeaderboardCharts_Swipable(aggregatedData);
            }
        }
        
        function setInsightView(view) { reportState.insightView = view; saveData(); const filtered = getFilteredTransactions(reportState.analysisPeriod); const { aggregatedData } = processDashboardData(filtered, reportState.analysisView); updateInteractiveAnalysisModule(aggregatedData); }
        function setInsightSubViewIndex(index) { reportState.insightSubViewIndex = index; }
        
        function renderPieCharts(data) {
            const container = document.getElementById('pieChartContainerWrapper');
            const earnData = data.filter(d => d.earned > 0).sort((a, b) => b.earned - a.earned);
            const spendData = data.filter(d => d.spent > 0).sort((a, b) => b.spent - a.spent);
            const createPieChartHTML = (type) => `<div class="pie-chart-wrapper" id="pieWrapper-${type}"></div>`;
            container.innerHTML = `<div class="swiper-container" id="pieSwiperContainer"><div class="swiper-wrapper"><div class="swiper-slide">${createPieChartHTML('earn')}</div><div class="swiper-slide">${createPieChartHTML('spend')}</div></div></div><div class="swiper-pagination" id="pieSwiperPagination"></div>`;
            setTimeout(() => { renderSinglePie('earn', earnData, reportState.analysisView); renderSinglePie('spend', spendData, reportState.analysisView); setupSwiper('pieSwiperContainer', 'pieSwiperPagination', (index) => { setInsightSubViewIndex(index); saveData(); }); }, 50);
        }

        function renderSinglePie(type, sourceData, view) {
            const wrapper = document.getElementById(`pieWrapper-${type}`);
            if (!wrapper) return;
            const valueKey = type === 'earn' ? 'earned' : 'spent';
            const totalValue = sourceData.reduce((sum, item) => sum + item[valueKey], 0);
            if (totalValue === 0) { wrapper.innerHTML = `<div class="empty-message" style="padding: 20px 0; color: var(--text-color-light);">æ— ${type === 'earn' ? 'è·å¾—' : 'æ¶ˆè´¹'}æ•°æ®</div>`; return; }
            let processedData = []; let otherValue = 0; const topN = view === 'task' ? 5 : 4; 
            sourceData.forEach((item, index) => { if (index < topN) processedData.push({ name: item.name, value: item[valueKey] }); else otherValue += item[valueKey]; });
            if (otherValue > 0) processedData.push({ name: 'å…¶ä»–', value: otherValue });
            const isCategoryView = view === 'category'; const colorPalette = type === 'earn' ? TASK_VIEW_EARN_COLORS : TASK_VIEW_SPEND_COLORS; let currentAngle = 0;
            const gradientParts = processedData.map((item, index) => { const percent = (item.value / totalValue) * 100; let color; if (item.name === 'å…¶ä»–') { color = OTHER_COLOR; } else if (!isCategoryView) { color = colorPalette[index] || OTHER_COLOR; } else { color = categoryColors.get(item.name) || '#ccc'; } item.color = color; const startAngle = currentAngle; const endAngle = currentAngle + percent; currentAngle = endAngle; return `${color} ${startAngle}% ${endAngle}%`; });
            const conicGradient = `conic-gradient(from 0deg, ${gradientParts.join(', ')})`;
            const legendHTML = isCategoryView ? '' : `<div class="pie-chart-legend">${processedData.map(item => `<div class="pie-legend-item"><div class="pie-legend-color-box" style="background-color: ${item.color};"></div>${item.name}</div>`).join('')}</div>`;
            wrapper.innerHTML = `<div class="pie-chart-container"><div class="pie-chart" style="background: ${conicGradient};"></div><div class="pie-slice-labels"></div><div class="pie-chart-center"><div class="pie-center-title">æ€»${type === 'earn' ? 'è·å¾—' : 'æ¶ˆè´¹'}</div><div class="pie-center-value">${formatTime(totalValue)}</div></div></div>${legendHTML}`;
            const labelsContainer = wrapper.querySelector('.pie-slice-labels'); const pieContainer = wrapper.querySelector('.pie-chart-container'); if (!pieContainer || !labelsContainer) return; const centerX = pieContainer.offsetWidth / 2; const centerY = pieContainer.offsetHeight / 2; startAngle = -Math.PI / 2;
            processedData.forEach(item => { const percent = item.value / totalValue; if (percent < 0.05) return; const sliceAngle = 2 * Math.PI * percent; const midAngle = startAngle + sliceAngle / 2; const labelRadiusFactor = 0.725; const labelX = centerX + (centerX * labelRadiusFactor) * Math.cos(midAngle); const labelY = centerY + (centerY * labelRadiusFactor) * Math.sin(midAngle); const labelEl = document.createElement('div'); labelEl.className = 'pie-slice-label'; if(isCategoryView) { labelEl.innerHTML = `${item.name}<br>${(percent * 100).toFixed(0)}%<br><span class="time-value">${formatTimeForPie(item.value)}</span>`; } else { labelEl.innerHTML = `${(percent * 100).toFixed(0)}% <br> <span class="time-value">${formatTime(item.value)}</span>`; } labelEl.style.left = `${labelX}px`; labelEl.style.top = `${labelY}px`; labelsContainer.appendChild(labelEl); startAngle += sliceAngle; });
        }
        
        function renderLeaderboardCharts_Swipable(data) {
            const container = document.getElementById('leaderboardContainerWrapper');
            const createChartHTML = (sourceData, type) => { const valueKey = type === 'earn' ? 'earned' : 'spent'; let chartData = sourceData.filter(d => d[valueKey] > 0).sort((a,b) => b[valueKey] - a[valueKey]); if (chartData.length === 0) { return `<div class="leaderboard-chart"><div class="empty-message" style="padding: 20px 0; color: var(--text-color-light);">æ— ${type === 'earn' ? 'è·å¾—' : 'æ¶ˆè´¹'}æ•°æ®</div></div>`; } const topN = 5; if (chartData.length > topN) { const othersValue = chartData.slice(topN).reduce((acc, item) => acc + item[valueKey], 0); chartData = chartData.slice(0, topN); if (othersValue > 0) chartData.push({ name: 'å…¶ä»–', [valueKey]: othersValue }); } const isCategoryView = reportState.analysisView === 'category'; const colorPalette = type === 'earn' ? TASK_VIEW_EARN_COLORS : TASK_VIEW_SPEND_COLORS; const chartClass = isCategoryView ? 'category-view' : ''; const maxVal = chartData.length > 0 ? chartData[0][valueKey] : 0; const itemsHTML = chartData.map((item, index) => { const value = item[valueKey]; const percent = maxVal > 0 ? (value / maxVal) * 100 : 0; let color; if (item.name === 'å…¶ä»–') { color = OTHER_COLOR; } else if (!isCategoryView) { color = colorPalette[index] || OTHER_COLOR; } else { color = categoryColors.get(item.name) || '#ccc'; } return `<div class="leaderboard-item" ${item.name !== 'å…¶ä»–' ? `onclick="setAnalysisItemFilter('${item.name}')"` : ''} title="${item.name}"><div class="leaderboard-label">${item.name}</div><div class="leaderboard-bar-wrapper"><div class="leaderboard-bar" style="width: ${percent}%; background-color: ${color};"></div><span class="leaderboard-bar-value">${formatTime(value)}</span></div></div>`; }).join(''); return `<div class="leaderboard-chart ${chartClass}">${itemsHTML}</div>`; };
            container.innerHTML = `<div class="swiper-container" id="leaderboardSwiperContainer"><div class="swiper-wrapper"><div class="swiper-slide">${createChartHTML(data, 'earn')}</div><div class="swiper-slide">${createChartHTML(data, 'spend')}</div></div></div><div class="swiper-pagination" id="leaderboardSwiperPagination"></div>`;
            setupSwiper('leaderboardSwiperContainer', 'leaderboardSwiperPagination', (index) => { setInsightSubViewIndex(index); saveData(); });
        }
        
        function updateTrendChart() { 
            const container = document.getElementById('trendChartContainerWrapper'); 
            const filtersHTML = `<div class="analysis-filters"> <div> <div class="analysis-view-switcher report-filters"> <button class="${reportState.trendView === 'category' ? 'active' : ''}" onclick="setTrendView('category')">åˆ†ç±»</button> <button class="${reportState.trendView === 'task' ? 'active' : ''}" onclick="setTrendView('task')">ä»»åŠ¡</button> </div> </div> <div class="report-filters"> <button class="${reportState.trendPeriod === '7d' ? 'active' : ''}" onclick="setTrendPeriod('7d')">7å¤©å†…</button> <button class="${reportState.trendPeriod === '30d' ? 'active' : ''}" onclick="setTrendPeriod('30d')">30å¤©å†…</button> </div> </div>`; 
            const chartsHTML = `<div class="swiper-container" id="trendSwiperContainer"><div class="swiper-wrapper" id="trendSwiperWrapper"></div></div><div class="swiper-pagination" id="trendSwiperPagination"></div>`; 
            container.innerHTML = filtersHTML + chartsHTML; 
            const filteredTransactions = getFilteredTransactions(reportState.trendPeriod); 
            const { aggregatedData, trendData } = processDashboardData(filteredTransactions, reportState.trendView); 
            const earnChartHTML = createSingleTrendChartHTML('earned', trendData, aggregatedData); 
            const spendChartHTML = createSingleTrendChartHTML('spent', trendData, aggregatedData); 
            document.getElementById('trendSwiperWrapper').innerHTML = `<div class="swiper-slide">${earnChartHTML}</div><div class="swiper-slide">${spendChartHTML}</div>`; 
            setupSwiper('trendSwiperContainer', 'trendSwiperPagination');
        }
function createSingleTrendChartHTML(type, trendData, allAggregatedData) { const valueKey = type; const title = valueKey === 'earned' ? 'è·å¾—æ—¶é—´è¶‹åŠ¿' : 'æ¶ˆè´¹æ—¶é—´è¶‹åŠ¿'; const dates = Object.keys(trendData).sort(); if (dates.length === 0) return `<div class="chart-container"><div class="chart-title">${title}</div><div class="empty-message" style="padding: 20px 0; color: var(--text-color-light);">æ— æ•°æ®</div></div>`; const topN = 5; const topItemsData = allAggregatedData.filter(d => d[valueKey] > 0).sort((a,b) => b[valueKey] - a[valueKey]).slice(0, topN); const topItems = new Set(topItemsData.map(d => d.name)); if(topItems.size === 0 && !Object.values(trendData).some(d => Object.keys(d[type]).length > 0)) return `<div class="chart-container"><div class="chart-title">${title}</div><div class="empty-message" style="padding: 20px 0; color: var(--text-color-light);">æ— æ•°æ®</div></div>`; const isTaskView = reportState.trendView === 'task'; const colorPalette = type === 'earned' ? TASK_VIEW_EARN_COLORS : TASK_VIEW_SPEND_COLORS; const colorMap = new Map(topItemsData.map((item, index) => [item.name, colorPalette[index] || OTHER_COLOR])); const maxDailyTotal = Math.max(1, ...dates.map(date => Object.values(trendData[date][type]).reduce((sum, val) => sum + val, 0))); const daysHTML = dates.map(date => { const dayData = trendData[date][type]; let dailyTotal = 0; let othersValue = 0; const segments = []; const tooltipEntries = {}; for(const name in dayData) { const value = dayData[name]; dailyTotal += value; tooltipEntries[name] = value; if (topItems.has(name)) segments.push({ name, value }); else othersValue += value; } if (othersValue > 0) { segments.push({ name: 'å…¶ä»–', value: othersValue }); tooltipEntries['å…¶ä»–'] = othersValue; } const tooltipContent = Object.entries(tooltipEntries).sort((a,b)=>b[1]-a[1]).map(([name, value]) => `<div>${name}: ${formatTime(value)}</div>`).join(''); const segmentsHTML = segments.sort((a,b) => b.value - a.value).map(item => { const height = dailyTotal > 0 ? (item.value / dailyTotal) * 100 : 0; let color; if(item.name === 'å…¶ä»–') { color = OTHER_COLOR; } else if (isTaskView) { color = colorMap.get(item.name); } else { color = categoryColors.get(item.name); } return `<div class="trend-segment" style="height: ${height}%; background-color: ${color || '#ccc'}"></div>`; }).join(''); const totalHeight = maxDailyTotal > 0 ? (dailyTotal / maxDailyTotal) * 100 : 0; return `<div> <div class="trend-day" style="height: 150px;"> <div style="height:${totalHeight}%; width: 100%; display: flex; flex-direction: column; justify-content: flex-end; border-radius: 4px; overflow: hidden;"> ${segmentsHTML} </div> <span class="tooltip"><b>${date}</b><hr style="border-color: #555; margin: 4px 0;">${tooltipContent}<b>æ€»è®¡: ${formatTime(dailyTotal)}</b></span> </div> <div class="trend-date-label">${new Date(date).getDate()}</div> </div>`; }).join(''); const legendItems = [...topItemsData]; if (allAggregatedData.length > topN) legendItems.push({ name: 'å…¶ä»–' }); const legendHTML = legendItems.map((item, index) => { let color; if(item.name === 'å…¶ä»–') { color = OTHER_COLOR; } else if (isTaskView) { color = colorPalette[index] || OTHER_COLOR; } else { color = categoryColors.get(item.name); } return `<div class="legend-item" ${item.name !== 'å…¶ä»–' ? `onclick="setAnalysisItemFilter('${item.name}')"`: ''}> <div class="legend-color-box" style="background-color:${color || '#ccc'};"></div> <div class="legend-label">${item.name}</div> </div>`; }).join(''); return `<div class="chart-container"><div class="chart-title">${title}</div><div class="trend-chart">${daysHTML}</div><div class="chart-legend">${legendHTML}</div></div>`; }
        
        function setupSwiper(containerId, paginationId, onSlideChangeCallback) {
            const container = document.getElementById(containerId); if (!container) return;
            const wrapper = container.querySelector('.swiper-wrapper'); if (!wrapper) return; 
            const totalSlides = wrapper.children.length; if (totalSlides === 0) return;

            let paginationEl = null; let paginationBullets = [];
            if (paginationId) {
                paginationEl = document.getElementById(paginationId);
                if (paginationEl) {
                    paginationEl.innerHTML = ''; 
                    for (let i = 0; i < totalSlides; i++) {
                        const bullet = document.createElement('span');
                        bullet.className = 'swiper-pagination-bullet';
                        bullet.onclick = () => goToSlide(i);
                        paginationEl.appendChild(bullet);
                        paginationBullets.push(bullet);
                    }
                }
            }

            let initialIndex = (containerId === 'pieSwiperContainer' || containerId === 'leaderboardSwiperContainer') ? (reportState.insightSubViewIndex || 0) : 0;
            let currentIndex = -1; 
            const slideWidthPercentage = 100 / totalSlides;
            
            function updatePagination() {
                if (!paginationEl) return;
                paginationBullets.forEach((bullet, index) => {
                    bullet.classList.toggle('swiper-pagination-bullet-active', index === currentIndex);
                });
            }

            function goToSlide(index) { 
                if (index < 0 || index >= totalSlides || index === currentIndex) return; 
                wrapper.style.transform = `translateX(-${index * slideWidthPercentage}%)`; 
                currentIndex = index; 
                updatePagination();
                if (onSlideChangeCallback) onSlideChangeCallback(index); 
            }
            
            wrapper.style.transition = 'none'; 
            goToSlide(initialIndex);
            setTimeout(() => { wrapper.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)'; }, 50);

            let touchstartX = 0; let touchstartY = 0; 
            container.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; touchstartY = e.changedTouches[0].screenY; }, { passive: true });
            container.addEventListener('touchend', e => { const touchendX = e.changedTouches[0].screenX; const touchendY = e.changedTouches[0].screenY; const deltaX = touchendX - touchstartX; const deltaY = touchendY - touchstartY; const absDeltaX = Math.abs(deltaX); const absDeltaY = Math.abs(deltaY); const swipeThreshold = 50; if (absDeltaX > swipeThreshold && absDeltaX > absDeltaY) { if (deltaX < 0 && currentIndex < totalSlides - 1) { goToSlide(currentIndex + 1); } else if (deltaX > 0 && currentIndex > 0) { goToSlide(currentIndex - 1); } } touchstartX = 0; touchstartY = 0; });
        }
        
        function updateDetailedDataTable() { const container = document.getElementById('tableContainerWrapper'); const filtersHTML = `<div class="analysis-filters"> <div> <div class="analysis-view-switcher report-filters"> <button class="${reportState.tableView === 'category' ? 'active' : ''}" onclick="setTableView('category')">åˆ†ç±»</button> <button class="${reportState.tableView === 'task' ? 'active' : ''}" onclick="setTableView('task')">ä»»åŠ¡</button> </div> </div> <div class="report-filters"> <button class="${reportState.tablePeriod === '7d' ? 'active' : ''}" onclick="setTablePeriod('7d')">7å¤©å†…</button> <button class="${reportState.tablePeriod === '30d' ? 'active' : ''}" onclick="setTablePeriod('30d')">30å¤©å†…</button> <button class="${reportState.tablePeriod === 'all' ? 'active' : ''}" onclick="setTablePeriod('all')">å…¨éƒ¨</button> </div> </div>`; const tableHTML = `<div class="analysis-table-container"> <table class="analysis-table" id="analysisTable"> <thead></thead> <tbody></tbody> <tfoot></tfoot> </table> </div>`; container.innerHTML = filtersHTML + tableHTML; const filteredTransactions = getFilteredTransactions(reportState.tablePeriod); const { aggregatedData } = processDashboardData(filteredTransactions, reportState.tableView); aggregatedData.forEach(row => { row.avgTime = row.count > 0 ? (row.earned + row.spent) / row.count : 0; }); renderDetailedDataTable(aggregatedData); }
        function setTableSort(key) { const currentSort = reportState.tableSortKey; if (key === 'amount') { if (currentSort === 'amount_desc') reportState.tableSortKey = 'amount_asc'; else if (currentSort === 'amount_asc') reportState.tableSortKey = 'amount_abs_desc'; else reportState.tableSortKey = 'amount_desc'; } else if (key === 'count') { if (currentSort === 'count_desc') reportState.tableSortKey = 'count_asc'; else reportState.tableSortKey = 'count_desc'; } else if (key === 'avg_time') { if (currentSort === 'avg_time_desc') reportState.tableSortKey = 'avg_time_asc'; else reportState.tableSortKey = 'avg_time_desc'; } updateDetailedDataTable(); }

        function renderDetailedDataTable(data) {
            const table = document.getElementById('analysisTable'); const thead = table.querySelector('thead'); const tbody = table.querySelector('tbody'); const tfoot = table.querySelector('tfoot');
            const sortKey = reportState.tableSortKey; const sortedData = [...data].sort((a, b) => { switch (sortKey) { case 'amount_desc': return b.net - a.net; case 'amount_asc': return a.net - b.net; case 'amount_abs_desc': return Math.abs(b.net) - Math.abs(a.net); case 'count_desc': return b.count - a.count; case 'count_asc': return a.count - b.count; case 'avg_time_desc': return b.avgTime - a.avgTime; case 'avg_time_asc': return a.avgTime - b.avgTime; default: return Math.abs(b.net) - Math.abs(a.net); } });
            const visibleRows = reportState.tableVisibleRows || 10; const visibleData = sortedData.slice(0, visibleRows);
            const getSortIndicator = (key) => { if (key === 'amount') { if (sortKey === 'amount_desc') return ' â–¼'; if (sortKey === 'amount_asc') return ' â–²'; if (sortKey === 'amount_abs_desc') return ' |â–¼|'; } if (key === 'count') { if (sortKey === 'count_desc') return ' â–¼'; if (sortKey === 'count_asc') return ' â–²'; } if (key === 'avg_time') { if (sortKey === 'avg_time_desc') return ' â–¼'; if (sortKey === 'avg_time_asc') return ' â–²'; } return ''; };
            const isTaskView = reportState.tableView === 'task'; const headers = isTaskView ? { name: 'ä»»åŠ¡', amount: 'æ€»æ—¶é—´', avg_time: 'å¹³å‡', count: 'æ¬¡æ•°' } : { name: 'åˆ†ç±»', amount: 'æ€»æ—¶é—´', count: 'æ¬¡æ•°' };
            const headerKeys = Object.keys(headers); thead.innerHTML = `<tr>${headerKeys.map(key => { const sortable = (key === 'amount' || key === 'count' || (isTaskView && key === 'avg_time')); const onClick = sortable ? `onclick="setTableSort('${key}')"` : ''; return `<th ${onClick} style="${sortable ? 'cursor: pointer;' : ''}">${headers[key]}${getSortIndicator(key)}</th>`; }).join('')}</tr>`;
            tbody.innerHTML = visibleData.length > 0 ? visibleData.map(row => { let amountText, amountClass; if (row.earned > 0 && row.spent > 0) { amountText = `<span class="text-positive">+${formatTimeHoursDecimal(row.earned)}</span><br><span class="text-negative">-${formatTimeHoursDecimal(row.spent)}</span>`; } else if (row.earned > 0) { amountText = `+${formatTimeHoursDecimal(row.earned)}`; amountClass = 'text-positive'; } else if (row.spent > 0) { amountText = `-${formatTimeHoursDecimal(row.spent)}`; amountClass = 'text-negative'; } else { amountText = formatTimeHoursDecimal(0); amountClass = 'text-neutral'; } const nameCell = `<td><div class="task-name-scrollable" tabindex="0" title="${row.name}">${row.name}</div></td>`; const amountCell = `<td class="${amountClass || ''}">${amountText}</td>`; const countCell = `<td>${row.count}</td>`; const avgTimeCell = isTaskView ? `<td>${formatTimeHoursDecimal(row.avgTime)}</td>` : ''; if (isTaskView) return `<tr>${nameCell}${amountCell}${avgTimeCell}${countCell}</tr>`; else { const categoryNameCell = `<td>${row.name}</td>`; return `<tr>${categoryNameCell}${amountCell}${countCell}</tr>`; } }).join('') : `<tr><td colspan="${headerKeys.length}" class="empty-message" style="color:var(--text-color);">æ— åŒ¹é…æ•°æ®</td></tr>`;
            tfoot.innerHTML = ''; if (sortedData.length > visibleRows) { const remaining = sortedData.length - visibleRows; tfoot.innerHTML = `<tr class="table-footer-row"><td colspan="${headerKeys.length}"><button class="show-more-btn" onclick="showMoreTableRows()">æ˜¾ç¤ºæ›´å¤š (${remaining} æ¡)</button></td></tr>`; }
        }
        function showMoreTableRows() { reportState.tableVisibleRows = (reportState.tableVisibleRows || 10) + 10; updateDetailedDataTable(); }
        function processDashboardData(transactionsToProcess, view) { const dataMap = new Map(); const trendData = {}; const chronoSortedTransactions = [...transactionsToProcess].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); const getItemNameAndCategory = (t) => { const task = tasks.find(tsk => tsk.id === t.taskId); if (view === 'category') { return { name: task ? task.category : 'æœªçŸ¥', category: null }; } return { name: t.taskName || task?.name || 'æœªçŸ¥ä»»åŠ¡', category: task?.category }; }; chronoSortedTransactions.forEach(t => { const { name, category } = getItemNameAndCategory(t); if (!name) return; if (!dataMap.has(name)) { dataMap.set(name, { name, category, earned: 0, spent: 0, net: 0, count: 0 }); } const item = dataMap.get(name); const isEarn = t.type ? t.type === 'earn' : t.amount > 0; const amount = Math.abs(t.amount); if (isEarn) { item.earned += amount; item.net += amount; } else { item.spent += amount; item.net -= amount; } item.count++; const dateStr = getLocalDateString(t.timestamp); if (!trendData[dateStr]) trendData[dateStr] = { earned: {}, spent: {} }; const trendType = isEarn ? 'earned' : 'spent'; trendData[dateStr][trendType][name] = (trendData[dateStr][trendType][name] || 0) + amount; }); return { aggregatedData: Array.from(dataMap.values()), trendData }; }
        
        // --- Report State Changers ---
        function setAnalysisPeriod(period) { reportState.analysisPeriod = period; saveData(); updateAnalysisDashboard(); }
        function setAnalysisView(view) { reportState.analysisView = view; reportState.analysisItemFilter = null; saveData(); updateAnalysisDashboard(); }
        function setAnalysisItemFilter(name) { if (name === 'å…¶ä»–') return; reportState.analysisItemFilter = name; saveData(); updateAnalysisDashboard(); }
        function setTrendPeriod(period) { reportState.trendPeriod = period; saveData(); updateTrendChart(); }
        function setTrendView(view) { reportState.trendView = view; saveData(); updateTrendChart(); }
        function setTablePeriod(period) { reportState.tableVisibleRows = 10; reportState.tablePeriod = period; saveData(); updateDetailedDataTable(); }
        function setTableView(view) { reportState.tableVisibleRows = 10; reportState.tableView = view; saveData(); updateDetailedDataTable(); }
        
        // --- Utilities & Helpers ---
        function getLocalDateString(date) { const d = new Date(date); const year = d.getFullYear(); const month = (d.getMonth() + 1).toString().padStart(2, '0'); const day = d.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
        function getHeatmapColorClass(net) { if (net === 0) return ''; const absNet = Math.abs(net); if (net > 0) { if (absNet < 3600) return 'net-surplus-1'; if (absNet < 10800) return 'net-surplus-2'; return 'net-surplus-3'; } else { if (absNet < 3600) return 'net-deficit-1'; if (absNet < 10800) return 'net-deficit-2'; return 'net-deficit-3'; } }
        
        // [v4.1.0] New helper function for balance card click
        function showTodayDetails() {
            const todayStr = getLocalDateString(new Date());
            showDayDetails(todayStr);
        }
function updateCategoryRecommendations(taskType) { let relevantCategories = []; if (taskType) { const isEarnType = ['reward', 'continuous', 'continuous_target'].includes(taskType); const filteredTasks = tasks.filter(task => { const taskIsEarn = ['reward', 'continuous', 'continuous_target'].includes(task.type); return isEarnType === taskIsEarn; }); relevantCategories = [...new Set(filteredTasks.map(t => t.category))]; } else { relevantCategories = [...new Set(tasks.map(t => t.category))]; } document.getElementById('categoryRecommendations').innerHTML = relevantCategories.map(cat => `<div class="recommendation-item" onclick="selectCategory('${cat}')">${cat}</div>`).join(''); }
        function selectCategory(category) { document.getElementById('taskCategory').value = category; }
        function formatTime(seconds) { if (seconds === null || isNaN(seconds)) return '0ç§’'; if (seconds < 0) return '-' + formatTime(-seconds); if (seconds === 0) return '0ç§’'; seconds = Math.round(seconds); const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = seconds % 60; const parts = []; if (h > 0) parts.push(`${h}å°æ—¶`); if (m > 0) parts.push(`${m}åˆ†`); if (s > 0 && h === 0) parts.push(`${s}ç§’`); return parts.length > 0 ? parts.join('') : '0ç§’'; }
        function formatTimeForPie(seconds) { if (seconds === null || isNaN(seconds)) return '0åˆ†'; if (seconds < 0) return '-' + formatTimeForPie(-seconds); const totalMinutes = Math.round(seconds / 60); if (totalMinutes < 1) return '0åˆ†'; if (totalMinutes < 60) return `${totalMinutes}åˆ†`; const h = Math.floor(totalMinutes / 60); const m = totalMinutes % 60; const parts = []; if (h > 0) parts.push(`${h}å°æ—¶`); if (m > 0) parts.push(`${m}åˆ†`); return parts.join(''); }
        function formatTimeHoursDecimal(seconds) { if (seconds === null || isNaN(seconds)) return '0.0å°æ—¶'; const sign = seconds < 0 ? '-' : ''; const absSeconds = Math.abs(seconds); if (absSeconds === 0) return '0.0å°æ—¶'; const hours = absSeconds / 3600; return `${sign}${hours.toFixed(1)}å°æ—¶`; }
        function formatDateTime(timestamp) { const d = new Date(timestamp), n = new Date(); const diff = (new Date(n.toDateString()) - new Date(d.toDateString())) / 86400000; if (diff === 0) return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); if (diff === 1) return 'æ˜¨å¤© ' + d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); if (diff < 7) return `${diff}å¤©å‰`; return d.toLocaleDateString('zh-CN'); }
        
        // --- Settings & Notifications ---
        function requestNotificationPermission() { if ('Notification' in window) Notification.requestPermission(); }
        
        // [v4.0.2] ä¿®å¤: "æµ‹è¯•é€šçŸ¥" æŒ‰é’®ä¼šç»•è¿‡è®¾ç½®æ£€æŸ¥ï¼Œç¡®ä¿æ€»èƒ½è§¦å‘
        async function showNotification(title, body, type) {
            const isTestNotification = title === 'âœ… æµ‹è¯•é€šçŸ¥';

            if (!isTestNotification) { // ä»…å¯¹éæµ‹è¯•é€šçŸ¥æ£€æŸ¥è®¾ç½®
                if (type === 'achievement' && !notificationSettings.achievement && !notificationSettings.habitNudgeEnabled) {
                    return;
                }
                if (type !== 'reminder' && type !== 'achievement' && !notificationSettings[type]) {
                    return; 
                }
            }
            
            if (!('Notification' in window) || !('serviceWorker' in navigator) || Notification.permission !== 'granted') {
                return; 
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                await registration.showNotification(title, { body: body, icon: 'icon-192.png' });
            } catch (error) {
                console.error(`Failed to show notification "${title}". Error:`, error);
                throw error;
            }
        }
        
        async function sendTestNotification() {
            if (!('Notification' in window) || !('serviceWorker' in navigator)) { alert('æ­¤æµè§ˆå™¨ä¸æ”¯æŒ PWA é€šçŸ¥åŠŸèƒ½ã€‚'); return; }
            if (Notification.permission === 'denied') { alert('é€šçŸ¥æƒé™å·²è¢«æ‹’ç»ã€‚è¯·åœ¨æ‚¨çš„æµè§ˆå™¨æˆ–ç³»ç»Ÿè®¾ç½®ä¸­ä¸ºæœ¬ç«™é‡æ–°å¼€å¯é€šçŸ¥æƒé™ã€‚'); return; }
            if (Notification.permission === 'default') { const permission = await Notification.requestPermission(); if (permission !== 'granted') { alert('æ‚¨æ‹’ç»äº†é€šçŸ¥æƒé™ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯ã€‚'); return; } }
            try { await showNotification('âœ… æµ‹è¯•é€šçŸ¥', 'å¦‚æœçœ‹åˆ°æ­¤æ¶ˆæ¯ï¼Œè¯´æ˜æ‚¨çš„é€šçŸ¥åŠŸèƒ½å·¥ä½œæ­£å¸¸ï¼', 'achievement'); alert('æµ‹è¯•é€šçŸ¥å·²æˆåŠŸå‘é€ï¼è¯·æ£€æŸ¥æ‚¨çš„ç³»ç»Ÿé€šçŸ¥ã€‚'); } catch (error) { alert(`å‘é€é€šçŸ¥æ—¶å‡ºé”™ï¼š\n${error.message}\n\nè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚`); }
        }
        function toggleAchievementNotifications() { notificationSettings.achievement = document.getElementById('achievementNotificationToggle').checked; if (notificationSettings.achievement && Notification.permission === 'default') requestNotificationPermission(); saveData(); }
        function toggleLongRunningNotifications() { notificationSettings.longRunning = document.getElementById('longRunningNotificationToggle').checked; saveData(); }
        function updateLongRunningThreshold() { const v = parseInt(document.getElementById('longRunningThreshold').value); if (v >= 300) { notificationSettings.longRunningThreshold = v; saveData(); } }
        function toggleLowBalanceNotifications() { notificationSettings.lowBalance = document.getElementById('lowBalanceNotificationToggle').checked; saveData(); }
        function updateLowBalanceThreshold() { const v = parseInt(document.getElementById('lowBalanceThreshold').value); if (v >= 0) { notificationSettings.lowBalanceThreshold = v; saveData(); updateBalance(); } }
        function toggleHabitNudge() { notificationSettings.habitNudgeEnabled = document.getElementById('habitNudgeToggle').checked; if (notificationSettings.habitNudgeEnabled && Notification.permission === 'default') requestNotificationPermission(); saveData(); }
        function updateHabitNudgeTime() { notificationSettings.habitNudgeTime = document.getElementById('habitNudgeTime').value; saveData(); }
        
        function updateNotificationSettingsUI() { 
            document.getElementById('achievementNotificationToggle').checked = notificationSettings.achievement; 
            document.getElementById('longRunningNotificationToggle').checked = notificationSettings.longRunning; 
            document.getElementById('longRunningThreshold').value = notificationSettings.longRunningThreshold; 
            document.getElementById('lowBalanceNotificationToggle').checked = notificationSettings.lowBalance; 
            document.getElementById('lowBalanceThreshold').value = notificationSettings.lowBalanceThreshold; 
            document.getElementById('habitNudgeToggle').checked = notificationSettings.habitNudgeEnabled;
            document.getElementById('habitNudgeTime').value = notificationSettings.habitNudgeTime;
        }
        
        let systemThemeListener = null;
        function applyTheme(theme) { if (systemThemeListener) { window.matchMedia('(prefers-color-scheme: dark)').removeEventListener('change', systemThemeListener); systemThemeListener = null; } if (theme === 'system') { const p = window.matchMedia('(prefers-color-scheme: dark)').matches; document.body.setAttribute('data-theme', p ? 'dark' : 'light'); systemThemeListener = e => document.body.setAttribute('data-theme', e.matches ? 'dark' : 'light'); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', systemThemeListener); } else { document.body.setAttribute('data-theme', theme); } document.querySelectorAll('.theme-option').forEach(b => b.classList.toggle('active', b.dataset.themeValue === theme)); }
        function setTheme(theme) { applyTheme(theme); localStorage.setItem('themePreference', theme); }
        
        function checkReminders() {
            const now = Date.now();
            let changed = false;
            tasks.forEach(task => {
                if (task.reminderDetails && task.reminderDetails.status === 'pending') {
                    const { mode, time, creationTimestamp, isRecurring } = task.reminderDetails;
                    let targetTime;
                    if (mode === 'absolute') {
                        const [datePart, timePart] = time.split('T');
                        const [year, month, day] = datePart.split('-').map(Number);
                        const [hours, minutes] = timePart.split(':').map(Number);
                        targetTime = new Date(year, month - 1, day, hours, minutes, 0, 0).getTime();
                    } else { // relative
                        targetTime = creationTimestamp + (time * 1000);
                    }

                    if (now >= targetTime) {
                        let shouldNotify = true;
                        
                        if (task.isHabit) {
                            const todayStr = getLocalDateString(new Date());
                            // [v3.18.0] Check if target is achieved this period, not just if completed today
                            // [v4.2.0] Use referenceDate (today)
                            const { currentCount, targetCount } = getHabitPeriodInfo(task, transactions, new Date());
                            if (currentCount >= targetCount) {
                                shouldNotify = false; // Don't notify, already achieved target this period
                            }
                        }
                        
                        if (shouldNotify) {
                            showNotification('ğŸ”” ä»»åŠ¡æé†’', `æ˜¯æ—¶å€™å¼€å§‹/å®Œæˆä»»åŠ¡: "${task.name}" äº†ï¼`, 'reminder');
                        }
                        
                        if (isRecurring && task.isHabit && mode === 'absolute') {
                            const [datePart, timePart] = time.split('T');
                            const [year, month, day] = datePart.split('-').map(Number);
                            const [hours, minutes] = timePart.split(':').map(Number);
                            
                            let nextTime = new Date(year, month - 1, day, hours, minutes, 0, 0);
                            
                            const period = task.habitDetails.period;
                            const nowDateTime = new Date();
                            
                            do {
                                if (period === 'daily') {
                                    nextTime.setDate(nextTime.getDate() + 1);
                                } else if (period === 'weekly') {
                                    nextTime.setDate(nextTime.getDate() + 7);
                                } else if (period === 'monthly') {
                                    // [v3.17.3] Ensure month wrap-around logic is correct
                                    nextTime.setMonth(nextTime.getMonth() + 1);
                                    // Handle day overflow (e.g., trying to set Feb 30)
                                    if (nextTime.getDate() !== day) {
                                        nextTime.setDate(0); // Set to last day of previous month
                                    }
                                } else {
                                    nextTime.setDate(nextTime.getDate() + 1);
                                }
                            } while (nextTime <= nowDateTime); 
                            
                            const pad = (num) => String(num).padStart(2, '0');
                            const y = nextTime.getFullYear();
                            const m = pad(nextTime.getMonth() + 1);
                            const d = pad(nextTime.getDate());
                            const h = pad(hours); 
                            const min = pad(minutes); 
                            
                            task.reminderDetails.time = `${y}-${m}-${d}T${h}:${min}`;
                            
                        } else {
                            task.reminderDetails.status = 'triggered';
                        }
                        changed = true;
                    }
                }
            });
            if (changed) {
                saveData();
            }
        }
// --- [v4.0.0] Authentication Functions ---
        
        // [v4.0.2] ä¿®å¤: ç§»é™¤éšè—/æ˜¾ç¤º 'data-btn-container' çš„é€»è¾‘ï¼Œä½¿å…¶å§‹ç»ˆå¯è§
        function updateAuthUI(user) {
            const authFormContainer = document.getElementById('authFormContainer');
            const authStatusContainer = document.getElementById('authStatusContainer');
            const authStatus = document.getElementById('authStatus');
            const authError = document.getElementById('authError');
            authError.textContent = '';
            
            // [v4.0.2] ä¿®å¤ï¼šæ•°æ®ç®¡ç†æ¨¡å—åº”å§‹ç»ˆå¯è§
            // document.getElementById('data-btn-container').classList.add('hidden'); // <- ç§»é™¤
            // document.getElementById('data-btn-container').classList.remove('hidden'); // <- ç§»é™¤

            if (user) {
                // Logged in
                authFormContainer.classList.add('hidden');
                authStatusContainer.classList.remove('hidden');
                authStatus.textContent = `å·²ä½œä¸º ${user.getUsername()} ç™»å½•ã€‚çŠ¶æ€ï¼šæ­£åœ¨è¿æ¥...`;
                authStatus.className = 'status-syncing';
            } else {
                // Logged out
                authFormContainer.classList.remove('hidden');
                authStatusContainer.classList.add('hidden');
                authStatus.textContent = 'æœªç™»å½•';
                authStatus.className = 'status-offline';
            }
        }
        
        function showAuthError(message) {
            const authError = document.getElementById('authError');
            authError.textContent = message;
            authError.classList.add('show');
        }

        async function handleRegister() {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            const email = document.getElementById('authEmail').value;
            
            if (!username || !password) {
                showAuthError('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            setAuthLoading(true);
            const user = new AV.User();
            user.setUsername(username);
            user.setPassword(password);
            if (email) user.setEmail(email);

            try {
                await user.signUp();
                updateAuthUI(user);
                showNotification('âœ… æ³¨å†ŒæˆåŠŸ', `æ¬¢è¿æ‚¨, ${username}ï¼æ­£åœ¨åŒæ­¥æœ¬åœ°æ•°æ®...`, 'achievement');
                await loadData(true); // Force load data, triggering migration
            } catch (error) {
                console.error('Register Error:', error);
                showAuthError(`æ³¨å†Œå¤±è´¥: ${error.message} (Code: ${error.code})`);
            } finally {
                setAuthLoading(false);
            }
        }

        async function handleLogin() {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;

            if (!username || !password) {
                showAuthError('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            setAuthLoading(true);
            try {
                const user = await AV.User.logIn(username, password);
                updateAuthUI(user);
                showNotification('ğŸ‘‹ ç™»å½•æˆåŠŸ', `æ¬¢è¿å›æ¥, ${username}ï¼æ­£åœ¨è·å–äº‘ç«¯æ•°æ®...`, 'achievement');
                await loadData(true); // Force load data, triggering cloud sync
            } catch (error) {
                console.error('Login Error:', error);
                showAuthError(`ç™»å½•å¤±è´¥: ${error.message} (Code: ${error.code})`);
            } finally {
                setAuthLoading(false);
            }
        }

        async function handleLogout() {
            if (!confirm('é€€å‡ºç™»å½•å°†åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼ã€‚æ‚¨ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) return;
            
            try {
                await AV.User.logOut();
                if (liveQuery) {
                    await liveQuery.unsubscribe();
                    liveQuery = null;
                }
                cloudDataObject = null;
                updateAuthUI(null);
                
                // Reset app state to local defaults
                resetLocalData();
                await loadData(true); // Force reload from localStorage
                showNotification(â¡ï¸ å·²é€€å‡º', 'å·²åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼ã€‚', 'achievement');
            } catch (error) {
                console.error('Logout Error:', error);
                alert('é€€å‡ºæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }
        
        function setAuthLoading(isLoading) {
            document.getElementById('registerButton').disabled = isLoading;
            document.getElementById('loginButton').disabled = isLoading;
            document.getElementById('authError').textContent = isLoading ? 'è¯·ç¨å€™...' : '';
        }
        
        // --- Data Persistence (Save/Load/Import/Export) ---
        
        // [v4.0.0] New Function: Migrate local data to cloud
        async function migrateLocalToCloud(localData) {
            const currentUser = AV.User.current();
            if (!currentUser) return;
            
            console.log("Attempting to migrate local data to cloud...");
            setAuthStatus('åŒæ­¥ä¸­...', 'status-syncing');
            
            const UserData = AV.Object.extend('UserTimeBankData');
            const dataObject = new UserData();
            
            // Set ACL for security: Only this user can read/write
            const acl = new AV.ACL();
            acl.setReadAccess(currentUser, true);
            acl.setWriteAccess(currentUser, true);
            dataObject.setACL(acl);
            
            // Set data and owner
            dataObject.set('data', localData);
            dataObject.set('owner', currentUser);

            try {
                await dataObject.save();
                console.log("Local data successfully migrated to cloud.");
                showNotification('â˜ï¸ åŒæ­¥æˆåŠŸ', 'æœ¬åœ°æ•°æ®å·²æˆåŠŸä¸Šä¼ åˆ°äº‘ç«¯ã€‚', 'achievement');
                // After migration, immediately load from cloud to establish sync
                await loadData(true); 
            } catch (error) {
                console.error("Cloud migration failed:", error);
                setAuthStatus(`åŒæ­¥å¤±è´¥: ${error.message}`, 'status-error');
                showAuthError("è‡ªåŠ¨ä¸Šä¼ æœ¬åœ°æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
            }
        }
        
        // [v4.0.0] New Function: Handle data conflict
        function handleDataConflict(localData, cloudData) {
            return new Promise((resolve) => {
                const useLocal = confirm("æ•°æ®å†²çªï¼\n\næˆ‘ä»¬å‘ç°äº‘ç«¯å’Œæœ¬åœ°å‡æœ‰æ•°æ®ã€‚\n\n[ç¡®å®š] = ä¿ç•™æœ¬åœ°æ•°æ® (è¦†ç›–äº‘ç«¯)\n[å–æ¶ˆ] = ä¿ç•™äº‘ç«¯æ•°æ® (è¦†ç›–æœ¬åœ°)");
                
                if (useLocal) {
                    console.log("Conflict resolution: User chose LOCAL data.");
                    setAuthStatus('åŒæ­¥ä¸­...', 'status-syncing');
                    cloudDataObject.set('data', localData);
                    cloudDataObject.save().then(() => {
                        console.log("Cloud data overwritten with local data.");
                        setAuthStatus('å·²åŒæ­¥ âœ…', 'status-online');
                        resolve(localData); // Use local data
                    }).catch(err => {
                        console.error("Failed to save local data to cloud:", err);
                        setAuthStatus(`åŒæ­¥å¤±è´¥: ${err.message}`, 'status-error');
                        resolve(cloudData); // Fallback to cloud data on error
                    });
                } else {
                    console.log("Conflict resolution: User chose CLOUD data.");
                    // Just resolve with cloud data. Local data will be overwritten.
                    resolve(cloudData);
                }
            });
        }
        
        // [v4.0.0] New Function: Set auth status message
        function setAuthStatus(message, className) {
            const authStatus = document.getElementById('authStatus');
            if (authStatus) {
                authStatus.textContent = message;
                authStatus.className = className;
            }
        }

        function exportData() { 
            const migratedTransactions = transactions.map(t => { 
                if (t.type) return t; 
                const isEarn = t.amount > 0; 
                const task = tasks.find(tsk => tsk.id === t.taskId); 
                return { 
                    ...t, 
                    type: isEarn ? 'earn' : 'spend', 
                    amount: Math.abs(t.amount), 
                    taskName: t.taskName || (task ? task.name : 'æœªçŸ¥ä»»åŠ¡'),
                    isStreakAdvancement: t.isStreakAdvancement || false // Ensure flag exists on export
                }; 
            }); 
            
            // [v4.0.0] Use current in-memory state, not localStorage
            const d = { 
                version: APP_VERSION, 
                currentBalance, 
                tasks, 
                transactions: migratedTransactions, 
                categoryColors: [...categoryColors], 
                collapsedCategories: [...collapsedCategories], 
                dailyChanges, 
                notificationSettings, 
                reportState, 
                earnTabViewMode, // [v4.4.0] Add new state
                exportTime: new Date().toISOString() 
            }; 
            
            const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' }); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(b); 
            a.download = `timebank_backup_${new Date().toISOString().split('T')[0]}.json`; 
            a.click(); URL.revokeObjectURL(a.href); 
            showNotification('ğŸ“ æ•°æ®å·²å¯¼å‡º', 'æ‰€æœ‰å†å²æ•°æ®å·²æ›´æ–°ä¸ºæœ€æ–°æ ¼å¼ã€‚', 'achievement'); 
        }
        
        function importData(event) {
            const f = event.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = function(e) {
                try {
                    let d = JSON.parse(e.target.result);
                    if (!d.version || !Array.isArray(d.tasks)) throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                    
                    const currentUser = AV.User.current();
                    const confirmMsg = currentUser 
                        ? 'å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰äº‘ç«¯å’Œæœ¬åœ°çš„æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
                        : 'å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æœ¬åœ°æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';
                        
                    if (!confirm(confirmMsg)) return;
                    
                    d = repairAndMigrateData(d);
                    
                    // Apply data to local state
                    applyDataState(d);
                    
                    // Save and reload
                    saveData(); // This will save to cloud if logged in
                    updateAllUI();
                    updateNotificationSettingsUI();
                    showNotification('ğŸ“¥ å¯¼å…¥å®Œæˆ', 'æ•°æ®å·²æˆåŠŸå¯¼å…¥ã€‚', 'achievement');
                    
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            r.onerror = function() {
                alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
            };
            r.readAsText(f);
            event.target.value = '';
        }

        // [v4.0.0] Modified clearAllData
        async function clearAllData() {
            const currentUser = AV.User.current();
            let confirmMsg = currentUser
                ? 'æ‚¨å·²ç™»å½•ï¼Œæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‚¨çš„ *äº‘ç«¯* å’Œ *æœ¬åœ°* æ‰€æœ‰æ•°æ®ï¼æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼'
                : 'æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰ *æœ¬åœ°* æ•°æ®ï¼æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼';

            if (!confirm(confirmMsg)) return;
            
            confirmMsg = currentUser
                ? 'æœ€åç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‚¨çš„äº‘ç«¯è´¦æˆ·æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
                : 'æœ€åç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰æœ¬åœ°ä»»åŠ¡ã€äº¤æ˜“è®°å½•å’Œè®¾ç½®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';

            if (!confirm(confirmMsg)) return;

            // Clear local backup and theme
            localStorage.removeItem('timeBankData_backup'); 
            localStorage.removeItem('themePreference');
            
            if (currentUser) {
                // Logged in: Destroy cloud data
                try {
                    if (cloudDataObject) {
                        await cloudDataObject.destroy();
                        console.log("Cloud data destroyed.");
                    }
                    // Also clear local data just in case
                    localStorage.removeItem('timeBankData');
                    await handleLogout(); // Logout and reload
                    location.reload();
                } catch (error) {
                    console.error("Failed to destroy cloud data:", error);
                    alert("åˆ é™¤äº‘ç«¯æ•°æ®å¤±è´¥: " + error.message + "\nè¯·é‡è¯•ã€‚");
                }
            } else {
                // Logged out: Clear local data
                localStorage.removeItem('timeBankData');
                location.reload();
            }
        }
        
        // [v4.0.0] Modified saveData
        function saveData() {
            const currentUser = AV.User.current();
            
            // 1. Get current state
            const dataToSave = getAppState(); // [v4.4.0] Use helper

            // 2. Decide where to save
            if (currentUser && cloudDataObject) {
                // --- Cloud Save ---
                if (isSyncing) return; // Don't save if a sync update is in progress
                
                // Use a queue to prevent concurrent saves
                saveQueue = dataToSave; // Always update queue with latest data
                if (isSaving) return; // Another save is already in progress
                
                isSaving = true;
                setAuthStatus('æ­£åœ¨ä¿å­˜...', 'status-syncing');
                
                // Process the data from the queue
                const dataFromQueue = saveQueue;
                saveQueue = null; // Clear queue
                
                // Only save the 'data' part to the cloud object
                cloudDataObject.set('data', dataFromQueue);
                
                cloudDataObject.save().then(() => {
                    console.log("Data saved to cloud.");
                    setAuthStatus('å·²åŒæ­¥ âœ…', 'status-online');
                    isSaving = false;
                    // If new data arrived while saving, save again
                    if (saveQueue) {
                        setTimeout(saveData, 100); 
                    }
                }).catch(error => {
                    console.error("Cloud save error:", error);
                    setAuthStatus(`ä¿å­˜å¤±è´¥: ${error.message}`, 'status-error');
                    isSaving = false;
                });

            } else {
                // --- Local Save ---
                try { 
                    const currentData = localStorage.getItem('timeBankData'); 
                    if (currentData) { 
                        localStorage.setItem('timeBankData_backup', currentData); 
                    } 
                } catch (error) { 
                    console.error("Failed to create data backup:", error); 
                }
                
                try { 
                    localStorage.setItem('timeBankData', JSON.stringify(dataToSave)); 
                } catch (error) { 
                    console.error("Failed to save data:", error); 
                    alert("é”™è¯¯ï¼šæ— æ³•ä¿å­˜æ‚¨çš„æ•°æ®ï¼æ‚¨çš„æ›´æ”¹å¯èƒ½ä¸ä¼šè¢«ä¿ç•™ã€‚"); 
                }
            }
        }
// [v4.0.0] Modified loadData
        async function loadData(forceReload = false) {
            const currentUser = AV.User.current();
            
            if (currentUser) {
                // --- Cloud Load ---
                setAuthStatus('è¿æ¥ä¸­...', 'status-syncing');
                
                // Disconnect old query if exists
                if (liveQuery && forceReload) {
                    await liveQuery.unsubscribe();
                    liveQuery = null;
                }
                
                const query = new AV.Query('UserTimeBankData');
                query.equalTo('owner', currentUser);
                
                try {
                    const results = await query.find();
                    let localData = getLocalData(); // Get local data for migration check
                    
                    if (results.length > 0) {
                        // 1. Cloud data EXISTS
                        cloudDataObject = results[0];
                        let cloudData = cloudDataObject.get('data');
                        
                        if (localData && localData.tasks.length > 0) {
                            // CONFLICT: Local data also exists. Ask user.
                            console.log("Conflict: Both local and cloud data found.");
                            setAuthStatus('ç­‰å¾…ç”¨æˆ·ç¡®è®¤...', 'status-warning');
                            const resolvedData = await handleDataConflict(localData, cloudData);
                            applyDataState(resolvedData);
                            localStorage.removeItem('timeBankData'); // Clear local data after resolution
                        } else {
                            // No conflict, just use cloud data
                            applyDataState(cloudData);
                        }
                        
                        // Subscribe to LiveQuery
                        await subscribeToLiveQuery(query);
                        
                    } else {
                        // 2. No cloud data. Check for local data.
                        if (localData && localData.tasks.length > 0) {
                            // MIGRATE: Local data exists, cloud is empty. Upload it.
                            await migrateLocalToCloud(localData);
                            localStorage.removeItem('timeBankData'); // Clear local data after migration
                        } else {
                            // NEW USER: No local, no cloud. Just use defaults and save.
                            applyDataState(null); // Load defaults
                            await migrateLocalToCloud(getAppState()); // Save defaults to cloud
                        }
                    }
                    
                    setAuthStatus('å·²åŒæ­¥ âœ…', 'status-online');
                    
                } catch (error) {
                    console.error("Cloud load error:", error);
                    setAuthStatus(`åŒæ­¥å¤±è´¥: ${error.message}`, 'status-error');
                    // Fallback to local data on error
                    applyDataState(getLocalData());
                }

            } else {
                // --- Local Load ---
                applyDataState(getLocalData());
            }
            
            // Final step: Apply theme and update UI
            const theme = localStorage.getItem('themePreference') || 'system'; 
            setTheme(theme);
            updateAllUI(); // First render
        }
        
        // [v4.0.0] New Function: LiveQuery Subscription
        async function subscribeToLiveQuery(query) {
            if (liveQuery) return; // Already subscribed
            
            try {
                liveQuery = await query.subscribe();
                console.log("LiveQuery subscribed successfully.");
                
                liveQuery.on('update', (updatedObject) => {
                    console.log('LiveQuery: Data updated from cloud.');
                    isSyncing = true; // Set sync flag
                    
                    try {
                        const newData = updatedObject.get('data');
                        if (newData) {
                            
                            // [v4.3.2] FIX 2: Update the global cloud object reference.
                            // This prevents a race condition where a background timer (checkReminders)
                            // might trigger a saveData() using the OLD cloudDataObject,
                            // overwriting the data that was just received.
                            cloudDataObject = updatedObject; 
                            
                            // Apply cloud data to local state
                            applyDataState(newData);
                            // Refresh UI
                            updateAllUI();
                        }
                        setAuthStatus('å·²åŒæ­¥ âœ…', 'status-online');
                    } catch (e) {
                        console.error("Error applying live update:", e);
                    } finally {
                        isSyncing = false; // Unset sync flag
                    }
                });
                
                liveQuery.on('close', () => {
                    console.log('LiveQuery: Connection closed.');
                    setAuthStatus('å·²æ–­å¼€ âš¡', 'status-error');
                });
                
                liveQuery.on('error', (error) => {
                    console.error('LiveQuery: Error', error);
                    setAuthStatus(`è¿æ¥é”™è¯¯: ${error.message}`, 'status-error');
                });
                
            } catch (error) {
                console.error("LiveQuery subscription failed:", error);
                setAuthStatus(`åŒæ­¥å¤±è´¥: ${error.message}`, 'status-error');
            }
        }
        
        // [v4.4.0] Modified to include new state
        function getAppState() {
            return {
                version: APP_VERSION,
                currentBalance,
                tasks,
                transactions,
                categoryColors: [...categoryColors],
                collapsedCategories: [...collapsedCategories],
                runningTasks: [...runningTasks],
                dailyChanges,
                notificationSettings,
                reportState,
                earnTabViewMode // [v4.4.0] New state variable
            };
        }
        
        // [v4.0.0] New Function: Reset local state to defaults
        function resetLocalData() {
            currentBalance = 0;
            tasks = [];
            transactions = [];
            categoryColors = new Map();
            collapsedCategories = new Set();
            runningTasks = new Map();
            dailyChanges = {};
            earnTabViewMode = 'recent'; // [v4.4.0] Reset to default
            // Keep notificationSettings and reportState as they are user prefs
        }

        // [v4.0.0] New Function: Get data from localStorage
        function getLocalData() {
            let dataString = localStorage.getItem('timeBankData');
            let loadedFromBackup = false;
            try {
                if (!dataString) return null; 
                const parsedData = JSON.parse(dataString);
                if (!parsedData.version || !Array.isArray(parsedData.tasks)) { throw new Error("Main data is malformed."); }
                return parsedData;
            } catch (error) {
                console.error('Failed to load main data:', error);
                const backupString = localStorage.getItem('timeBankData_backup');
                if (backupString) {
                    console.log("Attempting to load from backup...");
                    try {
                        const backupData = JSON.parse(backupString);
                         if (!backupData.version || !Array.isArray(backupData.tasks)) { throw new Error("Backup data is also malformed."); }
                        localStorage.setItem('timeBankData', backupString); // Restore backup
                        alert("æœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥ï¼Œå·²ä»ä¸Šä¸€æ¬¡çš„å¤‡ä»½ä¸­æˆåŠŸæ¢å¤ã€‚");
                        return backupData;
                    } catch (backupError) { 
                        console.error('Failed to load backup data:', backupError); 
                        alert("ä¸¥é‡é”™è¯¯ï¼šæœ¬åœ°ä¸»æ•°æ®å’Œå¤‡ä»½æ•°æ®å‡å·²æŸåï¼Œæ— æ³•æ¢å¤ã€‚");
                        return null;
                    }
                } else { 
                    alert("é”™è¯¯ï¼šæœ¬åœ°æ•°æ®åŠ è½½å¤±è´¥ä¸”æœªæ‰¾åˆ°å¤‡ä»½ã€‚");
                    return null;
                }
            }
        }
        
        // [v4.0.0] Renamed from applyLoadedData
        // [v4.3.0] Updated migration logic
        function applyDataState(data) {
            let dataWasRepaired = false;
            
            if (data) {
                const originalTransactions = JSON.stringify(data.transactions);
                data = repairAndMigrateData(data); 
                if(JSON.stringify(data.transactions) !== originalTransactions) { dataWasRepaired = true; } 
                
                const defaultReportState = { flowChartPeriod: '7d', tableSortKey: 'amount_abs_desc', insightView: 'chart', insightSubViewIndex: 0, tableVisibleRows: 10 }; 
                data.reportState = { ...reportState, ...defaultReportState, ...(data.reportState || {}) };
                
                // Data migration for older versions
                if (Array.isArray(data.tasks)) {
                    data.tasks.forEach(task => {
                        if (task.isHabit && task.habitDetails) {
                            if (task.habitDetails.targetCountInPeriod === undefined) {
                                task.habitDetails.targetCountInPeriod = 1; dataWasRepaired = true;
                            }
                            if (task.habitDetails.dailyLimit === undefined) {
                                task.habitDetails.dailyLimit = 1; dataWasRepaired = true;
                            }
                            if (task.habitDetails.isBroken === undefined) {
                                task.habitDetails.isBroken = false; dataWasRepaired = true;
                            }
                        }
                    });
                }
                if (Array.isArray(data.transactions)) {
                    data.transactions.forEach(t => {
                        if (t.isStreakAdvancement === undefined) {
                            // [v4.3.0] Set to false by default. Rebuild isn't needed here,
                            // it will run on the first backdate/undo.
                            t.isStreakAdvancement = false; dataWasRepaired = true;
                        }
                    });
                }

                if (!data.version || data.version < APP_VERSION || dataWasRepaired) { 
                    data.version = APP_VERSION; 
                    if (dataWasRepaired) console.log("Data repaired/migrated on load.");
                    // Don't save here, let the natural save process handle it
                } 
                
                currentBalance = data.currentBalance || 0; 
                tasks = data.tasks || []; 
                transactions = data.transactions || []; 
                transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 
                categoryColors = new Map(data.categoryColors || []); 
                collapsedCategories = new Set(data.collapsedCategories || []); 
                runningTasks = new Map(data.runningTasks || []); 
                dailyChanges = data.dailyChanges || {}; 
                notificationSettings = { ...notificationSettings, ...(data.notificationSettings || {}) }; 
                reportState = data.reportState;
                earnTabViewMode = data.earnTabViewMode || 'recent'; // [v4.4.0] Load new state
            } else {
                // No data provided (e.g., new user), apply defaults
                resetLocalData();
            }
        }

        function repairAndMigrateData(data) { if (!data.transactions || !Array.isArray(data.transactions) || !Array.isArray(data.tasks)) { return data; } let repairedCount = 0; const taskNameMap = new Map(data.tasks.map(task => [task.name, task.id])); data.transactions.forEach(t => { let needsUpdate = false; if (!t.taskId && t.description) { const match = t.description.match(/"([^"]+)"/); if (match && match[1]) { const taskNameInDesc = match[1]; if (taskNameMap.has(taskNameInDesc)) { t.taskId = taskNameMap.get(taskNameInDesc); if (!t.taskName) { t.taskName = taskNameInDesc; } repairedCount++; needsUpdate = true; } } } if (!t.type) { const isEarn = t.amount > 0; t.type = isEarn ? 'earn' : 'spend'; t.amount = Math.abs(t.amount); needsUpdate = true; } }); if (repairedCount > 0) { console.log(`[Data Repair] Successfully repaired ${repairedCount} transactions by adding missing task IDs.`); } return data; }
        
        function renderColorSelectors(editingColor = null) { const usedColors = Array.from(categoryColors.values()); const render = (containerId, colors) => { const container = document.getElementById(containerId); container.innerHTML = colors.map(color => { const isUsed = usedColors.includes(color); const isDisabled = isUsed && color !== editingColor; const isSelected = color === currentSelectedColor; return `<div class="color-swatch ${isDisabled ? 'disabled' : ''} ${isSelected ? 'selected' : ''}" style="background-color: ${color};" data-color="${color}"><span class="checkmark">âœ”</span></div>`; }).join(''); }; render('earnColorSelector', earnColors); render('spendColorSelector', spendColors); }
        function handleColorSelection(event) { const swatch = event.target.closest('.color-swatch'); if (!swatch || swatch.classList.contains('disabled')) return; currentSelectedColor = swatch.dataset.color; const selector = swatch.parentElement; selector.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected')); swatch.classList.add('selected'); }
        function getRandomAvailableColor(taskType) { const isEarn = ['reward', 'continuous', 'continuous_target'].includes(taskType); const colorPalette = isEarn ? earnColors : spendColors; const usedColors = new Set(Array.from(categoryColors.values())); const availableColors = colorPalette.filter(c => !usedColors.has(c)); if (availableColors.length > 0) { return availableColors[Math.floor(Math.random() * availableColors.length)]; } return colorPalette[Math.floor(Math.random() * colorPalette.length)]; }
        
        // --- Global Event Listeners ---
        function setupTaskModalEventListeners() {
            document.getElementById('isHabitToggle').addEventListener('change', (e) => toggleHabitSettings(e.target.checked));
            document.getElementById('isReminderToggle').addEventListener('change', (e) => toggleReminderSettings(e.target.checked));
            document.getElementById('reminderModeSwitch').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') switchReminderMode(e.target.dataset.mode);
            });
            document.getElementById('earnColorSelector').addEventListener('click', handleColorSelection);
            document.getElementById('spendColorSelector').addEventListener('click', handleColorSelection);
            
            // [v4.0.0] Toggle email field based on auth action
            document.getElementById('registerButton').addEventListener('click', () => {
                document.getElementById('authEmailGroup').classList.remove('hidden');
            });
            document.getElementById('loginButton').addEventListener('click', () => {
                document.getElementById('authEmailGroup').classList.add('hidden');
            });
        }
        document.addEventListener('DOMContentLoaded', initApp);
        window.addEventListener('beforeunload', () => {
             // [v4.0.0] Only save locally on unload if not logged in
             if (!AV.User.current()) {
                saveData();
             }
        });
        document.addEventListener('click', e => { if (e.target.classList.contains('modal')) { if (e.target.id === 'taskModal') hideTaskModal(); else if (e.target.id === 'historyModal') hideHistoryModal(); else if (e.target.id === 'dayDetailModal') hideDayDetailModal(); else if (e.target.id === 'backdateModal') hideBackdateModal(); } });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { if (document.getElementById('taskModal').classList.contains('show')) hideTaskModal(); else if (document.getElementById('historyModal').classList.contains('show')) hideHistoryModal(); else if (document.getElementById('dayDetailModal').classList.contains('show')) hideDayDetailModal(); else if (document.getElementById('backdateModal').classList.contains('show')) hideBackdateModal(); } else if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); showTaskModal(); } });
        document.addEventListener('touchstart', function(event) { const target = event.target.closest('.task-name-scrollable'); if (target) { target.style.overflowX = 'auto'; target.style.textOverflow = 'clip'; } }, { passive: true });
        document.addEventListener('touchend', function(event) { const target = event.target.closest('.task-name-scrollable'); setTimeout(() => { if (target && !target.matches(':hover') && !target.matches(':focus')) { target.style.overflowX = 'hidden'; target.style.textOverflow = 'ellipsis'; } }, 500); }, { passive: true });
        document.addEventListener('focusout', function(event) { const target = event.target; if (target && target.classList && target.classList.contains('task-name-scrollable')) { if (!target.matches(':hover')) { target.style.overflowX = 'hidden'; target.style.textOverflow = 'ellipsis'; } } }, true);
        document.addEventListener('mouseleave', function(event) { const target = event.target; if (target && target.classList && target.classList.contains('task-name-scrollable')) { if (document.activeElement !== target) { target.style.overflowX = 'hidden'; target.style.textOverflow = 'ellipsis'; } } }, true);
    </script>

    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/time-bank/sw.js')
          .then(reg => console.log('âœ… PWA å·²å¯ç”¨'))
          .catch(err => console.log('âŒ é”™è¯¯:', err));
      });
    }
    </script>
</html>