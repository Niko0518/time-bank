<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¶é—´é“¶è¡Œ - Time Bank v2.85</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* CSSå˜é‡å®šä¹‰ - æ”¯æŒäº®è‰²å’Œæš—è‰²ä¸»é¢˜ */
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.1);
            --text-color: #333;
            --border-color: #ddd;
            --input-bg: #fff;
            --header-text: white;
            --section-title-color: white;
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --card-bg: rgba(42, 42, 42, 0.95);
            --card-shadow: rgba(0, 0, 0, 0.3);
            --text-color: #e0e0e0 !important;
            --border-color: #444;
            --input-bg: #2a2a2a;
            --header-text: #e0e0e0;
            --section-title-color: #e0e0e0 !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨æ ‡ç­¾æ ç•™å‡ºç©ºé—´ */
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            padding: 20px;
            color: var(--header-text);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .balance-card {
            margin: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .balance-card.negative {
            background: rgba(255, 235, 238, 0.95);
            border: 2px solid #f44336;
        }

        .balance-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .daily-changes {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .daily-change {
            color: #666;
        }

        /* æ ‡ç­¾é¡µ */
        .tab-content {
            display: none;
            padding: 0 20px;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 20px 0 15px 0;
            color: var(--section-title-color);
        }

        /* æœ€è¿‘ä»»åŠ¡ç½‘æ ¼å¸ƒå±€ - ä¸€è¡Œä¸¤ä¸ªï¼Œæ˜¾ç¤ºä¸‰è¡Œï¼ˆå…±6ä¸ªï¼‰ */
        .recent-tasks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* åˆ†ç±»ä»»åŠ¡ç½‘æ ¼å¸ƒå±€ - ä¸€è¡Œä¸¤ä¸ª */
        .category-tasks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* ä»»åŠ¡å¡ç‰‡ - ç²¾ç®€ç‰ˆ */
        .task-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 16px var(--card-shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .task-card.compact {
            padding: 10px;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .task-info {
            flex: 1;
            min-width: 0;
        }

        .task-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-name-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .task-edit-btn {
            background: none;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            color: #666;
            padding: 2px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .task-edit-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .task-details {
            font-size: 0.75rem;
            color: #666;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .task-category {
            background: #2196F3;
            color: white;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .task-completion-count {
            color: #4CAF50;
            font-weight: 500;
            font-size: 0.7rem;
        }

        /* ç²¾ç®€ç‰ˆæŒ‰é’®å¸ƒå±€ */
        .task-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .task-actions.compact {
            gap: 3px;
        }
            max-width: 50%;
        }

        .task-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 36px; /* ç²¾ç®€ç‰ˆæ›´å°çš„æœ€å°å°ºå¯¸ */
            text-align: center;
        }

        .task-btn.compact {
            padding: 3px 6px;
            font-size: 0.65rem;
            min-width: 32px;
        }

        .task-btn.edit {
            background: #f5f5f5;
            color: #666;
            padding: 5px 8px;
            min-width: 36px;
        }

        .task-btn.primary {
            background: #2196F3;
            color: white;
        }

        .task-btn.success {
            background: #4CAF50;
            color: white;
        }

        .task-btn.warning {
            background: #FF9800;
            color: white;
        }

        .task-btn.danger {
            background: #f44336;
            color: white;
        }

        .task-btn.secondary {
            background: #9E9E9E;
            color: white;
        }

        .task-btn.info {
            background: #17a2b8;
            color: white;
        }

        .task-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .task-timer {
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2196F3;
        }

        .task-progress {
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
        }

        /* åˆ†ç±»ä»»åŠ¡ */
        .category-tasks {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-header:hover {
            background: rgba(255, 255, 255, 1);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .category-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .category-count {
            color: #666;
            font-size: 0.85rem;
        }

        .category-toggle {
            transition: transform 0.2s ease;
            font-size: 0.8rem;
            color: #666;
        }

        .category-header.collapsed .category-toggle {
            transform: rotate(-90deg);
        }

        .category-tasks-list {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-tasks-list.collapsed {
            max-height: 0;
        }

        /* æœ€è¿‘ä»»åŠ¡ */
        .recent-tasks {
            margin-bottom: 30px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            padding: 40px 20px;
        }

        /* æ‚¬æµ®æŒ‰é’® */
        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6);
        }

        /* åº•éƒ¨æ ‡ç­¾æ  */
        .bottom-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .tab-button {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: none;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            color: #666;
        }

        .tab-button.active {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .tab-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .form-input.error, .form-select.error {
            border-color: #f44336;
        }

        .error-message {
            color: #f44336;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        /* æ—¶é—´é¢„è®¾æŒ‰é’® */
        .time-presets {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .time-preset {
            padding: 6px 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-preset:hover {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        /* åˆ†ç±»æ¨è */
        .recommendations {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .recommendation-item {
            padding: 4px 8px;
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .recommendation-item:hover {
            background: #2196F3;
            color: white;
        }

        /* è¡¨å•æŒ‰é’® */
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* æŠ¥å‘Šé¡µé¢ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }

        .transaction-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .transaction-time {
            font-size: 0.8rem;
            color: #666;
        }

        .transaction-amount {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .transaction-amount.positive {
            color: #4CAF50;
        }

        .transaction-amount.negative {
            color: #f44336;
        }

        /* è®¾ç½®é¡µé¢ */
        .settings-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .settings-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-info {
            flex: 1;
        }

        .setting-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .setting-desc {
            font-size: 0.85rem;
            color: #666;
        }

        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .threshold-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        /* æ•°æ®ç®¡ç†æŒ‰é’® */
        .data-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .data-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            background: white;
            color: #2196F3;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .data-btn:hover {
            background: #2196F3;
            color: white;
        }

        .file-input {
            display: none;
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ä¼˜åŒ– */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .balance-amount {
                font-size: 2rem;
            }

            .balance-card {
                margin: 15px;
                padding: 15px;
            }

            .tab-content {
                padding: 0 15px;
            }

            /* ä»»åŠ¡å¡ç‰‡ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .task-card {
                padding: 12px;
                margin-bottom: 8px;
            }

            .task-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .task-actions {
                max-width: 100%;
                justify-content: flex-start;
                gap: 8px;
            }

            .task-btn {
                flex: 1;
                min-width: 0;
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .task-btn.edit {
                flex: 0 0 auto;
                min-width: 44px;
                padding: 8px;
            }

            /* å½“æŒ‰é’®è¶…è¿‡3ä¸ªæ—¶ï¼Œä½¿ç”¨ç½‘æ ¼å¸ƒå±€ */
            .task-actions.many-buttons {
                display: grid;
                grid-template-columns: auto 1fr 1fr;
                gap: 8px;
            }

            .task-actions.many-buttons .task-btn.edit {
                grid-row: 1 / 3;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }

            .form-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .data-buttons {
                flex-direction: column;
            }

            /* åº•éƒ¨æ ‡ç­¾æ ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .tab-button {
                padding: 10px 4px;
                font-size: 0.7rem;
            }

            .tab-icon {
                font-size: 1.1rem;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            .task-btn {
                font-size: 0.75rem;
                padding: 6px 8px;
            }

            .balance-amount {
                font-size: 1.8rem;
            }

            .header h1 {
                font-size: 1.3rem;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 10px;
            }

            .balance-card {
                margin: 10px;
                padding: 15px;
            }

            .balance-amount {
                font-size: 1.8rem;
            }

            .fab {
                bottom: 80px;
                right: 15px;
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }
        }

        /* ä»»åŠ¡å†å²æ¨¡æ€æ¡†æ ·å¼ */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            flex: 1;
        }

        .history-description {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .history-time {
            font-size: 0.8rem;
            color: #666;
        }

        .history-amount {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .history-amount.positive {
            color: #4CAF50;
        }

        .history-amount.negative {
            color: #f44336;
        }

        /* ä¸»é¢˜åˆ‡æ¢åŠ¨ç”» */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* æš—è‰²ä¸»é¢˜ä¸‹çš„æ¨¡æ€æ¡† */
        [data-theme="dark"] .modal-content {
            background: var(--card-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .form-label {
            color: var(--text-color);
        }

        [data-theme="dark"] .form-input,
        [data-theme="dark"] .form-select {
            background: var(--input-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .settings-title {
            color: var(--text-color);
        }

        [data-theme="dark"] .category-header {
            background: var(--card-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .category-header:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .bottom-tabs {
            background: var(--card-bg);
            border-top-color: var(--border-color);
        }

        [data-theme="dark"] .tab-button {
            color: #999;
        }

        [data-theme="dark"] .tab-button.active {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.2);
        }

        [data-theme="dark"] .task-edit-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>æ—¶é—´é“¶è¡Œ</h1>
        <p>Time Bank v2.85 - è®©æ—¶é—´æ›´æœ‰ä»·å€¼</p>
    </div>

    <!-- ä½™é¢å¡ç‰‡ -->
    <div class="balance-card" id="balanceCard">
        <div class="balance-title">å½“å‰ä½™é¢</div>
        <div class="balance-amount" id="balanceAmount">0ç§’</div>
        <div class="daily-changes">
            <div class="daily-change">ä»Šæ—¥è·å¾—: <span id="dailyEarned">0ç§’</span></div>
            <div class="daily-change">ä»Šæ—¥æ¶ˆè´¹: <span id="dailySpent">0ç§’</span></div>
        </div>
    </div>

    <!-- æ ‡ç­¾é¡µå†…å®¹ -->
    <!-- è·å¾—æ—¶é—´æ ‡ç­¾é¡µ -->
    <div class="tab-content active" id="earnTab">
        <div class="recent-tasks">
            <div class="section-title">æœ€è¿‘ä»»åŠ¡</div>
            <div id="recentEarnTasks"></div>
        </div>
        
        <div class="section-title">åˆ†ç±»ä»»åŠ¡</div>
        <div id="categoryEarnTasks"></div>
    </div>

    <!-- æ¶ˆè´¹æ—¶é—´æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="spendTab">
        <div class="recent-tasks">
            <div class="section-title">æœ€è¿‘ä»»åŠ¡</div>
            <div id="recentSpendTasks"></div>
        </div>
        
        <div class="section-title">åˆ†ç±»ä»»åŠ¡</div>
        <div id="categorySpendTasks"></div>
    </div>

    <!-- æŠ¥å‘Šæ ‡ç­¾é¡µ -->
    <div class="tab-content" id="reportTab">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalEarned">0ç§’</div>
                <div class="stat-label">æ€»è·å¾—æ—¶é—´</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">0ç§’</div>
                <div class="stat-label">æ€»æ¶ˆè´¹æ—¶é—´</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedTasks">0</div>
                <div class="stat-label">å·²å®Œæˆä»»åŠ¡</div>
            </div>
        </div>
        
        <div class="section-title">æœ€è¿‘äº¤æ˜“</div>
        <div class="transaction-list" id="transactionList">
            <div class="empty-message">æš‚æ— äº¤æ˜“è®°å½•</div>
        </div>
    </div>

    <!-- è®¾ç½®æ ‡ç­¾é¡µ -->
    <div class="tab-content" id="settingsTab">
        <!-- ä¸»é¢˜è®¾ç½® -->
        <div class="settings-section">
            <div class="settings-title">å¤–è§‚è®¾ç½®</div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">æš—è‰²ä¸»é¢˜</div>
                    <div class="setting-desc">å¼€å¯æš—è‰²æ¨¡å¼ä»¥ä¿æŠ¤çœ¼ç›</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="darkThemeToggle" onchange="toggleDarkTheme()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- é€šçŸ¥è®¾ç½® -->
        <div class="settings-section">
            <div class="settings-title">é€šçŸ¥è®¾ç½®</div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">å¯ç”¨é€šçŸ¥</div>
                    <div class="setting-desc">å…è®¸åº”ç”¨å‘é€æ¡Œé¢é€šçŸ¥</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="notificationToggle" onchange="toggleNotifications()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">æˆå°±é€šçŸ¥</div>
                    <div class="setting-desc">å®Œæˆä»»åŠ¡æ—¶æ˜¾ç¤ºé€šçŸ¥</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="achievementNotificationToggle" onchange="toggleAchievementNotifications()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">é•¿æ—¶é—´è¿è¡Œæé†’</div>
                    <div class="setting-desc">ä»»åŠ¡è¿è¡Œè¶…è¿‡è®¾å®šæ—¶é—´æ—¶æé†’</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="longRunningNotificationToggle" onchange="toggleLongRunningNotifications()">
                    <span class="slider"></span>
                </label>
                <input type="number" id="longRunningThreshold" class="threshold-input" 
                       value="3600" min="300" step="300" onchange="updateLongRunningThreshold()" 
                       placeholder="ç§’">
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">ä½™é¢ä¸è¶³æé†’</div>
                    <div class="setting-desc">ä½™é¢ä½äºè®¾å®šå€¼æ—¶æé†’</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="lowBalanceNotificationToggle" onchange="toggleLowBalanceNotifications()">
                    <span class="slider"></span>
                </label>
                <input type="number" id="lowBalanceThreshold" class="threshold-input" 
                       value="1800" min="0" step="300" onchange="updateLowBalanceThreshold()" 
                       placeholder="ç§’">
            </div>
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">ä»»åŠ¡é•¿æ—¶é—´æœªæ´»åŠ¨æé†’</div>
                    <div class="setting-desc">ä»»åŠ¡é•¿æ—¶é—´æœªä½¿ç”¨æ—¶æé†’</div>
                </div>
                <label class="switch">
                    <input type="checkbox" id="inactiveTaskNotificationToggle" onchange="toggleInactiveTaskNotifications()">
                    <span class="slider"></span>
                </label>
                <input type="number" id="inactiveTaskThreshold" class="threshold-input" 
                       value="86400" min="3600" step="3600" onchange="updateInactiveTaskThreshold()" 
                       placeholder="ç§’">
            </div>
        </div>

        <!-- æ•°æ®ç®¡ç† -->
        <div class="settings-section">
            <div class="settings-title">æ•°æ®ç®¡ç†</div>
            <div class="data-buttons">
                <button class="data-btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                <button class="data-btn" onclick="document.getElementById('importFile').click()">å¯¼å…¥æ•°æ®</button>
                <button class="data-btn" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
            </div>
            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
        </div>
    </div>

    <!-- æ‚¬æµ®æŒ‰é’® -->
    <button class="fab" id="fabButton" onclick="showTaskModal()">+</button>

    <!-- åº•éƒ¨æ ‡ç­¾æ  -->
    <div class="bottom-tabs">
        <button class="tab-button active" onclick="switchTab('earn')">
            <div class="tab-icon">â°</div>
            <div>è·å¾—æ—¶é—´</div>
        </button>
        <button class="tab-button" onclick="switchTab('spend')">
            <div class="tab-icon">ğŸ¯</div>
            <div>æ¶ˆè´¹æ—¶é—´</div>
        </button>
        <button class="tab-button" onclick="switchTab('report')">
            <div class="tab-icon">ğŸ“Š</div>
            <div>æŠ¥å‘Š</div>
        </button>
        <button class="tab-button" onclick="switchTab('settings')">
            <div class="tab-icon">âš™ï¸</div>
            <div>è®¾ç½®</div>
        </button>
    </div>

    <!-- ä»»åŠ¡æ¨¡æ€æ¡† -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">åˆ›å»ºæ–°ä»»åŠ¡</div>
                <button class="close-btn" onclick="hideTaskModal()">Ã—</button>
            </div>
            <form id="taskForm" onsubmit="saveTask(event)">
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡åç§° *</label>
                    <input type="text" id="taskName" class="form-input" placeholder="è¾“å…¥ä»»åŠ¡åç§°" required>
                    <div class="error-message" id="taskNameError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡åˆ†ç±» *</label>
                    <input type="text" id="taskCategory" class="form-input" placeholder="è¾“å…¥åˆ†ç±»åç§°" required>
                    <div class="recommendations" id="categoryRecommendations"></div>
                    <div class="error-message" id="taskCategoryError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡ç±»å‹ *</label>
                    <select id="taskType" class="form-select" onchange="updateFormFields()" required>
                        <option value="">è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹</option>
                        <option value="reward">å›ºå®šå¥–åŠ±</option>
                        <option value="continuous">æŒç»­å¥–åŠ±</option>
                        <option value="continuous_target">è¾¾æ ‡å¥–åŠ±</option>
                        <option value="instant_redeem">å³æ—¶å…‘æ¢</option>
                        <option value="continuous_redeem">æŒç»­æ¶ˆè€—</option>
                    </select>
                    <div class="error-message" id="taskTypeError"></div>
                </div>

                <!-- å›ºå®šæ—¶é—´å­—æ®µï¼ˆå›ºå®šå¥–åŠ±ä»»åŠ¡ä¸“ç”¨ï¼‰ -->
                <div class="form-group hidden" id="fixedTimeGroup">
                    <label class="form-label">å¥–åŠ±æ—¶é—´ (ç§’) *</label>
                    <input type="text" id="fixedTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800ï¼ˆ30åˆ†é’Ÿï¼‰">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 900)">15åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 1800)">30åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 3600)">1å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('fixedTime', 5400)">1.5å°æ—¶</div>
                    </div>
                    <div class="error-message" id="fixedTimeError"></div>
                </div>

                <!-- æ¶ˆè´¹æ—¶é—´å­—æ®µï¼ˆå³æ—¶æ¶ˆè´¹ä»»åŠ¡ä¸“ç”¨ï¼‰ -->
                <div class="form-group hidden" id="consumeTimeGroup">
                    <label class="form-label">æ¶ˆè´¹æ—¶é—´ (ç§’) *</label>
                    <input type="text" id="consumeTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800ï¼ˆ30åˆ†é’Ÿï¼‰">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 900)">15åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 1800)">30åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 3600)">1å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('consumeTime', 5400)">1.5å°æ—¶</div>
                    </div>
                    <div class="error-message" id="consumeTimeError"></div>
                </div>

                <!-- å€ç‡å­—æ®µï¼ˆè¿ç»­ä»»åŠ¡ä¸“ç”¨ï¼‰ -->
                <div class="form-group hidden" id="multiplierGroup">
                    <label class="form-label">æ—¶é—´å€ç‡ *</label>
                    <input type="text" id="multiplier" class="form-input" placeholder="ä¾‹å¦‚ï¼š1.0ï¼ˆ1å€ç‡ï¼‰">
                    <div class="error-message" id="multiplierError"></div>
                </div>

                <!-- ç›®æ ‡æ—¶é•¿å­—æ®µï¼ˆè¾¾æ ‡ä»»åŠ¡ä¸“ç”¨ï¼‰ -->
                <div class="form-group hidden" id="targetTimeGroup">
                    <label class="form-label">ç›®æ ‡æ—¶é•¿ (ç§’) *</label>
                    <input type="text" id="targetTime" class="form-input" placeholder="ä¾‹å¦‚ï¼š3600ï¼ˆ1å°æ—¶ï¼‰">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('targetTime', 1800)">30åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 3600)">1å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 5400)">1.5å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('targetTime', 7200)">2å°æ—¶</div>
                    </div>
                    <div class="error-message" id="targetTimeError"></div>
                </div>

                <!-- é¢å¤–å¥–åŠ±å­—æ®µï¼ˆè¾¾æ ‡ä»»åŠ¡ä¸“ç”¨ï¼‰ -->
                <div class="form-group hidden" id="bonusRewardGroup">
                    <label class="form-label">é¢å¤–å¥–åŠ± (ç§’) *</label>
                    <input type="text" id="bonusReward" class="form-input" placeholder="ä¾‹å¦‚ï¼š1800ï¼ˆ30åˆ†é’Ÿï¼‰">
                    <div class="time-presets">
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 900)">15åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 1800)">30åˆ†é’Ÿ</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 3600)">1å°æ—¶</div>
                        <div class="time-preset" onclick="setTimePreset('bonusReward', 5400)">1.5å°æ—¶</div>
                    </div>
                    <div class="error-message" id="bonusRewardError"></div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideTaskModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">åˆ›å»ºä»»åŠ¡</button>
                    <button type="button" class="btn btn-danger hidden" id="deleteBtn" onclick="deleteTask()">åˆ é™¤ä»»åŠ¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ä»»åŠ¡å†å²æ¨¡æ€æ¡† -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="historyModalTitle">ä»»åŠ¡å†å²</div>
                <button class="close-btn" onclick="hideHistoryModal()">Ã—</button>
            </div>
            <div id="historyContent">
                <div class="empty-message">æš‚æ— å†å²è®°å½•</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentBalance = 0;
        let tasks = [];
        let transactions = [];
        let categoryColors = new Map();
        let collapsedCategories = new Set();
        let runningTasks = new Map(); // å­˜å‚¨è¿è¡Œä¸­çš„ä»»åŠ¡çŠ¶æ€
        let currentEditingTask = null;
        let timerInterval = null; // å…¨å±€è®¡æ—¶å™¨
        let dailyChanges = {}; // æ¯æ—¥å˜åŒ–è®°å½•
        let currentHistoryTask = null; // å½“å‰æŸ¥çœ‹å†å²çš„ä»»åŠ¡
        
        // é€šçŸ¥è®¾ç½®
        let notificationSettings = {
            enabled: false,
            achievement: true,
            longRunning: true,
            longRunningThreshold: 3600,
            lowBalance: true,
            lowBalanceThreshold: 1800,
            inactiveTask: false,
            inactiveTaskThreshold: 86400
        };

        // é¢œè‰²é…ç½®
        const colors = [
            '#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#F44336',
            '#00BCD4', '#8BC34A', '#FFC107', '#E91E63', '#607D8B',
            '#3F51B5', '#009688', '#CDDC39', '#795548', '#FF5722'
        ];

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            loadData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            updateCategoryRecommendations();
            updateNotificationSettings();
            
            // å¯åŠ¨å…¨å±€è®¡æ—¶å™¨
            startGlobalTimer();
            
            // è¯·æ±‚é€šçŸ¥æƒé™
            if ('Notification' in window && Notification.permission === 'default') {
                requestNotificationPermission();
            }
        }

        // å¯åŠ¨å…¨å±€è®¡æ—¶å™¨
        function startGlobalTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            timerInterval = setInterval(() => {
                updateRunningTimers();
            }, 1000);
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾æŒ‰é’®
            event.target.closest('.tab-button').classList.add('active');
            
            // æ ¹æ®æ ‡ç­¾é¡µæ›´æ–°æ‚¬æµ®æŒ‰é’®æ˜¾ç¤º
            const fabButton = document.getElementById('fabButton');
            if (tabName === 'report' || tabName === 'settings') {
                fabButton.style.display = 'none';
            } else {
                fabButton.style.display = 'block';
            }
        }

        // æ›´æ–°æœ€è¿‘ä»»åŠ¡ - ä¿®å¤æ’åºè§†è§‰è·³è·ƒé—®é¢˜å¹¶å¢åŠ æ˜¾ç¤ºæ•°é‡åˆ°6ä¸ª
        function updateRecentTasks() {
            const earnTasks = tasks.filter(t => t.type === 'reward' || t.type === 'continuous' || t.type === 'continuous_target');
            const spendTasks = tasks.filter(t => t.type === 'instant_redeem' || t.type === 'continuous_redeem');
            
            // æŒ‰æœ€åä½¿ç”¨æ—¶é—´æ’åºï¼Œç¡®ä¿åŠ¨æ€æ›´æ–°
            const sortByLastUsed = (taskList) => {
                return [...taskList].sort((a, b) => {
                    if (!a.lastUsed && !b.lastUsed) return 0;
                    if (!a.lastUsed) return 1;
                    if (!b.lastUsed) return -1;
                    return new Date(b.lastUsed) - new Date(a.lastUsed);
                }).slice(0, 6); // å¢åŠ åˆ°6ä¸ªä»»åŠ¡
            };
            
            const recentEarnTasks = sortByLastUsed(earnTasks);
            const recentSpendTasks = sortByLastUsed(spendTasks);
            
            renderTaskList('recentEarnTasks', recentEarnTasks);
            renderTaskList('recentSpendTasks', recentSpendTasks);
        }

        // æ›´æ–°åˆ†ç±»ä»»åŠ¡
        function updateCategoryTasks() {
            const earnTasks = tasks.filter(t => t.type === 'reward' || t.type === 'continuous' || t.type === 'continuous_target');
            const spendTasks = tasks.filter(t => t.type === 'instant_redeem' || t.type === 'continuous_redeem');
            
            const earnTasksByCategory = groupTasksByCategory(earnTasks);
            const spendTasksByCategory = groupTasksByCategory(spendTasks);
            
            renderCategoryTasks('categoryEarnTasks', earnTasksByCategory);
            renderCategoryTasks('categorySpendTasks', spendTasksByCategory);
        }

        // æŒ‰åˆ†ç±»åˆ†ç»„ä»»åŠ¡
        function groupTasksByCategory(taskList) {
            const grouped = {};
            taskList.forEach(task => {
                if (!grouped[task.category]) {
                    grouped[task.category] = [];
                }
                grouped[task.category].push(task);
            });
            return grouped;
        }

        // æ¸²æŸ“åˆ†ç±»ä»»åŠ¡
        function renderCategoryTasks(containerId, tasksByCategory) {
            const container = document.getElementById(containerId);
            
            if (Object.keys(tasksByCategory).length === 0) {
                container.innerHTML = '<div class="empty-message">æš‚æ— ä»»åŠ¡</div>';
                return;
            }
            
            let html = '';
            Object.entries(tasksByCategory).forEach(([category, categoryTasks]) => {
                const isCollapsed = collapsedCategories.has(category);
                const color = categoryColors.get(category) || '#666';
                
                html += `
                    <div class="category-tasks">
                        <div class="category-header ${isCollapsed ? 'collapsed' : ''}" onclick="toggleCategory('${category}')">
                            <div class="category-info">
                                <div class="category-color" style="background-color: ${color}"></div>
                                <div class="category-name">${category}</div>
                                <div class="category-count">(${categoryTasks.length})</div>
                            </div>
                            <div class="category-toggle">â–¼</div>
                        </div>
                        <div class="category-tasks-list ${isCollapsed ? 'collapsed' : ''}">
                            <div class="category-tasks-grid">${renderTaskCards(categoryTasks, true)}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ - æœ€è¿‘ä»»åŠ¡ä½¿ç”¨ç½‘æ ¼å¸ƒå±€ï¼Œæ”¯æŒ6ä¸ªä»»åŠ¡
        function renderTaskList(containerId, taskList) {
            const container = document.getElementById(containerId);
            
            if (taskList.length === 0) {
                container.innerHTML = '<div class="empty-message">æš‚æ— æœ€è¿‘ä»»åŠ¡</div>';
                return;
            }
            
            // ä¸ºæœ€è¿‘ä»»åŠ¡ä½¿ç”¨ç½‘æ ¼å¸ƒå±€ï¼Œæ”¯æŒ6ä¸ªä»»åŠ¡ï¼ˆ2åˆ—x3è¡Œï¼‰
            if (containerId === 'recentEarnTasks' || containerId === 'recentSpendTasks') {
                container.innerHTML = `<div class="recent-tasks-grid">${renderTaskCards(taskList, true)}</div>`;
            } else {
                container.innerHTML = renderTaskCards(taskList);
            }
        }

        // æ¸²æŸ“ä»»åŠ¡å¡ç‰‡ - æ”¹è¿›ç‰ˆæœ¬ï¼Œæ”¯æŒç²¾ç®€æ¨¡å¼
        function renderTaskCards(taskList, isCompact = false) {
            return taskList.map(task => {
                const runningTask = runningTasks.get(task.id);
                const isRunning = !!runningTask;
                const isPaused = runningTask && runningTask.isPaused;
                const color = categoryColors.get(task.category) || '#666';
                
                let detailsHtml = `<span class="task-category" style="background-color: ${color}">${task.category}</span>`;
                
                // æ˜¾ç¤ºå®Œæˆæ¬¡æ•°
                if (task.completionCount && task.completionCount > 0) {
                    detailsHtml += ` <span class="task-completion-count">å·²å®Œæˆ ${task.completionCount} æ¬¡</span>`;
                }
                
                let actionsHtml = '';
                let progressHtml = '';
                
                if (task.type === 'reward') {
                    detailsHtml += ` â€¢ å¥–åŠ± ${formatTime(task.fixedTime)}`;
                    actionsHtml = `
                        <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                        <button class="task-btn success" onclick="completeTask('${task.id}')">å®Œæˆ</button>
                    `;
                } else if (task.type === 'continuous') {
                    detailsHtml += ` â€¢ ${task.multiplier}å€ç‡`;
                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        if (isPaused) {
                            actionsHtml = `
                                <button class="task-btn primary" onclick="resumeTask('${task.id}')">ç»§ç»­</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `<div class="task-timer">å·²æš‚åœï¼š${formatTime(totalSeconds)}</div>`;
                        } else {
                            actionsHtml = `
                                <button class="task-btn warning" onclick="pauseTask('${task.id}')">æš‚åœ</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `<div class="task-timer">è¿è¡Œä¸­ï¼š${formatTime(totalSeconds)}</div>`;
                        }
                    } else {
                        actionsHtml = `
                            <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                            <button class="task-btn primary" onclick="startTask('${task.id}')">å¼€å§‹</button>
                        `;
                    }
                } else if (task.type === 'continuous_target') {
                    // ä¿®å¤ç›®æ ‡æ—¶é—´æ˜¾ç¤ºï¼Œä¸æ˜¾ç¤º0ç§’
                    const targetTimeStr = formatTime(task.targetTime).replace(/0ç§’$/, '').trim();
                    detailsHtml += ` â€¢ ${task.multiplier}å€ç‡ â€¢ ç›®æ ‡ ${targetTimeStr}`;
                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        const progress = Math.min((totalSeconds / task.targetTime) * 100, 100);
                        if (isPaused) {
                            actionsHtml = `
                                <button class="task-btn primary" onclick="resumeTask('${task.id}')">ç»§ç»­</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `
                                <div class="task-timer">å·²æš‚åœï¼š${formatTime(totalSeconds)}</div>
                                <div class="task-progress">
                                    è¿›åº¦ï¼š${progress.toFixed(1)}% ${runningTask.achieved ? 'âœ… å·²è¾¾æ ‡' : ''}
                                </div>
                            `;
                        } else {
                            actionsHtml = `
                                <button class="task-btn warning" onclick="pauseTask('${task.id}')">æš‚åœ</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `
                                <div class="task-timer">è¿è¡Œä¸­ï¼š${formatTime(totalSeconds)}</div>
                                <div class="task-progress">
                                    è¿›åº¦ï¼š${progress.toFixed(1)}% ${runningTask.achieved ? 'âœ… å·²è¾¾æ ‡' : ''}
                                </div>
                            `;
                        }
                    } else {
                        actionsHtml = `
                            <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                            <button class="task-btn primary" onclick="startTask('${task.id}')">å¼€å§‹</button>
                        `;
                    }
                } else if (task.type === 'instant_redeem') {
                    detailsHtml += ` â€¢ æ¶ˆè´¹ ${formatTime(task.consumeTime)}`;
                    actionsHtml = `
                        <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                        <button class="task-btn danger" onclick="redeemTask('${task.id}')">å…‘æ¢</button>
                    `;
                } else if (task.type === 'continuous_redeem') {
                    detailsHtml += ` â€¢ ${task.multiplier}å€ç‡æ¶ˆè´¹`;
                    if (isRunning) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + (isPaused ? 0 : Date.now() - runningTask.startTime)) / 1000);
                        if (isPaused) {
                            actionsHtml = `
                                <button class="task-btn primary" onclick="resumeTask('${task.id}')">ç»§ç»­</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `<div class="task-timer">å·²æš‚åœï¼š${formatTime(totalSeconds)}</div>`;
                        } else {
                            actionsHtml = `
                                <button class="task-btn warning" onclick="pauseTask('${task.id}')">æš‚åœ</button>
                                <button class="task-btn secondary" onclick="cancelTask('${task.id}')">å–æ¶ˆ</button>
                                <button class="task-btn danger" onclick="stopTask('${task.id}')">ç»“æŸ</button>
                            `;
                            progressHtml = `<div class="task-timer">è¿è¡Œä¸­ï¼š${formatTime(totalSeconds)}</div>`;
                        }
                    } else {
                        actionsHtml = `
                            <button class="task-btn info" onclick="showTaskHistory('${task.id}')" title="å†å²">ğŸ“‹</button>
                            <button class="task-btn primary" onclick="startTask('${task.id}')">å¼€å§‹</button>
                        `;
                    }
                }
                
                // ç¼–è¾‘æŒ‰é’®
                const editBtnHtml = `<button class="task-edit-btn" onclick="editTask(tasks.find(t => t.id === '${task.id}'))" title="ç¼–è¾‘">âœï¸</button>`;
                
                const compactClass = isCompact ? 'compact' : '';
                const actionButtonCount = (actionsHtml.match(/task-btn/g) || []).length;
                const manyButtonsClass = actionButtonCount > 3 ? 'many-buttons' : '';
                
                return `
                    <div class="task-card ${compactClass}">
                        <div class="task-header">
                            <div class="task-info">
                                <div class="task-name">
                                    <span class="task-name-text" title="${task.name}">${task.name}</span>
                                    ${editBtnHtml}
                                </div>
                                <div class="task-details">${detailsHtml}</div>
                            </div>
                            <div class="task-actions ${compactClass} ${manyButtonsClass}">
                                ${actionsHtml}
                            </div>
                        </div>
                        ${progressHtml}
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°è¿è¡Œä¸­çš„è®¡æ—¶å™¨
        function updateRunningTimers() {
            let hasChanges = false;
            
            runningTasks.forEach((runningTask, taskId) => {
                if (!runningTask.isPaused) {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        const totalSeconds = Math.floor((runningTask.elapsedTime + Date.now() - runningTask.startTime) / 1000);
                        
                        // æ£€æŸ¥è¾¾æ ‡ä»»åŠ¡æ˜¯å¦è¾¾åˆ°ç›®æ ‡
                        if (task.type === 'continuous_target' && !runningTask.achieved && totalSeconds >= task.targetTime) {
                            runningTask.achieved = true;
                            showNotification('ğŸ¯ è¾¾æ ‡æé†’', `ä»»åŠ¡"${task.name}"å·²è¾¾åˆ°ç›®æ ‡æ—¶é—´ï¼`);
                            hasChanges = true;
                        }
                        
                        // æ£€æŸ¥é•¿æ—¶é—´è¿è¡Œæé†’
                        if (notificationSettings.enabled && notificationSettings.longRunning && 
                            totalSeconds > 0 && totalSeconds % notificationSettings.longRunningThreshold === 0) {
                            showNotification('â° é•¿æ—¶é—´è¿è¡Œæé†’', `ä»»åŠ¡"${task.name}"å·²è¿è¡Œ${formatTime(totalSeconds)}`);
                        }
                        
                        hasChanges = true;
                    }
                }
            });
            
            // åªæœ‰åœ¨æœ‰å˜åŒ–æ—¶æ‰æ›´æ–°ç•Œé¢
            if (hasChanges) {
                updateRecentTasks();
                updateCategoryTasks();
            }
        }

        // åˆ‡æ¢åˆ†ç±»æŠ˜å çŠ¶æ€
        function toggleCategory(category) {
            if (collapsedCategories.has(category)) {
                collapsedCategories.delete(category);
            } else {
                collapsedCategories.add(category);
            }
            saveData();
            updateCategoryTasks();
        }

        // æ˜¾ç¤ºä»»åŠ¡æ¨¡æ€æ¡†
        function showTaskModal() {
            currentEditingTask = null;
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºæ–°ä»»åŠ¡';
            document.getElementById('submitBtn').textContent = 'åˆ›å»ºä»»åŠ¡';
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('taskForm').reset();
            updateFormFields();
            document.getElementById('taskModal').classList.add('show');
        }

        // éšè—ä»»åŠ¡æ¨¡æ€æ¡†
        function hideTaskModal() {
            document.getElementById('taskModal').classList.remove('show');
            clearFormErrors();
        }

        // ç¼–è¾‘ä»»åŠ¡
        function editTask(task) {
            currentEditingTask = task;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ä»»åŠ¡';
            document.getElementById('submitBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
            document.getElementById('deleteBtn').classList.remove('hidden');
            
            // å¡«å……è¡¨å•
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskCategory').value = task.category;
            document.getElementById('taskType').value = task.type;
            
            if (task.fixedTime) document.getElementById('fixedTime').value = task.fixedTime;
            if (task.consumeTime) document.getElementById('consumeTime').value = task.consumeTime;
            if (task.multiplier) document.getElementById('multiplier').value = task.multiplier;
            if (task.targetTime) document.getElementById('targetTime').value = task.targetTime;
            if (task.bonusReward) document.getElementById('bonusReward').value = task.bonusReward;
            
            updateFormFields();
            document.getElementById('taskModal').classList.add('show');
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask() {
            if (!currentEditingTask) return;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${currentEditingTask.name}"å—ï¼Ÿ`)) {
                // å¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢å®ƒ
                if (runningTasks.has(currentEditingTask.id)) {
                    runningTasks.delete(currentEditingTask.id);
                }
                
                // ä»ä»»åŠ¡åˆ—è¡¨ä¸­åˆ é™¤
                tasks = tasks.filter(t => t.id !== currentEditingTask.id);
                
                saveData();
                updateRecentTasks();
                updateCategoryTasks();
                updateReports();
                hideTaskModal();
            }
        }

        // æ›´æ–°è¡¨å•å­—æ®µæ˜¾ç¤º
        function updateFormFields() {
            const taskType = document.getElementById('taskType').value;
            
            // éšè—æ‰€æœ‰å¯é€‰å­—æ®µ
            document.getElementById('fixedTimeGroup').classList.add('hidden');
            document.getElementById('consumeTimeGroup').classList.add('hidden');
            document.getElementById('multiplierGroup').classList.add('hidden');
            document.getElementById('targetTimeGroup').classList.add('hidden');
            document.getElementById('bonusRewardGroup').classList.add('hidden');
            
            // æ ¹æ®ä»»åŠ¡ç±»å‹æ˜¾ç¤ºç›¸åº”å­—æ®µ
            switch (taskType) {
                case 'reward':
                    document.getElementById('fixedTimeGroup').classList.remove('hidden');
                    break;
                case 'continuous':
                    document.getElementById('multiplierGroup').classList.remove('hidden');
                    break;
                case 'continuous_target':
                    document.getElementById('multiplierGroup').classList.remove('hidden');
                    document.getElementById('targetTimeGroup').classList.remove('hidden');
                    document.getElementById('bonusRewardGroup').classList.remove('hidden');
                    break;
                case 'instant_redeem':
                    document.getElementById('consumeTimeGroup').classList.remove('hidden');
                    break;
                case 'continuous_redeem':
                    document.getElementById('multiplierGroup').classList.remove('hidden');
                    break;
            }
        }

        // è®¾ç½®æ—¶é—´é¢„è®¾å€¼
        function setTimePreset(fieldId, seconds) {
            document.getElementById(fieldId).value = seconds;
        }

        // ä¿å­˜ä»»åŠ¡
        function saveTask(event) {
            event.preventDefault();
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
            clearFormErrors();
            
            // è·å–è¡¨å•æ•°æ®
            const formData = {
                name: document.getElementById('taskName').value.trim(),
                category: document.getElementById('taskCategory').value.trim(),
                type: document.getElementById('taskType').value
            };
            
            // éªŒè¯åŸºæœ¬å­—æ®µ
            let hasError = false;
            
            if (!formData.name) {
                showFieldError('taskName', 'è¯·è¾“å…¥ä»»åŠ¡åç§°');
                hasError = true;
            }
            
            if (!formData.category) {
                showFieldError('taskCategory', 'è¯·è¾“å…¥ä»»åŠ¡åˆ†ç±»');
                hasError = true;
            }
            
            if (!formData.type) {
                showFieldError('taskType', 'è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹');
                hasError = true;
            }
            
            // æ ¹æ®ä»»åŠ¡ç±»å‹éªŒè¯ç‰¹å®šå­—æ®µ
            if (formData.type === 'reward') {
                const fixedTime = parseInt(document.getElementById('fixedTime').value);
                if (!fixedTime || fixedTime <= 0) {
                    showFieldError('fixedTime', 'è¯·è¾“å…¥æœ‰æ•ˆçš„å¥–åŠ±æ—¶é—´');
                    hasError = true;
                } else {
                    formData.fixedTime = fixedTime;
                }
            } else if (formData.type === 'continuous') {
                const multiplier = parseFloat(document.getElementById('multiplier').value);
                if (!multiplier || multiplier <= 0) {
                    showFieldError('multiplier', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´å€ç‡');
                    hasError = true;
                } else {
                    formData.multiplier = multiplier;
                }
            } else if (formData.type === 'continuous_target') {
                const multiplier = parseFloat(document.getElementById('multiplier').value);
                const targetTime = parseInt(document.getElementById('targetTime').value);
                const bonusReward = parseInt(document.getElementById('bonusReward').value);
                
                if (!multiplier || multiplier <= 0) {
                    showFieldError('multiplier', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´å€ç‡');
                    hasError = true;
                } else {
                    formData.multiplier = multiplier;
                }
                
                if (!targetTime || targetTime <= 0) {
                    showFieldError('targetTime', 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡æ—¶é•¿');
                    hasError = true;
                } else {
                    formData.targetTime = targetTime;
                }
                
                if (!bonusReward || bonusReward <= 0) {
                    showFieldError('bonusReward', 'è¯·è¾“å…¥æœ‰æ•ˆçš„é¢å¤–å¥–åŠ±');
                    hasError = true;
                } else {
                    formData.bonusReward = bonusReward;
                }
            } else if (formData.type === 'instant_redeem') {
                const consumeTime = parseInt(document.getElementById('consumeTime').value);
                if (!consumeTime || consumeTime <= 0) {
                    showFieldError('consumeTime', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ¶ˆè´¹æ—¶é—´');
                    hasError = true;
                } else {
                    formData.consumeTime = consumeTime;
                }
            } else if (formData.type === 'continuous_redeem') {
                const multiplier = parseFloat(document.getElementById('multiplier').value);
                if (!multiplier || multiplier <= 0) {
                    showFieldError('multiplier', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´å€ç‡');
                    hasError = true;
                } else {
                    formData.multiplier = multiplier;
                }
            }
            
            if (hasError) return;
            
            // ä¿å­˜ä»»åŠ¡
            if (currentEditingTask) {
                // ç¼–è¾‘ç°æœ‰ä»»åŠ¡
                Object.assign(currentEditingTask, formData);
            } else {
                // åˆ›å»ºæ–°ä»»åŠ¡
                const newTask = {
                    id: Date.now().toString(),
                    ...formData,
                    completionCount: 0,
                    createdAt: new Date().toISOString()
                };
                tasks.push(newTask);
            }
            
            // æ›´æ–°åˆ†ç±»é¢œè‰²
            if (!categoryColors.has(formData.category)) {
                const usedColors = Array.from(categoryColors.values());
                const availableColors = colors.filter(color => !usedColors.includes(color));
                const newColor = availableColors.length > 0 ? availableColors[0] : colors[Math.floor(Math.random() * colors.length)];
                categoryColors.set(formData.category, newColor);
            }
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            updateCategoryRecommendations();
            hideTaskModal();
        }

        // æ˜¾ç¤ºå­—æ®µé”™è¯¯
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            field.classList.add('error');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        // æ¸…é™¤è¡¨å•é”™è¯¯
        function clearFormErrors() {
            document.querySelectorAll('.form-input, .form-select').forEach(field => {
                field.classList.remove('error');
            });
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.remove('show');
                error.textContent = '';
            });
        }

        // å®Œæˆå›ºå®šå¥–åŠ±ä»»åŠ¡
        function completeTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // å¢åŠ ä½™é¢
            currentBalance += task.fixedTime;
            
            // å¢åŠ å®Œæˆæ¬¡æ•°
            task.completionCount = (task.completionCount || 0) + 1;
            
            // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´ï¼ˆå®Œæˆæ—¶ç½®é¡¶ï¼‰
            task.lastUsed = new Date().toISOString();
            
            // è®°å½•äº¤æ˜“
            addTransaction({
                type: 'earn',
                taskId: task.id,
                taskName: task.name,
                amount: task.fixedTime,
                description: `å®Œæˆä»»åŠ¡: ${task.name}`,
                timestamp: new Date().toISOString()
            });
            
            // æ›´æ–°æ¯æ—¥å˜åŒ–
            updateDailyChanges('earned', task.fixedTime);
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('ğŸ‰ ä»»åŠ¡å®Œæˆ', `è·å¾— ${formatTime(task.fixedTime)} æ—¶é—´å¥–åŠ±ï¼`);
        }

        // å¼€å§‹è¿ç»­ä»»åŠ¡
        function startTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // ç›´æ¥å¼€å§‹ä»»åŠ¡ï¼Œæ”¯æŒå¤šä»»åŠ¡åŒæ—¶è¿è¡Œ
            runningTasks.set(taskId, {
                startTime: Date.now(),
                elapsedTime: 0,
                isPaused: false,
                achieved: false // ç”¨äºè¾¾æ ‡ä»»åŠ¡
            });
            
            // ä¸åœ¨å¼€å§‹æ—¶æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´ï¼Œé¿å…è§†è§‰è·³è·ƒ
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
            
            showNotification('â–¶ï¸ ä»»åŠ¡å¼€å§‹', `å¼€å§‹æ‰§è¡Œä»»åŠ¡: ${task.name}`);
        }

        // æš‚åœä»»åŠ¡
        function pauseTask(taskId) {
            const runningTask = runningTasks.get(taskId);
            if (!runningTask || runningTask.isPaused) return;
            
            // ç´¯è®¡å·²è¿è¡Œæ—¶é—´
            runningTask.elapsedTime += Date.now() - runningTask.startTime;
            runningTask.isPaused = true;
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
            
            const task = tasks.find(t => t.id === taskId);
            showNotification('â¸ï¸ ä»»åŠ¡æš‚åœ', `æš‚åœä»»åŠ¡: ${task.name}`);
        }

        // ç»§ç»­ä»»åŠ¡
        function resumeTask(taskId) {
            const runningTask = runningTasks.get(taskId);
            if (!runningTask || !runningTask.isPaused) return;
            
            runningTask.startTime = Date.now();
            runningTask.isPaused = false;
            
            saveData();
            updateRecentTasks();
            updateCategoryTasks();
            
            const task = tasks.find(t => t.id === taskId);
            showNotification('â–¶ï¸ ä»»åŠ¡ç»§ç»­', `ç»§ç»­æ‰§è¡Œä»»åŠ¡: ${task.name}`);
        }

        // å–æ¶ˆä»»åŠ¡
        function cancelTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (confirm(`ç¡®å®šè¦å–æ¶ˆä»»åŠ¡"${task.name}"å—ï¼Ÿå·²è¿è¡Œçš„æ—¶é—´å°†ä¸ä¼šä¿å­˜ã€‚`)) {
                runningTasks.delete(taskId);
                
                saveData();
                updateRecentTasks();
                updateCategoryTasks();
                
                showNotification('âŒ ä»»åŠ¡å–æ¶ˆ', `å–æ¶ˆä»»åŠ¡: ${task.name}`);
            }
        }

        // ç»“æŸä»»åŠ¡
        function stopTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const runningTask = runningTasks.get(taskId);
            if (!task || !runningTask) return;
            
            // è®¡ç®—æ€»è¿è¡Œæ—¶é—´
            const totalTime = runningTask.elapsedTime + (runningTask.isPaused ? 0 : Date.now() - runningTask.startTime);
            const totalSeconds = Math.floor(totalTime / 1000);
            
            if (totalSeconds <= 0) {
                alert('ä»»åŠ¡è¿è¡Œæ—¶é—´å¤ªçŸ­ï¼Œæ— æ³•è·å¾—å¥–åŠ±');
                return;
            }
            
            let earnedTime = 0;
            let description = '';
            
            if (task.type === 'continuous') {
                earnedTime = Math.floor(totalSeconds * task.multiplier);
                description = `è¿ç»­ä»»åŠ¡: ${task.name} (${formatTime(totalSeconds)} Ã— ${task.multiplier})`;
            } else if (task.type === 'continuous_target') {
                earnedTime = Math.floor(totalSeconds * task.multiplier);
                
                // å¦‚æœè¾¾åˆ°ç›®æ ‡æ—¶é—´ï¼Œç»™äºˆé¢å¤–å¥–åŠ±
                if (runningTask.achieved || totalSeconds >= task.targetTime) {
                    earnedTime += task.bonusReward;
                    description = `è¾¾æ ‡ä»»åŠ¡: ${task.name} (${formatTime(totalSeconds)} Ã— ${task.multiplier} + ${formatTime(task.bonusReward)} å¥–åŠ±)`;
                } else {
                    description = `è¾¾æ ‡ä»»åŠ¡: ${task.name} (${formatTime(totalSeconds)} Ã— ${task.multiplier})`;
                }
            } else if (task.type === 'continuous_redeem') {
                earnedTime = -Math.floor(totalSeconds * task.multiplier);
                description = `è¿ç»­æ¶ˆè´¹: ${task.name} (${formatTime(totalSeconds)} Ã— ${task.multiplier})`;
            }
            
            // æ›´æ–°ä½™é¢
            currentBalance += earnedTime;
            
            // å¢åŠ å®Œæˆæ¬¡æ•°
            task.completionCount = (task.completionCount || 0) + 1;
            
            // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´ï¼ˆå®Œæˆæ—¶ç½®é¡¶ï¼‰
            task.lastUsed = new Date().toISOString();
            
            // è®°å½•äº¤æ˜“
            addTransaction({
                type: earnedTime >= 0 ? 'earn' : 'spend',
                taskId: task.id,
                taskName: task.name,
                amount: Math.abs(earnedTime),
                description: description,
                timestamp: new Date().toISOString()
            });
            
            // æ›´æ–°æ¯æ—¥å˜åŒ–
            if (earnedTime >= 0) {
                updateDailyChanges('earned', earnedTime);
            } else {
                updateDailyChanges('spent', Math.abs(earnedTime));
            }
            
            // ç§»é™¤è¿è¡ŒçŠ¶æ€
            runningTasks.delete(taskId);
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            
            // æ˜¾ç¤ºé€šçŸ¥
            const notificationTitle = earnedTime >= 0 ? 'ğŸ‰ ä»»åŠ¡å®Œæˆ' : 'ğŸ’¸ ä»»åŠ¡æ¶ˆè´¹';
            const notificationMessage = earnedTime >= 0 ? 
                `è·å¾— ${formatTime(earnedTime)} æ—¶é—´å¥–åŠ±ï¼` : 
                `æ¶ˆè´¹ ${formatTime(Math.abs(earnedTime))} æ—¶é—´`;
            showNotification(notificationTitle, notificationMessage);
        }

        // å…‘æ¢å³æ—¶æ¶ˆè´¹ä»»åŠ¡
        function redeemTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
            if (currentBalance < task.consumeTime) {
                alert('ä½™é¢ä¸è¶³ï¼Œæ— æ³•å…‘æ¢æ­¤é¡¹ç›®');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦æ¶ˆè´¹ ${formatTime(task.consumeTime)} å…‘æ¢"${task.name}"å—ï¼Ÿ`)) {
                return;
            }
            
            // æ‰£é™¤ä½™é¢
            currentBalance -= task.consumeTime;
            
            // å¢åŠ å®Œæˆæ¬¡æ•°
            task.completionCount = (task.completionCount || 0) + 1;
            
            // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´ï¼ˆå®Œæˆæ—¶ç½®é¡¶ï¼‰
            task.lastUsed = new Date().toISOString();
            
            // è®°å½•äº¤æ˜“
            addTransaction({
                type: 'spend',
                taskId: task.id,
                taskName: task.name,
                amount: task.consumeTime,
                description: `å…‘æ¢é¡¹ç›®: ${task.name}`,
                timestamp: new Date().toISOString()
            });
            
            // æ›´æ–°æ¯æ—¥å˜åŒ–
            updateDailyChanges('spent', task.consumeTime);
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('ğŸ å…‘æ¢æˆåŠŸ', `æˆåŠŸå…‘æ¢: ${task.name}`);
        }

        // æ˜¾ç¤ºä»»åŠ¡å†å²
        function showTaskHistory(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentHistoryTask = task;
            document.getElementById('historyModalTitle').textContent = `${task.name} - å†å²è®°å½•`;
            
            // è·å–è¯¥ä»»åŠ¡çš„æ‰€æœ‰äº¤æ˜“è®°å½•
            const taskTransactions = transactions.filter(t => t.taskId === taskId);
            
            if (taskTransactions.length === 0) {
                document.getElementById('historyContent').innerHTML = '<div class="empty-message">æš‚æ— å†å²è®°å½•</div>';
            } else {
                const historyHtml = taskTransactions.map(transaction => {
                    const isPositive = transaction.type === 'earn';
                    return `
                        <div class="history-item">
                            <div class="history-info">
                                <div class="history-description">${transaction.description}</div>
                                <div class="history-time">${formatDateTime(transaction.timestamp)}</div>
                            </div>
                            <div class="history-amount ${isPositive ? 'positive' : 'negative'}">
                                ${isPositive ? '+' : '-'}${formatTime(transaction.amount)}
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('historyContent').innerHTML = historyHtml;
            }
            
            document.getElementById('historyModal').classList.add('show');
        }

        // éšè—ä»»åŠ¡å†å²æ¨¡æ€æ¡†
        function hideHistoryModal() {
            document.getElementById('historyModal').classList.remove('show');
            currentHistoryTask = null;
        }

        // æ·»åŠ äº¤æ˜“è®°å½•
        function addTransaction(transaction) {
            transactions.unshift(transaction); // æ·»åŠ åˆ°å¼€å¤´ï¼Œæœ€æ–°çš„åœ¨å‰é¢
            
            // é™åˆ¶äº¤æ˜“è®°å½•æ•°é‡ï¼Œé¿å…æ•°æ®è¿‡å¤š
            if (transactions.length > 1000) {
                transactions = transactions.slice(0, 1000);
            }
        }

        // æ›´æ–°æ¯æ—¥å˜åŒ–
        function updateDailyChanges(type, amount) {
            const today = new Date().toDateString();
            
            if (!dailyChanges[today]) {
                dailyChanges[today] = { earned: 0, spent: 0 };
            }
            
            dailyChanges[today][type] += amount;
        }

        // æ›´æ–°ä½™é¢æ˜¾ç¤º
        function updateBalance() {
            const balanceCard = document.getElementById('balanceCard');
            const balanceAmount = document.getElementById('balanceAmount');
            const dailyEarned = document.getElementById('dailyEarned');
            const dailySpent = document.getElementById('dailySpent');
            
            balanceAmount.textContent = formatTime(currentBalance);
            
            // æ ¹æ®ä½™é¢æ­£è´Ÿè®¾ç½®æ ·å¼
            if (currentBalance < 0) {
                balanceCard.classList.add('negative');
                balanceAmount.style.color = '#f44336';
            } else {
                balanceCard.classList.remove('negative');
                balanceAmount.style.color = currentBalance < notificationSettings.lowBalanceThreshold ? '#FF9800' : '#2196F3';
            }
            
            // æ˜¾ç¤ºä»Šæ—¥å˜åŒ–
            const today = new Date().toDateString();
            const todayChanges = dailyChanges[today] || { earned: 0, spent: 0 };
            
            dailyEarned.textContent = formatTime(todayChanges.earned);
            dailySpent.textContent = formatTime(todayChanges.spent);
            
            // æ£€æŸ¥ä½™é¢ä¸è¶³æé†’
            if (notificationSettings.enabled && notificationSettings.lowBalance && 
                currentBalance < notificationSettings.lowBalanceThreshold && currentBalance >= 0) {
                showNotification('âš ï¸ ä½™é¢ä¸è¶³', `å½“å‰ä½™é¢ä»…å‰© ${formatTime(currentBalance)}`);
            }
        }

        // æ›´æ–°æŠ¥å‘Š
        function updateReports() {
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const totalEarned = transactions
                .filter(t => t.type === 'earn')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalSpent = transactions
                .filter(t => t.type === 'spend')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalTasks = tasks.length;
            const completedTasks = tasks.reduce((sum, t) => sum + (t.completionCount || 0), 0);
            
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('totalEarned').textContent = formatTime(totalEarned);
            document.getElementById('totalSpent').textContent = formatTime(totalSpent);
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            
            // æ›´æ–°äº¤æ˜“åˆ—è¡¨
            const transactionList = document.getElementById('transactionList');
            
            if (transactions.length === 0) {
                transactionList.innerHTML = '<div class="empty-message">æš‚æ— äº¤æ˜“è®°å½•</div>';
            } else {
                const recentTransactions = transactions.slice(0, 20); // åªæ˜¾ç¤ºæœ€è¿‘20æ¡
                const transactionHtml = recentTransactions.map(transaction => {
                    const isPositive = transaction.type === 'earn';
                    return `
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <div class="transaction-name">${transaction.description}</div>
                                <div class="transaction-time">${formatDateTime(transaction.timestamp)}</div>
                            </div>
                            <div class="transaction-amount ${isPositive ? 'positive' : 'negative'}">
                                ${isPositive ? '+' : '-'}${formatTime(transaction.amount)}
                            </div>
                        </div>
                    `;
                }).join('');
                
                transactionList.innerHTML = transactionHtml;
            }
        }

        // æ›´æ–°åˆ†ç±»æ¨è
        function updateCategoryRecommendations() {
            const existingCategories = [...new Set(tasks.map(t => t.category))];
            const recommendationsContainer = document.getElementById('categoryRecommendations');
            
            if (existingCategories.length === 0) {
                recommendationsContainer.innerHTML = '';
                return;
            }
            
            const recommendationHtml = existingCategories.map(category => {
                return `<div class="recommendation-item" onclick="selectCategory('${category}')">${category}</div>`;
            }).join('');
            
            recommendationsContainer.innerHTML = recommendationHtml;
        }

        // é€‰æ‹©åˆ†ç±»æ¨è
        function selectCategory(category) {
            document.getElementById('taskCategory').value = category;
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            if (seconds < 0) {
                return '-' + formatTime(-seconds);
            }
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            const parts = [];
            if (hours > 0) parts.push(`${hours}å°æ—¶`);
            if (minutes > 0) parts.push(`${minutes}åˆ†é’Ÿ`);
            if (remainingSeconds > 0 || parts.length === 0) parts.push(`${remainingSeconds}ç§’`);
            
            return parts.join('');
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays < 7) {
                return `${diffDays}å¤©å‰`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        // é€šçŸ¥ç›¸å…³åŠŸèƒ½
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    notificationSettings.enabled = permission === 'granted';
                    updateNotificationSettings();
                    saveData();
                });
            }
        }

        function showNotification(title, body) {
            if (!notificationSettings.enabled || !notificationSettings.achievement) return;
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/favicon.ico'
                });
            }
        }

        function toggleNotifications() {
            const enabled = document.getElementById('notificationToggle').checked;
            
            if (enabled && Notification.permission !== 'granted') {
                requestNotificationPermission();
            } else {
                notificationSettings.enabled = enabled;
                saveData();
            }
        }

        function toggleAchievementNotifications() {
            notificationSettings.achievement = document.getElementById('achievementNotificationToggle').checked;
            saveData();
        }

        function toggleLongRunningNotifications() {
            notificationSettings.longRunning = document.getElementById('longRunningNotificationToggle').checked;
            saveData();
        }

        function updateLongRunningThreshold() {
            const threshold = parseInt(document.getElementById('longRunningThreshold').value);
            if (threshold >= 300) {
                notificationSettings.longRunningThreshold = threshold;
                saveData();
            }
        }

        function toggleLowBalanceNotifications() {
            notificationSettings.lowBalance = document.getElementById('lowBalanceNotificationToggle').checked;
            saveData();
        }

        function updateLowBalanceThreshold() {
            const threshold = parseInt(document.getElementById('lowBalanceThreshold').value);
            if (threshold >= 0) {
                notificationSettings.lowBalanceThreshold = threshold;
                saveData();
                updateBalance(); // é‡æ–°æ£€æŸ¥ä½™é¢çŠ¶æ€
            }
        }

        function toggleInactiveTaskNotifications() {
            notificationSettings.inactiveTask = document.getElementById('inactiveTaskNotificationToggle').checked;
            saveData();
        }

        function updateInactiveTaskThreshold() {
            const threshold = parseInt(document.getElementById('inactiveTaskThreshold').value);
            if (threshold >= 3600) {
                notificationSettings.inactiveTaskThreshold = threshold;
                saveData();
            }
        }

        function updateNotificationSettings() {
            document.getElementById('notificationToggle').checked = notificationSettings.enabled;
            document.getElementById('achievementNotificationToggle').checked = notificationSettings.achievement;
            document.getElementById('longRunningNotificationToggle').checked = notificationSettings.longRunning;
            document.getElementById('longRunningThreshold').value = notificationSettings.longRunningThreshold;
            document.getElementById('lowBalanceNotificationToggle').checked = notificationSettings.lowBalance;
            document.getElementById('lowBalanceThreshold').value = notificationSettings.lowBalanceThreshold;
            document.getElementById('inactiveTaskNotificationToggle').checked = notificationSettings.inactiveTask;
            document.getElementById('inactiveTaskThreshold').value = notificationSettings.inactiveTaskThreshold;
        }

        // ä¸»é¢˜åˆ‡æ¢
        function toggleDarkTheme() {
            const isDark = document.getElementById('darkThemeToggle').checked;
            
            if (isDark) {
                document.body.setAttribute('data-theme', 'dark');
            } else {
                document.body.removeAttribute('data-theme');
            }
            
            // ä¿å­˜ä¸»é¢˜è®¾ç½®
            localStorage.setItem('darkTheme', isDark);
        }

        // æ•°æ®ç®¡ç†
        function exportData() {
            const data = {
                version: '2.85',
                currentBalance,
                tasks,
                transactions,
                categoryColors: Array.from(categoryColors.entries()),
                collapsedCategories: Array.from(collapsedCategories),
                dailyChanges,
                notificationSettings,
                exportTime: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timebank_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('ğŸ“ å¯¼å‡ºå®Œæˆ', 'æ•°æ®å·²æˆåŠŸå¯¼å‡ºåˆ°æ–‡ä»¶');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!data.version || !Array.isArray(data.tasks)) {
                        throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                    }
                    
                    if (!confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                        return;
                    }
                    
                    // å¯¼å…¥æ•°æ®
                    currentBalance = data.currentBalance || 0;
                    tasks = data.tasks || [];
                    transactions = data.transactions || [];
                    categoryColors = new Map(data.categoryColors || []);
                    collapsedCategories = new Set(data.collapsedCategories || []);
                    dailyChanges = data.dailyChanges || {};
                    
                    if (data.notificationSettings) {
                        notificationSettings = { ...notificationSettings, ...data.notificationSettings };
                    }
                    
                    // æ¸…é™¤è¿è¡Œä¸­çš„ä»»åŠ¡ï¼ˆå¯¼å…¥åä¸ä¿æŒè¿è¡ŒçŠ¶æ€ï¼‰
                    runningTasks.clear();
                    
                    saveData();
                    updateBalance();
                    updateRecentTasks();
                    updateCategoryTasks();
                    updateReports();
                    updateCategoryRecommendations();
                    updateNotificationSettings();
                    
                    showNotification('ğŸ“¥ å¯¼å…¥å®Œæˆ', 'æ•°æ®å·²æˆåŠŸå¯¼å…¥');
                    
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            
            // æ¸…é™¤æ–‡ä»¶é€‰æ‹©
            event.target.value = '';
        }

        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                return;
            }
            
            if (!confirm('æœ€åç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ä»»åŠ¡ã€äº¤æ˜“è®°å½•å’Œè®¾ç½®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            
            // æ¸…ç©ºæ‰€æœ‰æ•°æ®
            currentBalance = 0;
            tasks = [];
            transactions = [];
            categoryColors.clear();
            collapsedCategories.clear();
            runningTasks.clear();
            dailyChanges = {};
            
            // é‡ç½®é€šçŸ¥è®¾ç½®
            notificationSettings = {
                enabled: false,
                achievement: true,
                longRunning: true,
                longRunningThreshold: 3600,
                lowBalance: true,
                lowBalanceThreshold: 1800,
                inactiveTask: false,
                inactiveTaskThreshold: 86400
            };
            
            saveData();
            updateBalance();
            updateRecentTasks();
            updateCategoryTasks();
            updateReports();
            updateCategoryRecommendations();
            updateNotificationSettings();
            
            showNotification('ğŸ—‘ï¸ æ¸…ç©ºå®Œæˆ', 'æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
        }

        // æ•°æ®æŒä¹…åŒ–
        function saveData() {
            const data = {
                currentBalance,
                tasks,
                transactions,
                categoryColors: Array.from(categoryColors.entries()),
                collapsedCategories: Array.from(collapsedCategories),
                runningTasks: Array.from(runningTasks.entries()),
                dailyChanges,
                notificationSettings
            };
            
            localStorage.setItem('timeBankData', JSON.stringify(data));
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('timeBankData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    currentBalance = data.currentBalance || 0;
                    tasks = data.tasks || [];
                    transactions = data.transactions || [];
                    categoryColors = new Map(data.categoryColors || []);
                    collapsedCategories = new Set(data.collapsedCategories || []);
                    runningTasks = new Map(data.runningTasks || []);
                    dailyChanges = data.dailyChanges || {};
                    
                    if (data.notificationSettings) {
                        notificationSettings = { ...notificationSettings, ...data.notificationSettings };
                    }
                }
                
                // åŠ è½½ä¸»é¢˜è®¾ç½®
                const darkTheme = localStorage.getItem('darkTheme') === 'true';
                document.getElementById('darkThemeToggle').checked = darkTheme;
                if (darkTheme) {
                    document.body.setAttribute('data-theme', 'dark');
                }
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);

        // é¡µé¢å…³é—­å‰ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', saveData);

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                if (event.target.id === 'taskModal') {
                    hideTaskModal();
                } else if (event.target.id === 'historyModal') {
                    hideHistoryModal();
                }
            }
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            // ESC é”®å…³é—­æ¨¡æ€æ¡†
            if (event.key === 'Escape') {
                if (document.getElementById('taskModal').classList.contains('show')) {
                    hideTaskModal();
                } else if (document.getElementById('historyModal').classList.contains('show')) {
                    hideHistoryModal();
                }
            }
            
            // Ctrl/Cmd + N åˆ›å»ºæ–°ä»»åŠ¡
            if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
                event.preventDefault();
                showTaskModal();
            }
        });
    </script>
</body>
</html>
